-----------------------------------------------------
-- Export file for user EMR@ORCL                   --
-- Created by Administrator on 2018/5/27, 13:47:54 --
-----------------------------------------------------

set define off
spool packbody.log

prompt
prompt Creating package body EMRBASEINFO
prompt =================================
prompt
create or replace package body emr.emrbaseinfo is

  --插入或修改诊断别名表
  PROCEDURE usp_AddOrModDiaOther(v_id    varchar2,
                                 v_ICDID varchar2,
                                 v_NAME  varchar2,
                                 v_PY    varchar2,
                                 v_WB    varchar2,
                                 v_VALID varchar2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from diagnosisothername
     where diagnosisothername.id = v_id;
    IF v_count <= 0 THEN
      insert into diagnosisothername
        (id, icdid, name, py, wb, valid)
      values
        (v_id, v_icdid, v_name, zlspellcode(v_name),  get_wb(v_name), '1');
    ELSE
      update diagnosisothername cn
         set cn.name  = v_NAME,
             cn.py    = zlspellcode(v_name),
             cn.wb    = get_wb(v_name),
             cn.valid = v_VALID
       where cn.id = v_id;
    end if;
  END;

  --插入或修改中医诊断别名表
  PROCEDURE usp_AddOrModDiaChiOther(v_id    varchar2,
                                    v_ICDID varchar2,
                                    v_NAME  varchar2,
                                    v_PY    varchar2,
                                    v_WB    varchar2,
                                    v_VALID varchar2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from diagnosischiothername
     where diagnosischiothername.id = v_id;
    IF v_count <= 0 THEN
      insert into diagnosischiothername
        (id, icdid, name, py, wb, valid)
      values
        (v_id, v_icdid, v_name, zlspellcode(v_name),  get_wb(v_name), '1');
    ELSE
      update diagnosischiothername cn
         set cn.name  = v_NAME,
             cn.py    = zlspellcode(v_name),
             cn.wb    = get_wb(v_name),
             cn.valid = v_VALID
       where cn.id = v_id;
    end if;
  END;

  --插入或修改手术别名表
  PROCEDURE usp_AddOrModOperOther(v_id    varchar2,
                                  v_ICDID varchar2,
                                  v_NAME  varchar2,
                                  v_PY    varchar2,
                                  v_WB    varchar2,
                                  v_VALID varchar2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from operothername
     where operothername.id = v_id;
    IF v_count <= 0 THEN
      insert into operothername
        (id, icdid, name, py, wb, valid)
      values
        (v_id, v_icdid, v_name, zlspellcode(v_name),  get_wb(v_name), '1');
    ELSE
      update operothername cn
         set cn.name  = v_NAME,
             cn.py    = zlspellcode(v_name),
             cn.wb    = get_wb(v_name),
             cn.valid = v_VALID
       where cn.id = v_id;
    end if;
  END;

end EMRBaseInfo;
/

prompt
prompt Creating package body EMRPROC
prompt =============================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emrproc IS
  /*******************************************************************/
  PROCEDURE usp_emr_patrecfile(v_flag             INTEGER,
                               v_indx             INTEGER,
                               v_noofinpat        INTEGER,
                               v_templateid       VARCHAR2,
                               v_filename         VARCHAR2,
                               v_filecontent      CLOB,
                               v_sortid           VARCHAR2,
                               v_owner            VARCHAR2,
                               v_auditor          VARCHAR2,
                               v_createtime       CHAR,
                               v_audittime        CHAR,
                               v_valid            INTEGER,
                               v_hassubmit        INTEGER,
                               v_hasprint         INTEGER,
                               v_hassign          INTEGER,
                               v_captiondatetime  varchar2,
                               v_FIRSTDAILYFLAG   varchar2,
                               v_py               varchar2,
                               v_wb               varchar2,
                               v_isyihuangoutong  varchar2,
                               v_isconfigpagesize varchar2,
                               v_DepartCode       varchar2,
                               v_wardCode         varchar2,
                               o_result           OUT empcurtyp) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]
    [作者]
    [版权]
    [描述] 更新或插入病历文件
    [功能说明]
    [输入参数]
      @NoOfInpat varchar(40)--首页序号
    [输出参数]
    [结果集、排序]
    质量控制统计数据集

    [调用的sp]
    [调用实例]
    EXEC usp_Emr_PatRecFile 1,2,'T','FNAME','CONTENT','SORTID','OWN','AUDIT','CRAETE','AUDIT',1,1,1,1
    [修改记录]
    **********/
    p_count integer default 0;
  BEGIN
    IF v_flag = 1 --插入
     THEN
      --SELECT NVL(MAX(ID), 0) + 1 into p_count FROM recorddetail;
      select seq_recorddetail_id.nextval into p_count from dual;
      INSERT INTO recorddetail
        (ID,
         noofinpat,
         templateid,
         NAME,
         content,
         sortid,
         owner,
         auditor,
         createtime,
         audittime,
         valid,
         hassubmit,
         hasprint,
         hassign,
         captiondatetime,
         FIRSTDAILYFLAG,
         islock,
         isyihuangoutong,
         isconfigpagesize,
         departcode,
         wardcode)
      VALUES
        (p_count,
         v_noofinpat,
         v_templateid,
         v_filename,
         v_filecontent,
         v_sortid,
         v_owner,
         v_auditor,
         v_createtime,
         v_audittime,
         v_valid,
         v_hassubmit,
         v_hasprint,
         v_hassign,
         v_captiondatetime,
         v_FIRSTDAILYFLAG,
         '4700',
         v_isyihuangoutong,
         v_isconfigpagesize,
         v_DepartCode,
         v_wardCode);

    ELSIF v_flag = 2 THEN
      UPDATE recorddetail
         SET --content   = v_filecontent,
                    auditor = v_auditor,
             audittime       = v_audittime,
             valid           = v_valid,
             hassubmit       = v_hassubmit,
             hasprint        = v_hasprint,
             hassign         = v_hassign,
             NAME            = v_filename,
             captiondatetime = v_captiondatetime
       WHERE ID = v_indx;
    END IF;

    OPEN o_result FOR
      select p_count from dual;
    /*
    IF v_sortid = 'AC' AND v_FIRSTDAILYFLAG = 0 THEN --保证病程记录整体提交

        --IF p_count > 0 THEN
        UPDATE recorddetail
        SET recorddetail.hassubmit =
        (
            SELECT hassubmit FROM recorddetail
            WHERE recorddetail.noofinpat
                IN ( SELECT noofinpat FROM recorddetail WHERE id = v_indx )
                AND sortid = 'AC' AND firstdailyflag = 1 AND valid = 1 AND rownum = 1
        )
        WHERE recorddetail.id
        IN
        (
            SELECT id FROM recorddetail
            WHERE recorddetail.noofinpat
                IN ( SELECT noofinpat FROM recorddetail WHERE id = v_indx )
                AND sortid = 'AC' AND firstdailyflag = 0 AND valid = 1
        );
        --END IF;
    END IF;
    */
  END;

  PROCEDURE usp_auditapplyrecord(v_audittype VARCHAR, --审核类型
                                 v_manid     VARCHAR, --审核人ID
                                 v_id        NUMERIC --记录ID
                                 ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  审批申请借阅病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_audittype = '5206' THEN
      --签收
      UPDATE applyrecord
         SET singindate = TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss'),
             singinman  = v_manid,
             status     = v_audittype
       WHERE ID = v_id;
    ELSE
      --审核
      UPDATE applyrecord
         SET auditdate = TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss'),
             auditman  = v_manid,
             status    = v_audittype
       WHERE ID = v_id;
    END IF;
  END;

  /***********************************************************************************/
  PROCEDURE usp_deletejob(v_id VARCHAR) AS
    /**********
     版本号
     创建时间
     作者
     版权
     描述
     功能说明      删除选定岗位
     输出参数
     结果集、排序
     调用的sp
     调用实例
    **********/
  BEGIN
    UPDATE users
       SET jobid = REPLACE(jobid, v_id || ',', '')
     WHERE ID IN (SELECT ID FROM users WHERE jobid LIKE '%v_ID%');

    DELETE FROM job2permission WHERE ID = v_id;

    DELETE FROM jobs WHERE ID = v_id;
  END;

  /********************************************************************************/
  PROCEDURE usp_deletejobpermission(v_id VARCHAR) AS
    /**********
     版本号
     创建时间
     作者
     版权
     描述
     功能说明      删除权限控制信息
     输出参数
     结果集、排序
     调用的sp
     调用实例
    **********/
  BEGIN
    DELETE job2permission WHERE ID = v_id;
  END;

  /*********************************************************************************/
  PROCEDURE usp_deleteuserinfo(v_id VARCHAR) AS
    /**********
     版本号
     创建时间
     作者
     版权
     描述
     功能说明      删除某个员工信息
     输出参数
     结果集、排序
     调用的sp
     调用实例
    **********/
  BEGIN
    DELETE users WHERE ID = v_id;
  END;

  /*********************************************************/
  PROCEDURE usp_deptemmanager(v_dept VARCHAR, o_result OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取病历模板选择助手数据
     功能说明
     输入参数
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_DepTemManager   3202
     修改记录
    **********/
    v_sql VARCHAR2(4000) DEFAULT '';
  BEGIN
    droptable('tmp_templet');
    v_sql := 'create table tmp_templet as
    select b.Name,
           b.ID,
           a.ID templetID,
           a.Name templetName,
           a.Describe,
           b.PrevID as PrevID,
           nvl(F_DepTemManager(0, b.ID, nvl(b.PrevID, '''')), '''') AS groupname,
           nvl(F_DepTemManager(1, b.ID, nvl(b.PrevID, '''')), '''') AS groupname2
      from Model_Docment a
      left join ModelDirectory b on a.SortID = b.ID
     order by b.ID, groupname';

    EXECUTE IMMEDIATE v_sql;

    v_sql := ' select a.*,
         b.Department,
         (case
           when b.Department is null then
            ''0''
           else
            ''1''
         end) as checked
    from tmp_templet a
    left join (select t.* from Template_Department t where t.Department = ''' ||
             v_dept || ''') b on a.templetID = b.TemplateID';

    OPEN o_result FOR v_sql;
  END;

  /*****************************************************************************/
  PROCEDURE usp_EditEmrLONG_ORDER(v_EditType         varchar default '', --操作类型
                                  v_LONGID           INTEGER default '',
                                  v_NOOFINPAT        INTEGER default '',
                                  v_GROUPID          INTEGER default '',
                                  v_GROUPFLAG        INTEGER default '',
                                  v_WARDID           VARCHAR2 default '',
                                  v_DEPTID           VARCHAR2 default '',
                                  v_TYPEDOCTOR       VARCHAR2 default '',
                                  v_TYPEDATE         CHAR default '',
                                  v_AUDITOR          VARCHAR2 default '',
                                  v_DATEOFAUDIT      CHAR default '',
                                  v_EXECUTOR         VARCHAR2 default '',
                                  v_EXECUTEDATE      CHAR default '',
                                  v_CANCELDOCTOR     VARCHAR2 default '',
                                  v_CANCELDATE       CHAR default '',
                                  v_CEASEDCOCTOR     VARCHAR2 default '',
                                  v_CEASEDATE        CHAR default '',
                                  v_CEASENURSE       VARCHAR2 default '',
                                  v_CEASEADUDITDATE  CHAR default '',
                                  v_STARTDATE        CHAR default '',
                                  v_TOMORROW         INTEGER default '',
                                  v_PRODUCTNO        INTEGER default '',
                                  v_NORMNO           INTEGER default '',
                                  v_MEDICINENO       INTEGER default '',
                                  v_DRUGNO           VARCHAR2 default '',
                                  v_DRUGNAME         VARCHAR2 default '',
                                  v_DRUGNORM         VARCHAR2 default '',
                                  v_ITEMTYPE         INTEGER default '',
                                  v_MINUNIT          VARCHAR2 default '',
                                  v_DRUGDOSE         INTEGER default '',
                                  v_DOSEUNIT         VARCHAR2 default '',
                                  v_UNITRATE         INTEGER default '',
                                  v_UNITTYPE         INTEGER default '',
                                  v_DRUGUSE          VARCHAR2 default '',
                                  v_BATCHNO          VARCHAR2 default '',
                                  v_EXECUTECOUNT     INTEGER default '',
                                  v_EXECUTECYCLE     INTEGER default '',
                                  v_CYCLEUNIT        INTEGER default '',
                                  v_DATEOFWEEK       CHAR default '',
                                  v_INNEREXECUTETIME VARCHAR2 default '',
                                  v_EXECUTEDEPT      VARCHAR2 default '',
                                  v_ENTRUST          VARCHAR2 default '',
                                  v_ORDERTYPE        INTEGER default '',
                                  v_ORDERSTATUS      INTEGER default '',
                                  v_SPECIALMARK      INTEGER default '',
                                  v_CEASEREASON      INTEGER default '',
                                  v_CURGERYID        INTEGER default '',
                                  v_CONTENT          VARCHAR2 default '',
                                  v_SYNCH            INTEGER default '',
                                  v_MEMO             VARCHAR2 default '',
                                  v_DJFL             VARCHAR2 default '',
                                  o_result           OUT empcurtyp) as
  begin
    --添加
    open o_result for
      select '' from dual;
    if v_EditType = '1' then
      insert into LONG_ORDER

        (LONGID,
         NOOFINPAT,
         GROUPID,
         GROUPFLAG,
         WARDID,
         DEPTID,
         TYPEDOCTOR,
         TYPEDATE,
         AUDITOR,
         DATEOFAUDIT,
         EXECUTOR,
         EXECUTEDATE,
         CANCELDOCTOR,
         CANCELDATE,
         CEASEDCOCTOR,
         CEASEDATE,
         CEASENURSE,
         CEASEADUDITDATE,
         STARTDATE,
         TOMORROW,
         PRODUCTNO,
         NORMNO,
         MEDICINENO,
         DRUGNO,
         DRUGNAME,
         DRUGNORM,
         ITEMTYPE,
         MINUNIT,
         DRUGDOSE,
         DOSEUNIT,
         UNITRATE,
         UNITTYPE,
         DRUGUSE,
         BATCHNO,
         EXECUTECOUNT,
         EXECUTECYCLE,
         CYCLEUNIT,
         DATEOFWEEK,
         INNEREXECUTETIME,
         EXECUTEDEPT,
         ENTRUST,
         ORDERTYPE,
         ORDERSTATUS,
         SPECIALMARK,
         CEASEREASON,
         CURGERYID,
         CONTENT,
         SYNCH,
         MEMO,
         DJFL)
      values
        (seq_long_order_id.nextval,
         v_NOOFINPAT,
         v_GROUPID,
         v_GROUPFLAG,
         v_WARDID,
         v_DEPTID,
         v_TYPEDOCTOR,
         v_TYPEDATE, --时间
         v_AUDITOR,
         v_DATEOFAUDIT,
         v_EXECUTOR,
         v_EXECUTEDATE, --时间
         v_CANCELDOCTOR,
         v_CANCELDATE, --时间
         v_CEASEDCOCTOR,
         v_CEASEDATE, --时间
         v_CEASENURSE,
         v_CEASEADUDITDATE, --时间
         v_STARTDATE, --时间
         v_TOMORROW,
         v_PRODUCTNO,
         v_NORMNO,
         v_MEDICINENO,
         v_DRUGNO,
         v_DRUGNAME,
         v_DRUGNORM,
         v_ITEMTYPE,
         v_MINUNIT,
         v_DRUGDOSE,
         v_DOSEUNIT,
         v_UNITRATE,
         v_UNITTYPE,
         v_DRUGUSE,
         v_BATCHNO,
         v_EXECUTECOUNT,
         v_EXECUTECYCLE,
         v_CYCLEUNIT,
         v_DATEOFWEEK,
         v_INNEREXECUTETIME, --时间
         v_EXECUTEDEPT,
         v_ENTRUST,
         v_ORDERTYPE,
         v_ORDERSTATUS,
         v_SPECIALMARK,
         v_CEASEREASON,
         v_CURGERYID,
         v_CONTENT,
         v_SYNCH,
         v_MEMO,
         v_DJFL);
      --修改
    elsif v_EditType = '2' then
      update LONG_ORDER
         set NOOFINPAT        = nvl(v_NOOFINPAT, NOOFINPAT),
             GROUPID          = nvl(v_GROUPID, GROUPID),
             GROUPFLAG        = nvl(v_GROUPFLAG, GROUPFLAG),
             WARDID           = nvl(v_WARDID, WARDID),
             DEPTID           = nvl(v_DEPTID, DEPTID),
             TYPEDOCTOR       = nvl(v_TYPEDOCTOR, TYPEDOCTOR),
             TYPEDATE         = nvl(v_TYPEDATE, TYPEDATE), --时间
             AUDITOR          = nvl(v_AUDITOR, AUDITOR),
             DATEOFAUDIT      = nvl(v_DATEOFAUDIT, DATEOFAUDIT),
             EXECUTOR         = nvl(v_EXECUTOR, EXECUTOR),
             EXECUTEDATE      = nvl(v_EXECUTEDATE, EXECUTEDATE), --时间
             CANCELDOCTOR     = nvl(v_CANCELDOCTOR, CANCELDOCTOR),
             CANCELDATE       = nvl(v_CANCELDATE, CANCELDATE), --时间
             CEASEDCOCTOR     = nvl(v_CEASEDCOCTOR, CEASEDCOCTOR),
             CEASEDATE        = nvl(v_CEASEDATE, CEASEDATE), --时间
             CEASENURSE       = nvl(v_CEASENURSE, CEASENURSE),
             CEASEADUDITDATE  = nvl(v_CEASEADUDITDATE, CEASEADUDITDATE), --时间
             STARTDATE        = nvl(v_STARTDATE, STARTDATE), --时间
             TOMORROW         = nvl(v_TOMORROW, TOMORROW),
             PRODUCTNO        = nvl(v_PRODUCTNO, PRODUCTNO),
             NORMNO           = nvl(v_NORMNO, NORMNO),
             MEDICINENO       = nvl(v_MEDICINENO, MEDICINENO),
             DRUGNO           = nvl(v_DRUGNO, DRUGNO),
             DRUGNAME         = nvl(v_DRUGNAME, DRUGNAME),
             DRUGNORM         = nvl(v_DRUGNORM, DRUGNORM),
             ITEMTYPE         = nvl(v_ITEMTYPE, ITEMTYPE),
             MINUNIT          = nvl(v_MINUNIT, MINUNIT),
             DRUGDOSE         = nvl(v_DRUGDOSE, DRUGDOSE),
             DOSEUNIT         = nvl(v_DOSEUNIT, DOSEUNIT),
             UNITRATE         = nvl(v_UNITRATE, UNITRATE),
             UNITTYPE         = nvl(v_UNITTYPE, UNITTYPE),
             DRUGUSE          = nvl(v_DRUGUSE, DRUGUSE),
             BATCHNO          = nvl(v_BATCHNO, BATCHNO),
             EXECUTECOUNT     = nvl(v_EXECUTECOUNT, EXECUTECOUNT),
             EXECUTECYCLE     = nvl(v_EXECUTECYCLE, EXECUTECYCLE),
             CYCLEUNIT        = nvl(v_CYCLEUNIT, CYCLEUNIT),
             DATEOFWEEK       = nvl(v_DATEOFWEEK, DATEOFWEEK),
             INNEREXECUTETIME = nvl(v_INNEREXECUTETIME, INNEREXECUTETIME), --时间
             EXECUTEDEPT      = nvl(v_EXECUTEDEPT, EXECUTEDEPT),
             ENTRUST          = nvl(v_ENTRUST, ENTRUST),
             ORDERTYPE        = nvl(v_ORDERTYPE, ORDERTYPE),
             ORDERSTATUS      = nvl(v_ORDERSTATUS, ORDERSTATUS),
             SPECIALMARK      = nvl(v_SPECIALMARK, SPECIALMARK),
             CEASEREASON      = nvl(v_CEASEREASON, CEASEREASON),
             CURGERYID        = nvl(v_CURGERYID, CURGERYID),
             CONTENT          = nvl(v_CONTENT, CONTENT),
             SYNCH            = nvl(v_SYNCH, SYNCH),
             MEMO             = nvl(v_MEMO, MEMO),
             DJFL             = nvl(v_DJFL, DJFL)
       where LONGID = V_LONGID;
      --删除
    elsif v_EditType = '3' then
      delete LONG_ORDER where LONGID = V_LONGID;
      --查询
    elsif v_EditType = '4' then
      open o_result for
        select * from LONG_ORDER where LONGID = V_LONGID;

    end if;
  end;

  /*****************************************************************************/
  PROCEDURE usp_EditEmrTEMP_ORDER(v_EditType         VARCHAR2 default '', --操作类型
                                  v_TEMPID           INTEGER default '',
                                  v_NOOFINPAT        INTEGER default '',
                                  v_GROUPID          INTEGER default '',
                                  v_GROUPFLAG        INTEGER default '',
                                  v_WARDID           VARCHAR2 default '',
                                  v_DEPTID           VARCHAR2 default '',
                                  v_TYPEDOCTOR       VARCHAR2 default '',
                                  v_TYPEDATE         CHAR default '',
                                  v_AUDITOR          VARCHAR2 default '',
                                  v_DATEOFAUDIT      CHAR default '',
                                  v_EXECUTOR         VARCHAR2 default '',
                                  v_EXECUTEDATE      CHAR default '',
                                  v_CANCELDOCTOR     VARCHAR2 default '',
                                  v_CANCELDATE       CHAR default '',
                                  v_STARTDATE        CHAR default '',
                                  v_PRODUCTNO        INTEGER default '',
                                  v_NORMNO           INTEGER default '',
                                  v_MEDICINENO       INTEGER default '',
                                  v_DRUGNO           VARCHAR2 default '',
                                  v_DRUGNAME         VARCHAR2 default '',
                                  v_DRUGNORM         VARCHAR2 default '',
                                  v_ITEMTYPE         INTEGER default '',
                                  v_MINUNIT          VARCHAR2 default '',
                                  v_DRUGDOSE         INTEGER default '',
                                  v_DOSEUNIT         VARCHAR2 default '',
                                  v_UNITRATE         INTEGER default '',
                                  v_UNITTYPE         INTEGER default '',
                                  v_DRUGUSE          VARCHAR2 default '',
                                  v_BATCHNO          VARCHAR2 default '',
                                  v_EXECUTECOUNT     INTEGER default '',
                                  v_EXECUTECYCLE     INTEGER default '',
                                  v_CYCLEUNIT        INTEGER default '',
                                  v_DATEOFWEEK       CHAR default '',
                                  v_INNEREXECUTETIME VARCHAR2 default '',
                                  v_ZXTS             INTEGER default '',
                                  v_TOTALDOSE        INTEGER default '',
                                  v_ENTRUST          VARCHAR2 default '',
                                  v_ORDERTYPE        INTEGER default '',
                                  v_ORDERSTATUS      INTEGER default '',
                                  v_SPECIALMARK      INTEGER default '',
                                  v_CEASEID          INTEGER default '',
                                  v_CEASEDATE        CHAR default '',
                                  v_CONTENT          VARCHAR2 default '',
                                  v_SYNCH            INTEGER default '',
                                  v_MEMO             VARCHAR2 default '',
                                  v_FORMTYPE         VARCHAR2 default '',
                                  o_result           OUT empcurtyp) as
  begin
    --添加
    open o_result for
      select '' from dual;

    if v_EditType = '1' then
      insert into TEMP_ORDER
        (TEMPID,
         NOOFINPAT,
         GROUPID,
         GROUPFLAG,
         WARDID,
         DEPTID,
         TYPEDOCTOR,
         TYPEDATE,
         AUDITOR,
         DATEOFAUDIT,
         EXECUTOR,
         EXECUTEDATE,
         CANCELDOCTOR,
         CANCELDATE,
         STARTDATE,
         PRODUCTNO,
         NORMNO,
         MEDICINENO,
         DRUGNO,
         DRUGNAME,
         DRUGNORM,
         ITEMTYPE,
         MINUNIT,
         DRUGDOSE,
         DOSEUNIT,
         UNITRATE,
         UNITTYPE,
         DRUGUSE,
         BATCHNO,
         EXECUTECOUNT,
         EXECUTECYCLE,
         CYCLEUNIT,
         DATEOFWEEK,
         INNEREXECUTETIME,
         ZXTS,
         TOTALDOSE,
         ENTRUST,
         ORDERTYPE,
         ORDERSTATUS,
         SPECIALMARK,
         CEASEID,
         CEASEDATE,
         CONTENT,
         SYNCH,
         MEMO,
         FORMTYPE)
      values
        (seq_temp_order_id.nextval,
         v_NOOFINPAT,
         v_GROUPID,
         v_GROUPFLAG,
         v_WARDID,
         v_DEPTID,
         v_TYPEDOCTOR,
         v_TYPEDATE, --时间
         v_AUDITOR,
         v_DATEOFAUDIT,
         v_EXECUTOR,
         v_EXECUTEDATE, --时间
         v_CANCELDOCTOR,
         v_CANCELDATE, --时间
         v_STARTDATE, --时间
         v_PRODUCTNO,
         v_NORMNO,
         v_MEDICINENO,
         v_DRUGNO,
         v_DRUGNAME,
         v_DRUGNORM,
         v_ITEMTYPE,
         v_MINUNIT,
         v_DRUGDOSE,
         v_DOSEUNIT,
         v_UNITRATE,
         v_UNITTYPE,
         v_DRUGUSE,
         v_BATCHNO,
         v_EXECUTECOUNT,
         v_EXECUTECYCLE,
         v_CYCLEUNIT,
         v_DATEOFWEEK,
         v_INNEREXECUTETIME, --时间
         v_ZXTS,
         v_TOTALDOSE,
         v_ENTRUST,
         v_ORDERTYPE,
         v_ORDERSTATUS,
         v_SPECIALMARK,
         v_CEASEID,
         v_CEASEDATE, --时间
         v_CONTENT,
         v_SYNCH,
         v_MEMO,
         v_FORMTYPE);
      --修改
    elsif v_EditType = '2' then
      update TEMP_ORDER
         set NOOFINPAT        = nvl(v_NOOFINPAT, NOOFINPAT),
             GROUPID          = nvl(v_GROUPID, GROUPID),
             GROUPFLAG        = nvl(v_GROUPFLAG, GROUPFLAG),
             WARDID           = nvl(v_WARDID, WARDID),
             DEPTID           = nvl(v_DEPTID, DEPTID),
             TYPEDOCTOR       = nvl(v_TYPEDOCTOR, TYPEDOCTOR),
             TYPEDATE         = nvl(v_TYPEDATE, TYPEDATE), --时间
             AUDITOR          = nvl(v_AUDITOR, AUDITOR),
             DATEOFAUDIT      = nvl(v_DATEOFAUDIT, DATEOFAUDIT),
             EXECUTOR         = nvl(v_EXECUTOR, EXECUTOR),
             EXECUTEDATE      = nvl(v_EXECUTEDATE, EXECUTEDATE), --时间
             CANCELDOCTOR     = nvl(v_CANCELDOCTOR, CANCELDOCTOR),
             CANCELDATE       = nvl(v_CANCELDATE, CANCELDATE), --时间
             STARTDATE        = nvl(v_STARTDATE, STARTDATE), --时间
             PRODUCTNO        = nvl(v_PRODUCTNO, PRODUCTNO),
             NORMNO           = nvl(v_NORMNO, NORMNO),
             MEDICINENO       = nvl(v_MEDICINENO, MEDICINENO),
             DRUGNO           = nvl(v_DRUGNO, DRUGNO),
             DRUGNAME         = nvl(v_DRUGNAME, DRUGNAME),
             DRUGNORM         = nvl(v_DRUGNORM, DRUGNORM),
             ITEMTYPE         = nvl(v_ITEMTYPE, ITEMTYPE),
             MINUNIT          = nvl(v_MINUNIT, MINUNIT),
             DRUGDOSE         = nvl(v_DRUGDOSE, DRUGDOSE),
             DOSEUNIT         = nvl(v_DOSEUNIT, DOSEUNIT),
             UNITRATE         = nvl(v_UNITRATE, UNITRATE),
             UNITTYPE         = nvl(v_UNITTYPE, UNITTYPE),
             DRUGUSE          = nvl(v_DRUGUSE, DRUGUSE),
             BATCHNO          = nvl(v_BATCHNO, BATCHNO),
             EXECUTECOUNT     = nvl(v_EXECUTECOUNT, EXECUTECOUNT),
             EXECUTECYCLE     = nvl(v_EXECUTECYCLE, EXECUTECYCLE),
             CYCLEUNIT        = nvl(v_CYCLEUNIT, CYCLEUNIT),
             DATEOFWEEK       = nvl(v_DATEOFWEEK, DATEOFWEEK),
             INNEREXECUTETIME = nvl(v_INNEREXECUTETIME, INNEREXECUTETIME), --时间
             ZXTS             = nvl(v_ZXTS, ZXTS),
             TOTALDOSE        = nvl(v_TOTALDOSE, TOTALDOSE),
             ENTRUST          = nvl(v_ENTRUST, ENTRUST),
             ORDERTYPE        = nvl(v_ORDERTYPE, ORDERTYPE),
             ORDERSTATUS      = nvl(v_ORDERSTATUS, ORDERSTATUS),
             SPECIALMARK      = nvl(v_SPECIALMARK, SPECIALMARK),
             CEASEID          = nvl(v_CEASEID, CEASEID),
             CEASEDATE        = nvl(v_CEASEDATE, CEASEDATE), --时间
             CONTENT          = nvl(v_CONTENT, CONTENT),
             SYNCH            = nvl(v_SYNCH, SYNCH),
             MEMO             = nvl(v_MEMO, MEMO),
             FORMTYPE         = nvl(v_FORMTYPE, FORMTYPE)
       where TEMPID = v_TEMPID;
      --删除
    elsif v_EditType = '3' then
      delete TEMP_ORDER where TEMPID = v_TEMPID;
      --查看
    elsif v_EditType = '4' then
      open o_result for
        select * from TEMP_ORDER where TEMPID = v_TEMPID;

    end if;
  end;

  /*****************************************************************************/
  PROCEDURE usp_editallergyhistoryinfo(v_edittype     VARCHAR, --编辑信息类型：1：添加、2：修改、3：删除
                                       v_id           NUMERIC, --唯一列
                                       v_noofinpat    NUMERIC DEFAULT '-1', --病人首页序号
                                       v_allergyid    INT DEFAULT -1, --过敏类型
                                       v_allergylevel INT DEFAULT -1, --过敏程度
                                       v_doctor       VARCHAR DEFAULT '', --代理医生
                                       v_allergypart  VARCHAR DEFAULT '', --过敏部位
                                       v_reactiontype VARCHAR DEFAULT '', --反应类型
                                       v_memo         VARCHAR DEFAULT '' --备注
                                       ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑过敏史信息
     功能说明
     输入参数
     输出参数
     结果集、排序

     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_edittype = '1' THEN
      --添加
      INSERT INTO allergyhistory
        (ID,
         noofinpat,
         allergyid,
         allergylevel,
         doctor,
         allergypart,
         reactiontype,
         memo)
      VALUES
        (seq_allergyhistory_id.NEXTVAL,
         v_noofinpat,
         v_allergyid,
         v_allergylevel,
         v_doctor,
         v_allergypart,
         v_reactiontype,
         v_memo);
    ELSIF (v_edittype = '2') THEN
      --修改
      UPDATE allergyhistory
         SET noofinpat    = v_noofinpat,
             allergyid    = v_allergyid,
             allergylevel = v_allergylevel,
             doctor       = v_doctor,
             allergypart  = v_allergypart,
             reactiontype = v_reactiontype,
             memo         = v_memo
       WHERE ID = v_id;
    ELSIF (v_edittype = '3') THEN
      --删除
      DELETE allergyhistory WHERE ID = v_id;
    END IF;
  END;

  /******************************************************************************/
  PROCEDURE usp_editfamilyhistoryinfo(v_edittype  VARCHAR, --编辑信息类型：1：添加、2：修改、3：删除
                                      v_id        NUMERIC, --联系人编号，是病人联系人的唯一标识
                                      v_noofinpat NUMERIC DEFAULT '-1',
                                      --首页序号(住院流水号)(Inpatient.NoOfInpat)
                                      v_relation  VARCHAR DEFAULT '', --家族关系
                                      v_birthday  VARCHAR DEFAULT '', --出生日期（在前台显示年龄）
                                      v_diseaseid VARCHAR DEFAULT '', --病种代码
                                      v_breathing INT DEFAULT '', --是否健在(1:是：0否)
                                      v_cause     VARCHAR DEFAULT '', --死亡原因
                                      v_memo      VARCHAR DEFAULT '' --备注
                                      ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑家族信息
     功能说明
     输入参数
     输出参数
     结果集、排序

     exec usp_EditFamilyHistoryInfo v_EditType='3',v_ID='5'

     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_edittype = '1' THEN
      --添加
      INSERT INTO familyhistory
        (ID,
         noofinpat,
         relation,
         birthday,
         diseaseid,
         breathing,
         cause,
         memo)
      VALUES
        (seq_familyhistory_id.NEXTVAL,
         v_noofinpat,
         v_relation,
         v_birthday,
         v_diseaseid,
         v_breathing,
         v_cause,
         v_memo);
    ELSIF v_edittype = '2' THEN
      --修改
      UPDATE familyhistory
         SET noofinpat = v_noofinpat,
             relation  = v_relation,
             birthday  = v_birthday,
             diseaseid = v_diseaseid,
             breathing = v_breathing,
             cause     = v_cause,
             memo      = v_memo
       WHERE ID = v_id;
    ELSIF v_edittype = '3' THEN
      --删除
      DELETE familyhistory WHERE ID = v_id;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_editillnesshistoryinfo(v_edittype     VARCHAR, --编辑信息类型：1：添加、2：修改、3：删除
                                       v_id           NUMERIC, --唯一列
                                       v_noofinpat    NUMERIC DEFAULT '-1', --病人首页序号
                                       v_diagnosisicd VARCHAR DEFAULT '', --病种代码
                                       v_discuss      VARCHAR DEFAULT '', --疾病评论
                                       v_diseasetime  VARCHAR DEFAULT '', --病发时间
                                       v_cure         INT DEFAULT '', --是否治愈
                                       v_memo         VARCHAR DEFAULT '' --备注
                                       ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑疾病史信息
     功能说明
     输入参数
     输出参数
     结果集、排序

     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_edittype = '1' THEN
      --添加
      INSERT INTO illnesshistory
        (ID, noofinpat, diagnosisicd, discuss, diseasetime, cure, memo)
      VALUES
        (seq_illnesshistory_id.NEXTVAL,
         v_noofinpat,
         v_diagnosisicd,
         v_discuss,
         v_diseasetime,
         v_cure,
         v_memo);
    ELSIF v_edittype = '2' THEN
      --修改
      UPDATE illnesshistory
         SET noofinpat    = v_noofinpat,
             diagnosisicd = v_diagnosisicd,
             discuss      = v_discuss,
             diseasetime  = v_diseasetime,
             cure         = v_cure,
             memo         = v_memo
       WHERE ID = v_id;
    ELSIF v_edittype = '3' THEN
      --删除
      DELETE illnesshistory WHERE ID = v_id;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_editnotesonnursinginfonew(v_noofinpat     NUMERIC, --首页序号(住院流水号)
                                          v_dateofsurvey  VARCHAR, --测量日期期（格式2010-01-01）
                                          v_indx          VARCHAR, --序号
                                          v_timeslot      VARCHAR, --测量时间段
                                          v_temperature   VARCHAR DEFAULT '', --患者体温
                                          v_wayofsurvey   INT DEFAULT 8800, --体温测量方式代码
                                          v_pulse         VARCHAR DEFAULT '', --脉搏
                                          v_heartrate     VARCHAR DEFAULT '', --心率
                                          v_breathe       VARCHAR DEFAULT '', --患者呼吸
                                          v_bloodpressure VARCHAR DEFAULT '', --患者血压
                                          v_timeofshit    VARCHAR DEFAULT '',
                                          --大便次数，格式：1*(3/2E ),'*'表示大便失禁
                                          v_countin          VARCHAR DEFAULT '', --患者总入量
                                          v_countout         VARCHAR DEFAULT '', --患者总出量
                                          v_drainage         VARCHAR DEFAULT '', --引流量
                                          v_height           VARCHAR DEFAULT '', --患者身高
                                          v_weight           VARCHAR DEFAULT '', --患者体重
                                          v_allergy          VARCHAR DEFAULT '', --患者过敏物
                                          v_daysaftersurgery VARCHAR DEFAULT '', --手术后日数
                                          v_dayofhospital    VARCHAR DEFAULT '', --住院天数
                                          v_physicalcooling  VARCHAR DEFAULT '', --物理降温
                                          v_doctorofrecord   VARCHAR, --记录医生
                                          v_PhysicalHotting  varchar default '', --物理升温 edit by ywk
                                          v_PainInfo         varchar default '' --疼痛
                                          ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  保存护理信息数据
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    --删除原数据(应该加上病案首页序号删除  edit by ywk 2012年4月20日14:55:41)
    DELETE notesonnursing
     WHERE dateofsurvey = v_dateofsurvey
          --AND notesonnursing.indx = v_indx
       and timeslot = v_timeslot
       and noofinpat = v_noofinpat;

    /* --保存护理信息数据
    INSERT INTO notesonnursing
      (ID,
       noofinpat,
       dateofsurvey,
       temperature,
       wayofsurvey,
       pulse,
       heartrate,
       breathe,
       timeslot,
       bloodpressure,
       timeofshit,
       countin,
       countout,
       drainage,
       height,
       weight,
       allergy,
       daysaftersurgery,
       dayofhospital,
       physicalcooling,
       doctorofrecord,
       physicalhotting,
       paininfo
       )
    VALUES
      (seq_notesonnursing_id.NEXTVAL,
       v_noofinpat,
       v_dateofsurvey,
       v_temperature,
       v_wayofsurvey,
       v_pulse,
       v_heartrate,
       v_breathe,
       v_timeslot,
       v_bloodpressure,
       v_timeofshit,
       v_countin,
       v_countout,
       v_drainage,
       v_height,
       v_weight,
       v_allergy,
       v_daysaftersurgery,
       v_dayofhospital,
       v_physicalcooling,
       v_doctorofrecord,
       v_PhysicalHotting,
       v_PainInfo
       );*/
    --保存护理信息数据
    INSERT INTO notesonnursing
      (ID,
       noofinpat,
       dateofsurvey,
       temperature,
       wayofsurvey,
       pulse,
       heartrate,
       breathe,
       timeslot,
       --bloodpressure,
       --timeofshit,
       --countin,
       --countout,
       --drainage,
       --height,
       --weight,
       --allergy,
       --daysaftersurgery,
       --dayofhospital,
       physicalcooling,
       doctorofrecord,
       physicalhotting,
       paininfo
       --indx
       )
    VALUES
      (seq_notesonnursing_id.NEXTVAL,
       v_noofinpat,
       v_dateofsurvey,
       v_temperature,
       v_wayofsurvey,
       v_pulse,
       v_heartrate,
       v_breathe,
       v_timeslot,
       --v_bloodpressure,
       --v_timeofshit,
       --v_countin,
       -- v_countout,
       --v_drainage,
       --v_height,
       -- v_weight,
       --v_allergy,
       -- v_daysaftersurgery,
       --v_dayofhospital,
       v_physicalcooling,
       v_doctorofrecord,
       v_PhysicalHotting,
       v_PainInfo
       --v_indx
       );
  END;

  /*********************************************************************************/
  PROCEDURE usp_editnotesonnursinginfo(v_noofinpat     NUMERIC, --首页序号(住院流水号)
                                       v_dateofsurvey  VARCHAR, --测量日期期（格式2010-01-01）
                                       v_timeslot      VARCHAR, --测量时间段
                                       v_temperature   VARCHAR DEFAULT '', --患者体温
                                       v_wayofsurvey   INT DEFAULT 8800, --体温测量方式代码
                                       v_pulse         VARCHAR DEFAULT '', --脉搏
                                       v_heartrate     VARCHAR DEFAULT '', --心率
                                       v_breathe       VARCHAR DEFAULT '', --患者呼吸
                                       v_bloodpressure VARCHAR DEFAULT '', --患者血压
                                       v_timeofshit    VARCHAR DEFAULT '',
                                       --大便次数，格式：1*(3/2E ),'*'表示大便失禁
                                       v_countin          VARCHAR DEFAULT '', --患者总入量
                                       v_countout         VARCHAR DEFAULT '', --患者总出量
                                       v_drainage         VARCHAR DEFAULT '', --引流量
                                       v_height           VARCHAR DEFAULT '', --患者身高
                                       v_weight           VARCHAR DEFAULT '', --患者体重
                                       v_allergy          VARCHAR DEFAULT '', --患者过敏物
                                       v_daysaftersurgery VARCHAR DEFAULT '', --手术后日数
                                       v_dayofhospital    VARCHAR DEFAULT '', --住院天数
                                       v_physicalcooling  VARCHAR DEFAULT '', --物理降温
                                       v_doctorofrecord   VARCHAR, --记录医生
                                       v_PhysicalHotting  varchar default '', --物理升温 edit by ywk
                                       v_PainInfo         varchar default '' --疼痛
                                       ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  保存护理信息数据
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    --删除原数据(应该加上病案首页序号删除  edit by ywk 2012年4月20日14:55:41)
    DELETE notesonnursing
     WHERE dateofsurvey = v_dateofsurvey
       AND timeslot = v_timeslot
       and noofinpat = v_noofinpat;

    /* --保存护理信息数据
    INSERT INTO notesonnursing
      (ID,
       noofinpat,
       dateofsurvey,
       temperature,
       wayofsurvey,
       pulse,
       heartrate,
       breathe,
       timeslot,
       bloodpressure,
       timeofshit,
       countin,
       countout,
       drainage,
       height,
       weight,
       allergy,
       daysaftersurgery,
       dayofhospital,
       physicalcooling,
       doctorofrecord,
       physicalhotting,
       paininfo
       )
    VALUES
      (seq_notesonnursing_id.NEXTVAL,
       v_noofinpat,
       v_dateofsurvey,
       v_temperature,
       v_wayofsurvey,
       v_pulse,
       v_heartrate,
       v_breathe,
       v_timeslot,
       v_bloodpressure,
       v_timeofshit,
       v_countin,
       v_countout,
       v_drainage,
       v_height,
       v_weight,
       v_allergy,
       v_daysaftersurgery,
       v_dayofhospital,
       v_physicalcooling,
       v_doctorofrecord,
       v_PhysicalHotting,
       v_PainInfo
       );*/
    --保存护理信息数据
    INSERT INTO notesonnursing
      (ID,
       noofinpat,
       dateofsurvey,
       temperature,
       wayofsurvey,
       pulse,
       heartrate,
       breathe,
       timeslot,
       --bloodpressure,
       --timeofshit,
       --countin,
       --countout,
       --drainage,
       --height,
       --weight,
       --allergy,
       --daysaftersurgery,
       --dayofhospital,
       physicalcooling,
       doctorofrecord,
       physicalhotting,
       paininfo)
    VALUES
      (seq_notesonnursing_id.NEXTVAL,
       v_noofinpat,
       v_dateofsurvey,
       v_temperature,
       v_wayofsurvey,
       v_pulse,
       v_heartrate,
       v_breathe,
       v_timeslot,
       --v_bloodpressure,
       --v_timeofshit,
       --v_countin,
       -- v_countout,
       --v_drainage,
       --v_height,
       -- v_weight,
       --v_allergy,
       -- v_daysaftersurgery,
       --v_dayofhospital,
       v_physicalcooling,
       v_doctorofrecord,
       v_PhysicalHotting,
       v_PainInfo);
  END;

  --护士三测单信息维护中。病人状态信息的维护 add by ywk 2012年4月23日14:05:18

  PROCEDURE usp_Edit_PatStates(v_EditType  varchar default '', --操作类型
                               v_CCode     varchar default '',
                               V_ID        varchar default '',
                               v_NoofInPat varchar default '',
                               v_DoTime    varchar default '',
                               v_Patid     varchar default '',
                               o_result    OUT empcurtyp) as
  begin
    open o_result for

      select V_ID from dual;
    --添加
    if v_EditType = '1' then
      INSERT INTO PatientStatus
        (ID, CCODE, NOOFINPAT, DoTime, Patid)
      VALUES
        (seq_Emr_ConfigPoint_ID.Nextval,
         v_CCode,
         v_NoofInPat,
         v_DoTime,
         v_Patid);

      --修改
    elsif v_EditType = '2' then

      UPDATE PatientStatus
         set CCODE     = v_CCode,
             DoTime    = v_DoTime,
             NOOFINPAT = v_NoofInPat,
             Patid     = v_Patid
       WHERE id = V_ID;

      --删除
    elsif v_EditType = '3' then

      /*update Emr_ConfigPoint a set a.valid = 0 where ID = V_ID;*/
      delete from PatientStatus
       where CCODE = v_CCode
         and NOOFINPAT = v_NoofInPat
         and id = V_id
         and Patid = v_Patid;
      commit;

      /*--查询
      elsif v_EditType = '4' then open o_result for
        select (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from Emr_ConfigPoint a
         where  a.valid = '1'
         order by id;*/
    end if;
  end;

  /*********************************************************************************/
  PROCEDURE usp_editpatientcontacts(v_edittype  VARCHAR, --编辑信息类型：1：添加、2：修改、3：删除
                                    v_id        NUMERIC DEFAULT '0', --联系人编号，是病人联系人的唯一标识
                                    v_noofinpat NUMERIC DEFAULT '0',
                                    --首页序号(住院流水号)(Inpatient.NoOfInpat)
                                    v_name     VARCHAR DEFAULT '', --联系人名
                                    v_sex      VARCHAR DEFAULT '', --性别
                                    v_relation VARCHAR DEFAULT '',
                                    --联系关系(Dictionary_detail.DetailID, ID = '44')
                                    v_address    VARCHAR DEFAULT '', --联系地址
                                    v_workunit   VARCHAR DEFAULT '', --联系(人)单位
                                    v_hometel    VARCHAR DEFAULT '', --联系人家庭电话
                                    v_worktel    VARCHAR DEFAULT '', --联系人工作电话
                                    v_postalcode VARCHAR DEFAULT '', --联系邮编
                                    v_tag        VARCHAR DEFAULT '' --联系人标志
                                    ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑第一联系人信息
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例
     exec usp_EditPatientContacts v_EditType='1',v_ID='0',v_NoOfInpat='75278',v_Name='李琼',v_Sex='2'
     ,v_Relation='05',v_Address='南京市浦口区雨山西路江浦街道',v_WorkUnit='南京市浦口区农业银行'
     ,v_HomeTel='15851867666',v_WorkTel='3422937293',v_PostalCode='3402334',v_Tag='0'
     修改记录
    **********/
  BEGIN
    IF v_edittype = '1' THEN
      --添加
      INSERT INTO patientcontacts
        (ID,
         noofinpat,
         NAME,
         sex,
         relation,
         address,
         workunit,
         hometel,
         worktel,
         postalcode,
         tag)
      VALUES
        (seq_patientcontacts_id.NEXTVAL,
         v_noofinpat,
         v_name,
         v_sex,
         v_relation,
         v_address,
         v_workunit,
         v_hometel,
         v_worktel,
         v_postalcode,
         v_tag);
    ELSIF v_edittype = '2' THEN
      --修改
      UPDATE patientcontacts
         SET NAME       = v_name,
             sex        = v_sex,
             relation   = v_relation,
             address    = v_address,
             workunit   = v_workunit,
             hometel    = v_hometel,
             worktel    = v_worktel,
             postalcode = v_postalcode,
             tag        = v_tag
       WHERE ID = v_id;
    ELSIF v_edittype = '3' THEN
      --删除
      DELETE patientcontacts WHERE ID = v_id;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_editpersonalhistoryinfo(v_noofinpat    NUMERIC, --病人首页序号
                                        v_marital      VARCHAR, --婚姻状况
                                        v_noofchild    INT, --孩子数量
                                        v_jobhistory   VARCHAR, --职业经历
                                        v_drinkwine    INT, --是否饮酒
                                        v_winehistory  VARCHAR, --饮酒史
                                        v_smoke        INT, --是否吸烟
                                        v_smokehistory VARCHAR, --吸烟史
                                        v_birthplace   VARCHAR, --出生地（省市）
                                        v_passplace    VARCHAR, --经历地（省市）
                                        v_memo         VARCHAR DEFAULT '' --备注
                                        ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑个人史信息
     功能说明
     输入参数
     输出参数
     结果集、排序

     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    --删除当前记录
    DELETE personalhistory WHERE noofinpat = v_noofinpat;

    --添加
    INSERT INTO personalhistory
      (ID,
       noofinpat,
       marital,
       noofchild,
       jobhistory,
       drinkwine,
       winehistory,
       smoke,
       smokehistory,
       birthplace,
       passplace,
       memo)
    VALUES
      (seq_personalhistory_id.NEXTVAL,
       v_noofinpat,
       v_marital,
       v_noofchild,
       v_jobhistory,
       v_drinkwine,
       v_winehistory,
       v_smoke,
       v_smokehistory,
       v_birthplace,
       v_passplace,
       v_memo);
  END;

  /*********************************************************************************/
  PROCEDURE usp_editsurgeryhistoryinfo(v_edittype    VARCHAR, --编辑信息类型：1：添加、2：修改、3：删除
                                       v_id          NUMERIC, --唯一列
                                       v_noofinpat   NUMERIC DEFAULT '-1', --病人首页序号
                                       v_surgeryid   VARCHAR DEFAULT '', --手术代码(Surgery.ID)
                                       v_diagnosisid VARCHAR DEFAULT '', --疾病（Diagnosis.ICD）
                                       v_discuss     VARCHAR DEFAULT '', --评论
                                       v_doctor      VARCHAR DEFAULT '', --手术医生
                                       v_memo        VARCHAR DEFAULT '' --备注
                                       ) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑手术史信息
     功能说明
     输入参数
     输出参数
     结果集、排序

     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_edittype = '1' THEN
      --添加
      INSERT INTO surgeryhistory
        (ID, noofinpat, surgeryid, diagnosisid, discuss, doctor, memo)
      VALUES
        (seq_surgeryhistory_id.NEXTVAL,
         v_noofinpat,
         v_surgeryid,
         v_diagnosisid,
         v_discuss,
         v_doctor,
         v_memo);
    ELSIF v_edittype = '2' THEN
      --修改
      UPDATE surgeryhistory
         SET noofinpat   = v_noofinpat,
             surgeryid   = v_surgeryid,
             diagnosisid = v_diagnosisid,
             discuss     = v_discuss,
             doctor      = v_doctor,
             memo        = v_memo
       WHERE ID = v_id;
    ELSIF v_edittype = '3' THEN
      --删除
      DELETE surgeryhistory WHERE ID = v_id;
    END IF;
  END;

  /************************************************************************************/
  PROCEDURE usp_emr_modelsearcher(v_flag   INT,
                                  v_type   VARCHAR,
                                  o_result OUT empcurtyp) AS
    /**********
     版本号 1.0.0.0.0
     创建时间 2007.02.8
     作者 周辉
     版权
     描述 .NET模型选择
     功能说明
     NET模型选择
     参数说明
      v_flag   int,  --模型分类类别
      v_type  int,  --模型类别
     返回值
     结果集、排序
     调用的sp
     调用实例
    exec  usp_Emr_ModelSearcher  0,3800
     修改历史
    **********/
    v_sql    VARCHAR(500);
    v_dybm   VARCHAR(20);
    v_sortid VARCHAR(10);
    v_mbmc   VARCHAR(10);
    v_mbms   VARCHAR(10);
    v_mxmc   VARCHAR(10);
  BEGIN
    IF v_type = 3800 THEN
      BEGIN
        v_dybm   := 'Model_Atom';
        v_sortid := 'DisMode';
        v_mbmc   := 'jdxsm';
        v_mbms   := 'jdms';
      END;
    ELSIF v_type = 3801 THEN
      BEGIN
        v_dybm   := 'Model_Object';
        v_sortid := 'SortID';
        v_mbmc   := 'dxmc';
        v_mbms   := 'dxms';
      END;
    ELSIF v_type = 3802 THEN
      BEGIN
        v_dybm   := 'Model_Embed';
        v_sortid := 'SortID';
        v_mbmc   := 'qrmbmc';
        v_mbms   := 'qrmbms';
      END;
    ELSIF v_type = 3804 THEN
      BEGIN
        v_dybm   := 'Model_Docment';
        v_sortid := 'SortID';
        v_mbmc   := 'mbmc';
        v_mbms   := 'mbms';
      END;
    ELSIF v_type = 3805 THEN
      BEGIN
        v_dybm   := 'Model_Record';
        v_sortid := 'SortID';
        v_mbmc   := 'zhmbmc';
        v_mbms   := 'zhmbms';
      END;
    ELSIF v_type = 3806 THEN
      BEGIN
        v_dybm   := 'Model_Table';
        v_sortid := 'SortID';
        v_mbmc   := 'bgmc';
        v_mbms   := 'bgms';
      END;
    ELSIF v_type = 3807 THEN
      BEGIN
        v_dybm   := 'Model_Structure';
        v_sortid := 'SortID';
        v_mbmc   := 'dxmc';
        v_mbms   := 'dxms';
      END;
    END IF;

    IF v_flag = 0 THEN
      BEGIN
        v_sql := 'select a.ID,a.Name,a.Describe,b.ID CatalogID ,b.Name Catalog,a.' ||
                 v_sortid || ' PrevID,a.' || v_sortid || ' SortID';

        IF (v_type <> 3800) THEN
          v_sql := v_sql || ', a.Valid';
        ELSE
          v_sql := v_sql || ',1 Valid';
        END IF;

        v_sql := v_sql || ' from ' || v_dybm ||
                 ' a left join ModelDirectory b on a.' || v_sortid ||
                 ' = b.ID order by ID';

        OPEN o_result FOR v_sql;
      END;
    END IF;
  END;

  /************************************************************************************/
  PROCEDURE USP_EMR_GETPATINFO(v_NoOfinpat varchar, o_result OUT empcurtyp) AS

    v_addresstip VARCHAR(30); --关于读取地址的配置标识

  begin
    select instr(value, '<IsReadAddressInfo>0</IsReadAddressInfo>', 1, 1)
      into v_addresstip
      from appcfg
     where configkey = 'EmrInputConfig';
    /* if v_addresstip = '0'--读取省市县
    then */
    open o_result for
      SELECT b.noofinpat  noofinpat, --首页序号
             b.patnoofhis patnoofhis, --HIS首页序号
             b.patid      patid, --住院号
             b.NAME   patname, --姓名
             b.sexid  sex, --病人性别
             j.name   sexname, --病人性别名称
             b.agestr agestr, --年龄
             b.py py, --拼音
             b.wb wb, --五笔
             b.status brzt, --病人状态
             e.NAME brztname, --病人状态名称
             RTRIM(b.criticallevel) wzjb, --危重级别
             i.NAME wzjbmc, --危重级别名称
             --case when PatID is null then ''
             --     else '一级护理'
             --end hljb --护理级别 名称
             /*
               cd.NAME hljb,CASE
             WHEN b.attendlevel IS NULL THEN   6105END attendlevel, --护理级别*/
             case b.attendlevel
               when '1' then
                '一级护理'
               when '2' then
                '二级护理'
               when '3' then
                '三级护理'
               when '4' then
                '特级护理'
               else
                '一级护理'
             end hljb, --护理级别

             case b.attendlevel
               when '1' then
                '6101'
               when '2' then
                '6102'
               when '3' then
                '6103'
               when '4' then
                '6104'
               else
                '6101'
             end attendlevel, --护理级别

             b.isbaby yebz, --婴儿标志
             CASE
               WHEN b.isbaby = '0' THEN
                '否'
               WHEN b.isbaby IS NULL THEN
                ''
               ELSE
                '是'
             END yebzname,
             a.wardid bqdm, --病区代码
             a.deptid ksdm, --科室代码
             --a.ID bedid, --床位代码
             b.outbed bedid, --出院床位
             dg.NAME  ksmc,--科室名称
             wh.NAME        bqmc, --病区名称
             a.formerward   ybqdm, --原病区代码
             a.formerdeptid yksdm, --原科室代码
             a.formerdeptid ycwdm, --原床位代码
             a.inbed        inbed, --占床标志
             a.borrow       jcbz, --借床标志
             a.sexinfo      cwlx, --床位类型
             -- SUBSTR(b.admitdate, 1, 16) admitdate,--入院时间
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'yyyy') || '年' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'MM') || '月' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'dd') || '日' || ' ' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'hh24') || ':' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'mi') admitdate, --入院时间

            b.admitdiagnosis     ryzd, --入院诊断
           b.admitdiagnosis     zdmc, --诊断名称
             b.resident zyysdm, --住院医生代码
             c.NAME     zyys, --住院医生
             c.NAME  cwys, --床位医生
             g.NAME  zzys, --主治医师
             h.NAME  zrys, --主任医师
             a.valid yxjl, --有效记录
             --me.pzlx pzlx, --凭证类型
             dd1.NAME pzlx, --费用类别
             /*TO_CHAR((CASE
              WHEN INSTR(v_deptids, a.deptid) = 0 AND (b.noofinpat IS NULL) THEN
                '属于其它科室'
             END)) extra, --额外信息*/
             b.memo memo, --备注
             (CASE b.cpstatus
               WHEN 0 THEN
                '未引入'
               WHEN 1 THEN
                '执行中'
               WHEN 2 THEN
                '退出'
             END) cpstatus,
             CASE
               WHEN b.noofinpat IS NULL THEN
                ''
               ELSE
                '己书写'
             END recordinfo,
             100 ye, --余额
             (SELECT CASE
                       WHEN COUNT(qc.foulstate) > 0 THEN
                        '是'
                       ELSE
                        '否'
                     END
                FROM qcrecord qc
               WHERE qc.noofinpat = b.noofinpat
                 AND qc.valid = 1
                 AND qc.foulstate = 1) AS iswarn, --是否违规

             b.organization Organization, --工作单位
             b.officeplace, --工作单位（新）

             --NVL(b.nativeaddress, b.officeplace) Address, --户口住址 edit by ywk

             case
               when v_addresstip > 0 then
                b.nativeaddress
               else
                b.xzzaddress ---hkaddress
             end Address, --仁和需求:户口住址   edit by ywk
             b.officetel OFFICETEL, ---工作单位电话 add by ywk 2012年8月14日 11:31:35
             b.xzztel TEL, --现住址电话 add  by ywk 2012年8月14日 11:32:12 原来的电话就标志为现住址电话
             --NVL(b.nativetel, b.officetel) TEL, --电话
             b.idno  IDNO, --身份证号
             j1.name JobName, --职位
             --b.inwarddate inwarddate, --入科时间
             to_char(to_date(b.inwarddate, 'yyyy-MM-dd hh24:mi:ss'), 'yyyy') || '年' ||
             to_char(to_date(b.inwarddate, 'yyyy-MM-dd hh24:mi:ss'), 'MM') || '月' ||
             to_char(to_date(b.inwarddate, 'yyyy-MM-dd hh24:mi:ss'), 'dd') || '日' || ' ' ||
             to_char(to_date(b.inwarddate, 'yyyy-MM-dd hh24:mi:ss'), 'hh24') || ':' ||
             to_char(to_date(b.inwarddate, 'yyyy-MM-dd hh24:mi:ss'), 'mi') inwarddate, --入科时间
             j2.name marital, --婚姻
             --nvl(a2.name, a1.name) HOMETOWN, --出生地
             --a2.name || a1.name HOMETOWN,

             --case when v_addresstip = '0' then
             /*  case when a1.provincename = a2.cityname then a1.provincename
             else a1.provincename || a2.cityn*/ --end HOMETOWN,
             -- else  b.csdaddress
             -- end HOMETOWN,

             case
               when v_addresstip > 0 then
                --case
                 -- when a1.provincename = a2.cityname then
                --   a1.provincename
                 -- else
                   --a1.provincename || a2.cityname
                   b.provinceid
                --end
               else
                b.csdaddress
             end HOMETOWN, --出生地

             case
               when v_addresstip > 0 then
                --case
                --  when a3.provincename = a4.cityname then
                  -- a3.provincename
                --  else
                  -- a3.provincename || a4.cityname
                  b.nativeplace_p
               -- end --JiGuan, --籍贯
               else
                b.jgaddress
             end JiGuan, --籍贯

             /*  case when a3.provincename = a4.cityname then a3.provincename
             else a3.provincename || a4.cityname end JiGuan, --籍贯
             --else b.jgaddress end*/ -- JiGuan,--籍贯

             to_char(to_date(b.birth, 'yyyy-MM-dd hh24:mi:ss'), 'yyyy') || '年' ||
             to_char(to_date(b.birth, 'yyyy-MM-dd hh24:mi:ss'), 'MM') || '月' ||
             to_char(to_date(b.birth, 'yyyy-MM-dd hh24:mi:ss'), 'dd') || '日' birth, --出生日期
             j3.name nation, --民族
             --trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')) INADMITDATE, --入院日期
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'yyyy') || '年' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'MM') || '月' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'dd') || '日' INADMITDATE, --入院日期
             b.contactaddress CONTACTADDRESS, --联系人地址
             b.contactperson CONTACTPERSON, --联系人姓名
             b.contacttel CONTACTTEL, --联系人电话
             b.incount INCOUNT, --住院次数
             patdiag.diag_content DIAGCONTENT, --主要诊断
             d1.name ADMITDEPT, --入院科室
             w1.name ADMITWARD, --入院病区
             case
               --xll 2013-08-15 修改为 住院天数不足一天为1天 算入院当天 不算出院当天
               when b.status in (1500, 1501) then --病人在院时 拿当前时间-入院时间+1  xull 2013-05-08
               /* trunc(sysdate) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')) + 1*/
                decode(trunc(sysdate) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')),0,1,trunc(sysdate) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')))
               when b.outwarddate is not null then --其他状态 病人有出区时间 出区时间-入院+1
               /* trunc(to_date(b.outwarddate, 'yyyy-MM-dd hh24:mi:ss')) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')) + 1*/
                decode(trunc(to_date(b.outwarddate, 'yyyy-MM-dd hh24:mi:ss')) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')),0,1,trunc(to_date(b.outwarddate, 'yyyy-MM-dd hh24:mi:ss')) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')))

               when b.outhosdate is not null then --其他状态 病人有出院时间 出院时间-入院+1
               /* trunc(to_date(b.outhosdate, 'yyyy-MM-dd hh24:mi:ss')) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')) + 1*/
                decode(trunc(to_date(b.outhosdate, 'yyyy-MM-dd hh24:mi:ss')) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')),0,1,trunc(to_date(b.outhosdate, 'yyyy-MM-dd hh24:mi:ss')) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')))
               else --其他无法预料 直接当前时间-入院时间+1  xull 2013-05-08 一般不存在
               /* trunc(sysdate) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')) + 1*/
                 decode(trunc(sysdate) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')),0,1,trunc(sysdate) -
                trunc(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss')))
             end indays, --住院天数
             u1.name ClinicDoctor, --门诊医生
             u2.name Resident, --住院医生
             u3.name Attend, --主治医师
             u4.name Chief, --主任医师
             b.isbaby, ---新增取得当前用户是不是婴儿，add by ywk
             b.mother, ---母亲的首页序号也取出来 add by ywk 2012年11月23日15:54:23
             j5.name relations,
               to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'yyyy') || '年' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'MM') || '月' ||
             to_char(to_date(b.admitdate, 'yyyy-MM-dd hh24:mi:ss'), 'dd') || '日' jieqi --计算节气的日期
        FROM /*
             bed a
             LEFT JOIN inpatient b ON a.noofinpat = b.noofinpat
                                  AND a.patnoofhis = b.patnoofhis
                                  and a.deptid = b.outhosdept
                                  AND a.inbed = 1301
                                  AND b.status IN (1501, 1504, 1505, 1506, 1507)
             */ inpatient b
        LEFT JOIN bed a
          ON a.noofinpat = b.noofinpat
         AND a.patnoofhis = b.patnoofhis
         AND a.deptid = b.outhosdept
         AND a.valid = '1'
        LEFT JOIN categorydetail e
          ON b.status = e.ID
         AND e.categoryid = '15'
      --LEFT JOIN medicareinfo me ON b.voucherscode = me.ID
        LEFT JOIN Dictionary_detail dd1
          ON dd1.categoryid = '1'
         AND b.payid = dd1.detailid
        LEFT JOIN department dg
          ON b.outhosdept = dg.ID
        LEFT JOIN ward wh
          ON b.outhosward = wh.id
      --   left join YY_SFXXMK e  on b.AttendLevel = e.sfxmdm
        LEFT JOIN diagnosis f
          ON f.icd = b.admitdiagnosis
        LEFT JOIN users c
          ON c.ID = b.resident
        LEFT JOIN dictionary_detail i
          ON i.detailid = b.criticallevel
         AND i.categoryid = '53'
        LEFT JOIN users g
          ON g.ID = b.attend
        LEFT JOIN users h
          ON h.ID = b.chief
        LEFT JOIN dictionary_detail j
          ON j.detailid = b.sexid
         AND j.categoryid = '3'
        LEFT JOIN dictionary_detail j1
          on j1.detailid = b.jobid
         AND j1.categoryid = '41'
        LEFT JOIN categorydetail cd
          ON b.attendlevel = cd.ID
         AND cd.categoryid = '63'
        LEFT JOIN dictionary_detail j2
          on j2.detailid = b.marital
         AND j2.categoryid = '4'
      --LEFT JOIN Areas a1 on a1.id = b.provinceid
      --                  AND a1.category = '1000'
      --LEFT JOIN Areas a2 on a2.id = b.countyid
      --                  AND a2.category = '1001'
       -- left outer JOIN s_province a1
        --  on a1.provinceid = b.provinceid
        left outer JOIN s_city a2
          on a2.cityid = b.countyid

       -- left outer join s_province a3
       --   on a3.provinceid = b.nativeplace_p
        left outer join s_city a4
          on a4.cityid = b.nativeplace_c

        LEFT JOIN dictionary_detail j3
          on j3.detailid = b.nationid
         AND j3.categoryid = '42'
        LEFT JOIN dictionary_detail j4
          on j4.detailid = b.nationalityid
         AND j4.categoryid = '43'
        LEFT JOIN patdiag
          on patdiag.diag_type_name = '入院诊断'
         AND patdiag.diag_no = 1
         AND patdiag.diag_sub_no = 0
         AND patdiag.patient_id = b.noofinpat
        LEFT JOIN department d1
          on d1.id = b.admitdept
         AND d1.valid = '1'
        LEFT JOIN ward w1
          on w1.id = b.admitward
         AND w1.valid = '1'
        LEFT JOIN users u1
          on u1.id = b.clinicdoctor
         and u1.valid = '1'
        LEFT JOIN users u2
          on u2.id = b.resident
         and u2.valid = '1'
        LEFT JOIN users u3
          on u3.id = b.attend
         and u3.valid = '1'
        LEFT JOIN users u4
          on u4.id = b.chief
         and u4.valid = '1'
        LEFT JOIN Dictionary_detail j5
          on j5.detailid = b.relationship
         AND j5.categoryid = '44'
       WHERE b.noofinpat = v_NoOfinpat;

  end;

  /*********************************************************************************/
  procedure usp_Emr_QueryOrderSuites(v_DeptID   varchar,
                                     v_WardID   varchar,
                                     v_DoctorID varchar,
                                     v_yzlr     int default 1,
                                     o_result   OUT empcurtyp,
                                     o_result1  OUT empcurtyp) as
    /**********
    [版本号] 1.0.0.0.0
    [创建时间] 2006.07.24
    [作者] 周辉
    [版权] Copyright ?
    [描述] 查询可用的成套医嘱
    [功能说明]
      现在按指定的科室进行查询。返回主记录和明细记录数据集
    [输入参数]
       v_DeptID  utKsdm  -- 科室代码
      ,v_WardID  utKsdm  -- 病区代码
      ,v_DoctorID  utCzyh  -- 医生工号
      ,v_yzlr  utBz  -- 是否是医嘱录入模块调用(0: 否  1:是)
    [输出参数]
    [结果集、排序]
      成套医嘱主记录数据集
      成套医嘱明细数据集
    [调用的sp]
    [调用实例]
      exec usp_Emr_QueryOrderSuites '2056', '2983', '001', 1
    **********/
    v_sql varchar2(4000);
  begin
    v_sql := 'truncate table tmp_Emr_QueryOrderSuites ';
    EXECUTE IMMEDIATE v_sql;

    -- 在界面上将按照长期、临时分别显示相应的成套医嘱，所以在生成数据集时要特殊处理，以满足数据过滤的需要
    insert into tmp_Emr_QueryOrderSuites
      select e.ID              GroupID,
             a.DetailID,
             a.Mark,
             a.SortMark,
             a.PlaceOfDrug,
             a.StandardOfDrug,
             a.ClinicIDOfDrug,
             a.DrugID,
             a.DrugName,
             a.ItemCategory,
             a.MinUnit,
             a.Dose,
             a.DoseUnit,
             a.MeasurementUnit,
             a.UnitCategory,
             a.UseageID,
             a.Frequency,
             a.EXECUTIONS,
             a.ExecuteCycle,
             a.CycleUnit,
             a.ZID,
             a.ExecuteDate,
             a.ExecuteDays,
             a.DrugGross,
             a.AdviceContent,
             a.AdviceCategory,
             e.Name,
             e.DeptID,
             e.WardID,
             e.DoctorID,
             e.UseRange,
             e.Memo,
             e.py,
             e.Wb,
             b.Name            yfmc,
             c.Name            pcmc --, d.Name yzbzmc--, f.Name yzlbmc
        from AdviceGroup e
        left join AdviceGroupDetail a
          on a.GroupID = e.ID
      --join YY_SJLBMXK d  on a.Mark = d.mxbh
      --join YY_SJLBMXK f  on a.AdviceCategory = f.mxbh
        left join DrugUseage b
          on a.UseageID = b.ID
        left join AdviceFrequency c
          on a.Frequency = c.ID
       where e.UseRange = 2900
          or (e.UseRange = 2901 and e.DeptID = v_DeptID)
          or (e.UseRange = 2903 and e.DoctorID = v_DoctorID);

    -- 输出结果集
    if v_yzlr = 1 then
      open o_result for
        select distinct GroupID,

                        Name,
                        DeptID,
                        WardID,
                        DoctorID,
                        UseRange,
                        Memo,
                        py,
                        Wb,
                        Mark,
                        (case AdviceCategory
                          when 3104 then
                           AdviceCategory
                          else
                           -1
                        end) AdviceCategory
          from tmp_Emr_QueryOrderSuites
         order by UseRange, Mark, AdviceCategory, Name;
    else
      open o_result for
        select distinct GroupID,
                        Name,
                        DeptID,
                        WardID,
                        DoctorID,
                        UseRange,
                        Memo,
                        py,
                        Wb
          from tmp_Emr_QueryOrderSuites
         order by UseRange, Name;
    end if;

    open o_result1 for
      select DetailID,
             GroupID,
             Mark,
             SortMark,
             PlaceOfDrug,
             StandardOfDrug,
             ClinicIDOfDrug,
             DrugID,
             DrugName,
             ItemCategory,
             MinUnit,
             Dose,
             DoseUnit,
             MeasurementUnit,
             UnitCategory,
             UseageID,
             Frequency,
             EXECUTIONS,
             ExecuteCycle,
             CycleUnit,
             ZID,
             ExecuteDate,
             ExecuteDays,
             DrugGross,
             AdviceContent,
             AdviceCategory
        from tmp_Emr_QueryOrderSuites
       where DetailID is not null
       order by GroupID, DetailID;

  end;

  /*********************************************************************************/
  procedure usp_Emr_SetOrderGroupSerialNo(v_NoOfInpat numeric,
                                          v_OrderType int,
                                          v_onlynew   int default 1) as
    /**********
    [版本号] 1.0.0.0.0
    [创建时间] 2007.02.14
    [作者]
    [版权] Copyright ?
    [描述] 设置医嘱的分组序号
    [功能说明]
      根据医嘱的分组标志重新设置指定病人的新长期或临时医嘱的分组序号。
      一般在医嘱保存后调用此存储过程进行统一设置（用来代替以前的医嘱表触发器）。
    [输入参数]
       v_NoOfInpat  utSyxh  -- EMR首页序号
      ,v_OrderType  utBz  -- 医嘱类别 0: 临时; 1: 长期; 2: 全部
      ,v_onlynew utBz = 1 -- 只处理新医嘱 1: 是; 0: 否
    [输出参数]
    [结果集、排序]
      成功 -- T
      失败 -- F, 失败原因
    [调用的sp]
    [调用实例]
       exec usp_Emr_SetOrderGroupSerialNo  32 , 1 ,1
    **********/
    v_tablename varchar2(40);
    v_cqlsbz    int;
    v_yzxh      int;
    v_GroupID   int;
    v_GroupFlag int;
    v_yznrlb    int;
    v_Memo      varchar2(50);
    --, v_lastcqlsbz utBz
    --, v_lastfzxh utXh12
    v_cyhzbz varchar2(50); -- 草药汇总信息标志
    v_sql    varchar2(4000);
  begin

    --yxy临时表暂时使用实体表
    /*
     v_tablename := 'tmp_newfzxh';

    droptable(v_tablename);
     --创建临时表

     v_sql := 'create table ' || v_tablename || '(
     cqlsbz  int    not null,  -- 长期临时标志, 0: 临时; 1: 长期
     yzxh  int  not null,  -- 医嘱序号
     GroupID  int  not null,  -- 分组序号
     GroupFlag  int  not null,  -- 分组标志
     OrderType  int  not null,  -- 医嘱类别(YY_SJLBMXK.mxbh, lbbh = 31)
     Memo  varchar(50)  null  ,  -- 备注
     constraint pk_newfzxh primary key (yzxh, cqlsbz)
     )';
     execute immediate v_sql;*/

    v_sql := 'truncate table tmp_newfzxh ';
    EXECUTE IMMEDIATE v_sql;

    if ((v_OrderType = 0) or (v_OrderType = 2)) then

      insert into tmp_newfzxh
        (cqlsbz, yzxh, GroupID, GroupFlag, OrderType, Memo)
        select 0, TempID, GroupID, GroupFlag, OrderType, Memo
          from Temp_Order
         where NoOfInpat = v_NoOfInpat
           and ((v_onlynew = 0) or
               ((v_onlynew = 1) and (OrderStatus = 3200)))
         order by TempID;
    end if;

    if ((v_OrderType = 1) or (v_OrderType = 2)) then
      insert into tmp_newfzxh
        (cqlsbz, yzxh, GroupID, GroupFlag, OrderType, Memo)
        select 1, LongID, GroupID, GroupFlag, OrderType, Memo
          from Long_Order
         where NoOfInpat = v_NoOfInpat
           and ((v_onlynew = 0) or
               ((v_onlynew = 1) and (OrderStatus = 3200)))
         order by LongID;
    end if;

    --select v_lastcqlsbz = 0, v_lastfzxh = 0
    v_cyhzbz := '草药汇总';
    declare
      cursor cr_fzxh is
        select cqlsbz, yzxh, GroupFlag, OrderType, Memo
          from tmp_newfzxh
         order by cqlsbz, yzxh
           for update of GroupID;

      --游标
    begin
      open cr_fzxh;
      fetch cr_fzxh
        into v_cqlsbz, v_yzxh, v_GroupFlag, v_yznrlb, v_Memo;
      while cr_fzxh%found loop
        -- 以下处理分组序号的过程中是按照正常顺序进行处理，未考虑传入的数据分组有错误的情况！！！
        if (v_GroupFlag <= 3501) then
          -- 组开始或单条或未分组,分组序号与医嘱序号一致
          begin
            if ((v_yznrlb = 3110) and (instr(v_Memo, v_cyhzbz) > 0)) then

              update tmp_newfzxh
                 set Memo = v_cyhzbz + to_char(v_GroupID)
               where current of cr_fzxh; -- 草药汇总的Memo中要保存草药明细的分组序号
            end if;
            v_GroupID := v_yzxh; --, v_lastfzxh = v_yzxh
          end;
        end if;

        update tmp_newfzxh
           set GroupID = v_GroupID
         where current of cr_fzxh; --yzxh = v_yzxh and cqlsbz = v_cqlsbz

        fetch cr_fzxh
          into v_cqlsbz, v_yzxh, v_GroupFlag, v_yznrlb, v_Memo;
      end loop;

      close cr_fzxh;

    end;

    update Temp_Order a
       set GroupID =
           (select b.GroupID
              from tmp_newfzxh b
             where a.TempID = b.yzxh
               and b.cqlsbz = 0)
     where exists (select 1
              from tmp_newfzxh b
             where a.TempID = b.yzxh
               and b.cqlsbz = 0);

    update Long_Order a
       set GroupID =
           (select b.GroupID
              from tmp_newfzxh b
             where a.LongID = b.yzxh
               and b.cqlsbz = 1)
     where exists (select 1
              from tmp_newfzxh b
             where a.LongID = b.yzxh
               and b.cqlsbz = 1);

  end;

  /*********************************************************************************/
  PROCEDURE usp_getapplyrecordnew(v_dateBegin VARCHAR, --开始日期
                                  v_dateEnd   VARCHAR, --结束日期
                                  --v_DateInBegin  varchar, --入院开始日期
                                  --v_DateInEnd    varchar, --入院结束日期
                                  v_patientName VARCHAR, --病人姓名
                                  v_DocName     VARCHAR, --申请医师姓名
                                  v_outhosdept  VARCHAR, --出院科室科室
                                  o_result      OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取申请借阅病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例
     exec usp_GetApplyRecord v_DateBegin=N'2001-04-20',v_DateEnd=N'2011-04-27',v_OutHosDept=N'0000'
     exec usp_GetApplyRecord v_DateBegin=N'2011-04-20',v_DateEnd=N'2011-04-28',v_OutHosDept=N'0000'
     修改记录
    **********/
  BEGIN
    --获取申请借阅病历
    OPEN o_result FOR
      SELECT distinct ar.*,
                      u.id           as applydoctorid, --add by cyq 2012-12-06
                      u.NAME         AS applydoctorname,
                      u.py           as applydoctorpy, --add by cyq 2012-12-06
                      u.wb           as applydoctorwb, --add by cyq 2012-12-06
                      cd1.NAME       AS applyaimname,
                      cd2.NAME       AS unitname,
                      inp.noofrecord,
                      inp.incount,
                      inp.NAME,
                      inp.py         as patientNamePY,
                      inp.wb         as patientNameWB,
                      dd.NAME        AS inpsexname,
                      inp.NAME       AS inpname,
                      inp.sexid, --add by cyq 2012-11-16
                      inp.agestr,
                      dept.NAME      AS outhosdeptname,
                      inp.patid,
                      inp.admitdate,
                      inp.outhosdate,
                      d.NAME         AS outdiagnosisname,
                      --s.NAME AS surgeryname,
                      inp.outwarddate,
                      inp.noofinpat, --Add By wwj 2011-09-21
                      cd3.name        as statusname -- add by cyq 2012-11-14
        FROM applyrecord ar
        LEFT JOIN inpatient inp
          ON inp.noofinpat = ar.noofinpat
        LEFT JOIN department dept
          ON dept.ID = inp.outhosdept
        LEFT JOIN users u
          ON u.ID = ar.applydoctor
        LEFT JOIN categorydetail cd1
          ON cd1.categoryid = '50'
         AND cd1.ID = ar.applyaim
        LEFT JOIN categorydetail cd2
          ON cd2.categoryid = '51'
         AND cd2.ID = ar.unit
        LEFT JOIN categorydetail cd3
          on cd3.id = ar.status
         and cd3.categoryid = '52'
        LEFT JOIN dictionary_detail dd
          ON dd.categoryid = '3'
         AND dd.detailid = inp.sexid
        LEFT JOIN diagnosis d
          ON d.icd = inp.outdiagnosis
      --LEFT JOIN medicalrecord mr ON mr.noofinpat = inp.noofinpat
        LEFT JOIN recorddetail rd
          on rd.noofinpat = inp.noofinpat
      --LEFT JOIN diseasecfg dc ON dc.ID = mr.disease
      --LEFT JOIN surgery s ON s.ID = dc.surgeryid
       WHERE ar.applydate >= v_datebegin || ' 00:00:00 '
         AND ar.applydate < v_dateend || ' 24:00:00 '
         AND (inp.outhosdept = v_outhosdept OR v_outhosdept = '0000')
            --edit by cyq 2012-12-04
            --and (inp.Name = v_patientName or v_patientName = '' or v_patientName is null)
         and (inp.Name like '%' || v_patientName || '%' or
             inp.py like '%' || v_patientName || '%' or
             inp.wb like '%' || v_patientName || '%')
         and (u.NAME like '%' || v_DocName || '%' or
             u.py like '%' || v_DocName || '%' or
             u.wb like '%' || v_DocName || '%')
         AND ar.status = '5201'
       ORDER BY outwarddate;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getapplyrecord(v_datebegin  VARCHAR, --开始日期
                               v_dateend    VARCHAR, --结束日期
                               v_outhosdept VARCHAR, --出院科室科室
                               o_result     OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取申请借阅病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例
     exec usp_GetApplyRecord v_DateBegin=N'2001-04-20',v_DateEnd=N'2011-04-27',v_OutHosDept=N'0000'
     exec usp_GetApplyRecord v_DateBegin=N'2011-04-20',v_DateEnd=N'2011-04-28',v_OutHosDept=N'0000'
     修改记录
    **********/
  BEGIN
    --获取申请借阅病历
    OPEN o_result FOR
      SELECT distinct ar.*,
                      u.NAME         AS applydoctorname,
                      cd1.NAME       AS applyaimname,
                      cd2.NAME       AS unitname,
                      inp.noofrecord,
                      inp.incount,
                      inp.NAME,
                      dd.NAME        AS inpsexname,
                      inp.NAME       AS inpname,
                      inp.agestr,
                      dept.NAME      AS outhosdeptname,
                      inp.patid,
                      inp.admitdate,
                      inp.outhosdate,
                      d.NAME         AS outdiagnosisname,
                      --s.NAME AS surgeryname,
                      inp.outwarddate,
                      inp.noofinpat --Add By wwj 2011-09-21
        FROM applyrecord ar
        LEFT JOIN inpatient inp
          ON inp.noofinpat = ar.noofinpat
        LEFT JOIN department dept
          ON dept.ID = inp.outhosdept
        LEFT JOIN users u
          ON u.ID = ar.applydoctor
        LEFT JOIN categorydetail cd1
          ON cd1.categoryid = '50'
         AND cd1.ID = ar.applyaim
        LEFT JOIN categorydetail cd2
          ON cd2.categoryid = '51'
         AND cd2.ID = ar.unit
        LEFT JOIN dictionary_detail dd
          ON dd.categoryid = '3'
         AND dd.detailid = inp.sexid
        LEFT JOIN diagnosis d
          ON d.icd = inp.outdiagnosis
      --LEFT JOIN medicalrecord mr ON mr.noofinpat = inp.noofinpat
        LEFT JOIN recorddetail rd
          on rd.noofinpat = inp.noofinpat
      --LEFT JOIN diseasecfg dc ON dc.ID = mr.disease
      --LEFT JOIN surgery s ON s.ID = dc.surgeryid
       WHERE ar.applydate >= v_datebegin || ' 00:00:00 '
         AND ar.applydate < v_dateend || ' 24:00:00 '
         AND (inp.outhosdept = v_outhosdept OR v_outhosdept = '0000')
         AND ar.status = '5201'
       ORDER BY outwarddate;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getcurrsystemparam(v_gettype INT, --操作类型
                                   o_result  OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间 2011-03-27
     作者   hjh
     版权
     描述  获取系统当前参数
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_gettype = 1 THEN
      --获取当前系统时间
      OPEN o_result FOR
        SELECT TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss') AS currserverdatetime
          FROM DUAL;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getdeptdeductpoint(v_deptcode      VARCHAR DEFAULT '',
                                   v_datetimebegin VARCHAR,
                                   v_datetimeend   VARCHAR,
                                   v_pointid       VARCHAR DEFAULT '',
                                   v_qcstattype    INT,
                                   o_result        OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取科室病历失分点
     功能说明
     输入参数
      v_DeptCode varchar(10)    --科室编号
     ,  v_DateTimeBegin varchar(9)  --开始时间
     ,  v_v_DateTimeEnd  varchar(9)  --结束时间
     ,  v_QCStatType int        --统计资料类型
     输出参数
     结果集、排序
    失分统计信息

     调用的sp
     调用实例
     exec usp_GetInpatientFiling '','', '2007-06-01', '2012-06-30',2
     修改记录
    **********/
  BEGIN
    IF v_qcstattype = 1 THEN
      --科室病历失分统计
      OPEN o_result FOR
        SELECT dept.NAME deptname,
               point.deductpointresult,
               point.deductpointcnt,
               point.ID
          FROM dept_deductpoint point
          LEFT JOIN department dept
            ON TO_CHAR(dept.ID) = TO_CHAR(point.deptcode)
         WHERE TO_CHAR(TO_DATE(point.creattime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd') >= v_datetimebegin
           AND TO_CHAR(TO_DATE(point.creattime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd') <= v_datetimeend
           AND (TO_CHAR(dept.ID) = v_deptcode OR v_deptcode = '' OR
                v_deptcode IS NULL);
    ELSIF v_qcstattype = 2 THEN
      --科室病历失分点明细
      OPEN o_result FOR
        SELECT ROW_NUMBER() OVER(ORDER BY detail.ID ASC) AS rowid_,
               dept.NAME deptname,
               inp.patid,
               dd.NAME sexname,
               inp.NAME inpatientname,
               residentuser.NAME residentname,
               attenduser.NAME attendname,
               chiefuser.NAME chiefname,
               detail.deductpointcnt,
               detail.deductpointresult,
               inp.noofinpat
          FROM dept_deductpointdetail detail
          LEFT JOIN dept_deductpoint point
            ON detail.faid = point.ID
          LEFT JOIN department dept
            ON TO_CHAR(dept.ID) = TO_CHAR(point.deptcode)
          LEFT JOIN inpatient inp
            ON inp.noofinpat = detail.noofinpat
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN users residentuser
            ON residentuser.ID = inp.resident
          LEFT JOIN users attenduser
            ON attenduser.ID = inp.attend
          LEFT JOIN users chiefuser
            ON chiefuser.ID = inp.chief
         WHERE TO_CHAR(TO_DATE(point.creattime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd') >= v_datetimebegin
           AND TO_CHAR(TO_DATE(point.creattime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd') <= v_datetimeend
           AND (TO_CHAR(dept.ID) = v_deptcode OR v_deptcode = '' OR
                v_deptcode IS NULL)
           AND (TO_CHAR(point.ID) = v_pointid OR v_pointid = '' OR
                v_pointid IS NULL);
    ELSIF v_qcstattype = 3 THEN
      --科室病历失分大类
      OPEN o_result FOR
        SELECT point.ID, point.deductpointresult AS NAME, point.creattime
          FROM dept_deductpoint point
         WHERE TO_CHAR(TO_DATE(point.creattime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd') >= v_datetimebegin
           AND TO_CHAR(TO_DATE(point.creattime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd') <= v_datetimeend
           AND (TO_CHAR(point.deptcode) = v_deptcode OR v_deptcode = '' OR
                v_deptcode IS NULL)
           AND (TO_CHAR(point.ID) = v_pointid OR v_pointid = '' OR
                v_pointid IS NULL);
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getdoctortaskinfo(v_wardid  VARCHAR, --病区
                                  v_deptids VARCHAR, --科室
                                  v_userid  VARCHAR, --用户ID
                                  v_time    VARCHAR, --时间
                                  o_result  OUT empcurtyp) AS
  BEGIN
    --待审核(申请科室)， 待会诊（申请科室）
    OPEN o_result FOR
      SELECT ip.NAME AS inpatientname,
             TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                     'yyyy-mm-dd hh24:mi:ss') AS consulttime,
             cd.NAME AS consultstatus,
             cd1.NAME AS urgencytype,
             ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
             ca.stateid,
             ca.noofinpat,
             ca.consulttypeid,
             ca.consultapplysn
        FROM consultapply ca
        LEFT OUTER JOIN users u
          ON u.ID = ca.applyuser
         AND u.valid = '1'
        LEFT OUTER JOIN inpatient ip
          ON ip.noofinpat = ca.noofinpat
        LEFT OUTER JOIN categorydetail cd
          ON cd.categoryid = '67'
         AND ca.stateid = cd.ID
        LEFT OUTER JOIN categorydetail cd1
          ON cd1.categoryid = '66'
         AND cd1.ID = ca.urgencytypeid
       WHERE ca.valid = '1'
         AND ca.valid = '1'
         and substr(ca.consulttime, 1, 10) = substr(v_time, 1, 10)
         AND ip.status IN ('1501', '1502', '1504', '1505', '1506', '1507')
         and ((ip.outhosdept = v_deptids AND ca.stateid IN ('6720', '6730')) or
             ((INSTR(v_deptids, u.deptid) > 0 AND
             ca.stateid IN ('6720', '6730')) --待审核,待会诊
             OR (ca.stateid IN ('6730') --待会诊
             AND EXISTS
              (SELECT *
                      FROM consultapplydepartment cad
                     WHERE cad.consultapplysn = ca.consultapplysn
                       AND INSTR(v_deptids, cad.departmentcode) > 0))));
  END;

  /************************************************************************************/
  PROCEDURE usp_gethospitalinfo(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM hospitalinfo hi;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getieminfo(v_noofinpat INT,
                           o_result    OUT empcurtyp,
                           o_result1   OUT empcurtyp,
                           o_result2   OUT empcurtyp,
                           o_result3   OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量评分
     功能说明
     输入参数
      v_NoOfInpat varchar(40)--首页序号
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_GetIemInfo  9
     修改记录
    **********/
    v_infono NUMERIC;
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    OPEN o_result1 FOR
      SELECT '' FROM DUAL;

    OPEN o_result2 FOR
      SELECT '' FROM DUAL;

    OPEN o_result3 FOR
      SELECT '' FROM DUAL;

    SELECT MAX(imb.iem_mainpage_no)
      INTO v_infono
      FROM iem_mainpage_basicinfo imb
     WHERE imb.noofinpat = v_noofinpat
       AND imb.valide = 1;

    --数据顺序不可变，与程序里相关
    --基本信息
    OPEN o_result FOR
      SELECT *
        FROM iem_mainpage_basicinfo
       WHERE iem_mainpage_no = v_infono
         AND valide = 1;

    --诊断
    OPEN o_result1 FOR
      SELECT *
        FROM iem_mainpage_diagnosis
       WHERE iem_mainpage_no = v_infono
         AND valide = 1
       ORDER BY order_value;

    --手术
    /*    OPEN o_result2 FOR
    SELECT *
      FROM iem_mainpage_operation
     WHERE iem_mainpage_no = v_infono
       AND valide = 1;*/

    OPEN o_result2 FOR

      SELECT iem.iem_mainpage_operation_no,
             iem.iem_mainpage_no,
             iem.operation_code,
             iem.operation_date,
             iem.operation_name,
             u1.name execute_user1_Name,
             iem.execute_user1,
             u2.name execute_user2_Name,
             iem.execute_user2,
             u3.name execute_user3_Name,
             iem.execute_user3,
             dic.name anaesthesia_type_Name,
             iem.anaesthesia_type_id,
             (case
               when iem.close_level = '1' then
                'I/甲'
               when iem.close_level = '2' then
                'II/甲'
               when iem.close_level = '3' then
                'III/甲'
               when iem.close_level = '4' then
                'I/乙'
               when iem.close_level = '5' then
                'II/乙'
               when iem.close_level = '6' then
                'III/乙'
               when iem.close_level = '7' then
                'I/丙'
               when iem.close_level = '8' then
                'II/丙'
               when iem.close_level = '9' then
                'III/丙'
               else
                ''
             end) close_level_Name,
             iem.close_level,
             ua.name anaesthesia_user_Name,
             iem.anaesthesia_user,
             iem.valide,
             iem.create_user,
             iem.create_time,
             iem.cancel_user,
             iem.cancel_time
        FROM iem_mainpage_operation iem
        left join users u1
          on iem.execute_user1 = u1.id
         and u1.valid = 1
        left join users u2
          on iem.execute_user2 = u2.id
         and u2.valid = 1
        left join users u3
          on iem.execute_user3 = u3.id
         and u3.valid = 1
        left join users ua
          on iem.anaesthesia_user = ua.id
         and ua.valid = 1
        left join dictionary_detail dic
          on iem.anaesthesia_type_id = dic.detailid
         and dic.categoryid = '30'
       WHERE valide = 1
         and iem.iem_mainpage_no = v_infono;

    --产妇婴儿信息
    OPEN o_result3 FOR
      SELECT *
        FROM IEM_MAINPAGE_OBSTETRICSBABY
       WHERE iem_mainpage_no = v_infono
         AND valide = 1;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getinpatientfiling(v_deptcode      VARCHAR DEFAULT '',
                                   v_InpatName     VARCHAR DEFAULT '',
                                   v_datetimebegin VARCHAR,
                                   v_datetimeend   VARCHAR,
                                   v_qcstattype    INT,
                                   o_result        OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取科室质量管理未归档病历
     功能说明
     输入参数
      v_DeptCode varchar(10)    --科室编号
       v_NoOfInpat varchar(10) = '', --病人首页序号
      v_DateTimeBegin varchar(9) --开始时间
     ,  v_v_DateTimeEnd  varchar(9) --结束时间
     ,  v_QCStatType int --统计资料类型
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_GetInpatientFiling '','', '2011-02-24', '2011-03-24',1
     修改记录
    **********/
  BEGIN
    IF v_qcstattype = 1 THEN
      --出院未归档病历
      OPEN o_result FOR
        SELECT --ROW_NUMBER() OVER(ORDER BY inp.noofinpat) AS rowid_,
        DISTINCT inp.outhosdept,
                 de.NAME        deptname,
                 inp.noofinpat  AS noofinpat,
                 inp.patnoofhis AS patnoofhis,
                 inp.patid      AS patid,
                 inp.NAME       AS NAME,
                 inp.sexid      AS sexid,
                 dd.NAME        AS sexname,
                 inp.agestr     AS agestr,
                 --TO_CHAR(inp.admitdate, 'yyyy-mm-dd') AS admitdate,
                 --TO_CHAR(inp.outhosdate, 'yyyy-mm-dd') AS outhosdate,

                 --edit by cyq 2013-03-14
                 --to_date(inp.admitdate, 'yyyy-MM-dd hh24:mi:ss') AS admitdate,
                -- to_date(inp.outhosdate, 'yyyy-MM-dd hh24:mi:ss') AS outhosdate,

                substr(inp.admitdate,1,16) AS admitdate,
                substr(inp.outhosdate,1,16) AS outhosdate,

                 --trunc(to_date(inp.admitdate, 'yyyy-MM-dd hh24:mi:ss')) AS admitdate,
                 --trunc(to_date(inp.outhosdate, 'yyyy-MM-dd hh24:mi:ss')) AS outhosdate,

                 --add by cyq 2013-03-14
                 --to_date(inp.inwarddate, 'yyyy-MM-dd hh24:mi:ss') AS inwarddate,
                -- to_date(inp.outwarddate, 'yyyy-MM-dd hh24:mi:ss') AS outwarddate,

                 substr(inp.inwarddate,1,16) AS inwarddate,
                  substr(inp.outwarddate,1,16) AS outwarddate,
                 1                 inhoscnt, ---住院次数
                 residentuser.NAME residentname,
                 attenduser.NAME   attendname,
                 chiefuser.NAME    chiefname,
                 inp.admitdiagnosis         admitdiag,
                 /*                 datediff('dd',
                          inp.admitdate,
                          NVL(trim(inp.outwarddate),
                              TO_CHAR(SYSDATE, 'yyyy-mm-dd'))) inhosdays,
                 NVL(datediff('dd',
                              trim(inp.outwarddate),
                              TO_CHAR(SYSDATE, 'yyyy-mm-dd')),
                     0) outhosdays,*/

                 isday(datediff('dd',
                                inp.admitdate,
                                 NVL(trim(inp.outhosdate),
                                --NVL(trim(inp.outwarddate),
                                    TO_CHAR(SYSDATE, 'yyyy-mm-dd')))) inhosdays, --2013-6-24 zjy
                 isday(datediff('dd',
                               -- trim(inp.outwarddate), eidt by ywk
                                  trim(inp.outhosdate),
                                TO_CHAR(SYSDATE, 'yyyy-mm-dd'))) outhosdays, --2013-6-24 zjy

                 inp.noofinpat NoOfInpat
          FROM inpatient inp
        --JOIN medicalrecord med ON inp.noofinpat = med.noofinpat
          LEFT JOIN recorddetail rd
            on rd.noofinpat = inp.noofinpat
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN users residentuser
            ON residentuser.ID = inp.resident
          LEFT JOIN users attenduser
            ON attenduser.ID = inp.attend
          LEFT JOIN users chiefuser
            ON chiefuser.ID = inp.chief
          LEFT JOIN department de
            ON de.ID = inp.outhosdept
          LEFT JOIN diagnosis diag
            ON diag.markid = inp.admitdiagnosis
         WHERE /*inp.status = 1503*/ --edit by ywk  2012年3月7日17:03:55
         inp.status in ('1502', '1503')
        --AND med.lockinfo IN (4700, 4702, 4703)
         AND (inp.islock IN (4700, 4702, 4703) or inp.islock is null)
        --AND TO_CHAR(inp.admitdate, 'yyyy-mm-dd') >= v_datetimebegin
        --AND TO_CHAR(inp.admitdate, 'yyyy-mm-dd') <= v_datetimeend

         AND trunc(to_date(inp.admitdate, 'yyyy-mm-dd hh24:mi:ss')) >=
         to_date(v_datetimebegin || ' 00:00:00', 'yyyy-mm-dd hh24:mi:ss')
         AND trunc(to_date(inp.admitdate, 'yyyy-mm-dd hh24:mi:ss')) <=
         to_date(v_datetimeend || ' 23:59:59', 'yyyy-mm-dd hh24:mi:ss')

         AND (TO_CHAR(outhosdept) = v_deptcode OR v_deptcode = '' OR
         v_deptcode IS NULL)
         AND (inp.patid = v_InpatName or v_InpatName = '' or
         v_InpatName is null)

         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 2 THEN
      --归档病历
      OPEN o_result FOR
        SELECT --ROW_NUMBER() OVER(ORDER BY inp.noofinpat) AS rowid_,
        distinct inp.outhosdept,
                 de.NAME        deptname,
                 inp.noofinpat  AS noofinpat,
                 inp.patnoofhis AS patnoofhis,
                 inp.patid      AS patid,
                 inp.NAME       AS NAME,
                 inp.sexid      AS sexid,
                 dd.NAME        AS sexname,
                 inp.agestr     AS agestr,
                 --TO_CHAR(inp.admitdate, 'yyyy-mm-dd') AS admitdate,
                 --TO_CHAR(inp.outhosdate, 'yyyy-mm-dd') AS outhosdate,

                 --edit by cyq 2013-03-14
                 to_date(inp.admitdate, 'yyyy-MM-dd hh24:mi:ss') AS admitdate,
                 to_date(inp.outhosdate, 'yyyy-MM-dd hh24:mi:ss') AS outhosdate,
                 --trunc(to_date(inp.admitdate, 'yyyy-MM-dd hh24:mi:ss')) AS admitdate,
                 --trunc(to_date(inp.outhosdate, 'yyyy-MM-dd hh24:mi:ss')) AS outhosdate,

                 --add by cyq 2013-03-14
                 to_date(inp.inwarddate, 'yyyy-MM-dd hh24:mi:ss') AS inwarddate,
                 to_date(inp.outwarddate, 'yyyy-MM-dd hh24:mi:ss') AS outwarddate,

                 1 inhoscnt, ---住院次数
                 residentuser.NAME residentname,
                 attenduser.NAME attendname,
                 chiefuser.NAME chiefname,
                 inp.admitdiagnosis admitdiag,
                 datediff('dd',
                          inp.admitdate,
                          NVL(trim(inp.outwarddate),
                              TO_CHAR(SYSDATE, 'yyyy-mm-dd'))) inhosdays,
                 NVL(datediff('dd',
                              inp.outwarddate,
                              TO_CHAR(SYSDATE, 'yyyy-mm-dd')),
                     0) outhosdays,
                 inp.noofinpat NoOfInpat
          FROM inpatient inp
        --JOIN medicalrecord med ON inp.noofinpat = med.noofinpat
          LEFT JOIN recorddetail rd
            on rd.noofinpat = inp.noofinpat
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN users residentuser
            ON residentuser.ID = inp.resident
          LEFT JOIN users attenduser
            ON attenduser.ID = inp.attend
          LEFT JOIN users chiefuser
            ON chiefuser.ID = inp.chief
          LEFT JOIN department de
            ON de.ID = inp.outhosdept
          LEFT JOIN diagnosis diag
            ON diag.mapid = inp.admitdiagnosis
         WHERE inp.status = 1503
              --AND med.lockinfo = 4701
           AND rd.islock = '4701'
              --AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
              --AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend

           AND trunc(to_date(inp.admitdate, 'yyyy-mm-dd hh24:mi:ss')) >=
               to_date(v_datetimebegin || ' 00:00:00',
                       'yyyy-mm-dd hh24:mi:ss')
           AND trunc(to_date(inp.admitdate, 'yyyy-mm-dd hh24:mi:ss')) <=
               to_date(v_datetimeend || ' 23:59:59',
                       'yyyy-mm-dd hh24:mi:ss')

           AND (TO_CHAR(outhosdept) = v_deptcode OR v_deptcode = '' OR
               v_deptcode IS NULL)
           AND (TO_CHAR(inp.noofinpat) = v_InpatName OR v_InpatName = '' OR
               v_InpatName IS NULL)
         ORDER BY inp.noofinpat;

     ELSIF v_qcstattype =3 THEN
      --归档病历
      OPEN o_result FOR
        SELECT --ROW_NUMBER() OVER(ORDER BY inp.noofinpat) AS rowid_,
        distinct inp.outhosdept,
                 de.NAME        deptname,
                 inp.noofinpat  AS noofinpat,
                 inp.patnoofhis AS patnoofhis,
                 inp.patid      AS patid,
                 inp.NAME       AS NAME,
                 inp.sexid      AS sexid,
                 dd.NAME        AS sexname,
                 inp.agestr     AS agestr,
                 --TO_CHAR(inp.admitdate, 'yyyy-mm-dd') AS admitdate,
                 --TO_CHAR(inp.outhosdate, 'yyyy-mm-dd') AS outhosdate,

                 --edit by cyq 2013-03-14
                 to_date(inp.admitdate, 'yyyy-MM-dd hh24:mi:ss') AS admitdate,
                 to_date(inp.outhosdate, 'yyyy-MM-dd hh24:mi:ss') AS outhosdate,
                 --trunc(to_date(inp.admitdate, 'yyyy-MM-dd hh24:mi:ss')) AS admitdate,
                 --trunc(to_date(inp.outhosdate, 'yyyy-MM-dd hh24:mi:ss')) AS outhosdate,

                 --add by cyq 2013-03-14
                 to_date(inp.inwarddate, 'yyyy-MM-dd hh24:mi:ss') AS inwarddate,
                 to_date(inp.outwarddate, 'yyyy-MM-dd hh24:mi:ss') AS outwarddate,

                 1 inhoscnt, ---住院次数
                 residentuser.NAME residentname,
                 attenduser.NAME attendname,
                 chiefuser.NAME chiefname,
                 inp.admitdiagnosis admitdiag,
                 datediff('dd',
                          inp.admitdate,
                          NVL(trim(inp.outwarddate),
                              TO_CHAR(SYSDATE, 'yyyy-mm-dd'))) inhosdays,
                 NVL(datediff('dd',
                              inp.outwarddate,
                              TO_CHAR(SYSDATE, 'yyyy-mm-dd')),
                     0) outhosdays,
                 inp.noofinpat NoOfInpat
          FROM inpatient inp
        --JOIN medicalrecord med ON inp.noofinpat = med.noofinpat
          LEFT JOIN recorddetail rd
            on rd.noofinpat = inp.noofinpat
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN users residentuser
            ON residentuser.ID = inp.resident
          LEFT JOIN users attenduser
            ON attenduser.ID = inp.attend
          LEFT JOIN users chiefuser
            ON chiefuser.ID = inp.chief
          LEFT JOIN department de
            ON de.ID = inp.outhosdept
          LEFT JOIN diagnosis diag
            ON diag.mapid = inp.admitdiagnosis
         WHERE
              --AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
              --AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend

            trunc(to_date(inp.admitdate, 'yyyy-mm-dd hh24:mi:ss')) >=
               to_date(v_datetimebegin || ' 00:00:00',
                       'yyyy-mm-dd hh24:mi:ss')
           AND trunc(to_date(inp.admitdate, 'yyyy-mm-dd hh24:mi:ss')) <=
               to_date(v_datetimeend || ' 23:59:59',
                       'yyyy-mm-dd hh24:mi:ss')

           AND (TO_CHAR(inp.patid) = v_InpatName OR v_InpatName = '' OR
               v_InpatName IS NULL)
               and TO_CHAR(inp.noofinpat) in ( select distinct  noofinpat from inpatientchangeinfo where olddeptid=v_deptcode )
         ORDER BY inp.noofinpat;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getinpatientreport(v_noofinpat     VARCHAR DEFAULT '',
                                   v_datetimebegin VARCHAR DEFAULT '',
                                   v_datetimeend   VARCHAR DEFAULT '',
                                   v_submitdocid   VARCHAR DEFAULT '',
                                   v_reportid      VARCHAR DEFAULT '',
                                   v_qcstattype    VARCHAR DEFAULT '',
                                   o_result        OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  根据传入的时间段以及病人首页序号  查询病人医技报告信息
     功能说明
     输入参数
     v_NoOfInpat  varchar(10) = '', --病人首页序号
     v_DateTimeBegin  varchar(10) = '', --开始时间
     v_DateTimeEnd  varchar(10) = '', --结束时间
     v_SubmitDocID  varchar(10) = '', --送检医生
     v_ReportID   varchar(12) = '', --主表唯一标示列（查询子表信息时候使用）
     v_QCStatType  varchar(3)  = '' --类型   默认查询主表信息   LIS：查询检查类信息  RIS：查询检验类信息
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
    usp_GetInpatientReport '62','','','','',''

     修改记录
    **********/
  BEGIN
    -----查询主表信息
    IF v_qcstattype IS NULL THEN
      OPEN o_result FOR
        SELECT report.hospitalno,
               report.noofinpat,
               inp.NAME,
               report.reportcatalog,
               report.reporttype,
               reportno,
               reportname,
               users.NAME           AS submitdocname,
               report.submitdate,
               report.releasedate,
               report.hadread,
               report.ID            reportid
          FROM inpatientreport report
          LEFT JOIN inpatient inp
            ON report.noofinpat = inp.noofinpat
          LEFT JOIN users users
            ON TO_CHAR(report.submitdocid) = TO_CHAR(users.ID)
         WHERE (TO_CHAR(inp.noofinpat) = v_noofinpat OR v_noofinpat = '' OR
               v_noofinpat IS NULL)
           AND TO_CHAR(TO_DATE(SUBSTR(report.submitdate, 1, 10),
                               'yyyy-mm-dd'),
                       'yyyy-mm-dd') >= v_datetimebegin
           AND TO_CHAR(TO_DATE(SUBSTR(report.submitdate, 1, 10),
                               'yyyy-mm-dd'),
                       'yyyy-mm-dd') <= v_datetimeend
           AND (TO_CHAR(report.submitdocid) = v_submitdocid OR
               v_submitdocid = '' OR v_submitdocid IS NULL);
      -----查询RIS信息
    ELSIF v_qcstattype = 'RIS' THEN
      OPEN o_result FOR
        SELECT (SELECT NAME FROM hospitalinfo WHERE ROWNUM <= 1) hospname,
               '【' || inp.NAME || '】' || '检查报告' reporttitle,
               report.reportno applyno,
               report.ID techno,
               '检查报告' technoname,
               '' wardorregdesc,
               inp.NAME patname,
               de.NAME sex,
               inp.agestr age,
               inp.noofrecord hospno,
               dept.NAME applydeptname,
               inp.outbed bedno,
               inp.outhosward ward,
              inp.admitdiagnosis lczd,
               '' applydoctor,
               TO_CHAR(TO_DATE(SUBSTR(report.submitdate, 1, 10),
                               'yyyy-mm-dd'),
                       'yyyy-mm-dd') exectime,
               '' execdoctor,
               '' instrument,
               risreslut.line,
               risreslut.itemname,
               risreslut.RESULT
          FROM inpatientreportrisreslut risreslut
          LEFT JOIN inpatientreport report
            ON risreslut.reportid = report.ID
          LEFT JOIN inpatient inp
            ON inp.noofinpat = report.noofinpat
          LEFT JOIN dictionary_detail de
            ON de.categoryid = '3'
           AND de.detailid = inp.sexid
          LEFT JOIN department dept
            ON dept.ID = inp.outhosdept
          LEFT JOIN diagnosis diag
            ON diag.icd = inp.admitdiagnosis
          LEFT JOIN users users
            ON TO_CHAR(users.ID) = TO_CHAR(report.submitdocid)
         WHERE TO_CHAR(risreslut.reportid) = v_reportid;
      -----查询LIS信息
    ELSIF v_qcstattype = 'LIS' THEN
      OPEN o_result FOR
        SELECT (SELECT NAME FROM hospitalinfo WHERE ROWNUM <= 1) reporttitle,
               report.reportno applyno,
               report.ID technodesc,
               inp.NAME patname,
               de.NAME sexdesc,
               inp.agestr agedesc,
               inp.noofrecord hospno,
               dept.NAME applydeptname,
               inp.outbed bedno,
               '' sampledesc,
               TO_CHAR(TO_DATE(SUBSTR(report.submitdate, 1, 10),
                               'yyyy-mm-dd'),
                       'yyyy-mm-dd') receivetime,
               '' sampletime,
              inp.admitdiagnosis clinicdesc,
               '' sampledescdesc,
               '' patpropnodesc,
               inp.outhosward warddesc,
               users.NAME todocname,
               '' execdocname,
               '' exectime,
               '' reporttime,
               '' verifiername,
               TO_CHAR(TO_DATE(SUBSTR(report.releasedate, 1, 10),
                               'yyyy-mm-dd'),
                       'yyyy-mm-dd') pubtime,
               '' comment_,
               report.reportname,
               lisreslut.line,
               lisreslut.itemname,
               lisreslut.RESULT,
               lisreslut.refervalue refer,
               lisreslut.unit,
               lisreslut.resultcolor
          FROM inpatientreportlisreslut lisreslut
          LEFT JOIN inpatientreport report
            ON lisreslut.reportid = report.ID
          LEFT JOIN inpatient inp
            ON inp.noofinpat = report.noofinpat
          LEFT JOIN dictionary_detail de
            ON de.categoryid = '3'
           AND de.detailid = inp.sexid
          LEFT JOIN department dept
            ON dept.ID = inp.outhosdept
          LEFT JOIN diagnosis diag
            ON diag.icd = inp.admitdiagnosis
          LEFT JOIN users users
            ON TO_CHAR(users.ID) = TO_CHAR(report.submitdocid)
         WHERE TO_CHAR(lisreslut.reportid) = v_reportid
         ORDER BY lisreslut.line;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getjobpermissioninfo(v_jobid  VARCHAR,
                                     o_result OUT empcurtyp) AS
    /**********
     版本号
     创建时间
     作者
     版权
     描述
     功能说明      输出所有岗位信息
     输出参数
     结果集、排序
     调用的sp
     调用实例
    **********/
  BEGIN
    OPEN o_result FOR
      SELECT * FROM job2permission WHERE ID = v_jobid;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getknowledgepublicinfo(v_ordertype NUMERIC, --所属类别
                                       o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  编辑家族信息
     功能说明
     输入参数
     输出参数
     结果集、排序

     exec usp_GetKnowledgePublicInfo v_OrderType=

     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    OPEN o_result FOR
      SELECT node, title, parentnode, CONTEXT, ordervalue, ordertype
        FROM knowledgepublic
       WHERE ordertype = v_ordertype
         AND valid = 1
       ORDER BY node, ordervalue;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getlookupeditordata(v_querytype NUMERIC, --查询的类型
                                    v_queryid   NUMERIC DEFAULT 0,
                                    o_result    OUT empcurtyp) AS /**********
                                                            版本号  1.0.0.0.0
                                                            创建时间
                                                            作者
                                                            版权
                                                            描述  获取需要在lookupeditor里显示的数据,最好包括ID，Name,Py,Memo，这样可以在APP里调用时用统一的方法
                                                            功能说明
                                                            输入参数
                                                            输出参数
                                                            结果集、排序

                                                            调用的sp
                                                            调用实例

                                                            修改记录
                                                            **********/
  BEGIN
    IF v_querytype = 1 THEN
      --病人性质(即 医疗付款方式)
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '1'
           AND valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 2 THEN
      --病人性别
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '3'
           AND valid = 1
         ORDER BY DETAILID;
    ELSIF v_querytype = 3 THEN
      --婚姻状况
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '4'
           AND valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 4 THEN
      --职业代码
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '41'
           AND valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 5 THEN
      --省市代码
      OPEN o_result FOR
        SELECT ID, NAME, py, memo
          FROM areas
         WHERE CATEGORY = 1000
         ORDER BY ID;
    ELSIF v_querytype = 6 THEN
      --民族代码
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '42'
           AND valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 7 THEN
      --国籍代码
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '43'
           AND valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 8 THEN
      --联系关系
      OPEN o_result FOR
        SELECT detailid AS ID, NAME, py, memo
          FROM dictionary_detail
         WHERE categoryid = '44'
           AND valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 9 THEN
      --临床科室
      OPEN o_result FOR
        SELECT ID, NAME, py, memo
          FROM department dept
         WHERE valid = 1
           AND EXISTS
         (SELECT 1 FROM dept2ward WHERE deptid = dept.ID)
         ORDER BY ID;
    ELSIF v_querytype = 10 THEN
      --临床病区
      OPEN o_result FOR
      --SELECT ID, NAME, py, memo FROM ward WHERE valid = 1 ORDER BY ID;
        select a.ID, a.NAME, a.py, a.wb, b.deptid
          from ward a, dept2ward b
         where a.id = b.wardid
           and a.valid = '1'
         order by ID;
    ELSIF v_querytype = 11 THEN
      --操作人员，所有
      OPEN o_result FOR
        SELECT ID, NAME, py, memo FROM users WHERE valid = 1 ORDER BY ID;
     elsif v_QueryType = 111 then
    --操作人员，护理  402

      OPEN o_result FOR
    select ID, NAME, Py, Memo from Users where  Valid = 1 and category = '402'  order by ID;
  elsif v_QueryType = 112 then
    --操作人员，护理  401 400 403

      OPEN o_result FOR
    select ID, NAME, Py, Memo from Users where  Valid = 1 and (category = '400' or category = '401' or category = '403' )  order by ID;


    ELSIF v_querytype = 12 THEN
      --诊断，所有
      OPEN o_result FOR
      /*SELECT icd AS ID, NAME, py, WB, memo, icd
                      FROM diagnosis
                     WHERE valid = 1
                     ORDER BY ID;*/
        SELECT icd AS ID, NAME, py, WB, memo, icd
          FROM diagnosis
         WHERE valid = 1
        union
        select diagnosis.icd as ID,
               diagnosisothername.name as Name,
               diagnosisothername.py,
               diagnosisothername.wb,
               '' as memo,
               diagnosis.icd as ICD
          from diagnosisothername
          left join diagnosis
            on diagnosis.icd = diagnosisothername.icdid
         where diagnosisothername.valid = '1'
         ORDER BY ID;
    ELSIF v_querytype = 13 THEN
      --区县代码
      OPEN o_result FOR
        SELECT ID, NAME, py, memo, parentid, parentname
          FROM areas
         WHERE CATEGORY = 1001
         ORDER BY ID;
    ELSIF v_querytype = 14 THEN
      --麻醉方式,需要修改
      OPEN o_result FOR
      /*  SELECT detailid AS ID, NAME, py, memo
                                        FROM dictionary_detail
                                       WHERE categoryid = '30'
                                         AND valid = 1
                                       ORDER BY ID;*/
      --edit by ywk 2012年4月18日10:12:07
        select ID, NAME, py, wb
          from anesthesia
         where valid = 1
         order by ID desc;

    ELSIF v_querytype = 15 THEN
      --切口愈合等级,需要修改
      OPEN o_result FOR
        SELECT 1 AS ID, 'I/甲' NAME, 'yj' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 2 AS ID, 'II/甲' NAME, 'ej' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 3 AS ID, 'III/甲' NAME, 'sj' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 4 AS ID, 'I/乙' NAME, 'yy' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 5 AS ID, 'II/乙' NAME, 'ey' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 6 AS ID, 'III/乙' NAME, 'sy' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 7 AS ID, 'I/丙' NAME, 'yb' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 8 AS ID, 'II/丙' NAME, 'eb' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 9 AS ID, 'III/丙' NAME, 'sb' py, NULL memo
          FROM DUAL
         ORDER BY ID;
    ELSIF v_querytype = 16 THEN
      --
      OPEN o_result FOR
        SELECT ID, NAME, py, memo
          FROM categorydetail
         WHERE categoryid = v_queryid
         ORDER BY ID;
      --损伤中毒库
    elsif v_querytype = 17 then

      OPEN o_result FOR
        select a.id, a.name, a.py, a.memo from Toxicosis a order by id;

    elsif v_querytype = 18 then
      open o_result for
        SELECT 1 AS ID, '一级手术' NAME, 'yjss' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 2 AS ID, '二级手术' NAME, 'ejss' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 3 AS ID, '三级手术' NAME, 'sjss' py, NULL memo
          FROM DUAL
        UNION ALL
        SELECT 4 AS ID, '四级手术' NAME, 'sjss' py, NULL memo FROM DUAL;

    ELSIF v_querytype = 19 THEN
      --诊断，所有 中医
      OPEN o_result FOR
        select ID, NAME, py, memo
          from diagnosisofchinese
         WHERE valid = 1
        union
        select diagnosisofchinese.id as ID,
               diagnosischiothername.name as Name,
               diagnosischiothername.py as PY,
               '' as memo
          from diagnosischiothername
          left join diagnosisofchinese
            on diagnosisofchinese.id = diagnosischiothername.icdid where diagnosisofchinese.valid=1
         ORDER BY ID;
      --新增取字典表的是否 add by ywk
    ELSIF v_querytype = 55 THEN

      OPEN o_result FOR
        select detailid as ID, NAME, py, memo
          from dictionary_detail
         WHERE valid = 1
           and categoryid = '69' --去掉未知选项 add by ywk 2012年7月20日 09:08:53
         ORDER BY ID;

    ELSIF v_querytype = 20 THEN
      --手术，所有
      OPEN o_result FOR
       /* select ID, NAME, py, memo
          from operation
         WHERE valid = 1
         ORDER BY ID;*/
           select ID, NAME, py, memo
          from operation
         WHERE valid = 1
         union
           select operation.id as ID,operothername.name as Name,operothername.py as PY,'' as memo
          from operothername left join operation on operation.id=operothername.icdid where operation.valid=1  ORDER BY ID;
      --add by wyt 2012-08-27
    ELSIF v_querytype = 30 THEN
      --病人来源
      OPEN o_result FOR
        select detailid ID, NAME, py, memo
          from dictionary_detail
         WHERE categoryid = '2'
           and valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 31 THEN
      --科室与病区对应
      OPEN o_result FOR
        select dept2ward.deptid,
               dept2ward.wardid,
               department.name  deptname,
               ward.name        wardname
          from dept2ward, department, ward
         WHERE department.id = deptid
           and ward.id = wardid
         ORDER BY deptid;
    ELSIF v_querytype = 32 THEN
      --科室
      OPEN o_result FOR
        SELECT ID,
               NAME,
               py,
               wb,
               (CASE sort
                 WHEN 101 THEN
                  '临床'
                 WHEN 102 THEN
                  '医技'
                 WHEN 103 THEN
                  '药剂'
                 WHEN 104 THEN
                  '机关'
                 WHEN 105 THEN
                  '其他'
                 ELSE
                  ''
               END) as sort
          FROM department dept
        /*          if sort = '101' then sort = '临床';
        elsif  sort = '102' then sort = '医技';
        elsif  sort = '103' then sort = '药剂';
        elsif  sort = '104' then sort = '机关';
        elsif  sort = '105' then sort = '其他';
        end if;*/
         where valid = 1
         ORDER BY ID;
    ELSIF v_querytype = 33 THEN
      --病区
      OPEN o_result FOR
        select a.ID, a.NAME, a.py, a.wb
          from ward a
         where a.valid = 1
         order by ID;
    END IF;
  END;

  /*  \*********************add by wyt 2012-08-16************************************************************\
  PROCEDURE usp_getmedicalrrecordviewnew(v_deptcode      VARCHAR DEFAULT '',
                                      v_datetimebegin VARCHAR,
                                      v_datetimeend   VARCHAR,
                                      v_datetimeinbegin VARCHAR,
                                      v_datetimeinend   VARCHAR,
                                      v_patientname   VARCHAR DEFAULT '',
                                      v_recordid      VARCHAR DEFAULT '',
                                      v_applydoctor   VARCHAR DEFAULT '',
                                      v_qcstattype    INT,
                                      v_patid  VARCHAR DEFAULT '',
                                      v_indiag    VARCHAR DEFAULT '', --入院诊断
                                      v_outdiag    VARCHAR DEFAULT '', --出院诊断
                                      v_curdiag    VARCHAR DEFAULT '', --当前诊断
                                      o_result OUT empcurtyp) AS
    \**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  按科室或科室对应病人的归档或未归档电子病历
     功能说明
     输入参数
      v_DeptCode varchar(10)=''    --科室编号
      v_DateTimeBegin varchar(9)       --开始时间
       v_v_DateTimeEnd  varchar(9)       --结束时间
       v_PatientName  varchar(20)='',   --病人姓名
        v_RecordID  varchar(20)='',      --病历
       v_QCStatType int,                 --统计资料类型，1：已归档、2：申请借阅
       v_ApplyDoctor     varchar(6) ,        --申请医师代码

       --Add wwj 用于模糊查询
       v_PatID           varchar(32),       --病历号
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_GetMedicalRrecordView '', '2011-01-01', '2011-05-26','','','',1, ''
      exec usp_GetMedicalRrecordView '10', '', '','','','',3
      exec usp_GetMedicalRrecordView v_DeptCode='',v_DateTimeBegin='2001-03-01'
      ,v_DateTimeEnd='2011-03-10',v_QCStatType='1',v_PatientName='',v_RecordID='',v_ApplyDoctor=''
      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-03-01',v_DateTimeEnd='2011-03-25'
      ,v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-03-01'
      ,v_DateTimeEnd='2011-04-27',v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-04-01'
      ,v_DateTimeEnd='2011-04-27',v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

     修改记录
    **********\
    v_sql       VARCHAR(4000);
    v_where     VARCHAR(100) DEFAULT '';
    v_leftwhere VARCHAR(100) DEFAULT '';
    v_deptwhere VARCHAR(100) DEFAULT '';
  BEGIN
    IF  v_deptcode IS NOT NULL THEN
      v_where := 'and inp.OutHosDept=''' || v_deptcode || '''';
    END IF;

    IF v_patid IS NOT NULL THEN
      v_where := v_where || ' and inp.PatID like ' || '''%' || v_patid ||
                 '%''';
    END IF;

    IF v_patientname IS NOT NULL THEN
      v_where := v_where || ' and inp.Name like ' || '''%' || v_patientname ||
                 '%''';
    END IF;

    IF v_recordid IS NOT NULL THEN
      v_where := v_where || ' and inp.NoOfRecord=''' || v_recordid || '''';
    END IF;

    IF v_applydoctor IS NOT NULL THEN
      v_where := v_where || ' and ar.ApplyDoctor=''' || v_applydoctor || '''';
      --set v_LeftWhere=' and ar.ApplyDoctor='''+v_ApplyDoctor+''''
    END IF;
    IF v_qcstattype = 1 THEN
      --患者已归档病历阅览
     OPEN o_result FOR
     SELECT DISTINCT ar.ApplyDate, --ROW_NUMBER() OVER (ORDER BY inp.NoOfInpat ASC) AS RowID_,
     inp.NoOfInpat AS NoOfInpat,
     inp.PatNoOfHis AS PatNoOfHis,
     inp.Name AS Name,
     dd.Name AS SexName,
     inp.InCount as InCount,
     inp.AgeStr AS AgeStr,
    inp.AdmitDate as AdmitDate,
    bed.WardId AS WardId,
    bed.DeptID AS DeptID,
    bed.ID  AS BedID,
    datediff('dd',inp.AdmitDate,nvl(trim(inp.OutWardDate),to_char(sysdate,'yyyy-mm-dd')))+1 inhosdays,
    inp.OutWardDate,
    CASE WHEN (SELECT COUNT (noofinpat) FROM recorddetail WHERE recorddetail.noofinpat = inp.noofinpat) > 0 THEN '已经治' ELSE '未经治' END AS statusname
    ,inp.Resident,us3.Name as ResidentName
    ,inp.Attend,us1.Name as AttendName ,inp.Chief ,us2.Name as ChiefName,inp.Status
    ,inp.PatID RecordID --mr.ID as RecordID
    ,inp.NoOfRecord,inp.OutBed,inp.OutHosDept,de1.Name as DeptName,rd.islock
    ,ar. Status  as ApplyStatusID,cd1.Name as ApplyStatus
    FROM InPatient inp
    LEFT JOIN recorddetail rd ON inp.noofinpat = rd.noofinpat
    left join Dictionary_detail dd  ON dd.CategoryID = '3' AND inp.SexID = dd.DetailID
    left join Bed bed  ON inp.NoOfInpat = bed.NoOfInpat
    left join Ward ward  on bed.WardId = ward.ID
    left join Department de  on bed.DeptID = de.ID
    left join Users us1 on us1.ID=inp.Attend
    left join Users us2 on us2.ID=inp.Chief
    left join Users us3 on us3.ID=inp.Resident
    left join Department de1  on inp.OutHosDept = de1.ID
    --left join MedicalRecord mr on mr.NoOfInpat = inp.NoOfInpat
    --left join ApplyRecord ar on ar.NoOfInpat=inp.NoOfInpat
    left join CurrentDiag cur on cur.patient_id = inp.noofinpat

    --串病历借阅记录表，得到病历借阅的状态
    left join ApplyRecord ar on ar.NoOfInpat=inp.NoOfInpat
    left join CategoryDetail cd1 on cd1.CategoryID = '52' and cd1.ID = ar. Status

    WHERE inp.Status IN  ('1502','1503')

    and rd.islock = '4701'

    and (inp.patid = v_patid or v_patid='' or v_patid is null)

    and (inp.admitdiagnosis = v_indiag or v_indiag='' or v_indiag is null)

    and (inp.outdiagnosis = v_outdiag or v_outdiag='' or v_outdiag is null)

    and (cur.diag_code = v_curdiag or v_curdiag='' or v_curdiag is null)

    and to_date(substr(nvl(trim(inp.OutWardDate),'1990-01-01'),1,10) , 'yyyy-mm-dd') >=  to_date(
               v_datetimebegin, 'yyyy-mm-dd')
    and to_date(substr(nvl(trim(inp.OutWardDate),'1990-01-01'),1,10) , 'yyyy-mm-dd') <=  to_date(
               v_datetimeend, 'yyyy-mm-dd')
    and to_date(substr(nvl(trim(inp.inwarddate),'1990-01-01'),1,10) , 'yyyy-mm-dd') >=  to_date(
               v_datetimeinbegin, 'yyyy-mm-dd')
    and to_date(substr(nvl(trim(inp.inwarddate),'1990-01-01'),1,10) , 'yyyy-mm-dd') <=  to_date(
               v_datetimeinend, 'yyyy-mm-dd')
     || v_where

     --' || v_where || '
     order by inp.NoOfInpat;

    ELSIF v_qcstattype = 2 THEN
      --申请借阅患者病历,已经归档的病历
    OPEN o_result FOR
    SELECT DISTINCT --ROW_NUMBER() OVER (ORDER BY inp.NoOfInpat ASC) AS RowID_,
    inp.NoOfInpat AS NoOfInpat,
    inp.PatNoOfHis AS PatNoOfHis,
    inp.PatID AS PatID,
    de.Name as DeptName,
    inp.Name AS Name,
    dd.Name AS SexName,
    inp.InCount as InCount,
    inp.AgeStr AS AgeStr,
    inp.AdmitDate as AdmitDate,
    inp.OutWardDate,
    inp.OutHosDept AS DeptID,
    ds.Name as DiagnosisName,
    inp.PatID RecordID, --mr.ID as RecordID
    inp.NoOfRecord
    FROM InPatient inp
    LEFT JOIN recorddetail rd ON inp.noofinpat = rd.noofinpat
    left join Dictionary_detail dd  ON dd.CategoryID = '3' AND inp.SexID = dd.DetailID
    left join Bed bed  ON inp.NoOfInpat = bed.NoOfInpat
    left join Ward ward  on bed.WardId = ward.ID
    left join Department de  on inp.OutHosDept = de.ID
    left join Diagnosis  ds on inp.OutDiagnosis=ds.MarkId
    left join MedicalRecord mr on mr.NoOfInpat = inp.NoOfInpat
    WHERE inp.Status IN  ('1502','1503')
               AND rd.islock ='4701'  order by inp.NoOfInpat;
               --|| v_where;
    END IF;
  END;
  */

  PROCEDURE usp_getmedicalrrecordviewnew(v_deptcode        VARCHAR DEFAULT '',
                                         v_datetimebegin   VARCHAR,
                                         v_datetimeend     VARCHAR,
                                         v_datetimeinbegin VARCHAR,
                                         v_datetimeinend   VARCHAR,
                                         v_patientname     VARCHAR DEFAULT '',
                                         v_recordid        VARCHAR DEFAULT '',
                                         v_applydoctor     VARCHAR DEFAULT '',
                                         v_qcstattype      INT,
                                         --Add wwj 用于模糊查询
                                         v_patid   VARCHAR DEFAULT '',
                                         v_indiag  VARCHAR DEFAULT '', --入院诊断
                                         v_outdiag VARCHAR DEFAULT '', --出院诊断
                                         v_curdiag VARCHAR DEFAULT '', --当前诊断
                                         o_result  OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  按科室或科室对应病人的归档或未归档电子病历
     功能说明
     输入参数
      v_DeptCode varchar(10)=''    --科室编号
      v_DateTimeBegin varchar(9)       --开始时间
       v_v_DateTimeEnd  varchar(9)       --结束时间
       v_PatientName  varchar(20)='',   --病人姓名
        v_RecordID  varchar(20)='',      --病历
       v_QCStatType int,                 --统计资料类型，1：已归档、2：申请借阅
       v_ApplyDoctor     varchar(6) ,        --申请医师代码

       --Add wwj 用于模糊查询
       v_PatID           varchar(32),       --病历号
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_GetMedicalRrecordView '', '2011-01-01', '2011-05-26','','','',1, ''
      exec usp_GetMedicalRrecordView '10', '', '','','','',3
      exec usp_GetMedicalRrecordView v_DeptCode='',v_DateTimeBegin='2001-03-01'
      ,v_DateTimeEnd='2011-03-10',v_QCStatType='1',v_PatientName='',v_RecordID='',v_ApplyDoctor=''
      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-03-01',v_DateTimeEnd='2011-03-25'
      ,v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-03-01'
      ,v_DateTimeEnd='2011-04-27',v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-04-01'
      ,v_DateTimeEnd='2011-04-27',v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

     修改记录
    **********/
    v_sql       VARCHAR(4000);
    v_where     VARCHAR(1000) DEFAULT '';
    v_leftwhere VARCHAR(100) DEFAULT '';
    v_deptwhere VARCHAR(100) DEFAULT '';
  BEGIN
    IF v_deptcode IS NOT NULL THEN
      v_where := 'and inp.OutHosDept=''' || v_deptcode || '''';
    END IF;

    IF v_patid IS NOT NULL THEN
      v_where := v_where || ' and inp.PatID like ' || '''%' || v_patid ||
                 '%''';
    END IF;

    IF v_patientname IS NOT NULL THEN
      v_where := v_where || ' and inp.Name like ' || '''%' || v_patientname ||
                 '%''';
    END IF;

    IF v_recordid IS NOT NULL THEN
      v_where := v_where || ' and inp.NoOfRecord like ' || '''%' ||
                 v_recordid || '%''';
    END IF;

    IF v_indiag IS NOT NULL THEN
      v_where := v_where || ' and inp.admitdiagnosis=''' || v_indiag || '''';
    END IF;

    IF v_outdiag IS NOT NULL THEN
      v_where := v_where || ' and id.diagnosis_code=''' || v_outdiag || '''';
    END IF;

    IF v_curdiag IS NOT NULL THEN
      v_where := v_where || ' and cur.diag_code=''' || v_curdiag || '''';
    END IF;

    IF v_applydoctor IS NOT NULL THEN
      v_where := v_where || ' and ar.ApplyDoctor=''' || v_applydoctor || '''';
      --set v_LeftWhere=' and ar.ApplyDoctor='''+v_ApplyDoctor+''''
    END IF;

    IF v_qcstattype = '1' THEN
      --患者已归档病历阅览
      v_sql := N' SELECT DISTINCT ar.ApplyDate, --ROW_NUMBER() OVER (ORDER BY inp.NoOfInpat ASC) AS RowID_,
      inp.NoOfInpat AS NoOfInpat,inp.PatNoOfHis AS PatNoOfHis
    ,inp.Name AS Name,inp.SexID,inp.ADMITDIAGNOSIS, id.diagnosis_code ,dd.Name AS SexName,inp.InCount as InCount, inp.AgeStr AS AgeStr
    ,inp.AdmitDate as AdmitDate, bed.WardId AS WardId, bed.DeptID AS DeptID, bed.ID  AS BedID
    ,datediff(''dd'',inp.AdmitDate,nvl(trim(inp.OutWardDate),to_char(sysdate,''yyyy-mm-dd'')))+1 inhosdays,inp.OutWardDate
    ,CASE WHEN (SELECT COUNT (noofinpat) FROM recorddetail WHERE recorddetail.noofinpat = inp.noofinpat) > 0 THEN ''已经治'' ELSE ''未经治'' END AS statusname
    ,inp.Resident,us3.Name as ResidentName
    ,inp.Attend,us1.Name as AttendName ,inp.Chief ,us2.Name as ChiefName,inp.Status
    ,inp.PatID RecordID --mr.ID as RecordID
    ,inp.NoOfRecord,inp.OutBed,inp.OutHosDept,de1.Name as DeptName,rd.islock
    ,ar. Status  as ApplyStatusID,cd1.Name as ApplyStatus
    FROM InPatient inp
    LEFT JOIN recorddetail rd ON inp.noofinpat = rd.noofinpat
    left join Dictionary_detail dd  ON dd.CategoryID = ''3'' AND inp.SexID = dd.DetailID
    left join Bed bed  ON inp.NoOfInpat = bed.NoOfInpat
    left join Ward ward  on bed.WardId = ward.ID
    left join Department de  on bed.DeptID = de.ID
    left join Users us1 on us1.ID=inp.Attend
    left join Users us2 on us2.ID=inp.Chief
    left join Users us3 on us3.ID=inp.Resident
    left join Department de1  on inp.OutHosDept = de1.ID
    left join CurrentDiag cur on cur.patient_id = inp.noofinpat
    --left join MedicalRecord mr on mr.NoOfInpat = inp.NoOfInpat
    --left join ApplyRecord ar on ar.NoOfInpat=inp.NoOfInpat

    --串病历借阅记录表，得到病历借阅的状态
    left join ApplyRecord ar on ar.NoOfInpat=inp.NoOfInpat
    left join CategoryDetail cd1 on cd1.CategoryID = ''52'' and cd1.ID = ar. Status

    --zyx 2013-1-11 得到出院诊断取iem_mainpage_diagnosis_2012中的字段
      left join iem_mainpage_basicinfo_2012 ib  on ib.noofinpat = inp.noofinpat
      left join iem_mainpage_diagnosis_2012 id on id.iem_mainpage_no = ib.iem_mainpage_no
         and id.valide = 1
         and id.diagnosis_type_id <> 13

    WHERE inp.Status IN  (''1502'',''1503'')

    and rd.islock = ''4701''



    and to_date(substr(nvl(trim(inp.OutWardDate),''1990-01-01''),1,10) , ''yyyy-mm-dd'') >=  to_date(''' ||
               v_datetimebegin ||
               ''', ''yyyy-mm-dd'')
    and to_date(substr(nvl(trim(inp.OutWardDate),''1990-01-01''),1,10) , ''yyyy-mm-dd'') <=  to_date(''' ||
               v_datetimeend ||
               ''', ''yyyy-mm-dd'')

    and to_date(substr(nvl(trim(inp.inwarddate),''1990-01-01''),1,10) , ''yyyy-mm-dd'') >=  to_date(''' ||
               v_datetimeinbegin ||
               ''', ''yyyy-mm-dd'')
    and to_date(substr(nvl(trim(inp.inwarddate),''1990-01-01''),1,10) , ''yyyy-mm-dd'') <=  to_date(''' ||
               v_datetimeinend || ''', ''yyyy-mm-dd'')

     ' || v_where || '
     order by inp.NoOfInpat';

    ELSIF v_qcstattype = '2' THEN
      --申请借阅患者病历,已经归档的病历
      v_sql := N' SELECT DISTINCT --ROW_NUMBER() OVER (ORDER BY inp.NoOfInpat ASC) AS RowID_,
     inp.NoOfInpat AS NoOfInpat,inp.PatNoOfHis AS PatNoOfHis,inp.PatID AS PatID,de.Name as DeptName
    ,inp.Name AS Name,inp.SexID,dd.Name AS SexName,inp.InCount as InCount, inp.AgeStr AS AgeStr
    ,inp.AdmitDate as AdmitDate,inp.OutWardDate, inp.OutHosDept AS DeptID,ds.Name as DiagnosisName
    ,inp.PatID RecordID --mr.ID as RecordID
    ,inp.NoOfRecord
    FROM InPatient inp
    LEFT JOIN recorddetail rd ON inp.noofinpat = rd.noofinpat
    left join Dictionary_detail dd  ON dd.CategoryID = ''3'' AND inp.SexID = dd.DetailID
    left join Bed bed  ON inp.NoOfInpat = bed.NoOfInpat
    left join Ward ward  on bed.WardId = ward.ID
    left join Department de  on inp.OutHosDept = de.ID
    left join Diagnosis  ds on inp.OutDiagnosis=ds.MarkId
    left join MedicalRecord mr on mr.NoOfInpat = inp.NoOfInpat

     left join iem_mainpage_basicinfo_2012 ib  on ib.noofinpat = inp.noofinpat
      left join iem_mainpage_diagnosis_2012 id on id.iem_mainpage_no = ib.iem_mainpage_no
         and id.valide = 1
         and id.diagnosis_type_id <> 13

    WHERE inp.Status IN  (''1502'',''1503'')' || v_where ||
               ' AND rd.islock =''4701''  order by inp.NoOfInpat';
    END IF;

    OPEN o_result FOR v_sql;
  END;

  /**********edit by wyt 2012-08-16***********************************************************************/
  PROCEDURE usp_getmedicalrrecordview(v_deptcode      VARCHAR DEFAULT '',
                                      v_datetimebegin VARCHAR,
                                      v_datetimeend   VARCHAR,
                                      v_patientname   VARCHAR DEFAULT '',
                                      v_recordid      VARCHAR DEFAULT '',
                                      v_applydoctor   VARCHAR DEFAULT '',
                                      v_qcstattype    INT,
                                      --Add wwj 用于模糊查询
                                      v_patid   VARCHAR DEFAULT '',
                                      v_outdiag VARCHAR DEFAULT '',
                                      o_result  OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  按科室或科室对应病人的归档或未归档电子病历
     功能说明
     输入参数
      v_DeptCode varchar(10)=''    --科室编号
      v_DateTimeBegin varchar(9)       --开始时间
       v_v_DateTimeEnd  varchar(9)       --结束时间
       v_PatientName  varchar(20)='',   --病人姓名
        v_RecordID  varchar(20)='',      --病历
       v_QCStatType int,                 --统计资料类型，1：已归档、2：申请借阅
       v_ApplyDoctor     varchar(6) ,        --申请医师代码

       --Add wwj 用于模糊查询
       v_PatID           varchar(32),       --病历号
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_GetMedicalRrecordView '', '2011-01-01', '2011-05-26','','','',1, ''
      exec usp_GetMedicalRrecordView '10', '', '','','','',3
      exec usp_GetMedicalRrecordView v_DeptCode='',v_DateTimeBegin='2001-03-01'
      ,v_DateTimeEnd='2011-03-10',v_QCStatType='1',v_PatientName='',v_RecordID='',v_ApplyDoctor=''
      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-03-01',v_DateTimeEnd='2011-03-25'
      ,v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-03-01'
      ,v_DateTimeEnd='2011-04-27',v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

      exec usp_GetMedicalRrecordView v_DeptCode='3202',v_DateTimeBegin='2011-04-01'
      ,v_DateTimeEnd='2011-04-27',v_QCStatType='2',v_PatientName='',v_RecordID='',v_ApplyDoctor='00'

     修改记录
    **********/
    v_sql       VARCHAR(4000);
    v_where     VARCHAR(4000) DEFAULT '';
    v_leftwhere VARCHAR(100) DEFAULT '';
    v_deptwhere VARCHAR(100) DEFAULT '';
  BEGIN
    IF v_deptcode IS NOT NULL THEN
      v_where := 'and inp.OutHosDept=''' || v_deptcode || '''';
    END IF;

    IF v_patid IS NOT NULL THEN
      v_where := v_where || ' and inp.PatID like ' || '''%' || v_patid ||
                 '%''';
    END IF;

    IF v_patientname IS NOT NULL THEN
      v_where := v_where || ' and inp.Name like ' || '''%' || v_patientname ||
                 '%''';
    END IF;

    IF v_recordid IS NOT NULL THEN
      v_where := v_where || ' and inp.NoOfRecord=''' || v_recordid || '''';
    END IF;

    IF v_applydoctor IS NOT NULL THEN
      v_where := v_where || ' and ar.ApplyDoctor=''' || v_applydoctor || '''';
      --set v_LeftWhere=' and ar.ApplyDoctor='''+v_ApplyDoctor+''''
    END IF;

    IF v_outdiag IS NOT NULL THEN
      v_where := v_where || ' and inp.Outdiagnosis=''' || v_outdiag || '''';
    END IF;

    IF v_qcstattype = '1' THEN
      --患者已归档病历阅览(-- edit by cyq 2012-11-15 添加sexid列)
      v_sql := N' SELECT DISTINCT ar.ApplyDate, --ROW_NUMBER() OVER (ORDER BY inp.NoOfInpat ASC) AS RowID_,
      inp.NoOfInpat AS NoOfInpat,inp.PatNoOfHis AS PatNoOfHis
    ,inp.Name AS Name,inp.SexID,dd.Name AS SexName,inp.InCount as InCount, inp.AgeStr AS AgeStr
    ,inp.AdmitDate as AdmitDate, bed.WardId AS WardId, bed.DeptID AS DeptID, bed.ID  AS BedID
    ,datediff(''dd'',inp.AdmitDate,nvl(trim(inp.OutWardDate),to_char(sysdate,''yyyy-mm-dd'')))+1 inhosdays,inp.OutWardDate
    ,CASE WHEN (SELECT COUNT (noofinpat) FROM recorddetail WHERE recorddetail.noofinpat = inp.noofinpat) > 0 THEN ''已经治'' ELSE ''未经治'' END AS statusname
    ,inp.Resident,us3.Name as ResidentName
    ,inp.Attend,us1.Name as AttendName ,inp.Chief ,us2.Name as ChiefName,inp.Status
    ,inp.PatID RecordID --mr.ID as RecordID
    ,inp.NoOfRecord,inp.OutBed,inp.OutHosDept,inp.Outdiagnosis as DiagnosisCode,Diagnosis.Name as DIAGNOSISNAME,de1.Name as DeptName,rd.islock
    ,ar. Status  as ApplyStatusID,cd1.Name as ApplyStatus
    FROM InPatient inp
    LEFT JOIN recorddetail rd ON inp.noofinpat = rd.noofinpat
    left join Dictionary_detail dd  ON dd.CategoryID = ''3'' AND inp.SexID = dd.DetailID
    left join Bed bed  ON inp.NoOfInpat = bed.NoOfInpat
    left join Ward ward  on bed.WardId = ward.ID
    left join Department de  on bed.DeptID = de.ID
    left join Users us1 on us1.ID=inp.Attend
    left join Users us2 on us2.ID=inp.Chief
    left join Users us3 on us3.ID=inp.Resident
    left join Department de1  on inp.OutHosDept = de1.ID
    left join Diagnosis dia on inp.Outdiagnosis=dia.icd --add by cyq 2012-12-07
    --left join MedicalRecord mr on mr.NoOfInpat = inp.NoOfInpat
    --left join ApplyRecord ar on ar.NoOfInpat=inp.NoOfInpat

    --串病历借阅记录表，得到病历借阅的状态
    left join ApplyRecord ar on ar.NoOfInpat=inp.NoOfInpat
    left join CategoryDetail cd1 on cd1.CategoryID = ''52'' and cd1.ID = ar. Status

    WHERE inp.Status IN  (''1502'',''1503'')

    and rd.islock = ''4701''

    and to_date(substr(nvl(trim(ar.ApplyDate),''1990-01-01''),1,10) , ''yyyy-mm-dd'') >=  to_date(''' ||
               v_datetimebegin ||
               ''', ''yyyy-mm-dd'')
    and to_date(substr(nvl(trim(ar.ApplyDate),''1990-01-01''),1,10) , ''yyyy-mm-dd'') <=  to_date(''' ||
               v_datetimeend || ''', ''yyyy-mm-dd'')

     ' || v_where || '
     order by inp.NoOfInpat';

    ELSIF v_qcstattype = '2' THEN
      --申请借阅患者病历,已经归档的病历(-- edit by cyq 2012-11-15 添加sexid列)
      v_sql := N' SELECT DISTINCT --ROW_NUMBER() OVER (ORDER BY inp.NoOfInpat ASC) AS RowID_,
     inp.NoOfInpat AS NoOfInpat,inp.PatNoOfHis AS PatNoOfHis,inp.PatID AS PatID,de.Name as DeptName
    ,inp.Name AS Name,inp.SexID,dd.Name AS SexName,inp.InCount as InCount, inp.AgeStr AS AgeStr
    ,inp.AdmitDate as AdmitDate,inp.OutWardDate, inp.OutHosDept AS DeptID,inp.OutDiagnosis as DiagnosisCode,ds.Name as DiagnosisName
    ,inp.PatID RecordID --mr.ID as RecordID
    ,inp.NoOfRecord
    FROM InPatient inp
    LEFT JOIN recorddetail rd ON inp.noofinpat = rd.noofinpat
    left join Dictionary_detail dd  ON dd.CategoryID = ''3'' AND inp.SexID = dd.DetailID
    left join Bed bed  ON inp.NoOfInpat = bed.NoOfInpat
    left join Ward ward  on bed.WardId = ward.ID
    left join Department de  on inp.OutHosDept = de.ID
    left join Diagnosis  ds on inp.OutDiagnosis=ds.MarkId
    left join MedicalRecord mr on mr.NoOfInpat = inp.NoOfInpat
    WHERE inp.Status IN  (''1502'',''1503'')' || v_where ||
               ' AND rd.islock =''4701''  order by inp.NoOfInpat';
    END IF;

    OPEN o_result FOR v_sql;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getmedicalrrecordviewfrm(v_gettype VARCHAR,
                                         --获取数据类型，1：科室、2：申请借阅目的、3：申请期限单位、4：病人姓名
                                         o_result OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  保存申请借阅电子病历信息
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例
    exec usp_GetMedicalRrecordViewFrm '1'
     修改记录
    **********/
  BEGIN
    IF v_gettype = '1' THEN
      --查询科室 全院 + 临床科室
      OPEN o_result FOR
        SELECT '0000' AS ID, '全院' AS NAME, 'qy' as PY, 'wgbpf' as WB
          FROM DUAL
        UNION
        SELECT ID, NAME, PY, WB
          FROM department, dept2ward dw
         WHERE department.ID = dw.deptid
           and department.valid = 1
         ORDER BY ID;
    ELSIF v_gettype = '2' THEN
      --查询借阅目的
      OPEN o_result FOR
        SELECT ID, NAME, PY, WB
          FROM categorydetail
         WHERE categoryid = '50'
         ORDER BY ID;
    ELSIF v_gettype = '3' THEN
      --借阅时间单位
      OPEN o_result FOR
        SELECT ID, NAME, PY, WB
          FROM categorydetail
         WHERE categoryid = '51'
         ORDER BY ID;
    ELSIF v_gettype = '4' THEN
      --查询病人姓名
      OPEN o_result FOR
        SELECT patid ID, NAME, PY, WB FROM inpatient ORDER BY ID;
    ELSIF v_gettype = '5' THEN
      --查询病历号
      OPEN o_result FOR
        SELECT patid ID FROM inpatient ORDER BY ID;

    ELSIF v_gettype = '6' THEN
      --查询入院诊断
      OPEN o_result FOR
        SELECT inpatient.patid,
               inpatient.name,
               ADMITDIAGNOSIS  ICD,
               diagnosis.name  diagnosis
          FROM inpatient, diagnosis
         where inpatient.admitdiagnosis = diagnosis.icd;

    ELSIF v_gettype = '7' THEN
      --查询出院诊断
      OPEN o_result FOR
        SELECT inpatient.patid,
               inpatient.name,
               OUTDIAGNOSIS    ICD,
               diagnosis.name  diagnosis
          FROM inpatient, diagnosis
         where inpatient.OUTDIAGNOSIS = diagnosis.icd;

      /*   ELSIF v_gettype = '8' THEN
      --查询当前诊断
      OPEN o_result FOR
        SELECT
        patient_id patid,
        patient_name name,
        Diag_code ICD,
        Diag_content diagnosis
          FROM CurrentDiag;*/
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getnotesonnursinginfo(v_noofinpat    NUMERIC, --首页序号(住院流水号)
                                      v_dateofsurvey VARCHAR, --测量日期期（格式2010-01-01）
                                      o_result       OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取护理信息数据
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    --获取护理信息数据
    OPEN o_result FOR
      SELECT *
        FROM notesonnursing
       WHERE dateofsurvey = v_dateofsurvey
         AND noofinpat = v_noofinpat;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getnursingrecordbydate(v_noofinpat NUMERIC DEFAULT '0', --首页序号
                                       v_begindate VARCHAR, --起始时间
                                       v_enddate   VARCHAR, --终止时间
                                       o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT non.*,
             CASE
               WHEN non.wayofsurvey = '8800' THEN
                '8801'
               ELSE
                TO_CHAR(non.wayofsurvey)
             END testtype --护理级别
        FROM notesonnursing non
       WHERE non.noofinpat = v_noofinpat
         AND to_char(to_date(v_begindate, 'yyyy-MM-dd'), 'yyyy-MM-dd') <=
             non.dateofsurvey
         AND non.dateofsurvey <=
             to_char(to_date(v_enddate, 'yyyy-MM-dd'), 'yyyy-MM-dd')
      /*AND to_date(v_begindate,'yyyy-MM-dd') <= to_date(non.dateofsurvey,'yyyy-MM-dd')
      AND to_date(non.dateofsurvey,'yyyy-MM-dd') <= to_date(v_enddate,'yyyy-MM-dd')*/
       ORDER BY non.dateofsurvey, TO_NUMBER(non.timeslot);
  END;

  /*********************************************************************************/
  PROCEDURE usp_getnursingrecordparam(v_frmtype VARCHAR, --窗体操作类型
                                      o_result  OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取护理文书项目窗体参数
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_frmtype = '1' THEN
      --获取生命体征记录时间段
      OPEN o_result FOR
        SELECT configkey, VALUE
          FROM appcfg
         WHERE configkey IN ('VITALSIGNSRECORDTIME', 'MODIFYNURSINGINFO');
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getpatientbedinfobydate(v_noofinpat    NUMERIC DEFAULT '0', --首页序号
                                        v_allocatedate VARCHAR, --指定的时间
                                        o_result       OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT *
        FROM (SELECT bi.formerbedid, --病床号
                     d.NAME AS deptname, --部门名称
                     (SELECT hi.NAME FROM hospitalinfo hi) AS hospitalname
                FROM bedinfo bi
                LEFT OUTER JOIN department d
                  ON d.ID = bi.formerdeptid
               WHERE bi.noofinpat = v_noofinpat
                 AND bi.startdate <= v_allocatedate
               ORDER BY bi.startdate DESC) temp
       WHERE ROWNUM <= 1;
  END;

  /*********add by wyt 2012-08-15************************************************************************/
  PROCEDURE usp_getdiagicdbyname(v_name   varchar, --病种名称
                                 o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT diag.icd FROM diagnosis diag WHERE diag.name = v_name;
  END;

  /*********add by wyt 2012-08-15************************************************************************/
  PROCEDURE usp_getdiagnamebyicd(v_icd    varchar, --病种编号
                                 o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT ICD, NAME, PY, WB FROM diagnosis WHERE icd = v_icd;
  END;

  /**********************add by wyt 2012-08-15***********************************************************/
  PROCEDURE usp_getdiagbyattendphysician(v_userid varchar, --用户编号
                                         o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT atd.relatedisease
        FROM ATTENDINGPHYSICIAN atd
       WHERE atd.id = v_userid;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getpatientinfoforthreemeas(v_noofinpat NUMERIC DEFAULT '0', --首页序号
                                           o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
    /*  SELECT dd.NAME AS gender,
                                 d.NAME AS dept_name,
                                 ip.admitbed,
                                 ip.NAME AS patient_name,
                                 ip.agestr,
                                 ip.admitdate,
                                 ip.patid,
                                 ip.outhosdate,
                                 ip.admitbed,
                                 ip.noofinpat
                            FROM inpatient ip
                            LEFT OUTER JOIN dictionary_detail dd ON dd.detailid = ip.sexid
                                                                AND dd.categoryid = '3'
                          --性别
                            LEFT OUTER JOIN department d ON d.ID = ip.admitdept
                          --部门
                           WHERE ip.noofinpat = v_noofinpat; --根据首页序号得到病人的基本信息*/
    --三测表中数据的修改（科别和床位的绑定）edit by ywk 2012年4月17日16:32:44
      SELECT dd.NAME AS gender,
             d.NAME AS dept_name,
             ip.outhosdept AS dept_id,
             ip.admitbed,
             ip.NAME AS patient_name,
             ip.agestr,
             ip.admitdate,
             ip.patid,
             ip.outhosdate,
             ip.admitbed,
             ip.outbed,
             ip.noofinpat,
             nvl(ip.inwarddate, ip.admitdate) inwarddate, --入科日期
             ip.isbaby, --是否是婴儿 add by ywk  2012年7月30日 13:38:14
             ip.mother, --母亲的Noofinpat
             ip.birth as BirthDay,
             im.weight
        FROM inpatient ip
        LEFT OUTER JOIN dictionary_detail dd
          ON dd.detailid = ip.sexid
         AND dd.categoryid = '3'
      --科别
      --LEFT OUTER JOIN department d ON d.ID = ip.admitdept
        LEFT OUTER JOIN department d
          ON d.ID = ip.outhosdept
        LEFT OUTER JOIN iem_mainpage_basicinfo_2012 im
          ON ip.noofinpat = im.noofinpat
      --部门
       WHERE ip.noofinpat = v_noofinpat;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getrecordmanagefrm(v_frmtype VARCHAR,
                                   --窗体类型，1n：病人信息管理维护窗体、2n：病人病历史信息窗体
                                   v_patnoofhis NUMERIC DEFAULT '0', --首页序号
                                   v_categoryid VARCHAR DEFAULT '',
                                   --(字典)类别代码 、或父节点代码 、首页序号
                                   o_result OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取病历管理窗体控件初始化数据
     功能说明
     输入参数
     输出参数
     结果集、排序


     调用的sp
     调用实例

     修改记录
    **********/
  BEGIN
    IF v_frmtype = '1' THEN
      --获取字典表信息
      OPEN o_result FOR
        SELECT categoryid, CAST(ID AS VARCHAR(4)) AS detailid, NAME, py, wb
          FROM categorydetail
         WHERE categoryid = v_categoryid
           AND ID != '4701';
    ELSIF v_frmtype = '2' THEN
      --获取手术名称
      OPEN o_result FOR
        SELECT * FROM operation ORDER BY NAME;--surgery原来居然是这个表 edit by ywk 2013年9月15日 15:25:10
    END IF;
  END;

  --获取诊断医师查询的记录
  /*PROCEDURE usp_getattendrecordnoonfile(v_dateOutHosBegin   VARCHAR, --出院开始日期
                                   v_dateOutHosEnd     VARCHAR, --出院结束日期
                                   v_dateInHosBegin   VARCHAR,--入院开始日期
                                   v_dateInHosEnd   VARCHAR,--入院截止日期
                                   v_deptid      VARCHAR, --科室代码
                                   v_status      VARCHAR, --病历状态
                                   v_patientname VARCHAR DEFAULT '', --病人姓名
                                   v_recordid    VARCHAR DEFAULT '', --病历号
                                   v_indiag    VARCHAR DEFAULT '', --入院诊断
                                   v_outdiag    VARCHAR DEFAULT '', --出院诊断
                                   v_curdiag    VARCHAR DEFAULT '', --当前诊断
                                   o_result      OUT empcurtyp) AS
                                   v_ds varchar(15);
  BEGIN
     --获取未归档病历
     OPEN o_result FOR
       select distinct inp.noofinpat,
                       inp.patid,
                       inp.noofrecord,
                       inp.name,
                       /*inp.sexid,*/ --已有SexName字段，此字段可省  by XLB 2012-12-12
  /*                      inp.agestr,
   inp.incount,
   inp.admitdate,
   inp.outbed,
   inp.OutHosDept,
  /* inp.OutDiagnosis,*/ --当前程序前不需要 by XLB 2012-12-12
  /*                     inp.Attend,
  inp.Chief,
  inp.Resident,
   inp.Status,
   dept.Name as OutHosDeptName,
   dd.Name as SexName,
   d.Name as DiagnosisName,  --edit by ywk   2012年12月4日9:16:07
   case
     when cd.Name is null then
      '未归档'
     when cd.Name = '' then
      '未归档'
     else
      cd.Name
   end LockInfoName,
   /*  datediff('yy',
              inp.Birth,
              to_char(sysdate, 'yyyy-mm-dd')) as InpAgeNum,*/
  /*                      datediff('dd',
                         inp.AdmitDate,
                         nvl(trim(inp.OutWardDate),
                             to_char(sysdate, 'yyyy-mm-dd'))) + 1 as InHosDay,
                datediff('dd',
                         nvl(trim(inp.OutWardDate),
                             to_char(sysdate, 'yyyy-mm-dd')),
                         to_char(sysdate, 'yyyy-mm-dd')) as OutHosDay,
                case
                  when (SELECT count(NoOfInpat)
                          FROM MedicalRecord
                         where MedicalRecord.NoOfInpat = inp.NoOfInpat) > 0 then
                   '已经治'
                  else
                   '未经治'
                end as StatusName,
                us3.Name as ResidentName,
                us1.Name as AttendName,
                us2.Name as ChiefName
                --,
                --mr.ID as RecordID,
                --b.ID     AS BedID,
                --b.WardId as WardId

  from (
  select InPatient.noofinpat,
                InPatient.patid,
                InPatient.noofrecord,
                InPatient.name,
                InPatient.sexid,
                InPatient.agestr,
                InPatient.incount,
                InPatient.admitdate,
                InPatient.outbed,
                InPatient.OutHosDept,
                InPatient.OutDiagnosis,
                InPatient.Attend,
                InPatient.Chief,
                InPatient.Resident,
                InPatient.OutWardDate,
                InPatient.admitdiagnosis,
                Inpatient.Status
                from InPatient
  where trim(InPatient.OutWardDate) is not null
   and trim(InPatient.inwarddate) is not null                 --为了对病人状态进行查询，删除了InPatient.Status in ('1502', '1503') by XLB
    /*and InPatient.Name like '%' || v_patientname
    and InPatient.Name like '%' || v_patientname*/ --by 项令波 2012-12-12
  /*         and InPatient.Name like '%' || v_patientname || '%'
       and to_date(substr(nvl(trim(InPatient.OutWardDate), sysdate), 1, 10),
                  'yyyy-mm-dd') >= to_date(v_dateOutHosBegin, 'yyyy-mm-dd')
      and to_date(substr(nvl(trim(InPatient.OutWardDate), '1990-01-01'), 1, 10),
                  'yyyy-mm-dd') < to_date(v_dateOutHosEnd, 'yyyy-mm-dd')
      and to_date(substr(nvl(trim(InPatient.inwarddate), sysdate), 1, 10),
                  'yyyy-mm-dd') >= to_date(v_dateInHosBegin, 'yyyy-mm-dd')
      and to_date(substr(nvl(trim(InPatient.inwarddate), '1990-01-01'), 1, 10),
                  'yyyy-mm-dd') < to_date(v_dateInHosEnd, 'yyyy-mm-dd')
      and InPatient.NoOfRecord like '%' || v_recordid || '%'
      and InPatient.OutHosDept like '%'||v_deptid||'%'
      ) inp
    left  join Department dept on dept.ID = inp.OutHosDept
   left  join Dictionary_detail dd on dd.CategoryID = '3'
                                   and dd.DetailID = inp.SexID
    left join recorddetail rd on rd.noofinpat = inp.NoOfInpat
   left  join CategoryDetail cd on cd.CategoryID = '47'
                                and cd.ID = rd.islock
   left join Users us1 on us1.ID = inp.Attend
   left  join Users us2 on us2.ID = inp.Chief
   left join Users us3 on us3.ID = inp.Resident
   left join iem_mainpage_basicinfo_2012 ib on ib.noofinpat=inp.noofinpat
   left  join iem_mainpage_diagnosis_2012 id on id.iem_mainpage_no=ib.iem_mainpage_no
   left   join Diagnosis d on d.ICD =id.diagnosis_code and d.valid=1 and id.valide=1 and id.diagnosis_type_id<>13--关于出院诊断的获取应该吧这个语句拿到下面 edit by ywk 2012年12月4日9:16:59
  left  join PATDIAG pd on inp.noofinpat= pd.patient_id
    where
      (rd.islock IN (v_status) or rd.islock is null)

        and(id.diagnosis_code = v_outdiag or v_outdiag='' or v_outdiag is null)
        /* or (idd.diagnosis_code = v_outdiag or v_outdiag='' or v_outdiag is null))*/
  -- by cyq 2012-12-07
  /*         and id.diagnosis_type_id in ('7','8')
         --and (id.diagnosis_type_id in ('7','8') or id.diagnosis_type_id = '' or id.diagnosis_type_id is null)
         and (pd.diag_code = v_curdiag or v_curdiag='' or v_curdiag is null)
          and (inp.OutHosDept = v_deptid or v_deptid = '0000' or v_deptid = '' or v_deptid is null)
        and (inp.admitdiagnosis = v_indiag or v_indiag='' or v_indiag is null)
       order by InHosDay;
  END;
  */
  PROCEDURE usp_getattendrecordnoonfile(v_dateOutHosBegin VARCHAR, --出院开始日期
                                        v_dateOutHosEnd   VARCHAR, --出院结束日期
                                        v_dateInHosBegin  VARCHAR, --入院开始日期
                                        v_dateInHosEnd    VARCHAR, --入院截止日期
                                        v_deptid          VARCHAR, --科室代码
                                        v_status          VARCHAR, --病历状态
                                        v_patientname     VARCHAR DEFAULT '', --病人姓名
                                        v_recordid        VARCHAR DEFAULT '', --病历号
                                        v_indiag          VARCHAR DEFAULT '', --入院诊断
                                        v_outdiag         VARCHAR DEFAULT '', --出院诊断
                                        v_curdiag         VARCHAR DEFAULT '', --当前诊断
                                        v_diaGroupStatus  VARCHAR, --诊断分组状态
                                        v_PatientStatus   VARCHAR, --病人状态
                                        v_ingroupid       VARCHAR, --分组ID1
                                        v_outgroupid      VARCHAR, --分组ID2
                                        o_result          OUT empcurtyp) AS
    v_sql varchar(5000);
  BEGIN
    OPEN o_result FOR --v_sql;
      select distinct inp.noofinpat,
                      inp.patid,
                      inp.noofrecord,
                      inp.name,
                      inp.sexid,
                      inp.agestr,
                      inp.incount,
                      inp.admitdate,
                      inp.outwarddate, --Add by xlb 出院时间 2013-06-19
                      inp.outbed,
                      inp.OutHosDept,
                      inp.OutDiagnosis,
                      inp.admitdiagnosis,
                      inp.Attend,
                      inp.Chief,
                      inp.Resident,
                      inp.Status,
                      dept.Name as OutHosDeptName,
                      dd.Name as SexName,
                      case
                        when cd.Name is null then
                         '未归档'
                        when cd.Name = '' then
                         '未归档'
                        else
                         cd.Name
                      end LockInfoName,
                      datediff('dd',
                               inp.AdmitDate,
                               --nvl(trim(inp.OutWardDate),
                               nvl(trim(inp.outhosdate), -- 此处用出院时间减去入院时间得到入院天数  2013-3-14 by tj
                                   to_char(sysdate, 'yyyy-mm-dd'))) + 1 as InHosDay,
                      datediff('dd',
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd')),
                               to_char(sysdate, 'yyyy-mm-dd')) as OutHosDay,
                      case
                        when (SELECT count(NoOfInpat)
                                FROM MedicalRecord
                               where MedicalRecord.NoOfInpat = inp.NoOfInpat) > 0 then
                         '已经治'
                        else
                         '未经治'
                      end as StatusName,
                      us3.Name as ResidentName,
                      us1.Name as AttendName,
                      us2.Name as ChiefName,
                      id.diagnosis_type_id,
                      id.order_value,
                      id.diagnosis_code,
                     inp.admitdiagnosis AdmitDiagnosisName,
                      id.diagnosis_name DiagnosisName
        from InPatient inp
        left join diagnosis diag
          on diag.icd = inp.admitdiagnosis
        left join Department dept
          on dept.ID = inp.OutHosDept
        left join Dictionary_detail dd
          on dd.CategoryID = '3'
         and dd.DetailID = inp.SexID
        left join recorddetail rd
          on rd.noofinpat = inp.NoOfInpat
        left join CategoryDetail cd
          on cd.CategoryID = '47'
         and cd.ID = rd.islock
        left join Users us1
          on us1.ID = inp.Attend
        left join Users us2
          on us2.ID = inp.Chief
        left join Users us3
          on us3.ID = inp.Resident
        left join iem_mainpage_basicinfo_2012 ib
          on ib.noofinpat = inp.noofinpat
        left join iem_mainpage_diagnosis_2012 id
          on id.iem_mainpage_no = ib.iem_mainpage_no
         and id.valide = 1
         and id.diagnosis_type_id <> 13
        left join Diagnosis d
          on d.ICD = id.diagnosis_code
         and d.valid = 1
         and id.valide = 1
         and id.diagnosis_type_id <> 13
        left join PATDIAG pd
          on inp.noofinpat = pd.patient_id
       where trim(inp.inwarddate) is not null --为了对病人状态进行查询，删除了InPatient.Status in ('1502', '1503') by XLB
         and inp.Name like '%' || v_patientname || '%'
         and to_date(substr(nvl(trim(inp.OutWardDate),
                                '9999-12-31 23:59:59'),
                            0,
                            19),
                     'yyyy-mm-dd hh24:mi:ss') >=
             to_date(v_dateOutHosBegin, 'yyyy-mm-dd hh24:mi:ss')
         and to_date(substr(nvl(trim(inp.OutWardDate),
                                '9999-12-31 23:59:59'),
                            0,
                            19),
                     'yyyy-mm-dd hh24:mi:ss') <=
             to_date(v_dateOutHosEnd, 'yyyy-mm-dd hh24:mi:ss')
         and to_date(substr(nvl(trim(inp.inwarddate), '1000-01-01 00:00:00'),
                            0,
                            19),
                     'yyyy-mm-dd hh24:mi:ss') >=
             to_date(v_dateInHosBegin, 'yyyy-mm-dd hh24:mi:ss')
         and to_date(substr(nvl(trim(inp.inwarddate), '1000-01-01 00:00:00'),
                            0,
                            19),
                     'yyyy-mm-dd hh24:mi:ss') <=
             to_date(v_dateInHosEnd, 'yyyy-mm-dd hh24:mi:ss')
         and inp.NoOfRecord like '%' || v_recordid || '%'
         and inp.OutHosDept like '%' || v_deptid || '%'
         and (rd.islock IN (v_status) or rd.islock is null)
         and (id.diagnosis_code = v_outdiag or v_outdiag = '' or
              v_outdiag is null) /**
                                                                                              or (idd.diagnosis_code = v_outdiag or v_outdiag = '' or
                                                                                                  v_outdiag is null)) **/
            -- by cyq 2012-12-07
         and id.diagnosis_type_id in ('7', '8')
            --and (id.diagnosis_type_id in ('7','8') or id.diagnosis_type_id = '' or id.diagnosis_type_id is null)
         and (pd.diag_code = v_curdiag or v_curdiag = '' or
              v_curdiag is null)
         and (inp.OutHosDept = v_deptid or v_deptid = '0000' or
              v_deptid = '' or v_deptid is null)
         and (inp.admitdiagnosis = v_indiag or v_indiag = '' or
              v_indiag is null)
         and ((v_PatientStatus = '1' and inp.Status in ('1500', '1501')) or
              (v_PatientStatus = '2' and inp.Status in ('1502', '1503')) or
              v_PatientStatus = '0') --病人状态
         and ((v_diaGroupStatus = '1' and
              ((inp.admitdiagnosis in
              (select a.COLUMN_VALUE
                    from table (select split_string(dis.diseaseids, '$')
                                  from diseasesgroup dis
                                 where dis.valid = 1
                                   and dis.id = v_ingroupid) a)) or
              v_ingroupid = '' or v_ingroupid is null) and

              ((id.diagnosis_code in
              (select a.COLUMN_VALUE
                    from table (select split_string(dis.diseaseids, '$')
                                  from diseasesgroup dis
                                 where dis.valid = 1
                                   and dis.id = v_outgroupid) a)) or
              v_outgroupid = '' or v_outgroupid is null)) or
              v_diaGroupStatus = '0')
      --order by InHosDay;
       order by inp.noofinpat, id.order_value;
    /*    --获取未归档病历  wangji 注释 2013 1 21
    OPEN o_result FOR
      select distinct inp.noofinpat,
                      inp.patid,
                      inp.noofrecord,
                      inp.name,
                      inp.sexid,
                      inp.agestr,
                      inp.incount,
                      inp.admitdate,
                      inp.outbed,
                      inp.OutHosDept,
                      inp.OutDiagnosis,\* *\--当前程序前不需要 by XLB 2012-12-12   by zyx 2013-1-11
                      inp.admitdiagnosis,
                      inp.Attend,
                      inp.Chief,
                      inp.Resident,
                      inp.Status,
                      dept.Name    as OutHosDeptName,
                      dd.Name      as SexName,
                      --d.Name as DiagnosisName,  --edit by ywk   2012年12月4日9:16:07
                      case
                        when cd.Name is null then
                         '未归档'
                        when cd.Name = '' then
                         '未归档'
                        else
                         cd.Name
                      end LockInfoName,
                      \*  datediff('yy',
                      inp.Birth,
                      to_char(sysdate, 'yyyy-mm-dd')) as InpAgeNum,*\
                      datediff('dd',
                               inp.AdmitDate,
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd'))) + 1 as InHosDay,
                      datediff('dd',
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd')),
                               to_char(sysdate, 'yyyy-mm-dd')) as OutHosDay,
                      case
                        when (SELECT count(NoOfInpat)
                                FROM MedicalRecord
                               where MedicalRecord.NoOfInpat = inp.NoOfInpat) > 0 then
                         '已经治'
                        else
                         '未经治'
                      end as StatusName,
                      us3.Name as ResidentName,
                      us1.Name as AttendName,
                      us2.Name as ChiefName,
                      id.diagnosis_type_id,
                      id.order_value,
                      id.diagnosis_code,
                      id.diagnosis_name DiagnosisName
      --,
      --mr.ID as RecordID,
      --b.ID     AS BedID,
      --b.WardId as WardId

        from (select InPatient.noofinpat,
                      InPatient.patid,
                      InPatient.noofrecord,
                      InPatient.name,
                      InPatient.sexid,
                      InPatient.agestr,
                      InPatient.incount,
                      InPatient.admitdate,
                      InPatient.outbed,
                      InPatient.OutHosDept,
                      InPatient.OutDiagnosis,
                      InPatient.Attend,
                      InPatient.Chief,
                      InPatient.Resident,
                      InPatient.OutWardDate,
                      InPatient.admitdiagnosis,
                      Inpatient.Status --需要进行二次查询 XLB 2012-12-10
                 from InPatient
                where
                trim(InPatient.inwarddate) is not null --为了对病人状态进行查询，删除了InPatient.Status in ('1502', '1503') by XLB
             and InPatient.Name like '%' || v_patientname || '%'
             and to_date(substr(nvl(trim(InPatient.OutWardDate), '2999-12-01'),
                               1,
                               10),
                        'yyyy-mm-dd') >=
                to_date(v_dateOutHosBegin, 'yyyy-mm-dd')
             and to_date(substr(nvl(trim(InPatient.OutWardDate), '1990-01-01'),
                               1,
                               10),
                        'yyyy-mm-dd') <
                to_date(v_dateOutHosEnd, 'yyyy-mm-dd')
             and to_date(substr(nvl(trim(InPatient.inwarddate), '2999-12-01'),
                               1,
                               10),
                        'yyyy-mm-dd') >=
                to_date(v_dateInHosBegin, 'yyyy-mm-dd')
             and to_date(substr(nvl(trim(InPatient.inwarddate), '1990-01-01'),
                               1,
                               10),
                        'yyyy-mm-dd') < to_date(v_dateInHosEnd, 'yyyy-mm-dd')
             and InPatient.NoOfRecord like '%' || v_recordid || '%'
             and InPatient.OutHosDept like '%' || v_deptid || '%') inp
        left join Department dept
          on dept.ID = inp.OutHosDept
        left join Dictionary_detail dd
          on dd.CategoryID = '3'
         and dd.DetailID = inp.SexID
        left join recorddetail rd
          on rd.noofinpat = inp.NoOfInpat
        left join CategoryDetail cd
          on cd.CategoryID = '47'
         and cd.ID = rd.islock
        left join Users us1
          on us1.ID = inp.Attend
        left join Users us2
          on us2.ID = inp.Chief
        left join Users us3
          on us3.ID = inp.Resident
        left join iem_mainpage_basicinfo_2012 ib
          on ib.noofinpat = inp.noofinpat
        left join iem_mainpage_diagnosis_2012 id
          on id.iem_mainpage_no = ib.iem_mainpage_no
         and id.valide = 1
         and id.diagnosis_type_id <> 13
        left join Diagnosis d
          on d.ICD = id.diagnosis_code
         and d.valid = 1
         and id.valide = 1
         and id.diagnosis_type_id <> 13 --关于出院诊断的获取应该吧这个语句拿到下面 edit by ywk 2012年12月4日9:16:59
        left join PATDIAG pd
          on inp.noofinpat = pd.patient_id
       where (rd.islock IN (v_status) or rd.islock is null)

         and (id.diagnosis_code = v_outdiag or v_outdiag = '' or
             v_outdiag is null)
            \* or (idd.diagnosis_code = v_outdiag or v_outdiag='' or v_outdiag is null))*\
            -- by cyq 2012-12-07
         and id.diagnosis_type_id in ('7', '8')
            --and (id.diagnosis_type_id in ('7','8') or id.diagnosis_type_id = '' or id.diagnosis_type_id is null)
         and (pd.diag_code = v_curdiag or v_curdiag = '' or
             v_curdiag is null)
         and (inp.OutHosDept = v_deptid or v_deptid = '0000' or
             v_deptid = '' or v_deptid is null)
         and (inp.admitdiagnosis = v_indiag or v_indiag = '' or
             v_indiag is null)
       order by InHosDay;*/
  END;

  PROCEDURE usp_getrecordnoonfileWyt(v_dateOutHosBegin VARCHAR, --出院开始日期
                                     v_dateOutHosEnd   VARCHAR, --出院结束日期
                                     v_dateInHosBegin  VARCHAR, --入院开始日期
                                     v_dateInHosEnd    VARCHAR, --入院截止日期
                                     v_deptid          VARCHAR, --科室代码
                                     v_indiag          VARCHAR, --入院诊断
                                     v_outdiag         VARCHAR, --出院诊断
                                     v_status          VARCHAR, --病历状态
                                     v_patientname     VARCHAR DEFAULT '', --病人姓名
                                     v_patientid       VARCHAR DEFAULT '', --病人ID
                                     v_recordid        VARCHAR DEFAULT '', --病历号
                                     v_physician       VARCHAR DEFAULT '', --住院医师代码
                                     o_result          OUT empcurtyp) AS
  BEGIN
    --获取未归档病历

    OPEN o_result FOR

      select distinct rd.islock,
                      inp.*,
                      dept.Name as OutHosDeptName,
                      dd.Name as SexName,
                      d.Name as DiagnosisName,
                      case
                        when cd.Name is null then
                         '未归档'
                        when cd.Name = '' then
                         '未归档'
                        else
                         cd.Name
                      end LockInfoName,
                      datediff('yy',
                               inp.Birth,
                               to_char(sysdate, 'yyyy-mm-dd')) as InpAgeNum,
                      datediff('dd',
                               inp.AdmitDate,
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd'))) + 1 as InHosDay,
                      datediff('dd',
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd')),
                               to_char(sysdate, 'yyyy-mm-dd')) as OutHosDay,
                      case
                        when (SELECT count(NoOfInpat)
                                FROM MedicalRecord
                               where MedicalRecord.NoOfInpat = inp.NoOfInpat) > 0 then
                         '已经治'
                        else
                         '未经治'
                      end as StatusName,
                      us3.Name as ResidentName,
                      us1.Name as AttendName,
                      us2.Name as ChiefName,
                      b.ID AS BedID,
                      b.WardId as WardId

        from InPatient inp
        left join Department dept
          on dept.ID = inp.OutHosDept
        left join Dictionary_detail dd
          on dd.CategoryID = '3'
         and dd.DetailID = inp.SexID
        left join Diagnosis d
          on d.ICD = inp.OutDiagnosis
        left join recorddetail rd
          on rd.noofinpat = inp.NoOfInpat
         and rd.valid = 1 ---add by cyq 2013-05-06
        left join CategoryDetail cd
          on cd.CategoryID = '47'
         and cd.ID = rd.islock
        left join Bed b
          ON inp.NoOfInpat = b.NoOfInpat
        left join Users us1
          on us1.ID = inp.Attend
        left join Users us2
          on us2.ID = inp.Chief
        left join Users us3
          on us3.ID = inp.Resident

       where 1 = 1
            --edit by cyq 2012-12-07
            --and to_date(substr(nvl(trim(inp.OutWardDate), '1990-01-01'), 1, 10),'yyyy-mm-dd') >= to_date(v_dateOutHosBegin, 'yyyy-mm-dd')
            --and to_date(substr(nvl(trim(inp.OutWardDate), '1990-01-01'), 1, 10),'yyyy-mm-dd') < to_date(v_dateOutHosEnd, 'yyyy-mm-dd')
            --and to_date(substr(nvl(trim(inp.inwarddate), '1990-01-01'), 1, 10),'yyyy-mm-dd') >= to_date(v_dateInHosBegin, 'yyyy-mm-dd')
            --and to_date(substr(nvl(trim(inp.inwarddate), '1990-01-01'), 1, 10),'yyyy-mm-dd') < to_date(v_dateInHosEnd, 'yyyy-mm-dd')
         and to_date(nvl(trim(inp.OutWardDate), '1990-01-01 00:00:00'),
                     'yyyy-MM-dd hh24:mi:ss') >=
             to_date(v_dateOutHosBegin || ' 00:00:00',
                     'yyyy-MM-dd hh24:mi:ss')
         and to_date(nvl(trim(inp.OutWardDate), '1990-01-01 00:00:00'),
                     'yyyy-MM-dd hh24:mi:ss') <=
             to_date(v_dateOutHosEnd || ' 23:59:59',
                     'yyyy-MM-dd hh24:mi:ss')
         and to_date(nvl(trim(inp.inwarddate), '1990-01-01 00:00:00'),
                     'yyyy-MM-dd hh24:mi:ss') >=
             to_date(v_dateInHosBegin || ' 00:00:00',
                     'yyyy-MM-dd hh24:mi:ss')
         and to_date(nvl(trim(inp.inwarddate), '1990-01-01 00:00:00'),
                     'yyyy-MM-dd hh24:mi:ss') <=
             to_date(v_dateInHosEnd || ' 23:59:59', 'yyyy-MM-dd hh24:mi:ss')

         and trim(inp.OutWardDate) is not null
         and trim(inp.inwarddate) is not null
         and (inp.admitdiagnosis = v_indiag or v_indiag = '' or
             v_indiag is null)
         and (inp.outdiagnosis = v_outdiag or v_outdiag = '' or
             v_outdiag is null)
         and inp.Status in ('1502', '1503')
         and (inp.OutHosDept = v_deptid or v_deptid = '0000')
         and (rd.islock IN (v_status) or rd.islock is null) --edit by cyq 2012-12-04
         and inp.Name like '%' || v_patientname || '%' --edit by cyq 2012-12-04
            --and (inp.Name = v_patientname or v_patientname = '' or v_patientname is null)
         and (inp.noofinpat = v_patientid or v_patientid = '' or
             v_patientid is null)
         and inp.NoOfRecord like '%' || v_recordid || '%' --edit by cyq 2012-12-04
         and (inp.resident = v_physician or v_physician = '' or
             v_physician is null)
       order by OutWardDate;

  END;

  /*********************************************************************************/
  PROCEDURE usp_getrecordnoonfile(v_datebegin   VARCHAR, --开始日期
                                  v_dateend     VARCHAR, --结束日期
                                  v_deptid      VARCHAR, --科室代码
                                  v_status      VARCHAR, --病历状态
                                  v_patientname VARCHAR DEFAULT '', --病人姓名
                                  v_recordid    VARCHAR DEFAULT '', --病历号
                                  o_result      OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取未归档病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例
     exec usp_GetRecordNoOnFileNew v_DateBegin='2011-04-01',v_DateEnd='2011-04-26',v_DeptID='0000',v_Status='4700,4702,4703'

     修改记录
    **********/

  BEGIN
    --获取未归档病历

    OPEN o_result FOR

      select distinct rd.islock,
                      inp.*,
                      dept.Name as OutHosDeptName,
                      dd.Name as SexName,
                      d.Name as DiagnosisName,
                      case
                        when cd.Name is null then
                         '未归档'
                        when cd.Name = '' then
                         '未归档'
                        else
                         cd.Name
                      end LockInfoName,
                      datediff('yy',
                               inp.Birth,
                               to_char(sysdate, 'yyyy-mm-dd')) as InpAgeNum,
                      datediff('dd',
                               inp.AdmitDate,
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd'))) + 1 as InHosDay,
                      datediff('dd',
                               nvl(trim(inp.OutWardDate),
                                   to_char(sysdate, 'yyyy-mm-dd')),
                               to_char(sysdate, 'yyyy-mm-dd')) as OutHosDay,
                      case
                        when (SELECT count(NoOfInpat)
                                FROM MedicalRecord
                               where MedicalRecord.NoOfInpat = inp.NoOfInpat) > 0 then
                         '已经治'
                        else
                         '未经治'
                      end as StatusName,
                      us3.Name as ResidentName,
                      us1.Name as AttendName,
                      us2.Name as ChiefName,
                      --mr.ID as RecordID,
                      b.ID     AS BedID,
                      b.WardId as WardId

        from InPatient inp
        left join Department dept
          on dept.ID = inp.OutHosDept
        left join Dictionary_detail dd
          on dd.CategoryID = '3'
         and dd.DetailID = inp.SexID
        left join Diagnosis d
          on d.ICD = inp.OutDiagnosis
        left join recorddetail rd
          on rd.noofinpat = inp.NoOfInpat
        left join CategoryDetail cd
          on cd.CategoryID = '47'
         and cd.ID = rd.islock
        left join Bed b
          ON inp.NoOfInpat = b.NoOfInpat
        left join Users us1
          on us1.ID = inp.Attend
        left join Users us2
          on us2.ID = inp.Chief
        left join Users us3
          on us3.ID = inp.Resident

       where to_date(substr(nvl(trim(inp.OutWardDate), '1990-01-01'), 1, 10),
                     'yyyy-mm-dd') >= to_date(v_datebegin, 'yyyy-mm-dd')
         and to_date(substr(nvl(trim(inp.OutWardDate), '1990-01-01'), 1, 10),
                     'yyyy-mm-dd') < to_date(v_dateend, 'yyyy-mm-dd')
         and trim(inp.OutWardDate) is not null
         and inp.Status in ('1502', '1503')
         and (inp.OutHosDept = v_deptid or v_deptid = '0000')
         and (rd.islock IN (v_status) or rd.islock is null)
         and (inp.Name = v_patientname or v_patientname = '' or
              v_patientname is null)
         and (inp.NoOfRecord = v_recordid or v_recordid = '' or
              v_recordid is null)
       order by OutWardDate;

  END;

  /*********************************************************************************/
  PROCEDURE usp_getrecordnoonfilenew(v_datebegin   VARCHAR, --开始日期
                                     v_dateend     VARCHAR, --结束日期
                                     v_deptid      VARCHAR, --科室代码
                                     v_status      VARCHAR, --病历状态
                                     v_patientname VARCHAR DEFAULT '', --病人姓名
                                     v_recordid    VARCHAR DEFAULT '', --病历号
                                     o_result      OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取未归档病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例
     exec usp_GetRecordNoOnFileNew v_DateBegin='2011-04-01',v_DateEnd='2011-04-26',v_DeptID='0000',v_Status='4700,4703'

     修改记录
    **********/
    v_sql VARCHAR(4000);
  BEGIN
    --获取未归档病历
    v_sql := 'select mr.LockInfo,inp.*,dept.Name as OutHosDeptName,dd.Name as SexName
      ,d.Name as DiagnosisName,cd.Name as LockInfoName
      ,datediff(yy,inp.Birth,to_char(sysdate,''yyyy-mm-dd'')) as InpAgeNum
      ,datediff(dd,inp.AdmitDate,nvl(trim(inp.OutWardDate),to_char(sysdate,''yyyy-mm-dd'')))+1 as InHosDay
      ,datediff(dd,inp.OutWardDate,to_char(sysdate,''yyyy-mm-dd'')) as OutHosDay
      ,case when (SELECT count(NoOfInpat)  FROM MedicalRecord where MedicalRecord.NoOfInpat = inp.NoOfInpat)>0
      then ''已经治'' else ''未经治'' end as StatusName
      ,us3.Name as ResidentName,us1.Name as AttendName,us2.Name as ChiefName
      ,mr.ID as RecordID,b.ID  AS BedID,b.WardId as WardId
  from InPatient inp
    left join  Department dept on dept.ID=inp.OutHosDept
    left join  Dictionary_detail dd on dd.CategoryID=''3'' and dd.DetailID=inp.SexID
    left join  Diagnosis d on d.ICD=inp.OutDiagnosis
    left join  MedicalRecord mr on mr.NoOfInpat=inp.NoOfInpat
    left join  CategoryDetail cd on cd.CategoryID=''47'' and cd.ID=mr.LockInfo
    left join  Bed b ON inp.NoOfInpat = b.NoOfInpat
    left join Users us1 on us1.ID=inp.Attend
    left join Users us2 on us2.ID=inp.Chief
    left join Users us3 on us3.ID=inp.Resident
  where inp.OutWardDate>= ''' || v_datebegin || ' 00:00:00''' || '
        and inp.OutWardDate<''' || v_dateend || ' 24:00:00''' || '
        and inp.Status in(''1502'',''1503'')
        and (inp.OutHosDept=''' || v_deptid || ''' or ''' ||
             v_deptid || '''=''0000'')
        and  mr.LockInfo in (' || v_status || ')
        and (inp.Name=''' || v_patientname || ''' or ''' ||
             v_patientname || '''=''''or ' || v_patientname ||
             ' is null)
        and (inp.NoOfRecord=''' || v_recordid || ''' or ''' ||
             v_recordid || '''='''' or ' || v_recordid ||
             ' is null)
  order by OutWardDate';

    OPEN o_result FOR v_sql;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getrecordonfile(v_datebegin  VARCHAR, --开始日期
                                v_dateend    VARCHAR, --结束日期
                                v_patid      VARCHAR DEFAULT '', --住院号码
                                v_name       VARCHAR DEFAULT '', --患者姓名
                                v_sexid      VARCHAR DEFAULT '', --病人性别
                                v_agebegin   VARCHAR DEFAULT '', --开始年龄
                                v_ageend     VARCHAR DEFAULT '', --结束年龄
                                v_outhosdept VARCHAR DEFAULT '', --出院科室科室
                                v_indiag     VARCHAR DEFAULT '', --入院诊断
                                v_outdiag    VARCHAR DEFAULT '', --出院诊断
                                v_surgeryid  VARCHAR DEFAULT '', --手术代码
                                v_physician  VARCHAR DEFAULT '', --住院医师代码
                                o_result     OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取已归档病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例

     exec usp_GetRecordOnFile v_DateBegin='2011-03-02'
         ,v_DateEnd='2011-03-10',v_PatID='',v_Name='',v_SexID=''
         ,v_AgeBegin='',v_AgeEnd='',v_OutHosDept='0000',v_OutDiagnosis=''
         ,v_SurgeryID=''
     修改记录
    **********/
  BEGIN
    --获取已归档病历
    OPEN o_result FOR
      SELECT DISTINCT inp.*,
                      dept.NAME AS outhosdeptname,
                      dd.NAME   AS sexname,
                      u1.NAME   AS residentname,
                      u2.NAME   AS attendname,
                      u3.NAME   AS chiefname,
                      inp.admitdiagnosis   AS indiagnosisname,
                      d2.NAME   AS outdiagnosisname,
                      --mr.lockdate
                      rd.islock
        FROM inpatient inp
        LEFT JOIN department dept
          ON dept.ID = inp.outhosdept
        LEFT JOIN dictionary_detail dd
          ON dd.categoryid = '3'
         AND dd.detailid = inp.sexid
        LEFT JOIN users u1
          ON u1.ID = inp.resident
        LEFT JOIN users u2
          ON u2.ID = inp.attend
        LEFT JOIN users u3
          ON u3.ID = inp.chief
        LEFT JOIN diagnosis d1
          ON d1.icd = inp.admitdiagnosis
        LEFT JOIN diagnosis d2
          ON d2.icd = inp.outdiagnosis
        LEFT JOIN recorddetail rd
          ON rd.noofinpat = inp.noofinpat
       WHERE 1 = 1
            --and inp.outwarddate >= v_datebegin || ' 00:00:00 ' --edit by cyq 2012-12-06
            --AND inp.outwarddate < v_dateend || ' 24:00:00 '  --edit by cyq 2012-12-06
            --AND (inp.patid = v_patid OR v_patid = '' OR v_patid IS NULL) --edit by cyq 2012-12-06
            --AND (inp.NAME = v_name OR v_name = '' OR v_name IS NULL) --edit by cyq 2012-12-06
         and TO_DATE(inp.outwarddate, 'yyyy-MM-dd hh24:mi:ss') >=
             TO_DATE(v_datebegin || ' 00:00:00', 'yyyy-MM-dd hh24:mi:ss')
         and TO_DATE(inp.outwarddate, 'yyyy-MM-dd hh24:mi:ss') <=
             TO_DATE(v_dateend || ' 23:59:59', 'yyyy-MM-dd hh24:mi:ss')
         and inp.patid like '%' || v_patid || '%'
         and inp.Name like '%' || v_name || '%'

         AND (inp.sexid = v_sexid OR v_sexid = '' OR v_sexid IS NULL)
         AND (datediff('yy',
                       inp.birth,
                       TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss')) - 1 >=
             v_agebegin OR v_agebegin is null)
         AND (datediff('yy',
                       inp.birth,
                       TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss')) - 1 <=
             v_ageend OR v_ageend is null)
         AND (inp.outhosdept = v_outhosdept OR v_outhosdept = '0000')
         AND (inp.admitdiagnosis = v_indiag OR v_indiag is null OR
             v_indiag = '')
         AND (inp.outdiagnosis = v_outdiag OR v_outdiag is null OR
             v_outdiag = '')
         AND inp.status IN ('1502', '1503')
         AND (inp.resident = v_physician OR v_physician is null or
             v_physician = '')
         AND rd.islock = '4701'
       ORDER BY outwarddate;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getsigninrecordnew(v_dateBegin   VARCHAR, --开始日期
                                   v_dateEnd     VARCHAR, --结束日期
                                   v_dateInBegin VARCHAR, --入院开始日期
                                   v_dateInEnd   VARCHAR, --入院结束日期
                                   v_patientName VARCHAR, --病人姓名
                                   v_outhosdept  VARCHAR, --出院科室科室
                                   o_result      OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取待签收归还病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例

     exec usp_GetSignInRecord v_DateBegin=N'2011-03-02',v_DateEnd=N'2011-03-09',v_OutHosDept=N'0000'

     修改记录
    **********/
  BEGIN
    --获取待签收归还病历
    OPEN o_result FOR
      SELECT DISTINCT ar.*,
                      u1.NAME        AS applydoctorname,
                      u2.NAME        AS auditmanname,
                      cd1.NAME       AS applyaimname,
                      cd2.NAME       AS unitname,
                      inp.noofrecord,
                      inp.incount,
                      inp.NAME,
                      inp.sexid, --add by cyq 2012-11-16
                      dd.NAME        AS inpsexname,
                      inp.agestr,
                      dept.NAME      AS outhosdeptname,
                      inp.patid,
                      inp.admitdate,
                      inp.outhosdate,
                      d.NAME         AS outdiagnosisname,
                      --s.NAME AS surgeryname,
                      inp.NAME      AS inpname,
                      inp.noofinpat
        FROM applyrecord ar
        LEFT JOIN inpatient inp
          ON inp.noofinpat = ar.noofinpat
        LEFT JOIN department dept
          ON dept.ID = inp.outhosdept
        LEFT JOIN users u1
          ON u1.ID = ar.applydoctor
        LEFT JOIN users u2
          ON u2.ID = ar.auditman
        LEFT JOIN categorydetail cd1
          ON cd1.categoryid = '50'
         AND cd1.ID = ar.applyaim
        LEFT JOIN categorydetail cd2
          ON cd2.categoryid = '51'
         AND cd2.ID = ar.unit
        LEFT JOIN dictionary_detail dd
          ON dd.categoryid = '3'
         AND dd.detailid = inp.sexid
        LEFT JOIN diagnosis d
          ON d.icd = inp.outdiagnosis
      --LEFT JOIN medicalrecord mr ON mr.noofinpat = inp.noofinpat
        LEFT JOIN recorddetail rd
          ON rd.noofinpat = inp.noofinpat
      --LEFT JOIN diseasecfg dc ON dc.ID = mr.disease
      --LEFT JOIN surgery s ON s.ID = dc.surgeryid
       WHERE ar.applydate >= v_datebegin || ' 00:00:00 '
         AND ar.applydate < v_dateend || ' 24:00:00'
         And to_date(substr(nvl(trim(inp.inwarddate), '1990-01-01'), 1, 10),
                     'yyyy-mm-dd') >= to_date(v_dateinbegin, 'yyyy-mm-dd')
         and to_date(substr(nvl(trim(inp.inwarddate), '1990-01-01'), 1, 10),
                     'yyyy-mm-dd') < to_date(v_dateinend, 'yyyy-mm-dd')
         AND (inp.outhosdept = v_outhosdept OR v_outhosdept = '0000')
         and (inp.Name = v_patientName or v_patientName = '' or
             v_patientName is null)
         AND ar.status = '5205'
       ORDER BY outhosdeptname;
  END;

  /*********************************************************************************/
  PROCEDURE usp_getsigninrecord(v_datebegin  VARCHAR, --开始日期
                                v_dateend    VARCHAR, --结束日期
                                v_outhosdept VARCHAR, --出院科室科室
                                o_result     OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取待签收归还病历
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例

     exec usp_GetSignInRecord v_DateBegin=N'2011-03-02',v_DateEnd=N'2011-03-09',v_OutHosDept=N'0000'

     修改记录
    **********/
  BEGIN
    --获取待签收归还病历
    OPEN o_result FOR
      SELECT DISTINCT ar.*,
                      u1.NAME        AS applydoctorname,
                      u2.NAME        AS auditmanname,
                      cd1.NAME       AS applyaimname,
                      cd2.NAME       AS unitname,
                      inp.noofrecord,
                      inp.incount,
                      inp.NAME,
                      dd.NAME        AS inpsexname,
                      inp.agestr,
                      dept.NAME      AS outhosdeptname,
                      inp.patid,
                      inp.admitdate,
                      inp.outhosdate,
                      d.NAME         AS outdiagnosisname,
                      --s.NAME AS surgeryname,
                      inp.NAME      AS inpname,
                      inp.noofinpat
        FROM applyrecord ar
        LEFT JOIN inpatient inp
          ON inp.noofinpat = ar.noofinpat
        LEFT JOIN department dept
          ON dept.ID = inp.outhosdept
        LEFT JOIN users u1
          ON u1.ID = ar.applydoctor
        LEFT JOIN users u2
          ON u2.ID = ar.auditman
        LEFT JOIN categorydetail cd1
          ON cd1.categoryid = '50'
         AND cd1.ID = ar.applyaim
        LEFT JOIN categorydetail cd2
          ON cd2.categoryid = '51'
         AND cd2.ID = ar.unit
        LEFT JOIN dictionary_detail dd
          ON dd.categoryid = '3'
         AND dd.detailid = inp.sexid
        LEFT JOIN diagnosis d
          ON d.icd = inp.outdiagnosis
      --LEFT JOIN medicalrecord mr ON mr.noofinpat = inp.noofinpat
        LEFT JOIN recorddetail rd
          ON rd.noofinpat = inp.noofinpat
      --LEFT JOIN diseasecfg dc ON dc.ID = mr.disease
      --LEFT JOIN surgery s ON s.ID = dc.surgeryid
       WHERE ar.applydate >= v_datebegin || ' 00:00:00 '
         AND ar.applydate < v_dateend || ' 24:00:00'
         AND (inp.outhosdept = v_outhosdept OR v_outhosdept = '0000')
         AND ar.status = '5205'
       ORDER BY outhosdeptname;
  END;

  /*********************************************************************************/
  PROCEDURE usp_gettemplatepersongroup(v_userid  VARCHAR DEFAULT '',
                                       o_result  OUT empcurtyp,
                                       o_result1 OUT empcurtyp) AS /**********
                                                                                         版本号  1.0.0.0.0
                                                                                         创建时间
                                                                                         作者
                                                                                         版权
                                                                                         描述  获取质量评分
                                                                                         功能说明
                                                                                         输入参数
                                                                                           v_NoOfInpat    numeric(9,0),     首页序号
                                                                                         v_NodeID       int,      节点ID
                                                                                         v_TemplateID   varchar(64),   模板ID
                                                                                         v_ParentNodeID int,      父节点ID
                                                                                         v_Name         varchar(64),   节点名称
                                                                                         v_UserID       varchar(18),     用户ID
                                                                                         v_TypeID       int       类别：判断是插入还是删除
                                                                                         输出参数
                                                                                         结果集、排序
                                                                                         质量控制统计数据集

                                                                                         调用的sp
                                                                                         调用实例
                                                                                         修改记录
                                                                                         **********/
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    OPEN o_result1 FOR
      SELECT '' FROM DUAL;

    OPEN o_result FOR
      SELECT t.ID,
             t.nodeid,
             t.parentnodeid,
             tsp.templateid AS templateid,
             t.templatepersonid,
             tsp.NAME,
             t.nodename,
             t.userid,
             tsp.sortid,
             tsp.memo
        FROM templatepersongroup t
        LEFT OUTER JOIN template_person tsp
          ON tsp.ID = t.templatepersonid
         AND tsp.valid = '1'
       WHERE t.userid = v_userid
       ORDER BY t.nodeid;

    OPEN o_result1 FOR
      SELECT ID, templateid, NAME, memo, '是' AS used, sortid
        FROM template_person
       WHERE userid = v_userid
            /*wwj*/ --and SortID <> '0000'
         AND valid = 1;
  END;
  /**********************************************************************************************/
  PROCEDURE usp_Inpatient_Trigger(v_syxh varchar2 --病人首页序号
                                  ) as

    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  修改病人基本信息表中数据时候，同步更新对应信息
     功能说明
     输入参数
     输出参数
     结果集、排序



     调用的sp
     调用实例
      exec usp_Inpatient_Trigger ''
     修改记录
    **********/
    v_csrq     varchar(19);
    v_ryrq     varchar(19);
    v_brnl     int;
    v_xsnl     varchar(19);
    v_InnerPIX varchar(24);
  begin
    if v_syxh is null then
      return;
    end if;
    ---更新年龄信息
    select inp.birth, inp.admitdate
      into v_csrq, v_ryrq
      from inpatient inp
     where inp.noofinpat = v_syxh
       and rownum = 1;

    EMRPROC.usp_EMR_GetAge(v_csrq, v_ryrq, v_brnl, v_xsnl);

    update InPatient
       set Age = v_brnl, AgeStr = v_xsnl
     where NoOfInpat = v_syxh;

    commit;

    -- 记录床位信息
    -- 找出病人床位或科室、病区信息有变化的病人

    -- 更新当前床位信息
    /*  update BedInfo set EndDate = to_char(sysdate,'yyyy-mm-dd HH24:mi:ss'), NewDept = b.OutHosDept, NewWard = b.OutHosWard, NewBed = b.OutBed, Mark = 0
    from BedInfo a, inpatient b
    where c.NoOfInpat = b.NoOfInpat
      and a.Mark = 1*/

    update BedInfo a
       set (EndDate, NewDept, NewWard, NewBed, Mark) =
           (select to_char(sysdate, 'yyyy-mm-dd HH24:mi:ss'),
                   b.OutHosDept,
                   b.OutHosWard,
                   b.OutBed,
                   0
              from inpatient b
             where a.noofinpat = b.NoOfInpat)
     where a.Mark = 1
       and exists
     (select 1 from inpatient b where a.noofinpat = b.NoOfInpat);

    -- 插入最新的床位信息记录
    insert into BedInfo
      (ID,
       NoOfInpat,
       FormerDeptID,
       FormerWard,
       FormerBedID,
       StartDate,
       Mark)
      select seq_bedinfo_id.nextval,
             a.NoOfInpat,
             a.OutHosDept,
             a.OutHosWard,
             a.OutBed,
             to_char(sysdate, 'yyyy-mm-dd HH24:mi:ss'),
             1
        from inpatient a
       where a.NoOfInpat = v_syxh;

    -- 处理关联病人

    -- 有社保卡号的，找出社保卡号相同的最小住院号
    select min(a.PatID)
      into v_InnerPIX
      from inpatient a
     where a.idno =
           (select b.idno from inpatient b where b.noofinpat = v_syxh);

    -- 更新关联的住院号码
    update InPatient a
       set InnerPIX = v_InnerPIX
     where a.NoOfInpat = v_syxh;

  end;

  /*********************************************************************************/
  PROCEDURE usp_insertimage(v_sort   INT,
                            v_name   VARCHAR,
                            v_memo   VARCHAR DEFAULT '',
                            v_id     NUMERIC DEFAULT 0,
                            o_result OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述
     功能说明  插入图片信息
     输入参数
    v_Sort int         --查询方式
    v_Name varchar(64)       --模板名称
    v_Content varchar(max)    --模板内容（需更改）
    v_Memo varchar(255)=''  --模板描述
    v_Image image         --模板内容
    v_ID numeric(12,0)=''       --模板ID

     输出参数
     结果集、排序
    图片管理器模板对图片信息进行保存更新

     调用的sp
     调用实例

     修改记录
    **********/

  BEGIN
    IF v_sort = 0 THEN
      INSERT into imagelibrary
        (id, name, memo, valid)
      VALUES
        (seq_imagelibrary_id.NEXTVAL, v_name, v_memo, 1);

      open o_result for
        select seq_imagelibrary_id.currval from dual;
    END IF;

    IF v_sort = 1 THEN
      UPDATE imagelibrary SET NAME = v_name, memo = v_memo WHERE ID = v_id;

      open o_result for
        select v_id from dual;
    END IF;

    IF v_sort = 2 THEN
      UPDATE imagelibrary SET NAME = v_name, memo = v_memo WHERE ID = v_id;

      open o_result for
        select v_id from dual;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_insertjob(v_id VARCHAR, v_title VARCHAR, v_memo VARCHAR) AS /**********
                                                                                                                版本号
                                                                                                                创建时间
                                                                                                                作者
                                                                                                                版权
                                                                                                                描述
                                                                                                                功能说明      插入岗位信息
                                                                                                                输出参数
                                                                                                                结果集、排序
                                                                                                                调用的sp
                                                                                                                调用实例
                                                                                                               **********/
  BEGIN
    INSERT INTO jobs (ID, title, memo) VALUES (v_id, v_title, v_memo);
  END;

  /*********************************************************************************/
  PROCEDURE usp_insertjobpermission(v_id         VARCHAR,
                                    v_moduleid   VARCHAR,
                                    v_modulename VARCHAR) AS /**********
                                                                                                            版本号
                                                                                                            创建时间
                                                                                                            作者
                                                                                                            版权
                                                                                                            描述
                                                                                                            功能说明      增加新的授权信息
                                                                                                            输出参数
                                                                                                            结果集、排序
                                                                                                            调用的sp
                                                                                                            调用实例
                                                                                                           **********/
  BEGIN
    INSERT INTO job2permission
      (ID, moduleid, modulename)
    VALUES
      (v_id, v_moduleid, v_modulename);
  END;

  /*********************************************************************************/
  PROCEDURE usp_insertnursrecordtable(v_noofinpat  NUMERIC, --首页序号(住院流水号)
                                      v_name       VARCHAR, --记录单名称（模板名称+日期+时间）
                                      v_content    BLOB, --数据内容
                                      v_templateid NUMERIC, --模板ID
                                      v_version    VARCHAR,
                                      --模板版本(自定义输入,默认为1.00.00,可以自增长最后1位)
                                      v_department VARCHAR, --病人所属科室代码
                                      v_sortid     NUMERIC, --模板分类代码
                                      v_valid      INT --有效记录(CategoryDetail.ID CategoryID = 0)
                                      ) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]2011-06-10
    [作者]hjh
    [版权]
    [描述]添加病人护理文档
    [功能说明]
    [输入参数]
    [输出参数]
    [结果集、排序]


    [调用的sp]
    [调用实例]

    [修改记录]
    **********/
  BEGIN
    --添加病人护理文档信息
    INSERT INTO nursrecordtable
      (noofinpat,
       templateid,
       content,
       department,
       VERSION,
       sortid,
       valid,
       NAME)
    VALUES
      (v_noofinpat,
       v_templateid,
       v_content,
       v_department,
       v_version,
       v_sortid,
       v_valid,
       v_name);
  END;

  /*********************************************************************************/
  PROCEDURE usp_insertnurstabletemplate(v_name     VARCHAR, --模板名称
                                        v_describe VARCHAR, --模板描述
                                        v_content  BLOB, --模板内容
                                        v_version  VARCHAR,
                                        --模板版本(自定义输入,默认为1.00.00,可以自增长最后1位)
                                        v_sortid VARCHAR, --模板分类代码
                                        v_valid  INT, --有效记录(CategoryDetail.ID CategoryID = 0)
                                        o_result OUT empcurtyp) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]2011-06-10
    [作者]hjh
    [版权]
    [描述]新增护理文档模板，并返回ID
    [功能说明]
    [输入参数]
    [输出参数]
    [结果集、排序]


    [调用的sp]
    [调用实例]

    [修改记录]
    **********/
  BEGIN
    --新增模板
    INSERT INTO template_table
      (ID, NAME, describe, content, VERSION, sortid, valid)
    VALUES
      (seq_template_table_id.NEXTVAL,
       v_name,
       v_describe,
       v_content,
       v_version,
       v_sortid,
       v_valid);

    --返回新增模板ID
    OPEN o_result FOR
      SELECT temp.ID
        FROM (SELECT ID FROM template_table WHERE valid = 1 ORDER BY ID DESC) temp
       WHERE ROWNUM < 1;
  END;

  /*********************************************************************************/
  PROCEDURE usp_inserttemplatepersongroup(v_userid             VARCHAR DEFAULT '',
                                          v_nodeid             INT DEFAULT 0,
                                          v_templatepersonid   INT DEFAULT 0,
                                          v_parentnodeid       INT DEFAULT 0,
                                          v_name               VARCHAR DEFAULT '',
                                          v_typeid             INT DEFAULT 0,
                                          v_templatepersonname VARCHAR DEFAULT '',
                                          v_templatepersonmemo VARCHAR DEFAULT '') AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量评分
     功能说明
     输入参数
        v_NoOfInpat    numeric(9,0),     首页序号
      v_NodeID       int,      节点ID
      v_TemplateID   varchar(64),   模板ID
      v_ParentNodeID int,      父节点ID
      v_Name         varchar(64),   节点名称
      v_UserID       varchar(18),     用户ID
      v_TypeID       int       类别：判断是插入还是删除
     输出参数
     结果集、排序
    质量控制统计数据集
     execute usp_InsertTemplatePersonGroup '00', 0, '', 0, '', 2
     调用的sp
     调用实例
     修改记录
    **********/
    v_maxnodeid           INT;
    v_maxtemplatepersonid INT;
  BEGIN
    IF v_typeid = 1 THEN
      INSERT INTO templatepersongroup
        (ID, userid, nodeid, parentnodeid, templatepersonid, nodename)
      VALUES
        (seq_templatepersongroup_id.NEXTVAL,
         v_userid,
         v_nodeid,
         v_parentnodeid,
         v_templatepersonid,
         v_name);
    END IF;

    IF v_typeid = 2 THEN
      DELETE FROM templatepersongroup WHERE userid = v_userid;
    END IF;

    IF v_typeid = 3 THEN
      UPDATE template_person
         SET NAME = v_templatepersonname, memo = v_templatepersonmemo
       WHERE userid = v_userid
         AND valid = '1'
         AND ID = v_templatepersonid;
    END IF;

    IF v_typeid = 4 THEN
      BEGIN
        SELECT NVL(MAX(tp.nodeid) + 1, 0)
          INTO v_maxnodeid
          FROM templatepersongroup tp
         WHERE tp.userid = v_userid;

        SELECT NVL(MAX(tp.ID), 0)
          INTO v_maxtemplatepersonid
          FROM template_person tp
         WHERE tp.userid = v_userid
           AND tp.valid = '1'
           AND tp.sortmark = '0'
           AND tp.sharedid = '0';

        INSERT INTO templatepersongroup
          (ID, userid, nodeid, parentnodeid, nodename, templatepersonid)
        VALUES
          (seq_templatepersongroup_id.NEXTVAL,
           v_userid,
           v_maxnodeid,
           v_parentnodeid,
           v_name,
           v_maxtemplatepersonid);
      END;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_insertuserlogin(v_id          VARCHAR,
                                v_moduleid    VARCHAR,
                                v_hostname    VARCHAR,
                                v_macaddr     VARCHAR,
                                v_client_ip   VARCHAR,
                                v_reason_id   VARCHAR,
                                v_create_user VARCHAR) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  用户登录相关修改
     功能说明
     输入参数
    v_ID varchar(4) NOT NULL,--模块登录者ID
    v_Module_id varchar(255) ,--模块名称
    v_MACADDR varchar(255) NOT NULL,--MAC地址
    v_HostName varchar(255) NOT NULL,--HostName
    v_Client_ip varchar(255) NOT NULL,--机器Ip地址
    v_Reason_id Varchar(1) ,--登录/登出 reason 0/null 正常，1强制
    v_Create_user varchar(4) NOT NULL --登录者ID
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例
     exec usp_InsertUserLogIn '00', '00', '00','00', '00', '00','00'
     修改记录
    **********/
  BEGIN
    INSERT INTO user_login
      (ID, module_id, hostname, macaddr, client_ip, reason_id, create_user)
    VALUES
      (v_id,
       v_moduleid,
       v_hostname,
       v_macaddr,
       v_client_ip,
       v_reason_id,
       v_create_user);
  END;

  /*********************************************************************************/
  PROCEDURE usp_insert_iem_mainpage_basic(v_patnoofhis               NUMERIC,
                                          v_noofinpat                NUMERIC,
                                          v_payid                    VARCHAR,
                                          v_socialcare               VARCHAR,
                                          v_incount                  INT,
                                          v_name                     VARCHAR,
                                          v_sexid                    VARCHAR,
                                          v_birth                    CHAR,
                                          v_marital                  VARCHAR,
                                          v_jobid                    VARCHAR,
                                          v_provinceid               VARCHAR,
                                          v_countyid                 VARCHAR,
                                          v_nationid                 VARCHAR,
                                          v_nationalityid            VARCHAR,
                                          v_idno                     VARCHAR,
                                          v_organization             VARCHAR,
                                          v_officeplace              VARCHAR,
                                          v_officetel                VARCHAR,
                                          v_officepost               VARCHAR,
                                          v_nativeaddress            VARCHAR,
                                          v_nativetel                VARCHAR,
                                          v_nativepost               VARCHAR,
                                          v_contactperson            VARCHAR,
                                          v_relationship             VARCHAR,
                                          v_contactaddress           VARCHAR,
                                          v_contacttel               VARCHAR,
                                          v_admitdate                VARCHAR,
                                          v_admitdept                VARCHAR,
                                          v_admitward                VARCHAR,
                                          v_days_before              NUMERIC,
                                          v_trans_date               VARCHAR,
                                          v_trans_admitdept          VARCHAR,
                                          v_trans_admitward          VARCHAR,
                                          v_trans_admitdept_again    VARCHAR,
                                          v_outwarddate              VARCHAR,
                                          v_outhosdept               VARCHAR,
                                          v_outhosward               VARCHAR,
                                          v_actual_days              NUMERIC,
                                          v_death_time               VARCHAR,
                                          v_death_reason             VARCHAR,
                                          v_admitinfo                VARCHAR,
                                          v_in_check_date            VARCHAR,
                                          v_pathology_diagnosis_name VARCHAR,
                                          v_pathology_observation_sn VARCHAR,
                                          v_ashes_diagnosis_name     VARCHAR,
                                          v_ashes_anatomise_sn       VARCHAR,
                                          v_allergic_drug            VARCHAR,
                                          v_hbsag                    NUMERIC,
                                          v_hcv_ab                   NUMERIC,
                                          v_hiv_ab                   NUMERIC,
                                          v_opd_ipd_id               NUMERIC,
                                          v_in_out_inpatinet_id      NUMERIC,
                                          v_before_after_or_id       NUMERIC,
                                          v_clinical_pathology_id    NUMERIC,
                                          v_pacs_pathology_id        NUMERIC,
                                          v_save_times               NUMERIC,
                                          v_success_times            NUMERIC,
                                          v_section_director         VARCHAR,
                                          v_director                 VARCHAR,
                                          v_vs_employee_code         VARCHAR,
                                          v_resident_employee_code   VARCHAR,
                                          v_refresh_employee_code    VARCHAR,
                                          v_master_interne           VARCHAR,
                                          v_interne                  VARCHAR,
                                          v_coding_user              VARCHAR,
                                          v_medical_quality_id       NUMERIC,
                                          v_quality_control_doctor   VARCHAR,
                                          v_quality_control_nurse    VARCHAR,
                                          v_quality_control_date     VARCHAR,
                                          v_xay_sn                   VARCHAR,
                                          v_ct_sn                    VARCHAR,
                                          v_mri_sn                   VARCHAR,
                                          v_dsa_sn                   VARCHAR,
                                          v_is_first_case            NUMERIC,
                                          v_is_following             NUMERIC,
                                          v_following_ending_date    VARCHAR,
                                          v_is_teaching_case         NUMERIC,
                                          v_blood_type_id            NUMERIC,
                                          v_rh                       NUMERIC,
                                          v_blood_reaction_id        NUMERIC,
                                          v_blood_rbc                NUMERIC,
                                          v_blood_plt                NUMERIC,
                                          v_blood_plasma             NUMERIC,
                                          v_blood_wb                 NUMERIC,
                                          v_blood_others             VARCHAR,
                                          v_is_completed             VARCHAR,
                                          v_completed_time           VARCHAR,
                                          --v_Valide numeric ,
                                          v_create_user VARCHAR,
                                          --v_Create_Time varchar(19)
                                          --v_Modified_User varchar(10) ,
                                          --v_Modified_Time varchar(19)
                                          o_result OUT empcurtyp) AS /**********
                                                                                                         版本号  1.0.0.0.0
                                                                                                         创建时间
                                                                                                         作者
                                                                                                         版权
                                                                                                         描述  插入功病案首页基本信息TABLE
                                                                                                         功能说明
                                                                                                         输入参数
                                                                                                         输出参数
                                                                                                         结果集、排序

                                                                                                         调用的sp
                                                                                                         调用实例

                                                                                                         修改记录
                                                                                                        **********/
  BEGIN
    INSERT INTO iem_mainpage_basicinfo
      (iem_mainpage_no,
       patnoofhis,
       noofinpat,
       payid,
       socialcare,
       incount,
       NAME,
       sexid,
       birth,
       marital,
       jobid,
       provinceid,
       countyid,
       nationid,
       nationalityid,
       idno,
       ORGANIZATION,
       officeplace,
       officetel,
       officepost,
       nativeaddress,
       nativetel,
       nativepost,
       contactperson,
       relationship,
       contactaddress,
       contacttel,
       admitdate,
       admitdept,
       admitward,
       days_before,
       trans_date,
       trans_admitdept,
       trans_admitward,
       trans_admitdept_again,
       outwarddate,
       outhosdept,
       outhosward,
       actual_days,
       death_time,
       death_reason,
       admitinfo,
       in_check_date,
       pathology_diagnosis_name,
       pathology_observation_sn,
       ashes_diagnosis_name,
       ashes_anatomise_sn,
       allergic_drug,
       hbsag,
       hcv_ab,
       hiv_ab,
       opd_ipd_id,
       in_out_inpatinet_id,
       before_after_or_id,
       clinical_pathology_id,
       pacs_pathology_id,
       save_times,
       success_times,
       section_director,
       director,
       vs_employee_code,
       resident_employee_code,
       refresh_employee_code,
       master_interne,
       interne,
       coding_user,
       medical_quality_id,
       quality_control_doctor,
       quality_control_nurse,
       quality_control_date,
       xay_sn,
       ct_sn,
       mri_sn,
       dsa_sn,
       is_first_case,
       is_following,
       following_ending_date,
       is_teaching_case,
       blood_type_id,
       rh,
       blood_reaction_id,
       blood_rbc,
       blood_plt,
       blood_plasma,
       blood_wb,
       blood_others,
       is_completed,
       completed_time,
       valide,
       create_user,
       create_time)
    VALUES
      (seq_iem_mainpage_basicinfo_id.NEXTVAL,
       v_patnoofhis,
       -- numeric
       v_noofinpat, -- numeric
       v_payid, -- varchar(4)
       v_socialcare, -- varchar(32)
       v_incount, -- int
       v_name,
       -- varchar(60)
       v_sexid, -- varchar(4)
       v_birth, -- char(10)
       v_marital, -- varchar(4)
       v_jobid, -- varchar(4)
       v_provinceid,
       -- varchar(10)
       v_countyid, -- varchar(10)
       v_nationid, -- varchar(4)
       v_nationalityid, -- varchar(4)
       v_idno,
       -- varchar(18)
       v_organization, -- varchar(64)
       v_officeplace, -- varchar(64)
       v_officetel, -- varchar(16)
       v_officepost,
       -- varchar(16)
       v_nativeaddress, -- varchar(64)
       v_nativetel, -- varchar(16)
       v_nativepost, -- varchar(16)
       v_contactperson, -- varchar(32)
       v_relationship, -- varchar(4)
       v_contactaddress,
       -- varchar(255)
       v_contacttel, -- varchar(16)
       v_admitdate, -- varchar(19)
       v_admitdept, -- varchar(12)
       v_admitward,
       -- varchar(12)
       v_days_before, -- numeric
       v_trans_date, -- varchar(19)
       v_trans_admitdept,
       -- varchar(12)
       v_trans_admitward, -- varchar(12)
       v_trans_admitdept_again, -- varchar(12)
       v_outwarddate, -- varchar(19)
       v_outhosdept, -- varchar(12)
       v_outhosward, -- varchar(12)
       v_actual_days,
       -- numeric
       v_death_time, -- varchar(19)
       v_death_reason, -- varchar(300)
       v_admitinfo, -- varchar(4)
       v_in_check_date, -- varchar(19)
       v_pathology_diagnosis_name, -- varchar(300)
       v_pathology_observation_sn, -- varchar(60)
       v_ashes_diagnosis_name,
       -- varchar(300)
       v_ashes_anatomise_sn, -- varchar(60)
       v_allergic_drug, -- varchar(300)
       v_hbsag, -- numeric
       v_hcv_ab,
       -- numeric
       v_hiv_ab, -- numeric
       v_opd_ipd_id, -- numeric
       v_in_out_inpatinet_id, -- numeric
       v_before_after_or_id, -- numeric
       v_clinical_pathology_id, -- numeric
       v_pacs_pathology_id, -- numeric
       v_save_times, -- numeric
       v_success_times,
       -- numeric
       v_section_director, -- varchar(20)
       v_director, -- varchar(20)
       v_vs_employee_code,
       -- varchar(20)
       v_resident_employee_code, -- varchar(20)
       v_refresh_employee_code,
       -- varchar(20)
       v_master_interne, -- varchar(20)
       v_interne, -- varchar(20)
       v_coding_user, -- varchar(20)
       v_medical_quality_id, -- numeric
       v_quality_control_doctor,
       -- varchar(20)
       v_quality_control_nurse, -- varchar(20)
       v_quality_control_date,
       -- varchar(19)
       v_xay_sn, -- varchar(300)
       v_ct_sn, -- varchar(300)
       v_mri_sn, -- varchar(300)
       v_dsa_sn, -- varchar(300)
       v_is_first_case,
       -- numeric
       v_is_following, -- numeric
       v_following_ending_date, -- varchar(19)
       v_is_teaching_case, -- numeric
       v_blood_type_id, -- numeric
       v_rh, -- numeric
       v_blood_reaction_id, -- numeric
       v_blood_rbc, -- numeric
       v_blood_plt, -- numeric
       v_blood_plasma, -- numeric
       v_blood_wb, -- numeric
       v_blood_others, -- varchar(60)
       v_is_completed, -- varchar(1)
       v_completed_time, -- varchar(19)
       1, -- numeric
       v_create_user,
       -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss') -- varchar(19)
       );

    OPEN o_result FOR
      SELECT seq_iem_mainpage_basicinfo_id.CURRVAL FROM DUAL;
  END;

  /*********************************************************************************/
  PROCEDURE usp_insert_iem_mainpage_diag(v_iem_mainpage_no   NUMERIC,
                                         v_diagnosis_type_id NUMERIC,
                                         v_diagnosis_code    VARCHAR,
                                         v_diagnosis_name    VARCHAR,
                                         v_status_id         NUMERIC,
                                         v_order_value       NUMERIC,
                                         --v_Valide numeric ,
                                         v_create_user VARCHAR
                                         --v_Create_Time varchar(19) ,
                                         --v_Cancel_User varchar(10) ,
                                         --v_Cancel_Time varchar(19)
                                         ) AS /**********
                                                                                                             版本号  1.0.0.0.0
                                                                                                             创建时间
                                                                                                             作者
                                                                                                             版权
                                                                                                             描述  插入功病案首页诊断TABLE
                                                                                                             功能说明
                                                                                                             输入参数
                                                                                                             输出参数
                                                                                                             结果集、排序

                                                                                                             调用的sp
                                                                                                             调用实例

                                                                                                             修改记录
                                                                                                            **********/
  BEGIN
    INSERT INTO iem_mainpage_diagnosis
      (iem_mainpage_no,
       diagnosis_type_id,
       diagnosis_code,
       diagnosis_name,
       status_id,
       order_value,
       valide,
       create_user,
       create_time)
    VALUES
      (v_iem_mainpage_no, -- Iem_Mainpage_NO - numeric
       v_diagnosis_type_id,
       -- Diagnosis_Type_Id - numeric
       v_diagnosis_code,
       -- Diagnosis_Code - varchar(60)
       v_diagnosis_name, -- Diagnosis_Name - varchar(300)
       v_status_id, -- Status_Id - numeric
       v_order_value,
       -- Order_Value - numeric
       1,
       -- Valide - numeric
       v_create_user, -- Create_User - varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss')
       -- Create_Time - varchar(19)
       );
  END;

  /*********************************************************************************/
  PROCEDURE usp_insert_iem_mainpage_oper(v_iem_mainpage_no     NUMERIC,
                                         v_operation_code      VARCHAR,
                                         v_operation_date      VARCHAR,
                                         v_operation_name      VARCHAR,
                                         v_execute_user1       VARCHAR,
                                         v_execute_user2       VARCHAR,
                                         v_execute_user3       VARCHAR,
                                         v_anaesthesia_type_id NUMERIC,
                                         v_close_level         NUMERIC,
                                         v_anaesthesia_user    VARCHAR,
                                         --v_Valide numeric ,
                                         v_create_user VARCHAR
                                         --v_Create_Time varchar(19)
                                         --v_Cancel_User varchar(10) ,
                                         --v_Cancel_Time varchar(19)
                                         ) AS /**********
                                                                                                             版本号  1.0.0.0.0
                                                                                                             创建时间
                                                                                                             作者
                                                                                                             版权
                                                                                                             描述  插入功病案首页手术TABLE
                                                                                                             功能说明
                                                                                                             输入参数
                                                                                                             输出参数
                                                                                                             结果集、排序

                                                                                                             调用的sp
                                                                                                             调用实例

                                                                                                             修改记录
                                                                                                            **********/
  BEGIN
    INSERT INTO iem_mainpage_operation
      (iem_mainpage_no,
       operation_code,
       operation_date,
       operation_name,
       execute_user1,
       execute_user2,
       execute_user3,
       anaesthesia_type_id,
       close_level,
       anaesthesia_user,
       valide,
       create_user,
       create_time)
    VALUES
      (v_iem_mainpage_no, --numeric
       v_operation_code, -- varchar(60)
       v_operation_date,
       -- varchar(19)
       v_operation_name, -- varchar(300)
       v_execute_user1, -- varchar(20)
       v_execute_user2,
       -- varchar(20)
       v_execute_user3, -- varchar(20)
       v_anaesthesia_type_id, -- numeric
       v_close_level,
       -- numeric
       v_anaesthesia_user, -- varchar(20)
       1, -- numeric
       v_create_user, -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'));
  END;

  /*********************************************************************************/
  /*输出更新某个病人的当前诊断信息(wyt 2012-08-13)*/
  PROCEDURE usp_updatecurrentdiaginfo(v_patient_id   VARCHAR2,
                                      v_patient_name VARCHAR2,
                                      v_diag_code    VARCHAR2,
                                      v_diag_content varchar2) AS
    v_tip VARCHAR(30);
  BEGIN
    -- select sysdate into v_tip  from dual;--为了保证运行正常，先注释
    DELETE CurrentDiag WHERE diag_code = v_diag_code;
    INSERT INTO CurrentDiag
      (patient_id, patient_name, diag_code, diag_content)
    values
      (v_patient_id, v_patient_name, v_diag_code, v_diag_content);
  END;

  /*********************************************************************************/
  /*输出更新某个诊断医师病种查看权限信息(wyt 2012-08-13)*/
  PROCEDURE usp_updateattendphysicianinfo(v_id            VARCHAR2,
                                          v_name          VARCHAR2,
                                          v_py            VARCHAR2,
                                          v_wb            VARCHAR2,
                                          v_deptid        VARCHAR2,
                                          v_relatedisease varchar2) AS
    v_tip VARCHAR(30);
  BEGIN
    --select sysdate into v_tip  from dual;--为了保证运行正常，先注释
    DELETE AttendingPhysician WHERE id = v_id;
    INSERT INTO AttendingPhysician
      (id, name, py, wb, deptid, relatedisease)
    values
      (v_id, v_name, v_py, v_wb, v_deptid, v_relatedisease);
  END;

  /*********************************************************************************/
  /*输出更新某个员工信息*/
  PROCEDURE usp_updateuserinfo(v_id           VARCHAR2,
                               v_name         VARCHAR2,
                               v_deptid       VARCHAR2,
                               v_wardid       VARCHAR2,
                               v_jobid        VARCHAR2,
                               v_Py           VARCHAR2,
                               v_Wb           VARCHAR2,
                               v_Sexy         VARCHAR2,
                               v_Birth        VARCHAR2,
                               v_Marital      VARCHAR2,
                               v_Idno         VARCHAR2,
                               v_Category     VARCHAR2,
                               v_Jobtitle     VARCHAR2,
                               v_Recipeid     VARCHAR2,
                               v_Recipemark   VARCHAR2,
                               v_Narcosismark VARCHAR2,
                               v_Grade        VARCHAR2,
                               v_Status       VARCHAR2,
                               v_Memo         varchar2

                               ) AS
  BEGIN
    UPDATE users
       SET NAME   = v_name,
           deptid = v_deptid,
           wardid = v_wardid,
           jobid  = v_jobid,

           Py           = v_Py,
           Wb           = v_Wb,
           Sexy         = v_Sexy,
           Birth        = v_Birth,
           Marital      = v_Marital,
           Idno         = v_Idno,
           Category     = v_Category,
           Jobtitle     = v_Jobtitle,
           Recipeid     = v_Recipeid,
           Recipemark   = v_Recipemark,
           Narcosismark = v_Narcosismark,
           Grade        = v_Grade,
           Status       = v_Status,
           memo         = v_Memo
     WHERE ID = v_id;
  END;

  /***************************************************************************************/
  /*修改岗位信息*/
  PROCEDURE usp_updatejobinfo(v_id    VARCHAR2,
                              v_title VARCHAR2,
                              v_memo  VARCHAR2) AS
  BEGIN
    UPDATE jobs SET title = v_title, memo = v_memo WHERE ID = v_id;
  END;

  /*****************************************************************************/
  PROCEDURE usp_updatenursrecordtable(v_id        NUMERIC, --记录ID
                                      v_noofinpat NUMERIC, --首页序号(住院流水号)
                                      v_content   BLOB --表单内容
                                      ) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]2011-06-10
    [作者]hjh
    [版权]
    [描述]更新病人护理文档
    [功能说明]
    [输入参数]
    [输出参数]
    [结果集、排序]


    [调用的sp]
    [调用实例]

    [修改记录]
    **********/
  BEGIN
    --更新病人护理文档信息
    UPDATE nursrecordtable
       SET content = v_content
     WHERE valid = 1
       AND ID = v_id
       AND noofinpat = v_noofinpat;
  END;

  /***************************************************************************************/
  PROCEDURE usp_updatenurstabletemplate(v_id       NUMERIC, --模板代码
                                        v_name     VARCHAR, --模板名称
                                        v_describe VARCHAR, --模板描述
                                        v_content  BLOB, --模板内容
                                        v_version  VARCHAR,
                                        --模板版本(自定义输入,默认为1.00.00,可以自增长最后1位)
                                        v_sortid VARCHAR --模板分类代码
                                        ) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]2011-06-10
    [作者]hjh
    [版权]
    [描述]更新护理文档模板
    [功能说明]
    [输入参数]
    [输出参数]
    [结果集、排序]


    [调用的sp]
    [调用实例]

    [修改记录]
    **********/
  BEGIN
    --更新模板
    UPDATE template_table
       SET NAME     = v_name,
           describe = v_describe,
           content  = v_content,
           VERSION  = v_version,
           sortid   = v_sortid
     WHERE ID = v_id;
  END;

  /***************************************************************************************/

  /*更新到期的借阅病历*/
  PROCEDURE usp_updatedueapplyrecord(v_applydoctor VARCHAR2 --申请医师代码
                                     ) AS
    v_currdatetime VARCHAR2(20);
  BEGIN
    v_currdatetime := TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss');

    UPDATE applyrecord
       SET status = '5205'
     WHERE (applydoctor = v_applydoctor OR v_applydoctor = '' OR
           v_applydoctor IS NULL)
       AND status = '5202'
       AND ((unit = '5101' AND
           datediff('mi', auditdate, v_currdatetime) >= duetime * 60) --小时
           OR (unit = '5102' AND
           datediff('hh', auditdate, v_currdatetime) >= duetime * 24) --天
           OR (unit = '5103' AND
           datediff('dd', auditdate, v_currdatetime) / 7 >= duetime) --周
           OR (unit = '5104' AND
           datediff('dd', auditdate, v_currdatetime) >= duetime * 30) --月
           OR (unit = '5105' AND
           datediff('dd', auditdate, v_currdatetime) >= duetime * 360) --年
           );
  END;

  /***************************************************************************************/
  /*更新功病案首页手术TABLE*/
  PROCEDURE usp_update_iem_mainpage_oper(v_iem_mainpage_no NUMERIC,
                                         v_cancel_user     VARCHAR) AS
  BEGIN
    UPDATE iem_mainpage_operation
       SET valide      = 0,
           cancel_user = v_cancel_user,
           cancel_time = TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss')
     WHERE iem_mainpage_no = v_iem_mainpage_no
       AND valide = 1;
  END;

  /***************************************************************************************/
  /*更新病案首页诊断TABLE,在插入之前调用*/
  PROCEDURE usp_update_iem_mainpage_diag(v_iem_mainpage_no NUMERIC,
                                         v_cancel_user     VARCHAR2) AS
  BEGIN
    UPDATE iem_mainpage_diagnosis
       SET cancel_user = v_cancel_user,
           valide      = 0,
           cancel_time = TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss')
     WHERE iem_mainpage_no = v_iem_mainpage_no
       AND valide = 1;
  END;

  /***************************************************************************************/
  /*更新功病案首页基本信息TABLE*/
  PROCEDURE usp_update_iem_mainpage_basic(v_iem_mainpage_no          NUMERIC,
                                          v_patnoofhis               NUMERIC,
                                          v_noofinpat                NUMERIC,
                                          v_payid                    VARCHAR,
                                          v_socialcare               VARCHAR,
                                          v_incount                  INT,
                                          v_name                     VARCHAR,
                                          v_sexid                    VARCHAR,
                                          v_birth                    CHAR,
                                          v_marital                  VARCHAR,
                                          v_jobid                    VARCHAR,
                                          v_provinceid               VARCHAR,
                                          v_countyid                 VARCHAR,
                                          v_nationid                 VARCHAR,
                                          v_nationalityid            VARCHAR,
                                          v_idno                     VARCHAR,
                                          v_organization             VARCHAR,
                                          v_officeplace              VARCHAR,
                                          v_officetel                VARCHAR,
                                          v_officepost               VARCHAR,
                                          v_nativeaddress            VARCHAR,
                                          v_nativetel                VARCHAR,
                                          v_nativepost               VARCHAR,
                                          v_contactperson            VARCHAR,
                                          v_relationship             VARCHAR,
                                          v_contactaddress           VARCHAR,
                                          v_contacttel               VARCHAR,
                                          v_admitdate                VARCHAR,
                                          v_admitdept                VARCHAR,
                                          v_admitward                VARCHAR,
                                          v_days_before              NUMERIC,
                                          v_trans_date               VARCHAR,
                                          v_trans_admitdept          VARCHAR,
                                          v_trans_admitward          VARCHAR,
                                          v_trans_admitdept_again    VARCHAR,
                                          v_outwarddate              VARCHAR,
                                          v_outhosdept               VARCHAR,
                                          v_outhosward               VARCHAR,
                                          v_actual_days              NUMERIC,
                                          v_death_time               VARCHAR,
                                          v_death_reason             VARCHAR,
                                          v_admitinfo                VARCHAR,
                                          v_in_check_date            VARCHAR,
                                          v_pathology_diagnosis_name VARCHAR,
                                          v_pathology_observation_sn VARCHAR,
                                          v_ashes_diagnosis_name     VARCHAR,
                                          v_ashes_anatomise_sn       VARCHAR,
                                          v_allergic_drug            VARCHAR,
                                          v_hbsag                    NUMERIC,
                                          v_hcv_ab                   NUMERIC,
                                          v_hiv_ab                   NUMERIC,
                                          v_opd_ipd_id               NUMERIC,
                                          v_in_out_inpatinet_id      NUMERIC,
                                          v_before_after_or_id       NUMERIC,
                                          v_clinical_pathology_id    NUMERIC,
                                          v_pacs_pathology_id        NUMERIC,
                                          v_save_times               NUMERIC,
                                          v_success_times            NUMERIC,
                                          v_section_director         VARCHAR,
                                          v_director                 VARCHAR,
                                          v_vs_employee_code         VARCHAR,
                                          v_resident_employee_code   VARCHAR,
                                          v_refresh_employee_code    VARCHAR,
                                          v_master_interne           VARCHAR,
                                          v_interne                  VARCHAR,
                                          v_coding_user              VARCHAR,
                                          v_medical_quality_id       NUMERIC,
                                          v_quality_control_doctor   VARCHAR,
                                          v_quality_control_nurse    VARCHAR,
                                          v_quality_control_date     VARCHAR,
                                          v_xay_sn                   VARCHAR,
                                          v_ct_sn                    VARCHAR,
                                          v_mri_sn                   VARCHAR,
                                          v_dsa_sn                   VARCHAR,
                                          v_is_first_case            NUMERIC,
                                          v_is_following             NUMERIC,
                                          v_following_ending_date    VARCHAR,
                                          v_is_teaching_case         NUMERIC,
                                          v_blood_type_id            NUMERIC,
                                          v_rh                       NUMERIC,
                                          v_blood_reaction_id        NUMERIC,
                                          v_blood_rbc                NUMERIC,
                                          v_blood_plt                NUMERIC,
                                          v_blood_plasma             NUMERIC,
                                          v_blood_wb                 NUMERIC,
                                          v_blood_others             VARCHAR,
                                          v_is_completed             VARCHAR,
                                          v_completed_time           VARCHAR,
                                          v_modified_user            VARCHAR) AS
  BEGIN
    UPDATE iem_mainpage_basicinfo
       SET patnoofhis               = v_patnoofhis,
           noofinpat                = v_noofinpat,
           payid                    = v_payid,
           socialcare               = v_socialcare,
           incount                  = v_incount,
           NAME                     = v_name,
           sexid                    = v_sexid,
           birth                    = v_birth,
           marital                  = v_marital,
           jobid                    = v_jobid,
           provinceid               = v_provinceid,
           countyid                 = v_countyid,
           nationid                 = v_nationid,
           nationalityid            = v_nationalityid,
           idno                     = v_idno,
           ORGANIZATION             = v_organization,
           officeplace              = v_officeplace,
           officetel                = v_officetel,
           officepost               = v_officepost,
           nativeaddress            = v_nativeaddress,
           nativetel                = v_nativetel,
           nativepost               = v_nativepost,
           contactperson            = v_contactperson,
           relationship             = v_relationship,
           contactaddress           = v_contactaddress,
           contacttel               = v_contacttel,
           admitdate                = v_admitdate,
           admitdept                = v_admitdept,
           admitward                = v_admitward,
           days_before              = v_days_before,
           trans_date               = v_trans_date,
           trans_admitdept          = v_trans_admitdept,
           trans_admitward          = v_trans_admitward,
           trans_admitdept_again    = v_trans_admitdept_again,
           outwarddate              = v_outwarddate,
           outhosdept               = v_outhosdept,
           outhosward               = v_outhosward,
           actual_days              = v_actual_days,
           death_time               = v_death_time,
           death_reason             = v_death_reason,
           admitinfo                = v_admitinfo,
           in_check_date            = v_in_check_date,
           pathology_diagnosis_name = v_pathology_diagnosis_name,
           pathology_observation_sn = v_pathology_observation_sn,
           ashes_diagnosis_name     = v_ashes_diagnosis_name,
           ashes_anatomise_sn       = v_ashes_anatomise_sn,
           allergic_drug            = v_allergic_drug,
           hbsag                    = v_hbsag,
           hcv_ab                   = v_hcv_ab,
           hiv_ab                   = v_hiv_ab,
           opd_ipd_id               = v_opd_ipd_id,
           in_out_inpatinet_id      = v_in_out_inpatinet_id,
           before_after_or_id       = v_before_after_or_id,
           clinical_pathology_id    = v_clinical_pathology_id,
           pacs_pathology_id        = v_pacs_pathology_id,
           save_times               = v_save_times,
           success_times            = v_success_times,
           section_director         = v_section_director,
           director                 = v_director,
           vs_employee_code         = v_vs_employee_code,
           resident_employee_code   = v_resident_employee_code,
           refresh_employee_code    = v_refresh_employee_code,
           master_interne           = v_master_interne,
           interne                  = v_interne,
           coding_user              = v_coding_user,
           medical_quality_id       = v_medical_quality_id,
           quality_control_doctor   = v_quality_control_doctor,
           quality_control_nurse    = v_quality_control_nurse,
           quality_control_date     = v_quality_control_date,
           xay_sn                   = v_xay_sn,
           ct_sn                    = v_ct_sn,
           mri_sn                   = v_mri_sn,
           dsa_sn                   = v_dsa_sn,
           is_first_case            = v_is_first_case,
           is_following             = v_is_following,
           following_ending_date    = v_following_ending_date,
           is_teaching_case         = v_is_teaching_case,
           blood_type_id            = v_blood_type_id,
           rh                       = v_rh,
           blood_reaction_id        = v_blood_reaction_id,
           blood_rbc                = v_blood_rbc,
           blood_plt                = v_blood_plt,
           blood_plasma             = v_blood_plasma,
           blood_wb                 = v_blood_wb,
           blood_others             = v_blood_others,
           is_completed             = v_is_completed,
           completed_time           = v_completed_time,
           modified_user            = v_modified_user,
           modified_time            = TO_CHAR(SYSDATE,
                                              'yyyy-mm-dd HH24:mi:ss')
     WHERE iem_mainpage_no = v_iem_mainpage_no
       AND valide = 1;
  END;

  /***************************************************************************************/
  /*更新病人就诊信息*/
  PROCEDURE usp_updatadiacrisisinfo(v_noofinpat      NUMERIC, --首页序号(住院流水号)(Inpatient.NoOfInpat)
                                    v_admitdiagnosis VARCHAR2 --入院诊断
                                    ) AS
  BEGIN
    --修改
    UPDATE inpatient
       SET admitdiagnosis = v_admitdiagnosis
     WHERE noofinpat = v_noofinpat;
  END;

  /***************************************************************************************/
  /*更新病人基本信息*/
  PROCEDURE usp_updatabasepatientinfo(v_noofinpat     NUMERIC, --首页序号(住院流水号)
                                      v_birth         VARCHAR, --出生日期
                                      v_marital       VARCHAR, --婚姻状况
                                      v_nationid      VARCHAR, --民族代码
                                      v_nationalityid VARCHAR, --国籍代码
                                      v_sexid         VARCHAR, --病人性别
                                      v_edu           VARCHAR, --文化程度
                                      v_provinceid    VARCHAR, --(出生地)省市代码
                                      v_countyid      VARCHAR, --(出生地)区县代码
                                      v_nativeplace_p VARCHAR, --籍贯省市代码
                                      v_nativeplace_c VARCHAR, --籍贯区县代码
                                      v_payid         VARCHAR, --病人性质
                                      v_age           INT, --病人年龄
                                      v_religion      VARCHAR, --宗教信仰
                                      v_educ          NUMERIC, --(受)教育年限(单位:年)
                                      v_idno          VARCHAR, --身份证号
                                      v_jobid         VARCHAR, --职业代码
                                      v_organization  VARCHAR, --工作单位(暂缺)
                                      v_officeplace   VARCHAR,
                                      --单位地址
                                      v_officepost    VARCHAR, --单位邮编
                                      v_officetel     VARCHAR, --单位电话
                                      v_nativeaddress VARCHAR, --户口地址
                                      v_nativetel     VARCHAR, --户口电话
                                      v_nativepost    VARCHAR, --户口邮编
                                      v_address       VARCHAR --当前地址
                                      ) AS
  BEGIN
    --修改
    UPDATE inpatient
       SET birth         = v_birth,
           marital       = v_marital,
           nationid      = v_nationid,
           nationalityid = v_nationalityid,
           sexid         = v_sexid,
           edu           = v_edu,
           provinceid    = v_provinceid,
           countyid      = v_countyid,
           nativeplace_p = v_nativeplace_p,
           nativeplace_c = v_nativeplace_c,
           payid         = v_payid,
           age           = v_age,
           religion      = v_religion,
           educ          = v_educ,
           idno          = v_idno,
           jobid         = v_jobid,
           ORGANIZATION  = v_organization,
           officeplace   = v_officeplace,
           officepost    = v_officepost,
           officetel     = v_officetel,
           nativeaddress = v_nativeaddress,
           nativetel     = v_nativetel,
           nativepost    = v_nativepost,
           address       = v_address
     WHERE noofinpat = v_noofinpat;
  END;

  /***************************************************************************************/
  /*查询员工*/
  PROCEDURE usp_selectusers(v_deptid   VARCHAR,
                            v_username VARCHAR,
                            o_result   OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT users.name      username,
             department.name deptname,
             users.deptid    deptid,
             users.id        userid,
             users.py,
             users.wb
        FROM users
        left join department
          on users.deptid = department.id
       WHERE (users.name = v_username or v_username = '' or
             v_username is null)
         and (users.deptid = v_deptid or v_deptid = '' or v_deptid = '0000' or
             v_deptid is null)
         and users.valid = 1;
  END;

  /*************************************************************************************/
  PROCEDURE usp_symbolmanager(v_type               VARCHAR,
                              v_symbolcategroyid   INT DEFAULT 0, --特殊字符类型名称
                              v_symbolcategoryname VARCHAR DEFAULT '', --特殊字符类型名称
                              v_symbolcategorymemo VARCHAR DEFAULT '', --特殊字符类型备注
                              --  v_SymbolRTF  varchar default '',--特殊字符类型ID(Inpatient.NoOfInpat)
                              --  v_SymbolCategroyID int  default 0,  --特殊字符编码
                              --  v_SymbolLength int  default  0,       --特殊字符长度
                              --  v_SymbolMemo varchar default  '' --特殊字符备注
                              o_result OUT empcurtyp) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]
    [作者]
    [版权]
    [描述] 特殊字符处理模块中负责插入、获取编号？
    [功能说明]
    [输入参数]
    [输出参数]
    [结果集、排序]
    [调用的sp]
    [调用实例]

    [修改记录]
    **********/
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    IF v_type = 'InsertSymCategory' THEN
      --新增特殊字符类型
      INSERT INTO symbolcategory
        (ID, NAME, memo)
      VALUES
        (seq_symbolcategory_id.NEXTVAL,
         v_symbolcategoryname /* Name  */,
         v_symbolcategorymemo /* Memo  */);
      --查询特殊字符类型新的编号
    ELSIF v_type = 'SelectSymCategoryID' THEN
      OPEN o_result FOR
        SELECT NVL((SELECT MAX(a.ID) + 1 FROM symbolcategory a), 1)
          FROM DUAL;
      --根据特殊字符类型编号查询出特殊字符编号
    ELSIF v_type = 'SelectSymbolID' THEN
      OPEN o_result FOR
        SELECT NVL((SELECT MAX(a.ID) + 1
                     FROM symbols a
                    WHERE a.categroyid = v_symbolcategroyid),
                   v_symbolcategroyid * 1000 + 0)
          FROM DUAL;
    END IF;
  END;

  /***************************************************************************************/
  /*输出所有部门信息*/
  PROCEDURE usp_selectward(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM ward where ward.valid = 1;
  END;

  /***************************************************************************************/
  /*输出所有岗位信息*/
  PROCEDURE usp_selectpermission(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM job2permission;
  END;

  /***************************************************************************************/
  /*输出某个员工信息*/
  PROCEDURE usp_selectjob(v_id VARCHAR, o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM jobs WHERE ID = v_id;
  END;

  /***************************************************************************************/
  /*输出所有部门信息*/
  PROCEDURE usp_selectdepartment(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM department;
  END;

  /***************************************************************************************/
  /*输出所有员工信息*/
  PROCEDURE usp_selectallusers2(o_result  OUT empcurtyp,
                                o_result1 OUT empcurtyp) AS
  BEGIN
    /*    OPEN o_result FOR
    SELECT a.*, b.NAME AS deptname, c.NAME AS wardname
      FROM users a
      LEFT JOIN department b ON a.deptid = b.ID
      LEFT JOIN ward c ON a.wardid = c.ID;*/
    OPEN o_result FOR
      select *
        from department a
       where exists (select 1
                from users b
               where a.valid = 1
                 and a.id = b.deptid)
       order by a.id;

    OPEN o_result1 FOR
      select * from users;

    /*      open o_result for

        SELECT a.deptid,b.NAME AS deptname,a.*,  c.NAME AS wardname
    FROM users a
    LEFT JOIN department b ON a.deptid = b.ID
    LEFT JOIN ward c ON a.wardid = c.ID
    order by b.id ;

    open o_result for select '' from dual;*/
  END;

  /***************************************************************************************/
  /*输出所有员工信息*/
  PROCEDURE usp_selectallusers(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM users;
  END;

  /***************************************************************************************/
  /*输出所有员工信息(编号显示其名称)*/
  procedure usp_selectuserinfo(o_result out empcurtyp) as
  begin
    open o_result for
      select users.id,
             users.name,
             users.birth,
             users.idno,
             users.marital,
             users.sexy,
             users.deptid,
             users.wardid,
             users.regdate,
             department.name deptname,
             ward.name       wardname,
             dict1.name      maritalname,
             dict2.name      sexname
        from users
        left join department
          on department.id = users.deptid
        left join ward
          on ward.id = users.wardid
        left join dictionary_detail dict1
          on dict1.categoryid = '4'
         and dict1.detailid = users.marital
        left join dictionary_detail dict2
          on dict2.categoryid = '3'
         and dict2.detailid = users.sexy
       where users.valid = 1;
  end;

  /***************************************************************************************/
  /*输出所有岗位信息*/
  PROCEDURE usp_selectalljobs(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT * FROM jobs;
  END;

  /***************************************************************************************/
  /*保存申请借阅电子病历信息*/
  PROCEDURE usp_saveapplyrecord(v_noofinpat   NUMERIC, --首页序号(住院流水号)
                                v_applydoctor VARCHAR, --申请医生代码
                                v_deptid      VARCHAR, --科室代码
                                v_applyaim    VARCHAR, --申请目的
                                v_duetime     NUMERIC, --申请期限
                                v_unit        VARCHAR --期限单位
                                ) AS
  BEGIN
    INSERT INTO applyrecord
      (ID,
       noofinpat,
       applydoctor,
       deptid,
       applyaim,
       duetime,
       unit,
       applydate,
       status)
    VALUES
      (seq_applyrecord_id.NEXTVAL,
       v_noofinpat,
       v_applydoctor,
       v_deptid,
       v_applyaim,
       v_duetime,
       v_unit,
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'),
       '5201');
  END;

  /***************************************************************************************/
  /*获取病人信息维护窗体控件初始化数据*/
  PROCEDURE usp_redactpatientinfofrm(v_frmtype VARCHAR,
                                     --窗体类型，1n：病人信息管理维护窗体、2n：病人病历史信息窗体
                                     v_noofinpat  NUMERIC DEFAULT '0', --首页序号
                                     v_categoryid VARCHAR DEFAULT '',
                                     --(字典)类别代码 、或父节点代码 、首页序号
                                     o_result OUT empcurtyp) AS
  BEGIN
    --  print v_FrmType
    --  print v_CategoryID
    IF v_frmtype = '11' THEN
      OPEN o_result FOR
      --省市代码(病人信息管理维护窗体)
        SELECT parentid, ID, NAME, py, wb
          FROM areas
         WHERE TRIM(CATEGORY) = v_categoryid
         ORDER BY NAME;
    ELSIF v_frmtype = '12' THEN
      OPEN o_result FOR
      --区县代码(病人信息管理维护窗体)
        SELECT parentid, ID, NAME, py, wb
          FROM areas
         WHERE TRIM(parentid) = v_categoryid
         ORDER BY NAME;
    ELSIF v_frmtype = '13' THEN
      OPEN o_result FOR
      --字典分类明细库(病人信息管理维护窗体)
        SELECT categoryid, detailid, NAME, py, wb lens
          FROM dictionary_detail
         WHERE TRIM(categoryid) = v_categoryid
         ORDER BY detailid;
    ELSIF v_frmtype = '14' THEN
      OPEN o_result FOR
      --病人基本信息
        SELECT ip.*,
               u.NAME     AS clinicdoctorname,
               dd1.NAME   AS stylename,
               dd2.NAME   AS originname,
               d.NAME     AS clinicdiagnosisname,
               cd.NAME    AS statusname,
               dd3.NAME   AS criticallevelname,
               dd4.NAME   AS admitinfoname,
               dd5.NAME   AS admitwayname,
               dept1.NAME AS admitdeptname,
               w1.NAME    AS admitwardname,
               dept2.NAME AS outhosdeptname,
               w2.NAME    AS outhoswardname,
               dd6.NAME   AS gender,
               dd7.NAME   AS marriage,
               dd8.NAME   AS jobname
          FROM inpatient ip
          LEFT JOIN dictionary_detail dd1
            ON dd1.categoryid = '45'
           AND dd1.detailid = ip.style
          LEFT JOIN dictionary_detail dd2
            ON dd2.categoryid = '2'
           AND dd2.detailid = ip.origin
          LEFT JOIN users u
            ON u.ID = ip.clinicdoctor
          LEFT JOIN diagnosis d
        /*add by ywk 2013年4月9日16:51:44 */
            ON d.icd = ip.clinicdiagnosis
           and d.tumorid <> ' '
        /* ON d.icd = ip.clinicdiagnosis*/
          LEFT JOIN categorydetail cd
            ON cd.ID = ip.status
           AND cd.categoryid = '15'
          LEFT JOIN dictionary_detail dd3
            ON dd3.categoryid = '53'
           AND dd3.detailid = ip.criticallevel
          LEFT JOIN dictionary_detail dd4
            ON dd4.categoryid = '5'
           AND dd4.detailid = ip.admitinfo
          LEFT JOIN dictionary_detail dd5
            ON dd5.categoryid = '6'
           AND dd5.detailid = ip.admitway
          LEFT JOIN department dept1
            ON dept1.ID = ip.admitdept
          LEFT JOIN ward w1
            ON w1.ID = ip.admitward
          LEFT JOIN department dept2
            ON dept2.ID = ip.outhosdept
          LEFT JOIN ward w2
            ON w2.ID = ip.outhosward
        --Add By wwj 2011-05-17
          LEFT JOIN dictionary_detail dd6
            ON dd6.categoryid = '3'
           AND dd6.detailid = ip.sexid
          LEFT JOIN dictionary_detail dd7
            ON dd7.categoryid = '4'
           AND dd7.detailid = ip.marital
          LEFT JOIN dictionary_detail dd8
            ON dd8.categoryid = '41'
           AND dd8.detailid = ip.jobid
         WHERE TRIM(ip.noofinpat) = v_noofinpat;
    ELSIF v_frmtype = '15' THEN
      OPEN o_result FOR
      --第一联系人信息(病人信息管理维护窗体)
        SELECT CASE
                 WHEN tag = '1' THEN
                  '是'
                 ELSE
                  '否'
               END AS tagname,
               a.*
          FROM patientcontacts a
         WHERE TRIM(a.noofinpat) = v_noofinpat;
      --        select ID,pc.Name,dd1.Name as SexName,dd2.Name as RelationName,Address,WorkUnit,HomeTel,WorkTel,PostalCode,Tag
      --     from PatientContacts pc
      --     left join Dictionary_detail dd1 on dd1.CategoryID='3' and dd1.DetailID=Sex
      --     left join Dictionary_detail dd2 on dd2.CategoryID='44' and dd2.DetailID=Relation
      --     where NoOfInpat=v_NoOfInpat
    ELSIF v_frmtype = '16' THEN
      OPEN o_result FOR
      --过去诊断病种
        SELECT * FROM diagnosis;
    ELSIF v_frmtype = '21' THEN
      OPEN o_result FOR
      --获取字典表信息
        SELECT categoryid, CAST(ID AS VARCHAR(4)) AS detailid, NAME, py, wb
          FROM categorydetail
         WHERE TRIM(categoryid) = v_categoryid;
    ELSIF v_frmtype = '22' THEN
      OPEN o_result FOR
      --获取家族史
        SELECT cd.NAME relationexplain,
               datediff('yy', fh.birthday, TO_CHAR(SYSDATE, 'yyyy-mm-dd')) + 1 age,
               d.NAME diseasename,
               (CASE
                 WHEN breathing = 1 THEN
                  '是'
                 ELSE
                  '否'
               END) isbreathing,
               fh.*
          FROM familyhistory fh
          LEFT JOIN categorydetail cd
            ON cd.ID = fh.relation
           AND cd.categoryid = '62'
          LEFT JOIN diagnosis d
            ON d.icd = fh.diseaseid
         WHERE noofinpat = v_noofinpat;
    ELSIF v_frmtype = '23' THEN
      OPEN o_result FOR
      --获取个人史
        SELECT * FROM personalhistory;
    ELSIF v_frmtype = '24' THEN
      OPEN o_result FOR
      --获取过敏史
        SELECT ah.*, cd1.NAME AS allergyname, cd2.NAME AS allergylevelname
          FROM allergyhistory ah
          LEFT JOIN categorydetail cd1
            ON cd1.ID = ah.allergyid
           AND cd1.categoryid = '60'
          LEFT JOIN categorydetail cd2
            ON cd2.ID = ah.allergylevel
           AND cd2.categoryid = '61'
         WHERE noofinpat = v_noofinpat;
    ELSIF v_frmtype = '25' THEN
      OPEN o_result FOR
      --获取手术名称
        SELECT * FROM surgery;
    ELSIF v_frmtype = '26' THEN
      OPEN o_result FOR
      --获取手术史
        SELECT sh.*, s.NAME AS surgeryname, d.NAME AS diagnosisname
          FROM surgeryhistory sh
          LEFT JOIN surgery s
            ON s.ID = sh.surgeryid
          LEFT JOIN diagnosis d
            ON d.icd = sh.diagnosisid
         WHERE noofinpat = v_noofinpat;
    ELSIF v_frmtype = '27' THEN
      OPEN o_result FOR
      --获取疾病史
        SELECT ih.*,
               d.NAME AS diagnosisname,
               (CASE
                 WHEN cure = 1 THEN
                  '是'
                 ELSE
                  '否'
               END) iscure
          FROM illnesshistory ih
          LEFT JOIN diagnosis d
            ON d.icd = ih.diagnosisicd
         WHERE noofinpat = v_noofinpat;
    END IF;
  END;

  /***************************************************************************************/
  /*获取质量控制统计数据(有查询条件)*/
  PROCEDURE usp_queryqcstatinfo(v_datetimebegin VARCHAR, --开始时间
                                v_datetimeend   VARCHAR, --结束时间
                                o_result        OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
    --在院患者
      SELECT COUNT(*) statnumber, '在院患者' statitem, 1 qctype
        FROM inpatient
       WHERE status IN (1501, 1505, 1506, 1507)
      UNION
      ----出院以提交
      --SELECT count(*) statnumber,'出院已提交' statitem,2 qctype FROM InPatient inp JOIN MedicalRecord med
      --ON inp.NoOfInpat = med.NoOfInpat AND med.LockInfo IN (4701) AND CONVERT(varchar(10),AdmitDate,102) >= v_DateTimeBegin
      --AND CONVERT(varchar(10),AdmitDate,102) <= v_DateTimeEnd
      --WHERE inp.Status IN  (1502,1503)
      --UNION
      --新入院患者
      SELECT COUNT(*) statnumber, '新入院患者' statitem, 2 qctype
        FROM inpatient
       WHERE status IN (1501, 1505, 1506, 1507)
      --AND CONVERT(varchar(10),AdmitDate,102) >= v_DateTimeBegin
      --AND CONVERT(varchar(10),AdmitDate,102) <= v_DateTimeEnd
      UNION
      --当日违规数
      SELECT COUNT(*) statnumber, '违规病历' statitem, 3 qctype
        FROM qcrecord a
        JOIN inpatient b
          ON a.noofinpat = b.noofinpat
         AND b.status IN (1500, 1501, 1504, 1505, 1506, 1507)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
        JOIN qcrule d
          ON a.rulecode = d.rulecode
        LEFT JOIN users c
          ON a.docotorid = c.ID
       WHERE a.valid != 0
         AND a.foulstate IN (1, 3)
      --
      UNION
      --危重病人
      SELECT COUNT(*) statnumber, '危重病人' statitem, 4 qctype
        FROM inpatient
       WHERE criticallevel = 1
         AND status IN (1500, 1501, 1504, 1505, 1506, 1507)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
      UNION
      --手术病人数,需要修改
      SELECT COUNT(*) statnumber, '手术病人' statitem, 5 qctype
        FROM inpatient
       WHERE status IN (1500, 1501, 1504, 1505, 1506, 1507)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
         AND (TO_NUMBER(SYSDATE - admitdate) > 30)
      --
      UNION
      --死亡病人数,需要修改
      SELECT COUNT(*) statnumber, '死亡病人' statitem, 6 qctype
        FROM inpatient
       WHERE status IN (1500, 1501, 1504, 1505, 1506, 1507)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
         AND (TO_NUMBER(SYSDATE - admitdate) > 30)
      --住院超过30天
      UNION
      SELECT COUNT(*) statnumber, '住院超过30天' statitem, 7 qctype
        FROM inpatient
       WHERE status IN (1500, 1501, 1504, 1505, 1506, 1507)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
         AND (TO_NUMBER(SYSDATE - admitdate) > 30)
      --出院未提交
      UNION
      SELECT COUNT(*) statnumber, '出院未提交' statitem, 8 qctype
        FROM inpatient inp
        JOIN medicalrecord med
          ON inp.noofinpat = med.noofinpat
         AND med.lockinfo IN (4700, 4702, 4703)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
       WHERE inp.status IN (1502, 1503)
      --归档病历
      UNION
      SELECT COUNT(*) statnumber, '归档病历' statitem, 9 qctype
        FROM inpatient inp
        JOIN medicalrecord med
          ON inp.noofinpat = med.noofinpat
         AND med.lockinfo IN (4700, 4702, 4703)
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') >= v_datetimebegin
         AND TO_CHAR(admitdate, 'yyyy.mm.dd') <= v_datetimeend
       WHERE inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
       ORDER BY qctype;
  END;

  /***************************************************************************************/
  /*获取质量控制统计数据*/
  PROCEDURE usp_queryqcstatdetailinfo(v_datetimebegin VARCHAR, --开始时间
                                      v_datetimeend   VARCHAR, --结束时间
                                      v_qcstattype    INT, --统计资料类型
                                      o_result        OUT empcurtyp) AS
  BEGIN
    IF v_qcstattype = 1 THEN
      OPEN o_result FOR
      --在院患者 isnull(,'-')
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 2 THEN
      OPEN o_result FOR
      --出院已提交
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          JOIN medicalrecord med
            ON inp.noofinpat = med.noofinpat
           AND med.lockinfo IN (4701)
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1502, 1503)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 3 THEN
      OPEN o_result FOR
      --当日违规数
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM qcrecord a
          JOIN inpatient inp
            ON a.noofinpat = inp.noofinpat
           AND inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
          JOIN qcrule d
            ON a.rulecode = d.rulecode
          LEFT JOIN users c
            ON a.docotorid = c.ID
         WHERE a.valid != 0
           AND a.foulstate IN (1, 3)
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 4 THEN
      OPEN o_result FOR
      --危重病人
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.criticallevel = 1
           AND inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 5 THEN
      OPEN o_result FOR
      --手术病人数,需要修改
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
           AND (TO_NUMBER(SYSDATE - inp.admitdate) > 30)
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 6 THEN
      OPEN o_result FOR
      --死亡病人数,需要修改
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
           AND (TO_NUMBER(SYSDATE - inp.admitdate) > 30)
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 7 THEN
      OPEN o_result FOR
      --住院超过30天
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
           AND (TO_NUMBER(SYSDATE - inp.admitdate) > 30)
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 8 THEN
      OPEN o_result FOR
      --出院未提交
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          JOIN medicalrecord med
            ON inp.noofinpat = med.noofinpat
           AND med.lockinfo IN (4700, 4702, 4703)
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1502, 1503)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
         ORDER BY inp.noofinpat;
    ELSIF v_qcstattype = 9 THEN
      OPEN o_result FOR
      --归档病历
        SELECT inp.noofinpat AS noofinpat,
               inp.patnoofhis AS patnoofhis,
               inp.patid AS patid,
               inp.NAME AS NAME,
               inp.sexid AS sexid,
               dd.NAME AS sexname,
               inp.agestr AS agestr,
               bed.wardid AS wardid,
               bed.deptid AS deptid,
               bed.ID AS bedid,
               inp.admitdate AS admitdate,
               bed.wardid,
               bed.deptid,
               ward.NAME AS wardname,
               de.NAME AS deptname,
               NULL cycletimes,
               NULL deduction,
               (SELECT COUNT(noofinpat)
                  FROM recorddetail
                 WHERE recorddetail.noofinpat = inp.noofinpat) AS copies,
               NVL(inp.NAME, '-') || '/' || NVL(dd.NAME, '-') || '/' ||
               NVL(inp.agestr, '-') || '/' || NVL(ward.NAME, '-') || '/' ||
               NVL(de.NAME, '-') || '/' || NVL(bed.ID, '-') || '床/' ||
               NVL(inp.admitdate, '-') || '入院' AS showinfo
          FROM inpatient inp
          JOIN medicalrecord med
            ON inp.noofinpat = med.noofinpat
           AND med.lockinfo IN (4700, 4702, 4703)
          LEFT JOIN dictionary_detail dd
            ON dd.categoryid = '3'
           AND inp.sexid = dd.detailid
          LEFT JOIN bed bed
            ON inp.noofinpat = bed.noofinpat
           AND inp.patnoofhis = bed.patnoofhis
           AND bed.inbed = 1301
          LEFT JOIN ward ward
            ON bed.wardid = ward.ID
          LEFT JOIN department de
            ON bed.deptid = de.ID
         WHERE inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') >= v_datetimebegin
           AND TO_CHAR(inp.admitdate, 'yyyy.mm.dd') <= v_datetimeend
         ORDER BY inp.noofinpat;
    END IF;
  END;

  /***************************************************************************************/
  /*获取问题登记数据*/
  PROCEDURE usp_queryqcprobleminfo(v_noofinpat INT, o_result OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取问题登记数据
     功能说明
     输入参数
      v_NoOfInpat int
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_QueryQCProblemInfo 2
     修改记录
    **********/
  BEGIN
    OPEN o_result FOR
      SELECT qcd.ID,
             ip.NAME,
             ip.patid,
             TO_CHAR(qcd.problemdate, 'yyyy.mm.dd') AS problemdate,
             qcd.typecode AS typecode,
             qct.typename AS typename,
             TO_CHAR(qcd.registerdate, 'yyyy.mm.dd') AS registerdate,
             us1.NAME AS registername,
             TO_CHAR(qcd.answerdate, 'yyyy.mm.dd') AS answerdate,
             us2.NAME AS ansewername,
             TO_CHAR(qcd.confirmdate, 'yyyy.mm.dd') AS confirmdate,
             us3.NAME AS confirmuser,
             qcd.CATEGORY,
             qcd.noofinpat,
             CASE qcd.CATEGORY
               WHEN 0 THEN
                '提交'
               WHEN 1 THEN
                '审核'
               WHEN 2 THEN
                '作废'
             END categoryname,
             qcd.status,
             CASE qcd.status
               WHEN 0 THEN
                '登记'
               WHEN 1 THEN
                '答复'
             END statusname,
             qcd.description,
             qcd.ansewercontent,
             qcd.confirmcontent
        FROM qcproblemdescription qcd
        JOIN inpatient ip
          ON qcd.noofinpat = ip.noofinpat
        LEFT JOIN users us1
          ON qcd.registeruser = us1.ID
        LEFT JOIN users us2
          ON qcd.answeruser = us2.ID
        LEFT JOIN users us3
          ON qcd.confirmuser = us3.ID
        JOIN qcscoretype qct
          ON qcd.typecode = qct.typecode
       WHERE qcd.noofinpat = v_noofinpat
         AND qcd.CATEGORY NOT IN (2)
       ORDER BY qcd.registerdate;
  END;

  /***************************************************************************************/
  /*获取质量控制病患数据*/
  PROCEDURE usp_queryqcpatientinfo(v_datetimefrom VARCHAR,
                                   v_datetimeto   VARCHAR,
                                   v_deptid       VARCHAR,
                                   v_wardid       VARCHAR,
                                   v_bedid        VARCHAR,
                                   v_name         VARCHAR,
                                   v_archives     VARCHAR,
                                   o_result       OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量控制病患数据
     功能说明
     输入参数
      v_DateTimeFrom varchar(9) --开始时间
     ,v_DateTimeTo  varchar(9) --结束时间
     ,v_DeptId varchar(10) --科室
     ,v_WardId varchar(10) --病区
     ,v_bedId varchar (10) --床位
     ,v_name varchar(20) --姓名
     ,v_archives varchar(1)--归档类型
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_QueryQCPatientInfo '2007-06-01', '2010-06-30','','','','',''
     修改记录
    ,环节质控次数 CycleTimes,环节质控扣分 Deduction,书写文书份数 Copies
    **********/
    v_sql VARCHAR(3000);
  BEGIN
    v_sql := 'SELECT inp.NoOfInpat AS NoOfInpat,inp.PatNoOfHis AS PatNoOfHis,inp.PatID AS PatID
,inp.Name AS Name,inp.SexID AS SexID,dd.Name AS SexName,inp.AgeStr AS AgeStr
, bed.WardId AS WardId, bed.DeptID AS DeptID, bed.ID  AS BedID,inp.AdmitDate AS AdmitDate
,bed.WardId,bed.DeptID,ward.Name AS wardname,de.Name AS deptname
,NULL CycleTimes,NULL Deduction
,(SELECT count(NoOfInpat)  FROM RecordDetail where RecordDetail.NoOfInpat = inp.NoOfInpat) as Copies
, isnull(inp.Name,''-'') ||''/''|| isnull(dd.Name,''-'')||''/''|| isnull(inp.AgeStr,''-'')
||''/''||isnull(ward.Name,''-'')||''/''||isnull(de.Name,''-'') ||''/'' || isnull(bed.ID,''-'') ||''床/''
|| isnull(inp.AdmitDate,''-'') || ''入院'' as showinfo
FROM InPatient inp';

    IF v_archives = '0' THEN
      --未归档
      BEGIN
        v_sql := v_sql ||
                 ' JOIN MedicalRecord med ON inp.NoOfInpat = med.NoOfInpat AND med.LockInfo IN (4700)';
      END;
    ELSIF v_archives = '1' THEN
      --已归档
      BEGIN
        v_sql := v_sql ||
                 ' JOIN MedicalRecord med ON inp.NoOfInpat = med.NoOfInpat AND med.LockInfo IN (4701)';
      END;
    ELSIF v_archives = '2' THEN
      --撤销归档
      BEGIN
        v_sql := v_sql ||
                 ' JOIN MedicalRecord med ON inp.NoOfInpat = med.NoOfInpat AND med.LockInfo IN (4702)';
      END;
    END IF;

    v_sql := v_sql ||
             ' LEFT JOIN Dictionary_detail dd  ON dd.CategoryID = ''3'' AND inp.SexID = dd.DetailID
LEFT JOIN Bed bed  ON inp.NoOfInpat = bed.NoOfInpat and inp.PatNoOfHis =bed.PatNoOfHis and bed.InBed = 1301';

    IF v_bedid != '' AND v_bedid IS NOT NULL THEN
      BEGIN
        v_sql := v_sql || ' and isnull(bed.ID,'''') like ''' || '%' ||
                 v_bedid || '''';
      END;
    END IF;

    v_sql := v_sql || ' left join Ward ward  on bed.WardId = ward.ID';

    IF v_wardid != '' AND v_wardid IS NOT NULL THEN
      BEGIN
        v_sql := v_sql || ' and isnull(ward.ID,'''') = ''' || v_wardid || '''';
      END;
    END IF;

    v_sql := v_sql || ' left join Department de  on bed.DeptID = de.ID';

    IF v_deptid != '' AND v_deptid IS NOT NULL THEN
      BEGIN
        v_sql := v_sql || ' and isnull(de.ID,'''') = ''' || v_deptid || '''';
      END;
    END IF;

    v_sql := v_sql ||
             ' WHERE inp.Status NOT IN (1509) AND CONVERT(varchar(10),inp.AdmitDate,102) >= ''' ||
             v_datetimefrom || '''';
    v_sql := v_sql || ' AND CONVERT(varchar(10),inp.AdmitDate,102) <= ''' ||
             v_datetimeto || '''';

    IF v_name != '' AND v_name IS NOT NULL THEN
      BEGIN
        v_sql := v_sql || ' and isnull(inp.Name,'''') like ''' || '%' ||
                 v_name || '%' || '''';
      END;
    END IF;

    v_sql := v_sql || ' order by inp.NoOfInpat';

    OPEN o_result FOR v_sql;
  END;

  /***************************************************************************************/
  /*根据首页序号获取病人对应信息*/
  PROCEDURE usp_querypatientinfobynoofinp(v_noofinpat INT, --首页序号
                                          o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  根据首页序号获取病人对应信息
     功能说明
     输入参数
     v_NoOfInpat int --首页序号
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例
     exec usp_QueryPatientInfoByNoOfInpat 2
     修改记录
    护理级别待处理
    **********/
  BEGIN
    OPEN o_result FOR
      SELECT inp.noofinpat AS noofinpat,
             inp.patnoofhis AS patnoofhis,
             inp.patid AS patid,
             inp.NAME AS NAME,
             inp.sexid AS sexid,
             dd.NAME AS sexname,
             inp.agestr AS agestr,
             bed.wardid AS wardid,
             bed.deptid AS deptid,
             bed.ID AS bedid,
             inp.admitdate AS admitdate,
             bed.wardid,
             bed.deptid,
             ward.NAME AS wardname,
             de.NAME AS deptname,
             inp.outhosdate AS outhosdate,
             did.NAME AS levelname,
             '一级护理' AS carelevel,
             inp.admitdiagnosis AS dianame,
             users.NAME AS doctorname,
             cad.NAME AS statusname
        FROM inpatient inp
        LEFT JOIN dictionary_detail dd
          ON dd.categoryid = '3'
         AND inp.sexid = dd.detailid
        LEFT JOIN bed bed
          ON inp.noofinpat = bed.noofinpat
         AND inp.patnoofhis = bed.patnoofhis
         AND bed.inbed = 1301
        LEFT JOIN ward ward
          ON bed.wardid = ward.ID
        LEFT JOIN department de
          ON bed.deptid = de.ID
        LEFT JOIN dictionary_detail did
          ON inp.criticallevel = did.detailid
         AND did.categoryid = '53'
        LEFT JOIN diagnosis dia
          ON inp.admitdiagnosis = dia.icd
        LEFT JOIN users
          ON inp.resident = users.ID
         AND users.valid = 1
        LEFT JOIN categorydetail cad
          ON inp.status = cad.ID
         AND cad.categoryid = '15'
       WHERE inp.noofinpat = v_noofinpat
       ORDER BY inp.noofinpat;
  END;

  /***************************************************************************************/
  /*获取病人提取界面病人列表*/
  PROCEDURE usp_queryownmanagerpat2(v_querytype INT,
                                    v_userid    VARCHAR,
                                    v_deptid    VARCHAR,
                                    v_wardid    VARCHAR,
                                    o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取病人提取界面病人列表
     功能说明
     输入参数
     QueryType int     查询类别
     UserID varchar(8) 用户ID
     DeptID varchar(6)     科室代码
     WardId varchar(6)     病区代码
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例

     修改记录
    护理级别待处理
    **********/
    v_sql VARCHAR(3000);
  BEGIN
    IF v_querytype = 0 THEN
      --获得除分管外的病人
      BEGIN
        v_sql := 'select
    a.NoOfInpat  NoOfInpat--首页序号
  , a.PatNoOfHis PatNoOfHis --HIS首页序号
  , a.PatID PatID --住院号
  , a.Name PatName --姓名
  , a.SexID Sex  --病人性别
  , b.Name SexName  --病人性别名称
  , a.AgeStr AgeStr  --年龄
  , rtrim(a.CriticalLevel) wzjb --危重级别
  , a.Status arzt --病人状态
  , c.Name wzjbmc --危重级别名称
  , substring(a.AdmitDate,1,16) AdmitDate  --入院日期
  ,  a.AdmitDiagnosis ryzd --入院诊断
  , d.Name zdmc --诊断名称
  --, e.Note pzlx --凭证类型
  , dd1.NAME pzlx --费用类别
  , f.DeptID ksdm
from InPatient a
left join Dictionary_detail b  on b.DetailID = a.SexID and b.CategoryID = ''3''
left join Dictionary_detail c  on c.DetailID = a.CriticalLevel and c.CategoryID = ''53''
left join Diagnosis d  on d.ICD = a.AdmitDiagnosis
--left join MedicareInfo e  ON a.VouchersCode = e.ID
LEFT JOIN Dictionary_detail dd1 ON dd1.categoryid = ''1'' AND a.payid = dd1.detailid
left join Bed f   on f.NoOfInpat = a.NoOfInpat and f.PatNoOfHis = a.PatNoOfHis and f.InBed = 1301
where a.Status in (1501,1504,1505,1506,1507)
and  not exists (select 1 from Doctor_AssignPatient da where da.NoOfInpat=a.NoOfInpat and ID=' ||
                 v_userid || ' and Valid=1)
and f.DeptID=''' || v_deptid || ''' and  f.WardId=''' ||
                 v_wardid || '''
';

        --exec sp_executesql v_sql
        OPEN o_result FOR v_sql;
      END;
    END IF;

    IF v_querytype = 1 THEN
      --获得分管病人
      BEGIN
        INSERT INTO doctor_assignpatient
          SELECT v_userid, noofinpat, 1, SYSDATE, v_userid, 1
            FROM inpatient a
           WHERE resident = v_userid
             AND status IN (1501, 1504, 1505, 1506, 1507)
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient da
                   WHERE da.noofinpat = a.noofinpat
                     AND ID = v_userid
                     AND valid = 1);

        OPEN o_result FOR
          SELECT a.noofinpat  noofinpat, --首页序号
                 a.patnoofhis patnoofhis,

                 --HIS首页序号
                 a.patid  patid, --住院号
                 a.NAME   patname, --姓名
                 a.sexid  sex, --病人性别
                 b.NAME   sexname, --病人性别名称
                 a.agestr agestr, --年龄
                 a.status arzt,

                 --病人状态
                 c.NAME wzjbmc, --危重级别名称
                 c.detailid wzjb, --危重级别编码
                 SUBSTR(a.admitdate, 1, 16) admitdate, --入院日期
                 d.icd ryzd,

                 --入院诊断
                 a.admitdiagnosis zdmc, --诊断名称
                 --e.note pzlx, --凭证类型
                 dd1.NAME pzlx, --费用类别
                 g.NAME   ksmc, --科室名称
                 h.NAME   bqmc,

                 --病区名称
                 a.outbed bedid, --出院床位号
                 (SELECT CASE
                           WHEN COUNT(qc.foulstate) > 0 THEN
                            '是'
                           ELSE
                            '否'
                         END
                    FROM qcrecord qc
                   WHERE qc.noofinpat = da.noofinpat
                     AND qc.valid = 1
                     AND qc.foulstate = 1) AS iswarn --是否违规
            FROM doctor_assignpatient da
            JOIN inpatient a
              ON da.noofinpat = a.noofinpat
             AND valid = 1
             AND da.ID = v_userid
            LEFT JOIN dictionary_detail b
              ON b.detailid = a.sexid
             AND b.categoryid = '3'
            LEFT JOIN dictionary_detail c
              ON c.detailid = a.criticallevel
             AND c.categoryid = '53'
            LEFT JOIN diagnosis d
              ON d.icd = a.admitdiagnosis
          --LEFT JOIN medicareinfo e ON a.voucherscode = e.ID

            LEFT JOIN Dictionary_detail dd1
              ON dd1.categoryid = '1'
             AND a.payid = dd1.detailid
            LEFT JOIN bed f
              ON f.noofinpat = a.noofinpat
             AND f.patnoofhis = a.patnoofhis
             AND f.inbed = 1301
            LEFT JOIN department g
              ON f.deptid = g.ID
            LEFT JOIN ward h
              ON f.wardid = g.ID
           WHERE a.status IN (1501, 1504, 1505, 1506, 1507)
          --group by  a.NoOfInpat,a.PatNoOfHis,a.PatID,a.Name,a.SexID,b.Name,a.AgeStr,a.Status,c.Name,substring(a.AdmitDate,1,16),d.ICD,d.Name,e.pzlx,g.Name,h.Name
          --and f.DeptID in DeptID
          ;
      END;
    END IF;
  END;

  /***************************************************************************************/
  /*获取对应病区的床位信息*/
  PROCEDURE usp_querynonarchivepatients(v_wardid  VARCHAR,
                                        v_deptids VARCHAR,
                                        o_result  OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取对应病区的床位信息
     功能说明
     输入参数
      v_wardid  varchar(6)   --病区代码
      v_deptids varchar(255)  --科室代码集合(形如: '代码1','代码2')
     输出参数
     结果集、排序
    病区未归档病人数据集

     调用的sp
     调用实例
     exec usp_QueryInwardPatients  '2821', '7006'
     修改记录

    **********/
    v_wardid_in VARCHAR2(6);
  BEGIN
    IF v_wardid IS NULL THEN
      v_wardid_in := '';

      OPEN o_result FOR
        SELECT b.noofinpat  noofinpat, --首页序号
               b.patnoofhis patnoofhis,

               --HIS首页序号
               b.patid  patid, --住院号
               b.NAME   inpatname, --姓名
               b.sexid  sexid, --病人性别
               b.agestr agestr, --年龄
               b.status status, --病人状态
               f.NAME   statusname,

               --病人状态名称
               b.criticallevel criticallevel, --危重级别
               h.NAME          criticallevelname,

               --危重级别名称
               z.NAME residentname, --住院医生
               SUBSTR(b.admitdate, 1, 16) admitdate, --入院日期
               b.admitdiagnosis admitdiagnosis, --入院诊断
               SUBSTR(b.outhosdate, 1, 16) outhosdate, --出院日期
               b.outbed outbed,

               --出院床位
               b.memo memo
        --备注
          FROM inpatient b
         INNER JOIN medicalrecord k
            ON b.noofinpat = k.noofinpat
           AND k.lockinfo IN (4700, 4702, 4703)
          LEFT JOIN categorydetail f
            ON b.status = f.ID
          LEFT JOIN users z
            ON z.ID = b.resident
          LEFT JOIN dictionary_detail h
            ON h.detailid = b.criticallevel
           AND h.categoryid = '53'
         WHERE b.outhosdept = v_deptids
           AND (v_wardid_in = '' OR b.outhosward = v_wardid_in OR
               v_wardid_in IS NULL)
           AND b.status IN (1502, 1503, 1504);
    END IF;
  END;

  /***************************************************************************************/
  /*质控TypeScore操作*/
  PROCEDURE usp_qctypescore(v_typename        VARCHAR default '',
                            v_typeinstruction VARCHAR default '',
                            v_typecategory    INT default 0,
                            v_typeorder       INT default 0,
                            v_typememo        VARCHAR default '',
                            v_typestatus      INT,
                            v_typecode        VARCHAR) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  质控TypeScore操作
     功能说明
     输入参数
     v_TypeName varchar(40)
     ,v_TypeInstruction  varchar(60)
     ,v_TypeCategory int
     ,v_TypeOrder int
     ,v_TypeMemo varchar(60)
    ,v_TypeStatus int
    ,v_TypeCode varchar(4)
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_QCTypeScore  'test', 'test',0,0,'test',0
     修改记录
    **********/
    v_typecodetemp VARCHAR(4);
  BEGIN
    IF v_typestatus = 0 THEN
      --新增
      BEGIN
        SELECT 'T' || lpad((nvl(max(substr(typecode, 2)), 0) + 1), 3, '0')
          INTO v_typecodetemp
          FROM qcscoretype;

        INSERT INTO qcscoretype
          (typecode,
           typename,
           typeinstruction,
           typecategory,
           typeorder,
           typememo)
        VALUES
          (v_typecodetemp,
           v_typename,
           v_typeinstruction,
           v_typecategory,
           v_typeorder,
           v_typememo);
      END;
    ELSIF v_typestatus = 1 THEN
      --修改
      BEGIN
        UPDATE qcscoretype
           SET typename        = v_typename,
               typeinstruction = v_typeinstruction,
               typecategory    = v_typecategory,
               typeorder       = v_typeorder,
               typememo        = v_typememo
         WHERE typecode = v_typecode;
      END;
    ELSIF v_typestatus = 2 THEN
      --删除
      BEGIN
        UPDATE qcscoretype SET valide = 0 WHERE typecode = v_typecode;
      END;
    END IF;
  END;

  /***************************************************************************************/
  /*获取质量问题数据*/
  PROCEDURE usp_qcoperprobleminfo(v_id             INT,
                                  v_noofinpat      INT,
                                  v_category       INT,
                                  v_status         INT,
                                  v_typecode       VARCHAR,
                                  v_description    VARCHAR,
                                  v_ansewercontent VARCHAR,
                                  v_confirmcontent VARCHAR,
                                  v_problemdate    VARCHAR,
                                  v_registerdate   VARCHAR,
                                  v_registeruser   VARCHAR,
                                  v_answerdate     VARCHAR,
                                  v_answeruser     VARCHAR,
                                  v_confirmdate    VARCHAR,
                                  v_confirmuser    VARCHAR,
                                  v_deldate        VARCHAR,
                                  v_deluser        VARCHAR,
                                  v_operstatus     INT) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量问题数据
     功能说明
     输入参数
      v_DateTimeBegin varchar(9) --开始时间
     ,v_v_DateTimeEnd  varchar(9) --结束时间
     ,v_QCStatType int --统计资料类型
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_QCOperProblemInfo '2007-06-01', '2010-06-30',1
     修改记录
    **********/
    v_doctorid VARCHAR(6);
  BEGIN
    IF v_operstatus = 0 THEN
      --提交
      BEGIN
        SELECT OPERATOR
          INTO v_doctorid
          FROM medicalrecord
         WHERE noofinpat = v_noofinpat
           AND ROWNUM < 2;

        INSERT INTO qcproblemdescription
          (ID,
           noofinpat,
           CATEGORY,
           status,
           typecode,
           description,
           problemdate,
           registerdate,
           registeruser,
           doctor_id)
        VALUES
          (seq_qcproblemdescription_id.NEXTVAL,
           v_noofinpat,
           v_category,
           v_status,
           v_typecode,
           v_description,
           v_problemdate,
           v_registerdate,
           v_registeruser,
           v_doctorid);
      END;
    ELSIF v_operstatus = 1 THEN
      -- 审核
      BEGIN
        UPDATE qcproblemdescription
           SET confirmcontent = v_confirmcontent,
               confirmdate    = v_confirmdate,
               confirmuser    = v_confirmuser,
               CATEGORY       = v_category
         WHERE ID = v_id;
      END;
    ELSIF v_operstatus = 2 THEN
      --作废
      BEGIN
        UPDATE qcproblemdescription
           SET confirmcontent = v_confirmcontent,
               deldate        = v_deldate,
               deluser        = v_deluser,
               CATEGORY       = v_category
         WHERE ID = v_id;
      END;
    END IF;
  END;

  /***************************************************************************************/
  /*获取质量控制统计数据*/
  PROCEDURE usp_qcitemscore(v_itemname           VARCHAR,
                            v_iteminstruction    VARCHAR,
                            v_itemdefaultscore   INT,
                            v_itemstandardscore  INT,
                            v_itemcategory       INT,
                            v_itemdefaulttarget  INT,
                            v_itemtargetstandard INT,
                            v_itemscorestandard  INT,
                            v_itemorder          INT,
                            v_typecode           VARCHAR,
                            v_itemmemo           VARCHAR,
                            v_typestatus         INT,
                            v_itemcode           VARCHAR) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量控制统计数据
     功能说明
     输入参数
      v_ItemName varchar(40)
     ,v_ItemInstruction varchar(60)
     ,v_ItemDefaultScore int
     ,v_ItemStandardScore int
     ,v_ItemCategory int
     ,v_ItemDefaultTarget int
     ,v_ItemTargetStandard int
     ,v_ItemScoreStandard int
     ,v_ItemOrder int
     ,v_TypeCode varchar(4)
     ,v_ItemMemo varchar(60)
    ,v_TypeStatus int
     ,v_ItemCode varchar(5)
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_QCItemScore  'test', 'test',3,4,5,6,7,8,9,'E001','test',0
     修改记录
    **********/
    v_itemcodetemp VARCHAR(5);
  BEGIN
    IF v_typestatus = 0 THEN
      BEGIN
        SELECT 'I' || lpad((nvl(max(substr(itemcode, 2)), 0) + 1), 4, '0')
          INTO v_itemcodetemp
          FROM qcscoreitem;

        INSERT INTO qcscoreitem
          (itemcode,
           itemname,
           iteminstruction,
           itemdefaultscore,
           itemstandardscore,
           itemcategory,
           itemdefaulttarget,
           itemtargetstandard,
           itemscorestandard,
           itemorder,
           typecode,
           itemmemo)
        VALUES
          (v_itemcodetemp,
           v_itemname,
           v_iteminstruction,
           v_itemdefaultscore,
           v_itemstandardscore,
           v_itemcategory,
           v_itemdefaulttarget,
           v_itemtargetstandard,
           v_itemscorestandard,
           v_itemorder,
           v_typecode,
           v_itemmemo);
      END;
    ELSIF v_typestatus = 1 THEN
      --修改
      BEGIN
        UPDATE qcscoreitem
           SET itemname           = v_itemname,
               iteminstruction    = v_iteminstruction,
               itemdefaultscore   = v_itemdefaultscore,
               itemstandardscore  = v_itemstandardscore,
               itemcategory       = v_itemcategory,
               itemdefaulttarget  = v_itemdefaulttarget,
               itemtargetstandard = v_itemtargetstandard,
               itemscorestandard  = v_itemscorestandard,
               itemorder          = v_itemorder,
               typecode           = v_typecode,
               itemmemo           = v_itemmemo
         WHERE itemcode = v_itemcode;
      END;
    ELSIF v_typestatus = 2 THEN
      --删除
      BEGIN
        UPDATE qcscoreitem SET valide = 0 WHERE itemcode = v_itemcode;
      END;
    END IF;
  END;

  /***************************************************************************************/
  /*获取病历模板选择助手数据*/
  PROCEDURE usp_msquerytemplate(v_id         VARCHAR,
                                v_user       VARCHAR,
                                v_type       INT,
                                v_department VARCHAR DEFAULT '',
                                o_result     OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取病历模板选择助手数据
     功能说明
     输入参数
      v_InitStauts int     --初始化ID
      ,v_ID VARCHAR(12) --ModelDirectory.ID
      ,v_SortID VARCHAR(12) --Model_Docment.SortID
      ,v_Department varchar(12)   --科室ID
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_MSQueryTemplate  0,'RM0',''
     修改记录
    **********/
    v_sql VARCHAR(400);
  BEGIN
    IF v_type = 0 THEN
      BEGIN
        v_sql := 'SELECT ID AS TemplateID ,Name, null SortID from ModelDirectory
WHERE Valid = 1 AND ID IN (' || v_id || ')';

        OPEN o_result FOR v_sql;
      END;
    ELSIF v_type = 1 THEN
      BEGIN
        v_sql := 'SELECT a.ID AS TemplateID,a.Name, a.SortID, b.Memo from Model_Docment a,Template_Department b
WHERE a.ID=b.TemplateID and a.Valid = 1 AND a.SortID like ''' || v_id ||
                 '%'' and b.Department =''' || v_department ||
                 '''  order by a.SortID ';

        OPEN o_result FOR v_sql;
      END;
    ELSIF v_type = 2 THEN
      OPEN o_result FOR
        SELECT ID AS templateid, NAME, NULL sortid
          FROM modeldirectory
         WHERE valid = 1
           AND ID = v_id;
    ELSIF v_type = 3 THEN
      OPEN o_result FOR
        SELECT ID AS templateid, NAME, NULL sortid
          FROM templatesort_person
         WHERE mark = '0'
           AND valid = '1'
           AND userid = v_user;
    ELSIF v_type = 4 THEN
      OPEN o_result FOR
        SELECT templateid, NAME, sortid
          FROM template_person
         WHERE sortid = v_id
           AND valid = '1'
           AND userid = v_user;
    END IF;
  END;

  /***************************************************************************************/
  /*
  * 更改用户密码
  *
  */
  PROCEDURE usp_updateuserpassword(v_id      IN users.ID%TYPE,
                                   v_passwd  IN users.passwd%TYPE,
                                   v_regdate IN users.regdate%TYPE) IS
  BEGIN
    UPDATE users
       SET passwd = v_passwd, regdate = v_regdate
     WHERE ID = v_id;
  END;

  /***************************************************************************************/
  /*
  * 得到用户帐户信息
  */
  PROCEDURE usp_getuseraccount(v_id     IN users.ID%TYPE,
                               o_result OUT empcurtyp) IS
  BEGIN
    OPEN o_result FOR
      SELECT d.ID        userid,
             d.NAME      username,
             d.passwd,
             d.deptid,
             d.wardid,
             b.NAME      deptname,
             c.NAME      wardname,
             d.regdate,
             d.ID,
             d.jobid,
             d.valid,
             tu.masterid,
             tu.memo,
             d.status
        FROM users d
        LEFT JOIN department b
          ON d.deptid = b.ID
        LEFT JOIN ward c
          ON d.wardid = c.ID
        LEFT JOIN tempusers tu
          ON tu.userid = d.ID
         AND TO_DATE(tu.startdate || ' 00:00:00', 'yyyy-mm-dd HH24:mi:ss') <=
             SYSDATE
         AND TO_DATE(tu.enddate || ' 23:59:59', 'yyyy-mm-dd HH24:mi:ss') >=
             SYSDATE
       WHERE d.ID = v_id;
  END;

  /***************************************************************************************/
  /*
  * 取职工科室对应设置, 若未指定病区，则通过指定的科室关联出所有的病区
  */
  PROCEDURE usp_getuserdeptandward(v_userid IN users.ID%TYPE,
                                   o_result OUT empcurtyp) IS
  BEGIN
    OPEN o_result FOR
      SELECT a.deptid, b.NAME deptname, a.wardid, c.NAME wardname
        FROM user2dept a
        LEFT JOIN department b
          ON a.deptid = b.ID
        LEFT JOIN ward c
          ON a.wardid = c.ID
       WHERE userid = v_userid
      --AND deptid <> ''
      UNION
      SELECT DISTINCT a.deptid,
                      b.NAME       deptname,
                      c.outhosward wardid,
                      d.NAME       wardname
        FROM user2dept a, department b, inpatient c, ward d
       WHERE a.userid = v_userid
         AND a.deptid = b.ID
         AND (a.wardid IS NULL OR a.wardid = '')
         AND c.outhosdept = a.deptid
         AND c.status NOT IN (1500, 1503, 1508, 1509)
         AND c.outhosward = d.ID
       ORDER BY deptname, wardname;
  END;

  /***************************************************************************************/
  /*
  * 取在院病人的所有科室、病区对应关系
  */
  PROCEDURE usp_getuseroutdeptandward(o_result OUT empcurtyp) IS
  BEGIN
    OPEN o_result FOR
    /*SELECT DISTINCT a.outhosdept deptid,
                                          b.NAME       deptname,
                                          a.outhosward wardid,
                                          c.NAME       wardname
                            FROM inpatient a, department b, ward c
                           WHERE a.status NOT IN ('1500', '1503', '1508', '1509')
                             AND a.outhosdept = b.ID
                             AND a.outhosward = c.ID
                           ORDER BY deptid, wardid;*/
      SELECT distinct department.id   deptid,
                      department.name deptname,
                      ward.id         wardid,
                      ward.name       wardname
        from department, ward, dept2ward
       where department.id = dept2ward.deptid
         and dept2ward.wardid = ward.id
         and ward.valid = '1'
         and department.valid = '1';
  END;

  /******************************************************************************************************************
  ****************************************************************************************************************/
  /**使用到临时表的存储过程**/

  /*
  *获取职工相关信息
  */
  PROCEDURE usp_getuserinfo(v_userid  VARCHAR,
                            o_result  OUT empcurtyp,
                            o_result1 OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间  2011.5.10
     作者
     版权
     描述  获取职工相关信息
     功能说明
     输入参数
      v_userid 职工代码
     输出参数
     结果集、排序
     调用的sp
        usp_GetUserInfo '00'
     调用实例

    **********/
    v_status   INT;
    v_masterid VARCHAR(16);
    v_flag     INT DEFAULT - 1;
    v_sql      VARCHAR(4000);
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    OPEN o_result1 FOR
      SELECT '' FROM DUAL;

    /*create table tmp_getuserinfo(
    userid    varchar(12) null,
    masterid  varchar(12) null,
    status    int      null
    );*/
    v_sql := 'truncate table tmp_getuserinfo ';

    EXECUTE IMMEDIATE v_sql;

    INSERT INTO tmp_getuserinfo
      SELECT a.ID, b.masterid, a.status
        FROM users a
        LEFT JOIN tempusers b
          ON a.ID = b.userid
       WHERE a.ID = v_userid;

    SELECT status INTO v_status FROM tmp_getuserinfo;

    SELECT masterid INTO v_masterid FROM tmp_getuserinfo;

    IF (v_status = 0) THEN
      --此账号为临时账号
      BEGIN
        SELECT 1
          INTO v_flag
          FROM tempusers
         WHERE userid = v_userid
           AND startdate < SYSDATE
           AND enddate > SYSDATE;

        IF v_flag > 0 THEN
          BEGIN
            OPEN o_result FOR
              SELECT '该账号尚未启用' FROM DUAL;

            RETURN;
          END;
        END IF;
      END;
    END IF;

    --捞取用户基本信息
    OPEN o_result FOR
      SELECT d.status,
             d.ID       userid,
             a.masterid masterid,
             d.NAME     username,
             d.passwd,
             d.deptid,
             d.wardid,
             b.NAME     deptname,
             c.NAME     wardname,
             d.regdate,
             d.ID,
             d.jobid,
             d.valid
        FROM tmp_getuserinfo a, users d
        LEFT JOIN department b
          ON d.deptid = b.ID
        LEFT JOIN ward c
          ON d.wardid = c.ID
       WHERE a.userid = d.ID;

    --捞取用户科室信息
    IF (v_userid = '00') THEN
      BEGIN
        OPEN o_result FOR
          SELECT DISTINCT a.outhosdept deptid,
                          b.NAME       deptname,
                          a.outhosward wardid,
                          c.NAME       wardname
            FROM inpatient a, department b, ward c
           WHERE a.status NOT IN (1500, 1503, 1508, 1509)
             AND a.outhosdept = b.ID
             AND a.outhosward = c.ID
           ORDER BY deptid, wardid;
      END;
    ELSE
      BEGIN
        --如果是临时用户则捞取其附属老师的账号信息
        IF (v_status = 1) THEN
          v_masterid := v_userid;

          OPEN o_result FOR
            SELECT a.deptid, b.NAME deptname, a.wardid, c.NAME wardname
              FROM user2dept a
              LEFT JOIN department b
                ON a.deptid = b.ID
              LEFT JOIN ward c
                ON a.wardid = b.ID
             WHERE userid = v_masterid
               AND deptid <> ''
            UNION
            SELECT DISTINCT a.deptid,
                            b.NAME       deptname,
                            c.outhosward wardid,
                            d.NAME       wardname
              FROM user2dept a, department b, inpatient c, ward d
             WHERE a.userid = v_masterid
               AND a.deptid = b.ID
               AND (a.wardid IS NULL OR a.wardid = '')
               AND c.outhosdept = a.deptid
               AND c.status NOT IN (1500, 1503, 1508, 1509)
               AND c.outhosward = d.ID
             ORDER BY deptname, wardname;
        END IF;
      END;
    END IF;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_nursrecordoperate(v_id        NUMERIC DEFAULT 0, --记录ID
                                  v_noofinpat NUMERIC DEFAULT 0, --首页序号(住院流水号)
                                  v_sortid    NUMERIC DEFAULT 0, --模板分类代码
                                  v_type      INT, --操作类型
                                  o_result    OUT empcurtyp) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间]2011-06-10
    [作者]hjh
    [版权]
    [描述]护理
    [功能说明]
    [输入参数]
    [输出参数]
    [结果集、排序]


    [调用的sp]
    [调用实例]

    [修改记录]
    **********/
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    IF v_type = 1 THEN
      --打开模板
      OPEN o_result FOR
        SELECT content
          FROM template_table
         WHERE valid = 1
           AND ID = v_id;
    ELSIF v_type = 2 THEN
      --打开病人护理单
      OPEN o_result FOR
        SELECT *
          FROM nursrecordtable
         WHERE valid = 1
           AND noofinpat = v_noofinpat
           AND ID = v_id;
    ELSIF v_type = 3 THEN
      --从数据库中读取模板信息列表
      OPEN o_result FOR
        SELECT tts.NAME AS sortname, tt.*
          FROM template_table tt
          LEFT JOIN templatetablesort tts
            ON tts.ID = tt.sortid
         WHERE tt.valid = 1
           AND (v_sortid = 0 OR tt.sortid = v_sortid)
         ORDER BY tt.sortid;
    ELSIF v_type = 4 THEN
      --获取病人会理表单
      OPEN o_result FOR
        SELECT *
          FROM nursrecordtable
         WHERE valid = 1
           AND noofinpat = v_noofinpat
         ORDER BY NAME;
    ELSIF v_type = 5 THEN
      --删除模板
      UPDATE template_table SET valid = 0 WHERE ID = v_id;
    ELSIF v_type = 6 THEN
      --删除病历护理表单
      UPDATE nursrecordtable
         SET valid = 0
       WHERE ID = v_id
         AND noofinpat = v_noofinpat;
    ELSIF v_type = 7 THEN
      --获取护理文档模板分类
      OPEN o_result FOR
        SELECT * FROM templatetablesort WHERE valid = 1 ORDER BY ID;
    END IF;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_medqcanalysis(v_datetimebegin VARCHAR, --查询开始日期
                              v_datetimeend   VARCHAR, --查询结束日期
                              o_result        OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间   2011-03-03
     作者     yxy
     版权     YidanSoft
     描述  医疗质量统计分析
     功能说明
     输入参数
     输出参数
     结果集、排序
    医疗质量统计分析

     调用的sp
     调用实例
    usp_MedQCAnalysis   '2009-11-25','2010-11-25'
     修改记录
        Medical quality statistic analysis


    **********/
    v_sql VARCHAR2(4000);
  BEGIN
    --DeptCode DeptName InHos NewInHos NewOutHos BedCnt  EmptyBedCnt  AddBedCnt DieCnt SurgeryCnt GraveCnt OutHosFail
    --创建医疗统计分析临时表
    /*  create table #temptable(DeptCode varchar(10) COLLATE Chinese_PRC_BIN
    NOT NULL, --科室代码
    DeptName varchar(100) NOT NULL, --科室名称
    InHos int null, --在院病人
    NewInHos int null, --新入院病人
    NewOutHos int null, --新出院病人
    BedCnt int null, --床位数
    EmptyBedCnt int null, --空床位数
    AddBedCnt int null, --加床数
    DieCnt int null, --死亡人数
    SurgeryCnt int null, --手术人数
    GraveCnt int null, --危重数
    OutHosFail int null --出院未提交数
    );*/
    v_sql := 'truncate table tmp_MedQCAnalysis ';

    EXECUTE IMMEDIATE v_sql;

    --插入挂有病区的科室
    INSERT INTO tmp_medqcanalysis
      (deptcode, deptname)
      SELECT dept.ID, dept.NAME
        FROM department dept
       WHERE EXISTS
       (SELECT 1 FROM dept2ward ward WHERE dept.ID = ward.deptid);

    --更新在院人数
    UPDATE tmp_medqcanalysis
       SET inhos = NVL((SELECT COUNT(1)
                         FROM inpatient inp
                        WHERE inp.status IN (1500, 1501, 1505, 1506, 1507) --, 1504
                             --                        AND CONVERT(varchar(10),inp.AdmitDate,102) >= v_DateTimeBegin
                             --                        AND CONVERT(varchar(10),inp.AdmitDate,102) <= v_DateTimeEnd
                          AND inp.outhosdept = deptcode),
                       0);

    --新入院病人
    UPDATE tmp_medqcanalysis
       SET newinhos = NVL((SELECT COUNT(1)
                            FROM inpatient inp
                           WHERE inp.status IN (1500, 1501) --,1504, 1505, 1506, 1507
                             AND trunc(TO_DATE(inp.admitdate,
                                               'yyyy-MM-dd hh24:mi:ss')) >=
                                 TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
                             AND trunc(TO_DATE(inp.admitdate,
                                               'yyyy-MM-dd hh24:mi:ss')) <=
                                 TO_DATE(v_datetimeend, 'yyyy-MM-dd')
                             AND inp.outhosdept = deptcode),
                          0);

    --新出院病人
    UPDATE tmp_medqcanalysis
       SET newouthos = NVL((SELECT COUNT(1)
                             FROM inpatient inp
                            WHERE inp.status IN (1502, 1503)
                              AND trunc(TO_DATE(inp.admitdate,
                                                'yyyy-MM-dd hh24:mi:ss')) >=
                                  TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
                              AND trunc(TO_DATE(inp.admitdate,
                                                'yyyy-MM-dd hh24:mi:ss')) <=
                                  TO_DATE(v_datetimeend, 'yyyy-MM-dd')
                              AND inp.outhosdept = deptcode),
                           0);

    --床位数
    UPDATE tmp_medqcanalysis
       SET bedcnt = NVL((SELECT COUNT(1)
                          FROM bed bed
                         WHERE bed.valid = 1
                           AND bed.deptid = deptcode),
                        0);

    --空床位数
    UPDATE tmp_medqcanalysis
       SET emptybedcnt = NVL((SELECT COUNT(1)
                               FROM bed bed
                              WHERE bed.valid = 1
                                AND bed.inbed = 1300
                                AND bed.deptid = deptcode),
                             0);

    --加床数
    UPDATE tmp_medqcanalysis
       SET addbedcnt = NVL((SELECT COUNT(1)
                             FROM bed bed
                            WHERE bed.valid = 1
                              AND bed.style = 1202
                              AND bed.deptid = deptcode),
                           0);

    --死亡人数  （。。。）
    UPDATE tmp_medqcanalysis
       SET diecnt = NVL((SELECT COUNT(1)
                          FROM inpatient inp
                          left join iem_mainpage_basicinfo_2012 imb
                            on imb.noofinpat = inp.noofinpat
                         WHERE inp.status IN /*杨伟康 修改应包含出院的*/
                               (1500,
                                1501,
                                1502,
                                1503,
                                1504,
                                1505,
                                1506,
                                1507)
                           AND trunc(TO_DATE(inp.admitdate,
                                             'yyyy-MM-dd hh24:mi:ss')) >=
                               TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
                           AND trunc(TO_DATE(inp.admitdate,
                                             'yyyy-MM-dd hh24:mi:ss')) <=
                               TO_DATE(v_datetimeend, 'yyyy-MM-dd')
                           and imb.outhostype = '5'
                              /*AND SYSDATE -
                              to_date(inp.admitdate,
                                      'yyyy-MM-dd hh24:mi:ss') > 30*/
                           AND inp.outhosdept = deptcode),
                        0);

    --手术病人
    UPDATE tmp_medqcanalysis
    /*SET surgerycnt = NVL((SELECT COUNT(1)
      FROM inpatient inp
     WHERE inp.status IN
           (1500, 1501, 1504, 1505, 1506, 1507)
       AND trunc(TO_DATE(inp.admitdate,
                         'yyyy-MM-dd hh24:mi:ss')) >=
           TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
       AND trunc(TO_DATE(inp.admitdate,
                         'yyyy-MM-dd hh24:mi:ss')) <=
           TO_DATE(v_datetimeend, 'yyyy-MM-dd')
       AND SYSDATE -
           to_date(inp.admitdate,
                   'yyyy-MM-dd hh24:mi:ss') > 30
       AND inp.outhosdept = deptcode),
    0);*/

    ---edit by ywk 2012年10月12日 10:21:47

    /*select count (*) from(select inp.noofinpat,inp.outhosdept
     FROM inpatient inp
     left join iem_mainpage_basicinfo_2012 bas on inp.noofinpat=bas.noofinpat
     left join iem_mainpage_operation_2012 ope on bas.iem_mainpage_no=bas.iem_mainpage_no
    WHERE inp.status IN
          (1500, 1501, 1504, 1505, 1506, 1507) and ope.operation_code is not null and inp.outhosdept='2401'
          group by inp.noofinpat,inp.outhosdept)*/

    ---edit by 王冀 2012年10月26日
    /*  SET surgerycnt=nvl((SELECT COUNT(1) from  ( select * from (select inp.noofinpat  noo,inp.outhosdept
       FROM inpatient inp
       left join iem_mainpage_basicinfo_2012 bas on inp.noofinpat=bas.noofinpat
       left join iem_mainpage_operation_2012 ope on ope.iem_mainpage_no=bas.iem_mainpage_no
      WHERE inp.outhosdept = deptcode and  inp.status IN (1500, 1501, 1504, 1505, 1506, 1507)
      and ope.operation_code is not null
         AND trunc(TO_DATE(inp.admitdate,
                      'yyyy-MM-dd hh24:mi:ss')) >=
        TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
    AND trunc(TO_DATE(inp.admitdate,
                      'yyyy-MM-dd hh24:mi:ss')) <=
        TO_DATE(v_datetimeend, 'yyyy-MM-dd')  group by inp.noofinpat,inp.outhosdept)A  where A.outhosdept=deptcode )),0);*/
    /*(select count(*)
    from (select inp.noofinpat noo, inp.outhosdept
            FROM inpatient inp
            left join iem_mainpage_basicinfo_2012 bas
              on inp.noofinpat = bas.noofinpat
            left join iem_mainpage_operation_2012 ope
              on ope.iem_mainpage_no =
                 bas.iem_mainpage_no
           WHERE inp.outhosdept = deptcode
             and inp.status IN (1500,
                                1501,
                                1504,
                                1505,
                                1506,
                                1507)
             and ope.operation_code is not null
             AND trunc(TO_DATE(inp.admitdate,
                               'yyyy-MM-dd hh24:mi:ss')) >=
                 TO_DATE(v_datetimebegin,
                         'yyyy-MM-dd')
             AND trunc(TO_DATE(inp.admitdate,
                               'yyyy-MM-dd hh24:mi:ss')) <=
                 TO_DATE(v_datetimeend,
                         'yyyy-MM-dd')
           group by inp.noofinpat, inp.outhosdept))*/

       SET surgerycnt = nvl((select count(distinct(inp.noofinpat))
                              FROM inpatient inp
                              left join iem_mainpage_basicinfo_2012 bas
                                on inp.noofinpat = bas.noofinpat
                              left join iem_mainpage_operation_2012 ope
                                on ope.iem_mainpage_no = bas.iem_mainpage_no
                             WHERE inp.outhosdept = deptcode
                               and inp.status IN (1500,
                                                  1501,
                                                  1502,
                                                  1503,
                                                  1504,
                                                  1505,
                                                  1506,
                                                  1507)
                               and ope.operation_code is not null
                               AND trunc(TO_DATE(inp.admitdate,
                                                 'yyyy-MM-dd hh24:mi:ss')) >=
                                   TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
                               AND trunc(TO_DATE(inp.admitdate,
                                                 'yyyy-MM-dd hh24:mi:ss')) <=
                                   TO_DATE(v_datetimeend, 'yyyy-MM-dd')),
                            0);

    --危重病人
    UPDATE tmp_medqcanalysis
       SET gravecnt = NVL((SELECT COUNT(1)
                            FROM inpatient inp
                           WHERE inp.criticallevel = 1
                             AND inp.status IN
                                 (1500, 1501, 1504, 1505, 1506, 1507)
                             AND trunc(TO_DATE(inp.admitdate,
                                               'yyyy-MM-dd hh24:mi:ss')) >=
                                 TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
                             AND trunc(TO_DATE(inp.admitdate,
                                               'yyyy-MM-dd hh24:mi:ss')) <=
                                 TO_DATE(v_datetimeend, 'yyyy-MM-dd')
                             AND inp.outhosdept = deptcode),
                          0);

    --出院未提交
    UPDATE tmp_medqcanalysis
    /*   SET outhosfail = NVL((SELECT COUNT(1)
      FROM inpatient inp
     WHERE inp.status IN (1502, 1503)
       AND trunc(TO_DATE(inp.admitdate,
                         'yyyy-MM-dd hh24:mi:ss')) >=
           TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
       AND trunc(TO_DATE(inp.admitdate,
                         'yyyy-MM-dd hh24:mi:ss')) <=
           TO_DATE(v_datetimeend, 'yyyy-MM-dd')
       AND inp.outhosdept = deptcode),
    0);*/

    -----edit by ywk 2012年10月12日 09:59:53

    -----edit by wj 2012年10月26日  注释
    /* select decode(count(b.id), 0 ,'未写','书写' ) RECORDSTATE,
          '' QC ,
          a.NoOfInpat AS NOOFINPAT,
          a.PatID as PATID,
          a.Name PATNAME,
          decode(a.sexid,1,'男',2,'女','未知') PATSEX,
          1 AS INHOSPITAL,
          dept.name DEPTNAME,
          diag.name PATDIAGNAME,
          a.admitdate INHOSPITALTIME,
          a.outhosdate OUTHOSPITALTIME,
          to_char(to_date(a.admitdate,'yyyy-mm-dd HH24:mi:ss') + 1, 'yyyy-mm-dd') SUREDIAGTIME,
          users.name DOCNAME,
          a.AgeStr PATAGE,
          datediff('dd',a.admitdate, NVL(trim(a.outwarddate), TO_CHAR(SYSDATE, 'yyyy-mm-dd'))) INCOUNT
     from INPATIENT    a,
          RecordDetail b,
          diagnosis    diag,
          department   dept,
          users        users
    where a.NOOFINPAT = b.NoOfInpat(+)
      and a.AdmitDiagnosis = diag.markid(+)
      and a.outhosdept = dept.id(+)
      and a.Resident = users.id(+)
      and a.status in (1502, 1503)
      and b.hassubmit = 4600
      AND trunc(TO_DATE(a.admitdate,'yyyy-MM-dd hh24:mi:ss')) >= TO_DATE('2001-01-01', 'yyyy-MM-dd')
      AND trunc(TO_DATE(a.admitdate,'yyyy-MM-dd hh24:mi:ss')) <= TO_DATE('2012-11-11', 'yyyy-MM-dd')
      AND a.outhosdept =2401
    group by a.NoOfInpat,
             a.PatID,
             a.NAME,
             a.SEXID,
             A.AGESTR,
             a.OUTBED,
             a.AdmitDiagnosis,
             a.admitdate,
             a.outwarddate,
             diag.name,
             dept.name,
             a.outhosdate,
             users.name*/
    /* SET outhosfail = NVL((select count(*)
      from (select (case
                     when count(b.ID) > 0 then
                      '书写'
                     else
                      '未写'
                   end) RECORDSTATE,
                   '' QC,
                   a.NoOfInpat AS NOOFINPAT,
                   a.PatID as PATID,
                   a.Name PATNAME,
                   (case
                     when a.SexID = 1 then
                      '男'
                     when a.SexID = 2 then
                      '女'
                     else
                      '未知'
                   end) as PATSEX,
                   1 AS INHOSPITAL,
                   dept.name DEPTNAME,
                   diag.name PATDIAGNAME,
                   a.admitdate INHOSPITALTIME,
                   a.outhosdate OUTHOSPITALTIME,
                   to_char(to_date(a.admitdate,
                                   'yyyy-mm-dd HH24:mi:ss') + 1,
                           'yyyy-mm-dd') SUREDIAGTIME,
                   users.name DOCNAME,
                   a.AgeStr PATAGE,
                   datediff('dd',
                            a.admitdate,
                            NVL(trim(a.outwarddate),
                                TO_CHAR(SYSDATE,
                                        'yyyy-mm-dd'))) INCOUNT
              from INPATIENT    a,
                   RecordDetail b,
                   diagnosis    diag,
                   department   dept,
                   users        users
             where a.NOOFINPAT = b.NoOfInpat(+)
               and a.AdmitDiagnosis = diag.markid(+)
               and a.outhosdept = dept.id(+)
               and a.Resident = users.id(+)
               and a.status in (1502, 1503)
               and b.hassubmit = 4600
               AND trunc(TO_DATE(a.admitdate,
                                 'yyyy-MM-dd hh24:mi:ss')) >=
                   TO_DATE(v_datetimebegin,
                           'yyyy-MM-dd')
               AND trunc(TO_DATE(a.admitdate,
                                 'yyyy-MM-dd hh24:mi:ss')) <=
                   TO_DATE(v_datetimeend,
                           'yyyy-MM-dd')
               AND a.outhosdept = deptcode
             group by a.NoOfInpat,
                      a.PatID,
                      a.NAME,
                      a.SEXID,
                      A.AGESTR,
                      a.OUTBED,
                      a.AdmitDiagnosis,
                      a.admitdate,
                      a.outwarddate,
                      diag.name,
                      dept.name,
                      a.outhosdate,
                      users.name)),
    0);*/
       SET outhosfail = NVL((select count(distinct(a.NoOfInpat))
                              from INPATIENT    a,
                                   RecordDetail b,
                                   diagnosis    diag,
                                   department   dept,
                                   users        users
                             where a.NOOFINPAT = b.NoOfInpat(+)
                               and a.AdmitDiagnosis = diag.markid(+)
                               and a.outhosdept = dept.id(+)
                               and a.Resident = users.id(+)
                               and a.status in (1502, 1503)
                               and b.hassubmit = 4600
                               AND trunc(TO_DATE(a.admitdate,
                                                 'yyyy-MM-dd hh24:mi:ss')) >=
                                   TO_DATE(v_datetimebegin, 'yyyy-MM-dd')
                               AND trunc(TO_DATE(a.admitdate,
                                                 'yyyy-MM-dd hh24:mi:ss')) <=
                                   TO_DATE(v_datetimeend, 'yyyy-MM-dd')
                               AND a.outhosdept = deptcode),
                            0);

    --杜总要求演示假数据---test by ywk  2012年10月8日 17:28:55
    /* update tmp_medqcanalysis
    set inhos       = trunc(dbms_random.value(0, 100), 0),
        newinhos    = trunc(dbms_random.value(0, 30), 0),
        newouthos   = trunc(dbms_random.value(0, 20), 0),
        bedcnt      = trunc(dbms_random.value(100, 200), 0),
        emptybedcnt = trunc(dbms_random.value(0, 100), 0),
        addbedcnt   = trunc(dbms_random.value(0, 100), 0),
        diecnt      = trunc(dbms_random.value(0, 20), 0),
        surgerycnt  = trunc(dbms_random.value(0, 100), 0),
        gravecnt    = trunc(dbms_random.value(0, 20), 0),
        outhosfail  = trunc(dbms_random.value(20, 50), 0),
        kssr        = trunc(dbms_random.value(100000, 800000), 0),
        yzb         = trunc(dbms_random.value(10, 40), 0);*/

    OPEN o_result FOR
      SELECT '_' deptcode,
             '总计' deptname,
             SUM(inhos) inhos,
             SUM(newinhos) newinhos,
             SUM(newouthos) newouthos,
             SUM(bedcnt) bedcnt,
             SUM(emptybedcnt) emptybedcnt,
             SUM(addbedcnt) addbedcnt,
             SUM(diecnt) diecnt,
             SUM(surgerycnt) surgerycnt,
             SUM(gravecnt) gravecnt,
             SUM(outhosfail) outhosfail,
             SUM(kssr) kssr,
             ceil(SUM(yzb) / count(1)) yzb
        FROM tmp_medqcanalysis
      UNION ALL
      SELECT deptcode,
             deptname,
             inhos,
             newinhos,
             newouthos,
             bedcnt,
             emptybedcnt,
             addbedcnt,
             diecnt,
             surgerycnt,
             gravecnt,
             outhosfail,
             kssr,
             yzb
        FROM tmp_medqcanalysis;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_querybrowserinwardpatients(v_id        VARCHAR,
                                           v_querytype INT,
                                           v_wardid    VARCHAR,
                                           v_deptids   VARCHAR,
                                           v_zyhm      VARCHAR DEFAULT '',
                                           v_hzxm      VARCHAR DEFAULT '',
                                           v_cyzd      VARCHAR DEFAULT '',
                                           v_ryrqbegin VARCHAR DEFAULT '',
                                           v_ryrqend   VARCHAR DEFAULT '',
                                           v_cyrqbegin VARCHAR DEFAULT '',
                                           v_cyrqend   VARCHAR DEFAULT '',
                                           o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取对应病区的床位信息(病区一览时调用）
    -- 功能说明
     输入参数
      v_Wardid   varchar(6)   --病区代码
      v_Deptids varchar(255)  --科室代码集合(形如: '代码1','代码2')
      v_zyhm  varchar(30)=''  --住院号
      v_hzxm  varchar(30)=''  --姓名
      v_cyzd  varchar(30)=''  --出院诊断
      v_cyrqbegin varchar(19)=''  --出院日期最小值
      v_cyrqend varchar(19)=''  --出院日期最大值
      v_ryrqbegin varchar(19)=''  --入院日期最小值
      v_ryrqend varchar(19)=''  --入院日期最大值
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例
     exec usp_QueryBrowserInwardPatients 0,0,'2911', '3202'
     修改记录
    护理级别待处理
    **********/
    v_existdata INTEGER;
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_wardid_in VARCHAR(40);
    v_sql       VARCHAR(4000);
  BEGIN
    v_sql := 'truncate table tmp_QueryBrowserinwardPat ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryBrowserInward_extraop ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryBrowserinwardPatExist ';

    EXECUTE IMMEDIATE v_sql;

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    SELECT COUNT(*)
      INTO v_existdata
      FROM doctor_assignpatient
     WHERE ID = v_id
       AND valid = 1;

    v_dqrq := TO_CHAR(SYSDATE, 'yyyy-mm-dd');
    v_ksrq := TO_CHAR(SYSDATE - 3, 'yyyy-mm-dd');
    v_jsrq := TO_CHAR(SYSDATE + 2, 'yyyy-mm-dd');
    v_now  := TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss');

    -- 先找出病人记录，然后读取病人的附加信息（手术、出院、转科等）
    INSERT INTO tmp_querybrowserinwardpat
      SELECT b.noofinpat  noofinpat, --首页序号
             b.patnoofhis patnoofhis, --HIS首页序号
             b.patid      patid,
             --住院号
             b.NAME   patname, --姓名
             b.sexid  sex, --病人性别
             b.sexid  sexname, --病人性别名称
             b.agestr agestr,
             --年龄
             b.py py, --拼音
             b.wb wb, --五笔
             b.status brzt, --病人状态
             RTRIM(b.criticallevel) wzjb,
             --危重级别
             i.NAME wzjbmc, --危重级别名称
             /*
             (CASE
               WHEN patid IS NULL THEN
                ''
               ELSE
                '一级护理'
             END) hljb, --护理级别
             */

             case b.attendlevel
               when '1' then
                '一级护理'
               when '2' then
                '二级护理'
               when '3' then
                '三级护理'
               when '4' then
                '特级护理'
               else
                '一级护理'
             end hljb, --护理级别

             b.isbaby yebz, --婴儿标志
             a.wardid bqdm, --病区代码
             a.deptid ksdm,
             --科室代码
             --a.ID           bedid, --床位代码
             b.outbed       bedid, --床位代码
             a.formerward   ybqdm, --原病区代码
             a.formerdeptid yksdm,
             --原科室代码
             a.formerdeptid ycwdm, --原床位代码
             a.inbed inbed, --占床标志
             a.borrow jcbz, --借床标志
             a.sexinfo cwlx, --床位类型
             SUBSTR(b.admitdate, 1, 16) admitdate,
             --入院日期
             f.NAME     ryzd, --入院诊断
            b.admitdiagnosis    zdmc, --诊断名称
             b.resident zyysdm, --住院医生代码
             c.NAME     zyys,
             --住院医生
             c.NAME  cwys, --床位医生
             g.NAME  zzys, --主治医师
             h.NAME  zrys, --主任医师
             a.valid yxjl, --有效记录
             --me.pzlx pzlx, --凭证类型
             dd1.NAME pzlx, --费用类别
             TO_CHAR(CASE
                       WHEN INSTR(v_deptids, a.deptid) = 0 AND (b.noofinpat IS NULL) THEN
                        '属于其它科室'
                       ELSE
                        ''
                     END) extra, --额外信息
             b.memo memo, --备注
             (CASE b.cpstatus
               WHEN 0 THEN
                '未引入'
               WHEN 1 THEN
                '执行中'
               WHEN 2 THEN
                '退出'
             END) cpstatus,
             (SELECT CASE
                       WHEN COUNT(qc.foulstate) > 0 THEN
                        '是'
                       ELSE
                        '否'
                     END
                FROM qcrecord qc
               WHERE qc.noofinpat = b.noofinpat
                 AND qc.valid = 1
                 AND qc.foulstate = 1) AS iswarn, --是否违规
             100 ye --余额
        FROM bed a
        LEFT JOIN inpatient b
          ON a.noofinpat = b.noofinpat
         AND a.patnoofhis = b.patnoofhis
         AND INSTR(v_deptids, RTRIM(b.outhosdept)) > 0
         AND a.inbed = 1301
      --LEFT JOIN medicareinfo me ON b.voucherscode = me.ID

        LEFT JOIN Dictionary_detail dd1
          ON dd1.categoryid = '1'
         AND b.payid = dd1.detailid
      --   left join YY_SFXXMK e  on b.AttendLevel = e.sfxmdm
        LEFT JOIN diagnosis f
          ON f.icd = b.admitdiagnosis
        LEFT JOIN users c
          ON c.ID = b.resident
        LEFT JOIN dictionary_detail i
          ON i.detailid = b.criticallevel
         AND i.categoryid = '53'
        LEFT JOIN users g
          ON g.ID = a.attend
        LEFT JOIN users h
          ON h.ID = a.chief
        LEFT JOIN dictionary_detail j
          ON j.detailid = b.sexid
         AND j.categoryid = '3'
       WHERE a.wardid = v_wardid_in
         AND a.valid = 1;

    -- 检查手术信息:临时医嘱，已审核和已执行的，开始时间、手术时间在当前日期-3、+1之内
    INSERT INTO tmp_querybrowserinward_extraop
      SELECT a.noofinpat,
             datediff('dd', v_now, TO_CHAR(a.entrust, 'yyyy-mm-dd')) diff
        FROM temp_order a, tmp_querybrowserinwardpat b
       WHERE a.noofinpat = b.noofinpat
         AND a.startdate BETWEEN v_ksrq AND v_jsrq
         AND a.ordertype = 3105
         AND a.orderstatus IN (3201, 3202);

    UPDATE tmp_querybrowserinwardpat a
       SET extra =
           (SELECT a.extra || (CASE b.diff
                     WHEN 1 THEN
                      '明日手术'
                     WHEN 0 THEN
                      '今日手术'
                     WHEN -1 THEN
                      '术后1天'
                     WHEN -2 THEN
                      '术后2天'
                     WHEN -3 THEN
                      '术后3天'
                     ELSE
                      ''
                   END) || ' '
              FROM tmp_querybrowserinward_extraop b
             WHERE a.noofinpat = b.noofinpat
               AND ROWNUM <= 1);

    -- 检查出院医嘱:临时医嘱，已审核和已执行的，开始时间、出院时间在当前日期0时之后
    v_sql := 'truncate table tmp_QueryBrowserInward_extraop ';

    EXECUTE IMMEDIATE v_sql;

    INSERT INTO tmp_querybrowserinward_extraop
      SELECT a.noofinpat,
             datediff('dd', v_now, TO_CHAR(a.entrust, 'yyyy-mm-dd')) diff
        FROM temp_order a, tmp_querybrowserinwardpat b
       WHERE a.noofinpat = b.noofinpat
         AND a.startdate >= v_dqrq
         AND a.ordertype = 3113
         AND a.orderstatus IN (3201, 3202);

    UPDATE tmp_querybrowserinwardpat a
       SET extra =
           (SELECT a.extra || (CASE b.diff
                     WHEN 0 THEN
                      '今日出院'
                     WHEN 1 THEN
                      '明日出院'
                     ELSE
                      TO_CHAR(b.diff) || '天后出院'
                   END) || ' '
              FROM tmp_querybrowserinward_extraop b
             WHERE a.noofinpat = b.noofinpat
               AND ROWNUM <= 1);

    -- 检查转科医嘱:根据病人状态
    UPDATE tmp_querybrowserinwardpat a
       SET extra =
           (SELECT a.extra || b.NAME || ' '
              FROM categorydetail b
             WHERE b.categoryid = a.brzt
               AND ROWNUM < 1)
     WHERE a.brzt IN (1505, 1506, 1507);

    -- 检查病人是否有病历
    UPDATE tmp_querybrowserinwardpat a
       SET extra = a.extra || '无病历'
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS
     (SELECT 1 FROM recorddetail b WHERE a.noofinpat = b.noofinpat);

    IF v_querytype = 0 THEN
      --全部
      BEGIN
        OPEN o_result FOR
          SELECT * FROM tmp_querybrowserinwardpat order by bedid;
        --ORDER BY TO_CHAR(bedid, '0000');
      END;
    ELSE
      --分管
      IF (v_existdata = 0) THEN
        BEGIN
          OPEN o_result FOR
            SELECT * FROM tmp_querybrowserinwardpat order by bedid;
          --ORDER BY TO_CHAR(bedid, '0000');
        END;
      ELSE
        BEGIN
          INSERT INTO tmp_querybrowserinwardpatexist
            SELECT b.noofinpat  noofinpat, --首页序号
                   b.patnoofhis patnoofhis,
                   --HIS首页序号
                   b.patid  patid, --住院号
                   b.NAME   patname, --姓名
                   b.sexid  sex, --病人性别
                   b.sexid  sexname, --病人性别名称
                   b.agestr agestr, --年龄
                   b.py     py, --拼音
                   b.wb     wb,
                   --五笔
                   b.status brzt, --病人状态
                   RTRIM(b.criticallevel) wzjb,
                   --危重级别
                   i.NAME wzjbmc, --危重级别名称
                   /*
                   (CASE
                     WHEN patid IS NULL THEN
                      ''
                     ELSE
                      '一级护理'
                   END) hljb, --护理级别
                   */

                   case b.attendlevel
                     when '1' then
                      '一级护理'
                     when '2' then
                      '二级护理'
                     when '3' then
                      '三级护理'
                     when '4' then
                      '特级护理'
                     else
                      '一级护理'
                   end hljb, --护理级别

                   b.isbaby yebz, --婴儿标志
                   a.wardid bqdm, --病区代码
                   a.deptid ksdm, --科室代码
                   --a.ID         bedid, --床位代码
                   b.outbed     bedid, --床位代码
                   a.formerward ybqdm,
                   --原病区代码
                   a.formerdeptid yksdm, --原科室代码
                   a.formerdeptid ycwdm,
                   --原床位代码
                   a.inbed   inbed, --占床标志
                   a.borrow  jcbz, --借床标志
                   a.sexinfo cwlx,
                   --床位类型
                   SUBSTR(b.admitdate, 1, 16) admitdate, --入院日期
                   f.NAME ryzd,
                   --入院诊断
                   b.admitdiagnosis    zdmc, --诊断名称
                   b.resident zyysdm, --住院医生代码
                   c.NAME     zyys,
                   --住院医生
                   c.NAME  cwys, --床位医生
                   g.NAME  zzys, --主治医师
                   h.NAME  zrys, --主任医师
                   a.valid yxjl,
                   --有效记录
                   --me.pzlx pzlx, --凭证类型
                   dd1.NAME pzlx, --费用类别
                   TO_CHAR(CASE
                             WHEN INSTR(v_deptids, a.deptid) = 0 AND
                                  (b.noofinpat IS NULL) THEN
                              '属于其它科室'
                             ELSE
                              ''
                           END) extra, --额外信息
                   b.memo memo, --备注
                   100 ye --余额
              FROM doctor_assignpatient da
              LEFT JOIN bed a
                ON da.noofinpat = a.noofinpat
               AND a.valid = 1
              LEFT JOIN inpatient b
                ON a.noofinpat = b.noofinpat
               AND a.patnoofhis = b.patnoofhis
               AND INSTR(v_deptids, RTRIM(b.outhosdept)) > 0
               AND a.inbed = 1301
            --LEFT JOIN medicareinfo me ON b.voucherscode = me.ID
              LEFT JOIN Dictionary_detail dd1
                ON dd1.categoryid = '1'
               AND b.payid = dd1.detailid
            --   left join YY_SFXXMK e  on b.AttendLevel = e.sfxmdm
              LEFT JOIN diagnosis f
                ON f.icd = b.admitdiagnosis
              LEFT JOIN users c
                ON c.ID = b.resident
              LEFT JOIN dictionary_detail i
                ON i.detailid = b.criticallevel
               AND i.categoryid = '53'
              LEFT JOIN users g
                ON g.ID = a.attend
              LEFT JOIN users h
                ON h.ID = a.chief
              LEFT JOIN dictionary_detail j
                ON j.detailid = b.sexid
               AND j.categoryid = '3'
             WHERE da.ID = v_id
               AND da.valid = 1;

          -- 检查手术信息:临时医嘱，已审核和已执行的，开始时间、手术时间在当前日期-3、+1之内
          v_sql := 'truncate table tmp_QueryBrowserInward_extraop ';

          EXECUTE IMMEDIATE v_sql;

          INSERT INTO tmp_querybrowserinward_extraop
            SELECT a.noofinpat,
                   datediff('dd', v_now, TO_CHAR(SUBSTR(a.entrust, 1, 19))) diff
              FROM temp_order a, tmp_querybrowserinwardpatexist b
             WHERE a.noofinpat = b.noofinpat
               AND a.startdate BETWEEN v_ksrq AND v_jsrq
               AND a.ordertype = 3105
               AND a.orderstatus IN (3201, 3202);

          UPDATE tmp_querybrowserinwardpatexist a
             SET extra =
                 (SELECT a.extra || (CASE b.diff
                           WHEN 1 THEN
                            '明日手术'
                           WHEN 0 THEN
                            '今日手术'
                           WHEN -1 THEN
                            '术后1天'
                           WHEN -2 THEN
                            '术后2天'
                           WHEN -3 THEN
                            '术后3天'
                           ELSE
                            ''
                         END) || ' '
                    FROM tmp_querybrowserinward_extraop b
                   WHERE a.noofinpat = b.noofinpat
                     AND ROWNUM < 1);

          -- 检查出院医嘱:临时医嘱，已审核和已执行的，开始时间、出院时间在当前日期0时之后
          v_sql := 'truncate table tmp_QueryBrowserInward_extraop ';

          EXECUTE IMMEDIATE v_sql;

          INSERT INTO tmp_querybrowserinward_extraop
            SELECT a.noofinpat,
                   datediff('dd', v_now, TO_CHAR(a.entrust, 'yyyy-mm-dd')) diff
              FROM temp_order a, tmp_querybrowserinwardpatexist b
             WHERE a.noofinpat = b.noofinpat
               AND a.startdate >= v_dqrq
               AND a.ordertype = 3113
               AND a.orderstatus IN (3201, 3202);

          UPDATE tmp_querybrowserinwardpatexist a
             SET extra =
                 (SELECT a.extra || (CASE b.diff
                           WHEN 0 THEN
                            '今日出院'
                           WHEN 1 THEN
                            '明日出院'
                           ELSE
                            TO_CHAR(b.diff) || '天后出院'
                         END) || ' '
                    FROM tmp_querybrowserinward_extraop b
                   WHERE a.noofinpat = b.noofinpat
                     AND ROWNUM < 1);

          -- 检查转科医嘱:根据病人状态
          UPDATE tmp_querybrowserinwardpatexist a
             SET extra =
                 (SELECT a.extra || b.NAME || ' '
                    FROM categorydetail b
                   WHERE b.categoryid = a.brzt
                     AND ROWNUM < 1)
           WHERE a.brzt IN (1505, 1506, 1507);

          -- 检查病人是否有病历
          UPDATE tmp_querybrowserinwardpatexist a
             SET extra = a.extra || '无病历'
           WHERE noofinpat IS NOT NULL
             AND NOT EXISTS (SELECT 1
                    FROM recorddetail b
                   WHERE a.noofinpat = b.noofinpat);

          OPEN o_result FOR
            SELECT * FROM tmp_querybrowserinwardpatexist order by bedid;
          --ORDER BY TO_CHAR(bedid, '0000');
        END;
      END IF;
    END IF;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_queryhistorypatients(v_wardid          VARCHAR,
                                     v_deptids         VARCHAR,
                                     v_patid           VARCHAR DEFAULT '',
                                     v_patname         VARCHAR DEFAULT '',
                                     v_outdiagnosis    VARCHAR DEFAULT '',
                                     v_admitdatebegin  VARCHAR DEFAULT '',
                                     v_admitdatend     VARCHAR DEFAULT '',
                                     v_outhosdatebegin VARCHAR DEFAULT '',
                                     v_outhosdatend    VARCHAR DEFAULT '',
                                     o_result          OUT empcurtyp,
                                     o_result1         OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取对应病区的床位信息
     功能说明
     输入参数
      v_wardid   varchar(6)   --病区代码
      v_deptids varchar(255)  --科室代码集合(形如: '代码1','代码2')
      v_PatID  varchar(30)=''  --住院号
      v_PatName  varchar(30)=''  --姓名
      v_OutDiagnosis  varchar(30)=''  --出院诊断
      v_OutHosDatebegin varchar(19)=''  --出院日期最小值
      v_OutHosDatend varchar(19)=''  --出院日期最大值
      v_AdmitDatebegin varchar(19)=''  --入院日期最小值
      v_AdmitDatend varchar(19)=''  --入院日期最大值
     输出参数
     结果集、排序
    在本病区住过的病人的病人信息
    病人的历次住院信息

     调用的sp
     调用实例
     exec usp_QueryInwardPatients   '2922','3225'
     修改记录

    **********/
    v_wardid_in        VARCHAR2(6);
    v_npatid           VARCHAR(30);
    v_npatname         VARCHAR(30);
    v_noutdiagnosis    VARCHAR(19);
    v_nouthosdatebegin VARCHAR(19);
    v_nouthosdatend    VARCHAR(19);
    v_nadmitdatebegin  VARCHAR(19);
    v_nadmitdatend     VARCHAR(19);
    v_sql              VARCHAR(400);
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    OPEN o_result1 FOR
      SELECT '' FROM DUAL;

    v_sql := 'truncate table tmp_QueryHistory_pats ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryHistory_result ';

    EXECUTE IMMEDIATE v_sql;

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    --查询历史病人
    v_npatid           := RTRIM(v_patid);
    v_npatname         := RTRIM(v_patname);
    v_noutdiagnosis    := RTRIM(v_outdiagnosis);
    v_nouthosdatebegin := RTRIM(v_outhosdatebegin);
    v_nouthosdatend    := RTRIM(v_outhosdatend);
    v_nadmitdatebegin  := RTRIM(v_admitdatebegin);
    v_nadmitdatend     := RTRIM(v_admitdatend);

    -- 找出入院或出院是在本科室的病人（不分在院和出院）
    INSERT INTO tmp_queryhistory_pats
      SELECT DISTINCT innerpix
        FROM inpatient
       WHERE (outhosdept = v_deptids OR admitdept = v_deptids)
         AND (v_npatid = '' OR v_npatid IS NULL OR
             patid LIKE v_npatid || '%')
         AND (v_npatname = '' OR v_npatname IS NULL OR
             NAME LIKE v_npatname || '%')
         AND (v_noutdiagnosis = '' OR v_noutdiagnosis IS NULL OR
             outdiagnosis LIKE v_noutdiagnosis)
         AND (v_nouthosdatebegin = '' OR v_nouthosdatebegin IS NULL OR
             (outhosdate >= v_nouthosdatebegin AND
             outhosdate <= v_nouthosdatend))
         AND (v_nadmitdatebegin = '' OR v_nadmitdatebegin IS NULL OR
             (admitdate >= v_nadmitdatebegin AND
             admitdate <= v_nadmitdatend));

    -- 找出病人的历次住院信息
    INSERT INTO tmp_queryhistory_result
      SELECT b.noofinpat, --首页序号
             b.patnoofhis, --HIS首页序号
             b.patid, --住院号
             b.NAME, --姓名
             b.sexid, --病人性别
             b.nativeaddress, --户口地址
             SUBSTR(b.admitdate, 1, 20) admitdate,
             --入院日期
             c.NAME admitdept, --入院科室
             d.NAME admitward, --入院病区
            b.admitdiagnosis admitdiagnosis,
             --入院诊断
             SUBSTR(b.outhosdate, 1, 20) outhosdate, --出院日期
             f.NAME outhosdept,
             --出院科室
             g.NAME outhosward, --出院病区
             h.NAME outdiagnosis --出院诊断
        FROM tmp_queryhistory_pats a
        JOIN inpatient b
          ON a.innerpix = b.innerpix
         AND b.status IN (1502, 1503)
        LEFT JOIN department c
          ON b.admitdept = c.ID
        LEFT JOIN ward d
          ON b.outhosward = d.ID
        LEFT JOIN diagnosis e
          ON b.admitdiagnosis = e.icd
        LEFT JOIN department f
          ON b.outhosdept = f.ID
        LEFT JOIN ward g
          ON b.outhosward = g.ID
        LEFT JOIN diagnosis h
          ON b.outdiagnosis = h.icd;

    -- 首先返回基本信息记录
    OPEN o_result FOR
      SELECT patid, --住院号
             NAME, --姓名
             sexid, --病人性别
             nativeaddress --户口地址
        FROM tmp_queryhistory_result
       WHERE noofinpat IN (SELECT MAX(noofinpat)
                             FROM tmp_queryhistory_result
                            GROUP BY patid)
       ORDER BY patid;

    -- 再返回历次住院信息
    OPEN o_result1 FOR
      SELECT * FROM tmp_queryhistory_result ORDER BY patid, admitdate;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_queryinwardpatients_old(v_wardid    VARCHAR,
                                        v_deptids   VARCHAR,
                                        v_zyhm      VARCHAR DEFAULT '',
                                        v_hzxm      VARCHAR DEFAULT '',
                                        v_cyzd      VARCHAR DEFAULT '',
                                        v_ryrqbegin VARCHAR DEFAULT '',
                                        v_ryrqend   VARCHAR DEFAULT '',
                                        v_cyrqbegin VARCHAR DEFAULT '',
                                        v_cyrqend   VARCHAR DEFAULT '',
                                        --add by xjt
                                        v_id        VARCHAR DEFAULT '',
                                        v_querytype INT DEFAULT 0,
                                        v_querynur  VARCHAR DEFAULT '',
                                        v_querybed  VARCHAR DEFAULT 'Y',
                                        o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取对应病区的床位信息
     功能说明
     输入参数
      v_Wardid   varchar(6)   --病区代码
      v_Deptids varchar(255)  --科室代码集合(形如: '代码1','代码2')
      v_zyhm  varchar(30)=''  --住院号
      v_hzxm  varchar(30)=''  --姓名
      v_cyzd  varchar(30)=''  --出院诊断
      v_cyrqbegin varchar(19)=''  --出院日期最小值
      v_cyrqend varchar(19)=''  --出院日期最大值
      v_ryrqbegin varchar(19)=''  --入院日期最小值
      v_ryrqend varchar(19)=''  --入院日期最大值
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例
     exec usp_QueryInwardPatients  '2911', '3202','','','','','','','','',3,'Y'
     修改记录
    护理级别待处理
    **********/
    /*v_wardid_in VARCHAR(6);
        v_dqrq      VARCHAR(10);
        v_ksrq      VARCHAR(10);
        v_jsrq      VARCHAR(10);
        v_now       VARCHAR(24);
        v_sql       VARCHAR(4000);
      BEGIN
       \* v_sql := 'truncate table tmp_QueryInwardPatients ';

        EXECUTE IMMEDIATE v_sql;
    *\
        v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

        EXECUTE IMMEDIATE v_sql;

        IF v_wardid IS NULL THEN
          v_wardid_in := '';
        END IF;

        \*-- 先找出病人记录，然后读取病人的附加信息（手术、出院、转科等）
        INSERT INTO tmp_queryinwardpatients
          SELECT distinct b.noofinpat noofinpat, --首页序号
                 b.patnoofhis patnoofhis, --HIS首页序号
                 b.patid patid, --住院号
                 b.name patname, --姓名
                 b.sexid sex, --病人性别
                 j.name sexname, --病人性别名称
                 b.agestr agestr, --年龄
                 b.py py, --拼音
                 b.wb wb, --五笔
                 b.status brzt, --病人状态
                 e.name brztname, --病人状态名称
                 RTRIM(b.criticallevel) wzjb, --危重级别
                 i.name wzjbmc, --危重级别名称
                 case b.attendlevel
                   when '1' then
                    '一级护理'
                   when '2' then
                    '二级护理'
                   when '3' then
                    '三级护理'
                   when '4' then
                    '特级护理'
                   else
                    '一级护理'
                 end hljb, --护理级别

                 case b.attendlevel
                   when '1' then
                    '6101'
                   when '2' then
                    '6102'
                   when '3' then
                    '6103'
                   when '4' then
                    '6104'
                   else
                    '6101'
                 end attendlevel, --护理级别
                 b.isbaby yebz, --婴儿标志
                 CASE
                   WHEN b.isbaby = '0' THEN
                    '否'
                   WHEN b.isbaby IS NULL THEN
                    ''
                   ELSE
                    '是'
                 END yebzname,
                 b.outhosward bqdm, --病区代码
                 b.outhosdept ksdm, --科室代码
                 case when length(b.outbed) = 1 then '0' || b.outbed else b.outbed end bedid, --床位代码
                 dg.NAME ksmc, --科室名称
                 wh.NAME bqmc, --病区名称
                 a.formerward ybqdm, --原病区代码
                 a.formerdeptid yksdm, --原科室代码
                 a.formerdeptid ycwdm, --原床位代码
                 --a.inbed inbed, --占床标志
                 '' inbed,--占床标志 add by ywk  2012年11月5日15:02:39
                 a.borrow jcbz, --借床标志
                 a.sexinfo cwlx, --床位类型
                 SUBSTR(b.admitdate, 1, 16) admitdate, --入院日期
                 f.NAME ryzd, --入院诊断
                 f.NAME zdmc, --诊断名称
                 b.resident zyysdm, --住院医生代码
                 c.NAME zyys, --住院医生
                 c.NAME cwys, --床位医生
                 g.NAME zzys, --主治医师
                 h.NAME zrys, --主任医师
                 a.valid yxjl, --有效记录
                 --me.pzlx pzlx, --凭证类型
                 dd1.NAME pzlx, --费用类别
                 CASE
                   WHEN b.outhosdept = v_deptids AND b.outhosward = v_wardid THEN
                    '本科室'
                   ELSE
                    '属于其他科室'
                 END extra, --额外信息
                 b.memo memo, --备注
                 CASE b.cpstatus
                   WHEN 0 THEN
                    '未引入'
                   WHEN 1 THEN
                    '执行中'
                   WHEN 2 THEN
                    '退出'
                 END cpstatus,
                 CASE
                   WHEN b.noofinpat IS NULL THEN
                    ''
                   ELSE
                    '己书写'
                 END recordinfo,
                 100 ye, --余额
                 (SELECT CASE
                           WHEN COUNT(qc.foulstate) > 0 THEN
                            '是'
                           ELSE
                            '否'
                         END
                    FROM qcrecord qc
                   WHERE qc.noofinpat = b.noofinpat
                     AND qc.valid = 1
                     AND qc.foulstate = 1) AS iswarn, --是否违规
                 b.incount as rycs --入院次数
            FROM inpatient b
           LEFT JOIN bed a ON a.id = b.outbed
           AND a.deptid = v_deptids AND a.wardid = v_wardid
           AND a.noofinpat = b.noofinpat AND a.valid = '1'
            LEFT JOIN Dictionary_detail dd1 ON dd1.categoryid = '1'
                                           AND b.payid = dd1.detailid
            LEFT JOIN categorydetail e ON b.status = e.ID
                                      AND e.categoryid = '15'
            LEFT JOIN department dg ON b.outhosdept = dg.id
            LEFT JOIN ward wh ON b.outhosward = wh.id
            LEFT JOIN diagnosis f ON f.icd = b.admitdiagnosis
            LEFT JOIN users c ON c.ID = b.resident
            LEFT JOIN dictionary_detail i ON i.detailid = b.criticallevel
                                         AND i.categoryid = '53'
            LEFT JOIN users g ON b.attend = g.id
            LEFT JOIN users h ON b.chief = h.id
            LEFT JOIN dictionary_detail j ON j.detailid = b.sexid
                                         AND j.categoryid = '3'
            LEFT JOIN categorydetail cd ON b.attendlevel = cd.ID
                                       AND cd.categoryid = '63'
           WHERE
             b.outhosdept = v_deptids AND b.outhosward = v_wardid
             AND b.status in ('1500','1501') AND b.isbaby != '1'
           ORDER BY bedid;
        \*
          v_dqrq := TO_CHAR(SYSDATE, 'yyyy-mm-dd');
          v_ksrq := TO_CHAR(SYSDATE - 3, 'yyyy-mm-dd');
          v_jsrq := TO_CHAR(SYSDATE + 2, 'yyyy-mm-dd');
          v_now  := TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss');

          -- 检查手术信息:临时医嘱，已审核和已执行的，开始时间、手术时间在当前日期-3、+1之内
          INSERT INTO tmp_queryinwardpats_extraop
            SELECT a.noofinpat,
                   datediff('dd', v_now, TO_CHAR(SUBSTR(a.entrust, 1, 19))) diff
              FROM temp_order a, tmp_queryinwardpatients b
             WHERE a.noofinpat = b.noofinpat
               AND a.startdate BETWEEN v_ksrq AND v_jsrq
               AND a.ordertype = 3105
               AND a.orderstatus IN (3201, 3202);

          UPDATE tmp_queryinwardpatients a
             SET extra = (SELECT a.extra || (CASE b.diff
                                   WHEN 1 THEN
                                    '明日手术'
                                   WHEN 0 THEN
                                    '今日手术'
                                   WHEN -1 THEN
                                    '术后1天'
                                   WHEN -2 THEN
                                    '术后2天'
                                   WHEN -3 THEN
                                    '术后3天'
                                   ELSE
                                    ''
                                 END) || ' '
                            FROM tmp_queryinwardpats_extraop b
                           WHERE a.noofinpat = b.noofinpat
                             AND ROWNUM < 1);

          -- 检查出院医嘱:临时医嘱，已审核和已执行的，开始时间、出院时间在当前日期0时之后
          v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

          EXECUTE IMMEDIATE v_sql;

          INSERT INTO tmp_queryinwardpats_extraop
            SELECT a.noofinpat,
                   datediff('dd', v_now, TO_CHAR(a.entrust, 'yyyy-mm-dd')) diff
              FROM temp_order a, tmp_queryinwardpatients b
             WHERE a.noofinpat = b.noofinpat
               AND a.startdate >= v_dqrq
               AND a.ordertype = 3113
               AND a.orderstatus IN (3201, 3202);

          UPDATE tmp_queryinwardpatients a
             SET extra = (SELECT a.extra || (CASE b.diff
                                   WHEN 0 THEN
                                    '今日出院'
                                   WHEN 1 THEN
                                    '明日出院'
                                   ELSE
                                    TO_CHAR(b.diff) || '天后出院'
                                 END) || ' '
                            FROM tmp_queryinwardpats_extraop b
                           WHERE a.noofinpat = b.noofinpat
                             AND ROWNUM < 1);

          -- 检查转科医嘱:根据病人状态
          UPDATE tmp_queryinwardpatients a
             SET extra = (SELECT a.extra || b.NAME || ' '
                            FROM categorydetail b
                           WHERE b.categoryid = a.brzt
                             AND ROWNUM < 1)
           WHERE a.brzt IN (1505, 1506, 1507);
        *\
        -- 检查病人是否有病历
        UPDATE tmp_queryinwardpatients a
           SET extra = extra || '无病历', recordinfo = '无病历'
         WHERE noofinpat IS NOT NULL
           AND NOT EXISTS (SELECT 1
                  FROM recorddetail b
                 WHERE a.noofinpat = b.noofinpat
                   and b.valid = '1');
    *\
        IF v_querytype = 0 THEN
          --全部
          BEGIN
            OPEN o_result FOR
              \*SELECT rownum ID, b.*
              FROM
              (
                  SELECT a.* FROM tmp_queryinwardpatients a
                   WHERE a.noofinpat IS NOT NULL
                   ORDER BY a.bedid
              ) b;*\
              SELECT rownum ID, c.*
              FROM
              (
                  SELECT a.*,
                    b.formerward ybqdm, --原病区代码
                    b.formerdeptid yksdm, --原科室代码
                    b.formerdeptid ycwdm, --原床位代码

                    b.deptid beddeptid,
                    b.wardid bedwardid,

                    b.borrow jcbz, --借床标志
                    b.sexinfo cwlx, --床位类型
                    b.valid yxjl --有效记录
                   FROM view_tmp_queryinwardpatients_2 a
                 LEFT JOIN bed b ON b.id = a.outbed
           AND b.deptid = v_deptids AND b.wardid = v_wardid
           AND b.noofinpat = a.noofinpat AND b.valid = '1'
                   WHERE a.noofinpat IS NOT NULL
                    and b.deptid=v_deptids and b.wardid=v_wardid
                  and a.outhosdept=v_deptids and a.outhosward=v_wardid
                   ORDER BY a.bedid
              ) c;
          END;
        ELSIF v_querytype = 1 THEN
          --分管
          BEGIN
            OPEN o_result FOR
              SELECT rownum ID, d.* FROM
              (
                SELECT c.* FROM
                (
                    \*SELECT a.* FROM tmp_queryinwardpatients a
                      JOIN doctor_assignpatient da ON a.noofinpat = da.noofinpat
                                            AND da.ID = v_id
                                            AND da.valid = 1

                    UNION
                    --Modified By wwj 2011-09-02
                    SELECT b.*
                      FROM tmp_queryinwardpatients b
                     where zyysdm = v_id
                       and noofinpat not in (select noofinpat
                                         from Doctor_AssignPatient
                                        where valid = '1')*\
                    SELECT a.*,

                      b.formerward ybqdm, --原病区代码
                    b.formerdeptid yksdm, --原科室代码
                    b.formerdeptid ycwdm, --原床位代码

                    b.deptid beddeptid,
                    b.wardid bedwardid,

                    b.borrow jcbz, --借床标志
                    b.sexinfo cwlx, --床位类型
                    b.valid yxjl --有效记录
                     FROM view_tmp_queryinwardpatients_2 a
                     LEFT JOIN bed b ON b.id = a.outbed
           AND b.deptid = v_deptids AND b.wardid = v_wardid
           AND b.noofinpat = a.noofinpat AND b.valid = '1'

                      JOIN doctor_assignpatient da ON a.noofinpat = da.noofinpat
                                            AND da.ID = v_id
                                            AND da.valid = 1
                                            and b.deptid=v_deptids and b.wardid=v_wardid
                                            and a.outhosdept=v_deptids and a.outhosward=v_wardid

                    UNION
                    --Modified By wwj 2011-09-02
                    SELECT a.*,
                      b.formerward ybqdm, --原病区代码
                    b.formerdeptid yksdm, --原科室代码
                    b.formerdeptid ycwdm, --原床位代码

                    b.deptid beddeptid,
                    b.wardid bedwardid,

                    b.borrow jcbz, --借床标志
                    b.sexinfo cwlx, --床位类型
                    b.valid yxjl --有效记录

                      FROM view_tmp_queryinwardpatients_2 a
                      LEFT JOIN bed b ON b.id = a.outbed
           AND b.deptid = v_deptids AND b.wardid = v_wardid
           AND b.noofinpat = a.noofinpat AND b.valid = '1'
                     where zyysdm = v_id
                       and a.noofinpat not in (select noofinpat
                                         from Doctor_AssignPatient
                                        where valid = '1')
                                         and b.deptid=v_deptids and b.wardid=v_wardid
                                            and a.outhosdept=v_deptids and a.outhosward=v_wardid
                 ) c
                 ORDER BY c.bedid --“我的患者”按照床位号排序
              ) d;
          END;
        ELSIF v_querytype = 2 THEN
          --未分配医生的患者
          BEGIN
            OPEN o_result FOR
              \*SELECT *
                FROM tmp_queryinwardpatients a
               WHERE a.noofinpat IS NOT NULL
                 AND NOT EXISTS (SELECT 1
                        FROM doctor_assignpatient d
                       WHERE d.valid = 1
                         AND d.noofinpat = a.noofinpat)
               ORDER BY a.bedid;*\
               SELECT a.*,
                 b.formerward ybqdm, --原病区代码
                    b.formerdeptid yksdm, --原科室代码
                    b.formerdeptid ycwdm, --原床位代码

                    b.deptid beddeptid,
                    b.wardid bedwardid,

                    b.borrow jcbz, --借床标志
                    b.sexinfo cwlx, --床位类型
                    b.valid yxjl --有效记录
                FROM view_tmp_queryinwardpatients_2 a
                LEFT JOIN bed b ON b.id = a.outbed
           AND b.deptid = v_deptids AND b.wardid = v_wardid
           AND b.noofinpat = a.noofinpat AND b.valid = '1'
               WHERE a.noofinpat IS NOT NULL
                 AND NOT EXISTS (SELECT 1
                        FROM doctor_assignpatient d
                       WHERE d.valid = 1
                         AND d.noofinpat = a.noofinpat)
                         and b.deptid=v_deptids and b.wardid=v_wardid
                                            and a.outhosdept=v_deptids and a.outhosward=v_wardid
               ORDER BY a.bedid;
          END;
        ELSIF v_querytype = 3 THEN
          --护理
          BEGIN
            IF v_querybed = 'N' THEN
              --不包含空床
              BEGIN
                OPEN o_result FOR
                 \* SELECT *
                    FROM tmp_QueryInwardPatients a
                   WHERE a.NoOfInpat IS NOT NULL
                   ORDER BY a.bedid;*\
                   SELECT a.*,
                     b.formerward ybqdm, --原病区代码
                    b.formerdeptid yksdm, --原科室代码
                    b.formerdeptid ycwdm, --原床位代码

                    b.deptid beddeptid,
                    b.wardid bedwardid,

                    b.borrow jcbz, --借床标志
                    b.sexinfo cwlx, --床位类型
                    b.valid yxjl --有效记录
                    FROM view_tmp_QueryInwardPatients_2 a
                    LEFT JOIN bed b ON b.id = a.outbed
           AND b.deptid = v_deptids AND b.wardid = v_wardid
           AND b.noofinpat = a.noofinpat AND b.valid = '1'
                   WHERE a.NoOfInpat IS NOT NULL
                    --and a.beddeptid=v_deptids and a.bedwardid=v_wardid
                    and b.deptid=v_deptids and b.wardid=v_wardid
                                          and a.outhosdept=v_deptids and a.outhosward=v_wardid
                   ORDER BY a.bedid;
              END;
            END IF;

            IF v_querybed = 'Y' THEN
              --包含空床
              BEGIN
                OPEN o_result FOR
                  \*SELECT * FROM tmp_QueryInwardPatients a ORDER BY a.bedid;*\
                  SELECT a.*,
                    b.formerward ybqdm, --原病区代码
                    b.formerdeptid yksdm, --原科室代码
                    b.formerdeptid ycwdm, --原床位代码

                    b.deptid beddeptid,
                    b.wardid bedwardid,

                    b.borrow jcbz, --借床标志
                    b.sexinfo cwlx, --床位类型
                    b.valid yxjl --有效记录
                   FROM view_tmp_QueryInwardPatients_2 a
                   LEFT JOIN bed b ON b.id = a.outbed
           AND b.deptid = v_deptids AND b.wardid = v_wardid
           AND b.noofinpat =a.noofinpat AND b.valid = '1'

                    ORDER BY a.bedid;
              END;
            END IF;
          END;
        END IF;
      END;*/
    -----------------------======
    v_wardid_in VARCHAR(6);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(4000);
  BEGIN
    v_sql := 'truncate table tmp_QueryInwardPatients ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

    EXECUTE IMMEDIATE v_sql;

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    -- 先找出病人记录，然后读取病人的附加信息（手术、出院、转科等）
    INSERT INTO tmp_queryinwardpatients
      SELECT distinct b.noofinpat noofinpat, --首页序号
                      b.patnoofhis patnoofhis, --HIS首页序号
                      b.patid patid, --住院号
                      b.name patname, --姓名
                      b.sexid sex, --病人性别
                      j.name sexname, --病人性别名称
                      b.agestr agestr, --年龄
                      b.py py, --拼音
                      b.wb wb, --五笔
                      b.status brzt, --病人状态
                      e.name brztname, --病人状态名称
                      RTRIM(b.criticallevel) wzjb, --危重级别
                      i.name wzjbmc, --危重级别名称
                      --cd.name hljb,

                      --CASE WHEN b.attendlevel IS NULL THEN 6105 ELSE to_number(b.attendlevel)
                      --END attendlevel, --护理级别

                      case b.attendlevel
                        when '1' then
                         '一级护理'
                        when '2' then
                         '二级护理'
                        when '3' then
                         '三级护理'
                        when '4' then
                         '特级护理'
                        else
                         '一级护理'
                      end hljb, --护理级别

                      case b.attendlevel
                        when '1' then
                         '6101'
                        when '2' then
                         '6102'
                        when '3' then
                         '6103'
                        when '4' then
                         '6104'
                        else
                         '6101'
                      end attendlevel, --护理级别
                      b.isbaby yebz, --婴儿标志
                      CASE
                        WHEN b.isbaby = '0' THEN
                         '否'
                        WHEN b.isbaby IS NULL THEN
                         ''
                        ELSE
                         '是'
                      END yebzname,
                      --a.wardid bqdm, --病区代码
                      --a.deptid ksdm, --科室代码

                      b.outhosward bqdm, --病区代码
                      b.outhosdept ksdm, --科室代码

                      --a.ID bedid, --床位代码
                      case
                        when length(b.outbed) = 1 then
                         '0' || b.outbed
                        else
                         b.outbed
                      end bedid, --床位代码
                      dg.NAME ksmc, --科室名称
                      wh.NAME bqmc, --病区名称
                      a.formerward ybqdm, --原病区代码
                      a.formerdeptid yksdm, --原科室代码
                      a.formerdeptid ycwdm, --原床位代码
                      a.inbed inbed, --占床标志
                      a.borrow jcbz, --借床标志
                      a.sexinfo cwlx, --床位类型
                      SUBSTR(b.admitdate, 1, 20) admitdate, --入院日期
                      f.NAME ryzd, --入院诊断
                      b.admitdiagnosis zdmc, --诊断名称
                      b.resident zyysdm, --住院医生代码
                      c.NAME zyys, --住院医生
                      c.NAME cwys, --床位医生
                      g.NAME zzys, --主治医师
                      h.NAME zrys, --主任医师
                      a.valid yxjl, --有效记录
                      --me.pzlx pzlx, --凭证类型
                      dd1.NAME pzlx, --费用类别
                      /*
                      TO_CHAR((CASE
                                WHEN INSTR(v_deptids, a.deptid) = 0 AND (b.noofinpat IS NULL) THEN
                                 '属于其它科室'
                                ELSE
                                 ''
                              END)) extra, --额外信息
                      */
                      CASE
                        WHEN b.outhosdept = v_deptids AND
                             b.outhosward = v_wardid THEN
                         '本科室'
                        ELSE
                         '属于其他科室'
                      END extra, --额外信息
                      b.memo memo, --备注
                      CASE b.cpstatus
                        WHEN 0 THEN
                         '未引入'
                        WHEN 1 THEN
                         '执行中'
                        WHEN 2 THEN
                         '退出'
                      END cpstatus,
                      CASE
                        WHEN b.noofinpat IS NULL THEN
                         ''
                        ELSE
                         '己书写'
                      END recordinfo,
                      100 ye, --余额
                      (SELECT CASE
                                WHEN COUNT(qc.foulstate) > 0 THEN
                                 '是'
                                ELSE
                                 '否'
                              END
                         FROM qcrecord qc
                        WHERE qc.noofinpat = b.noofinpat
                          AND qc.valid = 1
                          AND qc.foulstate = 1) AS iswarn, --是否违规
                      b.incount as rycs --入院次数
        FROM inpatient b
        LEFT JOIN bed a
          ON a.id = b.outbed
         AND a.deptid = v_deptids
         AND a.wardid = v_wardid
         AND a.noofinpat = b.noofinpat
         AND a.valid = '1'
      /*LEFT JOIN inpatient b ON a.noofinpat = b.noofinpat
                             AND a.patnoofhis = b.patnoofhis
                                --AND INSTR(v_deptids, RTRIM(b.outhosdept)) > 0
                                --AND b.status IN (1501, 1504, 1505, 1506, 1507) --在院
                             AND a.inbed = 1301 --占床
      -- 1501 病区分床,1504 取消结算,1505 进入ICU,1506 进入产房,1507 转科状态
        */
        LEFT JOIN Dictionary_detail dd1
          ON dd1.categoryid = '1'
         AND b.payid = dd1.detailid
        LEFT JOIN categorydetail e
          ON b.status = e.ID
         AND e.categoryid = '15'
        LEFT JOIN department dg
          ON b.outhosdept = dg.id
        LEFT JOIN ward wh
          ON b.outhosward = wh.id
        LEFT JOIN diagnosis f
          ON f.icd = b.admitdiagnosis
        LEFT JOIN users c
          ON c.ID = b.resident
        LEFT JOIN dictionary_detail i
          ON i.detailid = b.criticallevel
         AND i.categoryid = '53'
        LEFT JOIN users g
          ON b.attend = g.id
        LEFT JOIN users h
          ON b.chief = h.id
        LEFT JOIN dictionary_detail j
          ON j.detailid = b.sexid
         AND j.categoryid = '3'
        LEFT JOIN categorydetail cd
          ON b.attendlevel = cd.ID
         AND cd.categoryid = '63'
       WHERE /*((b.outhosdept = v_deptids AND b.outhosward = v_wardid) OR
                                           (v_deptids IN
                                           (SELECT bedinfo.newdept
                                                FROM bedinfo
                                               WHERE bedinfo.noofinpat = b.noofinpat) AND
                                           v_wardid IN
                                           (SELECT bedinfo.newward
                                                FROM bedinfo
                                               WHERE bedinfo.noofinpat = b.noofinpat)))
                                       AND a.valid = 1;*/
       b.outhosdept = v_deptids
       AND b.outhosward = v_wardid
       AND b.status in ('1500', '1501')
       AND b.isbaby != '1'
       ORDER BY bedid;
    /*
      v_dqrq := TO_CHAR(SYSDATE, 'yyyy-mm-dd');
      v_ksrq := TO_CHAR(SYSDATE - 3, 'yyyy-mm-dd');
      v_jsrq := TO_CHAR(SYSDATE + 2, 'yyyy-mm-dd');
      v_now  := TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss');

      -- 检查手术信息:临时医嘱，已审核和已执行的，开始时间、手术时间在当前日期-3、+1之内
      INSERT INTO tmp_queryinwardpats_extraop
        SELECT a.noofinpat,
               datediff('dd', v_now, TO_CHAR(SUBSTR(a.entrust, 1, 19))) diff
          FROM temp_order a, tmp_queryinwardpatients b
         WHERE a.noofinpat = b.noofinpat
           AND a.startdate BETWEEN v_ksrq AND v_jsrq
           AND a.ordertype = 3105
           AND a.orderstatus IN (3201, 3202);

      UPDATE tmp_queryinwardpatients a
         SET extra = (SELECT a.extra || (CASE b.diff
                               WHEN 1 THEN
                                '明日手术'
                               WHEN 0 THEN
                                '今日手术'
                               WHEN -1 THEN
                                '术后1天'
                               WHEN -2 THEN
                                '术后2天'
                               WHEN -3 THEN
                                '术后3天'
                               ELSE
                                ''
                             END) || ' '
                        FROM tmp_queryinwardpats_extraop b
                       WHERE a.noofinpat = b.noofinpat
                         AND ROWNUM < 1);

      -- 检查出院医嘱:临时医嘱，已审核和已执行的，开始时间、出院时间在当前日期0时之后
      v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

      EXECUTE IMMEDIATE v_sql;

      INSERT INTO tmp_queryinwardpats_extraop
        SELECT a.noofinpat,
               datediff('dd', v_now, TO_CHAR(a.entrust, 'yyyy-mm-dd')) diff
          FROM temp_order a, tmp_queryinwardpatients b
         WHERE a.noofinpat = b.noofinpat
           AND a.startdate >= v_dqrq
           AND a.ordertype = 3113
           AND a.orderstatus IN (3201, 3202);

      UPDATE tmp_queryinwardpatients a
         SET extra = (SELECT a.extra || (CASE b.diff
                               WHEN 0 THEN
                                '今日出院'
                               WHEN 1 THEN
                                '明日出院'
                               ELSE
                                TO_CHAR(b.diff) || '天后出院'
                             END) || ' '
                        FROM tmp_queryinwardpats_extraop b
                       WHERE a.noofinpat = b.noofinpat
                         AND ROWNUM < 1);

      -- 检查转科医嘱:根据病人状态
      UPDATE tmp_queryinwardpatients a
         SET extra = (SELECT a.extra || b.NAME || ' '
                        FROM categorydetail b
                       WHERE b.categoryid = a.brzt
                         AND ROWNUM < 1)
       WHERE a.brzt IN (1505, 1506, 1507);
    */
    -- 检查病人是否有病历
    UPDATE tmp_queryinwardpatients a
       SET extra = extra || '无病历', recordinfo = '无病历'
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS (SELECT 1
              FROM recorddetail b
             WHERE a.noofinpat = b.noofinpat
               and b.valid = '1');

    IF v_querytype = 0 THEN
      --全部
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, b.*
            FROM (SELECT a.*
                    FROM tmp_queryinwardpatients a
                   WHERE a.noofinpat IS NOT NULL
                   ORDER BY a.bedid) b;
      END;
    ELSIF v_querytype = 1 THEN
      --分管
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, d.*
            FROM (SELECT c.*
                    FROM (SELECT a.*
                            FROM tmp_queryinwardpatients a
                            JOIN doctor_assignpatient da
                              ON a.noofinpat = da.noofinpat
                             AND da.ID = v_id
                             AND da.valid = 1

                          UNION
                          --Modified By wwj 2011-09-02
                          SELECT b.*
                            FROM tmp_queryinwardpatients b
                           where zyysdm = v_id
                             and noofinpat not in
                                 (select noofinpat
                                    from Doctor_AssignPatient
                                   where valid = '1')) c
                   ORDER BY c.bedid --“我的患者”按照床位号排序
                  ) d;
      END;
    ELSIF v_querytype = 2 THEN
      --未分配医生的患者
      BEGIN
        OPEN o_result FOR
          SELECT *
            FROM tmp_queryinwardpatients a
           WHERE a.noofinpat IS NOT NULL
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient d
                   WHERE d.valid = 1
                     AND d.noofinpat = a.noofinpat)
           ORDER BY a.bedid;
      END;
    ELSIF v_querytype = 3 THEN
      --护理
      BEGIN
        IF v_querybed = 'N' THEN
          --不包含空床
          BEGIN
            OPEN o_result FOR
              SELECT *
                FROM tmp_QueryInwardPatients a
               WHERE a.NoOfInpat IS NOT NULL
               ORDER BY a.bedid;
          END;
        END IF;

        IF v_querybed = 'Y' THEN
          --包含空床
          BEGIN
            OPEN o_result FOR
              SELECT * FROM tmp_QueryInwardPatients a ORDER BY a.bedid;
          END;
        END IF;
      END;
    END IF;
  END;

  -------======================================

  /*
  bwj 20121108 解决医生工作站中用临时表出资源竞争悲观锁
  通过视图
  */
  PROCEDURE usp_queryinwardpatients(v_wardid    VARCHAR,
                                    v_deptids   VARCHAR,
                                    v_zyhm      VARCHAR DEFAULT '',
                                    v_hzxm      VARCHAR DEFAULT '',
                                    v_cyzd      VARCHAR DEFAULT '',
                                    v_ryrqbegin VARCHAR DEFAULT '',
                                    v_ryrqend   VARCHAR DEFAULT '',
                                    v_cyrqbegin VARCHAR DEFAULT '',
                                    v_cyrqend   VARCHAR DEFAULT '',
                                    --add by xjt
                                    v_id        VARCHAR DEFAULT '',
                                    v_querytype INT DEFAULT 0,
                                    v_querynur  VARCHAR DEFAULT '',
                                    v_querybed  VARCHAR DEFAULT 'Y',
                                    o_result    OUT empcurtyp)

   AS
    v_table     varchar(500);
    v_wardid_in VARCHAR(6);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(8000);
    v_cfgValue  clob;
  BEGIN
    --通过appcfg判断是够调用青龙山的存储过程 xuliangliang 2012-12-17
    select ap.VALUE
      into v_cfgValue
      from appcfg ap
     where ap.CONFIGKEY = 'ConfigQLSEMRPROC';
    if v_cfgValue = '1' then
      emrproc.usp_queryinwardpatientsQLS(v_wardid,
                                         v_deptids,
                                         v_zyhm,
                                         v_hzxm,
                                         v_cyzd,
                                         v_ryrqbegin,
                                         v_ryrqend,
                                         v_cyrqbegin,
                                         v_cyrqend,
                                         --add by xjt
                                         v_id,
                                         v_querytype,
                                         v_querynur,
                                         v_querybed,
                                         o_result);
    else
      begin

        v_table := 'tmp_' || to_char(sysdate, 'yyyyMMddHH24mimiss') ||
                   dbms_random.string('a', 3);
        execute immediate 'create table ' || v_table ||
                          ' as select t.*,''yyyy-MM-dd HH:mm:ss'' as inwarddate,''111111111111111111'' as idinfo from tmp_QueryInwardPatients t where 1<>1';
        --' as select * from tmp_QueryInwardPatients where 1<>1'; --edit by cyq 2013-03-13 添加入科日期列
        IF v_wardid IS NULL THEN
          v_wardid_in := '';
        END IF;

        v_sql := 'INSERT INTO ' || v_table ||
                 ' SELECT distinct b.noofinpat noofinpat,' --首页序号
                 || 'b.patnoofhis patnoofhis,' --HIS首页序号
                 || 'b.patid patid,' --住院号
                 || 'b.name patname,' --姓名
                 || 'b.sexid sex,' --病人性别
                 || 'j.name sexname,' --病人性别名称
                 || 'b.agestr agestr,' --年龄
                 || 'b.py py,' --拼音
                 || 'b.wb wb,' --五笔
                 || 'b.status brzt,' --病人状态
                 || 'e.name brztname,' --病人状态名称
                 || 'RTRIM(b.criticallevel) wzjb,' --危重级别
                 || 'i.name wzjbmc,'; --危重级别名称
        --cd.name hljb,

        --CASE WHEN b.attendlevel IS NULL THEN 6105 ELSE to_number(b.attendlevel)
        --END attendlevel, --护理级别

        v_sql := v_sql || ' case b.attendlevel' || '   when ''1'' then ' ||
                 '    ''一级护理''' || '   when ''2'' then' || ' ''二级护理''' ||
                 ' when ''3'' then' || '  ''三级护理''' || '  when ''4'' then' ||
                 '    ''特级护理'' ' || '   else ' || ' ''''' || ' end hljb,' --护理级别
                 || ' case b.attendlevel' || ' when ''1'' then ' ||
                 '    ''6101''' || ' when ''2'' then ' || ' ''6102''' ||
                 ' when ''3'' then' || '  ''6103''' || '   when ''4'' then' ||
                 '    ''6104''' || '  else ' || '    ''6101''' ||
                 ' end attendlevel,' --护理级别
                 || '  b.isbaby yebz, ' --婴儿标志
                 || '  CASE ' || '   WHEN b.isbaby = ''0'' THEN ' ||
                 ' ''否''' || ' WHEN b.isbaby IS NULL THEN ' || '  ''''' ||
                 ' ELSE ' || '  ''是''' || ' END yebzname,';
        --a.wardid bqdm, --病区代码
        --a.deptid ksdm, --科室代码

        v_sql := v_sql || 'b.outhosward bqdm,' --病区代码
                 || 'b.outhosdept ksdm,'; --科室代码';

        --a.ID bedid, --床位代码
        v_sql := v_sql ||
                 ' case when length(b.outbed) = 1 and isnumber(b.outbed) = 1 then ''0'' || b.outbed else b.outbed end bedid,' --床位代码
                 || 'dg.NAME ksmc,' --科室名称
                 || 'wh.NAME bqmc,' --病区名称
                 || 'a.formerward ybqdm,' --原病区代码
                 || 'a.formerdeptid yksdm,' --原科室代码
                 || 'a.formerdeptid ycwdm,' --原床位代码
                 || 'a.inbed inbed,' --占床标志
                 || 'a.borrow jcbz,' --借床标志
                 || 'a.sexinfo cwlx,' --床位类型
                 || 'SUBSTR(b.admitdate, 1, 23) admitdate,' --入院日期
                 || 'b.admitdiagnosis ryzd,' --入院诊断
                 || 'f.NAME zdmc,' --诊断名称
                 || 'b.resident zyysdm,' --住院医生代码
                 || 'c.NAME zyys,' --住院医生
                 || 'c.NAME cwys,' --床位医生
                 || 'g.NAME zzys,' --主治医师
                 || 'h.NAME zrys,' --主任医师
                 || 'a.valid yxjl,' --有效记录
                --me.pzlx pzlx, --凭证类型
                 || 'dd1.NAME pzlx,'; --费用类别';
        /*
        TO_CHAR((CASE
                  WHEN INSTR(v_deptids, a.deptid) = 0 AND (b.noofinpat IS NULL) THEN
                   '属于其它科室'
                  ELSE
                   ''
                END)) extra, --额外信息
        */
        v_sql := v_sql || '  CASE
               WHEN b.outhosdept =''' || v_deptids ||
                 ''' AND b.outhosward =''' || v_wardid ||
                 ''' THEN
                ''本科室''
               ELSE
               ''属于其他科室''
             END extra,' --额外信息
                 || 'b.memo memo,' --备注
                 || ' CASE b.cpstatus
               WHEN 0 THEN
                ''未引入''
               WHEN 1 THEN
                ''执行中''
               WHEN 2 THEN
                ''退出''
             END cpstatus,
             CASE
               WHEN b.noofinpat IS NULL THEN
                ''''
               ELSE
                ''己书写''
             END recordinfo,
             100 ye,' --余额
                 || '(SELECT CASE
                       WHEN COUNT(qc.foulstate) > 0 THEN
                        ''是''
                       ELSE
                        ''否''
                     END
                FROM qcrecord qc
               WHERE qc.noofinpat = b.noofinpat
                 AND qc.valid = 1
                 AND qc.foulstate = 1) AS iswarn,' --是否违规
                 || 'b.incount as rycs, ' --入院次数
                 || 'substr(b.inwarddate,1,23) ,' -- 入科日期 add by cyq 2013-03-13
                 || 'b.idno idinfo '; --身份ID
        v_sql := v_sql || '  FROM
      (select * from inpatient where ' || 'outhosdept =''' ||
                 v_deptids || ''' AND outhosward =''' || v_wardid ||
                 ''' AND status in (''1500'',''1501'') AND isbaby != ''1'') b
       LEFT JOIN( select formerward,formerdeptid,inbed,borrow,sexinfo,valid,noofinpat,id from bed where
        deptid =''' || v_deptids || ''' AND wardid =''' ||
                 v_wardid ||
                 ''' and valid = ''1'')
             a ON a.id = b.outbed AND a.noofinpat = b.noofinpat ';
        /*LEFT JOIN inpatient b ON a.noofinpat = b.noofinpat
                               AND a.patnoofhis = b.patnoofhis
                                  --AND INSTR(v_deptids, RTRIM(b.outhosdept)) > 0
                                  --AND b.status IN (1501, 1504, 1505, 1506, 1507) --在院
                               AND a.inbed = 1301 --占床
        -- 1501 病区分床,1504 取消结算,1505 进入ICU,1506 进入产房,1507 转科状态
          */

        v_sql := v_sql || ' LEFT JOIN (select name,detailid from Dictionary_detail where categoryid = ''1'') dd1 ON
                                       b.payid = dd1.detailid
        LEFT JOIN (select name,id from categorydetail where categoryid = ''15'') e ON b.status = e.ID
        LEFT JOIN (select name,id from department) dg ON b.outhosdept = dg.id
        LEFT JOIN (select name,id from ward) wh ON b.outhosward = wh.id
        LEFT JOIN (select name,icd from diagnosis) f ON f.icd = b.admitdiagnosis
        LEFT JOIN (select id,name from users) c ON c.ID = b.resident
        LEFT JOIN (select name,detailid from dictionary_detail where categoryid = ''53'') i ON i.detailid = b.criticallevel
        LEFT JOIN (select id,name from users) g ON b.attend = g.id
        LEFT JOIN (select id,name from users) h ON b.chief = h.id
        LEFT JOIN (select name, detailid from dictionary_detail where categoryid = ''3'')  j ON j.detailid = b.sexid
        LEFT JOIN (select name,id from categorydetail where categoryid = ''63'') cd ON b.attendlevel = cd.ID
       WHERE 1=1 '; /*((b.outhosdept = v_deptids AND b.outhosward = v_wardid) OR
                                           (v_deptids IN
                                           (SELECT bedinfo.newdept
                                                FROM bedinfo
                                               WHERE bedinfo.noofinpat = b.noofinpat) AND
                                           v_wardid IN
                                           (SELECT bedinfo.newward
                                                FROM bedinfo
                                               WHERE bedinfo.noofinpat = b.noofinpat)))
                                       AND a.valid = 1;*/
        /*  v_sql:=v_sql||' b.outhosdept = '||v_deptids||' AND b.outhosward ='|| v_wardid
        ||' AND b.status in (''1500'',''1501'') AND b.isbaby != ''1''*/
        v_sql := v_sql || ' ORDER BY bedid';

        /*
        dbms_output.put_line(substr(v_sql, 1, 1000));
        dbms_output.put_line(substr(v_sql, 1001, 1000));
        dbms_output.put_line(substr(v_sql, 2001, 1000));
        dbms_output.put_line(substr(v_sql, 3001, 1000));
        */

        execute immediate v_sql;
        -- 检查病人是否有病历
        v_sql := 'UPDATE ' || v_table || ' a
       SET extra = extra || ''无病历'', recordinfo = ''无病历''
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS (SELECT 1
              FROM recorddetail b
             WHERE a.noofinpat = b.noofinpat
               and b.valid = ''1'')';

        execute immediate v_sql;
        IF v_querytype = 0 THEN
          --全部
          BEGIN
            OPEN o_result FOR 'SELECT rownum ID, b.*
          FROM
          (
              SELECT a.* FROM ' || v_table || ' a
               WHERE a.noofinpat IS NOT NULL
               ORDER BY a.bedid
          ) b';
          END;
        ELSIF v_querytype = 1 THEN
          --分管
          BEGIN
            OPEN o_result FOR ' SELECT rownum ID, d.* FROM
          (
            SELECT c.* FROM
            (
                SELECT a.* FROM ' || v_table || ' a
                  JOIN doctor_assignpatient da ON a.noofinpat = da.noofinpat
                                        AND da.ID =''' || v_id || ''' AND da.valid = 1

                UNION
                --Modified By wwj 2011-09-02
                SELECT b.*
                  FROM ' || v_table || ' b
                 where zyysdm =''' || v_id || '''   and noofinpat not in (select noofinpat
                                     from Doctor_AssignPatient
                                    where valid = ''1'')
             ) c
             ORDER BY c.bedid --“我的患者”按照床位号排序
          ) d';
          END;
        ELSIF v_querytype = 2 THEN
          --未分配医生的患者
          BEGIN
            OPEN o_result FOR 'SELECT *
            FROM ' || v_table || ' a
           WHERE a.noofinpat IS NOT NULL
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient d
                   WHERE d.valid = 1
                     AND d.noofinpat = a.noofinpat)
           ORDER BY a.bedid';
          END;
        ELSIF v_querytype = 3 THEN
          --护理
          BEGIN
            IF v_querybed = 'N' THEN
              --不包含空床
              BEGIN
                OPEN o_result FOR 'SELECT *
                FROM ' || v_table || ' a
               WHERE a.NoOfInpat IS NOT NULL
               ORDER BY a.bedid';
              END;
            END IF;

            IF v_querybed = 'Y' THEN
              --包含空床
              BEGIN
                OPEN o_result FOR ' SELECT * FROM ' || v_table || ' a ORDER BY a.bedid';
              END;
            END IF;
          END;
        END IF;
      --永久删除add by ywk
        execute immediate 'drop table ' || v_table ||' purge';
      end;
    end if;
  END;

  /*
  xuliangliang2012-12-17从青龙上库导出
  解决青龙山科室病区代码问题 用like语句
  */
  PROCEDURE usp_queryinwardpatientsQLS(v_wardid    VARCHAR,
                                       v_deptids   VARCHAR,
                                       v_zyhm      VARCHAR DEFAULT '',
                                       v_hzxm      VARCHAR DEFAULT '',
                                       v_cyzd      VARCHAR DEFAULT '',
                                       v_ryrqbegin VARCHAR DEFAULT '',
                                       v_ryrqend   VARCHAR DEFAULT '',
                                       v_cyrqbegin VARCHAR DEFAULT '',
                                       v_cyrqend   VARCHAR DEFAULT '',
                                       --add by xjt
                                       v_id        VARCHAR DEFAULT '',
                                       v_querytype INT DEFAULT 0,
                                       v_querynur  VARCHAR DEFAULT '',
                                       v_querybed  VARCHAR DEFAULT 'Y',
                                       o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取对应病区的床位信息
     功能说明
     输入参数
      v_Wardid   varchar(6)   --病区代码
      v_Deptids varchar(255)  --科室代码集合(形如: '代码1','代码2')
      v_zyhm  varchar(30)=''  --住院号
      v_hzxm  varchar(30)=''  --姓名
      v_cyzd  varchar(30)=''  --出院诊断
      v_cyrqbegin varchar(19)=''  --出院日期最小值
      v_cyrqend varchar(19)=''  --出院日期最大值
      v_ryrqbegin varchar(19)=''  --入院日期最小值
      v_ryrqend varchar(19)=''  --入院日期最大值
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例
     exec usp_QueryInwardPatients  '2911', '3202','','','','','','','','',3,'Y'
     修改记录
    护理级别待处理
    **********/
    v_wardid_in VARCHAR(6);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(4000);
  BEGIN

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    IF v_querytype = 0 THEN
      --全部
      BEGIN
        OPEN o_result FOR

          SELECT rownum         ID,
                 a.*,
                 b.formerward   ybqdm, --原病区代码
                 b.formerdeptid yksdm, --原科室代码
                 b.formerdeptid ycwdm, --原床位代码

                 b.deptid beddeptid,
                 b.wardid bedwardid,

                 b.borrow  jcbz, --借床标志
                 b.sexinfo cwlx, --床位类型
                 b.valid   yxjl --有效记录
            FROM (select *
                    from view_tmp_queryinwardpatients_2
                   where view_tmp_queryinwardpatients_2.noofinpat IS NOT NULL
                     and view_tmp_queryinwardpatients_2.outhosdept like
                         '%' || v_deptids || '%'
                     AND view_tmp_queryinwardpatients_2.outhosward like
                         '%' || v_wardid || '%') a
            LEFT JOIN (select bed.id,
                              bed.borrow,
                              bed.formerward,
                              bed.formerdeptid,
                              bed.deptid,
                              bed.wardid,
                              bed.sexinfo,
                              bed.valid,
                              bed.noofinpat
                         from bed
                        where bed.valid = '1'
                          AND bed.deptid = v_deptids
                          AND bed.wardid = v_wardid

                       ) b
              ON b.id = a.outbed
             AND b.noofinpat = a.noofinpat
           ORDER BY a.bedid;

      END;
    ELSIF v_querytype = 1 THEN
      --分管
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, d.*
            FROM (SELECT c.*
                    FROM (
                          /*SELECT a.* FROM tmp_queryinwardpatients a
                            JOIN doctor_assignpatient da ON a.noofinpat = da.noofinpat
                                                  AND da.ID = v_id
                                                  AND da.valid = 1

                          UNION
                          --Modified By wwj 2011-09-02
                          SELECT b.*
                            FROM tmp_queryinwardpatients b
                           where zyysdm = v_id
                             and noofinpat not in (select noofinpat
                                               from Doctor_AssignPatient
                                              where valid = '1')*/
                          SELECT a.*,

                                  b.formerward   ybqdm, --原病区代码
                                  b.formerdeptid yksdm, --原科室代码
                                  b.formerdeptid ycwdm, --原床位代码

                                  b.deptid beddeptid,
                                  b.wardid bedwardid,

                                  b.borrow  jcbz, --借床标志
                                  b.sexinfo cwlx, --床位类型
                                  b.valid   yxjl --有效记录
                            FROM (select *
                                     from view_tmp_queryinwardpatients_2
                                    where view_tmp_queryinwardpatients_2.outhosdept like
                                          '%' || v_deptids || '%'
                                      AND view_tmp_queryinwardpatients_2.outhosward like
                                          '%' || v_wardid || '%'

                                   ) a
                            LEFT JOIN (select *
                                         from bed
                                        where bed.valid = '1'
                                          AND bed.deptid = v_deptids
                                          AND bed.wardid = v_wardid

                                       ) b
                              ON b.id = a.outbed
                             AND b.noofinpat = a.noofinpat

                            JOIN doctor_assignpatient da
                              ON a.noofinpat = da.noofinpat
                             AND da.ID = v_id
                             AND da.valid = 1

                          UNION
                          --Modified By wwj 2011-09-02
                          SELECT a.*,
                                 b.formerward   ybqdm, --原病区代码
                                 b.formerdeptid yksdm, --原科室代码
                                 b.formerdeptid ycwdm, --原床位代码

                                 b.deptid beddeptid,
                                 b.wardid bedwardid,

                                 b.borrow  jcbz, --借床标志
                                 b.sexinfo cwlx, --床位类型
                                 b.valid   yxjl --有效记录

                            FROM (select *
                                    from view_tmp_queryinwardpatients_2
                                   where view_tmp_queryinwardpatients_2.outhosdept like
                                         '%' || v_deptids || '%'
                                     AND view_tmp_queryinwardpatients_2.outhosward like
                                         '%' || v_wardid || '%') a
                            LEFT JOIN (select *
                                         from bed
                                        where bed.valid = '1'
                                          AND bed.deptid = v_deptids
                                          AND bed.wardid = v_wardid) b
                              ON b.id = a.outbed
                             AND b.noofinpat = a.noofinpat
                             AND b.valid = '1'
                           where zyysdm = v_id
                             and a.noofinpat not in
                                 (select noofinpat
                                    from Doctor_AssignPatient
                                   where valid = '1')) c
                   ORDER BY c.bedid --“我的患者”按照床位号排序
                  ) d;
      END;
    ELSIF v_querytype = 2 THEN
      --未分配医生的患者
      BEGIN
        OPEN o_result FOR
        /*SELECT *
                                                    FROM tmp_queryinwardpatients a
                                                   WHERE a.noofinpat IS NOT NULL
                                                     AND NOT EXISTS (SELECT 1
                                                            FROM doctor_assignpatient d
                                                           WHERE d.valid = 1
                                                             AND d.noofinpat = a.noofinpat)
                                                   ORDER BY a.bedid;*/
          SELECT a.*,
                 b.formerward   ybqdm, --原病区代码
                 b.formerdeptid yksdm, --原科室代码
                 b.formerdeptid ycwdm, --原床位代码

                 b.deptid beddeptid,
                 b.wardid bedwardid,

                 b.borrow  jcbz, --借床标志
                 b.sexinfo cwlx, --床位类型
                 b.valid   yxjl --有效记录
            FROM (select *
                    from view_tmp_queryinwardpatients_2
                   where view_tmp_queryinwardpatients_2.outhosdept like
                         '%' || v_deptids || '%'
                     AND view_tmp_queryinwardpatients_2.outhosward like
                         '%' || v_wardid || '%') a
            LEFT JOIN (select *
                         from bed
                        where bed.valid = '1'
                          AND bed.deptid = v_deptids
                          AND bed.wardid = v_wardid

                       ) b
              ON b.id = a.outbed
             AND b.noofinpat = a.noofinpat
           WHERE a.noofinpat IS NOT NULL
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient d
                   WHERE d.valid = 1
                     AND d.noofinpat = a.noofinpat)

           ORDER BY a.bedid;
      END;
    ELSIF v_querytype = 3 THEN
      --护理
      BEGIN
        IF v_querybed = 'N' THEN
          --不包含空床
          BEGIN
            OPEN o_result FOR
            /* SELECT *
                                                                            FROM tmp_QueryInwardPatients a
                                                                           WHERE a.NoOfInpat IS NOT NULL
                                                                           ORDER BY a.bedid;*/
              SELECT a.*,
                     b.formerward   ybqdm, --原病区代码
                     b.formerdeptid yksdm, --原科室代码
                     b.formerdeptid ycwdm, --原床位代码

                     b.deptid beddeptid,
                     b.wardid bedwardid,

                     b.borrow  jcbz, --借床标志
                     b.sexinfo cwlx, --床位类型
                     b.valid   yxjl --有效记录
                FROM (select *
                        from view_tmp_queryinwardpatients_2
                       where view_tmp_queryinwardpatients_2.outhosdept like
                             '%' || v_deptids || '%'
                         AND view_tmp_queryinwardpatients_2.outhosward like
                             '%' || v_wardid || '%') a
                LEFT JOIN (select *
                             from bed
                            where bed.valid = '1'
                              AND bed.deptid = v_deptids
                              AND bed.wardid = v_wardid

                           ) b
                  ON b.id = a.outbed
                 AND b.noofinpat = a.noofinpat
               WHERE a.NoOfInpat IS NOT NULL
               ORDER BY a.bedid;
          END;
        END IF;

        IF v_querybed = 'Y' THEN
          --包含空床
          BEGIN
            OPEN o_result FOR
            /*SELECT * FROM tmp_QueryInwardPatients a ORDER BY a.bedid;*/
              SELECT a.*,
                     b.formerward   ybqdm, --原病区代码
                     b.formerdeptid yksdm, --原科室代码
                     b.formerdeptid ycwdm, --原床位代码

                     b.deptid beddeptid,
                     b.wardid bedwardid,

                     b.borrow  jcbz, --借床标志
                     b.sexinfo cwlx, --床位类型
                     b.valid   yxjl --有效记录
                FROM (select *
                        from view_tmp_queryinwardpatients_2
                       where view_tmp_queryinwardpatients_2.outhosdept like
                             '%' || v_deptids || '%'
                         AND view_tmp_queryinwardpatients_2.outhosward like
                             '%' || v_wardid || '%') a
                LEFT JOIN (select *
                             from bed
                            where bed.valid = '1'
                              AND bed.deptid = v_deptids
                              AND bed.wardid = v_wardid

                           ) b
                  ON b.id = a.outbed
                 AND b.noofinpat = a.noofinpat

               ORDER BY a.bedid;
          END;
        END IF;
      END;
    END IF;
  END;

  -----------------------======
  /*v_wardid_in VARCHAR(6);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(4000);
  BEGIN
    v_sql := 'truncate table tmp_QueryInwardPatients ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

    EXECUTE IMMEDIATE v_sql;

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    -- 先找出病人记录，然后读取病人的附加信息（手术、出院、转科等）
    INSERT INTO tmp_queryinwardpatients
      SELECT distinct b.noofinpat noofinpat, --首页序号
             b.patnoofhis patnoofhis, --HIS首页序号
             b.patid patid, --住院号
             b.name patname, --姓名
             b.sexid sex, --病人性别
             j.name sexname, --病人性别名称
             b.agestr agestr, --年龄
             b.py py, --拼音
             b.wb wb, --五笔
             b.status brzt, --病人状态
             e.name brztname, --病人状态名称
             RTRIM(b.criticallevel) wzjb, --危重级别
             i.name wzjbmc, --危重级别名称
             --cd.name hljb,

             --CASE WHEN b.attendlevel IS NULL THEN 6105 ELSE to_number(b.attendlevel)
             --END attendlevel, --护理级别

             case b.attendlevel
               when '1' then
                '一级护理'
               when '2' then
                '二级护理'
               when '3' then
                '三级护理'
               when '4' then
                '特级护理'
               else
                '一级护理'
             end hljb, --护理级别

             case b.attendlevel
               when '1' then
                '6101'
               when '2' then
                '6102'
               when '3' then
                '6103'
               when '4' then
                '6104'
               else
                '6101'
             end attendlevel, --护理级别
             b.isbaby yebz, --婴儿标志
             CASE
               WHEN b.isbaby = '0' THEN
                '否'
               WHEN b.isbaby IS NULL THEN
                ''
               ELSE
                '是'
             END yebzname,
             --a.wardid bqdm, --病区代码
             --a.deptid ksdm, --科室代码

             b.outhosward bqdm, --病区代码
             b.outhosdept ksdm, --科室代码

             --a.ID bedid, --床位代码
             case when length(b.outbed) = 1 then '0' || b.outbed else b.outbed end bedid, --床位代码
             dg.NAME ksmc, --科室名称
             wh.NAME bqmc, --病区名称
             a.formerward ybqdm, --原病区代码
             a.formerdeptid yksdm, --原科室代码
             a.formerdeptid ycwdm, --原床位代码
             a.inbed inbed, --占床标志
             a.borrow jcbz, --借床标志
             a.sexinfo cwlx, --床位类型
             SUBSTR(b.admitdate, 1, 16) admitdate, --入院日期
             f.NAME ryzd, --入院诊断
             f.NAME zdmc, --诊断名称
             b.resident zyysdm, --住院医生代码
             c.NAME zyys, --住院医生
             c.NAME cwys, --床位医生
             g.NAME zzys, --主治医师
             h.NAME zrys, --主任医师
             a.valid yxjl, --有效记录
             --me.pzlx pzlx, --凭证类型
             dd1.NAME pzlx, --费用类别
             \*
                                                                 TO_CHAR((CASE
                                                                           WHEN INSTR(v_deptids, a.deptid) = 0 AND (b.noofinpat IS NULL) THEN
                                                                            '属于其它科室'
                                                                           ELSE
                                                                            ''
                                                                         END)) extra, --额外信息
                                                                 *\
             CASE
               WHEN b.outhosdept = v_deptids AND b.outhosward = v_wardid THEN
                '本科室'
               ELSE
                '属于其他科室'
             END extra, --额外信息
             b.memo memo, --备注
             CASE b.cpstatus
               WHEN 0 THEN
                '未引入'
               WHEN 1 THEN
                '执行中'
               WHEN 2 THEN
                '退出'
             END cpstatus,
             CASE
               WHEN b.noofinpat IS NULL THEN
                ''
               ELSE
                '己书写'
             END recordinfo,
             100 ye, --余额
             (SELECT CASE
                       WHEN COUNT(qc.foulstate) > 0 THEN
                        '是'
                       ELSE
                        '否'
                     END
                FROM qcrecord qc
               WHERE qc.noofinpat = b.noofinpat
                 AND qc.valid = 1
                 AND qc.foulstate = 1) AS iswarn, --是否违规
             b.incount as rycs --入院次数
        FROM inpatient b
       LEFT JOIN bed a ON a.id = b.outbed
       AND a.deptid = v_deptids AND a.wardid = v_wardid
       AND a.noofinpat = b.noofinpat AND a.valid = '1'
        \*LEFT JOIN inpatient b ON a.noofinpat = b.noofinpat
                             AND a.patnoofhis = b.patnoofhis
                                --AND INSTR(v_deptids, RTRIM(b.outhosdept)) > 0
                                --AND b.status IN (1501, 1504, 1505, 1506, 1507) --在院
                             AND a.inbed = 1301 --占床
      -- 1501 病区分床,1504 取消结算,1505 进入ICU,1506 进入产房,1507 转科状态
        *\
        LEFT JOIN Dictionary_detail dd1 ON dd1.categoryid = '1'
                                       AND b.payid = dd1.detailid
        LEFT JOIN categorydetail e ON b.status = e.ID
                                  AND e.categoryid = '15'
        LEFT JOIN department dg ON b.outhosdept = dg.id
        LEFT JOIN ward wh ON b.outhosward = wh.id
        LEFT JOIN diagnosis f ON f.icd = b.admitdiagnosis
        LEFT JOIN users c ON c.ID = b.resident
        LEFT JOIN dictionary_detail i ON i.detailid = b.criticallevel
                                     AND i.categoryid = '53'
        LEFT JOIN users g ON b.attend = g.id
        LEFT JOIN users h ON b.chief = h.id
        LEFT JOIN dictionary_detail j ON j.detailid = b.sexid
                                     AND j.categoryid = '3'
        LEFT JOIN categorydetail cd ON b.attendlevel = cd.ID
                                   AND cd.categoryid = '63'
       WHERE \*((b.outhosdept = v_deptids AND b.outhosward = v_wardid) OR
             (v_deptids IN
             (SELECT bedinfo.newdept
                  FROM bedinfo
                 WHERE bedinfo.noofinpat = b.noofinpat) AND
             v_wardid IN
             (SELECT bedinfo.newward
                  FROM bedinfo
                 WHERE bedinfo.noofinpat = b.noofinpat)))
         AND a.valid = 1;*\
         b.outhosdept = v_deptids AND b.outhosward = v_wardid
         AND b.status in ('1500','1501') AND b.isbaby != '1'
       ORDER BY bedid;
    \*
      v_dqrq := TO_CHAR(SYSDATE, 'yyyy-mm-dd');
      v_ksrq := TO_CHAR(SYSDATE - 3, 'yyyy-mm-dd');
      v_jsrq := TO_CHAR(SYSDATE + 2, 'yyyy-mm-dd');
      v_now  := TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss');

      -- 检查手术信息:临时医嘱，已审核和已执行的，开始时间、手术时间在当前日期-3、+1之内
      INSERT INTO tmp_queryinwardpats_extraop
        SELECT a.noofinpat,
               datediff('dd', v_now, TO_CHAR(SUBSTR(a.entrust, 1, 19))) diff
          FROM temp_order a, tmp_queryinwardpatients b
         WHERE a.noofinpat = b.noofinpat
           AND a.startdate BETWEEN v_ksrq AND v_jsrq
           AND a.ordertype = 3105
           AND a.orderstatus IN (3201, 3202);

      UPDATE tmp_queryinwardpatients a
         SET extra = (SELECT a.extra || (CASE b.diff
                               WHEN 1 THEN
                                '明日手术'
                               WHEN 0 THEN
                                '今日手术'
                               WHEN -1 THEN
                                '术后1天'
                               WHEN -2 THEN
                                '术后2天'
                               WHEN -3 THEN
                                '术后3天'
                               ELSE
                                ''
                             END) || ' '
                        FROM tmp_queryinwardpats_extraop b
                       WHERE a.noofinpat = b.noofinpat
                         AND ROWNUM < 1);

      -- 检查出院医嘱:临时医嘱，已审核和已执行的，开始时间、出院时间在当前日期0时之后
      v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

      EXECUTE IMMEDIATE v_sql;

      INSERT INTO tmp_queryinwardpats_extraop
        SELECT a.noofinpat,
               datediff('dd', v_now, TO_CHAR(a.entrust, 'yyyy-mm-dd')) diff
          FROM temp_order a, tmp_queryinwardpatients b
         WHERE a.noofinpat = b.noofinpat
           AND a.startdate >= v_dqrq
           AND a.ordertype = 3113
           AND a.orderstatus IN (3201, 3202);

      UPDATE tmp_queryinwardpatients a
         SET extra = (SELECT a.extra || (CASE b.diff
                               WHEN 0 THEN
                                '今日出院'
                               WHEN 1 THEN
                                '明日出院'
                               ELSE
                                TO_CHAR(b.diff) || '天后出院'
                             END) || ' '
                        FROM tmp_queryinwardpats_extraop b
                       WHERE a.noofinpat = b.noofinpat
                         AND ROWNUM < 1);

      -- 检查转科医嘱:根据病人状态
      UPDATE tmp_queryinwardpatients a
         SET extra = (SELECT a.extra || b.NAME || ' '
                        FROM categorydetail b
                       WHERE b.categoryid = a.brzt
                         AND ROWNUM < 1)
       WHERE a.brzt IN (1505, 1506, 1507);
    *\
    -- 检查病人是否有病历
    UPDATE tmp_queryinwardpatients a
       SET extra = extra || '无病历', recordinfo = '无病历'
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS (SELECT 1
              FROM recorddetail b
             WHERE a.noofinpat = b.noofinpat
               and b.valid = '1');

    IF v_querytype = 0 THEN
      --全部
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, b.*
          FROM
          (
              SELECT a.* FROM tmp_queryinwardpatients a
               WHERE a.noofinpat IS NOT NULL
               ORDER BY a.bedid
          ) b;
      END;
    ELSIF v_querytype = 1 THEN
      --分管
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, d.* FROM
          (
            SELECT c.* FROM
            (
                SELECT a.* FROM tmp_queryinwardpatients a
                  JOIN doctor_assignpatient da ON a.noofinpat = da.noofinpat
                                        AND da.ID = v_id
                                        AND da.valid = 1

                UNION
                --Modified By wwj 2011-09-02
                SELECT b.*
                  FROM tmp_queryinwardpatients b
                 where zyysdm = v_id
                   and noofinpat not in (select noofinpat
                                     from Doctor_AssignPatient
                                    where valid = '1')
             ) c
             ORDER BY c.bedid --“我的患者”按照床位号排序
          ) d;
      END;
    ELSIF v_querytype = 2 THEN
      --未分配医生的患者
      BEGIN
        OPEN o_result FOR
          SELECT *
            FROM tmp_queryinwardpatients a
           WHERE a.noofinpat IS NOT NULL
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient d
                   WHERE d.valid = 1
                     AND d.noofinpat = a.noofinpat)
           ORDER BY a.bedid;
      END;
    ELSIF v_querytype = 3 THEN
      --护理
      BEGIN
        IF v_querybed = 'N' THEN
          --不包含空床
          BEGIN
            OPEN o_result FOR
              SELECT *
                FROM tmp_QueryInwardPatients a
               WHERE a.NoOfInpat IS NOT NULL
               ORDER BY a.bedid;
          END;
        END IF;

        IF v_querybed = 'Y' THEN
          --包含空床
          BEGIN
            OPEN o_result FOR
              SELECT * FROM tmp_QueryInwardPatients a ORDER BY a.bedid;
          END;
        END IF;
      END;
    END IF;
  END;*/

  --病区包括科室，即一个病区可能会有多个科室
  PROCEDURE usp_queryinwardpatients2(v_wardid    VARCHAR,
                                     v_deptids   VARCHAR,
                                     v_zyhm      VARCHAR DEFAULT '',
                                     v_hzxm      VARCHAR DEFAULT '',
                                     v_cyzd      VARCHAR DEFAULT '',
                                     v_ryrqbegin VARCHAR DEFAULT '',
                                     v_ryrqend   VARCHAR DEFAULT '',
                                     v_cyrqbegin VARCHAR DEFAULT '',
                                     v_cyrqend   VARCHAR DEFAULT '',
                                     --add by xjt
                                     v_id        VARCHAR DEFAULT '',
                                     v_querytype INT DEFAULT 0,
                                     v_querynur  VARCHAR DEFAULT '',
                                     v_querybed  VARCHAR DEFAULT 'Y',
                                     o_result    OUT empcurtyp) AS
    v_wardid_in VARCHAR(6);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(4000);
  BEGIN
    v_sql := 'truncate table tmp_QueryInwardPatients ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryInwardPats_extraop ';

    EXECUTE IMMEDIATE v_sql;

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    -- 先找出病人记录，然后读取病人的附加信息（手术、出院、转科等）
    INSERT INTO tmp_queryinwardpatients
      SELECT distinct b.noofinpat noofinpat, --首页序号
                      b.patnoofhis patnoofhis, --HIS首页序号
                      b.patid patid, --住院号
                      b.name patname, --姓名
                      b.sexid sex, --病人性别
                      j.name sexname, --病人性别名称
                      b.agestr agestr, --年龄
                      b.py py, --拼音
                      b.wb wb, --五笔
                      b.status brzt, --病人状态
                      e.name brztname, --病人状态名称
                      RTRIM(b.criticallevel) wzjb, --危重级别
                      i.name wzjbmc, --危重级别名称
                      case b.attendlevel
                        when '1' then
                         '一级护理'
                        when '2' then
                         '二级护理'
                        when '3' then
                         '三级护理'
                        when '4' then
                         '特级护理'
                        else
                         ''
                      end hljb, --护理级别

                      case b.attendlevel
                        when '1' then
                         '6101'
                        when '2' then
                         '6102'
                        when '3' then
                         '6103'
                        when '4' then
                         '6104'
                        else
                         '6101'
                      end attendlevel, --护理级别
                      b.isbaby yebz, --婴儿标志
                      CASE
                        WHEN b.isbaby = '0' THEN
                         '否'
                        WHEN b.isbaby IS NULL THEN
                         ''
                        ELSE
                         '是'
                      END yebzname,
                      b.outhosward bqdm, --病区代码
                      b.outhosdept ksdm, --科室代码
                      case
                        when length(b.outbed) = 1 then
                         '0' || b.outbed
                        else
                         b.outbed
                      end bedid, --床位代码
                      dg.NAME ksmc, --科室名称
                      wh.NAME bqmc, --病区名称
                      a.formerward ybqdm, --原病区代码
                      a.formerdeptid yksdm, --原科室代码
                      a.formerdeptid ycwdm, --原床位代码
                      a.inbed inbed, --占床标志
                      a.borrow jcbz, --借床标志
                      a.sexinfo cwlx, --床位类型
                      SUBSTR(b.admitdate, 1, 16) admitdate, --入院日期
                     b.admitdiagnosis ryzd, --入院诊断
                     b.admitdiagnosis zdmc, --诊断名称
                      b.resident zyysdm, --住院医生代码
                      c.NAME zyys, --住院医生
                      c.NAME cwys, --床位医生
                      g.NAME zzys, --主治医师
                      h.NAME zrys, --主任医师
                      a.valid yxjl, --有效记录
                      --me.pzlx pzlx, --凭证类型
                      dd1.NAME pzlx, --费用类别
                      CASE
                        WHEN b.outhosdept = v_deptids AND
                             b.outhosward = v_wardid THEN
                         '本科室'
                        ELSE
                         '属于其他科室'
                      END extra, --额外信息
                      b.memo memo, --备注
                      CASE b.cpstatus
                        WHEN 0 THEN
                         '未引入'
                        WHEN 1 THEN
                         '执行中'
                        WHEN 2 THEN
                         '退出'
                      END cpstatus,
                      CASE
                        WHEN b.noofinpat IS NULL THEN
                         ''
                        ELSE
                         '己书写'
                      END recordinfo,
                      100 ye, --余额
                      (SELECT CASE
                                WHEN COUNT(qc.foulstate) > 0 THEN
                                 '是'
                                ELSE
                                 '否'
                              END
                         FROM qcrecord qc
                        WHERE qc.noofinpat = b.noofinpat
                          AND qc.valid = 1
                          AND qc.foulstate = 1) AS iswarn, --是否违规
                      b.incount as rycs --入院次数
        FROM inpatient b
        LEFT JOIN bed a
          ON a.id = b.outbed
         AND a.deptid = v_deptids
         AND a.wardid = v_wardid
         AND a.noofinpat = b.noofinpat
         AND a.valid = '1'
        LEFT JOIN Dictionary_detail dd1
          ON dd1.categoryid = '1'
         AND b.payid = dd1.detailid
        LEFT JOIN categorydetail e
          ON b.status = e.ID
         AND e.categoryid = '15'
        LEFT JOIN department dg
          ON b.outhosdept = dg.id
        LEFT JOIN ward wh
          ON b.outhosward = wh.id
        LEFT JOIN diagnosis f
          ON f.icd = b.admitdiagnosis
        LEFT JOIN users c
          ON c.ID = b.resident
        LEFT JOIN dictionary_detail i
          ON i.detailid = b.criticallevel
         AND i.categoryid = '53'
        LEFT JOIN users g
          ON b.attend = g.id
        LEFT JOIN users h
          ON b.chief = h.id
        LEFT JOIN dictionary_detail j
          ON j.detailid = b.sexid
         AND j.categoryid = '3'
        LEFT JOIN categorydetail cd
          ON b.attendlevel = cd.ID
         AND cd.categoryid = '63'
       WHERE --b.outhosdept = v_deptids AND
       b.outhosward = v_wardid
       AND b.status in ('1500', '1501')
       AND b.isbaby != '1'
       ORDER BY bedid;

    -- 检查病人是否有病历
    UPDATE tmp_queryinwardpatients a
       SET extra = extra || '无病历', recordinfo = '无病历'
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS (SELECT 1
              FROM recorddetail b
             WHERE a.noofinpat = b.noofinpat
               and b.valid = '1');

    IF v_querytype = 0 THEN
      --全部
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, b.*
            FROM (SELECT a.*
                    FROM tmp_queryinwardpatients a
                   WHERE a.noofinpat IS NOT NULL
                   ORDER BY a.bedid) b;
      END;
    ELSIF v_querytype = 1 THEN
      --分管
      BEGIN
        OPEN o_result FOR
          SELECT rownum ID, d.*
            FROM (SELECT c.*
                    FROM (SELECT a.*
                            FROM tmp_queryinwardpatients a
                            JOIN doctor_assignpatient da
                              ON a.noofinpat = da.noofinpat
                             AND da.ID = v_id
                             AND da.valid = 1

                          UNION
                          --Modified By wwj 2011-09-02
                          SELECT b.*
                            FROM tmp_queryinwardpatients b
                           where zyysdm = v_id
                             and noofinpat not in
                                 (select noofinpat
                                    from Doctor_AssignPatient
                                   where valid = '1')) c
                   ORDER BY c.bedid --“我的患者”按照床位号排序
                  ) d;
      END;
    ELSIF v_querytype = 2 THEN
      --未分配医生的患者
      BEGIN
        OPEN o_result FOR
          SELECT *
            FROM tmp_queryinwardpatients a
           WHERE a.noofinpat IS NOT NULL
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient d
                   WHERE d.valid = 1
                     AND d.noofinpat = a.noofinpat)
           ORDER BY a.bedid;
      END;
    ELSIF v_querytype = 3 THEN
      --护理
      BEGIN
        IF v_querybed = 'N' THEN
          --不包含空床
          BEGIN
            OPEN o_result FOR
              SELECT *
                FROM tmp_QueryInwardPatients a
               WHERE a.NoOfInpat IS NOT NULL
               ORDER BY a.bedid;
          END;
        END IF;

        IF v_querybed = 'Y' THEN
          --包含空床
          BEGIN
            OPEN o_result FOR
              SELECT * FROM tmp_QueryInwardPatients a ORDER BY a.bedid;
          END;
        END IF;
      END;
    END IF;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_queryownmanagerpat(v_querytype INT,
                                   v_userid    VARCHAR,
                                   v_deptid    VARCHAR,
                                   v_wardid    VARCHAR,
                                   o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取病人提取界面病人列表
     功能说明
     输入参数
     v_QueryType int     查询类别
     v_UserID varchar(8) 用户ID
     v_DeptID varchar(6)     科室代码
     v_WardId varchar(6)     病区代码
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例

     修改记录
    护理级别待处理
    **********/
    v_sql VARCHAR(3000);
  BEGIN
    v_sql := 'truncate table tmp_QueryOwnManagerPat ';

    EXECUTE IMMEDIATE v_sql;

    IF v_querytype = 0 THEN
      --获得除分管外的病人
      BEGIN
        v_sql := 'select
    a.NoOfInpat  NoOfInpat--首页序号
  , a.PatNoOfHis PatNoOfHis --HIS首页序号
  , a.PatID PatID --住院号
  , a.Name PatName --姓名
  , a.SexID Sex  --病人性别
  , b.Name SexName  --病人性别名称
  , a.AgeStr AgeStr  --年龄
  , rtrim(a.CriticalLevel) wzjb --危重级别
  , a.Status arzt --病人状态
  , c.Name wzjbmc --危重级别名称
  , substr(a.AdmitDate,1,16) AdmitDate  --入院日期
  ,a.AdmitDiagnosis ryzd --入院诊断
  ,a.AdmitDiagnosis zdmc --诊断名称
  --, e.Note pzlx --凭证类型
  , dd1.NAME pzlx --费用类别
  , f.DeptID ksdm
from InPatient a
left join Dictionary_detail b  on b.DetailID = a.SexID and b.CategoryID = ''3''
left join Dictionary_detail c  on c.DetailID = a.CriticalLevel and c.CategoryID = ''53''
left join Diagnosis d  on d.ICD = a.AdmitDiagnosis
--left join MedicareInfo e  ON a.VouchersCode = e.ID
LEFT JOIN Dictionary_detail dd1 ON dd1.categoryid = ''1'' AND a.payid = dd1.detailid
left join Bed f   on f.NoOfInpat = a.NoOfInpat and f.PatNoOfHis = a.PatNoOfHis and f.InBed = 1301
where a.Status in (1501,1504,1505,1506,1507)
and  not exists (select 1 from Doctor_AssignPatient da where da.NoOfInpat=a.NoOfInpat and ID=' ||
                 v_userid || ' and Valid=1)
and f.DeptID=''' || v_deptid || ''' and  f.WardId=''' ||
                 v_wardid || '''
';

        --exec sp_executesql v_sql
        OPEN o_result FOR v_sql;
      END;
    END IF;

    IF v_querytype = 1 THEN
      --获得分管病人
      BEGIN
        INSERT INTO doctor_assignpatient
          SELECT v_userid, noofinpat, 1, SYSDATE, v_userid, 1
            FROM inpatient a
           WHERE resident = v_userid
             AND status IN (1501, 1504, 1505, 1506, 1507)
             AND NOT EXISTS (SELECT 1
                    FROM doctor_assignpatient da
                   WHERE da.noofinpat = a.noofinpat
                     AND ID = v_userid
                     AND valid = 1);

        INSERT INTO tmp_queryownmanagerpat
          SELECT a.noofinpat  noofinpat, --首页序号
                 a.patnoofhis patnoofhis,
                 --HIS首页序号
                 a.patid    patid, --住院号
                 a.NAME     patname, --姓名
                 a.sexid    sex, --病人性别
                 b.NAME     sexname, --病人性别名称
                 a.agestr   agestr, --年龄
                 a.status   arzt, --病人状态
                 ce.NAME    arztname, --病人状态name
                 c.NAME     wzjbmc, --危重级别名称
                 c.detailid wzjb,
                 --危重级别编码
                 SUBSTR(a.admitdate, 1, 20) admitdate, --入院日期
                a.admitdiagnosis ryzd,
                 --入院诊断
                 a.admitdiagnosis zdmc, --诊断名称
                 --e.note pzlx, --凭证类型
                 dd1.NAME pzlx, --费用类别
                 g.NAME   ksmc, --科室名称
                 h.NAME   bqmc,
                 --病区名称
                 a.outbed bedid, --出院床位号
                 (SELECT CASE
                           WHEN COUNT(qc.foulstate) > 0 THEN
                            '是'
                           ELSE
                            '否'
                         END
                    FROM qcrecord qc
                   WHERE qc.noofinpat = da.noofinpat
                     AND qc.valid = 1
                     AND qc.foulstate = 1) AS iswarn --是否违规
                ,
                 '己书写' recordinfo --有无病历
            FROM doctor_assignpatient da
            JOIN inpatient a
              ON da.noofinpat = a.noofinpat
             AND valid = 1
             AND da.ID = v_userid
            LEFT JOIN categorydetail ce
              ON a.status = ce.ID
             AND ce.categoryid = '15'
            LEFT JOIN dictionary_detail b
              ON b.detailid = a.sexid
             AND b.categoryid = '3'
            LEFT JOIN dictionary_detail c
              ON c.detailid = a.criticallevel
             AND c.categoryid = '53'
            LEFT JOIN diagnosis d
              ON d.icd = a.admitdiagnosis
          --LEFT JOIN medicareinfo e ON a.voucherscode = e.ID
            LEFT JOIN Dictionary_detail dd1
              ON dd1.categoryid = '1'
             AND a.payid = dd1.detailid
            LEFT JOIN bed f
              ON f.noofinpat = a.noofinpat
             AND f.patnoofhis = a.patnoofhis
             AND f.inbed = 1301
            LEFT JOIN department g
              ON f.deptid = g.ID
            LEFT JOIN ward h
              ON f.wardid = g.ID
           WHERE a.status IN (1501, 1504, 1505, 1506, 1507);

        -- 检查病人是否有病历
        UPDATE tmp_queryownmanagerpat a
           SET recordinfo = '无病历'
         WHERE noofinpat IS NOT NULL
           AND NOT EXISTS
         (SELECT 1 FROM recorddetail b WHERE a.noofinpat = b.noofinpat);

        OPEN o_result FOR
          SELECT * FROM tmp_queryownmanagerpat order by bedid;
        --ORDER BY TO_CHAR(bedid, '0000');
      END;
    END IF;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_queryqcgrade(v_noofinpat INT,
                             v_operuser  VARCHAR,
                             o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量评分
     功能说明
     输入参数
      v_NoOfInpat varchar(40)--首页序号,
      v_OperUser varchar(6) --操作人
     输出参数
     结果集、排序
    质量控制统计数据集

     调用的sp
     调用实例
     exec usp_QueryQCGrade  9,'00'
     修改记录
    **********/
    v_doctorid VARCHAR(6);
    v_sql      VARCHAR2(400);
  BEGIN
    v_sql := 'truncate table tmp_QueryQCGrade ';

    EXECUTE IMMEDIATE v_sql;

    --基本评分项目(INSERT 进评分表)
    INSERT INTO tmp_queryqcgrade
      SELECT qct.typecode,
             qct.typename,
             qct.typeinstruction,
             qct.typecategory,
             qct.typeorder,
             qct.typememo,
             qci.itemcode,
             qci.itemname,
             qci.iteminstruction, --项目说明
             qci.itemdefaultscore,
             qci.itemdefaulttarget,
             --指标标准，指标分
             '00' ower,
             'YIDAN' owername,
             qci.itemtargetstandard,
             qci.itemstandardscore,
             qci.itemorder,
             qci.itemmemo
        FROM qcscoretype qct
        JOIN qcscoreitem qci
          ON qct.typecode = qci.typecode
         AND qct.valide = 1
         AND qci.valide = 1
         AND NOT EXISTS
       (SELECT 1
                FROM qcgrade
               WHERE qcgrade.itemcode = itemcode
                 AND qcgrade.noofinpat = v_noofinpat)
       ORDER BY qct.typecode, qci.itemorder;

    SELECT OPERATOR
      INTO v_doctorid
      FROM medicalrecord
     WHERE noofinpat = v_noofinpat
       AND ROWNUM < 1;

    INSERT INTO qcgrade
      (noofinpat, doctor_id, typecode, itemcode, create_time, create_user)
      SELECT v_noofinpat,
             v_doctorid,
             tmp_queryqcgrade.typecode,
             tmp_queryqcgrade.itemcode,
             SYSDATE,
             v_operuser
        FROM tmp_queryqcgrade;

    --基本评分项目
    OPEN o_result FOR
      SELECT qcg.ID,
             qcg.noofinpat,
             qct.typecode,
             qct.typename,
             --评分大项code&name
             qci.itemcode,
             qci.itemname, --项目代码code&name
             qci.iteminstruction, --项目说明
             qcg.doctor_id       AS doctor_id, --医师代码
             users.NAME          AS doctorname,
             --医师姓名
             qci.itemdefaultscore, --标准分
             qcg.grade, --评分
             qci.itemtargetstandard,
             qci.itemstandardscore, --指标标准，指标分
             qci.itemorder,
             qci.itemmemo --评分说明
        FROM qcgrade qcg
        JOIN qcscoretype qct
          ON qcg.typecode = qct.typecode
         AND qct.valide = 1
        JOIN qcscoreitem qci
          ON qcg.typecode = qci.typecode
         AND qcg.itemcode = qci.itemcode
         AND qci.valide = 1
        LEFT JOIN users
          ON qcg.doctor_id = users.ID
         AND users.valid = 1
       WHERE qcg.noofinpat = v_noofinpat
       ORDER BY qcg.typecode, qci.itemorder;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_queryquitpatientnodoctor(v_wardid    VARCHAR,
                                         v_deptids   VARCHAR,
                                         v_timefrom  VARCHAR,
                                         v_timeto    VARCHAR,
                                         v_PatientSN varchar default '', --病历号
                                         v_Name      varchar default '', --病人名称
                                         v_querytype INT DEFAULT 0,
                                         o_result    OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取对应病区的出院病患
     功能说明
     输入参数
      v_Wardid   varchar(6)   --病区代码
      v_Deptids varchar(255)  --科室代码集合(形如: '代码1','代码2')
        v_TimeFrom varchar(24),--开始时间
        v_TimeTo varchar(24),--结束时间
        v_QueryType int = 0,--类型
     输出参数
     结果集、排序
    在病区的病人数据集

     调用的sp
     调用实例
     exec usp_QueryQuitPatientNoDoctor  '2911', '3202' ,'2011-05-09','2011-05-09',1
     修改记录
    护理级别待处理
    **********/
    v_wardid_in VARCHAR(40);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(400);
  BEGIN
    v_sql := 'truncate table tmp_QueryQuitPatientNoDoctor ';

    EXECUTE IMMEDIATE v_sql;

    v_sql := 'truncate table tmp_QueryQuitPatientNo_extraop ';

    EXECUTE IMMEDIATE v_sql;

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    -- 先找出病人记录，然后读取病人的附加信息（手术、出院、转科等）
    INSERT INTO tmp_queryquitpatientnodoctor
      SELECT b.noofinpat  noofinpat, --首页序号
             b.patnoofhis patnoofhis, --HIS首页序号
             b.patid      patid,
             --住院号
             b.NAME   patname, --姓名
             b.sexid  sex, --病人性别
             dd2.name sexname, --病人性别名称
             b.agestr agestr,
             --年龄
             b.py py, --拼音
             b.wb wb, --五笔
             b.status brzt, --病人状态
             e.NAME brztname, --病人状态名称
             RTRIM(b.criticallevel) wzjb, --危重级别
             i.NAME wzjbmc, --危重级别名称
             /*
             (CASE
               WHEN patid IS NULL THEN
                ''
               ELSE
                '一级护理'
             END) hljb, --护理级别
             */
             case b.attendlevel
               when '1' then
                '一级护理'
               when '2' then
                '二级护理'
               when '3' then
                '三级护理'
               when '4' then
                '特级护理'
               else
                '一级护理'
             end hljb, --护理级别

             b.isbaby yebz, --婴儿标志
             (CASE
               WHEN b.isbaby = '0' THEN
                '否'
               WHEN b.isbaby IS NULL THEN
                ''
               ELSE
                '是'
             END) yebzname,
             b.outhosward bqdm, --病区代码
             b.outhosdept ksdm, --科室代码
             b.outbed bedid, --床位代码
             dg.NAME ksmc, --科室名称
             wh.NAME bqmc, --病区名称
             b.admitward ybqdm, --原病区代码
             b.admitdept yksdm, --原科室代码
             b.admitbed ycwdm, --原床位代码

             --b.InBed InBed  --占床标志
             --                ,
             --                a.Borrow jcbz --借床标志
             --                ,
             --                a.SexInfo cwlx --床位类型
             --                ,
             SUBSTR(b.admitdate, 1, 20) admitdate, --入院日期
             --SUBSTR(b.outhosdate, 1, 16) outhosdate, --出院日期ad by ywk 2013年7月26日 15:27:18
            b.admitdiagnosis     ryzd, --入院诊断
            b.admitdiagnosis     zdmc, --诊断名称
             b.resident zyysdm, --住院医生代码
             c.NAME     zyys, --住院医生
             c.NAME     cwys,
             --床位医生
             g.NAME zzys, --主治医师
             h.NAME zrys, --主任医师
             --                b.Valid yxjl --有效记录
             --                ,
             --me.pzlx pzlx, --凭证类型
             dd1.NAME pzlx, --费用类别
             TO_CHAR(CASE
                       WHEN INSTR(v_deptids, b.outhosdept) = 0 AND
                            (b.noofinpat IS NULL) THEN
                        '属于其它科室'
                       ELSE
                        ''
                     END) extra, --额外信息
             b.memo memo, --备注
             (CASE b.cpstatus
               WHEN 0 THEN
                '未引入'
               WHEN 1 THEN
                '执行中'
               WHEN 2 THEN
                '退出'
             END) cpstatus,
             CASE
               WHEN b.noofinpat IS NULL THEN
                ''
               ELSE
                '己书写'
             END recordinfo,
             100 ye, --余额
             (SELECT CASE
                       WHEN COUNT(qc.foulstate) > 0 THEN
                        '是'
                       ELSE
                        '否'
                     END
                FROM qcrecord qc
               WHERE qc.noofinpat = b.noofinpat
                 AND qc.valid = 1
                 AND qc.foulstate = 1) AS iswarn --是否违规
        FROM inpatient b
        LEFT JOIN categorydetail e
          ON b.status = e.ID
         AND e.categoryid = '15'
      --LEFT JOIN medicareinfo me ON b.voucherscode = me.ID
        LEFT JOIN Dictionary_detail dd1
          ON dd1.categoryid = '1'
         AND b.payid = dd1.detailid
        LEFT JOIN dictionary_detail dd2
          on dd2.categoryid = '3'
         AND b.sexid = dd2.detailid
        LEFT JOIN department dg
          ON b.outhosdept = dg.ID
      /*LEFT JOIN ward wh ON b.outhosward = dg.ID*/
        LEFT JOIN ward wh
          ON wh.id = dg.id --到这无重复数据集 edit by ywk 2012年3月7日10:14:15
      --   left join YY_SFXXMK e  on b.AttendLevel = e.sfxmdm
        LEFT JOIN diagnosis f
          ON f.icd = b.admitdiagnosis
        LEFT JOIN users c
          ON c.ID = b.resident
        LEFT JOIN dictionary_detail i
          ON i.detailid = b.criticallevel
         AND i.categoryid = '53'
        LEFT JOIN users g
          ON g.ID = b.attend
        LEFT JOIN users h
          ON h.ID = b.chief
        LEFT JOIN dictionary_detail j
          ON j.detailid = b.sexid
         AND j.categoryid = '3'
       WHERE (b.OutHosDept = v_deptids or b.admitdept=v_deptids)
         AND (b.OutHosWard = v_wardid or b.admitward=v_wardid)--add by ywk  出院在院都在此科室应该可以查出来
            /*中心医院需求，要求原来的入院日期改为出院日期 add by ywk 2012年11月21日13:34:11 */
            /*  AND (v_timefrom IS NULL OR
                TO_CHAR(TO_DATE(b.admitdate, 'yyyy-mm-dd hh24:mi:ss'),
                         'yyyy-mm-dd') >= SUBSTR(v_timefrom, 1, 10))
            AND (v_timeto IS NULL OR
                TO_CHAR(TO_DATE(b.admitdate, 'yyyy-mm-dd hh24:mi:ss'),
                         'yyyy-mm-dd') <= SUBSTR(v_timeto, 1, 10))*/
         AND (v_timefrom IS NULL OR
             TO_CHAR(TO_DATE(b.outhosdate, 'yyyy-mm-dd hh24:mi:ss'),
                      'yyyy-mm-dd') >= SUBSTR(v_timefrom, 1, 10))
         AND (v_timeto IS NULL OR
             TO_CHAR(TO_DATE(b.outhosdate, 'yyyy-mm-dd hh24:mi:ss'),
                      'yyyy-mm-dd') <= SUBSTR(v_timeto, 1, 10))

         AND b.patid like '%' || v_PatientSN || '%'
         AND b.name like '%' || v_Name || '%';
    /*
      v_dqrq := TO_CHAR(SYSDATE, 'yyyy-mm-dd');
      v_ksrq := TO_CHAR(SYSDATE - 3, 'yyyy-mm-dd');
      v_jsrq := TO_CHAR(SYSDATE + 2, 'yyyy-mm-dd');
      v_now  := TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss');

      -- 检查手术信息:临时医嘱，已审核和已执行的，开始时间、手术时间在当前日期-3、+1之内
      INSERT INTO tmp_queryquitpatientno_extraop
        SELECT a.noofinpat,
               datediff('dd', v_now, SUBSTR(a.entrust, 1, 19)) diff
          FROM temp_order a, tmp_queryquitpatientnodoctor b
         WHERE a.noofinpat = b.noofinpat
           AND a.startdate BETWEEN v_ksrq AND v_jsrq
           AND a.ordertype = 3105
           AND a.orderstatus IN (3201, 3202);

      UPDATE tmp_queryquitpatientnodoctor a
         SET extra = (SELECT a.extra || (CASE b.diff
                               WHEN 1 THEN
                                '明日手术'
                               WHEN 0 THEN
                                '今日手术'
                               WHEN -1 THEN
                                '术后1天'
                               WHEN -2 THEN
                                '术后2天'
                               WHEN -3 THEN
                                '术后3天'
                               ELSE
                                ''
                             END) || ' '
                        FROM tmp_queryquitpatientno_extraop b
                       WHERE a.noofinpat = b.noofinpat
                         AND ROWNUM < 1);

      -- 检查出院医嘱:临时医嘱，已审核和已执行的，开始时间、出院时间在当前日期0时之后
      v_sql := 'truncate table tmp_QueryQuitPatientNo_extraop ';

      EXECUTE IMMEDIATE v_sql;

      INSERT INTO tmp_queryquitpatientno_extraop
        SELECT a.noofinpat,
               datediff('dd', v_now, SUBSTR(a.entrust, 1, 10)) diff
          FROM temp_order a, tmp_queryquitpatientnodoctor b
         WHERE a.noofinpat = b.noofinpat
           AND a.startdate >= v_dqrq
           AND a.ordertype = 3113
           AND a.orderstatus IN (3201, 3202);

      UPDATE tmp_queryquitpatientnodoctor a
         SET extra = (SELECT a.extra || (CASE b.diff
                               WHEN 0 THEN
                                '今日出院'
                               WHEN 1 THEN
                                '明日出院'
                               ELSE
                                TO_CHAR(b.diff) || '天后出院'
                             END) || ' '
                        FROM tmp_queryquitpatientno_extraop b
                       WHERE a.noofinpat = b.noofinpat
                         AND ROWNUM < 1);

      -- 检查转科医嘱:根据病人状态
      UPDATE tmp_queryquitpatientnodoctor a
         SET extra = (SELECT a.extra || b.NAME || ' '
                        FROM categorydetail b
                       WHERE b.categoryid = a.brzt
                         AND ROWNUM < 1)
       WHERE a.brzt IN (1505, 1506, 1507);
    */
    -- 检查病人是否有病历
    UPDATE tmp_queryquitpatientnodoctor a
       SET extra = a.extra || '无病历', recordinfo = '无病历'
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS
     (SELECT 1 FROM recorddetail b WHERE a.noofinpat = b.noofinpat);

    IF v_querytype = 0 THEN
      --出院末分配医生
      BEGIN
        OPEN o_result FOR
          SELECT a.*, inp.inwarddate
            FROM tmp_queryquitpatientnodoctor a
            left join inpatient inp
              on a.noofinpat = inp.noofinpat
             and a.zyysdm IS NULL
           order by a.bedid;
      END;
    ELSE
      --全部病患
      BEGIN
        OPEN o_result FOR
          SELECT a.*, substr(inp.inwarddate,1,16) as inwarddate,substr(inp.outhosdate,1,20) as outhosdate
            FROM tmp_queryquitpatientnodoctor a
            left join inpatient inp
              on a.noofinpat = inp.noofinpat
             and a.brzt in ('1502', '1503')
              where( inp.islock<>4701 or inp.islock  is null)
           order by bedid;
      END;
    END IF;
  END;

  /****************************************************************************************************/
  PROCEDURE usp_emr_calcage(v_csrq VARCHAR,
                            v_dqrq VARCHAR,
                            v_sjnl OUT INT,
                            v_xsnl OUT VARCHAR) AS
    v_date3    VARCHAR(24);
    v_date4    VARCHAR(24);
    v_yy       INT;
    v_mm       INT;
    v_dd       INT;
    v_hh       INT;
    v_mi       INT;
    v_tempdate VARCHAR(24);
    v_decmm    INT;
    v_decyy    INT;
    v_dechh    INT;
    v_decmi    INT;
    /**********
     版本号  1.0.0.0.0
     创建时间  2010.8.10
     作者  周辉
     版权
     描述  计算病人年龄
     功能说明
      根据病案统计的要求，计算病人的精确年龄以及用来显示的年龄。
      对于婴幼儿患者，如果年龄只是笼统的几岁，则不能满足临床和统计分析的需要。
     输入参数
       v_csrq varchar(24)Time  --出生日期
      ,v_dqrq varchar(24)Time  --当前日期(截至到此日期的年龄)
      ,v_sjnl int = null output  --计算后的准确年龄(格式为YYYYMMDD,YYYY表示年的数值,MM表示月的数值,DD表示日的数值)
      ,v_xsnl varchar(16) = null output  --显示年龄(根据实际情况显示的年龄,如XXX年,XX月XX天,XX天)
     输出参数
     修改

        妇幼保健院新生儿科需求――出生时间在2小时以内的病人，年龄精确到分钟，出生日期在48小时以内的病人，年龄精确到小时。
     结果集、排序
     调用的sp
     调用实例
      declare v_csrq varchar(24), v_dqrq varchar(24), v_sjnl int, v_xsnl varchar(16)
      select v_csrq = '1978-08-01', v_dqrq = '1978-09-01'
      exec usp_EmrCalcAge v_csrq, v_dqrq, v_sjnl output, v_xsnl output
      select v_sjnl, v_xsnl
    **********/
  BEGIN
    --select v_date3 = substring(v_csrq, 1, 10)
    --  , v_date4 = substring(v_dqrq, 1, 10)
    v_date3 := SUBSTR(v_csrq, 1, 16);
    v_date4 := SUBSTR(v_dqrq, 1, 16);

    IF (isdate(v_date3) <> 1) OR (isdate(v_date4) <> 1) OR
       (v_date3 > v_date4) THEN
      BEGIN
        v_sjnl := 0;
        v_xsnl := '';
        RETURN;
      END;
    END IF;

    v_decmm := 0;
    v_decyy := 0;
    v_dechh := 0;
    v_decmi := 0;

    -- 分钟
    --TO_char(to_timestamp('2013-05-01 11:31:11','yyyy-mm-dd HH24:mi:ss'),'mi')
    -- IF TO_CHAR(v_date4, 'mi') >= TO_CHAR(v_date3, 'mi') THEN
    --这样的时间会有问题  add by ywk 2013年6月26日 11:35:14
    IF TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'mi') >=
       TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'mi') THEN
      v_mi := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'mi') -
              TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'mi');
    ELSE
      BEGIN
        v_decmi := 1;
        v_mi    := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'),
                           'mi') + 60 -
                   TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'),
                           'mi');
      END;
    END IF;

    --小时
    IF (TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'hh24') -
       v_decmi) >=
       TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'hh24') THEN
      v_hh := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'),
                      'hh24') - v_decmi -
              TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'),
                      'hh24');
    ELSE
      BEGIN
        v_dechh := 1;
        v_hh    := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'),
                           'hh24') - v_decmi + 24 -
                   TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'),
                           'hh24');
      END;
    END IF;

    --天
    IF (TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'dd') -
       v_dechh) >=
       TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'dd') THEN
      v_dd := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'dd') -
              v_dechh -
              TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'dd');
    ELSE
      BEGIN
        v_decmm := 1;

        v_dd := TO_CHAR(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'),
                        'dd') - v_dechh +
                datediff('dd',
                         v_date3,
                         to_char(ADD_MONTHS(to_date(v_date3,
                                                    'yyyy-mm-dd HH24:mi:ss'),
                                            1),
                                 'yyyy-mm-dd HH24:mi:ss')) -
                TO_CHAR(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'),
                        'dd');
        /*v_decmm := 1;
        v_dd := TO_char(to_timestamp(v_date4,'yyyy-mm-dd HH24:mi:ss'),'dd')
        - v_dechh +
                   datediff('dd', v_date3
                   , ADD_MONTHS(to_date(v_date3,'yyyy-mm-dd HH24:mi:ss'), 1)) -
                   TO_char(to_timestamp(v_date3,'yyyy-mm-dd HH24:mi:ss'),'dd');*/
      END;
    END IF;

    --月
    IF (TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'mm') -
       v_decmm) >=
       TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'mm') THEN
      v_mm := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'), 'mm') -
              v_decmm -
              TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'), 'mm');
    ELSE
      BEGIN
        v_decyy := 1;
        v_mm    := TO_char(to_timestamp(v_date4, 'yyyy-mm-dd HH24:mi:ss'),
                           'mm') - v_decmm + 12 -
                   TO_char(to_timestamp(v_date3, 'yyyy-mm-dd HH24:mi:ss'),
                           'mm');
      END;
    END IF;

    --年
    v_yy   := datediff('yy', v_date3, v_date4) - v_decyy;
    v_sjnl := v_yy * 10000 + v_mm * 100 + v_dd;

    IF v_yy > 1 THEN
      -- 2岁及以上的情况
      v_xsnl := TO_CHAR(v_yy) || '岁';
    ELSIF v_yy = 1 THEN
      v_xsnl := TO_CHAR(v_yy * 12 + v_mm) || '个月';
    ELSIF (v_mm > 1) OR ((v_mm = 1) AND (v_dd = 0)) THEN
      v_xsnl := TO_CHAR(v_mm) || '个月';
    ELSIF v_mm = 1 THEN
      v_xsnl := TO_CHAR(v_mm) || '个月' || TO_CHAR(v_dd) || '天';
    ELSIF v_dd > 1 THEN
      v_xsnl := TO_CHAR(v_dd) || '天';
    ELSIF v_dd = 1 THEN
      v_xsnl := TO_CHAR(v_dd * 24 + v_hh) || '个小时';
    ELSIF v_hh > 1 THEN
      v_xsnl := TO_CHAR(v_hh) || '个小时';
    ELSIF v_hh = 1 THEN
      v_xsnl := TO_CHAR(v_hh * 60 + v_mi) || '分钟';
    ELSE
      v_xsnl := TO_CHAR(v_mi) || '分钟';
    END IF;

    RETURN;
  END;

  /***********************************************************************************/
  procedure usp_EMR_GetAge(v_csrq varchar,
                           v_dqrq varchar,
                           v_sjnl out int,
                           v_xsnl out varchar) as
    d_csrq date;
    d_dqrq date;

  begin
    d_csrq := to_date(substr(v_csrq, 1, 10), 'yyyy-mm-dd');
    d_dqrq := to_date(substr(v_dqrq, 1, 10), 'yyyy-mm-dd');

    v_sjnl := TRUNC(Months_between(d_dqrq, d_csrq) / 12);
    v_xsnl := v_sjnl || '岁' /*||
                                                                    (TRUNC(d_dqrq) - ADD_MONTHS(d_csrq, v_sjnl * 12)) || '天'*/
     ;

  end usp_EMR_GetAge;

  --医师工作站得到出院病人
  PROCEDURE usp_queryinwardpatientsout(v_wardid    VARCHAR,
                                       v_deptids   VARCHAR,
                                       v_id        VARCHAR DEFAULT '',
                                       v_querytype INT DEFAULT 0,
                                       o_result    OUT empcurtyp) AS
    v_wardid_in VARCHAR(6);
    v_dqrq      VARCHAR(10);
    v_ksrq      VARCHAR(10);
    v_jsrq      VARCHAR(10);
    v_now       VARCHAR(24);
    v_sql       VARCHAR(4000);
  BEGIN

    IF v_wardid IS NULL THEN
      v_wardid_in := '';
    END IF;

    v_sql := 'truncate table tmp_QueryInwardPatients ';

    EXECUTE IMMEDIATE v_sql;

    INSERT INTO tmp_queryinwardpatients
      SELECT b.noofinpat noofinpat, --首页序号
             b.patnoofhis patnoofhis, --HIS首页序号
             b.patid patid, --住院号
             b.name patname, --姓名
             b.sexid sex, --病人性别
             j.name sexname, --病人性别名称
             b.agestr agestr, --年龄
             b.py py, --拼音
             b.wb wb, --五笔
             b.status brzt, --病人状态
             e.name brztname, --病人状态名称
             RTRIM(b.criticallevel) wzjb, --危重级别
             i.name wzjbmc, --危重级别名称
             --cd.name hljb,

             --CASE WHEN b.attendlevel IS NULL THEN 6105 ELSE to_number(b.attendlevel)
             --END attendlevel, --护理级别

             case b.attendlevel
               when '1' then
                '一级护理'
               when '2' then
                '二级护理'
               when '3' then
                '三级护理'
               when '4' then
                '特级护理'
               else
                '一级护理'
             end hljb, --护理级别

             case b.attendlevel
               when '1' then
                '6101'
               when '2' then
                '6102'
               when '3' then
                '6103'
               when '4' then
                '6104'
               else
                '6101'
             end attendlevel, --护理级别
             b.isbaby yebz, --婴儿标志
             CASE
               WHEN b.isbaby = '0' THEN
                '否'
               WHEN b.isbaby IS NULL THEN
                ''
               ELSE
                '是'
             END yebzname,
             a.wardid bqdm, --病区代码
             a.deptid ksdm, --科室代码
             --a.ID bedid, --床位代码
             b.outbed bedid, --床位代码
             dg.NAME ksmc, --科室名称
             wh.NAME bqmc, --病区名称
             a.formerward ybqdm, --原病区代码
             a.formerdeptid yksdm, --原科室代码
             a.formerdeptid ycwdm, --原床位代码
             a.inbed inbed, --占床标志
             a.borrow jcbz, --借床标志
             a.sexinfo cwlx, --床位类型
             SUBSTR(to_date(b.admitdate,'yyyy-mm-dd 24hh:mi:ss'), 1, 20) admitdate, --入院日期
             b.admitdiagnosis ryzd, --入院诊断
             b.admitdiagnosis zdmc, --诊断名称
             b.resident zyysdm, --住院医生代码
             c.NAME zyys, --住院医生
             c.NAME cwys, --床位医生
             g.NAME zzys, --主治医师
             h.NAME zrys, --主任医师
             a.valid yxjl, --有效记录
             --me.pzlx pzlx, --凭证类型
             dd1.NAME pzlx, --费用类别
             CASE
               WHEN b.outhosdept = v_deptids AND b.outhosward = v_wardid THEN
                '本科室'
               ELSE
                '属于其他科室'
             END extra, --额外信息
             b.memo memo, --备注
             CASE b.cpstatus
               WHEN 0 THEN
                '未引入'
               WHEN 1 THEN
                '执行中'
               WHEN 2 THEN
                '退出'
             END cpstatus,
             CASE
               WHEN b.noofinpat IS NULL THEN
                ''
               ELSE
                '己书写'
             END recordinfo,
             100 ye, --余额
             (SELECT CASE
                       WHEN COUNT(qc.foulstate) > 0 THEN
                        '是'
                       ELSE
                        '否'
                     END
                FROM qcrecord qc
               WHERE qc.noofinpat = b.noofinpat
                 AND qc.valid = 1
                 AND qc.foulstate = 1) AS iswarn, --是否违规
             b.incount as rycs --入院次数
        FROM inpatient b
        LEFT JOIN bed a
          ON a.noofinpat = b.noofinpat
         AND a.patnoofhis = b.patnoofhis
         AND a.inbed = 1301 --占床
        LEFT JOIN Dictionary_detail dd1
          ON dd1.categoryid = '1'
         AND b.payid = dd1.detailid
        LEFT JOIN categorydetail e
          ON b.status = e.ID
         AND e.categoryid = '15'
        LEFT JOIN department dg
          ON b.outhosdept = dg.ID
        LEFT JOIN ward wh
          ON b.outhosward = dg.ID
        LEFT JOIN diagnosis f
          ON f.icd = b.admitdiagnosis
        LEFT JOIN users c
          ON c.ID = b.resident
        LEFT JOIN dictionary_detail i
          ON i.detailid = b.criticallevel
         AND i.categoryid = '53'
        LEFT JOIN users g
          ON g.ID = b.attend
        LEFT JOIN users h
          ON h.ID = b.chief
        LEFT JOIN dictionary_detail j
          ON j.detailid = b.sexid
         AND j.categoryid = '3'
        LEFT JOIN categorydetail cd
          ON b.attendlevel = cd.ID
         AND cd.categoryid = '63'
       WHERE ((b.outhosdept = v_deptids AND b.outhosward = v_wardid) OR
             (v_deptids IN
             (SELECT bedinfo.newdept
                  FROM bedinfo
                 WHERE bedinfo.noofinpat = b.noofinpat) AND
             v_wardid IN
             (SELECT bedinfo.newward
                  FROM bedinfo
                 WHERE bedinfo.noofinpat = b.noofinpat)))
         AND a.valid is null;

    -- 检查病人是否有病历
    UPDATE tmp_queryinwardpatients a
       SET extra = extra || '无病历', recordinfo = '无病历'
     WHERE noofinpat IS NOT NULL
       AND NOT EXISTS (SELECT 1
              FROM recorddetail b
             WHERE a.noofinpat = b.noofinpat
               and b.valid = '1');

    OPEN o_result FOR
      SELECT *
        FROM tmp_queryinwardpatients a
       WHERE a.noofinpat IS NOT NULL
            /*AND NOT EXISTS (SELECT 1
             FROM doctor_assignpatient d
            WHERE d.valid = 1
              AND d.noofinpat = a.noofinpat)*/
         AND a.zyysdm = v_id
         AND ((
             /*
             EXISTS
             (
                 select 1 from recorddetail
                 where recorddetail.noofinpat = a.noofinpat and recorddetail.valid = '1'
                 having count(*) > 0
             )*/
              a.recordinfo != '无病历' AND EXISTS
              (select 1
                  from recorddetail
                 where recorddetail.noofinpat = a.noofinpat
                   and recorddetail.valid = '1'
                   and recorddetail.islock = '4700' having count(*) > 0)) OR
             (
             /*
             EXISTS
             (
                 select 1 from recorddetail
                 where recorddetail.noofinpat = a.noofinpat and recorddetail.valid = '1'
                 having count(*) = 0
             )*/
              a.recordinfo = '无病历'))
       ORDER BY a.bedid;
  END;

  ----医生工作站中获得会诊信息（全部符合条件的）
  PROCEDURE usp_GetMyConsultion(v_Deptids varchar, --部门编号
                                V_userid  varchar, --登录人编号
                                o_result  OUT empcurtyp) as
  BEGIN
    OPEN o_result FOR

      SELECT ip.NAME AS inpatientname,

             ip.py,
             ip.wb,
             TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                     'yyyy-mm-dd hh24:mi:ss') AS consulttime,
             cd.NAME AS consultstatus,
             cd1.NAME AS urgencytype,
             ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
             ca.stateid,
             u.name as applyusername,
             aa.name as shouyaoren,
             ca.noofinpat,
             ca.modifieduser,
             ca.finishtime,
             ca.consulttypeid,
             ca.applyuser,
             ca.applydept,
             ca.audituserid,
             ca.applytime,
             (case
               when ca.ispay = '1' then
                '已缴费'
               when ca.ispay = '0' then
                '未缴费'
               when ca.ispay is null then
                '未缴费'
             end) MyPay,
             ca.ispay,
             ca.consultapplysn,
             hh.departmentcode, --受邀科室
             hh.employeelevelid, --受邀人级别
             hh.employeecode, --受邀人工号
             -- hh.issignin         --是否签到
             ip.outhosdept,
             ip.outhosward
        FROM consultapply ca
        LEFT OUTER JOIN users u
          ON u.ID = ca.applyuser
        LEFT OUTER JOIN inpatient ip
          ON ip.noofinpat = ca.noofinpat
        LEFT OUTER JOIN categorydetail cd
          ON cd.categoryid = '67'
         AND ca.stateid = cd.ID
        left outer JOIN consultapplydepartment hh
          on ca.consultapplysn = hh.consultapplysn
         AND hh.valid = '1'
        left outer join users aa
          on aa.id = hh.employeecode
        LEFT OUTER JOIN categorydetail cd1
          ON cd1.categoryid = '66'
         AND cd1.ID = ca.urgencytypeid
       WHERE ca.valid = '1'
         AND ip.status IN
             ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
         and (stateid = '6730' or stateid = '6770' or stateid = '6720' or
             stateid = '6750' or stateid = '6740' or
             stateid = '6741' and
             to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') >
             trunc(sysdate) - 3)
            /*and u.id=V_userid*/
         and (u.id = V_userid or ca.applydept = v_Deptids)
      union
      SELECT ip.NAME AS inpatientname,

             ip.py,
             ip.wb,
             TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                     'yyyy-mm-dd hh24:mi:ss') AS consulttime,
             cd.NAME AS consultstatus,
             cd1.NAME AS urgencytype,
             ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
             ca.stateid,
             u.name as applyusername,
             aa.name as shouyaoren,
             ca.noofinpat,
             ca.modifieduser,
             ca.finishtime,
             ca.consulttypeid,
             ca.applyuser,
             ca.applydept,
             ca.audituserid,
             ca.applytime,
             (case
               when ca.ispay = '1' then
                '已缴费'
               when ca.ispay = '0' then
                '未缴费'
               when ca.ispay is null then
                '未缴费'
             end) MyPay,
             ca.ispay,
             ca.consultapplysn,
             hh.departmentcode, --受邀科室
             hh.employeelevelid, --受邀人级别
             hh.employeecode, --受邀人工号
             --hh.issignin         --是否签到
             ip.outhosdept,
             ip.outhosward
        FROM consultapply ca
        LEFT OUTER JOIN users u
          ON u.ID = ca.applyuser
         AND u.valid = '1'
        LEFT OUTER JOIN inpatient ip
          ON ip.noofinpat = ca.noofinpat
        LEFT OUTER JOIN categorydetail cd
          ON cd.categoryid = '67'
         AND ca.stateid = cd.ID
        LEFT OUTER JOIN categorydetail cd1
          ON cd1.categoryid = '66'
         AND cd1.ID = ca.urgencytypeid
        left outer JOIN consultapplydepartment hh
          on ca.consultapplysn = hh.consultapplysn
         AND hh.valid = '1'
        left outer join users aa
          on aa.id = hh.employeecode
       WHERE ca.valid = '1'
         and hh.departmentcode = v_Deptids
         AND ip.status IN
             ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
         and (stateid = '6730' or stateid = '6770' or stateid = '6720' or
             stateid = '6750' or stateid = '6740' or
             stateid = '6741' and
             to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') >
             trunc(sysdate) - 3)
         and (hh.employeecode = V_userid or (hh.employeecode is null)); -- or hh.employeelevelid=u.grade));

  END;

  PROCEDURE usp_editBabyinfo(v_Noofinpat  NUMERIC,
                             v_patnoofhis VARCHAR,
                             v_Noofclinic VARCHAR,
                             v_Noofrecord VARCHAR,
                             v_patid      VARCHAR,
                             v_Innerpix   VARCHAR,
                             v_outpix     VARCHAR,

                             v_Name            VARCHAR,
                             v_py              VARCHAR,
                             v_wb              VARCHAR,
                             v_payid           VARCHAR,
                             v_ORIGIN          VARCHAR,
                             v_InCount         int DEFAULT 0,
                             v_sexid           VARCHAR,
                             v_Birth           VARCHAR,
                             v_Age             int DEFAULT 0,
                             v_AgeStr          VARCHAR,
                             v_IDNO            VARCHAR,
                             v_Marital         VARCHAR,
                             v_JobID           VARCHAR,
                             v_CSDProvinceID   VARCHAR,
                             v_CSDCityID       VARCHAR,
                             v_CSDDistrictID   VARCHAR,
                             v_NationID        VARCHAR,
                             v_NationalityID   VARCHAR,
                             v_JGProvinceID    VARCHAR,
                             v_JGCityID        VARCHAR,
                             v_Organization    VARCHAR,
                             v_OfficePlace     VARCHAR,
                             v_OfficeTEL       VARCHAR,
                             v_OfficePost      VARCHAR,
                             v_HKDZProvinceID  VARCHAR,
                             v_HKDZCityID      VARCHAR,
                             v_HKDZDistrictID  VARCHAR,
                             v_NATIVEPOST      VARCHAR,
                             v_NATIVETEL       VARCHAR,
                             v_NATIVEADDRESS   VARCHAR,
                             v_ADDRESS         VARCHAR,
                             v_ContactPerson   VARCHAR,
                             v_RelationshipID  VARCHAR,
                             v_ContactAddress  VARCHAR,
                             v_ContactTEL      VARCHAR,
                             v_CONTACTOFFICE   VARCHAR,
                             v_CONTACTPOST     VARCHAR,
                             v_OFFERER         VARCHAR,
                             v_SocialCare      VARCHAR,
                             v_INSURANCE       VARCHAR,
                             v_CARDNO          VARCHAR,
                             v_ADMITINFO       VARCHAR,
                             v_AdmitDeptID     VARCHAR,
                             v_AdmitWardID     VARCHAR,
                             v_ADMITBED        VARCHAR,
                             v_AdmitDate       VARCHAR,
                             v_INWARDDATE      VARCHAR,
                             v_ADMITDIAGNOSIS  VARCHAR,
                             v_OutWardDate     VARCHAR,
                             v_OutHosDeptID    VARCHAR,
                             v_OutHosWardID    VARCHAR,
                             v_OutBed          VARCHAR,
                             v_OUTHOSDATE      VARCHAR,
                             v_OUTDIAGNOSIS    VARCHAR,
                             v_TOTALDAYS       int DEFAULT 0,
                             v_CLINICDIAGNOSIS VARCHAR,
                             v_SOLARTERMS      VARCHAR,
                             v_ADMITWAY        VARCHAR,
                             v_OUTWAY          VARCHAR,
                             v_CLINICDOCTOR    VARCHAR,
                             v_RESIDENT        VARCHAR,
                             v_ATTEND          VARCHAR,
                             v_CHIEF           VARCHAR,
                             v_EDU             VARCHAR,
                             v_EDUC            int DEFAULT 0,
                             v_RELIGION        VARCHAR,
                             v_STATUS          int DEFAULT 0,
                             v_CRITICALLEVEL   VARCHAR,
                             v_ATTENDLEVEL     VARCHAR,
                             v_EMPHASIS        int DEFAULT 0,
                             v_ISBABY          int DEFAULT 0,
                             v_MOTHER          NUMERIC,
                             v_MEDICAREID      VARCHAR,
                             v_MEDICAREQUOTA   int DEFAULT 0,
                             v_VOUCHERSCODE    VARCHAR,
                             v_STYLE           VARCHAR,
                             v_OPERATOR        VARCHAR,
                             v_MEMO            VARCHAR,
                             v_CPSTATUS        int DEFAULT 0,
                             v_OUTWARDBED      int DEFAULT 0,
                             v_XZZProvinceID   VARCHAR,
                             v_XZZCityID       VARCHAR,
                             v_XZZDistrictID   VARCHAR,
                             v_XZZTEL          VARCHAR,
                             v_XZZPost         VARCHAR,
                             v_EditType        varchar) as
    m_babycount int;
  begin
    select count(*)
      into m_babycount
      from inpatient
     where mother = v_MOTHER;
    /* select nvl(v_ADMITDEPT, AdmitDept)
     into myadmitdept
     from inpatient
    where NoOfInpat = v_NOOFINPAT;*/
    --1是新增，2是编辑
    IF v_EditType = '1' THEN
      insert into inpatient
        (NOOFINPAT,
         PATNOOFHIS,
         NOOFCLINIC,
         NOOFRECORD,
         PATID,
         INNERPIX,
         OUTPIX,
         NAME,
         PY,
         WB,
         PAYID,
         ORIGIN,
         INCOUNT,
         SEXID,
         BIRTH,
         AGE,
         AGESTR,
         IDNO,
         MARITAL,
         JOBID,
         PROVINCEID,
         COUNTYID,
         NATIONID,
         NATIONALITYID,
         NATIVEPLACE_P,
         NATIVEPLACE_C,
         ORGANIZATION,
         OFFICEPLACE,
         OFFICETEL,
         OFFICEPOST,
         NATIVEADDRESS,
         NATIVETEL,
         NATIVEPOST,
         ADDRESS,
         CONTACTPERSON,
         RELATIONSHIP,
         CONTACTADDRESS,
         CONTACTOFFICE,
         CONTACTTEL,
         CONTACTPOST,
         OFFERER,
         SOCIALCARE,
         INSURANCE,
         CARDNO,
         ADMITINFO,
         ADMITDEPT,
         ADMITWARD,
         ADMITBED,
         ADMITDATE,
         INWARDDATE,
         ADMITDIAGNOSIS,
         OUTHOSDEPT,
         OUTHOSWARD,
         OUTBED,
         OUTWARDDATE,
         OUTHOSDATE,
         OUTDIAGNOSIS,
         TOTALDAYS,
         CLINICDIAGNOSIS,
         SOLARTERMS,
         ADMITWAY,
         OUTWAY,
         CLINICDOCTOR,
         RESIDENT,
         ATTEND,
         CHIEF,
         EDU,
         EDUC,
         RELIGION,
         STATUS,
         CRITICALLEVEL,
         ATTENDLEVEL,
         EMPHASIS,
         ISBABY,
         MOTHER,
         MEDICAREID,
         MEDICAREQUOTA,
         VOUCHERSCODE,
         STYLE,
         OPERATOR,
         MEMO,
         CPSTATUS,
         OUTWARDBED,
         DISTRICTID,
         XZZPROVICEID,
         XZZCITYID,
         XZZDISTRICTID,
         XZZTEL,
         HKDZPROVICEID,
         HKZDCITYID,
         HKZDDISTRICTID,
         XZZPOST
         -- babycount
         )
      values
        (SEQ_INPATIENT_ID.NEXTVAL,
         v_patnoofhis,
         v_Noofclinic,
         v_Noofrecord,
         v_patid,
         v_Innerpix,
         v_outpix,
         v_Name,
         v_py,
         v_wb,
         v_payid,
         v_ORIGIN,
         v_InCount,
         v_sexid,
         v_Birth,
         v_Age,
         v_AgeStr,
         v_IDNO,
         v_Marital,
         v_JobID,
         v_CSDProvinceID,
         v_CSDCityID,
         v_NationID,
         v_NationalityID,
         v_JGProvinceID,
         v_JGCityID,
         v_Organization,
         v_OfficePlace,
         v_OfficeTEL,
         v_OfficePost,
         v_NATIVEADDRESS,
         v_NATIVETEL,
         v_NATIVEPOST,
         v_ADDRESS,
         v_ContactPerson,
         v_RelationshipID,
         v_ContactAddress,
         v_CONTACTOFFICE,
         v_ContactTEL,
         v_CONTACTPOST,
         v_OFFERER,
         v_SocialCare,
         v_INSURANCE,
         v_CARDNO,
         v_ADMITINFO,
         v_AdmitDeptID,
         v_AdmitWardID,
         v_ADMITBED,
         v_AdmitDate,
         v_INWARDDATE,
         v_ADMITDIAGNOSIS,
         v_OutHosDeptID,
         v_OutHosWardID,
         v_OutBed,
         v_OutWardDate,
         v_OUTHOSDATE,
         v_OUTDIAGNOSIS,
         v_TOTALDAYS,
         v_CLINICDIAGNOSIS,
         v_SOLARTERMS,
         v_ADMITWAY,
         v_OUTWAY,
         v_CLINICDOCTOR,
         v_RESIDENT,
         v_ATTEND,
         v_CHIEF,
         v_EDU,
         v_EDUC,
         v_RELIGION,
         v_STATUS,
         v_CRITICALLEVEL,
         v_ATTENDLEVEL,
         v_EMPHASIS,
         v_ISBABY,
         v_MOTHER,
         v_MEDICAREID,
         v_MEDICAREQUOTA,
         v_VOUCHERSCODE,
         v_STYLE,
         v_OPERATOR,
         v_memo,
         v_CPSTATUS,
         v_OUTWARDBED,
         v_CSDDistrictID,
         v_XZZProvinceID,
         v_XZZCityID,
         v_XZZDistrictID,
         v_XZZTEL,
         v_HKDZProvinceID,
         v_HKDZCityID,
         v_HKDZDistrictID,
         v_XZZPost
         -- m_babycount+1
         );
      commit;
      update inpatient
         set babycount = m_babycount + 1
       where noofinpat = v_MOTHER;
      commit;
    ELSIF v_EditType = '2' THEN
      --编辑
      update inpatient
         set name   = v_Name,
             Age    = v_Age,
             birth  = v_Birth,
             sexid  = v_sexid,
             Agestr = v_AgeStr
       where noofinpat = v_Noofinpat;
      commit;
    elsif v_EditType = '3' then
      -- 删除
      delete inpatient where noofinpat = v_Noofinpat;
      commit;
      update inpatient
         set babycount = m_babycount - 1
       where noofinpat = v_MOTHER;
      commit;
    end if;
  end;
  ----质控出院未归档病历查询
  -----Add by xlb 2013-06-04
  PROCEDURE usp_GetOutHosButNotLocks(v_deptId    VARCHAR2, ---科室代码
                                     v_sex       VARCHAR2, --性别
                                     v_dateBegin VARCHAR2, --出院起始时间
                                     v_dateEnd   VARCHAR2, --出院结束时间
                                     v_patName   VARCHAR2, ----病人姓名
                                     v_PatId     VARCHAR2,
                                     o_result    OUT empcurtyp) as
    p_begindate VARCHAR2(50);
    p_EndDate   VARCHAR2(50);
  begin
    p_begindate := v_dateBegin || ' 00:00:00';
    p_EndDate   := v_dateEnd || ' 23:59:59';
    open o_result for
      select (case
               when count(b.ID) > 0 then
                '书写'
               else
                '未写'
             end) RECORDSTATE,
             '' QC,
             a.NoOfInpat AS NOOFINPAT,
             a.PatID as PATID,
             a.Name PATNAME,
             (case
               when a.SexID = 1 then
                '男'
               when a.SexID = 2 then
                '女'
               else
                '未知'
             end) as PATSEX,
             1 AS INHOSPITAL,
             dept.name DEPTNAME,
             a.AdmitDiagnosis PATDIAGNAME,
             a.admitdate INHOSPITALTIME,
             a.outhosdate OUTHOSPITALTIME,

             bas.iem_mainpage_no      as IEMNO,
             diagnosis.diagnosis_name as DIAGNOSISNAME,
             --wmsys.wm_concat(diagnosis.diagnosis_name) as DIAGNOSISNAME ,

             to_char(to_date(a.admitdate, 'yyyy-mm-dd HH24:mi:ss') + 1,
                     'yyyy-mm-dd') SUREDIAGTIME,
             users.name DOCNAME,
             a.AgeStr PATAGE,
             datediff('dd',
                      a.admitdate,
                      NVL(trim(a.outwarddate),
                          TO_CHAR(SYSDATE, 'yyyy-mm-dd'))) INCOUNT

        from INPATIENT                   a,
             RecordDetail                b,
             diagnosis                   diag,
             department                  dept,
             users                       users,
             iem_mainpage_basicinfo_2012 bas,
             iem_mainpage_diagnosis_2012 diagnosis
       where a.NOOFINPAT = b.NoOfInpat(+)
         and a.AdmitDiagnosis = diag.markid(+)
         and a.outhosdept = dept.id(+)
         and a.Resident = users.id(+)

         and a.NOOFINPAT = bas.NOOFINPAT(+)
         and bas.iem_mainpage_no = diagnosis.iem_mainpage_no(+)
         and diagnosis.diagnosis_type_id <> 13

         and a.status in (1502, 1503)
         and a.islock in (4700, 4702, 4703)
         and (a.OutHosDept = v_deptId or v_deptId = '' or v_deptId is null)
         AND (a.sexid = v_sex OR v_sex = '' OR v_sex IS NULL)
         and to_date(substr(nvl(trim(a.outhosdate), '1990-01-01 00:00:00'),
                            1,
                            20),
                     'yyyy-mm-dd hh24:mi:ss') >=
             to_date(p_begindate, 'yyyy-mm-dd hh24:mi:ss')
         and to_date(substr(nvl(trim(a.outhosdate), '1990-01-01 00:00:00'),
                            1,
                            20),
                     'yyyy-mm-dd hh24:mi:ss') <
             to_date(p_EndDate, 'yyyy-mm-dd hh24:mi:ss') --原来的是p_begindate edit by ywk
         and (a.Name = v_patName or v_patName = '' or v_patName is null)
         and (a.patid = v_PatId or v_PatId = '' or v_PatId is null)
       group by a.NoOfInpat,
                a.PatID,
                a.NAME,
                a.SEXID,
                A.AGESTR,
                a.OUTBED,
                a.AdmitDiagnosis,
                a.admitdate,
                a.outwarddate,
                diag.name,
                dept.name,
                a.outhosdate,
                bas.iem_mainpage_no,
                diagnosis.diagnosis_name,
                users.name;

  end;

END;
/

prompt
prompt Creating package body EMRQCMANAGER
prompt ==================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emrqcmanager IS
  PROCEDURE usp_getpatientlist(v_deptid         VARCHAR2,
                               v_patid          VARCHAR2,
                               v_name           VARCHAR2,
                               v_status         VARCHAR2,
                               v_admitbegindate VARCHAR2,
                               v_admitenddate   VARCHAR2,
                               o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT inpatient.outhosdept deptno,
             department.NAME      deptname,
             inpatient.patid,
             inpatient.NAME,
             inpatient.noofinpat,
             inpatient.admitdate, --新增入院时间列 add by ywk 2012年8月10日 09:18:23
             inpatient.status --新增病人状态列 add by wyt 2012年12月10日
        FROM inpatient
        LEFT OUTER JOIN department
          ON department.ID = inpatient.outhosdept
       WHERE inpatient.outhosdept LIKE '%' || v_deptid || '%'
         AND inpatient.patid LIKE '%' || v_patid || '%'
         AND inpatient.NAME LIKE '%' || v_name || '%'
         AND inpatient.status LIKE '%' || v_status || '%'
         AND (inpatient.admitdate >= p_admitbegindate AND
             inpatient.admitdate <= p_admitenddate);
  END;
  --by xlb 2012-12-26 获取病人列表，要对出院和出区病人进行重点病人类型查询

  PROCEDURE usp_getpatientlistandpat(v_deptid         VARCHAR2,
                                     v_patid          VARCHAR2,
                                     v_name           VARCHAR2,
                                     v_status         VARCHAR2,
                                     v_admitbegindate VARCHAR2,
                                     v_admitenddate   VARCHAR2,
                                     o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT distinct inpatient.outhosdept deptno,
                      department.NAME      deptname,
                      inpatient.patid,
                      inpatient.NAME,
                      inpatient.noofinpat,
                      inpatient.admitdate,
                      inpatient.status,
                      m.zg_flag,
                      m.outhostype,
                      --o.close_level,       edit by wangj 2013 3 6 一个病人此记录不止一条
                      o.iem_mainpage_no,
                      u.name            DOCTORNAME,
                      f.bloodfee
        FROM inpatient
        LEFT OUTER JOIN department
          ON department.ID = inpatient.outhosdept
        left join iem_mainpage_basicinfo_2012 m
          on inpatient.noofinpat = m.noofinpat
        left join iem_mainpage_operation_2012 o
          on m.iem_mainpage_no = o.iem_mainpage_no
        left join iem_mainpage_feeinfo f
          on m.iem_mainpage_no = f.iem_mainpage_no
        left join users u
          on u.id = inpatient.resident
       WHERE inpatient.outhosdept LIKE '%' || v_deptid || '%'
         and (m.valide = '1' or m.valide is null or m.valide = '') --排除无效数据)
         and (o.valide = '1' or o.valide is null or o.valide = '')
         and (f.valid = '1' or f.valid is null or f.valid = '')
         AND inpatient.patid LIKE '%' || v_patid || '%'
         AND inpatient.NAME LIKE '%' || v_name || '%'
         AND inpatient.status LIKE '%' || v_status || '%'
         AND (inpatient.admitdate >= p_admitbegindate AND
             inpatient.admitdate <= p_admitenddate);
  END;


PROCEDURE usp_getpatientlistandpat_ZY(v_deptid         VARCHAR2,
                                     v_patid          VARCHAR2,
                                     v_name           VARCHAR2,
                                     v_status         VARCHAR2,
                                     v_admitbegindate VARCHAR2,
                                     v_admitenddate   VARCHAR2,
                                     o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT distinct inpatient.outhosdept deptno,
                      department.NAME      deptname,
                      inpatient.patid,
                      inpatient.NAME,
                      inpatient.noofinpat,
                      inpatient.admitdate,
                      inpatient.status,
                      '' as zg_flag,
                      m.outhostype,
                      --o.close_level,       edit by wangj 2013 3 6 一个病人此记录不止一条
                      o.iem_mainpage_no,
                      u.name            DOCTORNAME,
                      f.bloodfee
        FROM inpatient
        LEFT OUTER JOIN department
          ON department.ID = inpatient.outhosdept
        left join iem_mainpage_basicinfo_sx m
          on inpatient.noofinpat = m.noofinpat
        left join iem_mainpage_operation_sx o
          on m.iem_mainpage_no = o.iem_mainpage_no
        left join Iem_Mainpage_Feeinfozy f
          on inpatient.noofinpat=f.noofinpat
        left join users u
          on u.id = inpatient.resident
       WHERE inpatient.outhosdept LIKE '%' || v_deptid || '%'
         and (m.valide = '1' or m.valide is null or m.valide = '') --排除无效数据)
         and (o.valide = '1' or o.valide is null or o.valide = '')
         and (f.valid = '1' or f.valid is null or f.valid = '')
         AND inpatient.patid LIKE '%' || v_patid || '%'
         AND inpatient.NAME LIKE '%' || v_name || '%'
         AND inpatient.islock LIKE '%' || v_status || '%'
         AND (inpatient.admitdate >= p_admitbegindate AND
             inpatient.admitdate <= p_admitenddate);
  END;





  PROCEDURE usp_getpatientlistandpatSZ(v_deptid         VARCHAR2,
                                       v_patid          VARCHAR2,
                                       v_name           VARCHAR2,
                                       v_status         VARCHAR2,
                                       v_admitbegindate VARCHAR2,
                                       v_admitenddate   VARCHAR2,
                                       o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT distinct inpatient.outhosdept deptno,
                      department.NAME      deptname,
                      inpatient.patid,
                      inpatient.NAME,
                      inpatient.noofinpat,
                      inpatient.admitdate,
                      inpatient.status,
                      m.zg_flag,
                      m.outhostype, -- add by cyq 2013-04-30
                      --o.close_level,       edit by wangj 2013 3 6 一个病人此记录不止一条
                      o.iem_mainpage_no,
                      u.name            DOCTORNAME,
                      f.bloodfee
        FROM inpatient
        LEFT OUTER JOIN department
          ON department.ID = inpatient.outhosdept
        left join iem_mainpage_basicinfo_2012 m
          on inpatient.noofinpat = m.noofinpat
        left join iem_mainpage_operation_2012 o
          on m.iem_mainpage_no = o.iem_mainpage_no
        left join iem_mainpage_feeinfo f
          on m.iem_mainpage_no = f.iem_mainpage_no
        left join doctor_assignpatient da
          on da.noofinpat = inpatient.noofinpat
        left join users u
          on u.id = da.create_user
       WHERE inpatient.outhosdept LIKE '%' || v_deptid || '%'
         and (m.valide = '1' or m.valide is null or m.valide = '') --排除无效数据)
         and (o.valide = '1' or o.valide is null or o.valide = '')
         and (f.valid = '1' or f.valid is null or f.valid = '')
         AND inpatient.patid LIKE '%' || v_patid || '%'
         AND inpatient.NAME LIKE '%' || v_name || '%'
         AND inpatient.status LIKE '%' || v_status || '%'
         AND (inpatient.admitdate >= p_admitbegindate AND
             inpatient.admitdate <= p_admitenddate);
  END;





  PROCEDURE usp_getpatientlistandpatSZ_ZY(v_deptid         VARCHAR2,
                                       v_patid          VARCHAR2,
                                       v_name           VARCHAR2,
                                       v_status         VARCHAR2,
                                       v_admitbegindate VARCHAR2,
                                       v_admitenddate   VARCHAR2,
                                       o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT distinct inpatient.outhosdept deptno,
                      department.NAME      deptname,
                      inpatient.patid,
                      inpatient.NAME,
                      inpatient.noofinpat,
                      inpatient.admitdate,
                      inpatient.status,
                      '' as zg_flag,
                      m.outhostype, -- add by cyq 2013-04-30
                      --o.close_level,       edit by wangj 2013 3 6 一个病人此记录不止一条
                      o.iem_mainpage_no,
                      u.name            DOCTORNAME,
                      f.bloodfee
        FROM inpatient
        LEFT OUTER JOIN department
          ON department.ID = inpatient.outhosdept
        left join iem_mainpage_basicinfo_sx m
          on inpatient.noofinpat = m.noofinpat
        left join iem_mainpage_operation_sx o
          on m.iem_mainpage_no = o.iem_mainpage_no
        left join iem_mainpage_feeinfozy f
          on inpatient.noofinpat=f.noofinpat
        left join doctor_assignpatient da
          on da.noofinpat = inpatient.noofinpat
        left join users u
          on u.id = da.create_user
       WHERE inpatient.outhosdept LIKE '%' || v_deptid || '%'
         and (m.valide = '1' or m.valide is null or m.valide = '') --排除无效数据)
         --and (o.valide = '1' or o.valide is null or o.valide = '')
         and (f.valid = '1' or f.valid is null or f.valid = '')
         AND inpatient.patid LIKE '%' || v_patid || '%'
         AND inpatient.NAME LIKE '%' || v_name || '%' 
         AND (inpatient.islock LIKE '%' || v_status || '%'or nvl(inpatient.islock ,'4700') LIKE '%' || v_status || '%')
         AND (to_date(inpatient.admitdate,'yyyy-mm-dd hh24:mi:ss') between to_date(inpatient.admitdate,'yyyy-mm-dd hh24:mi:ss')  AND
           to_date(p_admitenddate,'yyyy-mm-dd hh24:mi:ss') );
  END;



  PROCEDURE usp_getalldepartmentstatinfo(v_deptid         VARCHAR2,
                                         v_patid          VARCHAR2,
                                         v_name           VARCHAR2,
                                         v_status         VARCHAR2,
                                         v_admitbegindate VARCHAR2,
                                         v_admitenddate   VARCHAR2,
                                         o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;
    --科室和人都为空
    if v_deptid is null and v_name is null then
      OPEN o_result FOR
      /*SELECT   a.deptno, a.deptname,

                                           --床位数
                                           (SELECT COUNT (*)
                                              FROM bed b
                                             WHERE b.deptid = a.deptno AND b.valid = '1') totalbed,

                                           --病人数
                                           COUNT (a.noofinpat) totalpat,

                                           --未写病历
                                           SUM (a.emrnonwritecount) emrnonwritecount,

                                           --未提交
                                           SUM (a.emrhaswritecount) emrhaswritecount,

                                           --提交未审核完病历
                                           SUM (a.hassubmitnoauditcount) hassubmitnoauditcount,

                                           --已审核完病历
                                           SUM (a.hasauditcount) hasauditcount
                                      FROM (SELECT inpatient.outhosdept deptno,
                                                   department.NAME deptname, inpatient.patid,
                                                   inpatient.NAME, inpatient.noofinpat,
                                                   (SELECT COUNT (*)
                                                      FROM qcrecord
                                                     WHERE qcrecord.noofinpat =
                                                                 inpatient.noofinpat
                                                       AND qcrecord.valid != '0'
                                                       AND qcrecord.foulstate IN (1, 3))
                                                                                     emrnonwritecount,
                                                   (SELECT COUNT (*)
                                                      FROM recorddetail
                                                     WHERE recorddetail.noofinpat =
                                                                 inpatient.noofinpat
                                                       AND recorddetail.valid = '1'
                                                       AND recorddetail.hassubmit = '4600')
                                                                                     emrhaswritecount,
                                                   (SELECT COUNT (*)
                                                      FROM recorddetail
                                                     WHERE recorddetail.noofinpat =
                                                              inpatient.noofinpat
                                                       AND recorddetail.valid = '1'
                                                       AND recorddetail.hassubmit NOT IN
                                                                                     ('4600', '4603'))
                                                                                hassubmitnoauditcount,
                                                   (SELECT COUNT (*)
                                                      FROM recorddetail
                                                     WHERE recorddetail.noofinpat =
                                                                    inpatient.noofinpat
                                                       AND recorddetail.valid = '1'
                                                       AND recorddetail.hassubmit = '4603')
                                                                                        hasauditcount
                                              FROM inpatient LEFT OUTER JOIN department ON department.ID =
                                                                                             inpatient.outhosdept
                                                                                      AND department.valid =
                                                                                                   '1'
                                             WHERE inpatient.outhosdept LIKE '%' || v_deptid || '%'
                                               AND inpatient.patid LIKE '%' || v_patid || '%'
                                               AND inpatient.NAME LIKE '%' || v_name || '%'
                                               AND inpatient.status LIKE '%' || v_status || '%'
                                               AND (    inpatient.admitdate >= p_admitbegindate
                                                    AND inpatient.admitdate <= p_admitenddate
                                                   )) a
                                  GROUP BY a.deptno, a.deptname
                                  ORDER BY a.deptname;*/
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101' --and d.id =v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室不为空，人为空
    elsif v_deptid is not null and v_name is null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and d.id = v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室为空，人不为空的情况
    elsif v_deptid is null and v_name is not null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and i.name like '%' || v_name || '%' --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室人都不为空
    elsif v_deptid is not null and v_name is not null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and d.id = v_deptid
           and i.name like '%' || v_name || '%'
           and d.id = v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
    end if;
  END;

  --仁和 获取科室统计信息 通过病人状态获取
  PROCEDURE usp_RHgetalldepstatinfo(v_deptid         VARCHAR2,
                                    v_patid          VARCHAR2,
                                    v_name           VARCHAR2,
                                    v_status         VARCHAR2,
                                    v_admitbegindate VARCHAR2,
                                    v_admitenddate   VARCHAR2,
                                    o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;
    --科室和人都为空
    if v_deptid is null and v_name is null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101' --and d.id =v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室不为空，人为空
    elsif v_deptid is not null and v_name is null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and d.id = v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室为空，人不为空的情况
    elsif v_deptid is null and v_name is not null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and i.name like '%' || v_name || '%' --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室人都不为空
    elsif v_deptid is not null and v_name is not null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status LIKE '%' || v_status || '%'
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and d.id = v_deptid
           and i.name like '%' || v_name || '%'
           and d.id = v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
    end if;
  END;

  --仁和 获取科室统计信息 住院和出院病人汇总
  PROCEDURE usp_RHgetDepstatinfoAll(v_deptid         VARCHAR2,
                                    v_patid          VARCHAR2,
                                    v_name           VARCHAR2,
                                    v_admitbegindate VARCHAR2,
                                    v_admitenddate   VARCHAR2,
                                    o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;
    --科室和人都为空
    if v_deptid is null and v_name is null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status in ('1501', '1502', '1503')
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101' --and d.id =v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室不为空，人为空
    elsif v_deptid is not null and v_name is null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status in ('1501', '1502', '1503')
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and d.id = v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室为空，人不为空的情况
    elsif v_deptid is null and v_name is not null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status in ('1501', '1502', '1503')
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and i.name like '%' || v_name || '%' --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
      --科室人都不为空
    elsif v_deptid is not null and v_name is not null then
      OPEN o_result FOR
        SELECT d.id deptno,
               '      ' || d.name deptname,
               (SELECT COUNT(*)
                  FROM bed b
                 WHERE b.deptid = d.id
                   AND b.valid = '1') totalbed, --床位数
               COUNT(distinct i.noofinpat) totalpat, --病人数
               0 emrnonwritecount, --未写病历
               sum(decode(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未提交
               sum(decode(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --提交未审核完病历
               sum(decode(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
          FROM department d
          LEFT OUTER JOIN inpatient i
            ON d.ID = i.outhosdept
           AND i.patid LIKE '%' || v_patid || '%'
           AND i.NAME LIKE '%' || v_name || '%'
           AND i.status in ('1501', '1502', '1503')
           AND (i.admitdate >= p_admitbegindate AND
               i.admitdate <= p_admitenddate)
           AND i.outhosdept LIKE '%' || v_deptid || '%'
          LEFT OUTER JOIN recorddetail r
            ON r.noofinpat = i.noofinpat
           AND r.valid = '1'
         WHERE d.valid = '1'
           AND d.sort = '101'
           and d.id = v_deptid
           and i.name like '%' || v_name || '%'
           and d.id = v_deptid --临床科室--按科室，统计信息不准确
         GROUP BY d.id, d.name;
    end if;
  END;

  --统计科室的病历评分信息 add by wyt 2012-12-12
  procedure usp_getdepartmentpatqcinfo(v_deptid         VARCHAR2,
                                       v_patid          VARCHAR2,
                                       v_name           VARCHAR2,
                                       v_status         VARCHAR2,
                                       v_admitbegindate VARCHAR2,
                                       v_admitenddate   VARCHAR2,
                                       v_sortid         varchar2,
                                       v_sumpoint1      int,
                                       v_sumpoint2      int,
                                       V_type           varchar2,
                                       V_userid         varchar2,
                                       V_auth           varchar2,
                                       o_result         OUT empcurtype) as
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
    p_userid         varchar2(16);
  begin
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    IF V_auth = '2' THEN
      p_userid := '';
    ELSE
      p_userid := V_userid;
    END IF;

    OPEN o_result FOR
      select record.id,
             record.name,
             record.noofinpat,
             record.qctype,
             record.checkstate,
             pat.PATID,
             pat.outbed bedid,
             (pat.name || '(编号' || pat.noofinpat || ')') patname,
             (case pat.sexid
               when '0' then
                '女'
               when '1' then
                '男'
             end) sexname,
             pat.age,
             pat.status,
             DECODE(pat.incount, 1, pat.incount, 0, 1) incount,
             dept.id deptno,
             dept.name deptname,
             diag.NAME admitdiagnosis,
             users.name createusername,
             p.doctorname,
             p.recorddetailname,
             p.sortid,
             p.emrpointid,
             p.problem_desc,
             (case record.qctype
               when '环节质控' then
                (v_sumpoint1 - p1.sumpoint)
               when '终末质控' then
                (v_sumpoint2 - p1.sumpoint)
             end) totalscore,
             (case record.qctype
               when '环节质控' then
                v_sumpoint1
               when '终末质控' then
                v_sumpoint2
             end) sumpoint,
             dict.cname,
             config.childname
        from (select id,
                     (name || ' ' ||
                     to_char(create_time, 'YYYY-MM-DD HH24:MI:SS')) name,
                     noofinpat,
                     (case qctype
                       when '0' then
                        '环节质控'
                       when '1' then
                        '终末质控'
                     end) qctype,
                     (case checkstate
                       when '0' then
                        '新建'
                       when '1' then
                        '提交未审核'
                       when '2' then
                        '审核通过'
                       when '3' then
                        '审核未通过'
                       when '4' then
                        '质控员质控'
                     end) checkstate,
                     CREATE_USER
                from emr_automark_record
               where isauto = '0'
                 and isvalid = '1') record
        left join inpatient pat
          on pat.noofinpat = record.noofinpat
        left join department dept
          on dept.id = pat.outhosdept
        left join diagnosis diag
          on diag.icd = REPLACE(pat.admitdiagnosis, ' ', '.')
         and diag.valid = '1'
        left join users
          on users.id = record.CREATE_USER
         and users.valid = 1
        left join emr_point p
          on p.emr_mark_record_id = record.id
         and p.valid = '1'
        left join (select emr_mark_record_id, sum(reducepoint) sumpoint
                     from emr_point
                    where Valid = '1'
                    group by emr_mark_record_id) p1
          on p1.emr_mark_record_id = record.id
        left join emr_configpoint config
          on config.childcode = to_char(p.emrpointid)
        left join dict_catalog dict
          on dict.ccode = p.sortid
       where record.create_user like '%' || p_userid || '%'
         and pat.patid LIKE '%' || v_patid || '%'
         and pat.outhosdept LIKE '%' || v_deptid || '%'
         and pat.NAME LIKE '%' || v_name || '%'
         and pat.status LIKE '%' || v_status || '%'
         and pat.admitdate >= p_admitbegindate
         and pat.admitdate <= p_admitenddate
         and p.sortid like '%' || v_sortid || '%';
  END;

  ---获得科室内病人，（在评分表中存在记录的病人）--edit by wyt 2012-10-26 增加了按扣分项搜索
  PROCEDURE usp_getdepartmentpatstatinfo(v_deptid         VARCHAR2,
                                         v_patid          VARCHAR2,
                                         v_name           VARCHAR2,
                                         v_status         VARCHAR2,
                                         v_admitbegindate VARCHAR2,
                                         v_admitenddate   VARCHAR2,
                                         v_sortid         varchar2,
                                         v_sumpoint       int, --新增的总分 ywk 2012年6月12日 14:51:41
                                         V_type           varchar2, --新增的按类型查询 ywk 2012年11月6日10:55:58
                                         o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;
    --病历评分表中的查询
    if V_type = 'point' then

      OPEN o_result FOR
        select temp2.bedid,
               temp2.deptno,
               temp2.deptname,
               temp2.patid,
               temp2.patname,
               temp2.noofinpat,
               temp2.sexname,
               temp2.age,
               temp2.incount,
               temp2.admitdiagnosis,
               temp2.emrnonwritecount,
               temp2.emrhaswritecount,
               temp2.hassubmitnoauditcount,
               temp2.hasauditcount,
               temp2.totalscore,
               pt2.sortid,
               dict.cname,
               configp.childname
          from (SELECT temp1.bedid,
                       temp1.deptno,
                       temp1.deptname,
                       temp1.patid,
                       temp1.patname,
                       temp1.noofinpat,
                       temp1.sexname,
                       temp1.age,
                       temp1.incount,
                       temp1.admitdiagnosis,
                       temp1.emrnonwritecount,
                       temp1.emrhaswritecount,
                       temp1.hassubmitnoauditcount,
                       temp1.hasauditcount,
                       v_sumpoint - SUM(pt.reducepoint) totalscore

                  from (select inp.outbed bedid,
                               inp.outhosdept deptno,
                               department.NAME deptname,
                               inp.patid,
                               inp.NAME patname,
                               inp.noofinpat,
                               dc.NAME sexname,
                               inp.agestr age,
                               DECODE(inp.incount, 1, inp.incount, 0, 1) incount,
                               diag.NAME admitdiagnosis,
                               '0' emrnonwritecount,
                               SUM(DECODE(rcd.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                               SUM(DECODE(rcd.hassubmit,
                                          '4600',
                                          0,
                                          '4603',
                                          0,
                                          1)) hassubmitnoauditcount, --未提交
                               SUM(DECODE(rcd.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                          FROM inpatient inp
                          LEFT OUTER JOIN department
                            ON department.ID = inp.outhosdept
                           AND department.valid = '1'
                          LEFT OUTER JOIN dictionary_detail dc
                            ON dc.detailid = inp.sexid
                           AND dc.categoryid = '3'
                          LEFT OUTER JOIN diagnosis diag
                            ON diag.icd =
                               REPLACE(inp.admitdiagnosis, ' ', '.')
                           AND diag.valid = '1'
                          LEFT OUTER JOIN recorddetail rcd
                            ON rcd.noofinpat = inp.noofinpat
                           AND rcd.valid = '1'
                         WHERE inp.outhosdept LIKE '%' || v_deptid || '%'
                           AND inp.patid LIKE '%' || v_patid || '%'
                           AND inp.NAME LIKE '%' || v_name || '%'
                           AND inp.status LIKE '%' || v_status || '%'
                           AND (inp.admitdate >= p_admitbegindate AND
                               inp.admitdate <= p_admitenddate)
                         GROUP BY inp.outbed,
                                  inp.outhosdept,
                                  department.NAME,
                                  inp.patid,
                                  inp.NAME,
                                  inp.noofinpat,
                                  dc.NAME,
                                  inp.agestr,
                                  inp.incount,
                                  diag.NAME) temp1
                  left OUTER JOIN emr_point pt
                    ON temp1.noofinpat = pt.noofinpat
                 where pt.valid = '1'
                 group by temp1.bedid,
                          temp1.deptno,
                          temp1.deptname,
                          temp1.patid,
                          temp1.patname,
                          temp1.noofinpat,
                          temp1.sexname,
                          temp1.age,
                          temp1.incount,
                          temp1.admitdiagnosis,
                          temp1.emrnonwritecount,
                          temp1.emrhaswritecount,
                          temp1.hassubmitnoauditcount,
                          temp1.hasauditcount) temp2
          left join emr_point pt2
            on pt2.noofinpat = temp2.noofinpat
          left join Emr_ConfigPoint configp
            on configp.id = pt2.emrpointid
          left join dict_catalog dict
            on dict.ccode = pt2.sortid
         where dict.ccode like '%' || v_sortid || '%';
      --时限信息中的查询
    elsif v_type = 'time' then
      OPEN o_result FOR
      /* SELECT inp.outbed bedid,
                         inp.outhosdept deptno,
                         department.NAME deptname,
                         inp.patid,
                         inp.NAME patname,
                         inp.noofinpat,
                         dc.NAME sexname,
                         inp.agestr age,
                         DECODE(inp.incount, 1, inp.incount, 0, 1) incount,
                         diag.NAME admitdiagnosis,
                         '0' emrnonwritecount,
                         SUM(DECODE(rcd.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                         SUM(DECODE(rcd.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                         SUM(DECODE(rcd.hassubmit, '4603', 1, 0)) hasauditcount, --已审核完病历
                         v_sumpoint - SUM(p.reducepoint) totalscore,
                         '' cname
                    FROM inpatient inp
                    LEFT OUTER JOIN department
                      ON department.ID = inp.outhosdept
                     AND department.valid = '1'
                    LEFT OUTER JOIN dictionary_detail dc
                      ON dc.detailid = inp.sexid
                     AND dc.categoryid = '3'
                    LEFT OUTER JOIN diagnosis diag
                      ON diag.icd = REPLACE(inp.admitdiagnosis, ' ', '.')
                     AND diag.valid = '1'
                    LEFT OUTER JOIN recorddetail rcd
                      ON rcd.noofinpat = inp.noofinpat
                     AND rcd.valid = '1'
                   LEFT OUTER JOIN emr_point p
                      ON inp.noofinpat = p.noofinpat  and p.valid = '1'
                   WHERE inp.outhosdept LIKE  '%' || v_deptid || '%'
                     AND inp.patid LIKE '%' || v_patid || '%'
                     AND inp.NAME LIKE '%' || v_name || '%'
                     AND inp.status LIKE '%' || v_status || '%'
                     AND (inp.admitdate >= p_admitbegindate AND
                         inp.admitdate <= p_admitenddate)
                   GROUP BY inp.outbed,inp.outhosdept,department.NAME,inp.patid,inp.NAME,
                            inp.noofinpat,dc.NAME,inp.agestr,inp.incount,diag.NAME;
            \**/
        SELECT a.bedid,
               a.deptno,
               a.deptname,
               a.patid,
               a.patname,
               a.noofinpat,
               a.sexname,
               a.age,
               a.incount,
               a.admitdiagnosis,
               a.emrnonwritecount,
               a.emrhaswritecount,
               a.hassubmitnoauditcount,
               a.hasauditcount,
               v_sumpoint - SUM(p.reducepoint) totalscore --总分数(从配置中取得)\*100 - SUM(p.reducepoint)*\
          FROM (SELECT i.outbed bedid,
                       i.outhosdept deptno,
                       department.NAME deptname,
                       i.patid,
                       i.NAME patname,
                       i.noofinpat,
                       c.NAME sexname,
                       i.agestr age,
                       DECODE(i.incount, 1, i.incount, 0, 1) incount,
                       d.NAME admitdiagnosis,
                       '0' emrnonwritecount,
                       SUM(DECODE(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                       SUM(DECODE(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                       SUM(DECODE(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                  FROM inpatient i
                  LEFT OUTER JOIN department
                    ON department.ID = i.outhosdept
                   AND department.valid = '1'
                  LEFT OUTER JOIN dictionary_detail c
                    ON c.detailid = i.sexid
                   AND c.categoryid = '3'
                  LEFT OUTER JOIN diagnosis d
                    ON d.icd = REPLACE(i.admitdiagnosis, ' ', '.')
                   AND d.valid = '1'
                  LEFT OUTER JOIN recorddetail r
                    ON r.noofinpat = i.noofinpat
                   AND r.valid = '1'
                 WHERE i.outhosdept LIKE '%' || v_deptid || '%' --v_deptid
                   AND i.patid LIKE '%' || v_patid || '%'
                   AND i.NAME LIKE '%' || v_name || '%'
                   AND i.status LIKE '%' || v_status || '%'
                   AND (i.admitdate >= p_admitbegindate AND
                       i.admitdate <= p_admitenddate)
                 GROUP BY i.outbed,
                          i.outhosdept,
                          department.NAME,
                          i.patid,
                          i.NAME,
                          i.noofinpat,
                          c.NAME,
                          i.agestr,
                          i.incount,
                          d.NAME) a
          LEFT OUTER JOIN emr_point p
            ON a.noofinpat = p.noofinpat
         WHERE p.valid = '1'
         GROUP BY a.bedid,
                  a.deptno,
                  a.deptname,
                  a.patid,
                  a.patname,
                  a.noofinpat,
                  a.sexname,
                  a.age,
                  a.incount,
                  a.admitdiagnosis,
                  a.emrnonwritecount,
                  a.emrhaswritecount,
                  a.hassubmitnoauditcount,
                  a.hasauditcount;
    end if;
  END;

  ---仁和 获得科室内病人，（在评分表中存在记录的病人 并且记录状态是8701 科室主任）
  PROCEDURE usp_GetRHGetDeptinfo(v_deptid         VARCHAR2,
                                 v_patid          VARCHAR2,
                                 v_name           VARCHAR2,
                                 v_status         VARCHAR2,
                                 v_admitbegindate VARCHAR2,
                                 v_admitenddate   VARCHAR2,
                                 o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT a.bedid,
             a.deptno,
             a.deptname,
             a.patid,
             a.patname,
             a.noofinpat,
             a.sexname,
             a.age,
             a.incount,
             a.admitdiagnosis,
             a.emrnonwritecount,
             a.emrhaswritecount,
             a.hassubmitnoauditcount,
             a.hasauditcount
        FROM (SELECT i.outbed bedid,
                     i.outhosdept deptno,
                     department.NAME deptname,
                     i.patid,
                     i.NAME patname,
                     i.noofinpat,
                     c.NAME sexname,
                     i.agestr age,
                     DECODE(i.incount, 1, i.incount, 0, 1) incount,
                     d.NAME admitdiagnosis,
                     '0' emrnonwritecount,
                     SUM(DECODE(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                     SUM(DECODE(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                     SUM(DECODE(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                FROM inpatient i
                LEFT OUTER JOIN department
                  ON department.ID = i.outhosdept
                 AND department.valid = '1'
                LEFT OUTER JOIN dictionary_detail c
                  ON c.detailid = i.sexid
                 AND c.categoryid = '3'
                LEFT OUTER JOIN diagnosis d
                  ON d.icd = REPLACE(i.admitdiagnosis, ' ', '.')
                 AND d.valid = '1'
                LEFT OUTER JOIN recorddetail r
                  ON r.noofinpat = i.noofinpat
                 AND r.valid = '1'
               WHERE i.outhosdept LIKE '%' || v_deptid || '%' --v_deptid
                 AND i.patid LIKE '%' || v_patid || '%'
                 AND i.NAME LIKE '%' || v_name || '%'
                 AND i.status LIKE '%' || v_status || '%'
                 AND (i.admitdate >= p_admitbegindate AND
                     i.admitdate <= p_admitenddate)
               GROUP BY i.outbed,
                        i.outhosdept,
                        department.NAME,
                        i.patid,
                        i.NAME,
                        i.noofinpat,
                        c.NAME,
                        i.agestr,
                        i.incount,
                        d.NAME) a
        LEFT OUTER JOIN emr_rhqc_table p
          ON a.noofinpat = p.noofinpat
       WHERE p.valid = '1'
         and p.stateid in ('8701', '8703')
       GROUP BY a.bedid,
                a.deptno,
                a.deptname,
                a.patid,
                a.patname,
                a.noofinpat,
                a.sexname,
                a.age,
                a.incount,
                a.admitdiagnosis,
                a.emrnonwritecount,
                a.emrhaswritecount,
                a.hassubmitnoauditcount,
                a.hasauditcount
       ORDER BY deptno, bedid;
  END;

  --得到病人的统计信息(仁和版本的，不连接评分表edit by ywk 2012年7月13日 08:58:34)
  procedure usp_GetrhDepartmentPatStatInfo(v_deptid         varchar2,
                                           v_patid          varchar2,
                                           v_name           varchar2,
                                           v_status         varchar2,
                                           v_admitbegindate varchar2,
                                           v_admitenddate   varchar2,
                                           o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT a.bedid,
             a.deptno,
             a.deptname,
             a.patid,
             a.patname,
             a.noofinpat,
             a.sexname,
             a.age,
             a.incount,
             a.admitdiagnosis,
             a.emrnonwritecount,
             a.emrhaswritecount,
             a.hassubmitnoauditcount,
             a.hasauditcount
        FROM (SELECT i.outbed bedid,
                     i.outhosdept deptno,
                     department.NAME deptname,
                     i.patid,
                     i.NAME patname,
                     i.noofinpat,
                     c.NAME sexname,
                     i.agestr age,
                     DECODE(i.incount, 1, i.incount, 0, 1) incount,
                     d.NAME admitdiagnosis,
                     '0' emrnonwritecount,
                     SUM(DECODE(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                     SUM(DECODE(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                     SUM(DECODE(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                FROM inpatient i
                LEFT OUTER JOIN department
                  ON department.ID = i.outhosdept
                 AND department.valid = '1'
                LEFT OUTER JOIN dictionary_detail c
                  ON c.detailid = i.sexid
                 AND c.categoryid = '3'
                LEFT OUTER JOIN diagnosis d
                  ON d.icd = REPLACE(i.admitdiagnosis, ' ', '.')
                 AND d.valid = '1'
                LEFT OUTER JOIN recorddetail r
                  ON r.noofinpat = i.noofinpat
                 AND r.valid = '1'
               WHERE i.outhosdept LIKE '%' || v_deptid || '%' --v_deptid
                 AND i.patid LIKE '%' || v_patid || '%'
                 AND i.NAME LIKE '%' || v_name || '%'
                 AND i.status LIKE '%' || v_status || '%'
                 AND (i.admitdate >= p_admitbegindate AND
                     i.admitdate <= p_admitenddate)
               GROUP BY i.outbed,
                        i.outhosdept,
                        department.NAME,
                        i.patid,
                        i.NAME,
                        i.noofinpat,
                        c.NAME,
                        i.agestr,
                        i.incount,
                        d.NAME) a

       GROUP BY a.bedid,
                a.deptno,
                a.deptname,
                a.patid,
                a.patname,
                a.noofinpat,
                a.sexname,
                a.age,
                a.incount,
                a.admitdiagnosis,
                a.emrnonwritecount,
                a.emrhaswritecount,
                a.hassubmitnoauditcount,
                a.hasauditcount
       ORDER BY deptno, bedid;
  END;

  --得到病人的统计信息 质控科人员 (仁和版本的，不连接评分表edit by ywk 2012年8月2日 08:58:34)
  procedure usp_GetrhDepPatStatInfoAll(v_deptid         varchar2,
                                       v_patid          varchar2,
                                       v_name           varchar2,
                                       v_admitbegindate varchar2,
                                       v_admitenddate   varchar2,
                                       o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT a.bedid,
             a.deptno,
             a.deptname,
             a.patid,
             a.patname,
             a.noofinpat,
             a.sexname,
             a.age,
             a.incount,
             a.admitdiagnosis,
             a.emrnonwritecount,
             a.emrhaswritecount,
             a.hassubmitnoauditcount,
             a.hasauditcount
        FROM (SELECT i.outbed bedid,
                     i.outhosdept deptno,
                     department.NAME deptname,
                     i.patid,
                     i.NAME patname,
                     i.noofinpat,
                     c.NAME sexname,
                     i.agestr age,
                     DECODE(i.incount, 1, i.incount, 0, 1) incount,
                     d.NAME admitdiagnosis,
                     '0' emrnonwritecount,
                     SUM(DECODE(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                     SUM(DECODE(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                     SUM(DECODE(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                FROM inpatient i
                LEFT OUTER JOIN department
                  ON department.ID = i.outhosdept
                 AND department.valid = '1'
                LEFT OUTER JOIN dictionary_detail c
                  ON c.detailid = i.sexid
                 AND c.categoryid = '3'
                LEFT OUTER JOIN diagnosis d
                  ON d.icd = REPLACE(i.admitdiagnosis, ' ', '.')
                 AND d.valid = '1'
                LEFT OUTER JOIN recorddetail r
                  ON r.noofinpat = i.noofinpat
                 AND r.valid = '1'
               WHERE i.outhosdept LIKE '%' || v_deptid || '%' --v_deptid
                 AND i.patid LIKE '%' || v_patid || '%'
                 AND i.NAME LIKE '%' || v_name || '%'
                 AND i.status in ('1501', '1502', '1503')
                 AND (i.admitdate >= p_admitbegindate AND
                     i.admitdate <= p_admitenddate)
               GROUP BY i.outbed,
                        i.outhosdept,
                        department.NAME,
                        i.patid,
                        i.NAME,
                        i.noofinpat,
                        c.NAME,
                        i.agestr,
                        i.incount,
                        d.NAME) a

       GROUP BY a.bedid,
                a.deptno,
                a.deptname,
                a.patid,
                a.patname,
                a.noofinpat,
                a.sexname,
                a.age,
                a.incount,
                a.admitdiagnosis,
                a.emrnonwritecount,
                a.emrhaswritecount,
                a.hassubmitnoauditcount,
                a.hasauditcount
       ORDER BY deptno, bedid;
  END;

  --得到病人的统计信息 科室指控员 (仁和版本的，不连接评分表edit by ywk 2012年8月2日 08:58:34)
  procedure usp_GetrhDepPatStatInfoCY(v_deptid         varchar2,
                                      v_patid          varchar2,
                                      v_name           varchar2,
                                      v_admitbegindate varchar2,
                                      v_admitenddate   varchar2,
                                      o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';

    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT a.bedid,
             a.deptno,
             a.deptname,
             a.patid,
             a.patname,
             a.noofinpat,
             a.sexname,
             a.age,
             a.incount,
             a.admitdiagnosis,
             a.emrnonwritecount,
             a.emrhaswritecount,
             a.hassubmitnoauditcount,
             a.hasauditcount
        FROM (SELECT i.outbed bedid,
                     i.outhosdept deptno,
                     department.NAME deptname,
                     i.patid,
                     i.NAME patname,
                     i.noofinpat,
                     c.NAME sexname,
                     i.agestr age,
                     DECODE(i.incount, 1, i.incount, 0, 1) incount,
                     d.NAME admitdiagnosis,
                     '0' emrnonwritecount,
                     SUM(DECODE(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                     SUM(DECODE(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                     SUM(DECODE(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                FROM inpatient i
                LEFT OUTER JOIN department
                  ON department.ID = i.outhosdept
                 AND department.valid = '1'
                LEFT OUTER JOIN dictionary_detail c
                  ON c.detailid = i.sexid
                 AND c.categoryid = '3'
                LEFT OUTER JOIN diagnosis d
                  ON d.icd = REPLACE(i.admitdiagnosis, ' ', '.')
                 AND d.valid = '1'
                LEFT OUTER JOIN recorddetail r
                  ON r.noofinpat = i.noofinpat
                 AND r.valid = '1'
               WHERE i.outhosdept LIKE '%' || v_deptid || '%' --v_deptid
                 AND i.patid LIKE '%' || v_patid || '%'
                 AND i.NAME LIKE '%' || v_name || '%'
                 AND i.status in ('1502', '1503')
                 AND (i.admitdate >= p_admitbegindate AND
                     i.admitdate <= p_admitenddate)
               GROUP BY i.outbed,
                        i.outhosdept,
                        department.NAME,
                        i.patid,
                        i.NAME,
                        i.noofinpat,
                        c.NAME,
                        i.agestr,
                        i.incount,
                        d.NAME) a

       GROUP BY a.bedid,
                a.deptno,
                a.deptname,
                a.patid,
                a.patname,
                a.noofinpat,
                a.sexname,
                a.age,
                a.incount,
                a.admitdiagnosis,
                a.emrnonwritecount,
                a.emrhaswritecount,
                a.hassubmitnoauditcount,
                a.hasauditcount
       ORDER BY deptno, bedid;
  END;

  --得到病人的所有病历
  procedure usp_GetAllEmrDocByNoofinpat(v_noofinpat varchar2,
                                        o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT 0 ID, ' ' NAME
        FROM dual
      UNION
      SELECT a.id, a.name
        FROM (SELECT id, name
                FROM recorddetail
               WHERE noofinpat = v_noofinpat
                 AND valid = '1'
               ORDER BY sortid, id) a;
  END;

  --得到科室所有医生
  procedure usp_GetAllDoctorByUserNO(v_userid varchar2,
                                     o_result OUT empcurtype) AS
  BEGIN
    open o_result for
      select u1.id, u1.name
        from users u1
       where u1.deptid in (select u2.deptid
                             from users u2
                            where u2.id = v_userid
                              and u2.valid = '1')
         and u1.valid = '1';
  END;

  --得到科室所有医生
  procedure usp_GetAllDoctorByNoofinpat(v_noofinpat varchar2,
                                        o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select u1.id, u1.name
        from users u1
       where u1.deptid in (select nvl(i.outhosdept, i.admitdept)
                             from inpatient i
                            where i.noofinpat = v_noofinpat)
         and u1.valid = '1';
  END;

  --得到病历评分表的信息//edit by wyt 2012-12-06 新增评分主记录ID条件
  procedure usp_GetEmrPointByNoofinpat(v_noofinpat varchar2,
                                       v_chiefid   varchar2,
                                       o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select case e.valid
               when '1' then
                '有效'
               else
                '无效'
             end valid,
             e.cancel_user,
             e.cancelusername,
             e.cancel_time,
             e.doctorID,
             e.doctorname,
             e.create_user,
             e.createusername,
             e.create_time,
             e.problem_desc,
             e.reducepoint,
             e.reducepoint*e.num point,
             e.num,
             e.grade,
             e.EMR_MARK_RECORD_ID, ---新增评分主记录ID
             e.recorddetailname,
             (case
               when v.childname is null then
                h.cname
               else
                v.childname
             end) childname, --edit by ywk 2012年4月12日10:23:02
             v.childcode,
             -- v.childname,---新增小评分项名称
             e.id,
             h.cname
        from emr_point e
      --left join emr_configpoint v on e.emrpointid = to_char(v.id)
        left join emr_configpoint v
          on e.emrpointid = to_char(v.childcode) --王冀 添加完成后 查询不到  分类ID没有
        left join dict_catalog h
          on e.sortid = h.ccode
       where e.noofinpat = v_noofinpat
         and e.EMR_MARK_RECORD_ID = v_chiefid
         and e.valid = '1'; --and v.valid='1';--edit by ywk 2012年4月11日9:31:47
  END;

  -- 仁和 得到病历评分表的详细信息
  procedure usp_GetRHPoint(v_rhqc_tableId varchar2,
                           o_result       OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select case e.valid
               when '1' then
                '有效'
               else
                '无效'
             end valid,
             e.cancel_user,
             e.cancelusername,
             e.cancel_time,
             e.doctorID,
             e.doctorname,
             e.create_user,
             e.createusername,
             e.create_time,
             e.problem_desc,
             e.reducepoint,
             e.num,
             e.grade,
             e.id,
             e.recorddetailname,
             (case
               when v.childname is null then
                h.cname
               else
                v.childname
             end) childname, --edit by ywk 2012年4月12日10:23:02
             -- v.childname,---新增小评分项名称
             h.cname
        from emr_rhpoint e
        left join emr_configpoint v
          on e.emrpointid = v.id
        left join dict_catalog h
          on e.sortid = h.ccode
       where e.rhqc_table_id = v_rhqc_tableId
         and e.valid = '1'; --and v.valid='1';--edit by ywk 2012年4月11日9:31:47
  END;

  procedure usp_insertEmrPoint(v_doctorid       varchar2,
                               v_doctorname     varchar2,
                               v_create_user    varchar2,
                               v_createusername varchar2,
                               v_problem_desc   varchar2,
                               v_reducepoint    varchar2,
                               v_num            varchar2,
                               --v_grade            varchar2,
                               v_recorddetailid   varchar2,
                               v_noofinpat        varchar2,
                               v_recorddetailname varchar2,
                               v_sortid           varchar2, --新增大类编号
                               --v_emrpointid INT DEFAULT 0,---新增字段
                               v_emrpointid varchar2, ---新增字段 --edit by wyt 2012-12-11
                               v_chiefid    varchar2, ---新增字段
                               v_emrpointchildid varchar2
                               ) AS
  BEGIN
    insert into emr_point
      (id,
       doctorid,
       doctorname,
       create_user,
       createusername,
       create_time,
       problem_desc,
       reducepoint,
       num,
       --grade,
       recorddetailid,
       valid,
       noofinpat,
       recorddetailname,
       emrpointid,
       sortid, ---新增字段
       EMR_MARK_RECORD_ID ,---新增字段
       emrpointchildid
       )
    values
      (seq_emr_point_id.nextval, --(select nvl(max(id), 0) + 1 from emr_point),
       v_doctorid,
       v_doctorname,
       v_create_user,
       v_createusername,
       sysdate,
       v_problem_desc,
       v_reducepoint,
       v_num,
       -- v_grade,
       v_recorddetailid,
       '1',
       v_noofinpat,
       v_recorddetailname,
       v_emrpointid,
       v_sortid,
       v_chiefid,
       v_emrpointchildid
       );
  END;

  procedure usp_cancelEmrPoint(v_id varchar2, v_cancel_user varchar2) AS
  BEGIN
    update emr_point
       set emr_point.valid       = '0',
           emr_point.cancel_user = v_cancel_user,
           emr_point.cancel_time = sysdate
     where emr_point.id = v_id;
  END;

  procedure usp_cancelRHEmrPoint(v_id              varchar2,
                                 v_cancel_user     varchar2,
                                 v_cancel_userName varchar2) AS
  BEGIN
    update emr_rhpoint
       set emr_rhpoint.valid          = '0',
           emr_rhpoint.cancel_user    = v_cancel_user,
           emr_rhpoint.cancelusername = v_cancel_userName,
           emr_rhpoint.cancel_time    = to_char(sysdate,
                                                'yyyy-MM-dd HH:mm:ss')
     where emr_rhpoint.id = v_id;
  END;

  procedure usp_GetPatientInfo(v_noofinpat varchar2,
                               o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select i.name,
             dd.name as gender,
             i.admitdate,
             i.outbed,
             i.agestr,
             i.patid
        from inpatient i
        LEFT outer JOIN dictionary_detail dd
          ON dd.detailid = i.sexid
         AND dd.categoryid = '3'
       where i.noofinpat = v_noofinpat;
  END;

  procedure usp_GetPointByDoctorID(v_doctorID varchar2,
                                   o_result   OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT e.id,
             e.noofinpat,
             e.recorddetailid,
             e.problem_desc,
             e.num*e.reducepoint || '分' as reducepoint,
             e.grade,
             e.num,
            b.childname recorddetailname,
             (SELECT i.name FROM inpatient i WHERE i.noofinpat = e.noofinpat) name
        FROM emr_point e left join ( select a.*,b.childname  from emr_configreduction2 a left join emr_configpoint b on a.parents=b.ccode and a.children=b.childcode) b on e.emrpointid=b.id
        
       WHERE e.doctorid = v_doctorID
         AND e.valid = '1';
  END;

  ------病历评分配置
  PROCEDURE usp_Edit_ConfigPoint(v_EditType   varchar default '', --操作类型
                                 V_ID         varchar default '',
                                 v_CCode      varchar default '',
                                 v_CChildCode varchar default '',
                                 v_CChildName varchar default '',
                                 v_Valid      varchar default '1',
                                 o_result     OUT empcurtype) as
  begin
    open o_result for

      select V_ID from dual;
    --添加
    if v_EditType = '1' then
      INSERT INTO Emr_ConfigPoint
        (ID, CCODE, ChildCode, ChildName, Valid)
      VALUES
        (seq_Emr_ConfigPoint_ID.Nextval,
         v_CCode,
         --v_CChildCode,
         seq_Emr_ConfigPoint_ID.Currval,
         v_CChildName,
         v_Valid);

      --修改
    elsif v_EditType = '2' then

      UPDATE Emr_ConfigPoint
         set CCODE     = v_CCode,
             ChildCode = v_CChildCode,
             ChildName = v_CChildName,
             Valid     = v_Valid
       WHERE id = V_ID;

      --删除
    elsif v_EditType = '3' then

      update Emr_ConfigPoint a set a.valid = 0 where ID = V_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from Emr_ConfigPoint a
         where a.valid = '1'
         order by id;
    end if;
  end;

  ------病历评分（扣分理由）配置       ywk 2012年5月28日 09:22:10   修改 王冀 2012-11-9    修改 王冀 2012-11-29
  PROCEDURE usp_Edit_ConfigReduction(v_EditType        varchar default '', --操作类型
                                     V_REDUCEPOINT     varchar default '',
                                     v_PROBLEMDESC     varchar default '',
                                     v_CREATEUSER      varchar default '',
                                     v_CREATETIME      varchar default '',
                                     v_ID              varchar default '',
                                     v_Valid           varchar default '1',
                                     v_Parents         varchar default '',
                                     v_Children        varchar default '',
                                     v_Isauto          varchar default '',
                                     v_Selectcondition varchar default '',
                                     o_result          OUT empcurtype) as
  begin
    open o_result for

      select V_ID from dual;
    --添加
    if v_EditType = '1' then
      INSERT INTO EMR_ConfigReduction2
        (ID,
         REDUCEPOINT,
         PROBLEM_DESC,
         CREATE_USER,
         CREATE_TIME,
         Valid,
         Parents,
         Children,
         Isauto,
         Selectcondition)
      VALUES
        (seq_EMR_ConfigReduction_ID.Nextval,
         V_REDUCEPOINT,
         v_PROBLEMDESC,
         v_CREATEUSER,
         to_date(v_CREATETIME, 'yyyy/mm/dd HH24:MI:SS'),
         -- v_CREATETIME,
         v_Valid,
         v_Parents,
         v_Children,
         v_Isauto,
         v_Selectcondition);

      --修改
    elsif v_EditType = '2' then

      UPDATE EMR_ConfigReduction2
         set REDUCEPOINT     = V_REDUCEPOINT,
             PROBLEM_DESC    = v_PROBLEMDESC,
             CREATE_USER     = v_CREATEUSER,
             Valid           = v_Valid,
             Parents         = v_Parents,
             Children        = v_Children,
             Isauto          = v_Isauto,
             Selectcondition = v_Selectcondition
       WHERE id = V_ID;

      --删除
    elsif v_EditType = '3' then

      update EMR_ConfigReduction2 a set a.valid = 0 where ID = V_ID;

      --查询   此处不知道有没有用到过 王冀 2012-11-9
    elsif v_EditType = '4' then
      open o_result for
        select A.ID,
               A.REDUCEPOINT,
               A.PROBLEM_DESC,
               A.CREATE_USER,
               A.CREATE_TIME,
               (case
                 when A.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               A.PARENTS,
               a.children
          from EMR_ConfigReduction2 A
         order by A.ID;
    end if;
  end;

  --病历评分中要显示的跟节点
  procedure usp_GetPointClass(o_result OUT empcurtype) as
  begin
    OPEN o_result FOR
    /* select ccode,cname from dict_catalog
                       where mname is not null ;*/

      select ccode, cname
        from dict_catalog
       where cname in ('病案首页',
                       '住院志',
                       '病程记录',
                       '知情文件',
                       '手术相关记录',
                       '会诊记录',
                       '其他记录');
  end;

  ------科室质控员的配置操作 2012年7月10日13:45:29 ywk
  PROCEDURE usp_Edit_ConfigPointManager(v_EditType      varchar default '', --操作类型
                                        V_ID            varchar default '',
                                        v_DeptID        varchar default '',
                                        v_QcManagerID   varchar default '',
                                        v_ChiefDoctorID varchar default '',
                                        v_Valid         varchar default '1',
                                        o_result        OUT empcurtype) as
  begin
    --open o_result for

    -- select V_ID from dual;
    --添加
    if v_EditType = '1' then
      insert into emr_ConfigCheckPointUser
        (Id, Deptid, Qcmanagerid, Chiefdoctorid, Valid)
      values
        (seqemr_ConfigCheckPointUser_ID.Nextval,
         v_DeptID,
         v_QcManagerID,
         v_ChiefDoctorID,
         '1');
      commit;

      --修改
    elsif v_EditType = '2' then

      UPDATE emr_ConfigCheckPointUser
         set DeptID        = v_DeptID,
             QCManagerID   = v_QcManagerID,
             ChiefDoctorID = v_ChiefDoctorID,
             Valid         = v_Valid
       WHERE id = V_ID;

      --删除
    elsif v_EditType = '3' then

      update emr_ConfigCheckPointUser a set a.valid = 0 where ID = V_ID;

      --查询
      /*elsif v_EditType = '4'  then
         if v_DeptID='' then  open o_result for
      select  A.id,D.NAME deptname,(case
            when A.valid = 1 then    '是' else  '否'  end) validName,U1.Name  QCMANAGERNAME, U2.NAME  CHIEFNAME
            from emr_Configcheckpointuser  A left join department D on A.DEPTID=D.ID
            left join users U1 on U1.ID=A.QCMANAGERID  left join users U2 on  U2.ID=A.CHIEFDOCTORID ;
       else open o_result for
          select  A.id,D.NAME deptname,(case
            when A.valid = 1 then    '是' else  '否'  end) validName,U1.Name                       QCMANAGERNAME, U2.NAME  CHIEFNAME
            from emr_Configcheckpointuser  A left join department D on A.DEPTID=D.ID
            left join users U1 on U1.ID=A.QCMANAGERID  left join users U2 on   U2.ID=A.CHIEFDOCTORID ;*/

    end if;
  end;

  ---获得科室内病人，（在评分表中存在记录的病人）
  PROCEDURE usp_getRHdepartpatstatinfo(v_deptid         VARCHAR2,
                                       v_patid          VARCHAR2,
                                       v_name           VARCHAR2,
                                       v_status         VARCHAR2,
                                       v_admitbegindate VARCHAR2,
                                       v_admitenddate   VARCHAR2,
                                       o_result         OUT empcurtype) AS
    p_admitbegindate VARCHAR2(19);
    p_admitenddate   VARCHAR2(19);
  BEGIN
    p_admitbegindate := v_admitbegindate || ' 00:00:00';
    p_admitenddate   := v_admitenddate || ' 23:59:59';
    IF v_admitbegindate = '' THEN
      p_admitbegindate := '2001-01-01 00:00:00';
    END IF;

    IF v_admitenddate = '' THEN
      p_admitenddate := '2999-01-01 00:00:00';
    END IF;

    OPEN o_result FOR
      SELECT a.bedid,
             a.deptno,
             a.deptname,
             a.patid,
             a.patname,
             a.noofinpat,
             a.sexname,
             a.age,
             a.incount,
             a.admitdiagnosis,
             a.emrnonwritecount,
             a.emrhaswritecount,
             a.hassubmitnoauditcount,
             a.hasauditcount,
             SUM(p.reducepoint) totalscore,
             rh.id,
             a.status
        FROM (SELECT i.outbed bedid,
                     i.outhosdept deptno,
                     department.NAME deptname,
                     i.patid,
                     i.NAME patname,
                     i.status,
                     i.noofinpat,
                     c.NAME sexname,
                     i.agestr age,
                     DECODE(i.incount, 1, i.incount, 0, 1) incount,
                     d.NAME admitdiagnosis,
                     '0' emrnonwritecount,
                     SUM(DECODE(r.hassubmit, '4600', 1, 0)) emrhaswritecount, --未写病历
                     SUM(DECODE(r.hassubmit, '4600', 0, '4603', 0, 1)) hassubmitnoauditcount, --未提交
                     SUM(DECODE(r.hassubmit, '4603', 1, 0)) hasauditcount --已审核完病历
                FROM inpatient i
                LEFT OUTER JOIN department
                  ON department.ID = i.outhosdept
                 AND department.valid = '1'
                LEFT OUTER JOIN dictionary_detail c
                  ON c.detailid = i.sexid
                 AND c.categoryid = '3'
                LEFT OUTER JOIN diagnosis d
                  ON d.icd = REPLACE(i.admitdiagnosis, ' ', '.')
                 AND d.valid = '1'
                LEFT OUTER JOIN recorddetail r
                  ON r.noofinpat = i.noofinpat
                 AND r.valid = '1'
               WHERE i.outhosdept LIKE '%' || v_deptid || '%' --v_deptid
                 AND i.patid LIKE '%' || v_patid || '%'
                 AND i.NAME LIKE '%' || v_name || '%'
                 AND i.status LIKE '%' || v_status || '%'
                 AND (i.admitdate >= p_admitbegindate AND
                     i.admitdate <= p_admitenddate)
               GROUP BY i.outbed,
                        i.outhosdept,
                        department.NAME,
                        i.patid,
                        i.NAME,
                        i.noofinpat,
                        c.NAME,
                        i.agestr,
                        i.incount,
                        d.NAME,
                        i.status) a
        LEFT OUTER JOIN EMR_RHQC_TABLE rh
          ON rh.noofinpat = a.noofinpat
        LEFT OUTER JOIN emr_rhpoint p
          ON rh.id = p.rhqc_table_id
       WHERE p.valid = '1'
         and rh.stateid in ('8702', '8704')
       GROUP BY a.bedid,
                a.deptno,
                a.deptname,
                a.patid,
                a.patname,
                a.noofinpat,
                a.sexname,
                a.age,
                a.incount,
                a.admitdiagnosis,
                a.emrnonwritecount,
                a.emrhaswritecount,
                a.hassubmitnoauditcount,
                a.hasauditcount,
                rh.id,
                a.status
       ORDER BY deptno, totalscore desc, bedid;
  END;

  ------病历评分（扣分理由）配置 仁和质控       ywk 2012年8月7日 09:22:10
  PROCEDURE usp_Edit_RHConfigReduction(v_EditType    varchar default '', --操作类型
                                       V_REDUCEPOINT varchar default '',
                                       v_PROBLEMDESC varchar default '',
                                       v_CREATEUSER  varchar default '',
                                       v_CREATETIME  varchar default '',
                                       v_ID          varchar default '',
                                       v_Valid       varchar default '1',
                                       v_UserType    varchar default '',
                                       o_result      OUT empcurtype) as
  begin
    open o_result for

      select V_ID from dual;
    --添加
    if v_EditType = '1' then
      INSERT INTO EMR_RHConfigReduction
        (ID,
         REDUCEPOINT,
         PROBLEM_DESC,
         CREATE_USER,
         CREATE_TIME,
         Valid,
         USER_TYPE)
      VALUES
        (seq_EMR_ConfigReduction_ID.Nextval,
         V_REDUCEPOINT,
         v_PROBLEMDESC,
         v_CREATEUSER,
         to_date(v_CREATETIME, 'yyyy/mm/dd HH24:MI:SS'),
         -- v_CREATETIME,
         v_Valid,
         v_UserType);

      --修改
    elsif v_EditType = '2' then

      UPDATE EMR_RHConfigReduction
         set REDUCEPOINT  = V_REDUCEPOINT,
             PROBLEM_DESC = v_PROBLEMDESC,
             CREATE_USER  = v_CREATEUSER,
             Valid        = v_Valid,
             USER_TYPE    = v_UserType
       WHERE id = V_ID;

      --删除
    elsif v_EditType = '3' then

      update EMR_RHConfigReduction a set a.valid = 0 where ID = V_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select A.ID,
               A.REDUCEPOINT,
               A.PROBLEM_DESC,
               A.CREATE_USER,
               A.CREATE_TIME,
               (case
                 when A.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               A.USER_TYPE
          from EMR_RHConfigReduction A
         order by A.ID;
    end if;
  end;

  PROCEDURE usp_QcmanagerDepartmentlist(o_result OUT empcurtype) AS
    /**********
     版本号  1.0.0.0.0
     创建时间   2013-03-21
     作者
     版权     YidanSoft
     描述  医疗质量统计分析
     功能说明
     输入参数
     输出参数
     结果集、排序
    医疗质量统计分析

     调用的sp
     调用实例

     修改记录



    **********/
    v_sql VARCHAR2(4000);
  BEGIN
    --创建医疗统计分析临时表
    v_sql := 'truncate table TMP_DEPARTMENTLIST ';

    EXECUTE IMMEDIATE v_sql;

    --插入挂有病区的科室
    INSERT INTO TMP_DEPARTMENTLIST
      (deptcode, deptname)
      SELECT dept.ID, dept.NAME
        FROM department dept
       WHERE EXISTS
       (SELECT 1 FROM dept2ward ward WHERE dept.ID = ward.deptid);

    --更新在院人数
    UPDATE TMP_DEPARTMENTLIST
       SET inhos = NVL((SELECT COUNT(1)
                         FROM inpatient inp
                        WHERE inp.status IN (1500, 1501, 1505, 1506, 1507) --, 1504
                          AND inp.outhosdept = deptcode),
                       0);

    --床位数
    UPDATE TMP_DEPARTMENTLIST
       SET bedcnt = NVL((SELECT COUNT(1)
                          FROM bed bed
                         WHERE bed.valid = 1
                           AND bed.deptid = deptcode),
                        0);

    --书写次数缺陷病例数
    UPDATE TMP_DEPARTMENTLIST
       SET WRTDEFICITCNT = NVL((select count(distinct(inp.noofinpat))
                                 from qcrecord qr
                                 left join inpatient inp
                                   on qr.noofinpat = inp.noofinpat
                                where qr.foulstate = '1'
                                  and qr.result = '0' --缺陷未补全
                                  and qr.valid = '1'
                                  and inp.status IN
                                      (1500, 1501, 1505, 1506, 1507) --在院
                                     /*and inp.status IN (1500,
                                     1501,
                                     1502,
                                     1503,
                                     1504,
                                     1505,
                                     1506,
                                     1507) --包含出院           */
                                  AND inp.outhosdept = deptcode),
                               0);

    --时限质控缺陷病例数
    UPDATE TMP_DEPARTMENTLIST
       SET TIMELIMITEDCNT = NVL((select count(distinct(inp.noofinpat))
                                  from qcrecord qr
                                  left join inpatient inp
                                    on qr.noofinpat = inp.noofinpat
                                 where qr.foulstate = '1'
                                   and qr.valid = '1'
                                   and inp.status IN
                                       (1500, 1501, 1505, 1506, 1507) --在院
                                      /* and inp.status IN (1500,
                                      1501,
                                      1502,
                                      1503,
                                      1504,
                                      1505,
                                      1506,
                                      1507) --包含出院      */
                                   AND inp.outhosdept = deptcode),
                                0);

    --已抽查病例数
    UPDATE TMP_DEPARTMENTLIST
       SET HAVESELECTCNT = nvl((select count(distinct(er.noofinpat))
                                 from emr_automark_record er
                                 left join inpatient inp
                                   on er.noofinpat = inp.noofinpat
                                where inp.outhosdept = deptcode
                                  and er.isvalid = '1'
                                  and er.isauto = '0'
                                  and inp.status IN
                                      (1500, 1501, 1505, 1506, 1507) --在院
                               /*and inp.status IN (1500, --包含出院
                               1501,
                               1502,
                               1503,
                               1504,
                               1505,
                               1506,
                               1507)*/
                               ),
                               0);

    --已抽查病历平均分
    UPDATE TMP_DEPARTMENTLIST
       SET SELECTAVE = NVL((select avg(er.score)
                             from emr_automark_record er
                             left join inpatient inp
                               on er.noofinpat = inp.noofinpat
                            where er.isvalid = '1'
                              and er.isauto = '0'
                              AND inp.status IN
                                  (1500, 1501, 1505, 1506, 1507)
                              AND inp.outhosdept = deptcode),
                           0);

    --疑似未写病历人数
    UPDATE TMP_DEPARTMENTLIST
       SET NORECORDS = NVL((select ((select count(distinct(inp.noofinpat))
                                      from inpatient inp
                                     where inp.status in
                                           (1500, 1501, 1505, 1506, 1507)
                                       and inp.outhosdept = deptcode) -
                                  (select count(distinct(rd.noofinpat))
                                      from recorddetail rd
                                      left join inpatient inp
                                        on inp.noofinpat = rd.noofinpat
                                     where inp.status in
                                           (1500, 1501, 1505, 1506, 1507)
                                       and rd.valid = '1'
                                       and inp.outhosdept = deptcode))
                             from dual),
                           0);

    OPEN o_result FOR
      SELECT '_' deptcode,
             '总计' deptname,
             SUM(inhos) inhos,
             SUM(bedcnt) bedcnt,
             SUM(WRTDEFICITCNT) WRTDEFICITCNT,
             SUM(TIMELIMITEDCNT) TIMELIMITEDCNT,
             SUM(HAVESELECTCNT) HAVESELECTCNT,
             SUM(SELECTAVE) SELECTAVE,
             SUM(NORECORDS) NORECORDS
        FROM TMP_DEPARTMENTLIST
      UNION ALL
      SELECT deptcode,
             deptname,
             inhos,
             bedcnt,
             WRTDEFICITCNT,
             TIMELIMITEDCNT,
             HAVESELECTCNT,
             SELECTAVE,
             NORECORDS
        FROM TMP_DEPARTMENTLIST;
  END;

 procedure usp_QcmanagerDepartmentDetail(v_deptid varchar default '',
                                         o_result OUT empcurtype) as
 begin
   OPEN o_result FOR
     select inp.noofinpat,
            inp.patid,
            inp.name,
            decode(inp.sexid, '1', '男', '2', '女', '未知') sex,
            inp.agestr,
            inp.outbed,
            u.name resident,
            inp.admitdate,
            dia.name admitdiagnosis,
            inp.status
       from inpatient inp
       left join users u
         on u.id = inp.resident
       left join diagnosis dia
         on dia.markid = inp.admitdiagnosis
      where inp.status in (1500, 1501, 1505, 1506, 1507)
        and inp.outhosdept = v_deptid
      order by inp.outbed;
 end;
END;
/

prompt
prompt Creating package body EMRSYSTABLE
prompt =================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emrsystable IS
  /*******************************************************************************/
  PROCEDURE usp_Edit_Diagnosis(v_EditType      varchar default '', --操作类型
                               v_MarkId        varchar default '',
                               v_ICD           varchar default '',
                               v_MapID         varchar default '',
                               v_StandardCode  varchar default '',
                               v_Name          varchar default '',
                               v_Py            varchar default '',
                               v_Wb            varchar default '',
                               v_TumorID       varchar default '',
                               v_Statist       varchar default '',
                               v_InnerCategory varchar default '',
                               v_Category      varchar default '',
                               v_OtherCategroy int default '',
                               v_Valid         int default 1,
                               v_Memo          varchar default '',
                               o_result        OUT empcurtyp) as
    /*
    Diagnosis  诊断库
    */
  begin

    open o_result for
      select v_MarkId from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO Diagnosis
        (MarkId,
         ICD,
         MapID,
         StandardCode,
         Name,
         Py,
         Wb,
         TumorID,
         Statist,
         InnerCategory,
         Category,
         OtherCategroy,
         Valid,
         Memo)
      VALUES
        (v_MarkId,
         v_ICD,
         v_MapID,
         v_StandardCode,
         v_Name,
         v_Py,
         v_Wb,
         v_TumorID,
         v_Statist,
         v_InnerCategory,
         v_Category,
         v_OtherCategroy,
         v_Valid,
         v_Memo);

      --修改
    elsif v_EditType = '2' then

      UPDATE Diagnosis
         SET ICD           = nvl(v_ICD, ICD),
             MapID         = nvl(v_MapID, MapID),
             --StandardCode  = nvl(v_StandardCode, StandardCode),
             StandardCode  = v_StandardCode,
             Name          = nvl(v_Name, Name),
             Py            = nvl(v_Py, Py),
             Wb            = nvl(v_Wb, Wb),
             --TumorID       = nvl(v_TumorID, TumorID),
             TumorID       = v_TumorID,
             --Statist       = nvl(v_Statist, Statist),
             Statist       = v_Statist,
             --InnerCategory = nvl(v_InnerCategory, InnerCategory),
             InnerCategory = v_InnerCategory,
             --Category      = nvl(v_Category, Category),
             Category      = v_Category,
             --OtherCategroy = nvl(v_OtherCategroy, OtherCategroy),
             OtherCategroy = v_OtherCategroy,
             Valid         = nvl(v_Valid, Valid),
             --Memo          = nvl(v_Memo, Memo)
             Memo          = v_Memo
       WHERE MarkId = v_MarkId;

      --删除
    elsif v_EditType = '3' then

      /*UPDATE Diagnosis SET Valid = 0 WHERE MarkId = v_MarkId;*/
      delete diagnosis WHERE MarkId = v_MarkId;

      --查询
    elsif v_EditType = '4' then
      open o_result for

        select b.id statistid,b.name statistname,
               /*a.statist,*/
               c.id innercategoryid,
               c.name innercategoryname,
               /*a.innercategory,*/
               d.id categoryid,
               d.name categoryname,
               /*a.category,*/
               e.id othercategroyid,
               e.name othercategroyname,
               /*a.othercategroy,*/
               t.name tumorname,
               /*a.tumorid,*/
               (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from Diagnosis a
          left join diseasecfg b on trim(a.statist) = trim(to_char(b.id))
                                and b.category = '700'
          left join diseasecfg c on trim(a.innercategory) =
                                    trim(to_char(c.id))
                                and c.category = '702'
          left join diseasecfg d on trim(a.category) = trim(to_char(d.id))
                                and d.category = '701'
          left join categorydetail e on trim(a.othercategroy) =
                                        trim(to_char(e.id))
                                    and e.categoryid = 9
          left join Tumor t on a.tumorid = t.id
         where (a.MarkId = v_MarkId or v_MarkId is null);
      /*select (case when a.valid =1 then '是' else '否' end) validName,a.*
       from Diagnosis a
      where (a.MarkId = v_MarkId or v_MarkId is null);*/
    end if;

  end;

  PROCEDURE usp_Edit_DeptDiagnosis(v_EditType varchar default '', --操作类型
                                   v_DeptID   varchar default '',
                                   v_MarkID   varchar default '',
                                   o_result   OUT empcurtyp) as
    /*
    Diagnosis  科室常用诊断库
    */
    v_sql VARCHAR(4000);
  begin

    open o_result for
      select v_MarkId from dual;
    --添加
    if v_EditType = '1' then

      delete DiagnosisToDept WHERE DeptID = v_DeptID;

      v_sql := '
      INSERT INTO DiagnosisToDept
        (MarkId,
         ICD,
         MapID,
         StandardCode,
         Name,
         Py,
         Wb,
         TumorID,
         Statist,
         InnerCategory,
         Category,
         OtherCategroy,
         Valid,
         Memo,
         DeptID)
        select MarkId,
               ICD,
               MapID,
               StandardCode,
               Name,
               Py,
               Wb,
               TumorID,
               Statist,
               InnerCategory,
               Category,
               OtherCategroy,
               Valid,
               Memo,
               ' || v_DeptID || '
          from diagnosis
         where MarkId in (' || v_MarkID || ')';

      EXECUTE IMMEDIATE v_sql;

      commit;
      open o_result for
        select 1 from dual;

      --查询
    elsif v_EditType = '2' then
      open o_result for

        select b.name statistname,
               /*a.statist,*/
               c.name innercategoryname,
               /*a.innercategory,*/
               d.name categoryname,
               /*a.category,*/
               e.name othercategroyname,
               /*a.othercategroy,*/
               t.name tumorname,
               /*a.tumorid,*/
               (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from DiagnosisToDept a
          left join diseasecfg b on trim(a.statist) = trim(to_char(b.id))
                                and b.category = '700'
          left join diseasecfg c on trim(a.innercategory) =
                                    trim(to_char(c.id))
                                and c.category = '702'
          left join diseasecfg d on trim(a.category) = trim(to_char(d.id))
                                and d.category = '701'
          left join categorydetail e on trim(a.othercategroy) =
                                        trim(to_char(e.id))
                                    and e.categoryid = 9
          left join Tumor t on a.tumorid = t.id
         where a.deptid = v_DeptID;
      /*select (case when a.valid =1 then '是' else '否' end) validName,a.*
       from Diagnosis a
      where (a.MarkId = v_MarkId or v_MarkId is null);*/
    end if;

  end;

  /*******************************************************************************/
  PROCEDURE usp_Edit_DiagnosisOfChinese(v_EditType varchar default '', --操作类型
                                        v_ID       varchar default '',
                                        v_MapID    varchar default '',
                                        v_Name     varchar default '',
                                        v_Py       varchar default '',
                                        v_Wb       varchar default '',
                                        v_Valid    int default 1,
                                        v_Memo     varchar default '',
                                        v_Memo1    varchar default '',
                                        v_Category varchar default '',
                                        o_result   OUT empcurtyp) as

    /*
    DiagnosisOfChinese     中医诊断库
    */
  begin
    open o_result for
      select v_ID from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO DiagnosisOfChinese
        (ID, MapID, Name, Py, Wb, Valid, Memo, Memo1, Category)
      VALUES
        (v_ID,
         v_MapID,
         v_Name,
         v_Py,
         v_Wb,
         v_Valid,
         v_Memo,
         v_Memo1,
         v_Category);

      --修改
    elsif v_EditType = '2' then

      UPDATE DiagnosisOfChinese
         SET MapID    = nvl(v_MapID, MapID),
             Name     = nvl(v_Name, Name),
             Py       = nvl(v_Py, Py),
             Wb       = nvl(v_Wb, Wb),
             Valid    = nvl(v_Valid, Valid),
             Memo     = nvl(v_Memo, Memo),
             Memo1    = nvl(v_Memo1, Memo1),
             Category = nvl(v_Category, Category)
       WHERE ID = v_ID;

      --删除
    elsif v_EditType = '3' then

      /*update diagnosisofchinese a set a.valid = 0 where a.id = v_ID;*/
      delete diagnosisofchinese WHERE id = v_ID;
      --查询
    elsif v_EditType = '4' then
      open o_result for
        select b.id categoryid,b.name categoryname,
               (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from DiagnosisOfChinese a
          left join categorydetail b on to_char(a.category) =
                                        trim(to_char(b.id))
                                    and b.categoryid = 7
         where (a.ID = v_ID or v_ID is null);
    end if;

  end;

  /*******************************************************************************/
  PROCEDURE usp_Edit_DiseaseCFG(v_EditType  varchar default '', --操作类型
                                v_ID        varchar default '',
                                v_MapID     varchar default '',
                                v_Name      varchar default '',
                                v_Py        varchar default '',
                                v_Wb        varchar default '',
                                v_DiseaseID varchar default '',
                                v_SurgeryID varchar default '',
                                v_Category  int default '',
                                v_Mark      varchar default '',
                                v_ParentID  varchar default '',
                                v_Valid     int default 1,
                                v_Memo      varchar default '',
                                o_result    OUT empcurtyp) as
    /*
    DiseaseCFG  病种设置库
    */
  begin

    open o_result for
      select v_ID from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO DiseaseCFG
        (ID,
         MapID,
         Name,
         Py,
         Wb,
         DiseaseID,
         SurgeryID,
         Category,
         Mark,
         ParentID,
         Valid,
         Memo)
      VALUES
        (v_ID,
         v_MapID,
         v_Name,
         v_Py,
         v_Wb,
         v_DiseaseID,
         v_SurgeryID,
         v_Category,
         v_Mark,
         v_ParentID,
         v_Valid,
         v_Memo);

      --修改
    elsif v_EditType = '2' then

      UPDATE DiseaseCFG
         SET MapID     = nvl(v_MapID, MapID),
             Name      = nvl(v_Name, Name),
             Py        = nvl(v_Py, Py),
             Wb        = nvl(v_Wb, Wb),
             DiseaseID = nvl(v_DiseaseID, DiseaseID),
             SurgeryID = nvl(v_SurgeryID, SurgeryID),
             Category  = nvl(v_Category, Category),
             Mark      = nvl(v_Mark, MapID),
             ParentID  = nvl(v_ParentID, MapID),
             Valid     = nvl(v_Valid, Valid),
             Memo      = nvl(v_Memo, MapID)
       WHERE ID = v_ID;

      --删除
    elsif v_EditType = '3' then

      /*update DiseaseCFG a set a.valid = 0 where a.id = v_ID;*/
      delete DiseaseCFG WHERE id = v_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select b.name categoryname,
               (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from DiseaseCFG a
          left join CategoryDetail b on trim(to_char(b.ID)) =
                                        trim(a.category)
                                    and b.CategoryID = 7
         where (a.ID = v_ID or v_ID is null);
    end if;

  end;

  /*******************************************************************************/
  PROCEDURE usp_Edit_Surgery(v_EditType     varchar default '', --操作类型
                             v_ID           varchar default '',
                             v_MapID        varchar default '',
                             v_StandardCode varchar default '',
                             v_Name         varchar default '',
                             v_Py           varchar default '',
                             v_Wb           varchar default '',
                             v_Valid        int default 1,
                             v_Memo         varchar default '',
                             v_bzlb         varchar default '',
                             v_sslb         int default '',
                             o_result       OUT empcurtyp) as
    /*
    Surgery  手术代码库
    */
  begin

    open o_result for
      select v_ID from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO Surgery
        (ID, MapID, StandardCode, Name, Py, Wb, Valid, Memo, bzlb, sslb)
      VALUES
        (v_ID,
         v_MapID,
         v_StandardCode,
         v_Name,
         v_Py,
         v_Wb,
         v_Valid,
         v_Memo,
         v_bzlb,
         v_sslb);

      --修改
    elsif v_EditType = '2' then
      UPDATE Surgery
         SET MapID        = nvl(v_MapID, MapID),
             StandardCode = nvl(v_StandardCode, StandardCode),
             Name         = nvl(v_Name, Name),
             Py           = nvl(v_Py, Py),
             Wb           = nvl(v_Wb, Wb),
             Valid        = nvl(v_Valid, Valid),
             Memo         = nvl(v_Memo, Memo),
             bzlb         = nvl(v_bzlb, bzlb),
             sslb         = nvl(v_sslb, sslb)
       WHERE ID = v_ID;

      --删除
    elsif v_EditType = '3' then

      /*update Surgery a set a.valid = 0 where a.id = v_ID;*/
      delete Surgery WHERE id = v_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select b.name bzlbname,
               c.name sslbname,
               (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from Surgery a
          left join DiseaseCFG b on trim(to_char(b.ID)) = trim(a.bzlb)
                                and b.Category = 701
          left join CategoryDetail c on c.ID = a.sslb
                                    and c.CategoryID = 8
         where (a.ID = v_ID or v_ID is null);
    end if;

  end;



  -------------------------手术信息维护----------------------------------
   PROCEDURE usp_Edit_OperInfo(v_EditType     varchar default '', --操作类型
                             v_ID           varchar default '',
                             v_MapID        varchar default '',
                             --v_StandardCode varchar default '',
                             v_Name         varchar default '',
                             v_Py           varchar default '',
                             v_Wb           varchar default '',
                             v_Valid        int default 1,
                             v_Memo         varchar default '',
                           --  v_bzlb         varchar default '',
                             v_sslb         int default '',
                             o_result       OUT empcurtyp)
 as
    /*
    Surgery  手术代码库
    */
  begin

    open o_result for
      select v_ID from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO operation
        (ID, MapID,  Name, Py, Wb,  sslb,Valid, Memo)
      VALUES
        (V_ID,
         v_MapID,
         v_Name,
         v_Py,
         v_Wb,
          v_sslb,
         v_Valid,
         v_Memo
        );

      --修改
    elsif v_EditType = '2' then
      UPDATE operation
         SET MapID        = nvl(v_MapID, MapID),
             Name         = nvl(v_Name, Name),
             Py           = nvl(v_Py, Py),
             Wb           = nvl(v_Wb, Wb),
             Valid        = nvl(v_Valid, Valid),
             Memo         = nvl(v_Memo, Memo),
             sslb         = nvl(v_sslb, sslb)
       WHERE ID = v_ID;

      --删除
    elsif v_EditType = '3' then

      update operation a set a.valid = 0 where a.id = v_ID;
      --delete Surgery WHERE id = v_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select
               c.name sslbname,
               (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from operation a
          left join CategoryDetail c on c.ID = a.sslb
                                    and c.CategoryID = 8
         where (a.ID = v_ID or v_ID is null) and a.valid='1';
    end if;

  end;

  ---------------------------------------------------------------

  /*******************************************************************************/
  PROCEDURE usp_Edit_Toxicosis(v_EditType     varchar default '', --操作类型
                               v_ID           varchar default '',
                               v_MapID        varchar default '',
                               v_StandardCode varchar default '',
                               v_Name         varchar default '',
                               v_Py           varchar default '',
                               v_Wb           varchar default '',
                               v_Valid        int default 1,
                               v_Memo         varchar default '',
                               o_result       OUT empcurtyp) as
    /*
    Toxicosis  损伤中毒库
    */
  begin
    open o_result for
      select v_ID from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO Toxicosis
        (ID, MapID, StandardCode, Name, Py, Wb, Valid, Memo)
      VALUES
        (v_ID,
         v_MapID,
         v_StandardCode,
         v_Name,
         v_Py,
         v_Wb,
         v_Valid,
         v_Memo);

      --修改
    elsif v_EditType = '2' then

      UPDATE Toxicosis
         set MapID        = nvl(v_MapID, MapID),
             StandardCode = nvl(v_StandardCode, StandardCode),
             Name         = nvl(v_Name, Name),
             Py           = nvl(v_Py, Py),
             Wb           = nvl(v_Wb, Wb),
             Valid        = nvl(v_Valid, Valid),
             Memo         = nvl(v_Memo, Memo)
       WHERE id = v_ID;

      --删除
    elsif v_EditType = '3' then

      /*update Toxicosis a set a.valid = 0 where MapID = v_MapID;*/
      delete Toxicosis WHERE id = v_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from Toxicosis a
         where (a.id = v_ID or v_ID is null);
    end if;

  end;



  /******************************************模板工厂操作*************************************/
  PROCEDURE usp_Edit_ModelEmr(v_EditType      varchar default '', --操作类型
                               v_ModelId        varchar default '',
                               v_DestEmrName           varchar default '',
                               v_SourceEmrName         varchar default '',
                               v_DestItemName  varchar default '',
                               v_SourceItemName          varchar default '',
                               v_Valid         int default 1,
                               o_result        OUT empcurtyp) as
    /*
    Toxicosis  模板工厂库
    */
  begin
    open o_result for
      select v_ModelId from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO emr_replace_item
        (ID,dest_emrname ,source_emrname ,dest_itemname ,source_itemname , Valid)
      VALUES
        (v_ModelId,
         v_DestEmrName,
         v_SourceEmrName,
         v_DestItemName,
         v_SourceItemName,
         v_Valid);

      --修改
    elsif v_EditType = '2' then

      UPDATE emr_replace_item
         set ID        = nvl(v_ModelId, ID),
           -- dest_emrname  = nvl(v_DestEmrName, dest_emrname),
            dest_emrname  = v_DestEmrName,
           /* source_emrname= nvl(v_SourceEmrName, source_emrname),
             dest_itemname = nvl(v_DestItemName, dest_itemname),
              source_itemname= nvl(v_SourceItemName, source_itemname),
             Valid        = nvl(v_Valid, Valid)*/
               source_emrname= v_SourceEmrName,
             dest_itemname = v_DestItemName,
              source_itemname= v_SourceItemName,
             Valid        = v_Valid
       WHERE id = v_ModelId;

      --删除
    elsif v_EditType = '3' then

     update emr_replace_item a set a.valid = 0 where ID = v_ModelId;
      /*delete Toxicosis WHERE id = v_ID;*/

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from emr_replace_item a
         where (a.id = v_ModelId or v_ModelId is null) and a.valid='1' order by id;
    end if;

  end;



  /*******************************************************************************/
  PROCEDURE usp_Edit_Tumor(v_EditType     varchar default '', --操作类型
                           v_ID           varchar default '',
                           v_MapID        varchar default '',
                           v_StandardCode varchar default '',
                           v_Name         varchar default '',
                           v_Py           varchar default '',
                           v_Wb           varchar default '',
                           v_Valid        int default 1,
                           v_Memo         varchar default '',
                           o_result       OUT empcurtyp) as
    /*
    Tumor  肿瘤库
    */
  begin
    open o_result for
      select v_ID from dual;
    --添加
    if v_EditType = '1' then

      INSERT INTO Tumor
        (ID, MapID, StandardCode, Name, Py, Wb, Valid, Memo)
      VALUES
        (v_ID,
         v_MapID,
         v_StandardCode,
         v_Name,
         v_Py,
         v_Wb,
         v_Valid,
         v_Memo);

      --修改
    elsif v_EditType = '2' then

      UPDATE Tumor
         SET MapID        = nvl(v_MapID, MapID),
             StandardCode = nvl(v_StandardCode, StandardCode),
             Name         = nvl(v_Name, Name),
             Py           = nvl(v_Py, Py),
             Wb           = nvl(v_Wb, Wb),
             Valid        = nvl(v_Valid, Valid),
             Memo         = nvl(v_Memo, Memo)
       WHERE ID = v_ID;

      --删除
    elsif v_EditType = '3' then

      /*update Tumor a set a.valid = 0 where ID = v_ID;*/
      delete Tumor WHERE ID = v_ID;
      --查询
    elsif v_EditType = '4' then
      open o_result for
        select (case
                 when a.valid = 1 then
                  '是'
                 else
                  '否'
               end) validName,
               a.*
          from Tumor a
         where (ID = v_ID or v_ID is null);
    end if;

  end;

/*******************************************************************************/

end;
/

prompt
prompt Creating package body EMRTEMPLETFACTORY
prompt =======================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emrtempletfactory IS
  /*******************************************************************/

  /*****************************************************************************/
  PROCEDURE usp_EditEmrTemplet(v_EditType        varchar default '', --操作类型
                               v_TEMPLET_ID      VARCHAR2 default '',
                               v_FILE_NAME       VARCHAR2 default '',
                               v_DEPT_ID         VARCHAR2 default '',
                               v_CREATOR_ID      VARCHAR2 default '',
                               v_CREATE_DATETIME VARCHAR2 default '',
                               v_LAST_TIME       VARCHAR2 default '',
                               v_PERMISSION      VARCHAR2 default '',
                               v_MR_CLASS        VARCHAR2 default '',
                               v_MR_CODE         VARCHAR2 default '',
                               v_MR_NAME         VARCHAR2 default '',
                               v_MR_ATTR         VARCHAR2 default '',
                               v_QC_CODE         VARCHAR2 default '',
                               v_NEW_PAGE_FLAG   INTEGER default 0,
                               v_FILE_FLAG       INTEGER default 0,
                               v_WRITE_TIMES     INTEGER default 0,
                               v_CODE            VARCHAR2 default '',
                               v_HOSPITAL_CODE   VARCHAR2 default '',
                               v_XML_DOC_NEW     clob default '',
                               v_PY              varchar2 default '',
                               v_WB              varchar2 default '',
                               v_ISSHOWFILENAME  varchar2 default '0',
                               v_ISFIRSTDAILY    varchar2 default '0',
                               v_ISYIHUANGOUTONG varchar2 default '0',
                               v_NEW_PAGE_END    INTEGER default 0,
                               v_state           varchar2 default '0',
                               v_auditor         varchar2 default '',
                                  v_isconfigpagesize    varchar2 default '0',
                               o_result          OUT empcurtyp) as

    v_new_TempletID     VARCHAR(10);
    v_new_MRCode        VARCHAR(10);
    v_new_HOSPITAL_CODE VARCHAR(12);
  begin
    open o_result for
      select '' from dual;

    --添加
    if v_EditType = '1' then

      select lpad(max(a.templet_id) + 1, 6, '0') templetid
        into v_new_TempletID
        from emrtemplet a;
      select v_MR_CLASS || v_DEPT_ID ||
             lpad(nvl(max(substr(a.mr_code, -3)), 0) + 1, 3, '0') mrcode
        into v_new_MRCode
        from emrtemplet a
       where a.mr_class = v_MR_CLASS
         and a.dept_id = v_DEPT_ID and a.valid=1;

      select a.medicalid into v_new_HOSPITAL_CODE from hospitalinfo a;

      insert into EMRTEMPLET
        (TEMPLET_ID,
         FILE_NAME,
         DEPT_ID,
         CREATOR_ID,
         CREATE_DATETIME,
         LAST_TIME,
         PERMISSION,
         MR_CLASS,
         MR_CODE,
         MR_NAME,
         MR_ATTR,
         QC_CODE,
         NEW_PAGE_FLAG,
         FILE_FLAG,
         WRITE_TIMES,
         CODE,
         HOSPITAL_CODE,
         XML_DOC_NEW,
         PY,
         WB,
         isshowfilename,
         ISFIRSTDAILY,
         ISYIHUANGOUTONG,
         NEW_PAGE_END,
         Valid,
         state,
         auditor,
         isconfigpagesize,
         auditdate
         )
      values
        (v_new_TempletID,
         v_FILE_NAME,
         v_DEPT_ID,
         v_CREATOR_ID,
         to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
         to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
         v_PERMISSION,
         v_MR_CLASS,
         v_new_MRCode,
         v_MR_NAME,
         v_MR_ATTR,
         v_QC_CODE,
         v_NEW_PAGE_FLAG,
         v_FILE_FLAG,
         v_WRITE_TIMES,
         v_CODE,
         v_new_HOSPITAL_CODE,
         v_XML_DOC_NEW,
         v_PY,
         v_WB,
         v_ISSHOWFILENAME,
         v_ISFIRSTDAILY,
         v_ISYIHUANGOUTONG,
         v_NEW_PAGE_END,
         1,
         v_state,
         v_auditor,
         v_isconfigpagesize,
         (case when  v_auditor is not null then to_char(sysdate,'yyyy-mm-dd HH24:mi:ss') else '' end)
         );

      open o_result for
        select v_new_TempletID from dual;
      --修改
    elsif v_EditType = '2' then

      UPDATE EMRTEMPLET
         SET FILE_NAME       = nvl(v_FILE_NAME, FILE_NAME),
             DEPT_ID         = nvl(v_DEPT_ID, DEPT_ID),
             LAST_TIME       = nvl(to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'), LAST_TIME),
             PERMISSION      = nvl(v_PERMISSION, PERMISSION),
             MR_CLASS        = nvl(v_MR_CLASS, MR_CLASS),
             MR_CODE         = nvl(v_MR_CODE, MR_CODE),
             MR_NAME         = nvl(v_MR_NAME, MR_NAME),
             MR_ATTR         = nvl(v_MR_ATTR, MR_ATTR),
             QC_CODE         = nvl(v_QC_CODE, QC_CODE),
             NEW_PAGE_FLAG   = nvl(v_NEW_PAGE_FLAG, NEW_PAGE_FLAG),
             FILE_FLAG       = nvl(v_FILE_FLAG, FILE_FLAG),
             WRITE_TIMES     = nvl(v_WRITE_TIMES, WRITE_TIMES),
             CODE            = nvl(v_CODE, CODE),
             HOSPITAL_CODE   = nvl(v_HOSPITAL_CODE, HOSPITAL_CODE),
             XML_DOC_NEW     = v_XML_DOC_NEW,
             PY              = v_PY,
             WB              = v_WB,
             isshowfilename  = v_ISSHOWFILENAME,
             ISFIRSTDAILY    = v_ISFIRSTDAILY,
             ISYIHUANGOUTONG = v_ISYIHUANGOUTONG,
             NEW_PAGE_END    = v_NEW_PAGE_END,
             state           = v_state,
             auditor           = v_auditor,
             isconfigpagesize=v_isconfigpagesize,--新增页面配置
             auditdate         = (case when  v_auditor is not null then to_char(sysdate,'yyyy-mm-dd HH24:mi:ss') else '' end)
       WHERE TEMPLET_ID = v_TEMPLET_ID;

      open o_result for
        select v_TEMPLET_ID from dual;
      --删除(原来的删除直接删除，现在改为更新Valid标识)
    elsif v_EditType = '3' then

      /*delete EMRTEMPLET where TEMPLET_ID = v_TEMPLET_ID;*/
      update EMRTEMPLET set valid=0 where TEMPLET_ID = v_TEMPLET_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select *
          from emrtemplet a
         where (a.templet_id = v_TEMPLET_ID or v_TEMPLET_ID is null) and a.valid=1;
    end if;

  end;

  /*****************************************************************************/
  PROCEDURE usp_EditEmrTemplet_Item(v_EditType         varchar default '', --操作类型
                                    v_MR_CLASS         VARCHAR2 default '',
                                    v_MR_CODE          VARCHAR2 default '',
                                    v_MR_NAME          VARCHAR2 default '',
                                    v_MR_ATTR          VARCHAR2 default '',
                                    v_QC_CODE          VARCHAR2 default '',
                                    v_DEPT_ID          VARCHAR2 default '',
                                    v_CREATOR_ID       VARCHAR2 default '',
                                    v_CREATE_DATE_TIME VARCHAR2 default '',
                                    v_LAST_TIME        VARCHAR2 default '',
                                    v_CONTENT_CODE     VARCHAR2 default '',
                                    v_PERMISSION       int default 0,
                                    v_VISIBLED         int default 1,
                                    v_INPUT            VARCHAR2 default '',
                                    v_HOSPITAL_CODE    VARCHAR2 default '',
                                    v_ITEM_DOC_NEW     clob default '',
                                    o_result           OUT empcurtyp) as

    v_new_MRCode        VARCHAR(10);
    v_new_HOSPITAL_CODE VARCHAR(12);
  begin
    --添加
    open o_result for
      select '' from dual;

    if v_EditType = '1' then
      begin
        --根据科室编码计算Mr_Code
        if v_DEPT_ID <> '*' then
          select v_MR_CLASS || v_DEPT_ID ||
                 lpad(nvl(max(substr(a.mr_code, -2)), 0) + 1, 2, '0') mrcode
            into v_new_MRCode
            from emrtemplet_item a
           where a.mr_class = v_MR_CLASS
             and a.dept_id = v_DEPT_ID;
        else
          select v_MR_CLASS ||
                 to_number(nvl(max(substr(a.mr_code, 3)), 0) + 1)
            into v_new_MRCode
            from emrtemplet_item a
           where a.mr_class = 'BA'
             and a.dept_id = v_DEPT_ID;
        end if;

        select a.medicalid into v_new_HOSPITAL_CODE from hospitalinfo a;

        insert into EMRTEMPLET_ITEM
          (MR_CLASS,
           MR_CODE,
           MR_NAME,
           MR_ATTR,
           QC_CODE,
           DEPT_ID,
           CREATOR_ID,
           CREATE_DATE_TIME,
           LAST_TIME,
           CONTENT_CODE,
           PERMISSION,
           VISIBLED,
           INPUT,
           HOSPITAL_CODE,
           ITEM_DOC_NEW)
        values
          (v_MR_CLASS,
           v_new_MRCode,
           v_MR_NAME,
           v_MR_ATTR,
           v_QC_CODE,
           v_DEPT_ID,
           v_CREATOR_ID,
           to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
           to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
           v_CONTENT_CODE,
           v_PERMISSION,
           v_VISIBLED,
           v_INPUT,
           v_new_HOSPITAL_CODE,
           v_ITEM_DOC_NEW);

        open o_result for
          select v_new_MRCode from dual;

      end;
      --修改
    elsif v_EditType = '2' then
      update EMRTEMPLET_ITEM
         set MR_CLASS = nvl(v_MR_CLASS, MR_CLASS),
             MR_NAME  = nvl(v_MR_NAME, MR_NAME),
             MR_ATTR  = nvl(v_MR_ATTR, MR_ATTR),
             QC_CODE  = nvl(v_QC_CODE, QC_CODE),
             DEPT_ID  = nvl(v_DEPT_ID, DEPT_ID),
             LAST_TIME     = to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
             CONTENT_CODE  = nvl(v_CONTENT_CODE, CONTENT_CODE),
             PERMISSION    = nvl(v_PERMISSION, PERMISSION),
             VISIBLED      = nvl(v_VISIBLED, VISIBLED),
             INPUT         = nvl(v_INPUT, INPUT),
             HOSPITAL_CODE = nvl(v_HOSPITAL_CODE, HOSPITAL_CODE),
             ITEM_DOC_NEW  = v_ITEM_DOC_NEW
       where MR_CODE = v_MR_CODE;

      open o_result for
        select v_MR_CODE from dual;
      --删除
    elsif v_EditType = '3' then

      delete EMRTEMPLET_ITEM where MR_CODE = v_MR_CODE;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select *
          from EMRTEMPLET_ITEM a
         where (a.mr_code = v_MR_CODE or v_MR_CODE is null);
    end if;

  end;

  /**********************************************************************************/
  PROCEDURE usp_EditEmrTempletHeader(v_EditType        varchar default '', --操作类型
                                     v_HEADER_ID       VARCHAR2 default '',
                                     v_NAME            VARCHAR2 default '',
                                     v_CREATOR_ID      VARCHAR2 default '',
                                     v_CREATE_DATETIME VARCHAR2 default '',
                                     v_LAST_TIME       VARCHAR2 default '',
                                     v_HOSPITAL_CODE   VARCHAR2 default '',
                                     v_CONTENT         CLOB default '',
                                     o_result          OUT empcurtyp) as
    v_new_Header_ID varchar2(40);
  begin
    --添加
    if v_EditType = '1' then

      select seq_EmrTempletHeader_ID.Nextval
        into v_new_Header_ID
        from dual;

      insert into emrtempletHeader
        (HEADER_ID,
         NAME,
         CREATOR_ID,
         CREATE_DATETIME,
         LAST_TIME,
         HOSPITAL_CODE,
         CONTENT)
      values
        (v_new_Header_ID,
         v_NAME,
         v_CREATOR_ID,
         to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'),
         to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'),
         v_HOSPITAL_CODE,
         v_CONTENT);

      open o_result for
        select v_new_Header_ID from dual;

      --修改
    elsif v_EditType = '2' then

      UPDATE EMRTEMPLETHEADER
         SET NAME            = nvl(v_NAME, NAME),
             LAST_TIME       = nvl(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'), LAST_TIME),
             HOSPITAL_CODE   = nvl(v_HOSPITAL_CODE, HOSPITAL_CODE),
             CONTENT         = nvl(v_CONTENT, CONTENT)
       where HEADER_ID = v_HEADER_ID;

      open o_result for
        select v_HEADER_ID from dual;
      --删除
    elsif v_EditType = '3' then

      delete EMRTEMPLETHEADER where HEADER_ID = v_HEADER_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select *
          from EMRTEMPLETHEADER
         where HEADER_ID = v_HEADER_ID
            or v_HEADER_ID is null;
    end if;

  end;

/*********************************************************************************************************/
PROCEDURE usp_EditEmrTemplet_Foot(v_EditType        varchar default '', --操作类型
                                     v_FOOT_ID       VARCHAR2 default '',
                                     v_NAME            VARCHAR2 default '',
                                     v_CREATOR_ID      VARCHAR2 default '',
                                     v_CREATE_DATETIME VARCHAR2 default '',
                                     v_LAST_TIME       VARCHAR2 default '',
                                     v_HOSPITAL_CODE   VARCHAR2 default '',
                                     v_CONTENT         CLOB default '',
                                     o_result          OUT empcurtyp) as
    v_new_Foot_ID varchar2(40);
  begin
    --添加
    if v_EditType = '1' then

      select SEQ_emrtemplet_foot_ID.Nextval
        into v_new_Foot_ID
        from dual;

      insert into emrtemplet_foot
        (Foot_ID,
         NAME,
         CREATOR_ID,
         CREATE_DATETIME,
         LAST_TIME,
         HOSPITAL_CODE,
         CONTENT)
      values
        (v_new_Foot_ID,
         v_NAME,
         v_CREATOR_ID,
         to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'),
         to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'),
         v_HOSPITAL_CODE,
         v_CONTENT);

      open o_result for
        select v_new_Foot_ID from dual;

      --修改
    elsif v_EditType = '2' then

      UPDATE emrtemplet_foot
         SET NAME            = nvl(v_NAME, NAME),
             LAST_TIME       = nvl(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'), LAST_TIME),
             HOSPITAL_CODE   = nvl(v_HOSPITAL_CODE, HOSPITAL_CODE),
             CONTENT         = nvl(v_CONTENT, CONTENT)
       where Foot_ID = v_FOOT_ID;

      open o_result for
        select v_FOOT_ID from dual;
      --删除
    elsif v_EditType = '3' then

      delete emrtemplet_foot where Foot_ID = v_FOOT_ID;

      --查询
    elsif v_EditType = '4' then
      open o_result for
        select *
          from emrtemplet_foot
         where foot_ID = v_FOOT_ID
            or v_FOOT_ID is null;
    end if;

  end;

  --保存诊断按钮
  PROCEDURE usp_SaveDiagButton(v_diagname   varchar) AS
  BEGIN
    MERGE INTO patdiagtype p
    USING (SELECT v_diagname diagname FROM dual) a
    ON (p.diagname = a.diagname)
    WHEN NOT MATCHED THEN
    INSERT VALUES
    (
        (SELECT max(sno) + 1 FROM patdiagtype),
        (SELECT max(sno) + 1 FROM patdiagtype),
        v_diagname,
        '2'
    );
  END;

  --个人模版维护
  PROCEDURE usp_EditMyEmrTemplet(v_EditType        varchar default '',
                               v_CODE      VARCHAR2 default '',
                               v_CREATEUSER      VARCHAR2 default '',
                               v_MR_CLASS        VARCHAR2 default '',
                               v_MR_NAME         VARCHAR2 default '',
                               v_EMRTEMLETCONTENT     clob default '',
                               o_result          OUT empcurtyp) as

  begin
    open o_result for
      select '' from dual;

    if v_EditType = '1' then

      insert into DOCTOREMRTEMPLET
        ( CODE,
         CREATEUSER,
         CREATEDATE,
         MR_CLASS,
         NAME,
          EMRTEMLETCONTENT
         )
      values
        (v_CODE,
         v_CREATEUSER,
         to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
         v_MR_CLASS,
         v_MR_NAME,
         v_EMRTEMLETCONTENT
         );

      open o_result for
        select v_CODE from dual;

    elsif v_EditType = '2' then

      UPDATE DOCTOREMRTEMPLET
         SET
             name         = nvl(v_MR_NAME, name),
             EMRTEMLETCONTENT     = v_EMRTEMLETCONTENT
       WHERE CODE = v_CODE and CREATEUSER=v_CREATEUSER;

      open o_result for
        select v_CODE from dual;

    elsif v_EditType = '3' then

    delete DOCTOREMRTEMPLET where code = v_CODE and CREATEUSER=v_CREATEUSER;

    elsif v_EditType = '4' then
      open o_result for
               select e.templet_id,
               substr(e.mr_name,instr(e.mr_name,'-',1,2)+1)ordername,
               e.file_name,
               e.dept_id,
               b.createuser creator_id,
               b.createdate create_datetime,
               e.last_time,
               e.permission,
               e.mr_class,
               e.mr_code,
               e.code,
               e.mr_attr,
               e.qc_code,
               e.new_page_flag,
               b.emrtemletcontent XML_DOC_NEW,
               e.file_flag,
               e.write_times,
               e.hospital_code,
               nvl(e.isfirstdaily, 0) isfirstdaily,
               e.isshowfilename,
               e.isyihuangoutong,
               e.NEW_PAGE_END,
               e.valid,
               e.State,
               e.isconfigpagesize,
               e.auditor,
               e.auditdate,
              (case when (select count(1)
              from templet2hisdept t
              where t.templetid = e.templet_id)>0 then '??' || mr_name else mr_name end )mr_name
                from emrtemplet e ,DOCTOREMRTEMPLET b
              where e.valid = 1 and e.templet_id=b.code and b.createuser= v_CREATEUSER and b.code = v_CODE or v_CODE is null;

    end if;

  end;
end;
/

prompt
prompt Creating package body EMR_COMMONNOTE
prompt ====================================
prompt
create or replace package body emr.emr_commonnote is

  --通过检索条件获取数据元
  PROCEDURE usp_GetDateElement(v_ElementId    VARCHAR2,
                               v_ElementName  VARCHAR2,
                               v_ElementClass VARCHAR2,
                               v_ElementPYM   VARCHAR2,
                               o_result       OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select *
        from dateelement d
       where d.elementid like '%' || v_ElementId || '%'
         and d.elementname like '%' || v_ElementName || '%'
         and d.elementclass like '%' || v_ElementClass || '%'
         and d.elementpym like '%' || v_ElementPYM || '%'
         and d.valid = '1';
  END;

  --通过检索条件获取数据元
  PROCEDURE usp_GetDateElementOne(v_ElementFlow VARCHAR2,
                                  o_result      OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select * from dateelement d where d.elementflow = v_ElementFlow;
  END;

  --通过数据元ID查找是够存在该数据元
  PROCEDURE usp_ValiDateElement(v_ElementId VARCHAR2,
                                o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select *
        from dateelement d
       where d.elementid = v_ElementId
         and d.valid = '1';
  END;

  --插入数据元
  PROCEDURE usp_InsertElement(v_ElementFlow     VARCHAR2,
                              v_ElementId       VARCHAR2,
                              v_ElementName     VARCHAR2,
                              v_ElementType     VARCHAR2,
                              v_ElementForm     VARCHAR2,
                              v_ElementRange    VARCHAR2,
                              v_ElementDescribe VARCHAR2,
                              v_ElementClass    VARCHAR2,
                              v_IsDataElemet    VARCHAR2,
                              v_ElementPYM      VARCHAR2) AS
  BEGIN
    insert into dateelement
    values
      (v_ElementFlow,
       v_ElementId,
       v_ElementName,
       v_ElementType,
       v_ElementForm,
       v_ElementRange,
       v_ElementDescribe,
       v_ElementClass,
       v_IsDataElemet,
       v_ElementPYM,
       '1');
  END;

  --修改数据元
  PROCEDURE usp_UpDateElement(v_ElementFlow     VARCHAR2,
                              v_ElementId       VARCHAR2,
                              v_ElementName     VARCHAR2,
                              v_ElementType     VARCHAR2,
                              v_ElementForm     VARCHAR2,
                              v_ElementRange    VARCHAR2,
                              v_ElementDescribe VARCHAR2,
                              v_ElementClass    VARCHAR2,
                              v_IsDataElemet    VARCHAR2,
                              v_ElementPYM      VARCHAR2,
                              v_Valid           VARCHAR2) AS
  BEGIN
    update dateelement d
       set d.ElementId       = v_ElementId,
           d.ElementName     = v_ElementName,
           d.ElementType     = v_ElementType,
           d.ElementForm     = v_ElementForm,
           d.ElementRange    = v_ElementRange,
           d.ElementDescribe = v_ElementDescribe,
           d.ElementClass    = v_ElementClass,
           d.IsDataElemet    = v_IsDataElemet,
           d.ElementPYM      = v_ElementPYM,
           d.Valid           = v_Valid
     where d.elementflow = v_ElementFlow;
  END;

  --获取简单版通用单
  PROCEDURE usp_GetSimpleCommonNote(v_CommonNoteName VARCHAR2,
                                    o_result         OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select *
        from COMMONNOTE cn
       Where (cn.commonnotename like '%' || v_CommonNoteName || '%' or
             cn.pym like '%' || v_CommonNoteName || '%' or
             cn.wbm like '%' || v_CommonNoteName || '%')
         and cn.valide = '1'
       order by cn.createdatetime;

  END;

  --获取通用单对应科室和病区
  PROCEDURE usp_GetCommonNoteSite(v_CommonNoteFlow VARCHAR2,
                                  o_result         OUT empcurtype,
                                  o_result1        OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select de.id, de.name
        from COMMONNOTE_SITE_REF cref
        left join department de
          on cref.site_id = de.id
       where cref.relationtype = '01'
         and cref.valide = '1'
         and cref.commonnoteflow = v_CommonNoteFlow; --科室

    OPEN o_result1 FOR
      select ward.id, ward.name
        from COMMONNOTE_SITE_REF cref
        left join ward
          on cref.site_id = ward.id
       where cref.relationtype = '02'
         and cref.valide = '1'
         and cref.commonnoteflow = v_CommonNoteFlow; --病区
  END;

  --获取详细通用单
  PROCEDURE usp_GetDetailCommonNote(v_CommonNoteFlow VARCHAR2,
                                    o_result         OUT empcurtype,
                                    o_result1        OUT empcurtype,
                                    o_result2        OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select *
        from COMMONNOTE cn
       Where cn.commonnoteflow = v_CommonNoteFlow
         and cn.valide = '1';
    OPEN o_result1 FOR
      select *
        from COMMONNOTE_TAB ctab
       Where ctab.Commonnoteflow = v_CommonNoteFlow
         and ctab.valide = '1'
       order by ctab.ordercode asc;
    OPEN o_result2 FOR
      select *
        from COMMONNOTE_ITEM citem
       Where citem.Commonnoteflow = v_CommonNoteFlow
         and citem.valide = '1'
       order by citem.ordercode;
  END;

  --插入或修改通用单
  PROCEDURE usp_AddOrModCommonNote(v_CommonNoteFlow   VARCHAR2,
                                   v_CommonNoteName   VARCHAR2,
                                   v_PrinteModelName  VARCHAR2,
                                   v_ShowType         VARCHAR2,
                                   v_CreateDoctorID   VARCHAR2,
                                   v_CreateDoctorName VARCHAR2,
                                   v_UsingFlag        VARCHAR2,
                                   v_Valide           VARCHAR2,
                                   v_PYM              varchar2,
                                   v_WBM              varchar2,
                                   v_UsingPicSign     varchar2,
                                   v_UsingCheckDoc    varchar2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from COMMONNOTE
     where COMMONNOTE.Commonnoteflow = v_CommonNoteFlow;
    IF v_count <= 0 THEN
      insert into COMMONNOTE
      values
        (v_CommonNoteFlow,
         v_CommonNoteName,
         v_PrinteModelName,
         v_ShowType,
         v_CreateDoctorID,
         v_CreateDoctorName,
         to_char(sysdate, 'yyyyMMddhh24Miss'),
         v_UsingFlag,
         '1',
         v_PYM,
         v_WBM,
         v_UsingPicSign,
         v_UsingCheckDoc);
    ELSE
      update COMMONNOTE cn
         set cn.commonnotename  = v_CommonNoteName,
             cn.printemodelname = v_PrinteModelName,
             cn.showtype        = v_ShowType,
             cn.usingflag       = v_UsingFlag,
             cn.valide          = v_Valide,
             cn.pym             = v_PYM,
             cn.wbm             = v_WBM,
             cn.usingpicsign    = v_UsingPicSign,
             cn.usingcheckdoc   = v_UsingCheckDoc
       where cn.COMMONNOTEFLOW = v_CommonNoteFlow;
    end if;
  END;

  --插入或修改通用单标签
  PROCEDURE usp_AddOrModCommonNote_Tab(v_CommonNote_Tab_Flow VARCHAR2,
                                       v_CommonNoteFlow      VARCHAR2,
                                       v_CommonNoteTabName   VARCHAR2,
                                       v_UsingRole           VARCHAR2,
                                       v_ShowType            VARCHAR2,
                                       v_OrderCode           VARCHAR2,
                                       v_CreateDoctorID      VARCHAR2,
                                       v_CreateDoctorName    VARCHAR2,
                                       v_Valide              VARCHAR2,
                                       v_RowMax              VARCHAR2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from COMMONNOTE_TAB
     where COMMONNOTE_TAB.CommonNote_Tab_Flow = v_CommonNote_Tab_Flow;
    if v_count <= 0 then
      insert into COMMONNOTE_TAB
        (commonnote_tab_flow,
         commonnoteflow,
         commonnotetabname,
         usingrole,
         showtype,
         ordercode,
         createdoctorid,
         createdoctorname,
         createdatetime,
         valide,
         maxrows)
      values
        (v_CommonNote_Tab_Flow,
         v_CommonNoteFlow,
         v_CommonNoteTabName,
         v_UsingRole,
         v_ShowType,
         v_OrderCode,
         v_CreateDoctorID,
         v_CreateDoctorName,
         to_char(sysdate, 'yyyyMMddhh24Miss'),
         '1',
         v_RowMax);
    else
      update COMMONNOTE_TAB ctab
         set ctab.usingrole         = v_UsingRole,
             ctab.showtype          = v_ShowType,
             ctab.ordercode         = v_OrderCode,
             ctab.valide            = v_Valide,
             ctab.CommonNoteTabName = v_CommonNoteTabName,
             ctab.maxrows           = v_RowMax
       where ctab.commonnote_tab_flow = v_CommonNote_Tab_Flow;
    end if;
  END;

  --插入或修改通用单项目
  PROCEDURE usp_AddOrModCommonNote_Item(v_CommonNote_Item_Flow VARCHAR2,
                                        v_CommonNote_Tab_Flow  VARCHAR2,
                                        v_CommonNoteFlow       VARCHAR2,
                                        v_DataElementFlow      VARCHAR2,
                                        v_DataElementId        VARCHAR2,
                                        v_DataElementName      VARCHAR2,
                                        v_OrderCode            VARCHAR2,
                                        v_IsValidate           VARCHAR2,
                                        v_CreateDoctorID       VARCHAR2,
                                        v_CreateDoctorName     VARCHAR2,
                                        v_Valide               VARCHAR2,
                                        v_OtherName            varchar2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from COMMONNOTE_ITEM
     where COMMONNOTE_ITEM.CommonNote_Item_Flow = v_CommonNote_Item_Flow;
    if v_count <= 0 then
      insert into COMMONNOTE_ITEM
      values
        (v_CommonNote_Item_Flow,
         v_CommonNote_Tab_Flow,
         v_CommonNoteFlow,
         v_DataElementFlow,
         v_DataElementId,
         v_DataElementName,
         v_OrderCode,
         v_IsValidate,
         v_CreateDoctorID,
         v_CreateDoctorName,
         to_char(sysdate, 'yyyyMMddhh24Miss'),
         '1',
         v_OtherName);
    else
      update COMMONNOTE_ITEM citem
         set citem.DataElementFlow = v_DataElementFlow,
             citem.DataElementId   = v_DataElementId,
             citem.DataElementName = v_DataElementName,
             citem.OrderCode       = v_OrderCode,
             citem.IsValidate      = v_IsValidate,
             citem.Valide          = v_Valide,
             citem.othername       = v_OtherName
       where citem.CommonNote_Item_Flow = v_CommonNote_Item_Flow;
    end if;
  END;

  --插入或修改通用单项关联
  PROCEDURE usp_AddOrModCommonNote_Site(v_Site_Flow      VARCHAR2,
                                        v_CommonNoteFlow VARCHAR2,
                                        v_RelationType   VARCHAR2,
                                        v_Site_ID        VARCHAR2,
                                        v_Valide         VARCHAR2) AS
    sitecount integer;
  BEGIN
    select count(*)
      into sitecount
      from COMMONNOTE_SITE_REF
     where COMMONNOTE_SITE_REF.SITE_ID = v_Site_ID
       and COMMONNOTE_SITE_REF.COMMONNOTEFLOW = v_CommonNoteFlow
       and COMMONNOTE_SITE_REF.Valide = '1'
       and COMMONNOTE_SITE_REF.Relationtype = v_RelationType;
    if sitecount > 0 then
      update COMMONNOTE_SITE_REF cref
         set cref.valide = v_Valide
       where cref.site_id = v_Site_ID
         and cref.commonnoteflow = v_CommonNoteFlow;
    else
      Insert into COMMONNOTE_SITE_REF
      values
        (v_Site_Flow,
         v_CommonNoteFlow,
         v_RelationType,
         v_Site_ID,
         v_Valide);
    end if;
  END;

  --删除该通用单的所用科室
  PROCEDURE usp_DelCommonNote_Site(v_CommonNoteFlow VARCHAR2) AS
  BEGIN
    update COMMONNOTE_SITE_REF cref
       set cref.valide = '0'
     where cref.commonnoteflow = v_CommonNoteFlow;
  END;

  --获取所有科室和病区
  PROCEDURE usp_GetAllDepartAndAreas(o_result  OUT empcurtype,
                                     o_result1 OUT empcurtype) AS
  BEGIN
    open o_result for
      select de.id, de.name from department de where de.valid = '1';
    open o_result1 for
      select ward.id, ward.name from ward where ward.valid = '1';
  END;

  --获取当前科室或病区下的所有配置单据 v_type 01科室 02病区
  PROCEDURE usp_GetCommonNoteForDeptWard(v_SiteCode varchar2,
                                         v_Type     varchar2,
                                         o_result   out empcurtype) as
  begin
    open o_result for
      select *
        from commonnote cn
       where cn.commonnoteflow in
             (select comsite.commonnoteflow
                from commonnote_site_ref comsite
               where comsite.relationtype = v_Type
                 and comsite.site_id = v_SiteCode
                 and comsite.valide = '1')
         and cn.valide = '1';
  end;

  --通过配置单流水号获取病人单据
  PROCEDURE usp_GetSimInCommonNote(v_noofInpant varchar2,
                                   o_result     out empcurtype) as
  begin
    open o_result for
      select *
        from incommonnote icn
       where icn.noofinpatient = v_noofInpant
         and icn.valide = '1'
       order by icn.incommonnotename, icn.createdatetime;
  end;

  --通过配置单流水号获取病人单据 某种单据类型
  PROCEDURE usp_GetSimInCommonNoteByFlow(v_noofInpant     varchar2,
                                         v_commonnoteflow varchar2,
                                         o_result         out empcurtype) as
  begin
    open o_result for
      select *
        from incommonnote icn
       where icn.noofinpatient = v_noofInpant
         and icn.commonnoteflow = v_commonnoteflow
         and icn.valide = '1'
       order by icn.createdatetime;
  end;

  --病人配置单流水号获取通用单详细信息 根据时间
  PROCEDURE usp_GetDetailInCommonNoteByDay(v_InCommonNoteFlow     varchar2,
                                           v_incommonnote_tabflow varchar2,
                                           v_StartDate            varchar2,
                                           v_EndDate              varchar2,
                                           o_result               out empcurtype,
                                           o_result1              out empcurtype,
                                           o_result2              out empcurtype) as
  begin
    open o_result for
      select *
        from incommonnote icom
       where icom.incommonnoteflow = v_InCommonNoteFlow
         and icom.valide = '1';
    open o_result1 for
      select *
        from incommonnote_tab icomtab
       where icomtab.incommonnoteflow = v_InCommonNoteFlow
         and icomtab.valide = '1'
       order by icomtab.ordercode;

    if v_StartDate is null and v_EndDate is null then
      open o_result2 for
        select *
          from incommonnote_item_view icomitem
         where icomitem.incommonnoteflow = v_InCommonNoteFlow
           and icomitem.valide = '1'
           and icomitem.incommonnote_tab_flow = v_incommonnote_tabflow
         order by icomitem.ordercode,
                  icomitem.recorddate,
                  icomitem.recordtime;
    else
      open o_result2 for
        select *
          from incommonnote_item_view icomitem
         where icomitem.incommonnoteflow = v_InCommonNoteFlow
           and icomitem.valide = '1'
           and icomitem.incommonnote_tab_flow = v_incommonnote_tabflow
           and icomitem.recorddate >= v_StartDate
           and icomitem.recorddate <= v_EndDate
         order by icomitem.ordercode,
                  icomitem.recorddate,
                  icomitem.recordtime;
    end if;
  end;

  --病人配置单流水号获取通用单详细信息
  PROCEDURE usp_GetDetailInCommonNote(v_InCommonNoteFlow varchar2,
                                      o_result           out empcurtype,
                                      o_result1          out empcurtype,
                                      o_result2          out empcurtype) as
  begin
    open o_result for
      select *
        from incommonnote icom
       where icom.incommonnoteflow = v_InCommonNoteFlow
         and icom.valide = '1';
    open o_result1 for
      select *
        from incommonnote_tab icomtab
       where icomtab.incommonnoteflow = v_InCommonNoteFlow
         and icomtab.valide = '1'
       order by icomtab.ordercode;
    open o_result2 for
      select *
        from incommonnote_item_view icomitem
       where icomitem.valide = '1'
         and icomitem.incommonnoteflow = v_InCommonNoteFlow
         and icomitem.incommonnote_tab_flow in
             (select icomtab.incommonnote_tab_flow
                from incommonnote_tab icomtab
               where icomtab.incommonnoteflow = v_InCommonNoteFlow
                 and icomtab.valide = '1')
       order by icomitem.ordercode,
                icomitem.recorddate,
                icomitem.recordtime;
  end;

  --添加或修改病人配置单
  PROCEDURE usp_AddorModInCommon(v_InCommonNoteFlow varchar2,
                                 v_CommonNoteFlow   varchar2,
                                 v_InCommonNoteName varchar2,
                                 v_PrinteModelName  varchar2,
                                 v_NoofInpatient    varchar2,
                                 v_InPatientName    varchar2,
                                 v_CurrDepartID     varchar2,
                                 v_CurrDepartName   varchar2,
                                 v_CurrWardID       varchar2,
                                 v_CurrWardName     varchar2,
                                 v_CreateDoctorID   varchar2,
                                 v_CreateDoctorName varchar2,
                                 v_CreateDateTime   varchar2,
                                 v_Valide           varchar2,
                                 v_CheckDocId       varchar2,
                                 v_CheckDocName     varchar2) as
    i_count integer := 0;
  begin
    select count(*)
      into i_count
      from incommonnote
     where incommonnote.incommonnoteflow = v_InCommonNoteFlow;
    if i_count <= 0 then
      insert into incommonnote
      values
        (v_InCommonNoteFlow,
         v_CommonNoteFlow,
         v_InCommonNoteName,
         v_PrinteModelName,
         v_NoofInpatient,
         v_InPatientName,
         v_CurrDepartID,
         v_CurrDepartName,
         v_CurrWardID,
         v_CurrWardName,
         v_CreateDoctorID,
         v_CreateDoctorName,
         to_char(sysdate, 'yyyyMMddhh24Miss'),
         '1',
         v_CheckDocId,
         v_CheckDocName);
    else
      null;
    end if;
  end;

  --添加或修改病人配置单tab
  PROCEDURE usp_AddorModInCommonTab(v_InCommonNote_Tab_Flow varchar2,
                                    v_CommonNote_Tab_Flow   varchar2,
                                    v_InCommonNoteFlow      varchar2,
                                    v_CommonNoteTabName     varchar2,
                                    v_UsingRole             varchar2,
                                    v_ShowType              varchar2,
                                    v_OrderCode             varchar2,
                                    v_CreateDoctorID        varchar2,
                                    v_CreateDoctorName      varchar2,
                                    v_CreateDateTime        varchar2,
                                    v_Valide                varchar2) as
    i_count integer := 0;
  begin
    select count(*)
      into i_count
      from incommonnote_tab
     where incommonnote_tab.InCommonNote_Tab_Flow = v_InCommonNote_Tab_Flow;
    if i_count <= 0 then
      insert into incommonnote_tab
      values
        (v_InCommonNote_Tab_Flow,
         v_CommonNote_Tab_Flow,
         v_InCommonNoteFlow,
         v_CommonNoteTabName,
         v_UsingRole,
         v_ShowType,
         v_OrderCode,
         v_CreateDoctorID,
         v_CreateDoctorName,
         to_char(sysdate, 'yyyyMMddhh24Miss'),
         '1');
    else
      null;
    end if;
  end;

  --添加或修改病人配置单项目
  PROCEDURE usp_AddorModInCommonitem(v_InCommonNote_Item_Flow varchar2,
                                     v_InCommonNote_Tab_Flow  varchar2,
                                     v_InCommonNoteFlow       varchar2,
                                     v_CommonNote_Item_Flow   varchar2,
                                     v_CommonNote_Tab_Flow    varchar2,
                                     v_CommonNoteFlow         varchar2,
                                     v_DataElementFlow        varchar2,
                                     v_DataElementId          varchar2,
                                     v_DataElementName        varchar2,
                                     v_OtherName              varchar2,
                                     v_OrderCode              varchar2,
                                     v_IsValidate             varchar2,
                                     v_CreateDoctorID         varchar2,
                                     v_CreateDoctorName       varchar2,
                                     v_CreateDateTime         varchar2,
                                     v_Valide                 varchar2,
                                     v_ValueXml               clob,
                                     v_RecordDate             varchar2,
                                     v_RecordTime             varchar2,
                                     v_RecordDoctorId         varchar2,
                                     v_RecordDoctorName       varchar2,
                                     v_GroupFlow              varchar2) as
    i_countr   integer := 0;
    i_countcol integer := 0;
  begin
    --插入行
    select count(*)
      into i_countr
      from incommonnote_row r
     where r.rowflow = v_GroupFlow;
    if i_countr <= 0 then
      insert into incommonnote_row
        (rowflow,
         incommonnote_tab_flow,
         incommonnoteflow,
         commonnote_tab_flow,
         commonnoteflow,
         createdoctorid,
         createdoctorname,
         createdatetime,
         valide,
         recorddate,
         recordtime,
         recorddoctorid,
         recorddoctorname)
      values
        (v_GroupFlow,
         v_incommonnote_tab_flow,
         v_incommonnoteflow,
         v_commonnote_tab_flow,
         v_commonnoteflow,
         v_createdoctorid,
         v_createdoctorname,
         to_char(sysdate, 'yyyyMMddhh24Miss'),
         '1',
         v_recorddate,
         v_recordtime,
         v_recorddoctorid,
         v_recorddoctorname);
    else
      update incommonnote_row
         set valide           = v_valide,
             recorddate       = v_recorddate,
             recordtime       = v_recordtime,
             recorddoctorid   = v_recorddoctorid,
             recorddoctorname = v_recorddoctorname
       where rowflow = v_GroupFlow;
    end if;

    select count(*)
      into i_countcol
      from incommonnote_column c
     where c.incommonnote_item_flow = v_InCommonNote_Item_Flow;
    if i_countcol <= 0 then
      insert into incommonnote_column
        (incommonnote_item_flow,
         rowflow,
         valuexml,
         commonnote_item_flow,
         incommonnote_tab_flow,
         incommonnoteflow)
      values
        (v_incommonnote_item_flow,
         v_GroupFlow,
         v_valuexml,
         v_commonnote_item_flow,
         v_incommonnote_tab_flow,
         v_InCommonNoteFlow);
    else
      update incommonnote_column
         set valuexml = v_valuexml
       where incommonnote_item_flow = v_incommonnote_item_flow;
    end if;
  end;

  --添加或修改使用单据列
  PROCEDURE usp_AddInCommonType(v_CommonNote_Item_Flow  varchar2,
                                v_InCommonNote_Tab_Flow varchar2,
                                v_DataElementFlow       varchar2,
                                v_OtherName             varchar2) as
    i_count integer := 0;
  begin
    select count(*)
      into i_count
      from incommonnote_column_type i
     where i.commonnote_item_flow = v_CommonNote_Item_Flow
       and i.incommonnote_tab_flow = v_InCommonNote_Tab_Flow;
    if i_count <= 0 then
      insert into incommonnote_column_type
        (commonnote_item_flow,
         incommonnote_tab_flow,
         dataelementflow,
         othername)
      values
        (v_commonnote_item_flow,
         v_incommonnote_tab_flow,
         v_dataelementflow,
         v_othername);
    else
      null;
    end if;
  end;

  --获取病人信息 包括病人信息和所在科室信息
  PROCEDURE usp_GetInpatient(v_noofInpat varchar2, o_result out empcurtype) as

  begin
    open o_result for
      select inpatient.*,
             (select department.name
                from department
               where department.id = inpatient.outhosdept) as departname,
             (select ward.name
                from ward
               where ward.id = inpatient.outhosward) as wardname,
             (select diagnosis.name
                from diagnosis
               where diagnosis.icd = inpatient.admitdiagnosis) as diagnosisname,
             (select dictionary_detail.name
                from dictionary_detail
               where dictionary_detail.detailid = inpatient.sexid
                 and dictionary_detail.categoryid = '3') as sex
        from inpatient
       where noofinpat = v_noofInpat;
  end;

  --获取一天的单据数据
  PROCEDURE usp_GetInCommomItemDay(v_commonNoteFlow varchar2,
                                   v_date           varchar2,
                                   v_dept           varchar2,
                                   v_ward           varchar2,
                                   o_result         out empcurtype) as
  begin
    open o_result for
      select *
        from incommonnote_item_view item
       where item.incommonnoteflow in

             (select i.incommonnoteflow
                from incommonnote i
               where i.commonnoteflow = v_commonNoteFlow
                 and i.valide = '1'
                 and i.currdepartid = v_dept
                 and i.currwardid = v_ward)

         and item.incommonnote_tab_flow in

             (select tab.incommonnote_tab_flow
                from incommonnote_tab tab
               where tab.incommonnoteflow in
                     (select i.incommonnoteflow
                        from incommonnote i
                       where i.commonnoteflow = v_commonNoteFlow
                         and i.valide = '1')
                 and tab.ordercode =
                     (select min(ordercode)
                        from incommonnote_tab
                       where incommonnote_tab.incommonnoteflow in
                             (select ia.incommonnoteflow
                                from incommonnote ia
                               where ia.commonnoteflow = v_commonNoteFlow
                                 and ia.valide = '1')))
         and item.valide = '1'
         and item.recorddate = v_date;

  end;

  --根据项目获取病人信息
  PROCEDURE usp_GetInpatientSim(v_incommonnoteitemflow varchar2,
                                o_result               out empcurtype) as
  begin
    open o_result for
      select i.name, i.patid, i.outbed
        from inpatient i
       where i.noofinpat =
             (select ic.noofinpatient
                from incommonnote ic
               where ic.incommonnoteflow =
                     (select it.incommonnoteflow
                        from incommonnote_item_view it
                       where it.incommonnote_item_flow =
                             v_incommonnoteitemflow));
  end;

  --获取病人的最新一条单据
  PROCEDURE usp_GetIncommonNew(v_noofinpat      varchar2,
                               v_commonnoteflow varchar2,
                               o_result         out empcurtype) as
  begin
    open o_result for
      select *
        from (select *
                from incommonnote i
               where i.noofinpatient = v_noofinpat
                 and i.commonnoteflow = v_commonnoteflow
                 and i.valide = '1'
               order by i.createdatetime desc)
       where rownum <= 1;
  end;

  --获取某个表格中存在多少行
  PROCEDURE usp_GetIncommonTabCount(v_incommonnote_tab_flow varchar2,
                                    o_result                out empcurtype) as
  begin
    open o_result for
      select count(*)
        from incommonnote_row i
       where i.incommonnote_tab_flow = v_incommonnote_tab_flow
         and i.valide = '1';
  end;

  --获取当前病区当前科室的所有病人
  --xlb 2013-01-18
  PROCEDURE usp_GetDeptAndWardInpatient(

                                        v_outhosdept varchar,
                                        v_outhosward varchar,
                                        o_result     out empcurtype) as
  begin
    open o_result for
      select i.noofinpat,
             i.name,
             i.outbed,
             i.outhosdept,
             i.patid,
             i.outhosward
        from inpatient i
       where i.outhosdept = v_outhosdept
         and i.outhosward = v_outhosward
         and i.status in ('1500', '1501')
       order by i.outbed;
  end;

  --病人同步时，更新婴儿状态和母亲一样 与通用单据无关  xll 20130307
  PROCEDURE usp_ChangeBabyStatus as
  begin
    update inpatient chinpatient
       set chinpatient.status =
           (select binpatient.status
              from inpatient binpatient
             where binpatient.noofinpat = chinpatient.mother)
     where chinpatient.isbaby = 1
       and mother in (select binpatient.noofinpat
                        from inpatient binpatient
                       where binpatient.isbaby = 0);
  end;

  --插入或修改通用单tongji
  PROCEDURE usp_AddOrModCommonNoteCount(v_CommonNoteCountFlow VARCHAR2,
                                        v_CommonNoteFlow      VARCHAR2,
                                        v_ItemCount           VARCHAR2,
                                        v_Hour12Name          VARCHAR2,
                                        v_Hour12Time          VARCHAR2,
                                        v_Hour24Name          VARCHAR2,
                                        v_Hour24Time          VARCHAR2,
                                        v_Valide              VARCHAR2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from commonnotecount
     where commonnotecount.commonnoteflow = v_CommonNoteFlow;
    IF v_count <= 0 THEN
      insert into commonnotecount
        (commonnotecountflow,
         commonnoteflow,
         itemcount,
         hour12name,
         hour12time,
         hour24name,
         hour24time,
         valide)
      values
        (v_CommonNoteCountFlow,
         v_CommonNoteFlow,
         v_ItemCount,
         v_Hour12Name,
         v_Hour12Time,
         v_Hour24Name,
         v_Hour24Time,
         v_Valide);
    ELSE
      update commonnotecount
         set itemcount  = v_ItemCount,
             hour12name = v_Hour12Name,
             hour12time = v_Hour12Time,
             hour24name = v_Hour24Name,
             hour24time = v_Hour24Time,
             valide     = v_Valide
       where commonnoteflow = v_CommonNoteFlow;
    end if;
  END;

  --插入历史记录
  PROCEDURE usp_AddPrintHistory(v_phflow          VARCHAR2,
                                v_printrecordflow VARCHAR2,
                                v_startpage       integer,
                                v_endpage         integer,
                                v_printpages      integer,
                                v_printdocid      VARCHAR2,
                                v_printdatetime   VARCHAR2,
                                v_printtype       VARCHAR2) AS

  BEGIN
    insert into printhistorynurse
      (phflow,
       printrecordflow,
       startpage,
       endpage,
       printpages,
       printdocid,
       printdatetime,
       printtype)
    values
      (v_phflow,
       v_printrecordflow,
       v_startpage,
       v_endpage,
       v_printpages,
       v_printdocid,
       v_printdatetime,
       v_printtype);
  END;

  --插入护理单据的历史记录
  PROCEDURE usp_AddInCommHistory(v_historyflow      varchar2,
                                 v_rowflow          varchar2,
                                 v_createdoctorid   varchar2,
                                 v_createdoctorname varchar2,
                                 v_createdatetime   varchar2,
                                 v_recorddate       varchar2,
                                 v_recordtime       varchar2,
                                 v_recorddoctorid   varchar2,
                                 v_recorddoctorname varchar2,
                                 v_valide varchar2 ) AS

  BEGIN
    insert into incommonnote_rowhis
      (historyflow,
       rowflow,
       createdoctorid,
       createdoctorname,
       createdatetime,
       recorddate,
       recordtime,
       recorddoctorid,
       recorddoctorname,
       valide)
    values
      (v_historyflow,
       v_rowflow,
       v_createdoctorid,
       v_createdoctorname,
       v_createdatetime,
       v_recorddate,
       v_recordtime,
       v_recorddoctorid,
       v_recorddoctorname,
       v_valide);
  END;

  --插入护理单据的历史记录 列
  PROCEDURE usp_AddInCommColHistory(v_incommonnote_item_flow varchar2,
                                    v_hisrowflow             varchar2,
                                    v_valuexml               varchar2,
                                    v_commonnote_item_flow   varchar2,
                                    v_incommonnote_tab_flow  varchar2,
                                    v_incommonnoteflow       varchar2) AS

  BEGIN
    insert into incommonnote_columnhis
      (incommonnote_item_flow,
       hisrowflow,
       valuexml,
       commonnote_item_flow,
       incommonnote_tab_flow,
       incommonnoteflow)
    values
      (v_incommonnote_item_flow,
       v_hisrowflow,
       v_valuexml,
       v_commonnote_item_flow,
       v_incommonnote_tab_flow,
       v_incommonnoteflow);
  END;


    --病人护理单据从第几页开始打印
  PROCEDURE usp_AddOrModIncommPagefrom(v_incommonnoteflow   VARCHAR2,
                                   v_PageFrom   VARCHAR2) AS
    v_count integer;
  BEGIN
    select count(*)
      into v_count
      from incommonprintfrompage
     where incommonprintfrompage.incommonnoteflow = v_incommonnoteflow;
    IF v_count <= 0 THEN
      insert into incommonprintfrompage( incommonnoteflow,pagefrom)
      values
        (v_incommonnoteflow,v_PageFrom);
    ELSE
      update incommonprintfrompage cn
         set cn.pagefrom=v_PageFrom
       where cn.incommonnoteflow = v_incommonnoteflow;
    end if;
  END;
end EMR_CommonNote;
/

prompt
prompt Creating package body EMR_CONSULTATION
prompt ======================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emr_consultation IS

  /*********************************************************************************/
  PROCEDURE usp_getconsultationdata(v_noofinpat        NUMERIC DEFAULT '0', --首页序号
                                    v_consultapplysn   INT DEFAULT 0, --会诊序号
                                    v_typeid           NUMERIC DEFAULT 0, --类别
                                    v_param1           VARCHAR DEFAULT '', --参数1
                                    v_consulttime      VARCHAR DEFAULT '',
                                    v_consulttypeid    INT DEFAULT 0,
                                    v_urgencytypeid    INT DEFAULT 0,
                                    v_name             VARCHAR DEFAULT '',
                                    v_patid            VARCHAR DEFAULT '',
                                    v_bedid            VARCHAR DEFAULT '',
                                    v_consulttimebegin VARCHAR DEFAULT '',
                                    v_consulttimeend   VARCHAR DEFAULT '',
                                    v_deptid           VARCHAR DEFAULT '',
                                    o_result           OUT empcurtyp,
                                    o_result1          OUT empcurtyp,
                                    o_result2          OUT empcurtyp) AS
    v_sql            VARCHAR(8000);
    v_where          VARCHAR(1000);
    v_consulttime_in VARCHAR(24);
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;

    OPEN o_result1 FOR
      SELECT '' FROM DUAL;

    OPEN o_result2 FOR
      SELECT '' FROM DUAL;

    v_consulttime_in := REPLACE(v_consulttime, '/', '-');

    IF v_typeid = '1' THEN
      --医院列表
      OPEN o_result FOR
        SELECT hi.ID AS ID, hi.NAME AS NAME
          FROM hospitalinfo hi
         ORDER BY hi.ID;
    END IF;

    IF v_typeid = '2' THEN
      --部门列表，需要根据医院来判断
      OPEN o_result FOR
        /*SELECT DISTINCT d.ID AS ID, d.NAME, d.py, d.wb
          FROM department d, dept2ward dw
         WHERE d.valid = '1'
           AND d.ID = dw.deptid*/---中心医院需求 edit by ywk
             select * from department  where sort in('101','102','104','105') and valid='1'
           AND hosno = v_param1
         ORDER BY  ID;
    END IF;

    IF v_typeid = '3' THEN
      --医生列表，需要根据部门来判断
      OPEN o_result FOR
        SELECT u.ID, u.NAME, u.py, u.wb
          FROM users u
         WHERE u.deptid = v_param1
           AND u.valid = '1'
         ORDER BY u.ID;
    END IF;

    IF v_typeid = '4' THEN
      --申请医师列表，需要根据当前病区来判断
      OPEN o_result FOR
        SELECT u.ID, u.NAME, u.py, u.wb
          FROM users u
         WHERE (u.wardid IS NOT NULL or u.wardid != '')
           AND u.WardID = v_Param1
           and u.valid = '1'
         ORDER BY u.ID;
    END IF;

    IF v_typeid = '5' THEN
      --申请医师科主任列表
      OPEN o_result FOR
        SELECT *
          FROM users u
         WHERE (u.wardid IS NOT NULL or u.wardid != '')
           AND /*u.WardID = v_Param1 and*/
               u.valid = '1'
           AND u.grade = '2000'
         ORDER BY u.ID;
    END IF;

    IF v_typeid = '6' THEN
      --根据类别从CategoryDetail表中捞取数据
      OPEN o_result FOR
        SELECT cd.ID, cd.NAME, cd.py, cd.wb
          FROM categorydetail cd
         WHERE cd.categoryid = v_param1
         ORDER BY cd.categoryid;
    END IF;

    IF v_typeid = '7' THEN
      --床位,需要根据当前病区来判断
      OPEN o_result FOR
        SELECT b.ID
          FROM bed b
         WHERE b.wardid = v_param1
           AND b.valid = '1';
    END IF;

    IF v_typeid = '8' THEN
      --得到所有临床医师
      OPEN o_result FOR
        SELECT u.ID AS employeecode,
               u.NAME AS employeename,
               u.ID||'_'||u.NAME AS employeenamestr,
               u.py,
               u.wb,
               u.deptid,
               d.NAME AS deptname,
               d.ID AS deptcode
          FROM users u
          LEFT OUTER JOIN department d ON d.ID = u.deptid
                                      AND d.valid = '1'
         WHERE (u.wardid IS NOT NULL or u.wardid != '')
           AND u.valid = '1'
         ORDER BY u.deptid, u.ID;
    END IF;

    IF v_typeid = '9' THEN
      --捞取医师资质(筛掉住院医师选项) '2003'
      OPEN o_result FOR
        SELECT cd.ID, cd.NAME, cd.py, cd.wb
          FROM categorydetail cd
         WHERE cd.categoryid = v_param1
           AND cd.ID IN ('2000', '2001', '2002')
         ORDER BY cd.categoryid;
    END IF;

    IF v_typeid = '20' THEN
      --捞取会诊申请的详细信息

      --(1)ConsultApply
      OPEN o_result FOR
        SELECT ca.consultapplysn,
               ca.noofinpat,
               ca.urgencytypeid,
               cd2.NAME AS urgencytypename,
               ca.consulttypeid,
               cd1.NAME AS consulttypename,
               ca.abstract,
               ca.purpose,
               ca.applyuser,
               u1.NAME AS applyusername,
               ca.applytime,
               ca.director,
               u2.NAME AS directorname,
               ca.consulttime,
               ca.consultlocation,
               ca.stateid,
               cd3.NAME AS statusname,
               ca.consultsuggestion,
               ca.finishtime,
               ca.rejectreason,
               ca.valid,
               ca.createuser,
               ca.createtime,
               ca.audituserid,--add by xlb 2013-03-13
               u3.name as AudioName --add by xlb 2013-03-13
          FROM consultapply ca
          LEFT OUTER JOIN categorydetail cd1 ON cd1.categoryid = '65'
                                            AND cd1.ID = ca.consulttypeid
          LEFT OUTER JOIN categorydetail cd2 ON cd2.categoryid = '66'
                                            AND cd2.ID = ca.urgencytypeid
          LEFT OUTER JOIN categorydetail cd3 ON cd3.categoryid = '67'
                                            AND cd3.ID = ca.stateid
          LEFT OUTER JOIN users u1 ON u1.ID = ca.applyuser
                                  AND u1.valid = '1'
          LEFT OUTER JOIN users u2 ON u2.ID = ca.director
                                  AND u2.valid = '1'
            LEFT OUTER JOIN users u3 ON u3.ID = ca.audituserid
                                  AND u3.valid = '1'
         WHERE ca.consultapplysn = v_consultapplysn
           AND ca.valid = '1';

      --(2)ConsultApplyDepartment
      OPEN o_result1 FOR
        SELECT cad.ID,
               cad.consultapplysn,
               cad.ordervalue,
               cad.hospitalcode,
               hi.NAME AS hospitalname,
               cad.departmentcode,
               CASE
                 WHEN cad.departmentcode = '' OR cad.departmentcode IS NULL THEN
                  cad.departmentname
                 ELSE
                  d.NAME
               END departmentname,
               cad.employeecode,
               cad.employeecode EmployeeID,
               cad.employeecode||'_'||(CASE
                 WHEN cad.employeecode = '' OR cad.employeecode IS NULL THEN
                  cad.employeename
                 ELSE
                  u.NAME
               END) employeenamestr,
               (CASE
                 WHEN cad.employeecode = '' OR cad.employeecode IS NULL THEN
                  cad.employeename
                 ELSE
                  u.NAME
               END) employeename,
               cad.employeelevelid,
               cd1.NAME AS employeelevelname,
               cad.createuser,
               cad.createtime,
              /* cad.issignin,
               (case when cad.issignin='' or cad.issignin is null or cad.issignin='0' then '未签到'
               when cad.issignin='1' then '已签到' end)signname,
               '删除' AS deletebutton,
               '签到' as signin,
               cad.reachtime*/

               '删除' AS deletebutton

          FROM consultapplydepartment cad
          LEFT OUTER JOIN hospitalinfo hi ON hi.ID = cad.hospitalcode
          LEFT OUTER JOIN department d ON d.ID = cad.departmentcode
                                      AND d.valid = '1'
          LEFT OUTER JOIN users u ON u.ID = cad.employeecode
                                 AND u.valid = '1'
          LEFT OUTER JOIN categorydetail cd1 ON cd1.categoryid = '20'
                                            AND cd1.ID =
                                                cad.employeelevelid
         WHERE cad.valid = '1'
           AND cad.consultapplysn IN
               (SELECT ca.consultapplysn
                  FROM consultapply ca
                 WHERE ca.consultapplysn = v_consultapplysn
                   AND ca.valid = '1');

      --(3)ConsultRecordDepartment
      OPEN o_result2 FOR
        SELECT cad.ID,
               cad.consultapplysn,
               cad.ordervalue,
               cad.hospitalcode,
               hi.NAME AS hospitalname,
               cad.departmentcode,
               CASE
                 WHEN cad.departmentcode = '' OR cad.departmentcode IS NULL THEN
                  cad.departmentname
                 ELSE
                  d.NAME
               END departmentname,
               cad.employeecode,
               cad.employeecode EmployeeID,
               cad.employeecode||'_'||(CASE
                 WHEN cad.employeecode = '' OR cad.employeecode IS NULL THEN
                  cad.employeename
                 ELSE
                  u.NAME
               END) employeenamestr,
               (CASE
                 WHEN cad.employeecode = '' OR cad.employeecode IS NULL THEN
                  cad.employeename
                 ELSE
                  u.NAME
               END) employeename,
               cad.employeelevelid,
               cd1.NAME AS employeelevelname,
               cad.createuser,
               '删除' AS deletebutton,
                 cad.issignin,
               (case when cad.issignin='' or cad.issignin is null or cad.issignin='0' then '未签到'
               when cad.issignin='1' then '已签到' end)signname,
               '删除' AS deletebutton,
               '签到' as signin,
                  cad.reachtime,
                  cad.createtime
          FROM consultrecorddepartment cad
          LEFT OUTER JOIN hospitalinfo hi ON hi.ID = cad.hospitalcode
          LEFT OUTER JOIN department d ON d.ID = cad.departmentcode
                                      AND d.valid = '1'
          LEFT OUTER JOIN users u ON u.ID = cad.employeecode
                                 AND u.valid = '1'
          LEFT OUTER JOIN categorydetail cd1 ON cd1.categoryid = '20'
                                            AND cd1.ID =
                                                cad.employeelevelid
         WHERE cad.valid = '1'
           AND cad.consultapplysn IN
               (SELECT ca.consultapplysn
                  FROM consultapply ca
                 WHERE ca.consultapplysn = v_consultapplysn
                   AND ca.valid = '1');
    END IF;

    IF v_typeid = '21' THEN
      --捞取符合条件的会诊申请信息(用于会诊审核列表)
      --把当前科室 = 申请人所在的科室 的都捞出来
      v_where := '';

      IF LTRIM(v_consulttime_in) != '' AND
         LTRIM(v_consulttime_in) IS NOT NULL THEN
        v_where := v_where || ' and ca.ConsultTime like ''' || '%' ||
                   RTRIM(v_consulttime_in) || '%' || '''';
      END IF;

      IF v_consulttypeid != '0' THEN
        v_where := v_where || ' and ca.ConsultTypeID=' ||
                   TO_CHAR(v_consulttypeid);
      END IF;

      IF v_urgencytypeid != '0' THEN
        v_where := v_where || ' and ca.UrgencyTypeID=' ||
                   TO_CHAR(v_urgencytypeid);
      END IF;

      IF v_name IS NOT NULL THEN
        v_where := v_where || ' and inp. Name  like ''' || '%' || v_name || '%' || '''';
      END IF;

      IF v_patid IS NOT NULL THEN
        v_where := v_where || ' and inp.PatID like ''' || '%' || v_patid || '%' || '''';
      END IF;

      IF v_bedid IS NOT NULL THEN
        v_where := v_where || ' and inp.OutBed=''' || v_bedid || '''';
      END IF;

      IF LTRIM(v_consulttimebegin) IS NOT NULL THEN
        v_where := v_where ||
                   ' and to_char(to_date(ca.ConsultTime, ''yyyy-mm-dd HH24:mi:ss''), ''yyyy-mm-dd'') >= ''' ||
                   v_consulttimebegin || '''';
      END IF;

      IF LTRIM(v_consulttimeend) IS NOT NULL THEN
        v_where := v_where ||
                   ' and to_char(to_date(ca.ConsultTime, ''yyyy-mm-dd HH24:mi:ss''), ''yyyy-mm-dd'') <= ''' ||
                   v_consulttimeend || '''';
      END IF;

      v_sql := 'select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
       ca.Valid, ca.CreateUser, ca.CreateTime, d. Name  as DeptName,
       ca.audituserid
  from ConsultApply ca
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and ca.StateID = ''6720'' and u1.DeptId = ''' ||
               v_deptid || '''
  and inp. Status  in (''1500'',''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')
  ';
      v_sql := v_sql || v_where;
      --print v_sql
      v_sql := v_sql || ' order by ApplyTime ';

      --dbms_output.put_line(v_sql);
      --open o_result for select v_sql from dual;
      OPEN o_result FOR v_sql;
    END IF;

    IF v_typeid = '22' THEN
      --捞取符合条件的会诊信息（用于会诊清单）
      --(1)把当前科室 = 申请人所在的科室 的都捞出来
      --(2)把当前科室 in 受邀科室 的都捞出来
      BEGIN
        v_where := '';

        IF LTRIM(v_consulttime_in) IS NOT NULL THEN
          v_where := v_where || ' and ca.ConsultTime like ''' || '%' ||
                     RTRIM(v_consulttime_in) || '%' || '''';
        END IF;

        IF v_consulttypeid != '0' THEN
          v_where := v_where || ' and ca.ConsultTypeID=' ||
                     TO_CHAR(v_consulttypeid);
        END IF;

        IF v_urgencytypeid != '0' THEN
          v_where := v_where || ' and ca.UrgencyTypeID=' ||
                     TO_CHAR(v_urgencytypeid);
        END IF;

        IF v_name IS NOT NULL THEN
          v_where := v_where || ' and inp. Name  like ''' || '%' || v_name || '%' || '''';
        END IF;

        IF v_patid IS NOT NULL THEN
          v_where := v_where || ' and inp.PatID like ''' || '%' || v_patid || '%' || '''';
        END IF;

        IF v_bedid IS NOT NULL THEN
          v_where := v_where || ' and inp.OutBed=''' || v_bedid || '''';
        END IF;

        IF LTRIM(v_consulttimebegin) IS NOT NULL THEN
          v_where := v_where ||
                     ' and to_char(to_date(ca.ConsultTime, ''yyyy-mm-dd HH24:mi:ss''), ''yyyy-mm-dd'') >= ''' ||
                     v_consulttimebegin || '''';
        END IF;

        IF LTRIM(v_consulttimeend) IS NOT NULL THEN
          v_where := v_where ||
                     ' and to_char(to_date(ca.ConsultTime, ''yyyy-mm-dd HH24:mi:ss''), ''yyyy-mm-dd'') <= ''' ||
                     v_consulttimeend || '''';
        END IF;
        --edit by wyt 2012-12-04 新增费用状态、签到状态、签到时间、受邀医师、会诊完成时间
       v_sql := 'select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       (case ca.ISPAY when 0 then ''未付款'' when 1 then ''已付款'' else ''未付款'' end) ISPAY,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime,
       ca.RejectReason,ca.Valid, ca.CreateUser, ca.CreateTime, cap.appdept,
       cap1.appname, crp.ISSIGNIN,crp.REACHTIME,d. Name  as DeptName
  from ConsultApply ca
  left join (select consultapplysn,
  wmsys.wm_concat(case ISSIGNIN when ''1'' then ''已签到'' when ''0'' then ''未签到''  else ''未签到'' end) ISSIGNIN,
  wm_concat(REACHTIME) REACHTIME from consultrecorddepartment where VALID = 1 group by consultapplysn) crp
  on ca.CONSULTAPPLYSN = crp.CONSULTAPPLYSN
  left join (select sn, wmsys.wm_concat(deptname) appdept from
  (select distinct consultapplysn sn, DEPARTMENTNAME deptname from  consultapplydepartment where VALID = 1) GROUP BY SN)
  cap on ca.CONSULTAPPLYSN = cap.sn
  left join (select consultapplysn,wmsys.wm_concat(EMPLOYEENAME) appname from consultapplydepartment
  where VALID = 1 group by consultapplysn) cap1 on ca.CONSULTAPPLYSN = cap1.CONSULTAPPLYSN
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and (u1.DeptId = ''' || v_deptid ||
                 ''' or
  exists
  (
    select *
    from ConsultApplyDepartment cad
    where cad.ConsultApplySn = ca.ConsultApplySn and cad.DepartmentCode = ''' ||
                 v_deptid || '''
  ))
  and exists
  (
    select *
    from ConsultApplyDepartment cad
    where cad.ConsultApplySn = ca.ConsultApplySn )
  and inp. Status  in (''1500'',''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')
  ';
/*        v_sql := 'select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
       ca.Valid, ca.CreateUser, ca.CreateTime, d. Name  as DeptName
  from ConsultApply ca
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and (u1.DeptId = ''' || v_deptid ||
                 ''' or
  exists
  (
    select *
    from ConsultApplyDepartment cad
    where cad.ConsultApplySn = ca.ConsultApplySn and cad.DepartmentCode = ''' ||
                 v_deptid || '''
  ))
  and inp. Status  in (''1500'',''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')
  ';*/
        v_sql := v_sql || v_where;
        --print v_sql
        v_sql := v_sql || ' order by ConsultTime ';

        OPEN o_result FOR v_sql;
      END;
    END IF;

    IF v_typeid = '23' THEN
      --捞取符合条件的会诊信息（用于会诊记录清单）
      --对于一般会诊被邀请的科室能够看到，对于多科会诊申请会诊的科室能够看到
      BEGIN
        v_where := '';

        IF LTRIM(v_consulttime_in) IS NOT NULL THEN
          v_where := v_where || ' and ca.ConsultTime like ''' || '%' ||
                     RTRIM(v_consulttime_in) || '%' || '''';
        END IF;

        IF v_consulttypeid != '0' THEN
          v_where := v_where || ' and ca.ConsultTypeID=' ||
                     TO_CHAR(v_consulttypeid);
        END IF;

        IF v_urgencytypeid != '0' THEN
          v_where := v_where || ' and ca.UrgencyTypeID=' ||
                     TO_CHAR(v_urgencytypeid);
        END IF;

        IF v_name IS NOT NULL THEN
          v_where := v_where || ' and inp. Name  like ''' || '%' || v_name || '%' || '''';
        END IF;

        IF v_patid IS NOT NULL THEN
          v_where := v_where || ' and inp.PatID like ''' || '%' || v_patid || '%' || '''';
        END IF;

        IF v_bedid IS NOT NULL THEN
          v_where := v_where || ' and inp.OutBed=''' || v_bedid || '''';
        END IF;

        IF LTRIM(v_consulttimebegin) IS NOT NULL THEN
          v_where := v_where ||
                     ' and to_char(to_date(ca.ConsultTime, ''yyyy-mm-dd HH24:mi:ss''), ''yyyy-mm-dd'') >= ''' ||
                     v_consulttimebegin || '''';
        END IF;

        IF LTRIM(v_consulttimeend) IS NOT NULL THEN
          v_where := v_where ||
                     ' and to_char(to_date(ca.ConsultTime, ''yyyy-mm-dd HH24:mi:ss''), ''yyyy-mm-dd'') <= ''' ||
                     v_consulttimeend || '''';
        END IF;
        --edit by wyt 2012-12-04 新增费用状态、签到状态、签到时间、受邀医师、会诊完成时间
        v_sql := 'select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
       (case ca.ISPAY when 0 then ''未付款'' when 1 then ''已付款'' else ''未付款'' end) ISPAY,
       ca.Valid, ca.CreateUser, ca.CreateTime, cap.appdept,cap1.appname,
       crp.ISSIGNIN,crp.REACHTIME, d. Name  as DeptName
  from ConsultApply ca
  left join (select consultapplysn,
  wmsys.wm_concat(case ISSIGNIN when ''1'' then ''已签到'' when ''0'' then ''未签到'' else ''未签到'' end) ISSIGNIN,
  wm_concat(REACHTIME) REACHTIME from consultrecorddepartment where VALID = 1 group by consultapplysn) crp
  on ca.CONSULTAPPLYSN = crp.CONSULTAPPLYSN
  left join (select sn, wmsys.wm_concat(deptname) appdept from
  (select distinct consultapplysn sn, DEPARTMENTNAME deptname from  consultapplydepartment where VALID = 1) GROUP BY SN)
  cap on ca.CONSULTAPPLYSN = cap.sn
  left join (select consultapplysn,wmsys.wm_concat(EMPLOYEENAME) appname from consultapplydepartment
  where VALID = 1 group by consultapplysn) cap1 on ca.CONSULTAPPLYSN = cap1.CONSULTAPPLYSN
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and ca.StateID in ( ''6730'', ''6740'' ) and
    ( exists
    (
      select 1
      from ConsultApplyDepartment cad
      where cad.ConsultApplySn = ca.ConsultApplySn and cad.DepartmentCode = ''' ||
                 v_deptid || '''
    ) or ca.applydept = ''' ||
                 v_deptid || ''' )
    /*and ca.ConsultTypeID = ''6501''*/
    and inp. Status  in (''1500'',''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')
  ';
        v_sql := v_sql || v_where;
        v_sql := v_sql || ' union
  select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
       (case ca.ISPAY when 0 then ''未付款'' when 1 then ''已付款'' else ''未付款'' end) ISPAY,
       ca.Valid, ca.CreateUser, ca.CreateTime, cap.appdept,cap1.appname,
       crp.ISSIGNIN,crp.REACHTIME,d. Name  as DeptName
  from ConsultApply ca
  left join (select consultapplysn,
  wmsys.wm_concat(case ISSIGNIN when ''1'' then ''已签到'' when ''0'' then ''未签到''  else ''未签到'' end) ISSIGNIN,
  wm_concat(REACHTIME) REACHTIME from consultrecorddepartment where VALID = 1 group by consultapplysn) crp
  on ca.CONSULTAPPLYSN = crp.CONSULTAPPLYSN
  left join (select sn, wmsys.wm_concat(deptname) appdept from
  (select distinct consultapplysn sn, DEPARTMENTNAME deptname from  consultapplydepartment where VALID = 1) GROUP BY SN)
  cap on ca.CONSULTAPPLYSN = cap.sn
  left join (select consultapplysn,wmsys.wm_concat(EMPLOYEENAME) appname from consultapplydepartment
  where VALID = 1 group by consultapplysn) cap1 on ca.CONSULTAPPLYSN = cap1.CONSULTAPPLYSN
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and ca.StateID in ( ''6730'', ''6740'' )
    and u1.DeptId = ''' || v_deptid || '''
    /*and ca.ConsultTypeID = ''6502''*/
    and inp. Status  in (''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')';
/*        v_sql := 'select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
       ca.Valid, ca.CreateUser, ca.CreateTime, d. Name  as DeptName
  from ConsultApply ca
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and ca.StateID in ( ''6730'', ''6740'' ) and
    ( exists
    (
      select 1
      from ConsultApplyDepartment cad
      where cad.ConsultApplySn = ca.ConsultApplySn and cad.DepartmentCode = ''' ||
                 v_deptid || '''
    ) or ca.applydept = ''' ||
                 v_deptid || ''' )
    \*and ca.ConsultTypeID = ''6501''*\
    and inp. Status  in (''1500'',''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')
  ';
        v_sql := v_sql || v_where;
        v_sql := v_sql || ' union
  select inp. Name  as PatientName, inp.PatID, inp.OutBed,
       ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2. Name  as UrgencyTypeName,
       ca.ConsultTypeID, cd1. Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
       ca.ApplyUser, u1. Name  as ApplyUserName, ca.ApplyTime, ca.Director,
       u2. Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
       cd3. Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
       ca.Valid, ca.CreateUser, ca.CreateTime, d. Name  as DeptName
  from ConsultApply ca
  left outer join CategoryDetail cd1 on cd1.CategoryID = ''65'' and cd1.ID = ca.ConsultTypeID
  left outer join CategoryDetail cd2 on cd2.CategoryID = ''66'' and cd2.ID = ca.UrgencyTypeID
  left outer join CategoryDetail cd3 on cd3.CategoryID = ''67'' and cd3.ID = ca.StateID
  left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = ''1''
  left outer join Users u2 on u2.ID = ca.Director and u2.Valid = ''1''
  left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
  left outer join Department d on d.ID = u1.DeptId and d.Valid = ''1''
  where ca.Valid = ''1'' and ca.StateID in ( ''6730'', ''6740'' )
    and u1.DeptId = ''' || v_deptid || '''
    \*and ca.ConsultTypeID = ''6502''*\
    and inp. Status  in (''1501'',''1502'',''1504'',''1505'',''1506'',''1507'')
  ';*/
        v_sql := v_sql || v_where;
        --print v_sql
        v_sql := v_sql || ' order by ConsultTime ';

        OPEN o_result FOR v_sql;
      END;
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_InsertConsultationApply(
                                        -- Add the parameters for the stored procedure here
                                        v_typeid            INT DEFAULT 0,
                                        v_consultapplysn    INT DEFAULT 0,
                                        v_noofinpat         NUMERIC DEFAULT '0', --首页序号
                                        v_urgencytypeid     INT DEFAULT 0,
                                        v_consulttypeid     INT DEFAULT 0,
                                        v_abstract          VARCHAR DEFAULT '',
                                        v_purpose           VARCHAR DEFAULT '',
                                        v_applyuser         VARCHAR DEFAULT '',
                                        v_applytime         VARCHAR DEFAULT '',
                                        v_director          VARCHAR DEFAULT '',
                                        v_consulttime       VARCHAR DEFAULT '',
                                        v_consultlocation   VARCHAR DEFAULT '',
                                        v_stateid           INT DEFAULT 0,
                                        v_createuser        VARCHAR DEFAULT '',
                                        v_createtime        VARCHAR DEFAULT '',
                                        v_consultsuggestion VARCHAR DEFAULT '',
                                        v_finishtime        VARCHAR DEFAULT '',
                                        v_rejectreason      VARCHAR DEFAULT '',
                                       -- V_mydept            VARCHAR DEFAULT '',
                                        v_APPLYDEPT         VARCHAR DEFAULT '',
                                        V_AuditUserID       VARCHAR DEFAULT '',
                                        v_AuditLevel        VARCHAR DEFAULT '',
                                        o_result            OUT empcurtyp) AS
    --v_APPLYDEPT VARCHAR(12);
   v_ward      VARCHAR(12);
    v_bed       VARCHAR(12);
    --V_shenheuser   varchar(12);
   -- v_count integer default 0;
  BEGIN


    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    IF v_typeid = 1 THEN
      --(会诊申请界面)插入数据
      BEGIN
        -- Insert statements for procedure here
        --select inp.outhosdept applydept
         -- into v_APPLYDEPT
         -- from inpatient inp
         --where inp.noofinpat = v_noofinpat;


         /* if V_shenheuser is null then
            select parentuserid into V_shenheuser ---取上级
           from Consult_DoctorParent
          where userid=v_applyuser and valid=1;
          else
           select userid   into V_shenheuser --取科室负责人
           from Consult_DeptAutio
           where deptid=V_mydept and valid=1;
                end if;
*/
        -- v_count := 0;
        -- select count(1) into v_count from Consult_DoctorParent  where userid =v_applyuser and valid=1;
         --if v_count > 0 then
          -- select parentuserid into V_shenheuser ---取上级
          -- from Consult_DoctorParent
          --where userid=v_applyuser and valid=1;
        -- else
           --select count(1) into v_count from Consult_DeptAutio  where deptid=V_mydept and valid=1;
          -- if v_count > 0 then
           --  select nvl(userid, '')   into V_shenheuser --取科室负责人
            -- from Consult_DeptAutio
            -- where deptid=V_mydept and valid=1;
          -- end if;
        -- end if;

        select inp.outhosward
          into v_ward
         from inpatient inp
        where inp.noofinpat = v_noofinpat;

      select inp.outbed
         into v_bed
         from inpatient inp
         where inp.noofinpat = v_noofinpat;

        INSERT INTO consultapply
          (consultapplysn,
           -- this column value is auto-generated,
           noofinpat,
           urgencytypeid,
           consulttypeid,
           abstract,
           purpose,
           applyuser,
           applytime,
           director,
           consulttime,
           consultlocation,
           stateid,
           consultsuggestion,
           finishtime,
           rejectreason,
           createuser,
           createtime,
           modifieduser,
           modifiedtime,
           valid,
           canceluser,
           canceltime,
           APPLYDEPT,
           ward,
           bed,
           AuditUserID,
           auditlevel
           )
        VALUES
          (seq_consultapply_id.NEXTVAL,
           v_noofinpat,
           v_urgencytypeid,
           v_consulttypeid,
           v_abstract,
           v_purpose,
           v_applyuser,
           v_applytime,
           v_director,
           v_consulttime,
           v_consultlocation,
           v_stateid,
           v_consultsuggestion,
           '',
           v_rejectreason,
           v_createuser,
           v_createtime,
           NULL,
           NULL,
           '1',
           NULL,
           NULL,
           v_APPLYDEPT,--申请科室
           v_ward,--病区
           v_bed,--患者床号
           V_AuditUserID,
           v_AuditLevel
           );
      END;
    END IF;

    IF v_typeid = 2 THEN
      --（会诊申请界面）修改数据
      BEGIN
        UPDATE consultapply
           SET urgencytypeid   = v_urgencytypeid,
               consulttypeid   = consulttypeid,
               abstract        = v_abstract,
               purpose         = v_purpose,
               applyuser       = v_applyuser,
               applytime       = v_applytime,
               director        = v_director,
               consulttime     = v_consulttime,
               consultlocation = v_consultlocation,
               stateid         = v_stateid,
               modifieduser    = v_createuser,
               modifiedtime    = to_char(sysdate,'yyyy-mm-dd hh24:mi:ss'),
               AuditUserID     =V_AuditUserID,--add by xlb 2013-03-15
               auditlevel      =v_AuditLevel --add by xlb 2013-03-15
         WHERE consultapplysn = v_consultapplysn;

        UPDATE consultapplydepartment
           SET valid = '0'
         WHERE consultapplysn = v_consultapplysn;
      END;
    END IF;

    IF v_typeid = 3 THEN
      -- (会诊记录填写界面) 修改数据
      BEGIN
        UPDATE consultapply
           SET consultsuggestion = v_consultsuggestion,
               finishtime        = v_finishtime,
               stateid           = v_stateid
         WHERE consultapplysn = v_consultapplysn;

        UPDATE consultrecorddepartment
           SET valid = '0'
         WHERE consultapplysn = v_consultapplysn;
      END;
    END IF;

    OPEN o_result FOR
      SELECT ca.consultapplysn
        FROM consultapply ca
       WHERE ca.noofinpat = v_noofinpat
         AND ca.valid = '1'
       ORDER BY ca.consultapplysn DESC;
  END;

  /*********************************************************************************/
  PROCEDURE usp_InsertConsultationApplyD(
                                         -- Add the parameters for the stored procedure here
                                         v_consultapplysn  INT DEFAULT 0,
                                         v_ordervalue      INT DEFAULT 0,
                                         v_hospitalcode    VARCHAR DEFAULT '',
                                         v_departmentcode  VARCHAR DEFAULT '',
                                         v_departmentname  VARCHAR DEFAULT '',
                                         v_employeecode    VARCHAR DEFAULT '',
                                         v_employeename    VARCHAR DEFAULT '',
                                         v_employeelevelid VARCHAR DEFAULT '',
                                         v_createuser      VARCHAR DEFAULT '',
                                         v_createtime      VARCHAR DEFAULT '') AS
  BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    -- Insert statements for procedure here
    INSERT INTO consultapplydepartment
      (ID, -- this column value is auto-generated,
       consultapplysn,
       ordervalue,
       hospitalcode,
       departmentcode,
       departmentname,
       employeecode,
       employeename,
       employeelevelid,
       createuser,
       createtime,
       valid,
       canceluser,
       canceltime)
    VALUES
      (seq_consultapplydepartment_id.NEXTVAL,
       v_consultapplysn,
       v_ordervalue,
       v_hospitalcode,
       v_departmentcode,
       v_departmentname,
       v_employeecode,
       v_employeename,
       v_employeelevelid,
       v_createuser,
       v_createtime,
       '1',
       NULL,
       NULL);

        INSERT INTO consultrecorddepartment
      (ID, -- this column value is auto-generated,
       consultapplysn,
       ordervalue,
       hospitalcode,
       departmentcode,
       departmentname,
       employeecode,
       employeename,
       employeelevelid,
       createuser,
       createtime,
       valid,
       canceluser,
       canceltime)
    VALUES
      (seq_consultrecorddepartment_id.NEXTVAL,
       v_consultapplysn,
       v_ordervalue,
       v_hospitalcode,
       v_departmentcode,
       v_departmentname,
       v_employeecode,
       v_employeename,
       v_employeelevelid,
       v_createuser,
       v_createtime,
       '1',
       NULL,
       NULL);
  END;

  /*********************************************************************************/
  PROCEDURE usp_insertconsultationrecord(
                                         -- Add the parameters for the stored procedure here
                                         v_consultapplysn  INT DEFAULT 0,
                                         v_ordervalue      INT DEFAULT 0,
                                         v_hospitalcode    VARCHAR DEFAULT '',
                                         v_departmentcode  VARCHAR DEFAULT '',
                                         v_departmentname  VARCHAR DEFAULT '',
                                         v_employeecode    VARCHAR DEFAULT '',
                                         v_employeename    VARCHAR DEFAULT '',
                                         v_employeelevelid VARCHAR DEFAULT '',
                                         v_createuser      VARCHAR DEFAULT '',
                                         v_createtime      VARCHAR DEFAULT '') AS
  BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.

    -- Insert statements for procedure here
    INSERT INTO consultrecorddepartment
      (ID, -- this column value is auto-generated,
       consultapplysn,
       ordervalue,
       hospitalcode,
       departmentcode,
       departmentname,
       employeecode,
       employeename,
       employeelevelid,
       createuser,
       createtime,
       valid,
       canceluser,
       canceltime)
    VALUES
      (seq_consultrecorddepartment_id.NEXTVAL,
       v_consultapplysn,
       v_ordervalue,
       v_hospitalcode,
       v_departmentcode,
       v_departmentname,
       v_employeecode,
       v_employeename,
       v_employeelevelid,
       v_createuser,
       v_createtime,
       '1',
       NULL,
       NULL);
  END;

  /***************************************************************************************/
  /*会诊审核更新状态*/
  PROCEDURE usp_updateconsultationdata(v_consultapplysn INT DEFAULT 0, --会诊号
                                       v_typeid         INT DEFAULT 0,
                                       --类型
                                       v_stateid      INT DEFAULT 0, --状态
                                       v_rejectreason VARCHAR DEFAULT '' --审核意见
                                       ) AS
  BEGIN
    IF v_typeid = 1 THEN
      UPDATE consultapply
         SET stateid = v_stateid, rejectreason = v_rejectreason
       WHERE consultapplysn = v_consultapplysn
         AND valid = '1';
    END IF;
  END;

  /***************************************************************************************/
  /*根据提供的会诊申请单编号获取会诊信息*/
  PROCEDURE usp_GetConsultationBySN(v_consultapplysn INT DEFAULT 0, --会诊号
                                    o_result         OUT empcurtyp) as
  begin
    OPEN o_result FOR
      select apply.consultapplysn,
             apply.noofinpat,
             apply.urgencytypeid,
             urgencytype.name urgencytypeName,
             apply.consulttypeid,

             consulttype.name consulttypeName,
             apply.abstract,
             apply.purpose,
             apply.applydept ApplyDeptID,
             dept.name ApplyDeptName,

             apply.applyuser applyuserID,
             applyuser.name applyuserName,
             apply.applytime,
             apply.consultsuggestion,
             applydept.departmentcode ConsultDeptID,

             applydeptname.name ConsultDeptName,
             recorddept.hospitalcode,
             recorddept.departmentcode ConsultDeptID2,
             recorddeptName.Name ConsultDeptName2,
             recorddept.employeecode ConsultUserID,

             hos.name ConsultHospitalName,
             ConsultUser.Name ConsultUserName,
             apply.finishtime ConsultTime,
             apply.stateid
        from consultapply apply
        left join ConsultApplyDepartment applydept on apply.consultapplysn =
                                                      applydept.consultapplysn
                                                      and applydept.valid = 1
        left join consultrecorddepartment recordDept on recordDept.Consultapplysn =
                                                        apply.consultapplysn
                                                    and recordDept.Valid = 1
        left join categorydetail urgencytype on urgencytype.id =
                                                apply.urgencytypeid
                                            and urgencytype.categoryid = '66'
        left join categorydetail consulttype on consulttype.id =
                                                apply.consulttypeid
                                            and consulttype.categoryid = '65'
        left join department dept on apply.applydept = dept.id
        left join users applyuser on applyuser.id = apply.applyuser
        left join department applydeptname on applydeptname.id =
                                              applydept.departmentcode
        left join hospitalinfo hos on hos.id = recorddept.hospitalcode
        left join department recorddeptName on recorddeptName.Id =
                                               recorddept.departmentcode
        left join users ConsultUser on ConsultUser.Id =
                                       recorddept.employeecode
       where apply.consultapplysn = v_consultapplysn;
  end;


  PROCEDURE usp_GetMessageInfo(v_userid VARCHAR DEFAULT '',
                               o_result OUT empcurtyp) AS
  BEGIN
  OPEN o_result FOR
     SELECT id, typeid, decode(typeid, '1', '【会诊】','2','【取消会诊】', '') typename,
            '病人：' || painetname || ' ' || tcontent content
     FROM NURSE_WITHINFORMATION
     WHERE userid = v_userid AND valid = 1 AND typeid in (1, 2);
  END;



     ---用于签到数据
                                      PROCEDURE usp_GetConsultUseSign(v_consultapplysn INT DEFAULT 0, --会诊号
                                    o_result         OUT empcurtyp)as
                                   begin
              OPEN o_result FOR
            SELECT cad.ID,
               cad.consultapplysn,
               cad.ordervalue,
               cad.hospitalcode,
               hi.NAME AS hospitalname,
               cad.departmentcode,
               CASE
                 WHEN cad.departmentcode = '' OR cad.departmentcode IS NULL THEN
                  cad.departmentname
                 ELSE
                  d.NAME
               END departmentname,
               cad.employeecode,
               cad.employeecode EmployeeID,
               cad.employeecode||'_'||(CASE
                 WHEN cad.employeecode = '' OR cad.employeecode IS NULL THEN
                  cad.employeename
                 ELSE
                  u.NAME
               END) employeenamestr,
               (CASE
                 WHEN cad.employeecode = '' OR cad.employeecode IS NULL THEN
                  cad.employeename
                 ELSE
                  u.NAME
               END) employeename,
               cad.employeelevelid,
               cd1.NAME AS employeelevelname,
               cad.createuser,
               '删除' AS deletebutton,
                 nn.issignin,
               (case when nn.issignin='' or nn.issignin is null or nn.issignin='0' then '未签到'
               when nn.issignin='1' then '已签到' end)signname,
               '删除' AS deletebutton,
               '签到' as signin,
                  --cad.reachtime,
                  cad.createtime,
                  nn.reachtime
          FROM consultapplydepartment cad
          LEFT OUTER JOIN hospitalinfo hi ON hi.ID = cad.hospitalcode
          LEFT OUTER JOIN department d ON d.ID = cad.departmentcode
                                      AND d.valid = '1'
          LEFT OUTER JOIN users u ON u.ID = cad.employeecode
                                 AND u.valid = '1'
          LEFT OUTER JOIN categorydetail cd1 ON cd1.categoryid = '20'
                                            AND cd1.ID =
                                                cad.employeelevelid
         left join consultrecorddepartment nn on cad.consultapplysn=nn.consultapplysn and cad.employeecode=nn.employeecode
         WHERE cad.valid = '1'
           AND cad.consultapplysn IN
               (SELECT ca.consultapplysn
                  FROM consultapply ca
                 WHERE ca.consultapplysn = v_consultapplysn
                   AND ca.valid = '1');
                                     end;


   ----医生工作站中获得会诊信息（全部符合条件的）
 PROCEDURE usp_GetMyConsultion(v_Deptids     varchar, --部门编号
                               v_userid      varchar,--登录人编号
                                --v_seetype   varchar,--增加参数区别查询会诊信息的时间段是三天内的还是查询所有的会诊信息  add by ywk 2012年7月24日 14:59:14
                               o_result      OUT empcurtyp )as
  BEGIN


  --if v_seetype='1'then  --查询3天内
    OPEN o_result FOR
  SELECT ip.NAME AS inpatientname,
               ip.Py,ip.wb,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               ca.printconsulttime,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode     --受邀人工号
               --hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
          left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
          left outer join users aa on aa.id=hh.employeecode
         WHERE ca.valid = '1'
           and hh.departmentcode = v_Deptids
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
 and ( stateid = '6730'
    or stateid = '6770'
    or stateid = '6720'
    or stateid = '6750'
    or stateid = '6740'
    or stateid = '6741'
   and to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 3);
--end  if;

/*if v_seetype='2' then --查询所有的，不加时间限制范围
     OPEN o_result FOR
  SELECT ip.NAME AS inpatientname,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode     --受邀人工号
               --hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
          left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
          left outer join users aa on aa.id=hh.employeecode
         WHERE ca.valid = '1'
           and hh.departmentcode = v_Deptids
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
 and ( stateid = '6730'
    or stateid = '6770'
    or stateid = '6720'
    or stateid = '6750'
    or stateid = '6740'
    or stateid = '6741');
end  if;*/
  END;


  ----医生工作站中获得会诊信息（全部符合条件的）
 PROCEDURE usp_GetAllMyConsultion(v_Deptids     varchar, --部门编号
                               v_userid      varchar,--登录人编号
                                v_seetype   varchar,--增加参数区别查询会诊信息的时间段是三天内的还是查询所有的会诊信息  add by ywk 2012年7月24日 14:59:14
                               o_result      OUT empcurtyp )as
  BEGIN
    OPEN o_result FOR




   SELECT ip.NAME AS inpatientname,
               ip.Py,ip.wb,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
               ca.audituserid,
               ca.applytime,
               (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                     when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
                 ca.printconsulttime,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode   --受邀人工号
              -- hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
              left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
              left outer join users aa on aa.id=hh.employeecode
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
         WHERE ca.valid = '1'
           AND ip.status IN ('1500','1501', '1502', '1504', '1505', '1506', '1507')
       and ( stateid = '6730'
    or stateid = '6770'
   or stateid = '6720'
    or stateid = '6750'
    or stateid = '6740'
    or stateid = '6741') --and to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 3)
    /*and u.id=V_userid*/
      and ( u.id=V_userid or ca.applydept=v_Deptids )
union
SELECT ip.NAME AS inpatientname,
               ip.Py,ip.wb,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               ca.printconsulttime,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode     --受邀人工号
               --hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
          left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
          left outer join users aa on aa.id=hh.employeecode
         WHERE ca.valid = '1'
           and hh.departmentcode = v_Deptids
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
 and ( stateid = '6730'
    or stateid = '6770'
    or stateid = '6720'
    or stateid = '6750'
    or stateid = '6740'
    or stateid = '6741')
   --and to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 3)
   and (
   hh.employeecode=V_userid or (hh.employeecode is null));-- or hh.employeelevelid=u.grade));



  END;




---根据条件获取所有会诊信息（质控办医务人员专用）--add by wyt 2012-09-07
 PROCEDURE usp_GetAllConsultion(v_ApplyDeptid     varchar, --部门编号
                                v_EmployeeDeptid     varchar, --部门编号
                                v_DateTimeBegin varchar,--开始时间
                                v_DateTimeEnd varchar, --结束时间
                               o_result      OUT empcurtyp )as
                                p_beginDate VARCHAR2(19);
                                p_beginEnd   VARCHAR2(19);
  BEGIN
    p_beginDate :=v_DateTimeBegin || ' 00:00:00';--Add by xlb 2013-06-28 当天数据检索
    p_beginEnd :=v_DateTimeEnd || '23:59:59';
    OPEN o_result FOR

    select inp. Name  as INPATIENTNAME, inp.PatID as PATID, inp.OutBed BED,
               ca.ConsultApplySn CONSULTAPPLYSN, ca.NoOfInpat as NOOFINPAT, ca.UrgencyTypeID, cd2.Name as  URGENCYTYPE,
               ca.ConsultTypeID, cd1.Name as ConsultTypeName, ca.Abstract as ABSTRACT, ca.Purpose as PURPOSE,
               ca.ApplyUser as APPLYUSER, u1.Name as  APPLYUSERNAME, ca.ApplyTime APPLYTIME, ca.Director,ca.consultlocation as CONSULTLOCATION,
               u2.Name as DirectorName, ca.ConsultTime as PLANCONSULTTIME, ca.ConsultLocation, ca.StateID,
               cd3.Name  as CONSULTSTATUS, ca.ConsultSuggestion, ca.FinishTime as FINISHTIME, ca.RejectReason,
               decode(ca.ispay, '1', '已付款', '未付款') MYPAY,ca.ispay,
               ca.Valid, ca.CreateUser, ca.CreateTime, crp.DEPARTMENTNAME, crp.EMPLOYEENAME,
               crp.ISSIGNIN, crp.REACHTIME, d.Name as APPLYDEPTNAME
          from ConsultApply ca
          left join (select consultapplysn, wmsys.wm_concat(decode(ISSIGNIN, '1', '已签到', '未签到')) ISSIGNIN,
           wmsys.wm_concat(departmentname) DEPARTMENTNAME,wmsys.wm_concat(consultrecorddepartment.employeename) EMPLOYEENAME,
            wm_concat(REACHTIME) REACHTIME from consultrecorddepartment where VALID = 1
            and  (departmentcode=v_EmployeeDeptid  or v_EmployeeDeptid = '0000' or v_EmployeeDeptid= '' or v_EmployeeDeptid is null)
             group by consultapplysn) crp
                on ca.CONSULTAPPLYSN = crp.CONSULTAPPLYSN
          left outer join CategoryDetail cd1 on cd1.CategoryID = '65' and cd1.ID = ca.ConsultTypeID
          left outer join CategoryDetail cd2 on cd2.CategoryID = '66' and cd2.ID = ca.UrgencyTypeID
          left outer join CategoryDetail cd3 on cd3.CategoryID = '67' and cd3.ID = ca.StateID
          left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = '1'
          left outer join Users u2 on u2.ID = ca.Director and u2.Valid = '1'
          left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
          left outer join Department d on d.ID = u1.DeptId and d.Valid = '1'
         where (ca.applydept=v_ApplyDeptid or v_ApplyDeptid = '0000' or v_ApplyDeptid = '' or v_ApplyDeptid is null)
        and to_date(substr(nvl(trim(ca.consulttime), '1000-01-01 00:00:00'), 1, 19),
                     'yyyy-mm-dd hh24:mi:ss') > to_date(p_beginDate, 'yyyy-mm-dd hh24:mi:ss')
         and to_date(substr(nvl(trim(ca.consulttime), '9990-01-01 23:59:59'), 1, 19),
                     'yyyy-mm-dd hh24:mi:ss') < to_date(p_beginEnd, 'yyyy-mm-dd hh24:mi:ss')
            and ca.Valid = '1';

/*select A.* from (
   SELECT  distinct ip.NAME AS inpatientname,
               ip.Py,ip.wb,
               ip.patid,
                      TO_CHAR(TO_DATE(cf.reachtime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,

               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
               u.name as applyusername,
               aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
               ca.finishtime,
               dept.name applydeptname,
               ca.audituserid,
               ca.applytime,
               (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                     when ca.ispay is null then '未缴费'
                   end) MyPay,
               ca.ispay,
               to_char(to_date(ca.consulttime,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi')  planconsulttime,
               ca.consultapplysn,
               ca.bed,
               ca.consultlocation,
               ca.abstract,
               ca.purpose,
               hh.departmentcode,  --受邀科室
               hh.departmentname,--受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode,   --受邀人工号
               (case
                    when hh.employeename = '' or hh.employeename is null then
                    '-'
                    else hh.employeename
                end) employeename,
                  cf.reachtime
                --hh.employeename
                    --受邀人名称
              -- hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
            AND u.valid = 1
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
           left join department dept
           on dept.id = ca.applydept
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
              left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'

            left join consultrecorddepartment cf on cf.consultapplysn=ca.consultapplysn and cf.valid='1'


              left outer join users aa on aa.id=hh.employeecode
              and aa.valid = 1
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid

         WHERE ca.valid = '1'
         and to_date(substr(nvl(trim(ca.consulttime), '1000-01-01 00:00:00'), 1, 19),
                     'yyyy-mm-dd hh24:mi:ss') > to_date(p_beginDate, 'yyyy-mm-dd hh24:mi:ss')
         and to_date(substr(nvl(trim(ca.consulttime), '9990-01-01 23:59:59'), 1, 19),
                     'yyyy-mm-dd hh24:mi:ss') < to_date(p_beginEnd, 'yyyy-mm-dd hh24:mi:ss')
         --and TO_DATE(substr(ca.consulttime,1,10),'yyyy-mm-dd')
           AND ip.status IN ('1500','1501', '1503','1502', '1504', '1505', '1506', '1507')
       and (ca.applydept=v_ApplyDeptid or v_ApplyDeptid = '0000' or v_ApplyDeptid = '' or v_ApplyDeptid is null)
       and (hh.departmentcode=v_EmployeeDeptid or v_EmployeeDeptid = '0000' or v_EmployeeDeptid = '' or v_EmployeeDeptid is null)
       )A WHERE A.DEPARTMENTCODE is not null;---add by ywk 其实受邀科室为空的是不会出现，应该是脏数据
      */
  END;




 ----医生工作站中获得会诊信息（全部符合条件的）  by tj
PROCEDURE usp_GetConsultionDoctor(v_Deptids varchar, --部门编号
                                  v_userid  varchar, --登录人ID
                                  v_levelid varchar, ---登录人级别
                                  o_result  OUT empcurtyp) as
BEGIN
  OPEN o_result FOR
    --Modify by wwj 2013-02-17
  SELECT distinct ip.NAME AS inpatientname,
                    ca.consulttime,
                    ca.consulttypeid,
                    ca.applyuser,
                    cd.NAME AS consultstatus,
                    cd1.NAME AS urgencytype,
                    ca.stateid,
                    ca.noofinpat,
                    ca.consultapplysn,
                    ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
                    ca.ispassed
      FROM consultapply ca
      LEFT OUTER JOIN inpatient ip
        ON ip.noofinpat = ca.noofinpat
      LEFT OUTER JOIN categorydetail cd
        ON cd.categoryid = '67'
       AND ca.stateid = cd.ID --会诊单状态
      LEFT OUTER JOIN categorydetail cd1
        ON cd1.categoryid = '66'
       AND cd1.ID = ca.urgencytypeid --紧急度
      LEFT OUTER JOIN consultrecorddepartment hh
        ON ca.consultapplysn = hh.consultapplysn
       AND hh.valid = '1'
     WHERE ((ca.stateid in ('6710','6750','6780') AND ca.applyuser = v_userid) --会诊申请保存,被否决,撤销的会诊记录  只有申请人可见
           OR (ca.stateid = '6720'
              AND (ca.applyuser = v_userid OR (ca.audituserid is not null AND ca.audituserid = v_userid))) --待审核  只有申请人、审核人可以看到
           OR (ca.stateid = '6720'
              AND (ca.applyuser = v_userid OR (ca.audituserid is null AND ca.AUDITLEVEL = v_levelid AND ca.applydept = v_Deptids))) --待审核  只有申请人、审核人可以看到
           OR (ca.stateid in ('6730', '6740') AND hh.employeecode is null
              AND (ca.applyuser = v_userid or (hh.employeelevelid = v_levelid AND hh.departmentcode = v_Deptids))) --待会诊、会诊记录保存 只有参加会诊的医师可以看到此记录
           OR (ca.stateid in ('6730', '6740') AND hh.employeecode is not null
              AND (ca.applyuser = v_userid or hh.employeecode = v_userid))
           OR (ca.stateid = '6741'
              AND (ca.applyuser = v_userid or hh.employeecode = v_userid))
              AND ca.modifiedtime IS NOT NULL AND trunc(to_date(ca.modifiedtime, 'yyyy-mm-dd hh24:mi:ss')) BETWEEN trunc(sysdate - 3) AND trunc(sysdate))
       AND ca.valid = '1'
       and (ca.ispay is null or ca.ispay<>'1')--过滤已缴费的记录Modify by xlb 2013-06-06
       --排除会诊意见填写完毕的记录
       AND NOT EXISTS(
           SELECT 1 FROM consultsuggestion
           WHERE consultsuggestion.consultapplysn = ca.consultapplysn and consultsuggestion.valid = '1'
           and consultsuggestion.createuser = v_userid and consultsuggestion.state = 20
       )
        and not exists (select 1 from consultrecorddepartment conred where conred.consultapplysn=ca.consultapplysn and conred.valid='1'
     and ((conred.issignin is null or conred.issignin<>'1') and
     to_date(ca.consulttime,'yyyy-mm-dd hh24:mi:ss') < (sysdate-7)--只显示会诊时间七天内没签到 Add by xlb 2013-06-07
    ))
    --排除掉超过7天未签到的记录 项令波 2013-06-20
     /*and  exists (select 1 from consultrecorddepartment conred where conred.consultapplysn=ca.consultapplysn and conred.valid='1'
     and (((conred.issignin is null or conred.issignin<>'1') and
      trunc(to_date(ca.consulttime,'yyyy-mm-dd hh24:mi:ss')) between trunc(sysdate-7)--只显示会诊时间七天内没签到 Add by xlb 2013-06-07
     and trunc(sysdate)) or (conred.issignin='1')--或者已签到 Add by xlb 2013-06-07   应该按照会诊时间来计算 比如提前很多天申请了多天后的会诊
    ))*/
      ORDER BY ca.consulttime desc;
   /*SELECT ip.NAME AS inpatientname,

               ip.py,ip.wb,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
               ca.audituserid,
               ca.applytime,
               (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                     when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode,   --受邀人工号
              -- hh.issignin         --是否签到
                ip.outhosdept,
                ip.outhosward
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
              left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1' and hh.employeelevelid=v_levelid
              left outer join users aa on aa.id=hh.employeecode
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
         WHERE ca.valid = '1'
           AND ip.status IN ('1500','1501', '1502', '1504', '1505', '1506', '1507')
       and ( stateid = '6730'
    or stateid = '6770'
    or stateid = '6720'
    or stateid = '6750'
    or stateid = '6740'
    or stateid = '6741' and to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 7)
    --and u.id=V_userid
      and ( u.id=v_userid or ca.applydept=v_Deptids )
union
SELECT ip.NAME AS inpatientname,

               ip.py,ip.wb,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode ,    --受邀人工号
               --hh.issignin         --是否签到
                ip.outhosdept,
                ip.outhosward
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
          left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'  and hh.employeelevelid=v_levelid
          left outer join users aa on aa.id=hh.employeecode
         WHERE ca.valid = '1'
           and hh.departmentcode = v_Deptids
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
 and ( stateid = '6730'
    or stateid = '6770'
    or stateid = '6720'
    or stateid = '6750'
    or stateid = '6740'
    or stateid = '6741'
   and to_date(finishtime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 7)
   and (
   hh.employeecode=v_userid or (hh.employeecode is null));*/
/*SELECT distinct(ca.noofinpat),ip.NAME AS inpatientname,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               --ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               hh.departmentcode,  --受邀科室
               hh.employeelevelid, --受邀人级别
               hh.employeecode   --受邀人工号
               --hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
          left outer JOIN consultapplydepartment hh
            on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
          left outer join users aa on aa.id=hh.employeecode
         WHERE ca.valid = '1'
          and hh.departmentcode = v_Deptids and hh.employeecode=v_userid
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
 and (stateid = '6770'
    or stateid = '6730'
    or stateid = '6740'
    or stateid = '6741')
      and to_date(ca.applytime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 7 ;*/

  END;

  ----护士工作站中获得会诊信息 tj
   PROCEDURE usp_GetConsultionNurse(
   v_Deptids     varchar, --部门编号
 o_result    OUT empcurtyp
)as
  BEGIN
  OPEN o_result FOR
SELECT distinct(ca.noofinpat),ip.NAME AS inpatientname,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid as stateid,
                 u.name as applyusername,
               --ca.noofinpat,
               ca.modifieduser,
               ca.printconsulttime,--打印时间
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               ip.outhosdept,
               ip.outhosward
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN consultapplydepartment sy --会诊受邀表
          on sy.consultapplysn=ca.consultapplysn
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
         WHERE ca.valid = '1'
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
           and  (ca.stateid = '6730' or ca.stateid='6740' or   ca.stateid='6741')
           and (ca.applydept=v_Deptids or sy.departmentcode=v_Deptids)
           and (ca.ispay = '1' or ca.ispay = '0'or ca.ispay is null)
           and to_date(ca.applytime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 7
           order  by stateid, TO_DATE(consulttime, 'yyyy-mm-dd hh24:mi:ss') desc
           --order  by  outhosdept,outhosward

           ;
  END;

   ----会诊提醒信息   by tj
   PROCEDURE usp_GetConsultionMessage(
   v_Deptids     varchar, --部门编号
   v_levelid varchar,---登录人级别
 o_result    OUT empcurtyp
)as
  BEGIN
  OPEN o_result FOR
SELECT distinct(ca.noofinpat),ip.NAME AS inpatientname,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
                 u.name as applyusername,
                 aa.name as shouyaoren,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
                ca.audituserid,
                 ca.applytime,
                  (case
                    when ca.ispay = '1' then
                    '已缴费'
                    when ca.ispay = '0' then
                    '未缴费'
                    when ca.ispay is null then '未缴费'
                   end) MyPay,
                   ca.ispay,
               ca.consultapplysn,
               hr.departmentcode,  --受邀科室
               hr.employeelevelid, --受邀人级别
               hr.employeecode   --受邀人工号
               --hh.issignin         --是否签到
          FROM consultapply ca
          LEFT OUTER JOIN users u
            ON u.ID = ca.applyuser
           AND u.valid = '1'
          LEFT OUTER JOIN inpatient ip
            ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd
            ON cd.categoryid = '67'
           AND ca.stateid = cd.ID
          LEFT OUTER JOIN categorydetail cd1
            ON cd1.categoryid = '66'
           AND cd1.ID = ca.urgencytypeid
          --left outer JOIN consultapplydepartment hh --会诊受邀表
           -- on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
          left outer JOIN CONSULTRECORDDEPARTMENT hr --会诊记录表
            on ca.consultapplysn = hr.consultapplysn AND hr.valid = '1'  --and hr.employeelevelid=v_levelid
          left outer join users aa on aa.id=hr.employeecode
         WHERE ca.valid = '1'
           AND ip.status IN ('1500', '1501', '1502', '1504', '1505', '1506', '1507')
 and (
       (stateid = '6730' and ( hr.issignin='0' or hr.issignin='' or hr.issignin is null))
    or (stateid = '6770' and ( hr.issignin='0' or hr.issignin='' or hr.issignin is null))
    or (stateid = '6720' and ( hr.issignin='0' or hr.issignin='' or hr.issignin is null))
    or (stateid = '6750' and ( hr.issignin='0' or hr.issignin='' or hr.issignin is null))
   -- or (stateid = '6740' and ( hr.issignin='0' or hr.issignin='' or hr.issignin is null))
   -- or (stateid = '6741' and ( hr.issignin='0' or hr.issignin='' or hr.issignin is null))
    )
--edit by xlb 2013-03-15 没抓取会诊记录保存或完成状态 完成时间可为空
   and to_date(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss') > trunc(sysdate) - 3 --三天前的会诊不显示
   and (hr.departmentcode =v_Deptids  or ca.applydept=v_Deptids)--or  hr.departmentcode is null这句话有问题edit by ywk 2013年8月30日 14:09:35
   and (hr.issignin='0' or hr.issignin='' or hr.issignin is null or hr.employeelevelid=v_levelid)---edit by ywk 2013年8月30日 14:39:02
   order  by TO_DATE(consulttime, 'yyyy-mm-dd hh24:mi:ss') desc
   ;-- or hh.employeelevelid=u.grade));

  END;


   --Add by wwj 2013-02-18 护士工作站的会诊数据捞取
   PROCEDURE usp_GetConsultionForNurse(v_Deptids varchar,      --部门编号
                                       v_ConsultDateFrom date, --会诊日期
                                       v_ConsultDateTo date,   --会诊日期
                                       v_ConsultState varchar, --会诊状态
                                       o_result OUT empcurtyp
   ) AS
   BEGIN
   OPEN o_result FOR
        SELECT distinct ca.noofinpat,
                ip.NAME AS inpatientname,
                TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                        'yyyy-mm-dd hh24:mi:ss') AS consulttime,
                cd.NAME AS consultstatus,
                cd1.NAME AS urgencytype,
                ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
                ca.stateid as stateid,
                u.name as applyusername,
                ca.modifieduser,
                ca.printconsulttime, --打印时间
                ca.finishtime,
                ca.consulttypeid,
                ca.applyuser,
                ca.applydept,
                ca.audituserid,
                ca.applytime,
                decode(ca.ispay, '1', '已缴费', '未缴费') MyPay,
                ca.ispay,
                ca.consultapplysn,
                ip.outhosdept,
                ip.outhosward
        FROM consultapply ca
            LEFT OUTER JOIN users u ON u.ID = ca.applyuser AND u.valid = '1'
            LEFT OUTER JOIN inpatient ip ON ip.noofinpat = ca.noofinpat
           inner JOIN consultrecorddepartment sy on sy.consultapplysn = ca.consultapplysn--修改 ywk 受邀科室为空过滤
            LEFT OUTER JOIN categorydetail cd ON cd.categoryid = '67' AND ca.stateid = cd.ID
            LEFT OUTER JOIN categorydetail cd1 ON cd1.categoryid = '66' AND cd1.ID = ca.urgencytypeid
        WHERE ca.valid = '1'
            and (v_ConsultState is null or v_ConsultState=''  AND ca.stateid IN (6730,6740,6741) --抓取会诊记录完成、待会诊、会诊记录保存三状态
                OR
                (v_ConsultState is not null AND ca.stateid = v_ConsultState)
            ) --待会诊、会诊记录保存、会诊记录完成
            and (ca.applydept = v_Deptids OR sy.departmentcode = v_Deptids)
            and to_date(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss') >= v_ConsultDateFrom
            and to_date(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss') < (v_ConsultDateTo + 1)
        ORDER BY TO_DATE(consulttime, 'yyyy-mm-dd hh24:mi:ss') desc;
 END;



 ----获得已会诊未缴费的记录 Add by wwj 2013-02-19
 PROCEDURE usp_GetAlreadyConsultNotFee(v_Deptids varchar, --部门编号
                                  o_result  OUT empcurtyp)as
  BEGIN
    OPEN o_result FOR
        SELECT distinct ip.NAME AS inpatientname,
               ip.Py,ip.wb,
               TO_CHAR(TO_DATE(ca.consulttime, 'yyyy-mm-dd hh24:mi:ss'),
                       'yyyy-mm-dd hh24:mi:ss') AS consulttime,
               cd.NAME AS consultstatus,
               cd1.NAME AS urgencytype,
               ip.NAME || '_' || cd1.NAME || '_' || ca.consulttime AS inpatientinfo,
               ca.stateid,
               u.name as applyusername,
               ca.noofinpat,
               ca.modifieduser,
               ca.finishtime,
               ca.consulttypeid,
               ca.applyuser,
               ca.applydept,
               ca.audituserid,
               ca.applytime,
               decode(ca.ispay, '1', '已缴费', '未缴费') MyPay,
               ca.ispay,
               ca.consultapplysn,
               ca.printconsulttime
          FROM consultapply ca
          LEFT OUTER JOIN users u ON u.ID = ca.applyuser
          LEFT OUTER JOIN inpatient ip ON ip.noofinpat = ca.noofinpat
          LEFT OUTER JOIN categorydetail cd ON cd.categoryid = '67' AND ca.stateid = cd.ID
          LEFT OUTER JOIN consultrecorddepartment hh on ca.consultapplysn = hh.consultapplysn AND hh.valid = '1'
          LEFT OUTER join users aa on aa.id=hh.employeecode
          LEFT OUTER JOIN categorydetail cd1 ON cd1.categoryid = '66' AND cd1.ID = ca.urgencytypeid
         WHERE ca.valid = '1' and (ca.applydept = v_Deptids OR hh.departmentcode = v_Deptids)
           and ca.stateid in (6740, 6741) and (ca.ispay <> '1' or ca.ispay is null);
  END;

  --会诊费用测试
  PROCEDURE usp_FeeTest(arg_inp varchar,
                        arg_name varchar,
                        arg_item varchar,
                        arg_itemname varchar,
                        arg_amount number,
                        arg_doct varchar,
                        arg_doctdept varchar,
                        arg_date date,
                        arg_dept varchar,
                        arg_hzdoct varchar,
                        arg_opercode varchar,
                        arg_operdate date,
                        return_code out number,
                        return_result out varchar)as
  BEGIN
    return_code := 1;
    return_result := '操作正确！';
  END;

  --获取待审核的会诊记录 Add by wwj 2013-02-27
  PROCEDURE usp_GetUnAuditConsult(v_timefrom date, --会诊起始时间
                                  v_timeto date,   --会诊终止时间
                                  v_inpatientname varchar, --病人姓名
                                  v_patid  varchar, --病历号
                                  v_urgencyTypeID varchar, --紧急度
                                  v_currentuserid varchar, --当前系统登录人
                                  v_currentuserlevel varchar, --当前用户级别
                                  o_result OUT empcurtyp)as
  BEGIN
    OPEN o_result FOR
        select inp.Name  as PatientName, inp.PatID, inp.OutBed,
             ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2.Name  as UrgencyTypeName,
             ca.ConsultTypeID, cd1.Name  as ConsultTypeName, ca.Abstract, ca.Purpose,
             ca.ApplyUser, u1.Name  as ApplyUserName, ca.ApplyTime, ca.Director,
             u2.Name  as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
             cd3.Name  as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
             ca.Valid, ca.CreateUser, ca.CreateTime, d.Name  as DeptName,
             ca.audituserid
        from ConsultApply ca
            left outer join CategoryDetail cd1 on cd1.CategoryID = '65' and cd1.ID = ca.ConsultTypeID
            left outer join CategoryDetail cd2 on cd2.CategoryID = '66' and cd2.ID = ca.UrgencyTypeID
            left outer join CategoryDetail cd3 on cd3.CategoryID = '67' and cd3.ID = ca.StateID
            left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = '1'
            left outer join Users u2 on u2.ID = ca.Director and u2.Valid = '1'
            left outer join Inpatient inp on inp.NoOfInpat = ca.NoOfInpat
            left outer join Department d on d.ID = u1.DeptId and d.Valid = '1'
        where to_date(ca.consulttime, 'yyyy-MM-dd hh24:mi:ss') between v_timefrom and (v_timeto + 1)
          and inp.name like '%' || v_inpatientname || '%'
          and inp.PatID like '%' || v_patid || '%'
          and ca.UrgencyTypeID like '%' || v_urgencyTypeID || '%'
          and ca.valid = 1
          and ca.stateid = '6720' --待审核
          and ((ca.audituserid is not null and ca.audituserid = v_currentuserid)
                or (ca.audituserid is null and ca.auditlevel = v_currentuserlevel));
  END;

  --获取与系统登录人相关的待会诊、会诊记录保存的记录 Add by wwj 2013-02-27
  PROCEDURE usp_GetWaitConsult(v_timefrom date, --会诊起始时间
                               v_timeto date,   --会诊终止时间
                               v_inpatientname varchar, --病人姓名
                               v_patid  varchar, --病历号
                               v_urgencyTypeID varchar, --紧急度
                               v_bedCode varchar, --床位号
                               v_currentuserid varchar, --当前系统登录人
                               v_currentuserlevel varchar, --当前用户级别
                               o_result OUT empcurtyp)as
  BEGIN
    OPEN o_result FOR
        --获取与登录人相关的会诊记录(待会诊、会诊记录保存)
              select inp. Name  as PatientName, inp.PatID, inp.OutBed,
               ca.ConsultApplySn, ca.NoOfInpat, ca.UrgencyTypeID, cd2.Name as UrgencyTypeName,
               ca.ConsultTypeID, cd1.Name as ConsultTypeName, ca.Abstract, ca.Purpose,
               ca.ApplyUser, u1.Name as ApplyUserName, ca.ApplyTime, ca.Director,
               u2.Name as DirectorName, ca.ConsultTime, ca.ConsultLocation, ca.StateID,
               cd3.Name as StatusName, ca.ConsultSuggestion, ca.FinishTime, ca.RejectReason,
               decode(ca.ispay, '1', '已付款', '未付款') ISPAY,
               ca.Valid, ca.CreateUser, ca.CreateTime, crp.appdept, crp.appname,
               crp.ISSIGNIN, crp.REACHTIME, d.Name as DeptName
          from ConsultApply ca
          left join (select consultapplysn, wmsys.wm_concat(decode(ISSIGNIN, '1', '已签到', '未签到')) ISSIGNIN, wmsys.wm_concat(departmentname) appdept,wmsys.wm_concat(consultrecorddepartment.employeename) appname, wm_concat(REACHTIME) REACHTIME from consultrecorddepartment where VALID = 1 group by consultapplysn) crp
                on ca.CONSULTAPPLYSN = crp.CONSULTAPPLYSN
          left outer join CategoryDetail cd1 on cd1.CategoryID = '65' and cd1.ID = ca.ConsultTypeID
          left outer join CategoryDetail cd2 on cd2.CategoryID = '66' and cd2.ID = ca.UrgencyTypeID
          left outer join CategoryDetail cd3 on cd3.CategoryID = '67' and cd3.ID = ca.StateID
          left outer join Users u1 on u1.ID = ca.ApplyUser and u1.Valid = '1'
          left outer join Users u2 on u2.ID = ca.Director and u2.Valid = '1'
          left outer join InPatient inp on inp.NoOfInpat = ca.NoOfInpat
          left outer join Department d on d.ID = u1.DeptId and d.Valid = '1'
         where ca.StateID in ( '6730', '6740' )
            and (exists(select 1 from consultrecorddepartment cd where ((cd.employeecode is not null and cd.employeecode = v_currentuserid) or (cd.employeecode is null and cd.employeelevelid = v_currentuserlevel)) or ca.applyuser =v_currentuserid) )
            and inp.name like '%' || v_inpatientname || '%'
            and inp.patid like '%' || v_patid || '%'
            and ca.urgencytypeid like '%' || v_urgencytypeid || '%'
            and (inp.outbed like '%' || v_bedcode || '%' or inp.outbed is null)
            and to_date(ca.applytime, 'yyyy-MM-dd hh24:mi:ss') between v_timefrom and (v_timeto + 1)
            and ca.Valid = '1';
  END;
  --add by xlb 2013-03-08
 PROCEDURE usp_SaveConsultRecord(
                                         v_TypeID          INT DEFAULT 0,
                                         v_ConsultId              INT DEFAULT 0,
                                         v_consultapplysn  INT DEFAULT 0,
                                         v_ordervalue      INT DEFAULT 0,
                                         v_hospitalcode    VARCHAR DEFAULT '',
                                         v_departmentcode  VARCHAR DEFAULT '',
                                         v_departmentname  VARCHAR DEFAULT '',
                                         v_employeecode    VARCHAR DEFAULT '',
                                         v_employeename    VARCHAR DEFAULT '',
                                         v_employeelevelid VARCHAR DEFAULT '',
                                         v_createuser      VARCHAR DEFAULT '',
                                         v_createtime      VARCHAR DEFAULT '',
                                         v_canceluser      VARCHAR DEFAULT '',
                                         v_modifyuser      VARCHAR DEFAULT '') AS


BEGIN

  --1表示删除的会诊邀请部分记录
  IF v_TypeID=1 THEN
    BEGIN
      update consultrecorddepartment set valid='0',
      canceluser=v_canceluser,canceltime=sysdate where id=v_ConsultId;
     END;
     END IF;
--2表示修改记录
IF v_TypeID=2 THEN
  BEGIN
    UPDATE consultrecorddepartment c set c.departmentcode=v_departmentcode,
    c.departmentname=v_departmentname,c.employeecode=v_employeecode,c.employeename=v_employeename,
    c.employeelevelid=v_employeelevelid,c.modifyuser=v_modifyuser,c.modifytime=sysdate where id=v_ConsultId;
   END;
   END IF;
   --3表示插入记录
  IF v_TypeID=3 THEN
    BEGIN
       INSERT INTO consultrecorddepartment
       (ID,
       consultapplysn,
       ordervalue,
       hospitalcode,
       departmentcode,
       departmentname,
       employeecode,
       employeename,
       employeelevelid,
       createuser,
       createtime,
       valid,
       canceluser,
       canceltime)
    VALUES
      (seq_consultrecorddepartment_id.NEXTVAL,
       v_consultapplysn,
       v_ordervalue,
       v_hospitalcode,
       v_departmentcode,
       v_departmentname,
       v_employeecode,
       v_employeename,
       v_employeelevelid,
       v_createuser,
       v_createtime,
       '1',
       NULL,
       NULL);
  END;
  END IF;

END;
--Add by xlb 2013-03-08
 PROCEDURE usp_SaveApplyDepartOrRecord(

                                         v_TypeId          INT DEFAULT 0,
                                         v_consultapplysn  INT DEFAULT 0,
                                         v_ordervalue      INT DEFAULT 0,
                                         v_hospitalcode    VARCHAR DEFAULT '',
                                         v_departmentcode  VARCHAR DEFAULT '',
                                         v_departmentname  VARCHAR DEFAULT '',
                                         v_employeecode    VARCHAR DEFAULT '',
                                         v_employeename    VARCHAR DEFAULT '',
                                         v_employeelevelid VARCHAR DEFAULT '',
                                         v_createuser      VARCHAR DEFAULT '',
                                         v_createtime      VARCHAR DEFAULT '') as
 BEGIN
   --1表示只在申请受邀部门表中插入数据
   IF    v_TypeId=1 THEN
     BEGIN
    INSERT INTO consultapplydepartment
      (ID, -- this column value is auto-generated,
       consultapplysn,
       ordervalue,
       hospitalcode,
       departmentcode,
       departmentname,
       employeecode,
       employeename,
       employeelevelid,
       createuser,
       createtime,
       valid,
       canceluser,
       canceltime)
    VALUES
      (seq_consultapplydepartment_id.NEXTVAL,
       v_consultapplysn,
       v_ordervalue,
       v_hospitalcode,
       v_departmentcode,
       v_departmentname,
       v_employeecode,
       v_employeename,
       v_employeelevelid,
       v_createuser,
       v_createtime,
       '1',
       NULL,
       NULL);
END;
END IF;
IF v_TypeId=2 THEN --2表示 插入实际会诊部门表
  BEGIN


        INSERT INTO consultrecorddepartment
      (ID, -- this column value is auto-generated,
       consultapplysn,
       ordervalue,
       hospitalcode,
       departmentcode,
       departmentname,
       employeecode,
       employeename,
       employeelevelid,
       createuser,
       createtime,
       valid,
       canceluser,
       canceltime)
    VALUES
      (seq_consultrecorddepartment_id.NEXTVAL,
       v_consultapplysn,
       v_ordervalue,
       v_hospitalcode,
       v_departmentcode,
       v_departmentname,
       v_employeecode,
       v_employeename,
       v_employeelevelid,
       v_createuser,
       v_createtime,
       '1',
       NULL,
       NULL);
  END;
  END IF;
END;

END;
/

prompt
prompt Creating package body EMR_DOCTOR_STATION
prompt ========================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emr_doctor_station
-----------------------------------------------------------
------------------Add By wwj 2012-07-02--------------------
-----------------医生工作站涉及到的逻辑--------------------
-----------------------------------------------------------
IS
   PROCEDURE usp_getthreelevelcheckList (
      v_deptid         VARCHAR,
      o_result    OUT   empcurtyp
   )
   AS
   BEGIN
      OPEN o_result
       FOR
          SELECT inpatient.NAME, recorddetail.ID, recorddetail.noofinpat,
                 recorddetail.templateid, recorddetail.NAME docname,
                 recorddetail.sortid, recorddetail.hassubmit,
                 c1.NAME AS hassubmitname, recorddetail.owner
            FROM recorddetail
            LEFT OUTER JOIN inpatient ON inpatient.noofinpat = recorddetail.noofinpat
            LEFT OUTER JOIN categorydetail c1 ON c1.categoryid = 46
                AND c1.ID = recorddetail.hassubmit
           WHERE recorddetail.valid = '1'
             AND inpatient.outhosdept = v_deptid
             AND recorddetail.hassubmit <> 4600;
   END;
END;
/

prompt
prompt Creating package body EMR_NURSE_STATION
prompt =======================================
prompt
create or replace package body emr.emr_nurse_station is

  --通过单据ID和人员ID获取单据信息
  PROCEDURE usp_GetNurseRecord(v_NoOfInpatient  IN varchar2,
                               v_FatherRecordId IN varchar2,
                               o_result         OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select *
        from nurse_recordoper re
       where re.noofinpatent = v_NoOfInpatient
         and re.father_recordid = v_FatherRecordId
         and re.valid = '1';
  END;

  --添加或修改记录单记录
  PROCEDURE usp_AddOrModNurseRecord(v_ID              IN varchar2,
                                    v_NOOFINPATENT    IN varchar2,
                                    v_FATHER_RECORDID IN varchar2,
                                    v_RECORD_DATETIME IN varchar2,
                                    v_TIWEN           IN varchar2,
                                    v_MAIBO           IN varchar2,
                                    v_HUXI            IN varchar2,
                                    v_XUEYA           IN varchar2,
                                    v_YISHI           IN varchar2,
                                    v_XYBHD           IN varchar2,
                                    v_QKFL            IN varchar2,
                                    v_SYPF            IN varchar2,
                                    v_OTHER_ONE       IN varchar2,
                                    v_OTHER_TWO       IN varchar2,
                                    v_OTHER_THREE     IN varchar2,
                                    v_OTHER_FOUR      IN varchar2,
                                    v_ZTKDX           IN varchar2,
                                    v_YTKDX           IN varchar2,
                                    v_TKDGFS          IN varchar2,
                                    v_WOWEI           IN varchar2,
                                    v_JMZG            IN varchar2,
                                    v_DGJYLG_ONE      IN varchar2,
                                    v_DGJYLG_TWO      IN varchar2,
                                    v_DGJYLG_THREE    IN varchar2,
                                    v_In_ITEM         IN varchar2,
                                    v_In_VALUE        IN varchar2,
                                    v_OUT_ITEM        IN varchar2,
                                    v_OUT_VALUE       IN varchar2,
                                    v_OUT_COLOR       IN varchar2,
                                    v_OUT_STATUE      IN varchar2,
                                    v_OTHER           IN varchar2,
                                    v_HXMS            IN varchar2,
                                    v_FCIMIAO         IN varchar2,
                                    v_XRYND           IN varchar2,
                                    v_CGSD            IN varchar2,
                                    v_LXXZYTQ         IN varchar2,
                                    v_BDG             IN varchar2,
                                    v_SINGE_DOCTOR    IN varchar2,
                                    v_SINGE_DOCTORID  IN varchar2,
                                    v_CREATE_DOCTORID IN varchar2,
                                    v_CREATE_TIME     IN varchar2,
                                    v_VALID           IN varchar2) AS
  BEGIN
    IF v_ID IS NULL THEN
      insert into nurse_recordoper
      values
        (to_char(NURSERECORDID_SEQ.NEXTVAL),
         v_NOOFINPATENT,
         v_FATHER_RECORDID,
         v_RECORD_DATETIME,
         v_TIWEN,
         v_MAIBO,
         v_HUXI,
         v_XUEYA,
         v_YISHI,
         v_XYBHD,
         v_QKFL,
         v_SYPF,
         v_OTHER_ONE,
         v_OTHER_TWO,
         v_OTHER_THREE,
         v_OTHER_FOUR,
         v_ZTKDX,
         v_YTKDX,
         v_TKDGFS,
         v_WOWEI,
         v_JMZG,
         v_DGJYLG_ONE,
         v_DGJYLG_TWO,
         v_DGJYLG_THREE,
         v_In_ITEM,
         v_In_VALUE,
         v_OUT_ITEM,
         v_OUT_VALUE,
         v_OUT_COLOR,
         v_OUT_STATUE,
         v_OTHER,
         v_HXMS,
         v_FCIMIAO,
         v_XRYND,
         v_CGSD,
         v_LXXZYTQ,
         v_BDG,
         v_SINGE_DOCTOR,
         v_SINGE_DOCTORID,
         v_CREATE_DOCTORID,
         to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'),
         '1');
    ELSE
      update nurse_recordoper re
         set re.NOOFINPATENT    = v_NOOFINPATENT,
             re.FATHER_RECORDID = v_FATHER_RECORDID,
             re.RECORD_DATETIME = v_RECORD_DATETIME,
             re.TIWEN           = v_TIWEN,
             re.MAIBO           = v_MAIBO,
             re.HUXI            = v_HUXI,
             re.XUEYA           = v_XUEYA,
             re.YISHI           = v_YISHI,
             re.XYBHD           = v_XYBHD,
             re.QKFL            = v_QKFL,
             re.SYPF            = v_SYPF,
             re.OTHER_ONE       = v_OTHER_ONE,
             re.OTHER_TWO       = v_OTHER_TWO,
             re.OTHER_THREE     = v_OTHER_THREE,
             re.OTHER_FOUR      = v_OTHER_FOUR,
             re.ZTKDX           = v_ZTKDX,
             re.YTKDX           = v_YTKDX,
             re.TKDGFS          = v_TKDGFS,
             re.WOWEI           = v_WOWEI,
             re.JMZG            = v_JMZG,
             re.DGJYLG_ONE      = v_DGJYLG_ONE,
             re.DGJYLG_TWO      = v_DGJYLG_TWO,
             re.DGJYLG_THREE    = v_DGJYLG_THREE,
             re.In_ITEM         = v_In_ITEM,
             re.In_VALUE        = v_In_VALUE,
             re.OUT_ITEM        = v_OUT_ITEM,
             re.OUT_VALUE       = v_OUT_VALUE,
             re.OUT_COLOR       = v_OUT_COLOR,
             re.OUT_STATUE      = v_OUT_STATUE,
             re.OTHER           = v_OTHER,
             re.HXMS            = v_HXMS,
             re.FCIMIAO         = v_FCIMIAO,
             re.XRYND           = v_XRYND,
             re.CGSD            = v_CGSD,
             re.LXXZYTQ         = v_LXXZYTQ,
             re.BDG             = v_BDG,
             re.SINGE_DOCTOR    = v_SINGE_DOCTOR,
             re.SINGE_DOCTORID  = v_SINGE_DOCTORID
       where re.id = v_ID;
    END IF;

  END;

  --删除记录单
  PROCEDURE usp_DelNurseRecord(v_NurseId IN varchar2) AS
  BEGIN
    update nurse_recordoper re set re.valid = '0' where re.id = v_NurseId;
  END;

  --查询某科室下所有的病人的护理数据 add by tj 2012-10-30
  --此处字段的别名需和表原始的字段名称相同,字段代替使用时 需要天数据保存还配置天数据字段，需要时段数据保存还配置时段数据 切记！！！！！！
  --2013-03-20 病人查询1501和150中2种病人的查询
  procedure usp_GetPatientsOfDept(v_departCode  varchar2,
                                  v_wardcode    varchar2,
                                  v_Timelot     varchar2,
                                  v_TimelotSave varchar2,
                                  v_date        varchar2,
                                  o_result      OUT empcurtype) AS
  BEGIN
    open o_result for
      select patt.OUTBED          BED,
             patt.name            PNAME,
             patt.patid           PATID,
             patt.py              PY,
             patt.noofinpat,
             patt.inwarddate      inwarddate,
             tmp.id               ID,
             tmp.timeslot         TIMESLOT,
             tmp.temperature      temperature,
             tmp.wayofsurvey      wayofsurvey,
             tmp.name,
             tmp.pulse            PULSE,
             tmp.heartrate        HEARTRATE,
             tmp.breathe          BREATHE,
             tmp.physicalhotting  PHYSICALHOTTING,
             tmp.physicalcooling  PHYSICALCOOLING,
             tmp.countin          COUNTIN,
             tmp.timeofshit       TIMEOFSHIT,
             tmp.countout         COUNTOUT,
             tmp.drainage         DRAINAGE,
             tmp.bloodpressure    BLOODPRESSURE,
             tmp.paininfo         PAININFO,
             tmp.weight           WEIGHT,
             tmp.allergy          allergy,
             tmp.param1           param1,
             tmp.param2           param2,
             tmp.param3           param3,
             tmp.param4           param4,
             tmp.param5           param5,
             tmp.param6           param6,
             tmp.height           height,
             tmp.daysaftersurgery daysaftersurgery,
             tmp.dayofhospital    dayofhospital
        from inpatient patt
        left join (select tmp1.id,
                          tmp1.noofinpat,
                          tmp1.temperature,
                          tmp1.wayofsurvey,
                          tmp1.name,
                          tmp1.timeslot,
                          tmp1.dateofsurvey,
                          tmp1.pulse,
                          tmp1.heartrate,
                          tmp1.breathe,
                          tmp1.physicalhotting,
                          tmp1.physicalcooling,
                          tmp1.paininfo,
                          n.countin,
                          n.timeofshit,
                          n.countout,
                          n.drainage,
                          n.bloodpressure,
                          n.weight,
                          n.allergy,
                          n.param1,
                          n.param2,
                          n.param3,
                          n.param4,
                          n.param5,
                          n.param6,
                          n.height,
                          n.daysaftersurgery,
                          n.dayofhospital
                     from (select notesonnursing.id,
                                  notesonnursing.temperature,
                                  notesonnursing.wayofsurvey,
                                  notesonnursing.noofinpat,
                                  dictionary_detail.name,
                                  notesonnursing.timeslot,
                                  notesonnursing.dateofsurvey,
                                  notesonnursing.pulse, --脉搏
                                  notesonnursing.heartrate, --心率
                                  notesonnursing.breathe, --呼吸
                                  notesonnursing.physicalhotting, --物理升温
                                  notesonnursing.physicalcooling, --物理降温
                                  notesonnursing.paininfo
                             from notesonnursing
                             left join dictionary_detail
                               on dictionary_detail.detailid =
                                  notesonnursing.wayofsurvey
                            where dictionary_detail.categoryid = '88'
                              and notesonnursing.timeslot = v_Timelot
                              and notesonnursing.dateofsurvey = v_date) tmp1,
                          notesonnursing n
                    where n.noofinpat = tmp1.noofinpat
                      and n.timeslot = v_TimelotSave
                      and n.dateofsurvey = v_date) tmp
          on patt.noofinpat = tmp.noofinpat
       where patt.status in ('1501', '1500')
            --and patt.outhosdept =v_departCode --护士要更据病区来获取病人
         and patt.outhosward = v_wardcode;
  END;

  procedure usp_GetPatientsOfDept2(v_departCode  varchar2,
                                   v_wardcode    varchar2,
                                   v_Timelot     varchar2,
                                   v_TimelotSave varchar2,
                                   v_date        varchar2,
                                   o_result      OUT empcurtype,
                                   o_result1     OUT empcurtype,
                                   o_result2     OUT empcurtype)

   AS
  BEGIN
    open o_result for
      select patt.OUTBED     BED,
             patt.name       PNAME, --病人名称
             patt.patid      PATID, --住院号
             patt.py         PY, --拼音
             patt.noofinpat, --病人id
             patt.inwarddate inwarddate --病人入科日期
        from inpatient patt
       where patt.outhosward = v_wardcode
         and patt.status in (1500, 1501);
    open o_result1 for
      select patt.noofinpat, --病人id
             tmp.id ID, --体温单id
             tmp.timeslot TIMESLOT, --时间点
             tmp.temperature temperature, --体温
             tmp.wayofsurvey wayofsurvey, --测量方式id
             (select name
                from dictionary_detail
               where dictionary_detail.categoryid = '88'
                 and dictionary_detail.detailid = tmp.wayofsurvey) name, ----测量方式名

             tmp.pulse           PULSE, --脉搏
             tmp.heartrate       HEARTRATE, --心率
             tmp.breathe         BREATHE, --呼吸
             tmp.physicalhotting PHYSICALHOTTING, --物理升温
             tmp.physicalcooling PHYSICALCOOLING --物理降温
        from inpatient patt
        left join notesonnursing tmp
          on tmp.noofinpat = patt.noofinpat
       where tmp.timeslot = v_Timelot
         and tmp.dateofsurvey = v_date
         and patt.outhosward = v_wardcode
         and patt.status in (1500, 1501);

    open o_result2 for

      select inpat.noofinpat      noofinpat,
             tmp.countin          COUNTIN,
             tmp.timeofshit       TIMEOFSHIT,
             tmp.countout         COUNTOUT,
             tmp.drainage         DRAINAGE,
             tmp.bloodpressure    BLOODPRESSURE,
             tmp.paininfo         PAININFO,
             tmp.weight           WEIGHT,
             tmp.allergy          allergy,
             tmp.param1           param1,
             tmp.param2           param2,
             tmp.param3           param3,
             tmp.param4           param4,
             tmp.param5           param5,
             tmp.param6           param6,
             tmp.height           height,
             tmp.daysaftersurgery daysaftersurgery,
             tmp.dayofhospital    dayofhospital
        from inpatient inpat
        left join notesonnursing tmp
          on inpat.noofinpat = tmp.noofinpat
       where tmp.timeslot = v_TimelotSave
         and tmp.dateofsurvey = v_date
         and inpat.outhosward = v_wardcode
         and inpat.status in (1500, 1501);
  end;

end EMR_NURSE_STATION;
/

prompt
prompt Creating package body EMR_RECORD_INPUT
prompt ======================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.emr_record_input IS
  --文书录入 “另存”保存的表
  PROCEDURE usp_inserttemplateperson(v_templateid       VARCHAR,
                                     v_name             VARCHAR,
                                     v_userid           VARCHAR,
                                     v_content          CLOB,
                                     v_sortid           VARCHAR,
                                     v_memo             VARCHAR,
                                     v_py               VARCHAR,
                                     v_wb               VARCHAR,
                                     v_type             VARCHAR,
                                     v_ISCONFIGPAGESIZE VARCHAR,
                                     v_deptid           VARCHAR,
                                     o_result           OUT empcurtyp) AS
  BEGIN
    INSERT INTO template_person
      (ID,
       templateid,
       NAME,
       userid,
       valid,
       content,
       sortid,
       sortmark,
       sharedid,
       memo,
       py,
       wb,
       TYPE,
       ISCONFIGPAGESIZE,
       DEPTID)
    VALUES
      (seq_template_person_id.NEXTVAL,
       v_templateid,
       v_name,
       v_userid,
       '1',
       v_content,
       v_sortid,
       NULL,
       NULL,
       v_memo,
       v_py,
       v_wb,
       v_type,
       v_ISCONFIGPAGESIZE,
       v_deptid);
  
    OPEN o_result FOR
      SELECT seq_template_person_id.CURRVAL FROM DUAL;
  END;

  --得到用户病历操作记录
  PROCEDURE usp_getoperrecordlog(v_user_id    VARCHAR,
                                 v_patient_id VARCHAR,
                                 v_startDate  VARCHAR,
                                 v_endDate    VARCHAR,
                                 o_result     OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT User_id,
             User_name,
             Patient_id,
             Patient_name,
             department.name        Dept_name,
             Record_id,
             Record_title,
             Record_type,
             dictionary_detail.name as Oper_type,
             Oper_time,
             Oper_content
        FROM OperRecordLog
        LEFT JOIN dictionary_detail
          ON dictionary_detail.categoryid = 'cz'
         and dictionary_detail.detailid = OperRecordLog.Oper_Id
        LEFT JOIN department
          ON department.id = OperRecordLog.User_Dept_Id
       where OperRecordLog.User_Id = v_user_id
         and (OperRecordLog.Patient_Id = v_patient_id or
             v_patient_id is null or v_patient_id = '')
         and to_date(substr(nvl(trim(OperRecordLog.Oper_Time), '1990-01-01'),
                            1,
                            10),
                     'yyyy-mm-dd') >= to_date(v_startDate, 'yyyy-mm-dd')
         and to_date(substr(nvl(trim(OperRecordLog.Oper_Time), '1990-01-01'),
                            1,
                            10),
                     'yyyy-mm-dd') < to_date(v_endDate, 'yyyy-mm-dd')
       ORDER BY Record_id;
  END;

  --插入病历操作记录
  PROCEDURE usp_insertoperrecordlog(v_user_id      VARCHAR,
                                    v_user_name    VARCHAR,
                                    v_patient_id   VARCHAR,
                                    v_patient_name VARCHAR,
                                    v_dept_id      VARCHAR,
                                    v_record_id    VARCHAR,
                                    v_record_type  VARCHAR,
                                    v_record_title VARCHAR,
                                    v_oper_id      VARCHAR,
                                    v_oper_time    VARCHAR,
                                    v_oper_content clob) AS
  BEGIN
    INSERT INTO OperRecordLog
      (user_id,
       user_name,
       patient_id,
       patient_name,
       user_dept_id,
       record_id,
       record_type,
       record_title,
       oper_id,
       oper_time,
       oper_content)
    VALUES
      (v_user_id,
       v_user_name,
       v_patient_id,
       v_patient_name,
       v_dept_id,
       v_record_id,
       v_record_type,
       v_record_title,
       v_oper_id,
       v_oper_time,
       v_oper_content);
  END;

  --插入住院病人登记信息
  /*PROCEDURE usp_insertinhospatientinfo (
     v_name        VARCHAR,
     v_sex       VARCHAR,
     v_age     VARCHAR,
     v_mariage          VARCHAR,
     v_province        VARCHAR,
     v_county      VARCHAR,
     v_nation     VARCHAR,
     v_nationality          VARCHAR,
     v_idcard        VARCHAR,
     v_jobname     VARCHAR,
      v_organization        VARCHAR,
     v_officetel       VARCHAR,
     v_officepostalcode     VARCHAR,
     v_household          VARCHAR,
     v_tel        VARCHAR,
     v_postalcode      VARCHAR,
     v_address     VARCHAR,
     v_contactperson          VARCHAR,
     v_relationship        VARCHAR,
     v_contactaddress     VARCHAR,
      v_contacttel        VARCHAR,
     v_noofclinic       VARCHAR,
     v_noofrecord     VARCHAR,
     v_incount          VARCHAR,
     v_status        VARCHAR,
     v_criticallevel      VARCHAR,
     v_attendlevel     VARCHAR,
     v_pay          VARCHAR,
     v_origin        VARCHAR,
     v_admitway     VARCHAR,
     v_outway        VARCHAR,
     v_clinicdoctor       VARCHAR,
     v_resident     VARCHAR,
     v_attend          VARCHAR,
     v_chief        VARCHAR
  )
  AS
  BEGIN
        INSERT INTO iem_mainpage_basicinfo_2012
     (iem_mainpage_no,
      patnoofhis,
      noofinpat,
      payid,
      socialcare,
      incount,
      NAME,
      sexid,
      birth,
      marital,
      jobid,
      nationid,
      nationalityid,
      idno,
      ORGANIZATION,
      officeplace,
      officetel,
      officepost,
      CONTACTPERSON,
      RELATIONSHIP,
      CONTACTADDRESS,
      CONTACTTEL,
      admitdate,
      admitdept,
      admitward,
      trans_date,
      trans_admitdept,
      trans_admitward,
      outwarddate,
      outhosdept,
      outhosward,
      actualdays,
      pathology_diagnosis_name,
      pathology_observation_sn,
      allergic_drug,
      section_director,
      director,
      vs_employee_code,
      resident_employee_code,
      refresh_employee_code,
      DUTY_NURSE,
      interne,
      coding_user,
      medical_quality_id,
      quality_control_doctor,
      quality_control_nurse,
      quality_control_date,
      xay_sn,
      ct_sn,
      mri_sn,
      dsa_sn,
      bloodtype,
      rh,
      is_completed,
      completed_time,
      valide,
      create_user,
      create_time,
      MODIFIED_USER,
      MODIFIED_TIME,
      ZYMOSIS,
      HURT_TOXICOSIS_ELE_ID,
      HURT_TOXICOSIS_ELE_NAME,
      ZYMOSISSTATE,
      PATHOLOGY_DIAGNOSIS_ID,
      MONTHAGE,
      WEIGHT,
      INWEIGHT,
      INHOSTYPE,
      OUTHOSTYPE,
      RECEIVEHOSPITAL,
      RECEIVEHOSPITAL2,
      AGAININHOSPITAL,
      AGAININHOSPITALREASON,
      BEFOREHOSCOMADAY,
      BEFOREHOSCOMAHOUR,
      BEFOREHOSCOMAMINUTE,
      LATERHOSCOMADAY,
      LATERHOSCOMAHOUR,
      LATERHOSCOMAMINUTE,
      CARDNUMBER,
      ALLERGIC_FLAG,
      AUTOPSY_FLAG,
      CSD_PROVINCEID,
      CSD_CITYID,
      CSD_DISTRICTID,
      CSD_PROVINCENAME,
      CSD_CITYNAME,
      CSD_DISTRICTNAME,
      XZZ_PROVINCEID,
      XZZ_CITYID,
      XZZ_DISTRICTID,
      XZZ_PROVINCENAME,
      XZZ_CITYNAME,
      XZZ_DISTRICTNAME,
      XZZ_TEL,
      XZZ_POST,
      HKDZ_PROVINCEID,
      HKDZ_CITYID,
      HKDZ_DISTRICTID,
      HKDZ_PROVINCENAME,
      HKDZ_CITYNAME,
      HKDZ_DISTRICTNAME,
      HKDZ_POST,
      JG_PROVINCEID,
      JG_CITYID,
      JG_PROVINCENAME,
      JG_CITYNAME,
      AGE,
      ZG_FLAG,
      ADMITINFO,
      CSDADDRESS,
      JGADDRESS,
      XZZADDRESS,
      HKADDRESS,
      MENANDINHOP,
      INHOPANDOUTHOP,
      BEFOREOPEANDAFTEROPER,
      LINANDBINGLI,
      INHOPTHREE,
      FANGANDBINGLI,
      PATFLAG
      )
   VALUES
     (seq_iem_mainpage_basicinfo_2012_id.NEXTVAL,
      v_patnoofhis,
      -- numeric
      v_noofinpat, -- numeric
      v_payid, -- varchar(4)
      v_socialcare, -- varchar(32)
      v_incount, -- int
      v_name,
      -- varchar(60)
      v_sexid, -- varchar(4)
      v_birth, -- char(10)
      v_marital, -- varchar(4)
      v_jobid, -- varchar(4)
      v_provinceid,
      -- varchar(10)
      v_countyid, -- varchar(10)
      v_nationid, -- varchar(4)
      v_nationalityid, -- varchar(4)
      v_idno,
      -- varchar(18)
      v_organization, -- varchar(64)
      v_officeplace, -- varchar(64)
      v_officetel, -- varchar(16)
      v_officepost,
      -- varchar(16)
      v_nativeaddress, -- varchar(64)
      v_nativetel, -- varchar(16)
      v_nativepost, -- varchar(16)
      v_contactperson, -- varchar(32)
      v_relationship, -- varchar(4)
      v_contactaddress,
      -- varchar(255)
      v_contacttel, -- varchar(16)
      v_admitdate, -- varchar(19)
      v_admitdept, -- varchar(12)
      v_admitward,
      -- varchar(12)
      v_days_before, -- numeric
      v_trans_date, -- varchar(19)
      v_trans_admitdept,
      -- varchar(12)
      v_trans_admitward, -- varchar(12)
      v_trans_admitdept_again, -- varchar(12)
      v_outwarddate, -- varchar(19)
      v_outhosdept, -- varchar(12)
      v_outhosward, -- varchar(12)
      v_actual_days,
      -- numeric
      v_death_time, -- varchar(19)
      v_death_reason, -- varchar(300)
      v_admitinfo, -- varchar(4)
      v_in_check_date, -- varchar(19)
      v_pathology_diagnosis_name, -- varchar(300)
      v_pathology_observation_sn, -- varchar(60)
      v_ashes_diagnosis_name,
      -- varchar(300)
      v_ashes_anatomise_sn, -- varchar(60)
      v_allergic_drug, -- varchar(300)
      v_hbsag, -- numeric
      v_hcv_ab,
      -- numeric
      v_hiv_ab, -- numeric
      v_opd_ipd_id, -- numeric
      v_in_out_inpatinet_id, -- numeric
      v_before_after_or_id, -- numeric
      v_clinical_pathology_id, -- numeric
      v_pacs_pathology_id, -- numeric
      v_save_times, -- numeric
      v_success_times,
      -- numeric
      v_section_director, -- varchar(20)
      v_director, -- varchar(20)
      v_vs_employee_code,
      -- varchar(20)
      v_resident_employee_code, -- varchar(20)
      v_refresh_employee_code,
      -- varchar(20)
      v_master_interne, -- varchar(20)
      v_interne, -- varchar(20)
      v_coding_user, -- varchar(20)
      v_medical_quality_id, -- numeric
      v_quality_control_doctor,
      -- varchar(20)
      v_quality_control_nurse, -- varchar(20)
      v_quality_control_date,
      -- varchar(19)
      v_xay_sn, -- varchar(300)
      v_ct_sn, -- varchar(300)
      v_mri_sn, -- varchar(300)
      v_dsa_sn, -- varchar(300)
      v_is_first_case,
      -- numeric
      v_is_following, -- numeric
      v_following_ending_date, -- varchar(19)
      v_is_teaching_case, -- numeric
      v_blood_type_id, -- numeric
      v_rh, -- numeric
      v_blood_reaction_id, -- numeric
      v_blood_rbc, -- numeric
      v_blood_plt, -- numeric
      v_blood_plasma, -- numeric
      v_blood_wb, -- numeric
      v_blood_others, -- varchar(60)
      v_is_completed, -- varchar(1)
      v_completed_time, -- varchar(19)
      1, -- numeric
      v_create_user,
      -- varchar(10)
      TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss') -- varchar(19)
      );
  END;*/

  PROCEDURE usp_insertthreelevelcheck(v_residentid   VARCHAR,
                                      v_residentname VARCHAR,
                                      v_attendid     VARCHAR,
                                      v_attentname   VARCHAR,
                                      v_chiefid      VARCHAR,
                                      v_chiefname    VARCHAR,
                                      v_deptid       VARCHAR,
                                      v_deptname     VARCHAR,
                                      v_createuser   VARCHAR) AS
    v_count INT;
  BEGIN
    SELECT COUNT(1)
      INTO v_count
      FROM three_level_check
     WHERE three_level_check.resident_id = v_residentid
       AND valid = '1';
  
    IF v_count > 0 THEN
      /*
      UPDATE three_level_check
         SET valid = '0'
       WHERE three_level_check.resident_id = v_residentid and valid = '1';
      */
      DELETE FROM three_level_check
       WHERE three_level_check.resident_id = v_residentid
         AND valid = '1';
    END IF;
  
    INSERT INTO three_level_check
      (dept_id,
       dept_name,
       resident_id,
       resident_name,
       attend_id,
       attend_name,
       chief_id,
       chief_name,
       create_time,
       create_user,
       valid)
    VALUES
      (v_deptid,
       v_deptname,
       v_residentid,
       v_residentname,
       v_attendid,
       v_attentname,
       v_chiefid,
       v_chiefname,
       SYSDATE,
       v_createuser,
       '1');
  END;

  --得到历史病人记录
  /** edit by cyq 2013-02-28
  PROCEDURE usp_getHistoryInpatient (
     v_noofinpat      VARCHAR,
     v_admitbegindate VARCHAR,--add by xlb 2013-01-14
     v_admitenddate   VARCHAR,--add by xlb 2013-01-14
     o_result     OUT empcurtyp
  )
  AS
  p_admitbegindate varchar(50);--add by xlb 2013-01-14
  p_admitenddate varchar(50);--add by xlb 2013-01-14
  BEGIN
     IF v_admitbegindate='' THEN --add by xlb 2013-01-14
      p_admitbegindate:='1000-01-01 00:00:00';--add by xlb 2013-01-14
     else
    p_admitbegindate :=v_admitbegindate|| ' 00:00:00';--add by xlb 2013-01-14 edit xlb 2013-02-26 时分秒前空格 否则起始时间和结束时间相同的记录查不出
    p_admitenddate   := v_admitenddate|| ' 23:59:59';--add by xlb 2013-01-14 edit xlb 2013-02-26
  
  
     END IF;
  
     IF v_admitenddate='' THEN--add by xlb 2013-01-14
     p_admitenddate :='2999-01-01 00:00:00';--add by xlb 2013-01-14
  
      END IF;
   OPEN o_result FOR
       SELECT noofinpat, inpatient.name, inpatient.admitdate, diagnosis.name diagname
         FROM inpatient LEFT OUTER JOIN diagnosis ON inpatient.admitdiagnosis = diagnosis.icd
        WHERE inpatient.noofclinic IN
           (
               SELECT noofclinic
                 FROM inpatient
                WHERE inpatient.noofinpat = v_noofinpat --'7183'
                AND noofclinic IS NOT NULL
           )
           AND inpatient.noofinpat <> v_noofinpat
            AND inpatient.admitdate>=p_admitbegindate--add by xlb 2013-01-14
                AND inpatient.admitdate<=p_admitenddate--add by xlb 2013-01-14
       ORDER BY noofinpat;
  END;*/

  --获取历史病历 add by cyq 2013-02-28
  PROCEDURE usp_getHistoryInpatient(v_noofinpat      VARCHAR,
                                    v_admitbegindate VARCHAR,
                                    v_admitenddate   VARCHAR,
                                    o_result         OUT empcurtyp) AS
    v_sql VARCHAR(4000);
  BEGIN
    v_sql := 'SELECT inp.noofinpat, inp.name, inp.admitdate, dia.name diagname, inp.outhosdate
              FROM inpatient inp LEFT OUTER JOIN diagnosis dia ON inp.admitdiagnosis = dia.icd
              where inp.noofinpat in
              (
                  select distinct i.noofinpat from inpatient i inner JOIN recorddetail r on i.noofinpat=r.noofinpat
                  and i.idno IN(SELECT idno FROM inpatient WHERE noofinpat = ' ||
             v_noofinpat || ' AND idno IS NOT NULL)
                  and r.sortid not in(''AI'',''AJ'',''AK'')
              ) ';
    v_sql := v_sql || ' and inp.status in(1502,1503) and inp.noofinpat <> ' ||
             v_noofinpat;
    if v_admitbegindate IS NOT NULL then
      v_sql := v_sql || ' and inp.admitdate >= ''' || v_admitbegindate ||
               ' 00:00:00''';
    end if;
    if v_admitenddate IS NOT NULL then
      v_sql := v_sql || ' and inp.admitdate <= ''' || v_admitenddate ||
               ' 23:59:59''';
    end if;
    v_sql := v_sql || ' ORDER BY inp.admitdate ';
  
    OPEN o_result FOR v_sql;
  END;

  --得到历史病人文件夹
  PROCEDURE usp_getHistoryInpatientFolder(v_noofinpat VARCHAR,
                                          o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT r.sortid, d.cname, d.mname, d.ccode, d.open_flag, d.utype
        FROM recorddetail r
        LEFT OUTER JOIN dict_catalog d
          ON d.ccode = r.sortid
       WHERE r.noofinpat = v_noofinpat
         and r.valid = '1'
       GROUP BY r.sortid, d.cname, d.mname, d.ccode, d.open_flag, d.utype
       ORDER BY r.sortid;
  END;

  --得到住院次数（******进入我们电子病历系统的次数，而非实际的入院次数**********）
  PROCEDURE usp_getHistoryInCount(v_noofinpat VARCHAR,
                                  o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT inpatient.incount
        FROM inpatient
       WHERE inpatient.noofinpat = v_noofinpat; --'7183'
  END;

  --得到病人的基本信息
  PROCEDURE usp_getPatinetInfo(v_noofinpat VARCHAR, o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT agestr age /*年龄*/,
             outbed || '床' bed,
             patid /*病历号*/,
             department.name deptname,
             ward.name wardname,
             inpatient.admitdate,
             inwarddate /*入区时间*/,
             inpatient.name patname,
             dd1.name sexname
        FROM inpatient
        left outer join department
          on department.id = inpatient.outhosdept
         and department.valid = '1'
        left outer join ward
          on ward.id = inpatient.outhosward
         and ward.valid = '1'
        left outer join dictionary_detail dd1
          on dd1.detailid = inpatient.sexid
         and dd1.categoryid = '3'
       WHERE inpatient.noofinpat = v_noofinpat;
  END;

  --得到病人历史病历，用于历史病历导入
  PROCEDURE usp_getHistoryEMR(v_noofinpat VARCHAR,
                              v_sortid    VARCHAR,
                              o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT emrtemplet.templet_id templateid,
             emrtemplet.mr_name,
             emrtemplet.mr_class SORTID,
             emrtemplet.new_page_flag,
             emrtemplet.file_name,
             emrtemplet.isshowfilename,
             emrtemplet.isyihuangoutong,
             emrtemplet.new_page_end,
             emrtemplet.isconfigpagesize,
             emrtemplet.isfirstdaily,
             emrtemplet.py,
             emrtemplet.wb,
             recorddetail.id,
             recorddetail.name,
             recorddetail.captiondatetime,
             '' content,
             inpatient.name,
             inpatient.admitdate
        FROM recorddetail, emrtemplet, inpatient
       WHERE recorddetail.templateid = emrtemplet.templet_id
         AND recorddetail.sortid = v_sortid
         AND recorddetail.noofinpat = v_noofinpat
         AND inpatient.noofinpat = v_noofinpat
         AND recorddetail.valid = '1'
       ORDER BY recorddetail.sortid, recorddetail.captiondatetime;
  END;

  --得到病历内容
  PROCEDURE usp_EmrContentByID(v_recorddetailid VARCHAR,
                               o_result         OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT recorddetail.content
        FROM recorddetail
       WHERE id = v_recorddetailid;
  END;

  /*插入转科记录 add by cyq 2013-03-26 */
  PROCEDURE usp_Inpatient_ChangeInfo(v_id          INTEGER,
                                     v_noofinpat   INTEGER,
                                     v_newdeptid   VARCHAR2 default '',
                                     v_newwardid   VARCHAR2 default '',
                                     v_newbedid    VARCHAR2 default '',
                                     v_olddeptid   VARCHAR2 default '',
                                     v_oldwardid   VARCHAR2 default '',
                                     v_oldbedid    VARCHAR2 default '',
                                     v_changestyle CHAR default '',
                                     v_createuser  VARCHAR2 default '',
                                     v_createtime  CHAR default '',
                                     v_modifyuser  VARCHAR2 default '',
                                     v_modifytime  CHAR default '',
                                     v_valid       INTEGER) AS
    /**********
    [版本号] 1.0.0.0.0
    [创建时间] 2013-03-26
    [作者]   cyq
    [版权]
    [描述] 插入病人转科文件
    [结果集]返回插入的ID
    **********/
  BEGIN
    INSERT INTO inpatientchangeinfo
      (ID,
       noofinpat,
       newdeptid,
       newwardid,
       newbedid,
       olddeptid,
       oldwardid,
       oldbedid,
       changestyle,
       createuser,
       createtime,
       modifyuser,
       modifytime,
       valid)
      SELECT v_id,
             v_noofinpat,
             v_newdeptid,
             v_newwardid,
             v_newbedid,
             v_olddeptid,
             v_oldwardid,
             v_oldbedid,
             v_changestyle,
             v_createuser,
             v_createtime,
             v_modifyuser,
             v_modifytime,
             v_valid
        FROM dual
      /*WHERE NOT EXISTS(
        SELECT 1 FROM inpatientchangeinfo ici
        WHERE ici.noofinpat = v_noofinpat AND ici.newdeptid = v_newdeptid
        AND ici.newwardid = v_newwardid AND ici.createtime = v_createtime
        AND ici.valid = '1'
      )*/
      ;
  END;

/*--新历史病历导入
   PROCEDURE usp_BatchInHistoryEMR(
     v_noofinpat       VARCHAR,
     v_templateid      VARCHAR,
     v_name            VARCHAR,
     v_sortid          VARCHAR,
     v_owner           VARCHAR,
     v_createtime      VARCHAR,
     v_captiondatetime VARCHAR,
     v_firstdailyflag  VARCHAR,
     v_isyihuangougong VARCHAR,
     v_ip              VARCHAR,
     v_isconfigpagesize VARCHAR,
     v_departcode      VARCHAR,
     v_wardcode        VARCHAR,
     v_changeid        VARCHAR
   ) AS
   BEGIN
    INSERT INTO recorddetail(id, noofinpat, templateid, name, sortid, owner,
                            createtime, valid, hassubmit, hasprint, hassign,
                            captiondatetime, islock, firstdailyflag,
                            isyihuangoutong, ip, isconfigpagesize, departcode,
                            wardcode, changeid)
VALUES(seq_recorddetail_id.nextval, v_noofinpat, v_templateid, v_name, v_sortid, v_owner,
        v_createtime, '1', '4600', '3600', '0',
        v_captiondatetime, '4701', v_firstdailyflag,
        v_isyihuangougong, v_ip, v_isconfigpagesize, v_departcode,
        v_wardcode, v_changeid);
   END;*/
END;
/

prompt
prompt Creating package body EMR_VIEW_TOOL
prompt ===================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.EMR_VIEW_TOOL IS
  --**********************************历次出院病历查阅**************************************
  --获取病人基本信息
  PROCEDURE usp_inpatient_info(v_patnoofhis VARCHAR2,
                               o_result     OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT i.name, decode(i.sexid, 1, '男', 2, '女', '未知') sex, i.birth
        FROM inpatient i
       WHERE i.patnoofhis = v_patnoofhis;
  END;

  --获取历史病人
  PROCEDURE usp_history_inpatient(v_patnoofhis VARCHAR2,
                                  o_result     OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT i1.NAME inpatientname, i1.noofinpat, i1.inwarddate
        FROM inpatient i1
       WHERE EXISTS (SELECT 1
                FROM inpatient i2
               WHERE i2.patnoofhis = v_patnoofhis
                 AND i2.noofclinic = i1.noofclinic)
       ORDER BY i1.inwarddate DESC;
  END;

  --获取病人病历
  PROCEDURE usp_inpatient_emr(v_noofinpat VARCHAR2,
                              o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT r.NAME, r.ID
        FROM recorddetail r
       WHERE r.noofinpat = v_noofinpat
         AND r.valid = 1
         AND (r.name like '%出院%');
  END;

  --获取病人病历
  PROCEDURE usp_inpatient_emr2(v_id VARCHAR2, o_result OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT r.content
        FROM recorddetail r
       WHERE r.ID = v_id
         AND r.valid = 1;
  END;

  --**********************************门急诊历史病历查阅**************************************

  --获取病人基本信息【门诊】
  PROCEDURE usp_inpatient_info_clinic(v_patnoofhis VARCHAR2,
                                      o_result     OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT i.name, decode(i.sexid, 1, '男', 2, '女', '未知') sex, i.birth
        FROM inpatient_clinic i
       WHERE i.patnoofhis = v_patnoofhis;
  END;

  --获取历史病人【门诊】
  PROCEDURE usp_history_inpatient_clinic(v_patnoofhis VARCHAR2,
                                         o_result     OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT i1.NAME            inpatientname,
             i1.noofinpatclinic noofinpat,
             i1.visittime       inwarddate
        FROM inpatient_clinic i1
       WHERE EXISTS (SELECT 1
                FROM inpatient_clinic i2
               WHERE i2.patnoofhis = v_patnoofhis
                 AND i2.patid = i1.patid)
         AND i1.patnoofhis != v_patnoofhis
         AND i1.valid = '1'
       ORDER BY i1.visittime DESC;
  END;

  --获取病人病历【门诊】
  PROCEDURE usp_inpatient_emr_clinic(v_noofinpat VARCHAR2,
                                     o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT r.NAME, r.ID
        FROM recorddetail_clinic r
       WHERE r.noofinpatclinic = v_noofinpat
         AND r.valid = 1
       ORDER BY r.id;
  END;

  --获取病人病历【门诊】
  PROCEDURE usp_inpatient_emr2_clinic(v_id     VARCHAR2,
                                      o_result OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      SELECT r.content
        FROM recorddetail_clinic r
       WHERE r.ID = v_id
         AND r.valid = 1;
  END;

  --获取门诊电子病历的宏元素的值
  PROCEDURE usp_macro_inpatient_clinic(v_noofinpat VARCHAR2,
                                       o_result    OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select ic.name           PatName,
             dd1.name          PatSexName,
             ic.patid          PatID,
             ic.age            PatAge,
             ic.bedcode        PatBedCode,
             dd2.name          PatMaritalName,
             ic.country        PatCountryName,
             ic.nationality    PatNationalityName,
             ic.jobname        PatJobName,
             ic.contactaddress PatContactAddress
        from inpatient_clinic ic
        left outer join dictionary_detail dd1
          on dd1.categoryid = '3'
         and dd1.detailid = ic.sexid
         and dd1.valid = '1'
        left outer join dictionary_detail dd2
          on dd2.categoryid = '4'
         and dd2.detailid = ic.maritalid
         and dd2.valid = '1'
       where ic.noofinpatclinic = v_noofinpat
         and ic.valid = '1';
  END;

  --********************************病人信息维护******************************************
  --获取门诊电子病历的宏元素的值
  PROCEDURE usp_get_inpatient_list(v_deptID         VARCHAR2,
                                   v_visitTypeID    VARCHAR2,
                                   v_name           VARCHAR2,
                                   v_patID          VARCHAR2,
                                   v_visitTimeBegin date,
                                   v_visitTimeEnd   date,
                                   o_result         OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select ic.noofinpatclinic,
             ic.visittype visittypeid,
             dd1.name visittypename,
             trunc(ic.visittime) visittime,
             ic.visitno,
             ic.roomname,
             ic.name,
             ic.patid,
             dd2.name sexname,
             ic.birth,
             ic.age,
             dd3.name maritalname,
             d.name deptname,
             ic.nationality,
             ic.country,
             ic.healthcardid,
             ic.contactaddress,
             ic.jobname,
             ic.visitdoctorid || '_' || u.name visitdoctorname,
             ic.bedcode
        from inpatient_clinic ic
        left outer join dictionary_detail dd1
          on dd1.categoryid = '13'
         and dd1.detailid = ic.visittype
        left outer join dictionary_detail dd2
          on dd2.categoryid = '3'
         and dd2.detailid = ic.sexid
        left outer join dictionary_detail dd3
          on dd3.categoryid = '4'
         and dd3.detailid = ic.maritalid
        left outer join users u
          on u.id = ic.visitdoctorid
        left outer join department d
          on d.id = ic.deptid
       where ic.deptid = v_deptID
         and ic.visittype = v_visitTypeID
         and ic.name like '%' || v_name || '%'
         and ic.patid like '%' || v_patID || '%'
         and trunc(ic.visittime) >= trunc(v_visitTimeBegin)
         and trunc(ic.visittime) <= trunc(v_visitTimeEnd)
         and ic.valid = '1'
       order by trunc(ic.visittime), ic.visitno desc;
  END;

  --通过病历号或病人姓名抓取病人
  PROCEDURE usp_get_inpatient_list2(v_patID  VARCHAR2,
                                    v_name   VARCHAR2,
                                    o_result OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select ic.noofinpatclinic,
             ic.visittype visittypeid,
             dd1.name visittypename,
             trunc(ic.visittime) visittime,
             ic.visitno,
             ic.roomname,
             ic.name,
             ic.patid,
             dd2.name sexname,
             ic.birth,
             ic.age,
             dd3.name maritalname,
             d.name deptname,
             ic.nationality,
             ic.country,
             ic.healthcardid,
             ic.contactaddress,
             ic.jobname,
             ic.visitdoctorid || '_' || u.name visitdoctorname,
             ic.bedcode
        from inpatient_clinic ic
        left outer join dictionary_detail dd1
          on dd1.categoryid = '13'
         and dd1.detailid = ic.visittype
        left outer join dictionary_detail dd2
          on dd2.categoryid = '3'
         and dd2.detailid = ic.sexid
        left outer join dictionary_detail dd3
          on dd3.categoryid = '4'
         and dd3.detailid = ic.maritalid
        left outer join users u
          on u.id = ic.visitdoctorid
        left outer join department d
          on d.id = ic.deptid
       where ((v_patID is not null and ic.patid = v_patID) or
             (v_name is not null and ic.name = v_name))
         and ic.valid = '1';
  END;

  --获取门诊科室列表                                   
  PROCEDURE usp_get_dept_list(o_result OUT empcurtype) AS
  BEGIN
    OPEN o_result FOR
      select d.id, d.name, d.py, d.wb
        from department d
       where d.sort not in ('102', '103', '104')
         and d.valid = '1'
       order by d.id;
  END;

  --********************************测试，用于解析XML*************************************  
  PROCEDURE usp_xml_content(v_recordDetailID varchar2,
                            v_roElementName  varchar2,
                            o_result         OUT empcurtype) AS
    --创建XML解析器实例XMLPARSER.parser
    xmlPar XMLPARSER.parser := XMLPARSER.NEWPARSER;
    --定义DOM文档对象
    doc xmldom.DOMDocument;
  
    --roElement元素
    roElementNode xmldom.DOMNode;
  
    --p元素集合
    paragraphElementNodes xmldom.DOMNodeList;
    --p元素集合的数量
    paragraphElementCount integer;
    --p元素
    paragraphElementNode xmldom.DOMNode;
  
    --p元素的所有子节点集合
    childElementNodes xmldom.DOMNodeList;
    --p元素的所有子节点个数
    childElementNodesCount integer;
  
    --selement元素集合
    selementNodes xmldom.DOMNodeList;
    --selement元素集合个数
    selementNodesCount integer;
    selementNode       xmldom.DOMNode;
    selementValue      nvarchar2(200);
  
    xmlClobData clob;
    v_result    nvarchar2(4000);
  
    --进入逻辑判断的标志位
    isEnter integer := 0;
  
    --节点属性集合
    nodeAttributes xmldom.DOMNamedNodeMap;
  BEGIN
  
    --获取xml数据，clob字段中获取病历内容
    select content
      into xmlClobData
      from recorddetail
     where id = v_recordDetailID;
  
    --解析xml数据
    xmlparser.parseClob(xmlPar, xmlClobData);
    doc := xmlparser.getDocument(xmlPar);
  
    --释放解析器实例
    xmlparser.freeParser(xmlPar);
  
    --获取所有P元素
    paragraphElementNodes := xmldom.getElementsByTagName(doc, 'p');
    paragraphElementCount := xmldom.getLength(paragraphElementNodes);
  
    --循环段落 
    For paragraphIndex in 0 .. paragraphElementCount - 1 LOOP
      --********循环段落 BEGIN********
      BEGIN
        --获取当前段落
        paragraphElementNode := xmldom.item(paragraphElementNodes,
                                            paragraphIndex);
        --获取段落中所有元素
        childElementNodes      := xmldom.getChildNodes(paragraphElementNode);
        childElementNodesCount := xmldom.getLength(childElementNodes);
        FOR childElementNodesIndex in 0 .. childElementNodesCount - 1 LOOP
          --********段落中的元素 BEGIN********
          BEGIN
            roElementNode := xmldom.item(childElementNodes,
                                         childElementNodesIndex);
          
            IF isEnter = 0 THEN
              --找到起始RoElement元素
              BEGIN
                --获取段落中的roElement元素
                IF (xmldom.getNodeName(roElementNode) = 'roelement') THEN
                  BEGIN
                    nodeAttributes := xmldom.getAttributes(roElementNode);
                  
                    --获取name == v_roleElementName 的roELement元素
                    IF (xmldom.getNodeValue(xmldom.getNamedItem(nodeAttributes,
                                                                'name')) =
                       v_roElementName) THEN
                      BEGIN
                        isEnter := 1;
                      END;
                    END IF;
                  END;
                END IF;
              END;
            ELSIF isEnter = 1 THEN
              BEGIN
                --判断是否遇到后面的roElement，如果遇到需要退出循环
                IF (xmldom.getNodeName(roElementNode) = 'roelement') THEN
                  BEGIN
                    isEnter := 2;
                    EXIT;
                  END;
                ELSE
                  BEGIN
                    IF (xmldom.getNodeName(roElementNode) = 'selement') THEN
                      --如果是"多选框"需要做特殊处理
                      BEGIN
                        nodeAttributes := xmldom.getAttributes(roElementNode);
                        selementValue  := xmldom.getNodeValue(xmldom.getNamedItem(nodeAttributes,
                                                                                  'text')); --获取selement元素的text属性的值
                      
                        selementNodes      := xmldom.getChildNodes(roElementNode);
                        selementNodesCount := xmldom.getLength(selementNodes);
                      
                        FOR selementNodesIndex in 0 .. selementNodesCount - 1 LOOP
                          --循环selement元素的所有子元素item
                          selementNode   := xmldom.item(selementNodes,
                                                        selementNodesIndex);
                          nodeAttributes := xmldom.getAttributes(selementNode);
                          IF xmldom.getNodeValue(xmldom.getNamedItem(nodeAttributes,
                                                                     'selected')) =
                             'true' THEN
                            --找出item中属性selected为true的节点
                            selementValue := xmldom.getNodeValue(xmldom.getFirstChild(selementNode));
                          END IF;
                        END LOOP;
                      
                        v_result := v_result || selementValue;
                      END;
                    ELSIF (xmldom.getNodeName(roElementNode) = 'btnelement') THEN
                      --如果是“按钮”需要做特殊处理
                      BEGIN
                        nodeAttributes := xmldom.getAttributes(roElementNode);
                        selementValue  := xmldom.getNodeValue(xmldom.getNamedItem(nodeAttributes,
                                                                                  'print')); --获取btnelement元素的print属性的值
                        IF selementValue != 'False' THEN
                          BEGIN
                            v_result := v_result ||
                                        xmldom.getNodeValue(xmldom.getFirstChild(roElementNode));
                          END;
                        END IF;
                      END;
                    ELSE
                      v_result := v_result ||
                                  xmldom.getNodeValue(xmldom.getFirstChild(roElementNode));
                    END IF;
                  END;
                END IF;
              END;
            END IF;
          END;
          --********段落中的元素 END********
        END LOOP;
      END;
      --********循环段落 END********
    END LOOP;
  
    OPEN o_result FOR
      select ltrim(ltrim(v_result, '：'), ':') as content from dual;
  END;

END;
/

prompt
prompt Creating package body EMR_ZYMOSIS_REPORT
prompt ========================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.EMR_ZYMOSIS_REPORT IS

  /*********************************************************************************/
  PROCEDURE usp_EditZymosis_Report(v_EditType         varchar,
                                   v_Report_ID        NUMERIC DEFAULT 0,
                                   v_Report_NO        varchar DEFAULT '', --报告卡卡号
                                   v_Report_Type      varchar default '', --报告卡类型   1、初次报告  2、订正报告
                                   v_Noofinpat        varchar default '', --首页序号
                                   v_PatID            varchar default '', --住院号
                                   v_Name             varchar default '', --患者姓名
                                   v_ParentName       varchar default '', --家长姓名
                                   v_IDNO             varchar default '', --身份证号码
                                   v_Sex              varchar default '', --患者性别
                                   v_Birth            varchar default '', --出生日期
                                   v_Age              varchar default '', --实足年龄
                                   v_AgeUnit          varchar default '', --实足年龄单位
                                   v_Organization     varchar default '', --工作单位
                                   v_OfficePlace      varchar default '', --单位地址
                                   v_OfficeTEL        varchar default '', --单位电话
                                   v_AddressType      varchar default '', --病人属于地区  1、本县区 2、本市区其他县区  3、本省其他地区  4、外省  5、港澳台  6、外籍
                                   v_HomeTown         varchar default '', --家乡
                                   v_Address          varchar default '', --详细地址[村 街道 门牌号]
                                   v_JobID            varchar default '', --职业代码（按页面顺序记录编号）
                                   v_RecordType1      varchar default '', --病历分类  1、疑似病历  2、临床诊断病历  3、实验室确诊病历  4病原携带者
                                   v_RecordType2      varchar default '', --病历分类（乙型肝炎、血吸虫病填写）  1、急性  2、慢性
                                   v_AttackDate       varchar default '', --发病日期（病原携带者填初检日期或就诊日期）
                                   v_DiagDate         varchar default '', --诊断日期
                                   v_DieDate          varchar default '', --死亡日期
                                   v_DiagICD10        varchar default '', --传染病病种(对应传染病诊断库)
                                   v_DiagName         varchar default '', --传染病病种名称
                                   v_INFECTOTHER_FLAG varchar default '', --有无感染其他人[0无 1有]
                                   v_Memo             varchar default '', --备注
                                   v_Correct_flag     varchar default '', --订正标志【0、未订正 1、已订正】
                                   v_Correct_Name     varchar default '', --订正病名
                                   v_Cancel_Reason    varchar default '', --退卡原因
                                   v_ReportDeptCode   varchar default '', --报告科室编号
                                   v_ReportDeptName   varchar default '', --报告科室名称
                                   v_ReportDocCode    varchar default '', --报告医生编号
                                   v_ReportDocName    varchar default '', --报告医生名称
                                   v_DoctorTEL        varchar default '', --报告医生联系电话
                                   v_Report_Date      varchar default '', --填卡时间
                                   v_State            varchar default '', --报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报  7、作废】
                                   v_StateName        varchar default '', --操作状态，方便记录操作流水中
                                   v_create_date      varchar default '', --创建时间
                                   v_create_UserCode  varchar default '', --创建人
                                   v_create_UserName  varchar default '', --创建人
                                   v_create_deptCode  varchar default '', --创建人科室
                                   v_create_deptName  varchar default '', --创建人科室
                                   v_Modify_date      varchar default '', --修改时间
                                   v_Modify_UserCode  varchar default '', --修改人
                                   v_Modify_UserName  varchar default '', --修改人
                                   v_Modify_deptCode  varchar default '', --修改人科室
                                   v_Modify_deptName  varchar default '', --修改人科室
                                   v_Audit_date       varchar default '', --审核时间
                                   v_Audit_UserCode   varchar default '', --审核人
                                   v_Audit_UserName   varchar default '', --审核人
                                   v_Audit_deptCode   varchar default '', --审核人科室
                                   v_Audit_deptName   varchar default '', --审核人科室
                                   v_OtherDiag        varchar default '',
                                   o_result           OUT empcurtyp) AS
  
    v_Report_ID_new int;
  BEGIN
  
    --新增传染病报告卡
    IF v_edittype = '1' THEN
    
      select seq_Zymosis_Report_ID.Nextval into v_Report_ID_new from dual;
    
      insert into zymosis_report
        (Report_ID,
         Report_NO, --报告卡卡号
         Report_Type, --报告卡类型   1、初次报告  2、订正报告
         Noofinpat, --首页序号
         PatID, --住院号
         Name, --患者姓名
         ParentName, --家长姓名
         IDNO, --身份证号码
         Sex, --患者性别
         Birth, --出生日期
         Age, --实足年龄
         Age_Unit, --实足年龄单位
         Organization, --工作单位
         OfficePlace, --单位地址
         OfficeTEL, --单位电话
         AddressType, --病人属于地区  1、本县区 2、本市区其他县区  3、本省其他地区  4、外省  5、港澳台  6、外籍
         HomeTown, --家乡
         Address, --详细地址[村 街道 门牌号]
         JobID, --职业代码（按页面顺序记录编号）
         RecordType1, --病历分类  1、疑似病历  2、临床诊断病历  3、实验室确诊病历  4病原携带者
         RecordType2, --病历分类（乙型肝炎、血吸虫病填写）  1、急性  2、慢性
         AttackDate, --发病日期（病原携带者填初检日期或就诊日期）
         DiagDate, --诊断日期
         DieDate, --死亡日期
         DiagICD10, --传染病病种(对应传染病诊断库)
         DiagName, --传染病病种名称
         INFECTOTHER_FLAG, --有无感染其他人[0无 1有]
         Memo, --备注
         Correct_flag, --订正标志【0、未订正 1、已订正】
         Correct_Name, --订正病名
         Cancel_Reason, --退卡原因
         ReportDeptCode, --报告科室编号
         ReportDeptName, --报告科室名称
         ReportDocCode, --报告医生编号
         ReportDocName, --报告医生名称
         DoctorTEL, --报告医生联系电话
         Report_Date, --填卡时间
         State, --报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报  7、作废】
         create_date, --创建时间
         create_UserCode, --创建人
         create_UserName, --创建人
         create_deptCode, --创建人科室
         create_deptName, --创建人科室
         Modify_date, --修改时间
         Modify_UserCode, --修改人
         Modify_UserName, --修改人
         Modify_deptCode, --修改人科室
         Modify_deptName, --修改人科室
         Audit_date, --审核时间
         Audit_UserCode, --审核人
         Audit_UserName, --审核人
         Audit_deptCode, --审核人科室
         Audit_deptName, --审核人科室
         OTHERDIAG)
      values
        (v_Report_ID_new,
         v_Report_NO, --报告卡卡号
         v_Report_Type, --报告卡类型   1、初次报告  2、订正报告
         v_Noofinpat, --首页序号
         v_PatID, --住院号
         v_Name, --患者姓名
         v_ParentName, --家长姓名
         v_IDNO, --身份证号码
         v_Sex, --患者性别
         v_Birth, --出生日期
         v_Age, --实足年龄
         v_AgeUnit,
         v_Organization, --工作单位
         v_OfficePlace, --单位地址
         v_OfficeTEL, --单位电话
         v_AddressType, --病人属于地区  1、本县区 2、本市区其他县区  3、本省其他地区  4、外省  5、港澳台  6、外籍
         v_HomeTown, --家乡
         v_Address, --详细地址[村 街道 门牌号]
         v_JobID, --职业代码（按页面顺序记录编号）
         v_RecordType1, --病历分类  1、疑似病历  2、临床诊断病历  3、实验室确诊病历  4病原携带者
         v_RecordType2, --病历分类（乙型肝炎、血吸虫病填写）  1、急性  2、慢性
         v_AttackDate, --发病日期（病原携带者填初检日期或就诊日期）
         v_DiagDate, --诊断日期
         v_DieDate, --死亡日期
         v_DiagICD10, --传染病病种(对应传染病诊断库)
         v_DiagName, --传染病病种名称
         v_INFECTOTHER_FLAG, --有无感染其他人[0无 1有]
         v_Memo, --备注
         v_Correct_flag, --订正标志【0、未订正 1、已订正】
         v_Correct_Name, --订正病名
         v_Cancel_Reason, --退卡原因
         v_ReportDeptCode, --报告科室编号
         v_ReportDeptName, --报告科室名称
         v_ReportDocCode, --报告医生编号
         v_ReportDocName, --报告医生名称
         v_DoctorTEL, --报告医生联系电话
         v_Report_Date, --填卡时间
         v_State, --报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报  7、作废】
         to_char(sysdate, 'yyyy-mm-dd HH24:mi:ss'), --创建时间
         v_create_UserCode, --创建人
         v_create_UserName, --创建人
         v_create_deptCode, --创建人科室
         v_create_deptName, --创建人科室
         v_Modify_date, --修改时间
         v_Modify_UserCode, --修改人
         v_Modify_UserName, --修改人
         v_Modify_deptCode, --修改人科室
         v_Modify_deptName, --修改人科室
         v_Audit_date, --审核时间
         v_Audit_UserCode, --审核人
         v_Audit_UserName, --审核人
         v_Audit_deptCode, --审核人科室
         v_Audit_deptName, --审核人科室
         v_OtherDiag);
    
      --插入传染病报告卡操作流水
      insert into Zymosis_Report_SN
        (Report_SN_ID, --表流水号
         Report_ID, --传染病报告卡编号
         create_date, --创建时间
         create_UserCode, --创建人
         create_UserName, --创建人
         create_deptCode, --创建人科室
         create_deptName, --创建人科室
         State, --修改类型
         Memo --备注
         )
      values
        (seq_Zymosis_Report_SN_ID.Nextval, --表流水号
         v_Report_ID_new, --传染病报告卡编号
         to_char(sysdate, 'yyyy-mm-dd HH24:mi:ss'), --创建时间
         v_create_UserCode, --创建人
         v_create_UserName, --创建人
         v_create_deptCode, --创建人科室
         v_create_deptName, --创建人科室
         v_StateName, --修改类型
         '' --备注
         );
    
      open o_result for
        select v_Report_ID_new from dual;
    
    end if;
  
    --修改保存传染病报告卡信息
    IF v_edittype = '2' THEN
    
      update zymosis_report
         set Report_NO        = nvl(v_Report_NO, Report_NO), --报告卡卡号
             Report_Type      = nvl(v_Report_Type, Report_Type), --报告卡类型   1、初次报告  2、订正报告
             Noofinpat        = nvl(v_Noofinpat, Noofinpat), --首页序号
             PatID            = nvl(v_PatID, PatID), --住院号
             Name             = nvl(v_Name, Name), --患者姓名
             ParentName       = v_ParentName, --家长姓名
             IDNO             = v_IDNO, --身份证号码
             Sex              = nvl(v_Sex, Sex), --患者性别
             Birth            = v_Birth, --出生日期
             Age              = v_Age, --实足年龄
             Age_Unit         = v_AgeUnit, --实足年龄
             Organization     = v_Organization, --工作单位
             OfficePlace      = v_OfficePlace, --单位地址
             OfficeTEL        = v_OfficeTEL, --单位电话
             AddressType      = nvl(v_AddressType, AddressType), --病人属于地区  1、本县区 2、本市区其他县区  3、本省其他地区  4、外省  5、港澳台  6、外籍
             HomeTown         = v_HomeTown, --家乡
             Address          = v_Address, --详细地址[村 街道 门牌号]
             JobID            = v_JobID, --职业代码（按页面顺序记录编号）
             RecordType1      = v_RecordType1, --病历分类  1、疑似病历  2、临床诊断病历  3、实验室确诊病历  4病原携带者
             RecordType2      = v_RecordType2, --病历分类（乙型肝炎、血吸虫病填写）  1、急性  2、慢性
             AttackDate       = v_AttackDate, --发病日期（病原携带者填初检日期或就诊日期）
             DiagDate         = v_DiagDate, --诊断日期
             DieDate          = v_DieDate, --死亡日期
             DiagICD10        = v_DiagICD10, --传染病病种(对应传染病诊断库)
             DiagName         = v_DiagName, --传染病病种名称
             INFECTOTHER_FLAG = v_INFECTOTHER_FLAG, --有无感染其他人[0无 1有]
             Memo             = v_Memo, --备注
             Correct_flag     = v_Correct_flag, --订正标志【0、未订正 1、已订正】
             Correct_Name     = v_Correct_Name, --订正病名
             Cancel_Reason    = v_Cancel_Reason, --退卡原因
             ReportDeptCode   = v_ReportDeptCode, --报告科室编号
             ReportDeptName   = v_ReportDeptName, --报告科室名称
             ReportDocCode    = v_ReportDocCode, --报告医生编号
             ReportDocName    = v_ReportDocName, --报告医生名称
             DoctorTEL        = v_DoctorTEL, --报告医生联系电话
             Report_Date      = v_Report_Date, --填卡时间
             State            = v_State, --报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报  7、作废】
             create_date      = nvl(v_create_date, create_date), --创建时间
             create_UserCode  = nvl(v_create_UserCode, create_UserCode), --创建人
             create_UserName  = nvl(v_create_UserName, create_UserName), --创建人
             create_deptCode  = nvl(v_create_deptCode, create_deptCode), --创建人科室
             create_deptName  = nvl(v_create_deptName, create_deptName), --创建人科室
             Modify_date      = nvl(v_Modify_date, Modify_date), --修改时间
             Modify_UserCode  = nvl(v_Modify_UserCode, Modify_UserCode), --修改人
             Modify_UserName  = nvl(v_Modify_UserName, Modify_UserName), --修改人
             Modify_deptCode  = nvl(v_Modify_deptCode, Modify_deptCode), --修改人科室
             Modify_deptName  = nvl(v_Modify_deptName, Modify_deptName), --修改人科室
             Audit_date       = nvl(v_Audit_date, Audit_date), --审核时间
             Audit_UserCode   = nvl(v_Audit_UserCode, Audit_UserCode), --审核人
             Audit_UserName   = nvl(v_Audit_UserName, Audit_UserName), --审核人
             Audit_deptCode   = nvl(v_Audit_deptCode, Audit_deptCode), --审核人科室
             Audit_deptName   = nvl(v_Audit_deptName, Audit_deptName), --审核人科室
             OtherDiag        = v_OtherDiag
      
       where Report_ID = v_Report_ID;
    
      --插入传染病报告卡操作流水
      insert into Zymosis_Report_SN
        (Report_SN_ID, --表流水号
         Report_ID, --传染病报告卡编号
         create_date, --创建时间
         create_UserCode, --创建人
         create_UserName, --创建人
         create_deptCode, --创建人科室
         create_deptName, --创建人科室
         State, --修改类型
         Memo --备注
         )
      values
        (seq_Zymosis_Report_SN_ID.Nextval, --表流水号
         v_Report_ID, --传染病报告卡编号
         to_char(sysdate, 'yyyy-mm-dd HH24:mi:ss'), --创建时间
         v_Modify_UserCode, --创建人
         v_Modify_UserName, --创建人
         v_Modify_deptCode, --创建人科室
         v_Modify_deptName, --创建人科室
         v_StateName, --修改类型
         '' --备注
         );
      open o_result for
        select v_Report_ID from dual;
    
    end if;
  
    --作废传染病报告卡信息
    IF v_edittype = '3' THEN
    
      update zymosis_report
         set /*Report_NO        = nvl(v_Report_NO, Report_NO), --报告卡卡号*/      Report_Type = nvl(v_Report_Type,
             Report_Type), --报告卡类型   1、初次报告  2、订正报告
             Noofinpat        = nvl(v_Noofinpat, Noofinpat), --首页序号
             PatID            = nvl(v_PatID, PatID), --住院号
             Name             = nvl(v_Name, Name), --患者姓名
             ParentName       = v_ParentName, --家长姓名
             IDNO             = v_IDNO, --身份证号码
             Sex              = nvl(v_Sex, Sex), --患者性别
             Birth            = v_Birth, --出生日期
             Age              = v_Age, --实足年龄
             Age_Unit         = v_AgeUnit, --实足年龄
             Organization     = v_Organization, --工作单位
             OfficePlace      = v_OfficePlace, --单位地址
             OfficeTEL        = v_OfficeTEL, --单位电话
             AddressType      = nvl(v_AddressType, AddressType), --病人属于地区  1、本县区 2、本市区其他县区  3、本省其他地区  4、外省  5、港澳台  6、外籍
             HomeTown         = v_HomeTown, --家乡
             Address          = v_Address, --详细地址[村 街道 门牌号]
             JobID            = v_JobID, --职业代码（按页面顺序记录编号）
             RecordType1      = v_RecordType1, --病历分类  1、疑似病历  2、临床诊断病历  3、实验室确诊病历  4病原携带者
             RecordType2      = v_RecordType2, --病历分类（乙型肝炎、血吸虫病填写）  1、急性  2、慢性
             AttackDate       = v_AttackDate, --发病日期（病原携带者填初检日期或就诊日期）
             DiagDate         = v_DiagDate, --诊断日期
             DieDate          = v_DieDate, --死亡日期
             DiagICD10        = nvl(v_DiagICD10, DiagICD10), --传染病病种(对应传染病诊断库)
             DiagName         = nvl(v_DiagName, DiagName), --传染病病种名称
             INFECTOTHER_FLAG = v_INFECTOTHER_FLAG, --有无感染其他人[0无 1有]
             Memo             = v_Memo, --备注
             Correct_flag     = v_Correct_flag, --订正标志【0、未订正 1、已订正】
             Correct_Name     = v_Correct_Name, --订正病名
             Cancel_Reason    = v_Cancel_Reason, --退卡原因
             ReportDeptCode   = v_ReportDeptCode, --报告科室编号
             ReportDeptName   = v_ReportDeptName, --报告科室名称
             ReportDocCode    = v_ReportDocCode, --报告医生编号
             ReportDocName    = v_ReportDocName, --报告医生名称
             DoctorTEL        = v_DoctorTEL, --报告医生联系电话
             Report_Date      = v_Report_Date, --填卡时间
             State            = v_State, --报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报  7、作废】
             create_date      = nvl(v_create_date, create_date), --创建时间
             create_UserCode  = nvl(v_create_UserCode, create_UserCode), --创建人
             create_UserName  = nvl(v_create_UserName, create_UserName), --创建人
             create_deptCode  = nvl(v_create_deptCode, create_deptCode), --创建人科室
             create_deptName  = nvl(v_create_deptName, create_deptName), --创建人科室
             Modify_date      = nvl(v_Modify_date, Modify_date), --修改时间
             Modify_UserCode  = nvl(v_Modify_UserCode, Modify_UserCode), --修改人
             Modify_UserName  = nvl(v_Modify_UserName, Modify_UserName), --修改人
             Modify_deptCode  = nvl(v_Modify_deptCode, Modify_deptCode), --修改人科室
             Modify_deptName  = nvl(v_Modify_deptName, Modify_deptName), --修改人科室
             Audit_date       = nvl(v_Audit_date, Audit_date), --审核时间
             Audit_UserCode   = nvl(v_Audit_UserCode, Audit_UserCode), --审核人
             Audit_UserName   = nvl(v_Audit_UserName, Audit_UserName), --审核人
             Audit_deptCode   = nvl(v_Audit_deptCode, Audit_deptCode), --审核人科室
             Audit_deptName   = nvl(v_Audit_deptName, Audit_deptName), --审核人科室
             OtherDiag        = v_OtherDiag,
             vaild            = 0
      
       where Report_ID = v_Report_ID;
    
      insert into Zymosis_Report_SN
        (Report_SN_ID, --表流水号
         Report_ID, --传染病报告卡编号
         create_date, --创建时间
         create_UserCode, --创建人
         create_UserName, --创建人
         create_deptCode, --创建人科室
         create_deptName, --创建人科室
         State, --修改类型
         Memo --备注
         )
      values
        (seq_Zymosis_Report_SN_ID.Nextval, --表流水号
         v_Report_ID, --传染病报告卡编号
         to_char(sysdate, 'yyyy-mm-dd HH24:mi:ss'), --创建时间
         v_Modify_UserCode, --创建人
         v_Modify_UserName, --创建人
         v_Modify_deptCode, --创建人科室
         v_Modify_deptName, --创建人科室
         v_StateName, --修改类型
         '' --备注
         );
    
      open o_result for
        select v_Report_ID from dual;
    
    end if;
  
    --根据传入的传染病报告卡ID查询报告卡信息
    IF v_edittype = '4' THEN
    
      open o_result for
        select * from zymosis_report a where a.report_id = v_Report_ID;
    
    end if;
  
  end;

  /*********************************************************************************/

  PROCEDURE usp_GetInpatientByNofinpat(v_Noofinpat varchar default '', --首页序号
                                       o_result    OUT empcurtyp) as
    /*
    * 在传染病报告卡模块中新增报告卡时候根据病人首页号获取病人信息
    */
  begin
  
    open o_result for
      select inp.noofinpat,
             inp.patid,
             inp.patnoofhis,
             inp.name,
             inp.sexid,
             inp.birth,
             (case
               when instr(inp.agestr, '岁') > 1 then
                replace(inp.agestr, '岁')
               when instr(inp.agestr, '月') > 1 then
                replace(inp.agestr, '个月')
               else
                ''
             end) age,
             (case
               when instr(inp.agestr, '岁') > 1 then
                '1'
               when instr(inp.agestr, '月') > 1 then
                '2'
               else
                ''
             end) ageUint,
             inp.idno,
             inp.officeplace organization,
             inp.officeplace,
             inp.officetel,
             inp.outhosdept,
             --inp.address,--原来的地址
             inp.nativeaddress, --edit by ywk 2012年3月26日15:26:44 改为这个地址
             inp.attend,
             to_char(sysdate, 'yyyy-mm-dd') reportdate
        from inpatient inp
       where inp.noofinpat = v_Noofinpat;
  end;

  PROCEDURE usp_geteditzymosisreport(v_report_type1    varchar default '',
                                     v_report_type2    varchar default '',
                                     v_name            varchar default '',
                                     v_patid           varchar default '',
                                     v_deptid          varchar default '',
                                     v_applicant       varchar default '',
                                     v_status          varchar default '',
                                     v_createdatestart varchar default '', --新增的上报日期开始
                                     v_createdateend   varchar default '', --新增的上报日期结束
                                     v_querytype       varchar default '', --查询类型
                                     o_result          OUT empcurtyp) as
  begin
    if v_querytype = '1' THEN
      --有时间限制
      open o_result for
        SELECT report_id,
               report_no,
               CASE report_type
                 WHEN '1' THEN
                  '初步报告'
                 ELSE
                  '订正报告'
               END REPORTTYPENAME,
               noofinpat,
               patid,
               NAME,
               state,
               create_date,
               create_deptcode,
               create_deptcode
          FROM zymosis_report
         WHERE ((v_report_type1 IS NOT NULL AND
               zymosis_report.report_type = '1') OR
               (v_report_type2 IS NOT NULL AND
               zymosis_report.report_type = '2'))
           AND zymosis_report.name like '%' || v_name || '%'
           AND zymosis_report.patid like '%' || v_patid || '%'
           AND zymosis_report.create_deptcode like '%' || v_deptid || '%'
           AND (v_applicant IS NULL OR
               v_applicant IS NOT NULL AND
               zymosis_report.create_usercode = v_applicant)
           AND instr(v_status, zymosis_report.state) > 0
           AND create_date between v_createdatestart || ' 00:00:00' and
               v_createdateend || ' 23:59:59'; --更改为时间段 
    end if;
  
    if v_querytype = '2' THEN
      --无时间限制
      open o_result for
        SELECT report_id,
               report_no,
               CASE report_type
                 WHEN '1' THEN
                  '初步报告'
                 ELSE
                  '订正报告'
               END REPORTTYPENAME,
               noofinpat,
               patid,
               NAME,
               state,
               create_date,
               create_deptcode,
               create_deptcode
          FROM zymosis_report
         WHERE ((v_report_type1 IS NOT NULL AND
               zymosis_report.report_type = '1') OR
               (v_report_type2 IS NOT NULL AND
               zymosis_report.report_type = '2'))
           AND zymosis_report.name like '%' || v_name || '%'
           AND zymosis_report.patid like '%' || v_patid || '%'
           AND zymosis_report.create_deptcode like '%' || v_deptid || '%'
           AND (v_applicant IS NULL OR
               v_applicant IS NOT NULL AND
               zymosis_report.create_usercode = v_applicant)
           AND instr(v_status, zymosis_report.state) > 0;
    end if;
  
  end;

  PROCEDURE usp_getReportBrowse(v_report_type1 varchar default '',
                                v_report_type2 varchar default '',
                                v_recordtype1  varchar default '',
                                v_beginDate    varchar default '',
                                v_EndDate      varchar default '',
                                v_deptid       varchar default '',
                                v_diagICD      varchar default '',
                                v_status       varchar default '',
                                o_result       OUT empcurtyp) as
  begin
  
    open o_result for
      select rep.name,
             rep.report_id,
             rep.report_no,
             CASE report_type
               WHEN '1' THEN
                '初步报告'
               ELSE
                '订正报告'
             END REPORTTYPENAME,
             rep.sex as sexid, --add by cyq 2012-11-16
             (case
               when rep.sex = '1' then
                '男'
               when rep.sex = '2' then
                '女'
             end) sexstr,
             rep.birth,
             (case
               when rep.birth is not null then
                GetYearAgeByBirthAndApplyDate(to_date(rep.birth,
                                                      'yyyy-mm-dd'),
                                              to_date(rep.create_date,
                                                      'yyyy-mm-dd HH24:mi:ss'))
               when rep.birth is null then
                rep.age || (case
                  when rep.age_unit = '1' then
                   '岁'
                  when rep.age_unit = '2' then
                   '月'
                  when rep.age_unit = '3' then
                   '天'
                end)
             end) agestr,
             rep.diagicd10,
             rep.diagname,
             rep.address,
             rep.reportdeptcode,
             rep.reportdeptname,
             (case
               when rep.recordtype1 = '1' then
                '疑似病例'
               when rep.recordtype1 = '2' then
                '临床诊断病例'
               when rep.recordtype1 = '3' then
                '实验室确诊病例'
               when rep.recordtype1 = '4' then
                '病原携带者'
             end) recordtype1,
             job.jobname jobname,
             rep.create_date,
             rep.create_usercode,
             rep.create_username,
             (case
               when rep.state = '1' then
                '新增'
               when rep.state = '2' then
                '提交'
               when rep.state = '3' then
                '撤回'
               when rep.state = '4' then
                '审核通过'
               when rep.state = '5' then
                '审核未通过撤回'
               when rep.state = '6' then
                '上报'
               when rep.state = '7' then
                '作废'
             end) stateName
        from zymosis_report rep
        left join zymosis_job job
          on rep.jobid = job.jobid
       WHERE ((v_report_type1 IS NOT NULL AND rep.report_type = '1') OR
             (v_report_type2 IS NOT NULL AND rep.report_type = '2'))
         AND v_begindate || ' 00:00:00' <= rep.create_date
         AND rep.create_date <= v_enddate || ' 23:59:59'
         and (rep.recordtype1 = v_recordtype1 or v_recordtype1 = '' or
             v_recordtype1 is null)
         AND (rep.reportdeptcode = v_deptid or v_deptid = '' or
             v_deptid is null)
         AND (rep.diagicd10 = v_diagICD or v_diagICD = '' or
             v_diagICD is null)
         AND instr(v_status, rep.state) > 0;
  
  end;

  ---获取传染病分析信息
  PROCEDURE usp_GetReportAnalyse(v_beginDate varchar default '',
                                 v_EndDate   varchar default '',
                                 o_result    OUT empcurtyp) as
  
    v_sql    VARCHAR2(4000);
    v_cnt    integer;
    v_diecnt integer;
  begin
  
    v_sql := 'truncate table tmp_Zymosis_Analyse ';
  
    EXECUTE IMMEDIATE v_sql;
  
    --插入所有传染病信息
    INSERT INTO tmp_Zymosis_Analyse
      (level_id, level_name, ICD_Code, Name)
      select a.level_id,
             (case
               when a.level_id = 1 then
                '甲类传染病'
               when a.level_id = 2 then
                '乙类传染病'
               when a.level_id = 3 then
                '丙类传染病'
               else
                '其他传染病'
             end) level_Name,
             a.icd,
             a.name
        from Zymosis_Diagnosis a;
  
    --更新发病数
    UPDATE tmp_Zymosis_Analyse tmp
       SET Cnt = NVL((SELECT COUNT(distinct rep.noofinpat)
                       FROM zymosis_report rep
                      WHERE rep.diagicd10 = tmp.icd_code
                        and rep.vaild = 1
                        AND v_begindate || ' 00:00:00' <= rep.create_date
                        AND rep.create_date <= v_enddate || ' 23:59:59'
                        and rep.state in (4, 6)),
                     0);
  
    --更新死亡数
    UPDATE tmp_Zymosis_Analyse tmp
       SET Die_Cnt = NVL((SELECT COUNT(distinct rep.noofinpat)
                           FROM zymosis_report rep
                          WHERE rep.diagicd10 = tmp.icd_code
                            and rep.diedate is not null
                            and rep.vaild = 1
                            AND v_begindate || ' 00:00:00' <=
                                rep.create_date
                            AND rep.create_date <= v_enddate || ' 23:59:59'
                            and rep.state in (4, 6)),
                         0);
  
    --插入其他病种传染病
    INSERT INTO tmp_Zymosis_Analyse
      (level_id, level_name, ICD_Code, Name)
      select distinct 4, '其他' level_Name, '', a.otherdiag
        from zymosis_report a
       where a.diagicd10 is null;
  
    --更新发病数
    UPDATE tmp_Zymosis_Analyse tmp
       SET Cnt = NVL((SELECT COUNT(distinct rep.noofinpat)
                       FROM zymosis_report rep
                      WHERE rep.otherdiag = tmp.name
                        and rep.vaild = 1
                        and rep.diagicd10 is null
                        AND v_begindate || ' 00:00:00' <= rep.create_date
                        AND rep.create_date <= v_enddate || ' 23:59:59'
                        and rep.state in (4, 6)),
                     0)
     where tmp.icd_code is null;
  
    --更新死亡数
    UPDATE tmp_Zymosis_Analyse tmp
       SET Die_Cnt = NVL((SELECT COUNT(distinct rep.noofinpat)
                           FROM zymosis_report rep
                          WHERE rep.otherdiag = tmp.name
                            and rep.diedate is not null
                            and rep.vaild = 1
                            and rep.diagicd10 is null
                            AND v_begindate || ' 00:00:00' <=
                                rep.create_date
                            AND rep.create_date <= v_enddate || ' 23:59:59'
                            and rep.state in (4, 6)),
                         0)
     where tmp.icd_code is null;
  
    select sum(cnt) into v_cnt from tmp_Zymosis_Analyse;
    select sum(die_cnt) into v_diecnt from tmp_Zymosis_Analyse;
  
    --更新发病数占总发病数百分比
    UPDATE tmp_Zymosis_Analyse tmp
       SET Attack_rate = (case
                           when v_cnt = 0 then
                            0
                           else
                            to_number(cnt) / v_cnt * 100
                         end);
  
    --更新死亡数占总发病数百分比
    UPDATE tmp_Zymosis_Analyse tmp
       SET Die_Rate = (case
                        when v_diecnt = 0 then
                         0
                        else
                         to_number(Die_Cnt) / v_diecnt * 100
                      end);
  
    commit;
  
    open o_result for
    /* select a.level_id,
                                                                                                                                         a.level_name,
                                                                                                                                         a.ICD_Code,
                                                                                                                                         a.Name,
                                                                                                                                         a.cnt,
                                                                                                                                         a.attack_rate || '%' attack_rate,
                                                                                                                                         a.die_cnt,
                                                                                                                                         a.die_rate || '%' die_rate,
                                                                                                                                         (case
                                                                                                                                           when a.cnt = 0 then
                                                                                                                                            0
                                                                                                                                           else
                                                                                                                                            a.die_cnt / a.cnt * 100
                                                                                                                                         end) dieRate
                                                                                                                                    from tmp_Zymosis_Analyse a;*/
      select *
        from (select a.level_id,
                     a.level_name,
                     a.ICD_Code,
                     a.Name,
                     a.cnt,
                     a.attack_rate,
                     a.die_cnt,
                     a.die_rate,
                     round((case
                             when a.cnt = 0 then
                              0
                             else
                              a.die_cnt / a.cnt * 100
                           end),
                           4) dieRate
                from tmp_Zymosis_Analyse a
              
              union all
              
              select a.level_id,
                     '总计' level_name,
                     '' ICD_Code,
                     '小计' Name,
                     to_char(sum(a.cnt)) cnt,
                     sum(a.attack_rate) attack_rate,
                     to_char(sum(a.die_cnt)) die_cnt,
                     sum(a.die_rate) die_rate,
                     round((case
                             when sum(a.cnt) = 0 then
                              0
                             else
                              sum(a.die_cnt) / sum(a.cnt) * 100
                           end),
                           4) dieRate
                from tmp_Zymosis_Analyse a
               group by a.level_id)
       order by level_id, level_name;
  
  end;

  --分职业统计传染病情况
  PROCEDURE usp_GetJobDisease(v_beginDate varchar default '',
                              v_EndDate   varchar default '',
                              v_DiagCode  varchar default '',
                              o_result    OUT empcurtyp) as
    v_sql     VARCHAR2(4000);
    v_jobID   varchar2(4);
    v_jobName varchar2(14);
  begin
    v_sql := 'truncate table tmp_JobDisease ';
  
    EXECUTE IMMEDIATE v_sql;
  
    --定义游标
    declare
      cursor cr_JobDisease is
        select jobID, jobName from zymosis_job;
    
    begin
      open cr_JobDisease;
      fetch cr_JobDisease
        into v_jobID, v_jobName;
      while cr_JobDisease%found loop
      
        --游标循环插入值
        INSERT INTO tmp_JobDisease
          (JobID, JobName, DiagID, DiagName, DiseaseCnt, DieCnt)
          select v_jobID jobid, v_jobName jobName, a.icd, a.name, 0, 0
            from Zymosis_Diagnosis a
           where v_DiagCode like '%,' || a.icd || ',%';
      
        fetch cr_JobDisease
          into v_jobID, v_jobName;
      end loop;
    
      close cr_JobDisease;
    
    end;
  
    commit;
  
    --更新发病数
    UPDATE tmp_JobDisease tmp
       SET DiseaseCnt = NVL((SELECT COUNT(distinct rep.noofinpat)
                              FROM zymosis_report rep
                             WHERE rep.diagicd10 = tmp.diagid
                               and rep.jobid = tmp.jobid
                               and rep.vaild = 1
                               AND v_begindate || ' 00:00:00' <=
                                   rep.create_date
                               AND rep.create_date <=
                                   v_enddate || ' 23:59:59'
                               and rep.state in (4, 6)),
                            0);
  
    --更新死亡数
    UPDATE tmp_JobDisease tmp
       SET DieCnt = NVL((SELECT COUNT(distinct rep.noofinpat)
                          FROM zymosis_report rep
                         WHERE rep.diagicd10 = tmp.diagid
                           and rep.jobid = tmp.jobid
                           and rep.diedate is not null
                           and rep.vaild = 1
                           AND v_begindate || ' 00:00:00' <= rep.create_date
                           AND rep.create_date <= v_enddate || ' 23:59:59'
                           and rep.state in (4, 6)),
                        0);
    commit;
  
    open o_result for
    --select * from tmp_JobDisease;
      select * from tmp_JobDisease order by to_number(jobid);
    /*  --插入所有传染病信息
    INSERT INTO tmp_JobDisease
      (level_id, level_name, ICD_Code, Name)
      select a.level_id,
             (case
               when a.level_id = 1 then
                '甲类传染病'
               when a.level_id = 2 then
                '乙类传染病'
               when a.level_id = 3 then
                '丙类传染病'
               else
                '其他传染病'
             end) level_Name,
             a.icd,
             a.name
        from Zymosis_Diagnosis a;*/
  end;

  --得到所有有效的诊断
  PROCEDURE usp_GetDiagnosis(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT markid, icd, name, py, wb, memo, valid, statist, name namestr
        FROM DIAGNOSIS a
       where not exists
       (select 1 from zymosis_diagnosis d where d.icd = a.icd)
       order by icd;
  END;

  --得到所有有效的诊断
  PROCEDURE usp_GetDiagnosisTo(v_categoryid varchar default '',
                               o_result     OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT markid, icd, name, py, wb, memo, valid, statist, name namestr
        FROM DIAGNOSIS a
       where not exists (select 1
                from zymosis_diagnosis d
               where d.icd = a.icd
                 and (d.categoryid = v_categoryid or
                     v_categoryid = '' or v_categoryid is null))
         and a.valid = '1'
       order by icd;
  END;

  --得到所有有效的诊断
  PROCEDURE usp_GetDiagnosisTo_ZY(v_categoryid varchar default '',
                                  o_result     OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT ID as markid,
             ID AS icd,
             name,
             py,
             wb,
             memo,
             '' as statist,
             valid,
             name namestr
        FROM diagnosisofchinese a
       where not exists (select 1
                from zymosis_diagnosis d
               where d.icd = a.id
                 and (d.categoryid = v_categoryid or
                     v_categoryid = '' or v_categoryid is null))
         and a.valid = '1'
       order by icd;
  END;

  --得到传染病病种信息
  PROCEDURE usp_GetDisease2(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT (CASE
               WHEN a.level_id = 1 THEN
                '甲类传染病'
               WHEN a.level_id = 2 THEN
                '乙类传染病'
               WHEN a.level_id = 3 THEN
                '丙类传染病'
               ELSE
                '其他传染病'
             END) level_name,
             a.level_id,
             a.icd,
             a.NAME,
             a.py,
             a.wb,
             a.markid,
             a.memo,
             a.statist,
             CASE a.valid
               WHEN 1 THEN
                '有效'
               ELSE
                '无效'
             END valid_name,
             a.valid,
             a.namestr,
             a.upcount,
             a.fukatype
        FROM zymosis_diagnosis a
       where a.categoryid = 1
       order by a.icd;
  END;

  PROCEDURE usp_GetDisease2To(v_categoryid varchar default '',
                              o_result     OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      SELECT (CASE
               WHEN a.level_id = 1 THEN
                '甲类传染病'
               WHEN a.level_id = 2 THEN
                '乙类传染病'
               WHEN a.level_id = 3 THEN
                '丙类传染病'
               ELSE
                '其他传染病'
             END) level_name,
             a.level_id,
             a.icd,
             a.NAME,
             a.py,
             a.wb,
             a.markid,
             a.memo,
             a.statist,
             CASE a.valid
               WHEN 1 THEN
                '有效'
               ELSE
                '无效'
             END valid_name,
             a.valid,
             a.namestr,
             a.upcount,
             a.categoryid
      
        FROM zymosis_diagnosis a
       where a.categoryid = v_categoryid
       order by a.icd;
  END;

  --保存病种记录
  PROCEDURE usp_SaveZymosisDiagnosis(v_markid   varchar default '',
                                     v_icd      varchar default '',
                                     v_name     varchar default '',
                                     v_py       varchar default '',
                                     v_wb       varchar default '',
                                     v_levelID  varchar default '',
                                     v_valid    varchar default '',
                                     v_statist  varchar default '',
                                     v_memo     varchar default '',
                                     v_namestr  varchar default '',
                                     v_upcount  integer,
                                     v_fukatype varchar default '') AS
    p_count INT;
  BEGIN
    SELECT COUNT(1) INTO p_count FROM zymosis_diagnosis WHERE icd = v_icd;
  
    IF p_count > 0 THEN
      UPDATE zymosis_diagnosis
         SET markid   = v_markid,
             icd      = v_icd,
             name     = v_name,
             py       = v_py,
             wb       = v_wb,
             level_id = v_levelID,
             valid    = v_valid,
             memo     = v_memo,
             statist  = v_statist,
             namestr  = v_namestr,
             upcount  = v_upcount,
             fukatype = v_fukatype
       WHERE icd = v_icd;
    ELSE
      INSERT INTO zymosis_diagnosis
        (markid,
         icd,
         name,
         py,
         wb,
         level_id,
         valid,
         memo,
         statist,
         namestr,
         upcount,
         fukatype)
      VALUES
        (v_markid,
         v_icd,
         v_name,
         v_py,
         v_wb,
         v_levelID,
         v_valid,
         v_memo,
         v_statist,
         v_namestr,
         v_upcount,
         v_fukatype);
    END IF;
  END;

  --保存病种记录
  PROCEDURE usp_SaveZymosisDiagnosisTo(v_markid     varchar default '',
                                       v_icd        varchar default '',
                                       v_name       varchar default '',
                                       v_py         varchar default '',
                                       v_wb         varchar default '',
                                       v_levelID    varchar default '',
                                       v_valid      varchar default '',
                                       v_statist    varchar default '',
                                       v_memo       varchar default '',
                                       v_namestr    varchar default '',
                                       v_upcount    integer,
                                       v_categoryid integer) AS
    p_count INT;
  BEGIN
    SELECT COUNT(1)
      INTO p_count
      FROM zymosis_diagnosis
     WHERE icd = v_icd
       and categoryid = v_categoryid;
  
    IF p_count > 0 THEN
      UPDATE zymosis_diagnosis
         SET markid     = v_markid,
             icd        = v_icd,
             name       = v_name,
             py         = v_py,
             wb         = v_wb,
             level_id   = v_levelID,
             valid      = v_valid,
             memo       = v_memo,
             statist    = v_statist,
             namestr    = v_namestr,
             upcount    = v_upcount,
             categoryid = v_categoryid
       WHERE icd = v_icd
         and categoryid = v_categoryid;
    ELSE
      INSERT INTO zymosis_diagnosis
        (markid,
         icd,
         name,
         py,
         wb,
         level_id,
         valid,
         memo,
         statist,
         namestr,
         upcount,
         categoryid)
      VALUES
        (v_markid,
         v_icd,
         v_name,
         v_py,
         v_wb,
         v_levelID,
         v_valid,
         v_memo,
         v_statist,
         v_namestr,
         v_upcount,
         v_categoryid);
    END IF;
  END;

  /*********************************************************************************/
  PROCEDURE usp_EditTbirthdefects_Report(v_EditType         varchar,
                                         v_ID               NUMERIC DEFAULT 0,
                                         v_REPORT_NOOFINPAT varchar DEFAULT '', --病人编号
                                         v_REPORT_ID        varchar default '', --报告卡序号
                                         v_DIAG_CODE        varchar default '', --报告卡诊断编码
                                         
                                         v_STRING3         varchar default '', --预留
                                         v_STRING4         varchar default '', --预留
                                         v_STRING5         varchar default '', --预留
                                         v_REPORT_PROVINCE varchar default '', --上报告卡省份
                                         v_REPORT_CITY     varchar default '', --报告卡市（县）
                                         v_REPORT_TOWN     varchar default '', --报告卡乡镇
                                         v_REPORT_VILLAGE  varchar default '', --报告卡村
                                         v_REPORT_HOSPITAL varchar default '', --报告卡医院
                                         v_REPORT_NO       varchar default '', --报告卡序号
                                         v_MOTHER_PATID    varchar default '', --产妇住院号
                                         v_MOTHER_NAME     varchar default '', --姓名
                                         v_MOTHER_AGE      varchar default '', --年龄
                                         v_NATIONAL        varchar default '', --民族
                                         v_ADDRESS_POST    varchar default '', --地址and邮编
                                         v_PREGNANTNO      varchar default '', --孕次
                                         v_PRODUCTIONNO    varchar default '', --产次
                                         v_LOCALADD        varchar default '', --常住地
                                         
                                         v_PERCAPITAINCOME         varchar default '', --年人均收入     
                                         v_EDUCATIONLEVEL          varchar default '', --文化程度     
                                         v_CHILD_PATID             varchar default '', --孩子住院号     
                                         v_CHILD_NAME              varchar default '', --孩子姓名     
                                         v_ISBORNHERE              varchar default '', --是否本院出生     
                                         v_CHILD_SEX               varchar default '', --孩子性别      
                                         v_BORN_YEAR               varchar default '', --出生年     
                                         v_BORN_MONTH              varchar default '', --  出生月     
                                         v_BORN_DAY                varchar default '', --出生日      
                                         v_GESTATIONALAGE          varchar default '', --胎龄     
                                         v_WEIGHT                  varchar default '', --体重     
                                         v_BIRTHS                  varchar default '', --胎数     
                                         v_ISIDENTICAL             varchar default '', --是否同卵      
                                         v_OUTCOME                 varchar default '', --转归      
                                         v_INDUCEDLABOR            varchar default '', --是否引产     
                                         v_DIAGNOSTICBASIS         varchar default '', --诊断依据――临床      
                                         v_DIAGNOSTICBASIS1        varchar default '', --诊断依据――超声波      
                                         v_DIAGNOSTICBASIS2        varchar default '', --诊断依据――尸解     
                                         v_DIAGNOSTICBASIS3        varchar default '', --诊断依据――生化检查     
                                         v_DIAGNOSTICBASIS4        varchar default '', --诊断依据――生化检查――其他     
                                         v_DIAGNOSTICBASIS5        varchar default '', --诊断依据――染色体      
                                         v_DIAGNOSTICBASIS6        varchar default '', --诊断依据――其他     
                                         v_DIAGNOSTICBASIS7        varchar default '', --诊断依据――其他――内容     
                                         v_DIAG_ANENCEPHALY        varchar default '', --出生缺陷诊断――无脑畸形     
                                         v_DIAG_SPINA              varchar default '', --出生缺陷诊断――脊柱裂      
                                         v_DIAG_PENGOUT            varchar default '', --出生缺陷诊断――脑彭出      
                                         v_DIAG_HYDROCEPHALUS      varchar default '', --出生缺陷诊断――先天性脑积水     
                                         v_DIAG_CLEFTPALATE        varchar default '', --出生缺陷诊断――腭裂     
                                         v_DIAG_CLEFTLIP           varchar default '', --出生缺陷诊断――唇裂      
                                         v_DIAG_CLEFTMERGER        varchar default '', --出生缺陷诊断――唇裂合并腭裂     
                                         v_DIAG_SMALLEARS          varchar default '', --出生缺陷诊断――小耳（包括无耳）     
                                         v_DIAG_OUTEREAR           varchar default '', --出生缺陷诊断――外耳其它畸形（小耳、无耳除外）     
                                         v_DIAG_ESOPHAGEAL         varchar default '', --出生缺陷诊断――食道闭锁或狭窄     
                                         v_DIAG_RECTUM             varchar default '', --出生缺陷诊断――直肠肛门闭锁或狭窄（包括无肛）     
                                         v_DIAG_HYPOSPADIAS        varchar default '', --出生缺陷诊断――尿道下裂     
                                         v_DIAG_BLADDER            varchar default '', --出生缺陷诊断――膀胱外翻     
                                         v_DIAG_HORSESHOEFOOTLEFT  varchar default '', --出生缺陷诊断――马蹄内翻足_左      
                                         v_DIAG_HORSESHOEFOOTRIGHT varchar default '', --出生缺陷诊断――马蹄内翻足_右     
                                         v_DIAG_MANYPOINTLEFT      varchar default '', --出生缺陷诊断――多指（趾）_左      
                                         v_DIAG_MANYPOINTRIGHT     varchar default '', --出生缺陷诊断――多指（趾）_右     
                                         v_DIAG_LIMBSUPPERLEFT     varchar default '', --出生缺陷诊断――肢体短缩_上肢 _左      
                                         v_DIAG_LIMBSUPPERRIGHT    varchar default '', --出生缺陷诊断――肢体短缩_上肢 _右     
                                         v_DIAG_LIMBSLOWERLEFT     varchar default '', --出生缺陷诊断――肢体短缩_下肢 _左      
                                         v_DIAG_LIMBSLOWERRIGHT    varchar default '', --出生缺陷诊断――肢体短缩_下肢 _右     
                                         v_DIAG_HERNIA             varchar default '', --出生缺陷诊断――先天性膈疝     
                                         v_DIAG_BULGINGBELLY       varchar default '', --出生缺陷诊断――脐膨出     
                                         v_DIAG_GASTROSCHISIS      varchar default '', --出生缺陷诊断――腹裂     
                                         v_DIAG_TWINS              varchar default '', --出生缺陷诊断――联体双胎     
                                         v_DIAG_TSSYNDROME         varchar default '', --出生缺陷诊断――唐氏综合征（21-三体综合征）     
                                         v_DIAG_HEARTDISEASE       varchar default '', --出生缺陷诊断――先天性心脏病（类型）      
                                         v_DIAG_OTHER              varchar default '', --出生缺陷诊断――其他（写明病名或详细描述）      
                                         v_DIAG_OTHERCONTENT       varchar default '', --出生缺陷诊断――其他内容      
                                         v_FEVER                   varchar default '', --发烧（＞38℃）      
                                         v_VIRUSINFECTION          varchar default '', --病毒感染     
                                         v_ILLOTHER                varchar default '', --患病其他     
                                         v_SULFA                   varchar default '', --磺胺类     
                                         v_ANTIBIOTICS             varchar default '', --抗生素     
                                         v_BIRTHCONTROLPILL        varchar default '', --避孕药      
                                         v_SEDATIVES               varchar default '', --镇静药     
                                         v_MEDICINEOTHER           varchar default '', --服药其他      
                                         v_DRINKING                varchar default '', --饮酒     
                                         v_PESTICIDE               varchar default '', --农药      
                                         v_RAY                     varchar default '', --射线      
                                         v_CHEMICALAGENTS          varchar default '', --化学制剂     
                                         v_FACTOROTHER             varchar default '', --其他有害因素      
                                         v_STILLBIRTHNO            varchar default '', --死胎例数     
                                         v_ABORTIONNO              varchar default '', --自然流产例数     
                                         v_DEFECTSNO               varchar default '', --缺陷儿例数     
                                         v_DEFECTSOF1              varchar default '', --缺陷名1     
                                         v_DEFECTSOF2              varchar default '', --缺陷名2     
                                         v_DEFECTSOF3              varchar default '', --缺陷名3     
                                         v_YCDEFECTSOF1            varchar default '', --遗传缺陷名1     
                                         v_YCDEFECTSOF2            varchar default '', --遗传缺陷名2     
                                         v_YCDEFECTSOF3            varchar default '', --遗传缺陷名3     
                                         v_KINSHIPDEFECTS1         varchar default '', --与缺陷儿亲缘关系1     
                                         v_KINSHIPDEFECTS2         varchar default '', --与缺陷儿亲缘关系2     
                                         v_KINSHIPDEFECTS3         varchar default '', --与缺陷儿亲缘关系3     
                                         v_COUSINMARRIAGE          varchar default '', --近亲婚配史      
                                         v_COUSINMARRIAGEBETWEEN   varchar default '', --近亲婚配史关系     
                                         v_PREPARER                varchar default '', --填表人      
                                         v_THETITLE1               varchar default '', --填表人职称     
                                         v_FILLDATEYEAR            varchar default '', --填表日期年      
                                         v_FILLDATEMONTH           varchar default '', --填表日期月     
                                         v_FILLDATEDAY             varchar default '', --填表日期日     
                                         v_HOSPITALREVIEW          varchar default '', --医院审表人      
                                         v_THETITLE2               varchar default '', --医院审表人职称     
                                         v_HOSPITALAUDITDATEYEAR   varchar default '', --医院审表日期年     
                                         v_HOSPITALAUDITDATEMONTH  varchar default '', --医院审表日期月      
                                         v_HOSPITALAUDITDATEDAY    varchar default '', --医院审表日期日      
                                         v_PROVINCIALVIEW          varchar default '', --省级审表人      
                                         v_THETITLE3               varchar default '', --省级审表人职称     
                                         v_PROVINCIALVIEWDATEYEAR  varchar default '', --省级审表日期年      
                                         v_PROVINCIALVIEWDATEMONTH varchar default '', --省级审表日期月     
                                         v_PROVINCIALVIEWDATEDAY   varchar default '', --省级审表日期日     
                                         v_FEVERNO                 varchar default '', --发烧度数      
                                         v_ISVIRUSINFECTION        varchar default '', --是否病毒感染     
                                         v_ISDIABETES              varchar default '', --是否糖尿病      
                                         v_ISILLOTHER              varchar default '', --是否患病其他     
                                         v_ISSULFA                 varchar default '', --是否磺胺类     
                                         v_ISANTIBIOTICS           varchar default '', --是否抗生素     
                                         v_ISBIRTHCONTROLPILL      varchar default '', --是否避孕药      
                                         v_ISSEDATIVES             varchar default '', --是否镇静药     
                                         v_ISMEDICINEOTHER         varchar default '', --是否服药其他      
                                         v_ISDRINKING              varchar default '', --是否饮酒     
                                         v_ISPESTICIDE             varchar default '', --是否农药      
                                         v_ISRAY                   varchar default '', --是否射线      
                                         v_ISCHEMICALAGENTS        varchar default '', --是否化学制剂     
                                         v_ISFACTOROTHER           varchar default '', --是否其他有害因素      
                                         v_STATE                   varchar default '', -- "报告状态【 1、新增保存 2、提交 3、撤回 4、?to open this dialog next """     
                                         v_CREATE_DATE             varchar default '', --创建时间      
                                         v_CREATE_USERCODE         varchar default '', --创建人     
                                         v_CREATE_USERNAME         varchar default '', ---创建人      
                                         v_CREATE_DEPTCODE         varchar default '', --创建人科室     
                                         v_CREATE_DEPTNAME         varchar default '', --创建人科室     
                                         v_MODIFY_DATE             varchar default '', --修改时间      
                                         v_MODIFY_USERCODE         varchar default '', --修改人     
                                         v_MODIFY_USERNAME         varchar default '', --修改人     
                                         v_MODIFY_DEPTCODE         varchar default '', --修改人科室     
                                         v_MODIFY_DEPTNAME         varchar default '', --修改人科室     
                                         v_AUDIT_DATE              varchar default '', --审核时间     
                                         v_AUDIT_USERCODE          varchar default '', --审核人      
                                         v_AUDIT_USERNAME          varchar default '', --审核人      
                                         v_AUDIT_DEPTCODE          varchar default '', --审核人科室      
                                         v_AUDIT_DEPTNAME          varchar default '', --审核人科室      
                                         v_VAILD                   varchar default '', --状态是否有效  1、有效   0、无效     
                                         v_CANCELREASON            varchar default '', --否决原因     
                                         v_PRENATAL                varchar default '', --产前     
                                         v_PRENATALNO              varchar default '', --产前周数     
                                         v_POSTPARTUM              varchar default '', --产后     
                                         v_ANDTOSHOWLEFT           varchar default '', --并指左     
                                         v_ANDTOSHOWRIGHT          varchar default '', --并指右
                                         o_result                  OUT empcurtyp) AS
  
    v_ID_new int;
  BEGIN
  
    --新增传染病报告卡
    IF v_edittype = '1' THEN
    
      select SEQ_BIRTHDEFECTS.Nextval into v_ID_new from dual;
    
      insert into BIRTHDEFECTSCARD
        (ID, --序号
         REPORT_NOOFINPAT, --病案首页编号
         REPORT_ID, --  报告卡序号
         DIAG_CODE, --  病种编号
         STRING3, --  预留4
         STRING4, --  预留5
         STRING5, --  预留6
         REPORT_PROVINCE, --  报告卡省份
         REPORT_CITY, --  报告卡市（县）
         REPORT_TOWN, --  报告卡乡镇-----10
         REPORT_VILLAGE, -- 报告卡村
         REPORT_HOSPITAL, --  报告卡医院
         REPORT_NO, --右上方不明框框
         MOTHER_PATID, -- 产妇住院号
         MOTHER_NAME, --  姓名
         MOTHER_AGE, -- 年龄
         NATIONAL, -- 民族
         ADDRESS_POST, -- 地址and邮编
         PREGNANTNO, -- 孕次
         PRODUCTIONNO, -- 产次-----20
         LOCALADD, -- 常住地
         PERCAPITAINCOME, --  年人均收入
         EDUCATIONLEVEL, -- 文化程度
         CHILD_PATID, --  孩子住院号
         CHILD_NAME, -- 孩子姓名
         ISBORNHERE, -- 是否本院出生
         CHILD_SEX, --孩子性别
         BORN_YEAR, --  出生年
         BORN_MONTH, -- 出生月
         BORN_DAY, -- 出生日--30
         
         GESTATIONALAGE, -- 胎龄
         WEIGHT, -- 体重
         BIRTHS, -- 胎数
         ISIDENTICAL, --  是否同卵
         OUTCOME, --  转归
         INDUCEDLABOR, -- 是否引产
         DIAGNOSTICBASIS, --  诊断依据――临床
         DIAGNOSTICBASIS1, -- 诊断依据――超声波
         DIAGNOSTICBASIS2, -- 诊断依据――尸解
         DIAGNOSTICBASIS3, -- 诊断依据――生化检查--40
         
         DIAGNOSTICBASIS4, -- 诊断依据――生化检查――其他
         DIAGNOSTICBASIS5, -- 诊断依据――染色体
         DIAGNOSTICBASIS6, -- 诊断依据――其他
         DIAGNOSTICBASIS7, -- 诊断依据――其他――内容
         DIAG_ANENCEPHALY, -- 出生缺陷诊断――无脑畸形
         DIAG_SPINA, -- 出生缺陷诊断――脊柱裂
         DIAG_PENGOUT, -- 出生缺陷诊断――脑彭出
         DIAG_HYDROCEPHALUS, -- 出生缺陷诊断――先天性脑积水
         DIAG_CLEFTPALATE, -- 出生缺陷诊断――腭裂
         DIAG_CLEFTLIP, --  出生缺陷诊断――唇裂--50
         
         DIAG_CLEFTMERGER, -- 出生缺陷诊断――唇裂合并腭裂
         DIAG_SMALLEARS, -- 出生缺陷诊断――小耳（包括无耳）
         DIAG_OUTEREAR, --  出生缺陷诊断――外耳其它畸形（小耳、无耳除外）
         DIAG_ESOPHAGEAL, --  出生缺陷诊断――食道闭锁或狭窄
         DIAG_RECTUM, --  出生缺陷诊断――直肠肛门闭锁或狭窄（包括无肛）
         DIAG_HYPOSPADIAS, -- 出生缺陷诊断――尿道下裂
         DIAG_BLADDER, -- 出生缺陷诊断――膀胱外翻
         DIAG_HORSESHOEFOOTLEFT, -- 出生缺陷诊断――马蹄内翻足_左 
         DIAG_HORSESHOEFOOTRIGHT, --  出生缺陷诊断――马蹄内翻足_右
         DIAG_MANYPOINTLEFT, -- 出生缺陷诊断――多指（趾）_左--60
         
         DIAG_MANYPOINTRIGHT, --  出生缺陷诊断――多指（趾）_右
         DIAG_LIMBSUPPERLEFT, --  出生缺陷诊断――肢体短缩_上肢 _左
         DIAG_LIMBSUPPERRIGHT, -- 出生缺陷诊断――肢体短缩_上肢 _右
         DIAG_LIMBSLOWERLEFT, --  出生缺陷诊断――肢体短缩_下肢 _左
         DIAG_LIMBSLOWERRIGHT, -- 出生缺陷诊断――肢体短缩_下肢 _右
         DIAG_HERNIA, --  出生缺陷诊断――先天性膈疝
         DIAG_BULGINGBELLY, --  出生缺陷诊断――脐膨出
         DIAG_GASTROSCHISIS, -- 出生缺陷诊断――腹裂
         DIAG_TWINS, -- 出生缺陷诊断――联体双胎
         DIAG_TSSYNDROME, --  出生缺陷诊断――唐氏综合征（21-三体综合征）--70
         
         DIAG_HEARTDISEASE, --  出生缺陷诊断――先天性心脏病（类型）
         DIAG_OTHER, -- 出生缺陷诊断――其他（写明病名或详细描述）
         DIAG_OTHERCONTENT, --  出生缺陷诊断――其他内容
         FEVER, --  发烧（＞38℃）
         VIRUSINFECTION, -- 病毒感染
         ILLOTHER, -- 患病其他
         SULFA, --  磺胺类
         ANTIBIOTICS, --  抗生素
         BIRTHCONTROLPILL, -- 避孕药
         SEDATIVES, --  镇静药
         
         MEDICINEOTHER, --  服药其他
         DRINKING, -- 饮酒
         PESTICIDE, --  农药
         RAY, --  射线
         CHEMICALAGENTS, -- 化学制剂
         FACTOROTHER, --  其他有害因素
         STILLBIRTHNO, -- 死胎例数
         ABORTIONNO, -- 自然流产例数
         DEFECTSNO, --  缺陷儿例数
         DEFECTSOF1, -- 缺陷名1--90
         
         DEFECTSOF2, -- 缺陷名2
         DEFECTSOF3, -- 缺陷名3
         YCDEFECTSOF1, -- 遗传缺陷名1
         YCDEFECTSOF2, -- 遗传缺陷名2
         YCDEFECTSOF3, -- 遗传缺陷名3
         KINSHIPDEFECTS1, --  与缺陷儿亲缘关系1
         KINSHIPDEFECTS2, --  与缺陷儿亲缘关系2
         KINSHIPDEFECTS3, --  与缺陷儿亲缘关系3
         COUSINMARRIAGE, -- 近亲婚配史
         COUSINMARRIAGEBETWEEN, --  近亲婚配史关系
         PREPARER, -- 填表人
         THETITLE1, --  填表人职称
         FILLDATEYEAR, -- 填表日期年
         FILLDATEMONTH, --  填表日期月
         FILLDATEDAY, --  填表日期日
         HOSPITALREVIEW, -- 医院审表人
         THETITLE2, --  医院审表人职称
         HOSPITALAUDITDATEYEAR, --  医院审表日期年
         HOSPITALAUDITDATEMONTH, -- 医院审表日期月
         HOSPITALAUDITDATEDAY, -- 医院审表日期日
         PROVINCIALVIEW, -- 省级审表人
         THETITLE3, --  省级审表人职称
         PROVINCIALVIEWDATEYEAR, -- 省级审表日期年
         PROVINCIALVIEWDATEMONTH, --  省级审表日期月
         PROVINCIALVIEWDATEDAY, --  省级审表日期日
         FEVERNO, --  发烧度数
         ISVIRUSINFECTION, -- 是否病毒感染
         ISDIABETES, -- 是否糖尿病
         ISILLOTHER, -- 是否患病其他
         ISSULFA, --  是否磺胺类--120
         
         ISANTIBIOTICS, --  是否抗生素
         ISBIRTHCONTROLPILL, -- 是否避孕药
         ISSEDATIVES, --  是否镇静药
         ISMEDICINEOTHER, --  是否服药其他
         ISDRINKING, -- 是否饮酒
         ISPESTICIDE, --  是否农药
         ISRAY, --  是否射线
         ISCHEMICALAGENTS, -- 是否化学制剂
         ISFACTOROTHER, --  是否其他有害因素
         STATE, --  "报告状态【 1、新增保存 2、提交 3、撤回 4、?to open this dialog next """
         CREATE_DATE, --  创建时间
         CREATE_USERCODE, --  创建人
         CREATE_USERNAME, --  创建人
         CREATE_DEPTCODE, --  创建人科室
         CREATE_DEPTNAME, --  创建人科室
         MODIFY_DATE, --  修改时间
         MODIFY_USERCODE, --  修改人
         MODIFY_USERNAME, --  修改人
         MODIFY_DEPTCODE, --  修改人科室
         MODIFY_DEPTNAME, --  修改人科室
         AUDIT_DATE, -- 审核时间
         AUDIT_USERCODE, -- 审核人
         AUDIT_USERNAME, -- 审核人
         AUDIT_DEPTCODE, -- 审核人科室
         AUDIT_DEPTNAME, -- 审核人科室
         VAILD, --  状态是否有效  1、有效   0、无效
         CANCELREASON, -- 否决原因
         PRENATAL, -- 产前
         PRENATALNO, -- 产前周数
         POSTPARTUM, -- 产后--150
         
         ANDTOSHOWLEFT, --  并指左
         ANDTOSHOWRIGHT) --并指右
      
      values
        (v_ID_new, --序号
         v_REPORT_NOOFINPAT,
         v_Report_ID,
         v_DIAG_CODE, --报告卡诊断编码
         v_STRING3, --预留
         v_STRING4, --预留
         v_STRING5, --预留
         v_REPORT_PROVINCE, --上报告卡省份
         v_REPORT_CITY, --报告卡市（县）
         v_REPORT_TOWN, --报告卡乡镇--------10
         v_REPORT_VILLAGE, --报告卡村
         v_REPORT_HOSPITAL, --报告卡医院
         v_REPORT_NO, --报告卡序号
         v_MOTHER_PATID, --产妇住院号
         v_MOTHER_NAME, --姓名
         v_MOTHER_AGE, --年龄
         v_NATIONAL, --民族
         v_ADDRESS_POST, --地址and邮编
         v_PREGNANTNO, --孕次
         v_PRODUCTIONNO, --产次----------=20
         v_LOCALADD, --常住地
         v_PERCAPITAINCOME, --  年人均收入
         v_EDUCATIONLEVEL, -- 文化程度
         v_CHILD_PATID, --  孩子住院号
         v_CHILD_NAME, -- 孩子姓名
         v_ISBORNHERE, --是否本院出生
         v_CHILD_SEX, --孩子性别
         v_BORN_YEAR, --出生年
         v_BORN_MONTH, -- 出生月
         v_BORN_DAY, --出生日---------------30
         v_GESTATIONALAGE, --胎龄
         v_WEIGHT, --体重
         v_BIRTHS, --胎数
         v_ISIDENTICAL, --是否同卵
         v_OUTCOME, --转归
         v_INDUCEDLABOR, --是否引产
         v_DIAGNOSTICBASIS, --诊断依据――临床
         v_DIAGNOSTICBASIS1, -- 诊断依据――超声波
         v_DIAGNOSTICBASIS2, --诊断依据――尸解
         v_DIAGNOSTICBASIS3, --诊断依据――生化检查
         v_DIAGNOSTICBASIS4, --诊断依据――生化检查――其他
         v_DIAGNOSTICBASIS5, --诊断依据――染色体
         v_DIAGNOSTICBASIS6, --诊断依据――其他
         v_DIAGNOSTICBASIS7, --诊断依据――其他――内容
         v_DIAG_ANENCEPHALY, --出生缺陷诊断――无脑畸形
         v_DIAG_SPINA, --出生缺陷诊断――脊柱裂
         v_DIAG_PENGOUT, --出生缺陷诊断――脑彭出
         v_DIAG_HYDROCEPHALUS, --出生缺陷诊断――先天性脑积水
         v_DIAG_CLEFTPALATE, --出生缺陷诊断――腭裂
         v_DIAG_CLEFTLIP, --出生缺陷诊断――唇裂------------50
         v_DIAG_CLEFTMERGER, --出生缺陷诊断――唇裂合并腭裂
         v_DIAG_SMALLEARS, --出生缺陷诊断――小耳（包括无耳）
         v_DIAG_OUTEREAR, --出生缺陷诊断――外耳其它畸形（小耳、无耳除外）
         v_DIAG_ESOPHAGEAL, --出生缺陷诊断――食道闭锁或狭窄
         v_DIAG_RECTUM, --出生缺陷诊断――直肠肛门闭锁或狭窄（包括无肛）
         v_DIAG_HYPOSPADIAS, --出生缺陷诊断――尿道下裂
         v_DIAG_BLADDER, --出生缺陷诊断――膀胱外翻
         v_DIAG_HORSESHOEFOOTLEFT, --出生缺陷诊断――马蹄内翻足_左 
         v_DIAG_HORSESHOEFOOTRIGHT, --出生缺陷诊断――马蹄内翻足_右
         v_DIAG_MANYPOINTLEFT, --出生缺陷诊断――多指（趾）_左
         v_DIAG_MANYPOINTRIGHT, --出生缺陷诊断――多指（趾）_右
         v_DIAG_LIMBSUPPERLEFT, --出生缺陷诊断――肢体短缩_上肢 _左
         v_DIAG_LIMBSUPPERRIGHT, --出生缺陷诊断――肢体短缩_上肢 _右
         v_DIAG_LIMBSLOWERLEFT, --  出生缺陷诊断――肢体短缩_下肢 _左
         v_DIAG_LIMBSLOWERRIGHT, -- 出生缺陷诊断――肢体短缩_下肢 _右
         v_DIAG_HERNIA, --  出生缺陷诊断――先天性膈疝
         v_DIAG_BULGINGBELLY, --出生缺陷诊断――脐膨出
         v_DIAG_GASTROSCHISIS, --出生缺陷诊断――腹裂
         v_DIAG_TWINS, --出生缺陷诊断――联体双胎
         v_DIAG_TSSYNDROME, --出生缺陷诊断――唐氏综合征（21-三体综合征）
         v_DIAG_HEARTDISEASE, --出生缺陷诊断――先天性心脏病（类型）
         v_DIAG_OTHER, --出生缺陷诊断――其他（写明病名或详细描述）
         v_DIAG_OTHERCONTENT, --出生缺陷诊断――其他内容
         v_FEVER, --发烧（＞38℃）
         v_VIRUSINFECTION, --病毒感染
         v_ILLOTHER, --患病其他
         v_SULFA, --磺胺类
         v_ANTIBIOTICS, --抗生素
         v_BIRTHCONTROLPILL, -- 避孕药
         v_SEDATIVES, --镇静药---------------80
         v_MEDICINEOTHER, --服药其他
         v_DRINKING, -- 饮酒
         v_PESTICIDE, --  农药
         v_RAY, --射线
         v_CHEMICALAGENTS, --化学制剂
         v_FACTOROTHER, --其他有害因素
         v_STILLBIRTHNO, -- 死胎例数
         v_ABORTIONNO, --自然流产例数
         v_DEFECTSNO, --缺陷儿例数
         v_DEFECTSOF1, --缺陷名1--------------90
         v_DEFECTSOF2, --缺陷名2
         v_DEFECTSOF3, --缺陷名3
         v_YCDEFECTSOF1, --遗传缺陷名1
         v_YCDEFECTSOF2, -- 遗传缺陷名2
         v_YCDEFECTSOF3, --遗传缺陷名3
         v_KINSHIPDEFECTS1, --与缺陷儿亲缘关系1
         v_KINSHIPDEFECTS2, --与缺陷儿亲缘关系2
         v_KINSHIPDEFECTS3, --与缺陷儿亲缘关系3
         v_COUSINMARRIAGE, --近亲婚配史
         v_COUSINMARRIAGEBETWEEN, --近亲婚配史关系
         v_PREPARER, --填表人
         v_THETITLE1, --填表人职称
         v_FILLDATEYEAR, --填表日期年
         v_FILLDATEMONTH, --填表日期月
         v_FILLDATEDAY, --填表日期日
         v_HOSPITALREVIEW, --医院审表人
         v_THETITLE2, --医院审表人职称
         v_HOSPITALAUDITDATEYEAR, --医院审表日期年
         v_HOSPITALAUDITDATEMONTH, --医院审表日期月
         v_HOSPITALAUDITDATEDAY, --医院审表日期日
         v_PROVINCIALVIEW, --省级审表人
         v_THETITLE3, --省级审表人职称
         v_PROVINCIALVIEWDATEYEAR, --省级审表日期年
         v_PROVINCIALVIEWDATEMONTH, --省级审表日期月
         v_PROVINCIALVIEWDATEDAY, --省级审表日期日
         v_FEVERNO, --发烧度数
         v_ISVIRUSINFECTION, --是否病毒感染
         v_ISDIABETES, --是否糖尿病
         v_ISILLOTHER, --是否患病其他
         v_ISSULFA, --是否磺胺类----------------120
         v_ISANTIBIOTICS, --是否抗生素
         v_ISBIRTHCONTROLPILL, --是否避孕药
         v_ISSEDATIVES, --是否镇静药
         v_ISMEDICINEOTHER, --是否服药其他
         v_ISDRINKING, --是否饮酒
         v_ISPESTICIDE, --是否农药
         v_ISRAY, --是否射线
         v_ISCHEMICALAGENTS, --是否化学制剂
         v_ISFACTOROTHER, --是否其他有害因素
         v_STATE, --"报告状态【 1、新增保存 2、提交 3、撤回 4、?to open this dialog next """
         v_CREATE_DATE, --创建时间
         v_CREATE_USERCODE, --创建人
         v_CREATE_USERNAME, --创建人
         v_CREATE_DEPTCODE, --创建人科室
         v_CREATE_DEPTNAME, --创建人科室
         v_MODIFY_DATE, --修改时间
         v_MODIFY_USERCODE, --修改人
         v_MODIFY_USERNAME, --修改人
         v_MODIFY_DEPTCODE, --修改人科室
         v_MODIFY_DEPTNAME, --修改人科室
         v_AUDIT_DATE, --审核时间
         v_AUDIT_USERCODE, --审核人
         v_AUDIT_USERNAME, --审核人
         v_AUDIT_DEPTCODE, -- 审核人科室
         v_AUDIT_DEPTNAME, --审核人科室
         v_VAILD, --状态是否有效  1、有效   0、无效
         v_CANCELREASON, --否决原因
         v_PRENATAL, --产前
         v_PRENATALNO, --产前周数
         v_POSTPARTUM, --产后--------------150
         v_ANDTOSHOWLEFT, --并指左
         v_ANDTOSHOWRIGHT); --并指右
    
      open o_result for
        select v_ID_new from dual;
    
    end if;
  
    --修改保存传染病报告卡信息
    IF v_edittype = '2' THEN
    
      update BIRTHDEFECTSCARD
         set REPORT_NOOFINPAT        = v_REPORT_NOOFINPAT,
             REPORT_ID               = v_Report_ID, --报告卡序号        
             DIAG_CODE               = v_DIAG_CODE,
             STRING3                 = v_STRING3,
             STRING4                 = v_STRING4,
             STRING5                 = v_STRING5,
             REPORT_PROVINCE         = v_REPORT_PROVINCE, --报告卡省份
             REPORT_CITY             = v_REPORT_CITY, --报告卡市（县）
             REPORT_TOWN             = v_REPORT_TOWN, --报告卡乡镇
             REPORT_VILLAGE          = v_REPORT_VILLAGE, --报告卡村
             REPORT_HOSPITAL         = v_REPORT_HOSPITAL, --报告卡医院
             REPORT_NO               = v_REPORT_NO, --右上方不明框框
             MOTHER_PATID            = v_MOTHER_PATID, --产妇住院号
             MOTHER_NAME             = v_MOTHER_NAME, --姓名
             MOTHER_AGE              = v_MOTHER_AGE, --年龄
             NATIONAL                = v_NATIONAL, --民族
             ADDRESS_POST            = v_ADDRESS_POST, --地址and邮编
             PREGNANTNO              = v_PREGNANTNO, --孕次
             PRODUCTIONNO            = v_PRODUCTIONNO, --产次
             LOCALADD                = v_LOCALADD, --常住地
             PERCAPITAINCOME         = v_PERCAPITAINCOME, --年人均收入
             EDUCATIONLEVEL          = v_EDUCATIONLEVEL, --文化程度
             CHILD_PATID             = v_CHILD_PATID, --孩子住院号
             CHILD_NAME              = v_CHILD_NAME, --  孩子姓名
             ISBORNHERE              = v_ISBORNHERE, --是否本院出生
             CHILD_SEX               = v_CHILD_SEX, --孩子性别
             BORN_YEAR               = v_BORN_YEAR, --出生年
             BORN_MONTH              = v_BORN_MONTH, --出生月
             BORN_DAY                = v_BORN_DAY, --出生日
             GESTATIONALAGE          = v_GESTATIONALAGE, --  胎龄
             WEIGHT                  = v_WEIGHT, --体重
             BIRTHS                  = v_BIRTHS, --胎数
             ISIDENTICAL             = v_ISIDENTICAL, --是否同卵
             OUTCOME                 = v_OUTCOME, --转归
             INDUCEDLABOR            = v_INDUCEDLABOR, --是否引产
             DIAGNOSTICBASIS         = v_DIAGNOSTICBASIS, --诊断依据――临床
             DIAGNOSTICBASIS1        = v_DIAGNOSTICBASIS1, --诊断依据――超声波
             DIAGNOSTICBASIS2        = v_DIAGNOSTICBASIS2, --诊断依据――尸解
             DIAGNOSTICBASIS3        = v_DIAGNOSTICBASIS3, --诊断依据――生化检查
             DIAGNOSTICBASIS4        = v_DIAGNOSTICBASIS4, --诊断依据――生化检查――其他
             DIAGNOSTICBASIS5        = v_DIAGNOSTICBASIS5, --诊断依据――染色体
             DIAGNOSTICBASIS6        = v_DIAGNOSTICBASIS6, --诊断依据――其他
             DIAGNOSTICBASIS7        = v_DIAGNOSTICBASIS7, --诊断依据――其他――内容
             DIAG_ANENCEPHALY        = v_DIAG_ANENCEPHALY, --出生缺陷诊断――无脑畸形
             DIAG_SPINA              = v_DIAG_SPINA, --出生缺陷诊断――脊柱裂
             DIAG_PENGOUT            = v_DIAG_PENGOUT, --出生缺陷诊断――脑彭出
             DIAG_HYDROCEPHALUS      = v_DIAG_HYDROCEPHALUS, --出生缺陷诊断――先天性脑积水
             DIAG_CLEFTPALATE        = v_DIAG_CLEFTPALATE, --出生缺陷诊断――腭裂
             DIAG_CLEFTLIP           = v_DIAG_CLEFTLIP, --出生缺陷诊断――唇裂
             DIAG_CLEFTMERGER        = v_DIAG_CLEFTMERGER, --出生缺陷诊断――唇裂合并腭裂
             DIAG_SMALLEARS          = v_DIAG_SMALLEARS, --出生缺陷诊断――小耳（包括无耳）
             DIAG_OUTEREAR           = v_DIAG_OUTEREAR, --出生缺陷诊断――外耳其它畸形（小耳、无耳除外）
             DIAG_ESOPHAGEAL         = v_DIAG_ESOPHAGEAL, --出生缺陷诊断――食道闭锁或狭窄
             DIAG_RECTUM             = v_DIAG_RECTUM, --出生缺陷诊断――直肠肛门闭锁或狭窄（包括无肛）
             DIAG_HYPOSPADIAS        = v_DIAG_HYPOSPADIAS, --出生缺陷诊断――尿道下裂
             DIAG_BLADDER            = v_DIAG_BLADDER, --出生缺陷诊断――膀胱外翻
             DIAG_HORSESHOEFOOTLEFT  = v_DIAG_HORSESHOEFOOTLEFT, --出生缺陷诊断――马蹄内翻足_左 
             DIAG_HORSESHOEFOOTRIGHT = v_DIAG_HORSESHOEFOOTRIGHT, --  出生缺陷诊断――马蹄内翻足_右
             DIAG_MANYPOINTLEFT      = v_DIAG_MANYPOINTLEFT, --出生缺陷诊断――多指（趾）_左
             DIAG_MANYPOINTRIGHT     = v_DIAG_MANYPOINTRIGHT, --出生缺陷诊断――多指（趾）_右
             DIAG_LIMBSUPPERLEFT     = v_DIAG_LIMBSUPPERLEFT, --出生缺陷诊断――肢体短缩_上肢 _左
             DIAG_LIMBSUPPERRIGHT    = v_DIAG_LIMBSUPPERRIGHT, --出生缺陷诊断――肢体短缩_上肢 _右
             DIAG_LIMBSLOWERLEFT     = v_DIAG_LIMBSLOWERLEFT, --出生缺陷诊断――肢体短缩_下肢 _左
             DIAG_LIMBSLOWERRIGHT    = v_DIAG_LIMBSLOWERRIGHT, ---出生缺陷诊断――肢体短缩_下肢 _右
             DIAG_HERNIA             = v_DIAG_HERNIA, --出生缺陷诊断――先天性膈疝
             DIAG_BULGINGBELLY       = v_DIAG_BULGINGBELLY, --出生缺陷诊断――脐膨出
             DIAG_GASTROSCHISIS      = v_DIAG_GASTROSCHISIS, --出生缺陷诊断――腹裂
             DIAG_TWINS              = v_DIAG_TWINS, --出生缺陷诊断――联体双胎
             DIAG_TSSYNDROME         = v_DIAG_TSSYNDROME, --出生缺陷诊断――唐氏综合征（21-三体综合征）
             DIAG_HEARTDISEASE       = v_DIAG_HEARTDISEASE, --出生缺陷诊断――先天性心脏病（类型）
             DIAG_OTHER              = v_DIAG_OTHER, --出生缺陷诊断――其他（写明病名或详细描述）
             DIAG_OTHERCONTENT       = v_DIAG_OTHERCONTENT, --出生缺陷诊断――其他内容
             FEVER                   = v_FEVER, --发烧（＞38℃）
             VIRUSINFECTION          = v_VIRUSINFECTION, --病毒感染
             ILLOTHER                = v_ILLOTHER, --患病其他
             SULFA                   = v_SULFA, --磺胺类
             ANTIBIOTICS             = v_ANTIBIOTICS, --抗生素
             BIRTHCONTROLPILL        = v_BIRTHCONTROLPILL, --避孕药
             SEDATIVES               = v_SEDATIVES, --镇静药
             MEDICINEOTHER           = v_MEDICINEOTHER, --服药其他
             DRINKING                = v_DRINKING, --饮酒
             PESTICIDE               = v_PESTICIDE, --农药
             RAY                     = v_RAY, --射线
             CHEMICALAGENTS          = v_CHEMICALAGENTS, --  化学制剂
             FACTOROTHER             = v_FACTOROTHER, --其他有害因素
             STILLBIRTHNO            = v_STILLBIRTHNO, --  死胎例数
             ABORTIONNO              = v_ABORTIONNO, --自然流产例数
             DEFECTSNO               = v_DEFECTSNO, --缺陷儿例数
             DEFECTSOF1              = v_DEFECTSOF1, --缺陷名1
             DEFECTSOF2              = v_DEFECTSOF2, --缺陷名2
             DEFECTSOF3              = v_DEFECTSOF3, --缺陷名3
             YCDEFECTSOF1            = v_YCDEFECTSOF1, --遗传缺陷名1
             YCDEFECTSOF2            = v_YCDEFECTSOF2, --遗传缺陷名2
             YCDEFECTSOF3            = v_YCDEFECTSOF3, --遗传缺陷名3
             KINSHIPDEFECTS1         = v_KINSHIPDEFECTS1, --与缺陷儿亲缘关系1
             KINSHIPDEFECTS2         = v_KINSHIPDEFECTS2, --与缺陷儿亲缘关系2
             KINSHIPDEFECTS3         = v_KINSHIPDEFECTS3, --与缺陷儿亲缘关系3
             COUSINMARRIAGE          = v_COUSINMARRIAGE, --近亲婚配史
             COUSINMARRIAGEBETWEEN   = v_COUSINMARRIAGEBETWEEN, --近亲婚配史关系
             PREPARER                = v_PREPARER, --填表人
             THETITLE1               = v_THETITLE1, --填表人职称
             FILLDATEYEAR            = v_FILLDATEYEAR, --填表日期年
             FILLDATEMONTH           = v_FILLDATEMONTH, --填表日期月
             FILLDATEDAY             = v_FILLDATEDAY, --填表日期日
             HOSPITALREVIEW          = v_HOSPITALREVIEW, --医院审表人
             THETITLE2               = v_THETITLE2, --医院审表人职称
             HOSPITALAUDITDATEYEAR   = v_HOSPITALAUDITDATEYEAR, --医院审表日期年
             HOSPITALAUDITDATEMONTH  = v_HOSPITALAUDITDATEMONTH, --医院审表日期月
             HOSPITALAUDITDATEDAY    = v_HOSPITALAUDITDATEDAY, --医院审表日期日
             PROVINCIALVIEW          = v_PROVINCIALVIEW, --省级审表人
             THETITLE3               = v_THETITLE3, --省级审表人职称
             PROVINCIALVIEWDATEYEAR  = v_PROVINCIALVIEWDATEYEAR, --省级审表日期年
             PROVINCIALVIEWDATEMONTH = v_PROVINCIALVIEWDATEMONTH, --省级审表日期月
             PROVINCIALVIEWDATEDAY   = v_PROVINCIALVIEWDATEDAY, --  省级审表日期日
             FEVERNO                 = v_FEVERNO, --发烧度数
             ISVIRUSINFECTION        = v_ISVIRUSINFECTION, --是否病毒感染
             ISDIABETES              = v_ISDIABETES, --是否糖尿病
             ISILLOTHER              = v_ISILLOTHER, --是否患病其他
             ISSULFA                 = v_ISSULFA, --是否磺胺类
             ISANTIBIOTICS           = v_ISANTIBIOTICS, --是否抗生素
             ISBIRTHCONTROLPILL      = v_ISBIRTHCONTROLPILL, --是否避孕药
             ISSEDATIVES             = v_ISSEDATIVES, --是否镇静药
             ISMEDICINEOTHER         = v_ISMEDICINEOTHER, --是否服药其他
             ISDRINKING              = v_ISDRINKING, --是否饮酒
             ISPESTICIDE             = v_ISPESTICIDE, --是否农药
             ISRAY                   = v_ISRAY, --是否射线
             ISCHEMICALAGENTS        = v_ISCHEMICALAGENTS, --是否化学制剂
             ISFACTOROTHER           = v_ISFACTOROTHER, --是否其他有害因素
             STATE                   = v_STATE, --"报告状态【 1、新增保存 2、提交 3、撤回 4、?to open this dialog next """
             CREATE_DATE             = v_CREATE_DATE, --创建时间
             CREATE_USERCODE         = v_CREATE_USERCODE, --创建人
             CREATE_USERNAME         = v_CREATE_USERNAME, --创建人
             CREATE_DEPTCODE         = v_CREATE_DEPTCODE, --创建人科室
             CREATE_DEPTNAME         = v_CREATE_DEPTNAME, --创建人科室
             MODIFY_DATE             = v_MODIFY_DATE, --修改时间
             MODIFY_USERCODE         = v_MODIFY_USERCODE, --修改人
             MODIFY_USERNAME         = v_MODIFY_USERNAME, --修改人
             MODIFY_DEPTCODE         = v_MODIFY_DEPTCODE, --修改人科室
             MODIFY_DEPTNAME         = v_MODIFY_DEPTNAME, --修改人科室
             AUDIT_DATE              = v_AUDIT_DATE, --审核时间
             AUDIT_USERCODE          = v_AUDIT_USERCODE, --  审核人
             AUDIT_USERNAME          = v_AUDIT_USERNAME, --审核人
             AUDIT_DEPTCODE          = v_AUDIT_DEPTCODE, --审核人科室
             AUDIT_DEPTNAME          = v_AUDIT_DEPTNAME, --审核人科室
             VAILD                   = v_VAILD, --状态是否有效  1、有效   0、无效
             CANCELREASON            = v_CANCELREASON, --否决原因
             PRENATAL                = v_PRENATAL, --产前
             PRENATALNO              = v_PRENATALNO, --产前周数
             POSTPARTUM              = v_POSTPARTUM, --产后
             ANDTOSHOWLEFT           = v_ANDTOSHOWLEFT, --  并指左
             ANDTOSHOWRIGHT          = v_ANDTOSHOWRIGHT --并指右
      
       where ID = v_ID;
    
      open o_result for
        select v_ID from dual;
    
    end if;
  
    --作废传染病报告卡信息     
  
    --根据传入的传染病报告卡ID查询报告卡信息
    IF v_edittype = '4' THEN
    
      open o_result for
        select * from BIRTHDEFECTSCARD a where a.report_id = v_ID;
    
    end if;
  
  end;
  --------出生缺陷报告卡

  PROCEDURE usp_EditTherioma_Report(v_EditType              varchar,
                                    v_Report_ID             NUMERIC DEFAULT 0,
                                    v_REPORT_DISTRICTID     varchar DEFAULT '', --传染病上报卡表区(县)编码
                                    v_REPORT_DISTRICTNAME   varchar default '', --传染病上报卡表区(县)名称
                                    v_REPORT_ICD10          varchar default '', --传染病报告卡ICD-10编码
                                    v_REPORT_ICD0           varchar default '', --传染病报告卡ICD-0编码
                                    v_REPORT_CLINICID       varchar default '', --门诊号
                                    v_REPORT_PATID          varchar default '', --住院号
                                    v_REPORT_INDO           varchar default '', --身份证号码
                                    v_REPORT_INPATNAME      varchar default '', --病患姓名
                                    v_SEXID                 varchar default '', --病患性别
                                    v_REALAGE               varchar default '', --病患实足年龄
                                    v_BIRTHDATE             varchar default '', --病患生日
                                    v_NATIONID              varchar default '', --病患民族编号
                                    v_NATIONNAME            varchar default '', --病患民族全称
                                    v_CONTACTTEL            varchar default '', --家庭电话
                                    v_MARTIAL               varchar default '', --婚姻状况
                                    v_OCCUPATION            varchar default '', --病患职业
                                    v_OFFICEADDRESS         varchar default '', --工作单位地址
                                    v_ORGPROVINCEID         varchar default '', --户口地址省份编码
                                    v_ORGCITYID             varchar default '', --户口地址所在市编码
                                    v_ORGDISTRICTID         varchar default '', --户口所在地区县编码
                                    v_ORGTOWNID             varchar default '', --户口所在地镇(街道)编码
                                    v_ORGVILLIAGE           varchar default '', --户口所在地居委会对应编码
                                    v_ORGPROVINCENAME       varchar default '', --户口所在地省份全称
                                    v_ORGCITYNAME           varchar default '', --户口所在地市全名称
                                    v_ORGDISTRICTNAME       varchar default '', --户口所在地区(县)全称
                                    v_ORGTOWN               varchar default '', --户口所在地镇全称
                                    v_ORGVILLAGENAME        varchar default '', --户口所在地村全称
                                    v_XZZPROVINCEID         varchar default '', --现住址所在省份编码
                                    v_XZZCITYID             varchar default '', --现住址所在市编码
                                    v_XZZDISTRICTID         varchar default '', --现住址所在区(县)代码
                                    v_XZZTOWNID             varchar default '', --现住址所在镇代码
                                    v_XZZVILLIAGEID         varchar default '', --报现住址所在村编码
                                    v_XZZPROVINCE           varchar default '', --现住址所在省份全称
                                    v_XZZCITY               varchar default '', --现住址所在市全称
                                    v_XZZDISTRICT           varchar default '', --现住址所在区全称
                                    v_XZZTOWN               varchar default '', --现住址所在镇全称
                                    v_XZZVILLIAGE           varchar default '', --现住址所在村全称
                                    v_REPORT_DIAGNOSIS      varchar default '', --诊断
                                    v_PATHOLOGICALTYPE      varchar default '', --病理类型
                                    v_PATHOLOGICALID        varchar default '', --病理诊断病理号
                                    v_QZDIAGTIME_T          varchar default '', --确诊时期_T期
                                    v_QZDIAGTIME_N          varchar default '', --确诊时期_N期
                                    v_QZDIAGTIME_M          varchar default '', --确诊时期_M期
                                    v_FIRSTDIADATE          varchar default '', --首次确诊时间
                                    v_REPORTINFUNIT         varchar default '', --报告单位
                                    v_REPORTDOCTOR          varchar default '', --报告医生
                                    v_REPORTDATE            varchar default '', --报告时间
                                    v_DEATHDATE             varchar default '', --死亡时间
                                    v_DEATHREASON           varchar default '', --死亡原因
                                    v_REJEST                varchar default '', --病历摘要
                                    v_REPORT_YDIAGNOSIS     varchar default '', --原诊断
                                    v_REPORT_YDIAGNOSISDATA varchar default '', --原诊断日期
                                    v_REPORT_DIAGNOSISBASED varchar default '', --诊断依据
                                    v_REPORT_NO             varchar default '', --传染病上报卡表编号
                                    v_REPORT_NOOFINPAT      varchar default '', --患者ID
                                    v_STATE                 varchar default '', --报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报  7、作废】
                                    v_CREATE_DATE           varchar default '', --创建人日期  
                                    v_CREATE_USERCODE       varchar default '', --创建人
                                    v_CREATE_USERNAME       varchar default '', --创建人
                                    v_CREATE_DEPTCODE       varchar default '', --创建人科室
                                    v_CREATE_DEPTNAME       varchar default '', --创建人科室
                                    v_MODIFY_DATE           varchar default '', --修改时间
                                    v_MODIFY_USERCODE       varchar default '', --修改人
                                    v_MODIFY_USERNAME       varchar default '', --修改人
                                    v_MODIFY_DEPTCODE       varchar default '', --修改人科室
                                    v_MODIFY_DEPTNAME       varchar default '', --修改人科室
                                    v_AUDIT_DATE            varchar default '', --审核时间
                                    v_AUDIT_USERCODE        varchar default '', --审核人
                                    v_AUDIT_USERNAME        varchar default '', --审核人
                                    v_AUDIT_DEPTCODE        varchar default '', --审核人科室
                                    v_AUDIT_DEPTNAME        varchar default '', --审核人科室
                                    v_VAILD                 varchar default '',
                                    v_DIAGICD10             varchar default '',
                                    v_CANCELREASON          varchar default '', --否决原因   
                                    V_CARDTYPE              varchar default '', --卡片类型死亡或者发病                   
                                    V_clinicalstages        varchar default '',
                                    V_ReportDiagfunit       varchar default '',
                                    o_result                OUT empcurtyp) AS
  
    v_Report_ID_new int;
  BEGIN
  
    --新增传染病报告卡
    IF v_edittype = '1' THEN
    
      select SEQ_THERIOMAID.Nextval into v_Report_ID_new from dual;
    
      insert into THERIOMAREPORTCARD
        (REPORT_ID, --序号
         REPORT_DISTRICTID, --传染病上报卡表区(县)编码
         REPORT_DISTRICTNAME, --传染病上报卡表区(县)名称
         REPORT_ICD10, --传染病报告卡ICD-10编码
         REPORT_ICD0, --传染病报告卡ICD-0编码
         REPORT_CLINICID, --门诊号
         REPORT_PATID, --住院号
         REPORT_INDO, --身份证号码
         REPORT_INPATNAME, --病患姓名
         SEXID, --病患性别
         REALAGE, --病患实足年龄(在诊断时未过生日者为虚年龄减二岁，已过生日者为虚年龄减一岁；未满一岁者为0岁)
         BIRTHDATE, --病患生日
         NATIONID, --病患民族编号
         NATIONNAME, --病患民族全称
         CONTACTTEL, --家庭电话
         MARTIAL, --婚姻状况
         OCCUPATION, --病患职业
         OFFICEADDRESS, --工作单位地址
         ORGPROVINCEID, --户口地址省份编码
         ORGCITYID, --户口地址所在市编码
         ORGDISTRICTID, --户口所在地区县编码
         ORGTOWNID, --户口所在地镇(街道)编码
         ORGVILLIAGE, --户口所在地居委会对应编码
         ORGPROVINCENAME, --户口所在地省份全称
         ORGCITYNAME, --户口所在地市全名称
         ORGDISTRICTNAME, --户口所在地区(县)全称
         ORGTOWN, --户口所在地镇全称
         ORGVILLAGENAME, --户口所在地村全称
         XZZPROVINCEID, --现住址所在省份编码
         XZZCITYID, --现住址所在市编码
         XZZDISTRICTID, --现住址所在区(县)代码
         XZZTOWNID, --现住址所在镇代码
         XZZVILLIAGEID, --现住址所在村编码
         XZZPROVINCE, --现住址所在省份全称
         XZZCITY, --现住址所在市全称
         XZZDISTRICT, --现住址所在区全称
         XZZTOWN, --现住址所在镇全称
         XZZVILLIAGE, --现住址所在村全称
         REPORT_DIAGNOSIS, --诊断
         PATHOLOGICALTYPE, --病理类型
         PATHOLOGICALID, --病理诊断病理号
         QZDIAGTIME_T, --确诊时期_T期
         QZDIAGTIME_N, --确诊时期_N期
         QZDIAGTIME_M, --确诊时期_M期
         FIRSTDIADATE, --首次确诊时间
         REPORTINFUNIT, --报告单位
         REPORTDOCTOR, --报告医生
         REPORTDATE, --报告时间
         DEATHDATE, --死亡时间
         DEATHREASON, --死亡原因
         REJEST, --病历摘要
         REPORT_YDIAGNOSIS, --原诊断
         REPORT_YDIAGNOSISDATA, --原诊断日期
         REPORT_DIAGNOSISBASED, --诊断依据
         REPORT_NO, --传染病上报卡表编号
         REPORT_NOOFINPAT, --患者ID
         STATE, --"报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报 7、作废】"
         CREATE_DATE, --创建时间
         CREATE_USERCODE, --创建人
         CREATE_USERNAME, --创建人
         CREATE_DEPTCODE, --创建人科室
         CREATE_DEPTNAME, --创建人科室
         MODIFY_DATE, --修改时间
         MODIFY_USERCODE, --修改人
         MODIFY_USERNAME, --修改人
         MODIFY_DEPTCODE, --修改人科室
         MODIFY_DEPTNAME, --修改人科室
         AUDIT_DATE, --审核时间
         AUDIT_USERCODE, --审核人
         AUDIT_USERNAME, --审核人
         AUDIT_DEPTCODE, --审核人科室
         AUDIT_DEPTNAME, --审核人科室
         VAILD, --状态是否有效  1、有效   0、无效
         DIAGICD10, --传染病病种(对应传染病诊断库)
         CANCELREASON, --否决原因
         CARDTYPE,
         clinicalstages,
         ReportDiagfunit)
      values
        (v_Report_ID_new, --序号
         v_REPORT_DISTRICTID, --传染病上报卡表区(县)编码
         v_REPORT_DISTRICTNAME, --传染病上报卡表区(县)名称
         v_REPORT_ICD10, --传染病报告卡ICD-10编码
         v_REPORT_ICD0, --传染病报告卡ICD-0编码
         v_REPORT_CLINICID, --门诊号
         v_REPORT_PATID, --住院号
         v_REPORT_INDO, --身份证号码
         v_REPORT_INPATNAME, --病患姓名
         v_SEXID, --病患性别
         v_REALAGE, --病患实足年龄(在诊断时未过生日者为虚年龄减二岁，已过生日者为虚年龄减一岁；未满一岁者为0岁)
         v_BIRTHDATE, --病患生日
         v_NATIONID, --病患民族编号
         v_NATIONNAME, --病患民族全称
         v_CONTACTTEL, --家庭电话
         v_MARTIAL, --婚姻状况
         v_OCCUPATION, --病患职业
         v_OFFICEADDRESS, --工作单位地址
         v_ORGPROVINCEID, --户口地址省份编码
         v_ORGCITYID, --户口地址所在市编码
         v_ORGDISTRICTID, --户口所在地区县编码
         v_ORGTOWNID, --户口所在地镇(街道)编码
         v_ORGVILLIAGE, --户口所在地居委会对应编码
         v_ORGPROVINCENAME, --户口所在地省份全称
         v_ORGCITYNAME, --户口所在地市全名称
         v_ORGDISTRICTNAME, --户口所在地区(县)全称
         v_ORGTOWN, --户口所在地镇全称
         v_ORGVILLAGENAME, --户口所在地村全称
         v_XZZPROVINCEID, --现住址所在省份编码
         v_XZZCITYID, --现住址所在市编码
         v_XZZDISTRICTID, --现住址所在区(县)代码
         v_XZZTOWNID, --现住址所在镇代码
         v_XZZVILLIAGEID, --现住址所在村编码
         v_XZZPROVINCE, --现住址所在省份全称
         v_XZZCITY, --现住址所在市全称
         v_XZZDISTRICT, --现住址所在区全称
         v_XZZTOWN, --现住址所在镇全称
         v_XZZVILLIAGE, --现住址所在村全称
         v_REPORT_DIAGNOSIS, --诊断
         v_PATHOLOGICALTYPE, --病理类型
         v_PATHOLOGICALID, --病理诊断病理号
         v_QZDIAGTIME_T, --确诊时期_T期
         v_QZDIAGTIME_N, --确诊时期_N期
         v_QZDIAGTIME_M, --确诊时期_M期
         v_FIRSTDIADATE, --首次确诊时间
         v_REPORTINFUNIT, --报告单位
         v_REPORTDOCTOR, --报告医生
         v_REPORTDATE, --报告时间
         v_DEATHDATE, --死亡时间
         v_DEATHREASON, --死亡原因
         v_REJEST, --病历摘要
         v_REPORT_YDIAGNOSIS, --原诊断
         v_REPORT_YDIAGNOSISDATA, --原诊断日期
         v_REPORT_DIAGNOSISBASED, --诊断依据
         v_REPORT_NO, --传染病上报卡表编号
         v_REPORT_NOOFINPAT, --患者ID
         v_STATE, --"报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报 7、作废】"
         v_CREATE_DATE, --创建时间
         v_CREATE_USERCODE, --创建人
         v_CREATE_USERNAME, --创建人
         v_CREATE_DEPTCODE, --创建人科室
         v_CREATE_DEPTNAME, --创建人科室
         v_MODIFY_DATE, --修改时间
         v_MODIFY_USERCODE, --修改人
         v_MODIFY_USERNAME, --修改人
         v_MODIFY_DEPTCODE, --修改人科室
         v_MODIFY_DEPTNAME, --修改人科室
         v_AUDIT_DATE, --审核时间
         v_AUDIT_USERCODE, --审核人
         v_AUDIT_USERNAME, --审核人
         v_AUDIT_DEPTCODE, --审核人科室
         v_AUDIT_DEPTNAME, --审核人科室
         v_VAILD, --状态是否有效  1、有效   0、无效
         v_DIAGICD10, --传染病病种(对应传染病诊断库)
         v_CANCELREASON, --否决原因
         V_CARDTYPE,
         V_clinicalstages,
         V_ReportDiagfunit);
    
      open o_result for
        select v_Report_ID_new from dual;
    
    end if;
  
    --修改保存传染病报告卡信息
    IF v_edittype = '2' THEN
    
      update THERIOMAREPORTCARD
         set REPORT_DISTRICTID     = v_REPORT_DISTRICTID, --传染病上报卡表区(县)编码
             REPORT_DISTRICTNAME   = v_REPORT_DISTRICTNAME, --传染病上报卡表区(县)名称
             REPORT_ICD10          = v_REPORT_ICD10, --传染病报告卡ICD-10编码
             REPORT_ICD0           = v_REPORT_ICD0, --传染病报告卡ICD-0编码
             REPORT_CLINICID       = v_REPORT_CLINICID, --门诊号
             REPORT_PATID          = v_REPORT_PATID, --住院号
             REPORT_INDO           = v_REPORT_INDO, --身份证号码
             REPORT_INPATNAME      = v_REPORT_INPATNAME, --病患姓名
             SEXID                 = v_SEXID, --病患性别
             REALAGE               = v_REALAGE, --病患实足年龄(在诊断时未过生日者为虚年龄减二岁，已过生日者为虚年龄减一岁；未满一岁者为0岁)
             BIRTHDATE             = v_BIRTHDATE, --病患生日
             NATIONID              = v_NATIONID, --病患民族编号
             NATIONNAME            = v_NATIONNAME, --病患民族全称
             CONTACTTEL            = v_CONTACTTEL, --家庭电话
             MARTIAL               = v_MARTIAL, --婚姻状况
             OCCUPATION            = v_OCCUPATION, --病患职业
             OFFICEADDRESS         = v_OFFICEADDRESS, --工作单位地址
             ORGPROVINCEID         = v_ORGPROVINCEID, --户口地址省份编码
             ORGCITYID             = v_ORGCITYID, --户口地址所在市编码
             ORGDISTRICTID         = v_ORGDISTRICTID, --户口所在地区县编码
             ORGTOWNID             = v_ORGTOWNID, --户口所在地镇(街道)编码
             ORGVILLIAGE           = v_ORGVILLIAGE, --户口所在地居委会对应编码
             ORGPROVINCENAME       = v_ORGPROVINCENAME, --户口所在地省份全称
             ORGCITYNAME           = v_ORGCITYNAME, --户口所在地市全名称
             ORGDISTRICTNAME       = v_ORGDISTRICTNAME, --户口所在地区(县)全称
             ORGTOWN               = v_ORGTOWN, --户口所在地镇全称
             ORGVILLAGENAME        = v_ORGVILLAGENAME, --户口所在地村全称
             XZZPROVINCEID         = v_XZZPROVINCEID, --现住址所在省份编码
             XZZCITYID             = v_XZZCITYID, --现住址所在市编码
             XZZDISTRICTID         = v_XZZDISTRICTID, --现住址所在区(县)代码
             XZZTOWNID             = v_XZZTOWNID, --现住址所在镇代码
             XZZVILLIAGEID         = v_XZZVILLIAGEID, --现住址所在村编码
             XZZPROVINCE           = v_XZZPROVINCE, --现住址所在省份全称
             XZZCITY               = v_XZZCITY, --现住址所在市全称
             XZZDISTRICT           = v_XZZDISTRICT, --报现住址所在区全称
             XZZTOWN               = v_XZZTOWN, --现住址所在镇全称
             XZZVILLIAGE           = v_XZZVILLIAGE, --现住址所在村全称
             REPORT_DIAGNOSIS      = v_REPORT_DIAGNOSIS, --诊断
             PATHOLOGICALTYPE      = v_PATHOLOGICALTYPE, --病理类型
             PATHOLOGICALID        = v_PATHOLOGICALID, --病理诊断病理号
             QZDIAGTIME_T          = v_QZDIAGTIME_T, --确诊时期_T期
             QZDIAGTIME_N          = v_QZDIAGTIME_N, --确诊时期_N期
             QZDIAGTIME_M          = v_QZDIAGTIME_M, --确诊时期_M期
             FIRSTDIADATE          = v_FIRSTDIADATE, --首次确诊时间
             REPORTINFUNIT         = v_REPORTINFUNIT, --报告单位
             REPORTDOCTOR          = v_REPORTDOCTOR, --报告医生
             REPORTDATE            = v_REPORTDATE, --报告时间
             DEATHDATE             = v_DEATHDATE, --死亡时间
             DEATHREASON           = v_DEATHREASON, --死亡原因
             REJEST                = v_REJEST, --病历摘要
             REPORT_YDIAGNOSIS     = v_REPORT_YDIAGNOSIS, --原诊断
             REPORT_YDIAGNOSISDATA = v_REPORT_YDIAGNOSISDATA, --原诊断日期
             REPORT_DIAGNOSISBASED = v_REPORT_DIAGNOSISBASED, --诊断依据                   
             REPORT_NO             = v_REPORT_NO, --传染病上报卡表编号
             REPORT_NOOFINPAT      = v_REPORT_NOOFINPAT, --患者ID
             STATE                 = v_STATE, --"报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报 7、作废】"                           
             CREATE_DATE           = nvl(v_CREATE_DATE, CREATE_DATE), --创建时间
             CREATE_USERCODE       = nvl(v_CREATE_USERCODE, CREATE_USERCODE), --创建人
             CREATE_USERNAME       = nvl(v_CREATE_USERNAME, CREATE_USERNAME), --创建人
             CREATE_DEPTCODE       = nvl(v_CREATE_DEPTCODE, CREATE_DEPTCODE), --创建人科室
             CREATE_DEPTNAME       = nvl(v_CREATE_DEPTNAME, CREATE_DEPTNAME), --创建人科室
             MODIFY_DATE           = nvl(v_MODIFY_DATE, MODIFY_DATE), --修改时间
             MODIFY_USERCODE       = nvl(v_MODIFY_USERCODE, MODIFY_USERCODE), --修改人
             MODIFY_USERNAME       = nvl(v_MODIFY_USERNAME, MODIFY_USERNAME), --修改人
             MODIFY_DEPTCODE       = nvl(v_MODIFY_DEPTCODE, MODIFY_DEPTCODE), --修改人科室
             MODIFY_DEPTNAME       = nvl(v_MODIFY_DEPTNAME, MODIFY_DEPTNAME), --修改人科室
             AUDIT_DATE            = nvl(v_AUDIT_DATE, AUDIT_DATE), --审核时间
             AUDIT_USERCODE        = nvl(v_AUDIT_USERCODE, AUDIT_USERCODE), --审核人
             AUDIT_USERNAME        = nvl(v_AUDIT_USERNAME, AUDIT_USERNAME), --审核人
             AUDIT_DEPTCODE        = nvl(v_AUDIT_DEPTCODE, AUDIT_DEPTCODE), --审核人科室
             AUDIT_DEPTNAME        = nvl(v_AUDIT_DEPTNAME, AUDIT_DEPTNAME), --审核人科室
             VAILD                 = v_VAILD,
             DIAGICD10             = v_DIAGICD10, --传染病病种(对应传染病诊断库)
             CANCELREASON          = v_CANCELREASON, --否决原因
             CARDTYPE              = V_CARDTYPE,
             clinicalstages        = V_clinicalstages,
             ReportDiagfunit       = V_ReportDiagfunit
       where REPORT_ID = v_Report_ID;
    
      open o_result for
        select v_Report_ID from dual;
    
    end if;
  
    --作废传染病报告卡信息
    IF v_edittype = '3' THEN
    
      update THERIOMAREPORTCARD
         set REPORT_DISTRICTID     = nvl(v_REPORT_DISTRICTID,
                                         REPORT_DISTRICTID), --传染病上报卡表区(县)编码
             REPORT_DISTRICTNAME   = nvl(v_REPORT_DISTRICTNAME,
                                         REPORT_DISTRICTNAME), --传染病上报卡表区(县)名称
             REPORT_ICD10          = nvl(v_REPORT_ICD10, REPORT_ICD10), --传染病报告卡ICD-10编码
             REPORT_ICD0           = nvl(v_REPORT_ICD0, REPORT_ICD0), --传染病报告卡ICD-0编码
             REPORT_CLINICID       = nvl(v_REPORT_CLINICID, REPORT_CLINICID), --门诊号
             REPORT_PATID          = v_REPORT_PATID, --住院号
             REPORT_INDO           = v_REPORT_INDO, --身份证号码
             REPORT_INPATNAME      = v_REPORT_INPATNAME, --病患姓名
             SEXID                 = nvl(v_SEXID, SEXID), --病患性别
             REALAGE               = v_REALAGE, --病患实足年龄(在诊断时未过生日者为虚年龄减二岁，已过生日者为虚年龄减一岁；未满一岁者为0岁)
             BIRTHDATE             = v_BIRTHDATE, --病患生日
             NATIONID              = v_NATIONID, --病患民族编号
             NATIONNAME            = v_NATIONNAME, --病患民族全称
             CONTACTTEL            = v_CONTACTTEL, --家庭电话
             MARTIAL               = v_MARTIAL, --婚姻状况
             OCCUPATION            = v_OCCUPATION, --病患职业
             OFFICEADDRESS         = v_OFFICEADDRESS, --工作单位地址
             ORGPROVINCEID         = v_ORGPROVINCEID, --户口地址省份编码
             ORGCITYID             = v_ORGCITYID, --户口地址所在市编码
             ORGDISTRICTID         = v_ORGDISTRICTID, --户口所在地区县编码
             ORGTOWNID             = v_ORGTOWNID, --户口所在地镇(街道)编码
             ORGVILLIAGE           = v_ORGVILLIAGE, --户口所在地居委会对应编码
             ORGPROVINCENAME       = v_ORGPROVINCENAME, --户口所在地省份全称
             ORGCITYNAME           = v_ORGCITYNAME, --户口所在地市全名称
             ORGDISTRICTNAME       = v_ORGDISTRICTNAME, --户口所在地区(县)全称
             ORGTOWN               = v_ORGTOWN, --户口所在地镇全称
             ORGVILLAGENAME        = v_ORGVILLAGENAME, --户口所在地村全称
             XZZPROVINCEID         = v_XZZPROVINCEID, --现住址所在省份编码
             XZZCITYID             = v_XZZCITYID, --现住址所在市编码
             XZZDISTRICTID         = v_XZZDISTRICTID, --现住址所在区(县)代码
             XZZTOWNID             = v_XZZTOWNID, --现住址所在镇代码
             XZZVILLIAGEID         = v_XZZVILLIAGEID, --现住址所在村编码
             XZZPROVINCE           = v_XZZPROVINCE, --现住址所在省份全称
             XZZCITY               = v_XZZCITY, --现住址所在市全称
             XZZDISTRICT           = v_XZZDISTRICT, --报现住址所在区全称
             XZZTOWN               = v_XZZTOWN, --现住址所在镇全称
             XZZVILLIAGE           = v_XZZVILLIAGE, --现住址所在村全称
             REPORT_DIAGNOSIS      = v_REPORT_DIAGNOSIS, --诊断
             PATHOLOGICALTYPE      = v_PATHOLOGICALTYPE, --病理类型
             PATHOLOGICALID        = v_PATHOLOGICALID, --病理诊断病理号
             QZDIAGTIME_T          = v_QZDIAGTIME_T, --确诊时期_T期
             QZDIAGTIME_N          = v_QZDIAGTIME_N, --确诊时期_N期
             QZDIAGTIME_M          = v_QZDIAGTIME_M, --确诊时期_M期
             FIRSTDIADATE          = v_FIRSTDIADATE, --首次确诊时间
             REPORTINFUNIT         = v_REPORTINFUNIT, --报告单位
             REPORTDOCTOR          = v_REPORTDOCTOR, --报告医生
             REPORTDATE            = v_REPORTDATE, --报告时间
             DEATHDATE             = v_DEATHDATE, --死亡时间
             DEATHREASON           = v_DEATHREASON, --死亡原因
             REJEST                = v_REJEST, --病历摘要
             REPORT_YDIAGNOSIS     = v_REPORT_YDIAGNOSIS, --原诊断
             REPORT_YDIAGNOSISDATA = v_REPORT_YDIAGNOSISDATA, --原诊断日期
             REPORT_DIAGNOSISBASED = v_REPORT_DIAGNOSISBASED, --诊断依据                   
             REPORT_NO             = v_REPORT_NO, --传染病上报卡表编号
             REPORT_NOOFINPAT      = v_REPORT_NOOFINPAT, --患者ID
             STATE                 = v_STATE, --"报告状态【 1、新增保存 2、提交 3、撤回 4、审核通过 5、审核未通过撤回 6、上报 7、作废】"                           
             CREATE_DATE           = nvl(v_CREATE_DATE, CREATE_DATE), --创建时间
             CREATE_USERCODE       = nvl(v_CREATE_USERCODE, CREATE_USERCODE), --创建人
             CREATE_USERNAME       = nvl(v_CREATE_USERNAME, CREATE_USERNAME), --创建人
             CREATE_DEPTCODE       = nvl(v_CREATE_DEPTCODE, CREATE_DEPTCODE), --创建人科室
             CREATE_DEPTNAME       = nvl(v_CREATE_DEPTNAME, CREATE_DEPTNAME), --创建人科室
             MODIFY_DATE           = nvl(v_MODIFY_DATE, MODIFY_DATE), --修改时间
             MODIFY_USERCODE       = nvl(v_MODIFY_USERCODE, MODIFY_USERCODE), --修改人
             MODIFY_USERNAME       = nvl(v_MODIFY_USERNAME, MODIFY_USERNAME), --修改人
             MODIFY_DEPTCODE       = nvl(v_MODIFY_DEPTCODE, MODIFY_DEPTCODE), --修改人科室
             MODIFY_DEPTNAME       = nvl(v_MODIFY_DEPTNAME, MODIFY_DEPTNAME), --修改人科室
             AUDIT_DATE            = nvl(v_AUDIT_DATE, AUDIT_DATE), --审核时间
             AUDIT_USERCODE        = nvl(v_AUDIT_USERCODE, AUDIT_USERCODE), --审核人
             AUDIT_USERNAME        = nvl(v_AUDIT_USERNAME, AUDIT_USERNAME), --审核人
             AUDIT_DEPTCODE        = nvl(v_AUDIT_DEPTCODE, AUDIT_DEPTCODE), --审核人科室
             AUDIT_DEPTNAME        = nvl(v_AUDIT_DEPTNAME, AUDIT_DEPTNAME), --审核人科室
             VAILD                 = '0',
             DIAGICD10             = v_DIAGICD10, -- --传染病病种(对应传染病诊断库)
             CANCELREASON          = v_CANCELREASON, --否决原因
             CARDTYPE              = V_CARDTYPE,
             clinicalstages        = V_clinicalstages,
             ReportDiagfunit       = V_ReportDiagfunit
       where REPORT_ID = v_Report_ID;
    
      open o_result for
        select v_Report_ID from dual;
    
    end if;
  
    --根据传入的传染病报告卡ID查询报告卡信息
    IF v_edittype = '4' THEN
    
      open o_result for
        select * from THERIOMAREPORTCARD a where a.report_id = v_Report_ID;
    
    end if;
  
  end;

  /*********************************************************************************/
  --报表部分---肿瘤登记月报表 add by ywk 2013年7月31日 14:59:19
  PROCEDURE usp_GetTheriomaReportBYMonth( --v_searchtype    varchar default '', --增加此字段主要后期为i区分中心医院及其他的查询
                                         v_year          varchar default '', --年
                                         v_month         varchar default '', --月
                                         v_deptcode      varchar default '', --科室编码
                                         v_diagstartdate varchar default '', --诊断开始时间
                                         v_diagenddate   varchar default '', --诊断结束时间
                                         o_result        OUT empcurtyp) as
  begin
    --if v_searchtype = '1' then
    open o_result for
      select *
        from (select REPORT_INPATNAME as PATNAME,
                     sexinfo.name as SEXNAME,
                     REALAGE,
                     STATE,
                     reportdate,
                     material.name as MATRIAL,
                     jobinfo.name as JOB,
                     FIRSTDIADATE,
                     DEATHDATE,
                     DEATHREASON,
                     VAILD,
                     XZZPROVINCE || XZZCITY || XZZDISTRICT || XZZTOWN ||
                     XZZVILLIAGE as JZADDRESS,
                     REPORT_DIAGNOSIS,
                     '九江中医院' as HOSP,
                     (case
                       when instr(REPORT_DIAGNOSISBASED, '1', 1) <> 0 then
                        '临床'
                       when instr(REPORT_DIAGNOSISBASED, '2', 1) <> 0 then
                        'X线、CT、超声、内窥镜'
                       when instr(REPORT_DIAGNOSISBASED, '3', 1) <> 0 then
                        '手术、尸检'
                       when instr(REPORT_DIAGNOSISBASED, '4', 1) <> 0 then
                        '生化、免疫'
                       when instr(REPORT_DIAGNOSISBASED, '5', 1) <> 0 then
                        '细胞学、血片'
                       when instr(REPORT_DIAGNOSISBASED, '6', 1) <> 0 then
                        '病理（继发）'
                       when instr(REPORT_DIAGNOSISBASED, '7', 1) <> 0 then
                        '病理（原发）'
                       when instr(REPORT_DIAGNOSISBASED, '8', 1) <> 0 then
                        '尸检（有病理）'
                       when instr(REPORT_DIAGNOSISBASED, '9', 1) <> 0 then
                        '不详'
                       when instr(REPORT_DIAGNOSISBASED, '0', 1) <> 0 then
                        '死亡补发病'
                       else
                        ''
                     end) as DIAGYJ,
                     PATHOLOGICALTYPE,
                     QZDIAGTIME_T || QZDIAGTIME_N || QZDIAGTIME_M as QZDIAGTIME,
                     '' as MEMO
              
                from theriomareportcard tmpcard
                left join dictionary_detail material
                  on material.detailid = tmpcard.MARTIAL
                 and material.categoryid = '4'
                 AND material.valid = 1
                left join dictionary_detail sexinfo
                  on sexinfo.detailid = tmpcard.sexid
                 and sexinfo.categoryid = '3'
                 and sexinfo.valid = 1
                left join dictionary_detail jobinfo
                  on jobinfo.detailid = tmpcard.occupation
                 and jobinfo.categoryid = '41'
                 and jobinfo.valid = 1) A
       where A.reportdate like v_year || '-' || v_month || '%'
         and A.VAILD = '1'
         and A.STATE not in ('3', '5', '7');
    -- and A.FIRSTDIADATE >v_diagstartdate and A.FIRSTDIADATE<v_diagenddate ;   --'2013-0%';
  end;
  --报表部分---恶性肿瘤新发病例登记簿 add by ywk 2013年8月2日 11:29:02
  PROCEDURE usp_GetTheriomaReportBYNew( --v_searchtype    varchar default '', --增加此字段主要后期为i区分中心医院及其他的查询
                                       v_year   varchar default '', --年
                                       v_month  varchar default '', --月
                                       o_result OUT empcurtyp) as
  begin
    open o_result for
      select *
        from (select REPORT_INPATNAME as PATNAME,
                     sexinfo.name as SEXNAME,
                     REALAGE,
                     REPORT_NO,
                     '' HIGHDIAG,
                     '' SFTIME,
                     '' SFINFO,
                     OFFICEADDRESS,
                     reportdate,
                     material.name as MATRIAL,
                     jobinfo.name as JOB,
                     FIRSTDIADATE,
                     DEATHDATE,
                     DEATHREASON,
                     VAILD,
                     XZZPROVINCE || XZZCITY || XZZDISTRICT || XZZTOWN ||
                     XZZVILLIAGE as JZADDRESS,
                     REPORT_DIAGNOSIS,
                     '九江中医院' as HOSP,
                     (case
                       when instr(REPORT_DIAGNOSISBASED, '1', 1) <> 0 then
                        '临床'
                       when instr(REPORT_DIAGNOSISBASED, '2', 1) <> 0 then
                        'X线、CT、超声、内窥镜'
                       when instr(REPORT_DIAGNOSISBASED, '3', 1) <> 0 then
                        '手术、尸检'
                       when instr(REPORT_DIAGNOSISBASED, '4', 1) <> 0 then
                        '生化、免疫'
                       when instr(REPORT_DIAGNOSISBASED, '5', 1) <> 0 then
                        '细胞学、血片'
                       when instr(REPORT_DIAGNOSISBASED, '6', 1) <> 0 then
                        '病理（继发）'
                       when instr(REPORT_DIAGNOSISBASED, '7', 1) <> 0 then
                        '病理（原发）'
                       when instr(REPORT_DIAGNOSISBASED, '8', 1) <> 0 then
                        '尸检（有病理）'
                       when instr(REPORT_DIAGNOSISBASED, '9', 1) <> 0 then
                        '不详'
                       when instr(REPORT_DIAGNOSISBASED, '0', 1) <> 0 then
                        '死亡补发病'
                       else
                        ''
                     end) as DIAGYJ,
                     STATE,
                     PATHOLOGICALTYPE,
                     QZDIAGTIME_T || QZDIAGTIME_N || QZDIAGTIME_M as QZDIAGTIME,
                     '' as MEMO
              
                from theriomareportcard tmpcard
                left join dictionary_detail material
                  on material.detailid = tmpcard.MARTIAL
                 and material.categoryid = '4'
                 AND material.valid = 1
                left join dictionary_detail sexinfo
                  on sexinfo.detailid = tmpcard.sexid
                 and sexinfo.categoryid = '3'
                 and sexinfo.valid = 1
                left join dictionary_detail jobinfo
                  on jobinfo.detailid = tmpcard.occupation
                 and jobinfo.categoryid = '41'
                 and jobinfo.valid = 1) A
       where A.reportdate like v_year || '-' || v_month || '%'
         and A.DEATHDATE is null
         and A.VAILD = '1'
         and A.STATE not in ('3', '5', '7');
  end;

  --报表部分---恶性肿瘤死亡病例登记簿 add by ywk 2013年8月2日 11:29:02
  PROCEDURE usp_GetTheriomaReportBYDead( --v_searchtype    varchar default '', --增加此字段主要后期为i区分中心医院及其他的查询
                                        v_year   varchar default '', --年
                                        v_month  varchar default '', --月
                                        o_result OUT empcurtyp) as
  begin
    open o_result for
      select *
        from (select REPORT_INPATNAME as PATNAME,
                     sexinfo.name as SEXNAME,
                     REALAGE,
                     REPORT_NO,
                     OFFICEADDRESS,
                     reportdate,
                     material.name as MATRIAL,
                     jobinfo.name as JOB,
                     FIRSTDIADATE,
                     DEATHDATE,
                     DEATHREASON,
                     BIRTHDATE,
                     VAILD,
                     '' DIEADDRESS,
                     '' CULTURAL,
                     XZZPROVINCE || XZZCITY || XZZDISTRICT || XZZTOWN ||
                     XZZVILLIAGE as JZADDRESS,
                     REPORT_DIAGNOSIS,
                     '九江中医院' as HOSP,
                     (case
                       when instr(REPORT_DIAGNOSISBASED, '1', 1) <> 0 then
                        '临床'
                       when instr(REPORT_DIAGNOSISBASED, '2', 1) <> 0 then
                        'X线、CT、超声、内窥镜'
                       when instr(REPORT_DIAGNOSISBASED, '3', 1) <> 0 then
                        '手术、尸检'
                       when instr(REPORT_DIAGNOSISBASED, '4', 1) <> 0 then
                        '生化、免疫'
                       when instr(REPORT_DIAGNOSISBASED, '5', 1) <> 0 then
                        '细胞学、血片'
                       when instr(REPORT_DIAGNOSISBASED, '6', 1) <> 0 then
                        '病理（继发）'
                       when instr(REPORT_DIAGNOSISBASED, '7', 1) <> 0 then
                        '病理（原发）'
                       when instr(REPORT_DIAGNOSISBASED, '8', 1) <> 0 then
                        '尸检（有病理）'
                       when instr(REPORT_DIAGNOSISBASED, '9', 1) <> 0 then
                        '不详'
                       when instr(REPORT_DIAGNOSISBASED, '0', 1) <> 0 then
                        '死亡补发病'
                       else
                        ''
                     end) as DIAGYJ,
                     PATHOLOGICALTYPE,
                     QZDIAGTIME_T || QZDIAGTIME_N || QZDIAGTIME_M as QZDIAGTIME,
                     '' as MEMO,
                     STATE
              
                from theriomareportcard tmpcard
                left join dictionary_detail material
                  on material.detailid = tmpcard.MARTIAL
                 and material.categoryid = '4'
                 AND material.valid = 1
                left join dictionary_detail sexinfo
                  on sexinfo.detailid = tmpcard.sexid
                 and sexinfo.categoryid = '3'
                 and sexinfo.valid = 1
                left join dictionary_detail jobinfo
                  on jobinfo.detailid = tmpcard.occupation
                 and jobinfo.categoryid = '41'
                 and jobinfo.valid = 1) A
       where A.reportdate like v_year || '-' || v_month || '%'
         and A.DEATHDATE is not null
         and A.VAILD = '1'
         and A.STATE not in ('3', '5', '7');
  end;

  --报表部分---肿瘤登记月报表 add by ywk 2013年8月5日 11:33:25中心医院
  PROCEDURE usp_GetTheriomaReportBYMonthZX( --v_searchtype    varchar default '', --增加此字段主要后期为i区分中心医院及其他的查询
                                           v_year          varchar default '', --年
                                           v_month         varchar default '', --月
                                           v_deptcode      varchar default '', --科室编码
                                           v_diagstartdate varchar default '', --诊断开始时间
                                           v_diagenddate   varchar default '', --诊断结束时间
                                           o_result        OUT empcurtyp) as
  begin
    --if v_searchtype = '1' then
    open o_result for
      select *
        from (select REPORT_INPATNAME as PATNAME,
                     sexinfo.name as SEXNAME,
                     REALAGE,
                     STATE,
                     reportdate,
                     material.name as MATRIAL,
                     jobinfo.name as JOB,
                     FIRSTDIADATE,
                     DEATHDATE,
                     DEATHREASON,
                     VAILD,
                     REPORT_NO,
                     REPORT_PATID,
                     BIRTHDATE,
                     CONTACTTEL,
                     users.name as REPORTDOCTORNAME,
                     REPORTDOCTOR,
                     REPORT_INDO,
                     CREATE_DEPTNAME as BGDEPT, --报告科室
                     REPORTDIAGFUNIT, --诊断单位
                     d.name as DIAGUNIT, --诊断单位名称
                     XZZPROVINCE || XZZCITY || XZZDISTRICT || XZZTOWN ||
                     XZZVILLIAGE as JZADDRESS,
                     REPORT_DIAGNOSIS,
                     '九江中医院' as HOSP,
                     (case
                       when instr(REPORT_DIAGNOSISBASED, '1', 1) <> 0 then
                        '临床'
                       when instr(REPORT_DIAGNOSISBASED, '2', 1) <> 0 then
                        'X线、CT、超声、内窥镜'
                       when instr(REPORT_DIAGNOSISBASED, '3', 1) <> 0 then
                        '手术、尸检'
                       when instr(REPORT_DIAGNOSISBASED, '4', 1) <> 0 then
                        '生化、免疫'
                       when instr(REPORT_DIAGNOSISBASED, '5', 1) <> 0 then
                        '细胞学、血片'
                       when instr(REPORT_DIAGNOSISBASED, '6', 1) <> 0 then
                        '病理（继发）'
                       when instr(REPORT_DIAGNOSISBASED, '7', 1) <> 0 then
                        '病理（原发）'
                       when instr(REPORT_DIAGNOSISBASED, '8', 1) <> 0 then
                        '尸检（有病理）'
                       when instr(REPORT_DIAGNOSISBASED, '9', 1) <> 0 then
                        '不详'
                       when instr(REPORT_DIAGNOSISBASED, '0', 1) <> 0 then
                        '死亡补发病'
                       else
                        ''
                     end) as DIAGYJ,
                     PATHOLOGICALTYPE,
                     QZDIAGTIME_T || QZDIAGTIME_N || QZDIAGTIME_M as QZDIAGTIME,
                     '' as MEMO
              
                from theriomareportcard tmpcard
                left join dictionary_detail material
                  on material.detailid = tmpcard.MARTIAL
                 and material.categoryid = '4'
                 AND material.valid = 1
                left join dictionary_detail sexinfo
                  on sexinfo.detailid = tmpcard.sexid
                 and sexinfo.categoryid = '3'
                 and sexinfo.valid = 1
                left join dictionary_detail jobinfo
                  on jobinfo.detailid = tmpcard.occupation
                 and jobinfo.categoryid = '41'
                 and jobinfo.valid = 1
                left join users
                  on tmpcard.reportdoctor = users.id
                left join department d
                  on tmpcard.ReportDiagfunit = d.id) A
       where A.reportdate like v_year || '-' || v_month || '%'
         and A.VAILD = '1'
         and A.STATE not in ('3', '5', '7');
    -- and A.FIRSTDIADATE >v_diagstartdate and A.FIRSTDIADATE<v_diagenddate ;   --'2013-0%';
  end;

------------------脑卒中，冠心病报表-------------------add  by  jxh  2013-9-7  15:30
 PROCEDURE usp_CardiovascularReport( --v_searchtype    varchar default '', --增加此字段主要后期为i区分中心医院及其他的查询
                                           v_year          varchar default '', --年
                                           v_month         varchar default '', --月
                                           v_deptcode      varchar default '', --科室编码
                                           v_diagstartdate varchar default '', --诊断开始时间
                                           v_diagenddate   varchar default '', --诊断结束时间
                                           o_result        OUT empcurtyp) as
  begin
    --if v_searchtype = '1' then
    open o_result for
      select *
        from (select   REPORT_NO,--编号
                       PATID,--住院号
                       diovcard.NAME,--姓名
                       sexinfo.name as SEXNAME,--性别
                       AGE,--年龄
                       STATE,--状态
                       jobinfo.name as JOB,--职业
                       XZZPROVICE || XZZCITY || XZZSTREET || XZZCOMMITTEES ||
                       XZZPARM as JZADDRESS,--居住地址
                       OFFICEPLACE,--单位地址
                       z.name as DIAGNAME,--诊断    
                       DIAGNOSEDATE,--确诊日期  
                       DIAGHOSPITAL,--诊断单位  
                       CASE diovcard.isfirstsick
                            WHEN '1' THEN
                             '是'
                             ELSE
                             '否'
                       END ISFIRSTSICK,
                       --ISFIRSTSICK,--是否首次发病   
                       REPORTDATE,--报卡日期
                       REPORTUSERNAME,--报卡医师
                       CREATE_DEPTNAME,--报告科室
                       DIEDATE,--死亡日期
                       VAILD --是否有效                   
                from cardiovascularcard diovcard    
                left join zymosis_diagnosis z on diovcard.Icd = z.icd           
                left join dictionary_detail sexinfo
                  on sexinfo.detailid = diovcard.sexid
                 and sexinfo.categoryid = '3'
                 and sexinfo.valid = 1
                left join dictionary_detail jobinfo
                  on jobinfo.detailid = diovcard.jobid
                 and jobinfo.categoryid = '41'
                 and jobinfo.valid = 1
                left join users
                  on diovcard.REPORTUSERCODE = users.id) A
               
       where A.reportdate like v_year || '-' || v_month || '%'
         and A.VAILD = '1'
         and A.STATE not in ('3', '5', '7');
    -- and A.FIRSTDIADATE >v_diagstartdate and A.FIRSTDIADATE<v_diagenddate ;   --'2013-0%';
  end;

  --保存或修改艾滋病报表
  PROCEDURE usp_AddOrModHIVReport(v_HIVID               varchar2,
                                  v_REPORTID            integer,
                                  v_REPORTNO            varchar2,
                                  v_MARITALSTATUS       varchar2,
                                  v_NATION              varchar2,
                                  v_CULTURESTATE        varchar2,
                                  v_HOUSEHOLDSCOPE      varchar2,
                                  v_HOUSEHOLDADDRESS    varchar2,
                                  v_ADDRESS             varchar2,
                                  v_CONTACTHISTORY      varchar2,
                                  v_VENERISMHISTORY     varchar2,
                                  v_INFACTWAY           varchar2,
                                  v_SAMPLESOURCE        varchar2,
                                  v_DETECTIONCONCLUSION varchar2,
                                  v_AFFIRMDATE          varchar2,
                                  v_AFFIRMLOCAL         varchar2,
                                  v_DIAGNOSEDATE        varchar2,
                                  v_DOCTOR              varchar2,
                                  v_WRITEDATE           varchar2,
                                  v_ALIKESYMBOL         varchar2,
                                  v_REMARK              varchar2,
                                  v_VAILD               varchar2,
                                  v_CREATOR             varchar2,
                                  v_CREATEDATE          varchar2,
                                  v_MENDER              varchar2,
                                  v_ALTERDATE           varchar2) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from zymosis_hiv z
     where z.hiv_id = v_HIVID;
    if v_count <= 0 then
      insert into zymosis_hiv
        (HIV_ID,
         REPORT_ID,
         REPORT_NO,
         MARITALSTATUS,
         NATION,
         CULTURESTATE,
         HOUSEHOLDSCOPE,
         HOUSEHOLDADDRESS,
         ADDRESS,
         CONTACTHISTORY,
         VENERISMHISTORY,
         INFACTWAY,
         SAMPLESOURCE,
         DETECTIONCONCLUSION,
         AFFIRMDATE,
         AFFIRMLOCAL,
         DIAGNOSEDATE,
         DOCTOR,
         WRITEDATE,
         ALIKESYMBOL,
         REMARK,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE)
      values
        (v_HIVID,
         v_REPORTID,
         v_REPORTNO,
         v_MARITALSTATUS,
         v_NATION,
         v_CULTURESTATE,
         v_HOUSEHOLDSCOPE,
         v_HOUSEHOLDADDRESS,
         v_ADDRESS,
         v_CONTACTHISTORY,
         v_VENERISMHISTORY,
         v_INFACTWAY,
         v_SAMPLESOURCE,
         v_DETECTIONCONCLUSION,
         v_AFFIRMDATE,
         v_AFFIRMLOCAL,
         v_DIAGNOSEDATE,
         v_DOCTOR,
         v_WRITEDATE,
         v_ALIKESYMBOL,
         v_REMARK,
         '1',
         v_CREATOR,
         v_CREATEDATE,
         v_MENDER,
         v_ALTERDATE);
    else
      update zymosis_hiv
         set REPORT_ID           = v_REPORTID,
             REPORT_NO           = v_REPORTNO,
             MARITALSTATUS       = v_MARITALSTATUS,
             NATION              = v_NATION,
             CULTURESTATE        = v_CULTURESTATE,
             HOUSEHOLDSCOPE      = v_HOUSEHOLDSCOPE,
             HOUSEHOLDADDRESS    = v_HOUSEHOLDADDRESS,
             ADDRESS             = v_ADDRESS,
             CONTACTHISTORY      = v_CONTACTHISTORY,
             VENERISMHISTORY     = v_VENERISMHISTORY,
             INFACTWAY           = v_INFACTWAY,
             SAMPLESOURCE        = v_SAMPLESOURCE,
             DETECTIONCONCLUSION = v_DETECTIONCONCLUSION,
             AFFIRMDATE          = v_AFFIRMDATE,
             AFFIRMLOCAL         = v_AFFIRMLOCAL,
             DIAGNOSEDATE        = v_DIAGNOSEDATE,
             DOCTOR              = v_DOCTOR,
             WRITEDATE           = v_WRITEDATE,
             ALIKESYMBOL         = v_ALIKESYMBOL,
             REMARK              = v_REMARK,
             MENDER              = v_MENDER,
             ALTERDATE           = v_ALTERDATE
       where HIV_ID = v_HIVID;
    
    end if;
  end;

  --保存或修改沙眼衣原体感染
  PROCEDURE usp_AddOrModSYYYTReport(v_SZDYYTID            varchar,
                                    v_REPORTID            integer,
                                    v_REPORTNO            varchar,
                                    v_MARITALSTATUS       varchar,
                                    v_NATION              varchar,
                                    v_CULTURESTATE        varchar,
                                    v_HOUSEHOLDSCOPE      varchar,
                                    v_HOUSEHOLDADDRESS    varchar,
                                    v_ADDRESS             varchar,
                                    v_SYYYTGR             varchar,
                                    v_CONTACTHISTORY      varchar,
                                    v_VENERISMHISTORY     varchar,
                                    v_INFACTWAY           varchar,
                                    v_SAMPLESOURCE        varchar,
                                    v_DETECTIONCONCLUSION varchar,
                                    v_AFFIRMDATE          varchar,
                                    v_AFFIRMLOCAL         varchar,
                                    v_VAILD               varchar,
                                    v_CREATOR             varchar,
                                    v_CREATEDATE          varchar,
                                    v_MENDER              varchar,
                                    v_ALTERDATE           varchar) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from zymosis_szdyyt z
     where z.SZDYYT_ID = v_SZDYYTID;
    if v_count <= 0 then
      insert into zymosis_szdyyt
        (SZDYYT_ID,
         REPORT_ID,
         REPORT_NO,
         MARITALSTATUS,
         NATION,
         CULTURESTATE,
         HOUSEHOLDSCOPE,
         HOUSEHOLDADDRESS,
         ADDRESS,
         SYYYTGR,
         CONTACTHISTORY,
         VENERISMHISTORY,
         INFACTWAY,
         SAMPLESOURCE,
         DETECTIONCONCLUSION,
         AFFIRMDATE,
         AFFIRMLOCAL,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE)
      values
        (v_szdyytid,
         v_reportid,
         v_reportno,
         v_maritalstatus,
         v_nation,
         v_culturestate,
         v_householdscope,
         v_householdaddress,
         v_address,
         v_syyytgr,
         v_contacthistory,
         v_venerismhistory,
         v_infactway,
         v_samplesource,
         v_detectionconclusion,
         v_affirmdate,
         v_affirmlocal,
         '1',
         v_creator,
         v_createdate,
         v_mender,
         v_alterdate);
    else
      update zymosis_szdyyt
         set report_id           = v_reportid,
             report_no           = v_reportno,
             maritalstatus       = v_maritalstatus,
             nation              = v_nation,
             culturestate        = v_culturestate,
             householdscope      = v_householdscope,
             householdaddress    = v_householdaddress,
             address             = v_address,
             syyytgr             = v_syyytgr,
             contacthistory      = v_contacthistory,
             venerismhistory     = v_venerismhistory,
             infactway           = v_infactway,
             samplesource        = v_samplesource,
             detectionconclusion = v_detectionconclusion,
             affirmdate          = v_affirmdate,
             affirmlocal         = v_affirmlocal,
             vaild               = v_vaild,
             creator             = v_creator,
             createdate          = v_createdate,
             mender              = v_mender,
             alterdate           = v_alterdate
       where szdyyt_id = v_szdyytid;
    end if;
  end;

  --保存或修改乙肝报表
  PROCEDURE usp_AddOrModHBVReport(v_HBVID varchar2,
                                  
                                  v_REPORTID      integer,
                                  v_HBSAGDATE     varchar2,
                                  v_FRISTDATE     varchar2,
                                  v_ALT           varchar2,
                                  v_ANTIHBC       varchar2,
                                  v_LIVERBIOPSY   varchar2,
                                  v_RECOVERYHBSAG varchar2,
                                  
                                  v_VAILD      varchar2,
                                  v_CREATOR    varchar2,
                                  v_CREATEDATE varchar2,
                                  v_MENDER     varchar2,
                                  v_ALTERDATE  varchar2) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from ZYMOSIS_HBV z
     where z.HBVID = v_HBVID
       and z.vaild = '1';
    if v_count <= 0 then
      insert into ZYMOSIS_HBV
        (HBVID,
         REPORTID,
         HBSAGDATE,
         FRISTDATE,
         ALT,
         ANTIHBC,
         LIVERBIOPSY,
         RECOVERYHBSAG,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE)
      values
        (v_HBVID,
         v_REPORTID,
         v_HBSAGDATE,
         v_FRISTDATE,
         v_ALT,
         v_ANTIHBC,
         v_LIVERBIOPSY,
         v_RECOVERYHBSAG,
         '1',
         v_CREATOR,
         v_CREATEDATE,
         v_MENDER,
         v_ALTERDATE);
    else
      update ZYMOSIS_HBV
         set REPORTID      = v_REPORTID,
             HBSAGDATE     = v_HBSAGDATE,
             FRISTDATE     = v_FRISTDATE,
             ALT           = v_ALT,
             ANTIHBC       = v_ANTIHBC,
             LIVERBIOPSY   = v_LIVERBIOPSY,
             RECOVERYHBSAG = v_RECOVERYHBSAG,
             MENDER        = v_MENDER,
             ALTERDATE     = v_ALTERDATE
       where HBVID = v_HBVID;
    
    end if;
  end;

  --保存或修改尖锐湿疣项目
  PROCEDURE usp_AddOrModJRSYReport(v_JRSY_ID             varchar,
                                   v_REPORTID            integer,
                                   v_REPORTNO            varchar,
                                   v_MARITALSTATUS       varchar,
                                   v_NATION              varchar,
                                   v_CULTURESTATE        varchar,
                                   v_HOUSEHOLDSCOPE      varchar,
                                   v_HOUSEHOLDADDRESS    varchar,
                                   v_ADDRESS             varchar,
                                   v_CONTACTHISTORY      varchar,
                                   v_VENERISMHISTORY     varchar,
                                   v_INFACTWAY           varchar,
                                   v_SAMPLESOURCE        varchar,
                                   v_DETECTIONCONCLUSION varchar,
                                   v_AFFIRMDATE          varchar,
                                   v_AFFIRMLOCAL         varchar,
                                   v_VAILD               varchar,
                                   v_CREATOR             varchar,
                                   v_CREATEDATE          varchar,
                                   v_MENDER              varchar,
                                   v_ALTERDATE           varchar) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from ZYMOSIS_JRSY z
     where z.JRSY_ID = v_JRSY_ID;
    if v_count <= 0 then
      insert into ZYMOSIS_JRSY
        (JRSY_ID,
         REPORT_ID,
         REPORT_NO,
         MARITALSTATUS,
         NATION,
         CULTURESTATE,
         HOUSEHOLDSCOPE,
         HOUSEHOLDADDRESS,
         ADDRESS,
         CONTACTHISTORY,
         VENERISMHISTORY,
         INFACTWAY,
         SAMPLESOURCE,
         DETECTIONCONCLUSION,
         AFFIRMDATE,
         AFFIRMLOCAL,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE)
      values
        (v_JRSY_ID,
         v_reportid,
         v_reportno,
         v_maritalstatus,
         v_nation,
         v_culturestate,
         v_householdscope,
         v_householdaddress,
         v_address,
         v_contacthistory,
         v_venerismhistory,
         v_infactway,
         v_samplesource,
         v_detectionconclusion,
         v_affirmdate,
         v_affirmlocal,
         '1',
         v_creator,
         v_createdate,
         v_mender,
         v_alterdate);
    else
      update ZYMOSIS_JRSY
         set report_id           = v_reportid,
             report_no           = v_reportno,
             maritalstatus       = v_maritalstatus,
             nation              = v_nation,
             culturestate        = v_culturestate,
             householdscope      = v_householdscope,
             householdaddress    = v_householdaddress,
             address             = v_address,
             contacthistory      = v_contacthistory,
             venerismhistory     = v_venerismhistory,
             infactway           = v_infactway,
             samplesource        = v_samplesource,
             detectionconclusion = v_detectionconclusion,
             affirmdate          = v_affirmdate,
             affirmlocal         = v_affirmlocal,
             vaild               = v_vaild,
             creator             = v_creator,
             createdate          = v_createdate,
             mender              = v_mender,
             alterdate           = v_alterdate
       where JRSY_ID = v_JRSY_ID;
    end if;
  end;

  --保存或修改甲型H1N1流感报表
  PROCEDURE usp_AddOrModH1N1Report(v_H1N1ID         varchar2,
                                   v_REPORTID       integer,
                                   v_CASETYPE       varchar2,
                                   v_HOSPITALSTATUS varchar2,
                                   v_ISCURE         varchar2,
                                   v_ISOVERSEAS     varchar2,
                                   v_VAILD          varchar2,
                                   v_CREATOR        varchar2,
                                   v_CREATEDATE     varchar2,
                                   v_MENDER         varchar2,
                                   v_ALTERDATE      varchar2) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from ZYMOSIS_H1N1 z
     where z.H1N1ID = v_H1N1ID
       and z.vaild = '1';
    if v_count <= 0 then
      insert into ZYMOSIS_H1N1
        (H1N1ID,
         REPORTID,
         CASETYPE,
         HOSPITALSTATUS,
         ISCURE,
         ISOVERSEAS,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE)
      values
        (v_H1N1ID,
         v_REPORTID,
         v_CASETYPE,
         v_HOSPITALSTATUS,
         v_ISCURE,
         v_ISOVERSEAS,
         '1',
         v_CREATOR,
         v_CREATEDATE,
         v_MENDER,
         v_ALTERDATE);
    else
      update ZYMOSIS_H1N1
         set REPORTID       = v_REPORTID,
             CASETYPE       = v_CASETYPE,
             HOSPITALSTATUS = v_HOSPITALSTATUS,
             ISCURE         = v_ISCURE,
             ISOVERSEAS     = v_ISOVERSEAS,
             MENDER         = v_MENDER,
             ALTERDATE      = v_ALTERDATE
       where H1N1ID = v_H1N1ID;
    end if;
  end;

  --保存或修改手足口病报告表
  PROCEDURE usp_AddOrModHFMDReport(v_HFMDID     varchar2,
                                   v_REPORTID   integer,
                                   v_LABRESULT  varchar2,
                                   v_ISSEVERE   varchar2,
                                   v_VAILD      varchar2,
                                   v_CREATOR    varchar2,
                                   v_CREATEDATE varchar2,
                                   v_MENDER     varchar2,
                                   v_ALTERDATE  varchar2) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from ZYMOSIS_HFMD z
     where z.HFMDID = v_HFMDID;
    if v_count <= 0 then
      insert into ZYMOSIS_HFMD
        (HFMDID,
         REPORTID,
         LABRESULT,
         ISSEVERE,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE)
      values
        (v_HFMDID,
         v_REPORTID,
         v_LABRESULT,
         v_ISSEVERE,
         '1',
         v_CREATOR,
         v_CREATEDATE,
         v_MENDER,
         v_ALTERDATE);
    else
      update ZYMOSIS_HFMD
         set REPORTID  = v_REPORTID,
             LABRESULT = v_LABRESULT,
             ISSEVERE  = v_ISSEVERE,
             MENDER    = v_MENDER,
             ALTERDATE = v_ALTERDATE
       where HFMDID = v_HFMDID;
    end if;
  end;

  --保存或修改AFP报告表
  PROCEDURE usp_AddOrModAFPReport(v_AFPID            varchar2,
                                  v_REPORTID         integer,
                                  v_HOUSEHOLDSCOPE   varchar2,
                                  v_HOUSEHOLDADDRESS varchar2,
                                  v_ADDRESS          varchar2,
                                  v_PALSYDATE        varchar2,
                                  v_PALSYSYMPTOM     varchar2,
                                  v_VAILD            varchar2,
                                  v_CREATOR          varchar2,
                                  v_CREATEDATE       varchar2,
                                  v_MENDER           varchar2,
                                  v_ALTERDATE        varchar2,
                                  v_DIAGNOSISDATE    varchar2) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from ZYMOSIS_AFP z
     where z.AFPID = v_AFPID;
    if v_count <= 0 then
      insert into ZYMOSIS_AFP
        (AFPID,
         REPORTID,
         HOUSEHOLDSCOPE,
         HOUSEHOLDADDRESS,
         ADDRESS,
         PALSYDATE,
         PALSYSYMPTOM,
         VAILD,
         CREATOR,
         CREATEDATE,
         MENDER,
         ALTERDATE,
         DIAGNOSISDATE)
      values
        (v_AFPID,
         v_REPORTID,
         v_HOUSEHOLDSCOPE,
         v_HOUSEHOLDADDRESS,
         v_ADDRESS,
         v_PALSYDATE,
         v_PALSYSYMPTOM,
         '1',
         v_CREATOR,
         v_CREATEDATE,
         v_MENDER,
         v_ALTERDATE,
         v_DIAGNOSISDATE);
    else
      update ZYMOSIS_AFP
         set REPORTID         = v_REPORTID,
             HOUSEHOLDSCOPE   = v_HOUSEHOLDSCOPE,
             HOUSEHOLDADDRESS = v_HOUSEHOLDADDRESS,
             ADDRESS          = v_ADDRESS,
             PALSYDATE        = v_PALSYDATE,
             PALSYSYMPTOM     = v_PALSYSYMPTOM,
             MENDER           = v_MENDER,
             ALTERDATE        = v_ALTERDATE,
             DIAGNOSISDATE    = v_DIAGNOSISDATE
       where AFPID = v_AFPID;
    end if;
  end;

  --脑卒中报告卡  add  by  ywk 2013年8月21日 15:47:00
  PROCEDURE usp_EditCardiovacular_Report(v_EditType      varchar, --操作类型
                                        
                                         v_REPORT_NO     varchar DEFAULT '', --报告卡卡号                                 
                                         v_NOOFCLINIC    varchar DEFAULT '', --门诊号 
                                         v_PATID         varchar default '',
                                         v_NAME          varchar default '',
                                         v_IDNO          varchar default '',
                                         v_SEXID         varchar default '',
                                         v_BIRTH         varchar default '',
                                         v_AGE           varchar DEFAULT '',
                                         v_NATIONID      varchar default '',
                                         v_JOBID         varchar default '',
                                         v_OFFICEPLACE   varchar default '',
                                         v_CONTACTTEL    varchar default '',
                                         v_HKPROVICE     varchar default '',
                                         v_HKCITY        varchar default '',
                                         v_HKSTREET      varchar default '',
                                         v_HKADDRESSID   varchar default '',
                                         v_XZZPROVICE    varchar default '',
                                         v_XZZCITY       varchar default '',
                                         v_XZZSTREET     varchar default '',
                                         v_XZZADDRESSID  varchar default '',
                                         v_XZZCOMMITTEES varchar default '',
                                         v_XZZPARM         varchar default '',
                                         v_ICD             varchar default '',
                                         v_DIAGZWMXQCX     varchar default '',
                                         v_DIAGNCX         varchar default '',
                                         v_DIAGNGS         varchar default '',
                                         v_DIAGWFLNZZ      varchar default '',
                                         v_DIAGJXXJGS      varchar default '',
                                         v_DIAGXXCS        varchar default '',
                                         v_DIAGNOSISBASED  varchar default '',
                                         v_DIAGNOSEDATE    varchar default '',
                                         v_ISFIRSTSICK     varchar default '',
                                         v_DIAGHOSPITAL    varchar default '',
                                         v_OUTFLAG         varchar default '',
                                         v_DIEDATE         varchar default '',
                                         v_REPORTDEPT      varchar default '',
                                         v_REPORTUSERCODE  varchar default '',
                                         v_REPORTUSERNAME  varchar default '',
                                         v_REPORTDATE      varchar default '',
                                         v_CREATE_DATE     varchar default '',
                                         v_CREATE_USERCODE varchar default '',
                                         v_CREATE_USERNAME varchar default '',
                                         v_CREATE_DEPTCODE varchar default '',
                                         v_CREATE_DEPTNAME varchar default '',
                                         v_MODIFY_DATE     varchar default '',
                                         v_MODIFY_USERCODE varchar default '',
                                         v_MODIFY_USERNAME varchar default '',
                                         v_MODIFY_DEPTCODE varchar default '',
                                         v_MODIFY_DEPTNAME varchar default '',
                                         v_AUDIT_DATE      varchar default '',
                                         v_AUDIT_USERCODE  varchar default '',
                                         v_AUDIT_USERNAME  varchar default '',
                                         v_AUDIT_DEPTCODE  varchar default '',
                                         v_AUDIT_DEPTNAME  varchar default '',
                                         v_VAILD           varchar default '',
                                         v_CANCELREASON    varchar default '',
                                         v_STATE           varchar default '',
                                         v_CARDPARAM1      varchar default '',
                                         v_CARDPARAM2      varchar default '',
                                         v_CARDPARAM3      varchar default '',
                                         v_CARDPARAM4      varchar default '',
                                         v_CARDPARAM5      varchar default '',
                                         v_NOOFINPAT       varchar default '',
                                          v_REPORTID      varchar DEFAULT '',
                                         o_result          OUT empcurtyp) as
    v_Report_ID_new int;
  BEGIN
  
    --新增传染病报告卡
    IF v_edittype = '1' THEN
    
      select seq_cardiovascularcard_ID.Nextval
        into v_Report_ID_new
        from dual;
      --select 1 into v_Report_ID_new from dual;
      insert into CARDIOVASCULARCARD
        (ID,
         REPORT_NO,
         NOOFCLINIC,
         PATID,
         NAME,
         IDNO,
         SEXID,
         BIRTH,
         AGE,
         NATIONID,
         JOBID,
         OFFICEPLACE,
         CONTACTTEL,
         HKPROVICE,
         HKCITY,
         HKSTREET,
         HKADDRESSID,
         XZZPROVICE,
         XZZCITY,
         XZZSTREET,
         XZZADDRESSID,
         XZZCOMMITTEES,
         XZZPARM,
         ICD,
         DIAGZWMXQCX,
         DIAGNCX,
         DIAGNGS,
         DIAGWFLNZZ,
         DIAGJXXJGS,
         DIAGXXCS,
         DIAGNOSISBASED,
         DIAGNOSEDATE,
         ISFIRSTSICK,
         DIAGHOSPITAL,
         OUTFLAG,
         DIEDATE,
         REPORTDEPT,
         REPORTUSERCODE,
         REPORTUSERNAME,
         REPORTDATE,
         CREATE_DATE,
         CREATE_USERCODE,
         CREATE_USERNAME,
         CREATE_DEPTCODE,
         CREATE_DEPTNAME,
         MODIFY_DATE,
         MODIFY_USERCODE,
         MODIFY_USERNAME,
         MODIFY_DEPTCODE,
         MODIFY_DEPTNAME,
         AUDIT_DATE,
         AUDIT_USERCODE,
         AUDIT_USERNAME,
         AUDIT_DEPTCODE,
         AUDIT_DEPTNAME,
         VAILD,
         CANCELREASON,
         STATE,
         CARDPARAM1,
         CARDPARAM2,
         CARDPARAM3,
         CARDPARAM4,
         CARDPARAM5,
         NOOFINPAT)
      values
        (v_Report_ID_new,
         v_REPORT_NO,
         v_NOOFCLINIC,
         v_PATID,
         v_NAME,
         v_IDNO,
         v_SEXID,
         v_BIRTH,
         v_AGE,
         v_NATIONID,
         v_JOBID,
         v_OFFICEPLACE,
         v_CONTACTTEL,
         v_HKPROVICE,
         v_HKCITY,
         v_HKSTREET,
         v_HKADDRESSID,
         v_XZZPROVICE,
         v_XZZCITY,
         v_XZZSTREET,
         v_XZZADDRESSID,
         v_XZZCOMMITTEES,
         v_XZZPARM,
         v_ICD,
         v_DIAGZWMXQCX,
         v_DIAGNCX,
         v_DIAGNGS,
         v_DIAGWFLNZZ,
         v_DIAGJXXJGS,
         v_DIAGXXCS,
         v_DIAGNOSISBASED,
         v_DIAGNOSEDATE,
         v_ISFIRSTSICK,
         v_DIAGHOSPITAL,
         v_OUTFLAG,
         v_DIEDATE,
         v_REPORTDEPT,
         v_REPORTUSERCODE,
         v_REPORTUSERNAME,
         v_REPORTDATE,
         v_CREATE_DATE,
         v_CREATE_USERCODE,
         v_CREATE_USERNAME,
         v_CREATE_DEPTCODE,
         v_CREATE_DEPTNAME,
         v_MODIFY_DATE,
         v_MODIFY_USERCODE,
         v_MODIFY_USERNAME,
         v_MODIFY_DEPTCODE,
         v_MODIFY_DEPTNAME,
         v_AUDIT_DATE,
         v_AUDIT_USERCODE,
         v_AUDIT_USERNAME,
         v_AUDIT_DEPTCODE,
         v_AUDIT_DEPTNAME,
         v_VAILD,
         v_CANCELREASON,
         v_STATE,
         v_CARDPARAM1,
         v_CARDPARAM2,
         v_CARDPARAM3,
         v_CARDPARAM4,
         v_CARDPARAM5,
         v_NOOFINPAT);
    
      open o_result for
        select v_Report_ID_new from dual;
    
    end if;
  
    --修改保存脑卒中报告卡信息
    IF v_edittype = '2' THEN
      
      update CARDIOVASCULARCARD set  
         REPORT_NO=v_REPORT_NO,
         NOOFCLINIC=v_NOOFCLINIC,
         PATID=v_PATID,
         NAME=v_NAME,
         IDNO=v_IDNO,
         SEXID=v_SEXID,
         BIRTH=v_BIRTH,
         AGE=v_AGE,
         NATIONID=v_NATIONID,
         JOBID=v_JOBID,
         OFFICEPLACE=v_OFFICEPLACE,
         CONTACTTEL=v_CONTACTTEL,
         HKPROVICE=v_HKPROVICE,
         HKCITY=v_HKCITY,
         HKSTREET=v_HKSTREET,
         HKADDRESSID=v_HKADDRESSID,
         XZZPROVICE=v_XZZPROVICE,
         XZZCITY=v_XZZCITY,
         XZZSTREET=v_XZZSTREET,
         XZZADDRESSID=v_XZZADDRESSID,
         XZZCOMMITTEES=v_XZZCOMMITTEES,
         XZZPARM=v_XZZPARM,
         ICD=v_ICD,
         DIAGZWMXQCX=v_DIAGZWMXQCX,
         DIAGNCX=v_DIAGNCX,
         DIAGNGS=v_DIAGNGS,
         DIAGWFLNZZ=v_DIAGWFLNZZ,
         DIAGJXXJGS=v_DIAGJXXJGS,
         DIAGXXCS=v_DIAGXXCS,
         DIAGNOSISBASED=v_DIAGNOSISBASED,
         DIAGNOSEDATE=v_DIAGNOSEDATE,
         ISFIRSTSICK=v_ISFIRSTSICK,
         DIAGHOSPITAL=V_DIAGHOSPITAL,
         OUTFLAG=V_OUTFLAG,
         DIEDATE=V_DIEDATE,
         REPORTDEPT=V_REPORTDEPT,
         REPORTUSERCODE=V_REPORTUSERCODE,
         REPORTUSERNAME=V_REPORTUSERNAME,
         REPORTDATE=V_REPORTDATE,
         CREATE_DATE=nvl(v_CREATE_DATE, CREATE_DATE),
         CREATE_USERCODE=nvl(v_CREATE_USERCODE, CREATE_USERCODE),
         CREATE_USERNAME=nvl(v_CREATE_USERNAME, CREATE_USERNAME),
         CREATE_DEPTCODE=nvl(v_CREATE_DEPTCODE, CREATE_DEPTCODE),
         CREATE_DEPTNAME=nvl(v_CREATE_DEPTNAME, CREATE_DEPTNAME),
         MODIFY_DATE=nvl(v_MODIFY_DATE, MODIFY_DATE),
         MODIFY_USERCODE=nvl(v_MODIFY_USERCODE, MODIFY_USERCODE),
         MODIFY_USERNAME=nvl(v_MODIFY_USERNAME, MODIFY_USERNAME),
         MODIFY_DEPTCODE=nvl(v_MODIFY_DEPTCODE, MODIFY_DEPTCODE),
         MODIFY_DEPTNAME=nvl(v_MODIFY_DEPTNAME, MODIFY_DEPTNAME),
         AUDIT_DATE=nvl(v_AUDIT_DATE, AUDIT_DATE),
         AUDIT_USERCODE=nvl(v_AUDIT_USERCODE, AUDIT_USERCODE),
         AUDIT_USERNAME=nvl(v_AUDIT_USERNAME, AUDIT_USERNAME),
         AUDIT_DEPTCODE=nvl(v_AUDIT_DEPTCODE, AUDIT_DEPTCODE),
         AUDIT_DEPTNAME=nvl(v_AUDIT_DEPTNAME, AUDIT_DEPTNAME),
         VAILD=V_VAILD,
         CANCELREASON=V_CANCELREASON,
         STATE=V_STATE,
         CARDPARAM1=V_CARDPARAM1,
         CARDPARAM2=V_CARDPARAM2,
         CARDPARAM3=V_CARDPARAM3,
         CARDPARAM4=V_CARDPARAM4,
         CARDPARAM5=V_CARDPARAM5,
         NOOFINPAT=V_NOOFINPAT
      where ID=v_REPORTID;
    
      open o_result for
    
    select v_REPORTID from dual;
    end if;
  
    --作废脑卒中报告卡信息
    IF v_edittype = '3' THEN
    
      update CARDIOVASCULARCARD ca
         set ca.vaild = 0
       where ca.id = v_REPORTID;
      --select 1 into v_Report_ID_new from dual;
    
      open o_result for
        select 1 into v_Report_ID_new from dual;
    end if;
  
    --根据传入的脑卒中报告卡ID查询报告卡信息
    IF v_edittype = '4' THEN
    
      open o_result for
        select * from CARDIOVASCULARCARD a where a.id = v_REPORTID;
    
    end if;
  
  end;

END;
/

prompt
prompt Creating package body IEM_MAIN_PAGE
prompt ===================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.iem_main_page IS
  /*插入病案首页信息*/
  PROCEDURE usp_insertiembasicinfo(v_patnoofhis               varchar,
                                   v_noofinpat                varchar,
                                   v_payid                    VARCHAR,
                                   v_socialcare               VARCHAR,
                                   v_incount                  VARCHAR,
                                   v_name                     VARCHAR,
                                   v_sexid                    VARCHAR,
                                   v_birth                    VARCHAR,
                                   v_marital                  VARCHAR,
                                   v_jobid                    VARCHAR,
                                   v_provinceid               VARCHAR,
                                   v_countyid                 VARCHAR,
                                   v_nationid                 VARCHAR,
                                   v_nationalityid            VARCHAR,
                                   v_idno                     VARCHAR,
                                   v_organization             VARCHAR,
                                   v_officeplace              VARCHAR,
                                   v_officetel                VARCHAR,
                                   v_officepost               VARCHAR,
                                   v_nativeaddress            VARCHAR,
                                   v_nativetel                VARCHAR,
                                   v_nativepost               VARCHAR,
                                   v_contactperson            VARCHAR,
                                   v_relationship             VARCHAR,
                                   v_contactaddress           VARCHAR,
                                   v_contacttel               VARCHAR,
                                   v_admitdate                VARCHAR,
                                   v_admitdept                VARCHAR,
                                   v_admitward                VARCHAR,
                                   v_days_before              VARCHAR,
                                   v_trans_date               VARCHAR,
                                   v_trans_admitdept          VARCHAR,
                                   v_trans_admitward          VARCHAR,
                                   v_trans_admitdept_again    VARCHAR,
                                   v_outwarddate              VARCHAR,
                                   v_outhosdept               VARCHAR,
                                   v_outhosward               VARCHAR,
                                   v_actual_days              VARCHAR,
                                   v_death_time               VARCHAR,
                                   v_death_reason             VARCHAR,
                                   v_admitinfo                VARCHAR,
                                   v_in_check_date            VARCHAR,
                                   v_pathology_diagnosis_name VARCHAR,
                                   v_pathology_observation_sn VARCHAR,
                                   v_ashes_diagnosis_name     VARCHAR,
                                   v_ashes_anatomise_sn       VARCHAR,
                                   v_allergic_drug            VARCHAR,
                                   v_hbsag                    VARCHAR,
                                   v_hcv_ab                   VARCHAR,
                                   v_hiv_ab                   VARCHAR,
                                   v_opd_ipd_id               VARCHAR,
                                   v_in_out_inpatinet_id      VARCHAR,
                                   v_before_after_or_id       VARCHAR,
                                   v_clinical_pathology_id    VARCHAR,
                                   v_pacs_pathology_id        VARCHAR,
                                   v_save_times               VARCHAR,
                                   v_success_times            VARCHAR,
                                   v_section_director         VARCHAR,
                                   v_director                 VARCHAR,
                                   v_vs_employee_code         VARCHAR,
                                   v_resident_employee_code   VARCHAR,
                                   v_refresh_employee_code    VARCHAR,
                                   v_master_interne           VARCHAR,
                                   v_interne                  VARCHAR,
                                   v_coding_user              VARCHAR,
                                   v_medical_quality_id       VARCHAR,
                                   v_quality_control_doctor   VARCHAR,
                                   v_quality_control_nurse    VARCHAR,
                                   v_quality_control_date     VARCHAR,
                                   v_xay_sn                   VARCHAR,
                                   v_ct_sn                    VARCHAR,
                                   v_mri_sn                   VARCHAR,
                                   v_dsa_sn                   VARCHAR,
                                   v_is_first_case            VARCHAR,
                                   v_is_following             VARCHAR,
                                   v_following_ending_date    VARCHAR,
                                   v_is_teaching_case         VARCHAR,
                                   v_blood_type_id            VARCHAR,
                                   v_rh                       VARCHAR,
                                   v_blood_reaction_id        VARCHAR,
                                   v_blood_rbc                VARCHAR,
                                   v_blood_plt                VARCHAR,
                                   v_blood_plasma             VARCHAR,
                                   v_blood_wb                 VARCHAR,
                                   v_blood_others             VARCHAR,
                                   v_is_completed             VARCHAR,
                                   v_completed_time           VARCHAR,
                                   v_create_user              VARCHAR,
                                   v_Zymosis                  varchar,
                                   v_Hurt_Toxicosis_Ele       varchar,
                                   v_ZymosisState             varchar,
                                   o_result                   OUT empcurtyp) IS
  BEGIN
    INSERT INTO iem_mainpage_basicinfo
      (iem_mainpage_no,
       patnoofhis,
       noofinpat,
       payid,
       socialcare,
       incount,
       NAME,
       sexid,
       birth,
       marital,
       jobid,
       provinceid,
       countyid,
       nationid,
       nationalityid,
       idno,
       ORGANIZATION,
       officeplace,
       officetel,
       officepost,
       nativeaddress,
       nativetel,
       nativepost,
       contactperson,
       relationship,
       contactaddress,
       contacttel,
       admitdate,
       admitdept,
       admitward,
       days_before,
       trans_date,
       trans_admitdept,
       trans_admitward,
       trans_admitdept_again,
       outwarddate,
       outhosdept,
       outhosward,
       actual_days,
       death_time,
       death_reason,
       admitinfo,
       in_check_date,
       pathology_diagnosis_name,
       pathology_observation_sn,
       ashes_diagnosis_name,
       ashes_anatomise_sn,
       allergic_drug,
       hbsag,
       hcv_ab,
       hiv_ab,
       opd_ipd_id,
       in_out_inpatinet_id,
       before_after_or_id,
       clinical_pathology_id,
       pacs_pathology_id,
       save_times,
       success_times,
       section_director,
       director,
       vs_employee_code,
       resident_employee_code,
       refresh_employee_code,
       master_interne,
       interne,
       coding_user,
       medical_quality_id,
       quality_control_doctor,
       quality_control_nurse,
       quality_control_date,
       xay_sn,
       ct_sn,
       mri_sn,
       dsa_sn,
       is_first_case,
       is_following,
       following_ending_date,
       is_teaching_case,
       blood_type_id,
       rh,
       blood_reaction_id,
       blood_rbc,
       blood_plt,
       blood_plasma,
       blood_wb,
       blood_others,
       is_completed,
       completed_time,
       create_user,
       valide,
       create_time,
       Zymosis,
       Hurt_Toxicosis_Ele,
       ZymosisState)
    VALUES
      (seq_iem_mainpage_basicinfo_id.NEXTVAL,
       v_patnoofhis,
       v_noofinpat,
       v_payid,
       v_socialcare,
       v_incount,
       v_name,
       v_sexid,
       v_birth,
       v_marital,
       v_jobid,
       v_provinceid,
       v_countyid,
       v_nationid,
       v_nationalityid,
       v_idno,
       v_organization,
       v_officeplace,
       v_officetel,
       v_officepost,
       v_nativeaddress,
       v_nativetel,
       v_nativepost,
       v_contactperson,
       v_relationship,
       v_contactaddress,
       v_contacttel,
       v_admitdate,
       v_admitdept,
       v_admitward,
       v_days_before,
       v_trans_date,
       v_trans_admitdept,
       v_trans_admitward,
       v_trans_admitdept_again,
       v_outwarddate,
       v_outhosdept,
       v_outhosward,
       v_actual_days,
       v_death_time,
       v_death_reason,
       v_admitinfo,
       v_in_check_date,
       v_pathology_diagnosis_name,
       v_pathology_observation_sn,
       v_ashes_diagnosis_name,
       v_ashes_anatomise_sn,
       v_allergic_drug,
       v_hbsag,
       v_hcv_ab,
       v_hiv_ab,
       v_opd_ipd_id,
       v_in_out_inpatinet_id,
       v_before_after_or_id,
       v_clinical_pathology_id,
       v_pacs_pathology_id,
       v_save_times,
       v_success_times,
       v_section_director,
       v_director,
       v_vs_employee_code,
       v_resident_employee_code,
       v_refresh_employee_code,
       v_master_interne,
       v_interne,
       v_coding_user,
       v_medical_quality_id,
       v_quality_control_doctor,
       v_quality_control_nurse,
       v_quality_control_date,
       v_xay_sn,
       v_ct_sn,
       v_mri_sn,
       v_dsa_sn,
       v_is_first_case,
       v_is_following,
       v_following_ending_date,
       v_is_teaching_case,
       v_blood_type_id,
       v_rh,
       v_blood_reaction_id,
       v_blood_rbc,
       v_blood_plt,
       v_blood_plasma,
       v_blood_wb,
       v_blood_others,
       v_is_completed,
       v_completed_time,
       v_create_user,
       1,
       TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss'),
       v_Zymosis,
       v_Hurt_Toxicosis_Ele,
       v_ZymosisState);
  
    OPEN o_result FOR
      SELECT seq_iem_mainpage_basicinfo_id.CURRVAL FROM DUAL;
  END;

  /*修改病案首页信息*/
  PROCEDURE usp_Upateiembasicinfo(v_iem_mainpage_no          varchar,
                                  v_patnoofhis               varchar,
                                  v_noofinpat                integer,
                                  v_payid                    VARCHAR,
                                  v_socialcare               VARCHAR,
                                  v_incount                  VARCHAR,
                                  v_name                     VARCHAR,
                                  v_sexid                    VARCHAR,
                                  v_birth                    VARCHAR,
                                  v_marital                  VARCHAR,
                                  v_jobid                    VARCHAR,
                                  v_provinceid               VARCHAR,
                                  v_countyid                 VARCHAR,
                                  v_nationid                 VARCHAR,
                                  v_nationalityid            VARCHAR,
                                  v_idno                     VARCHAR,
                                  v_organization             VARCHAR,
                                  v_officeplace              VARCHAR,
                                  v_officetel                VARCHAR,
                                  v_officepost               VARCHAR,
                                  v_nativeaddress            VARCHAR,
                                  v_nativetel                VARCHAR,
                                  v_nativepost               VARCHAR,
                                  v_contactperson            VARCHAR,
                                  v_relationship             VARCHAR,
                                  v_contactaddress           VARCHAR,
                                  v_contacttel               VARCHAR,
                                  v_admitdate                VARCHAR,
                                  v_admitdept                VARCHAR,
                                  v_admitward                VARCHAR,
                                  v_days_before              VARCHAR,
                                  v_trans_date               VARCHAR,
                                  v_trans_admitdept          VARCHAR,
                                  v_trans_admitward          VARCHAR,
                                  v_trans_admitdept_again    VARCHAR,
                                  v_outwarddate              VARCHAR,
                                  v_outhosdept               VARCHAR,
                                  v_outhosward               VARCHAR,
                                  v_actual_days              VARCHAR,
                                  v_death_time               VARCHAR,
                                  v_death_reason             VARCHAR,
                                  v_admitinfo                VARCHAR,
                                  v_in_check_date            VARCHAR,
                                  v_pathology_diagnosis_name VARCHAR,
                                  v_pathology_observation_sn VARCHAR,
                                  v_ashes_diagnosis_name     VARCHAR,
                                  v_ashes_anatomise_sn       VARCHAR,
                                  v_allergic_drug            VARCHAR,
                                  v_hbsag                    VARCHAR,
                                  v_hcv_ab                   VARCHAR,
                                  v_hiv_ab                   VARCHAR,
                                  v_opd_ipd_id               VARCHAR,
                                  v_in_out_inpatinet_id      VARCHAR,
                                  v_before_after_or_id       VARCHAR,
                                  v_clinical_pathology_id    VARCHAR,
                                  v_pacs_pathology_id        VARCHAR,
                                  v_save_times               VARCHAR,
                                  v_success_times            VARCHAR,
                                  v_section_director         VARCHAR,
                                  v_director                 VARCHAR,
                                  v_vs_employee_code         VARCHAR,
                                  v_resident_employee_code   VARCHAR,
                                  v_refresh_employee_code    VARCHAR,
                                  v_master_interne           VARCHAR,
                                  v_interne                  VARCHAR,
                                  v_coding_user              VARCHAR,
                                  v_medical_quality_id       VARCHAR,
                                  v_quality_control_doctor   VARCHAR,
                                  v_quality_control_nurse    VARCHAR,
                                  v_quality_control_date     VARCHAR,
                                  v_xay_sn                   VARCHAR,
                                  v_ct_sn                    VARCHAR,
                                  v_mri_sn                   VARCHAR,
                                  v_dsa_sn                   VARCHAR,
                                  v_is_first_case            VARCHAR,
                                  v_is_following             VARCHAR,
                                  v_following_ending_date    VARCHAR,
                                  v_is_teaching_case         VARCHAR,
                                  v_blood_type_id            VARCHAR,
                                  v_rh                       VARCHAR,
                                  v_blood_reaction_id        VARCHAR,
                                  v_blood_rbc                VARCHAR,
                                  v_blood_plt                VARCHAR,
                                  v_blood_plasma             VARCHAR,
                                  v_blood_wb                 VARCHAR,
                                  v_blood_others             VARCHAR,
                                  v_is_completed             VARCHAR,
                                  v_completed_time           VARCHAR,
                                  v_Zymosis                  varchar,
                                  v_Hurt_Toxicosis_Ele       varchar,
                                  v_ZymosisState             varchar,
                                  o_result                   OUT empcurtyp) IS
  BEGIN
    update iem_mainpage_basicinfo
       set patnoofhis               = v_patnoofhis,
           noofinpat                = v_noofinpat,
           payid                    = v_payid,
           socialcare               = v_socialcare,
           incount                  = v_incount,
           NAME                     = v_NAME,
           sexid                    = v_sexid,
           birth                    = v_birth,
           marital                  = v_marital,
           jobid                    = v_jobid,
           provinceid               = v_provinceid,
           countyid                 = v_countyid,
           nationid                 = v_nationid,
           nationalityid            = v_nationalityid,
           idno                     = v_idno,
           ORGANIZATION             = v_ORGANIZATION,
           officeplace              = v_officeplace,
           officetel                = v_officetel,
           officepost               = v_officepost,
           nativeaddress            = v_nativeaddress,
           nativetel                = v_nativetel,
           nativepost               = v_nativepost,
           contactperson            = v_contactperson,
           relationship             = v_relationship,
           contactaddress           = v_contactaddress,
           contacttel               = v_contacttel,
           admitdate                = v_admitdate,
           admitdept                = v_admitdept,
           admitward                = v_admitward,
           days_before              = v_days_before,
           trans_date               = v_trans_date,
           trans_admitdept          = v_trans_admitdept,
           trans_admitward          = v_trans_admitward,
           trans_admitdept_again    = v_trans_admitdept_again,
           outwarddate              = v_outwarddate,
           outhosdept               = v_outhosdept,
           outhosward               = v_outhosward,
           actual_days              = v_actual_days,
           death_time               = v_death_time,
           death_reason             = v_death_reason,
           admitinfo                = v_admitinfo,
           in_check_date            = v_in_check_date,
           pathology_diagnosis_name = v_pathology_diagnosis_name,
           pathology_observation_sn = v_pathology_observation_sn,
           ashes_diagnosis_name     = v_ashes_diagnosis_name,
           ashes_anatomise_sn       = v_ashes_anatomise_sn,
           allergic_drug            = v_allergic_drug,
           hbsag                    = v_hbsag,
           hcv_ab                   = v_hcv_ab,
           hiv_ab                   = v_hiv_ab,
           opd_ipd_id               = v_opd_ipd_id,
           in_out_inpatinet_id      = v_in_out_inpatinet_id,
           before_after_or_id       = v_before_after_or_id,
           clinical_pathology_id    = v_clinical_pathology_id,
           pacs_pathology_id        = v_pacs_pathology_id,
           save_times               = v_save_times,
           success_times            = v_success_times,
           section_director         = v_section_director,
           director                 = v_director,
           vs_employee_code         = v_vs_employee_code,
           resident_employee_code   = v_resident_employee_code,
           refresh_employee_code    = v_refresh_employee_code,
           master_interne           = v_master_interne,
           interne                  = v_interne,
           coding_user              = v_coding_user,
           medical_quality_id       = v_medical_quality_id,
           quality_control_doctor   = v_quality_control_doctor,
           quality_control_nurse    = v_quality_control_nurse,
           quality_control_date     = v_quality_control_date,
           xay_sn                   = v_xay_sn,
           ct_sn                    = v_ct_sn,
           mri_sn                   = v_mri_sn,
           dsa_sn                   = v_dsa_sn,
           is_first_case            = v_is_first_case,
           is_following             = v_is_following,
           following_ending_date    = v_following_ending_date,
           is_teaching_case         = v_is_teaching_case,
           blood_type_id            = v_blood_type_id,
           rh                       = v_rh,
           blood_reaction_id        = v_blood_reaction_id,
           blood_rbc                = v_blood_rbc,
           blood_plt                = v_blood_plt,
           blood_plasma             = v_blood_plasma,
           blood_wb                 = v_blood_wb,
           blood_others             = v_blood_others,
           is_completed             = v_is_completed,
           completed_time           = v_completed_time,
           Zymosis                  = v_Zymosis,
           Hurt_Toxicosis_Ele       = v_Hurt_Toxicosis_Ele,
           ZymosisState             = v_ZymosisState
     where iem_mainpage_no = v_iem_mainpage_no
       and valide = 1;
  
    OPEN o_result FOR
      SELECT v_iem_mainpage_no FROM DUAL;
  END;

  /*********************************************************************************/
  PROCEDURE usp_insert_iem_mainpage_diag(v_iem_mainpage_no   VARCHAR,
                                         v_diagnosis_type_id VARCHAR,
                                         v_diagnosis_code    VARCHAR,
                                         v_diagnosis_name    VARCHAR,
                                         v_status_id         VARCHAR,
                                         v_order_value       VARCHAR,
                                         --v_Valide numeric ,
                                         v_create_user VARCHAR
                                         --v_Create_Time varchar(19) ,
                                         --v_Cancel_User varchar(10) ,
                                         --v_Cancel_Time varchar(19)
                                         ) AS /**********
                                                                                   版本号  1.0.0.0.0
                                                                                   创建时间
                                                                                   作者
                                                                                   版权
                                                                                   描述  插入功病案首页诊断TABLE
                                                                                   功能说明
                                                                                   输入参数
                                                                                   输出参数
                                                                                   结果集、排序
            
                                                                                   调用的sp
                                                                                   调用实例
            
                                                                                   修改记录
                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_diagnosis
      (iem_mainpage_diagnosis_no,
       iem_mainpage_no,
       diagnosis_type_id,
       diagnosis_code,
       diagnosis_name,
       status_id,
       order_value,
       valide,
       create_user,
       create_time)
    VALUES
      (seq_iem_mainpage_diagnosis_id.NEXTVAL,
       v_iem_mainpage_no, -- Iem_Mainpage_NO - numeric
       v_diagnosis_type_id,
       -- Diagnosis_Type_Id - numeric
       v_diagnosis_code,
       -- Diagnosis_Code - varchar(60)
       v_diagnosis_name, -- Diagnosis_Name - varchar(300)
       v_status_id, -- Status_Id - numeric
       v_order_value,
       -- Order_Value - numeric
       1,
       -- Valide - numeric
       v_create_user, -- Create_User - varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss')
       -- Create_Time - varchar(19)
       );
  END;

  /*********************************************************************************/
  PROCEDURE usp_insert_iem_mainpage_oper(v_iem_mainpage_no     NUMERIC,
                                         v_operation_code      VARCHAR,
                                         v_operation_date      VARCHAR,
                                         v_operation_name      VARCHAR,
                                         v_execute_user1       VARCHAR,
                                         v_execute_user2       VARCHAR,
                                         v_execute_user3       VARCHAR,
                                         v_anaesthesia_type_id NUMERIC,
                                         v_close_level         NUMERIC,
                                         v_anaesthesia_user    VARCHAR,
                                         --v_Valide numeric ,
                                         v_create_user VARCHAR
                                         --v_Create_Time varchar(19)
                                         --v_Cancel_User varchar(10) ,
                                         --v_Cancel_Time varchar(19)
                                         ) AS /**********
                                                                                   版本号  1.0.0.0.0
                                                                                   创建时间
                                                                                   作者
                                                                                   版权
                                                                                   描述  插入功病案首页手术TABLE
                                                                                   功能说明
                                                                                   输入参数
                                                                                   输出参数
                                                                                   结果集、排序
            
                                                                                   调用的sp
                                                                                   调用实例
            
                                                                                   修改记录
                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_operation
      (iem_mainpage_operation_no,
       iem_mainpage_no,
       operation_code,
       operation_date,
       operation_name,
       execute_user1,
       execute_user2,
       execute_user3,
       anaesthesia_type_id,
       close_level,
       anaesthesia_user,
       valide,
       create_user,
       create_time)
    VALUES
      (seq_iem_mainpage_operation_id.NEXTVAL,
       v_iem_mainpage_no, --numeric
       v_operation_code, -- varchar(60)
       v_operation_date,
       -- varchar(19)
       v_operation_name, -- varchar(300)
       v_execute_user1, -- varchar(20)
       v_execute_user2,
       -- varchar(20)
       v_execute_user3, -- varchar(20)
       v_anaesthesia_type_id, -- numeric
       v_close_level,
       -- numeric
       v_anaesthesia_user, -- varchar(20)
       1, -- numeric
       v_create_user, -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'));
  END;

  /*
  * 插入病案首页中 产妇婴儿信息
  */
  PROCEDURE usp_insert_iem_main_ObsBaby(v_iem_mainpage_no NUMERIC,
                                        v_IBSBABYID       VARCHAR, --编号
                                        v_TC              VARCHAR, --胎次
                                        v_CC              VARCHAR, -- 产次
                                        v_TB              VARCHAR, -- 胎别
                                        v_CFHYPLD         VARCHAR, --产妇会阴破裂度
                                        v_MIDWIFERY       VARCHAR, --接产者
                                        v_SEX             VARCHAR, --性别
                                        v_APJ             VARCHAR, -- 阿帕加评加
                                        v_HEIGH           VARCHAR, --身长
                                        v_WEIGHT          VARCHAR, --体重
                                        v_CCQK            VARCHAR, --产出情况
                                        v_BITHDAY         VARCHAR, --出生时间
                                        v_FMFS            VARCHAR, --     分娩方式
                                        v_CYQK            VARCHAR,
                                        v_create_user     VARCHAR) as
  begin
    insert into IEM_MAINPAGE_OBSTETRICSBABY
      (IEM_MAINPAGE_OBSBABYID,
       IEM_MAINPAGE_NO,
       IBSBABYID, --编号
       TC, --胎次
       CC, -- 产次
       TB, -- 胎别
       CFHYPLD, --产妇会阴破裂度
       MIDWIFERY, --接产者
       SEX, --性别
       APJ, -- 阿帕加评加
       HEIGH, --身长
       WEIGHT, --体重
       CCQK, --产出情况
       BITHDAY, --出生时间
       FMFS, --      分娩方式
       CYQK, --出院情况
       create_user,
       create_time)
    values
      (SEQ_IEM_MAINPAGE_OBSBABY_ID.Nextval,
       v_IEM_MAINPAGE_NO,
       v_IBSBABYID, --编号
       v_TC, --胎次
       v_CC, -- 产次
       v_TB, -- 胎别
       v_CFHYPLD, --产妇会阴破裂度
       v_MIDWIFERY, --接产者
       v_SEX, --性别
       v_APJ, -- 阿帕加评加
       v_HEIGH, --身长
       v_WEIGHT, --体重
       v_CCQK, --产出情况
       v_BITHDAY, --出生时间
       v_FMFS, --      分娩方式
       v_CYQK,
       v_create_user, -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'));
  end;

  /*
  * 插入一条病人信息(在没有连HIS的情况下手动输入病人信息)
  */
  PROCEDURE usp_insertpatientinfo(v_noofinpat       varchar,
                                  v_patnoofhis      VARCHAR,
                                  v_Noofclinic      VARCHAR,
                                  v_Noofrecord      VARCHAR,
                                  v_patid           VARCHAR,
                                  v_Innerpix        VARCHAR,
                                  v_outpix          VARCHAR,
                                  v_Name            VARCHAR,
                                  v_py              VARCHAR,
                                  v_wb              VARCHAR,
                                  v_payid           VARCHAR,
                                  v_ORIGIN          VARCHAR,
                                  v_InCount         int DEFAULT 0,
                                  v_sexid           VARCHAR,
                                  v_Birth           VARCHAR,
                                  v_Age             int DEFAULT 0,
                                  v_AgeStr          VARCHAR,
                                  v_IDNO            VARCHAR,
                                  v_Marital         VARCHAR,
                                  v_JobID           VARCHAR,
                                  v_CSDProvinceID   VARCHAR,
                                  v_CSDCityID       VARCHAR,
                                  v_CSDDistrictID   VARCHAR,
                                  v_NationID        VARCHAR,
                                  v_NationalityID   VARCHAR,
                                  v_JGProvinceID    VARCHAR,
                                  v_JGCityID        VARCHAR,
                                  v_Organization    VARCHAR,
                                  v_OfficePlace     VARCHAR,
                                  v_OfficeTEL       VARCHAR,
                                  v_OfficePost      VARCHAR,
                                  v_HKDZProvinceID  VARCHAR,
                                  v_HKDZCityID      VARCHAR,
                                  v_HKDZDistrictID  VARCHAR,
                                  v_NATIVEPOST      VARCHAR,
                                  v_NATIVETEL       VARCHAR,
                                  v_NATIVEADDRESS   VARCHAR,
                                  v_ADDRESS         VARCHAR,
                                  v_ContactPerson   VARCHAR,
                                  v_RelationshipID  VARCHAR,
                                  v_ContactAddress  VARCHAR,
                                  v_ContactTEL      VARCHAR,
                                  v_CONTACTOFFICE   VARCHAR,
                                  v_CONTACTPOST     VARCHAR,
                                  v_OFFERER         VARCHAR,
                                  v_SocialCare      VARCHAR,
                                  v_INSURANCE       VARCHAR,
                                  v_CARDNO          VARCHAR,
                                  v_ADMITINFO       VARCHAR,
                                  v_AdmitDeptID     VARCHAR,
                                  v_AdmitWardID     VARCHAR,
                                  v_ADMITBED        VARCHAR,
                                  v_AdmitDate       VARCHAR,
                                  v_INWARDDATE      VARCHAR,
                                  v_ADMITDIAGNOSIS  VARCHAR,
                                  v_OutWardDate     VARCHAR,
                                  v_OutHosDeptID    VARCHAR,
                                  v_OutHosWardID    VARCHAR,
                                  v_OutBed          VARCHAR,
                                  v_OUTHOSDATE      VARCHAR,
                                  v_OUTDIAGNOSIS    VARCHAR,
                                  v_TOTALDAYS       int DEFAULT 0,
                                  v_CLINICDIAGNOSIS VARCHAR,
                                  v_SOLARTERMS      VARCHAR,
                                  v_ADMITWAY        VARCHAR,
                                  v_OUTWAY          VARCHAR,
                                  v_CLINICDOCTOR    VARCHAR,
                                  v_RESIDENT        VARCHAR,
                                  v_ATTEND          VARCHAR,
                                  v_CHIEF           VARCHAR,
                                  v_EDU             VARCHAR,
                                  v_EDUC            int DEFAULT 0,
                                  v_RELIGION        VARCHAR,
                                  v_STATUS          int DEFAULT 0,
                                  v_CRITICALLEVEL   VARCHAR,
                                  v_ATTENDLEVEL     VARCHAR,
                                  v_EMPHASIS        int DEFAULT 0,
                                  v_ISBABY          int DEFAULT 0,
                                  v_MOTHER          NUMERIC,
                                  v_MEDICAREID      VARCHAR,
                                  v_MEDICAREQUOTA   int DEFAULT 0,
                                  v_VOUCHERSCODE    VARCHAR,
                                  v_STYLE           VARCHAR,
                                  v_OPERATOR        VARCHAR,
                                  v_MEMO            VARCHAR,
                                  v_CPSTATUS        int DEFAULT 0,
                                  v_OUTWARDBED      int DEFAULT 0,
                                  v_XZZProvinceID   VARCHAR,
                                  v_XZZCityID       VARCHAR,
                                  v_XZZDistrictID   VARCHAR,
                                  v_XZZTEL          VARCHAR,
                                  v_XZZPost         VARCHAR) as
    i_count integer;
  begin
    select count(*)
      into i_count
      from inpatient
     where inpatient.noofinpat = v_noofinpat;
    if (i_count <= 0) then
      insert into inpatient
        (NOOFINPAT,
         PATNOOFHIS,
         NOOFCLINIC,
         NOOFRECORD,
         PATID,
         INNERPIX,
         OUTPIX,
         NAME,
         PY,
         WB,
         PAYID,
         ORIGIN,
         INCOUNT,
         SEXID,
         BIRTH,
         AGE,
         AGESTR,
         IDNO,
         MARITAL,
         JOBID,
         PROVINCEID,
         COUNTYID,
         NATIONID,
         NATIONALITYID,
         NATIVEPLACE_P,
         NATIVEPLACE_C,
         ORGANIZATION,
         OFFICEPLACE,
         OFFICETEL,
         OFFICEPOST,
         NATIVEADDRESS,
         NATIVETEL,
         NATIVEPOST,
         ADDRESS,
         CONTACTPERSON,
         RELATIONSHIP,
         CONTACTADDRESS,
         CONTACTOFFICE,
         CONTACTTEL,
         CONTACTPOST,
         OFFERER,
         SOCIALCARE,
         INSURANCE,
         CARDNO,
         ADMITINFO,
         ADMITDEPT,
         ADMITWARD,
         ADMITBED,
         ADMITDATE,
         INWARDDATE,
         ADMITDIAGNOSIS,
         OUTHOSDEPT,
         OUTHOSWARD,
         OUTBED,
         OUTWARDDATE,
         OUTHOSDATE,
         OUTDIAGNOSIS,
         TOTALDAYS,
         CLINICDIAGNOSIS,
         SOLARTERMS,
         ADMITWAY,
         OUTWAY,
         CLINICDOCTOR,
         RESIDENT,
         ATTEND,
         CHIEF,
         EDU,
         EDUC,
         RELIGION,
         STATUS,
         CRITICALLEVEL,
         ATTENDLEVEL,
         EMPHASIS,
         ISBABY,
         MOTHER,
         MEDICAREID,
         MEDICAREQUOTA,
         VOUCHERSCODE,
         STYLE,
         OPERATOR,
         MEMO,
         CPSTATUS,
         OUTWARDBED,
         DISTRICTID,
         XZZPROVICEID,
         XZZCITYID,
         XZZDISTRICTID,
         XZZTEL,
         HKDZPROVICEID,
         HKZDCITYID,
         HKZDDISTRICTID,
         XZZPOST)
      values
        (SEQ_INPATIENT_ID.NEXTVAL,
         v_patnoofhis,
         v_Noofclinic,
         v_Noofrecord,
         v_patid,
         v_Innerpix,
         v_outpix,
         v_Name,
         v_py,
         v_wb,
         v_payid,
         v_ORIGIN,
         v_InCount,
         v_sexid,
         v_Birth,
         v_Age,
         v_AgeStr,
         v_IDNO,
         v_Marital,
         v_JobID,
         v_CSDProvinceID,
         v_CSDCityID,
         v_NationID,
         v_NationalityID,
         v_JGProvinceID,
         v_JGCityID,
         v_Organization,
         v_OfficePlace,
         v_OfficeTEL,
         v_OfficePost,
         v_NATIVEADDRESS,
         v_NATIVETEL,
         v_NATIVEPOST,
         v_ADDRESS,
         v_ContactPerson,
         v_RelationshipID,
         v_ContactAddress,
         v_CONTACTOFFICE,
         v_ContactTEL,
         v_CONTACTPOST,
         v_OFFERER,
         v_SocialCare,
         v_INSURANCE,
         v_CARDNO,
         v_ADMITINFO,
         v_AdmitDeptID,
         v_AdmitWardID,
         v_ADMITBED,
         v_AdmitDate,
         v_INWARDDATE,
         v_ADMITDIAGNOSIS,
         v_OutHosDeptID,
         v_OutHosWardID,
         v_OutBed,
         v_OutWardDate,
         v_OUTHOSDATE,
         v_OUTDIAGNOSIS,
         v_TOTALDAYS,
         v_CLINICDIAGNOSIS,
         v_SOLARTERMS,
         v_ADMITWAY,
         v_OUTWAY,
         v_CLINICDOCTOR,
         v_RESIDENT,
         v_ATTEND,
         v_CHIEF,
         v_EDU,
         v_EDUC,
         v_RELIGION,
         v_STATUS,
         v_CRITICALLEVEL,
         v_ATTENDLEVEL,
         v_EMPHASIS,
         v_ISBABY,
         v_MOTHER,
         v_MEDICAREID,
         v_MEDICAREQUOTA,
         v_VOUCHERSCODE,
         v_STYLE,
         v_OPERATOR,
         v_memo,
         v_CPSTATUS,
         v_OUTWARDBED,
         v_CSDDistrictID,
         v_XZZProvinceID,
         v_XZZCityID,
         v_XZZDistrictID,
         v_XZZTEL,
         v_HKDZProvinceID,
         v_HKDZCityID,
         v_HKDZDistrictID,
         v_XZZPost);
    else
      update inpatient
         set --PATNOOFHIS      = v_patnoofhis,
             --NOOFCLINIC      = v_Noofclinic,
             --NOOFRECORD      = v_Noofrecord,
             --PATID           = v_patid,
             INNERPIX        = v_Innerpix,
             OUTPIX          = v_outpix,
             NAME            = v_Name,
             PY              = v_py,
             WB              = v_wb,
             PAYID           = v_payid,
             ORIGIN          = v_ORIGIN,
             INCOUNT         = v_InCount,
             SEXID           = v_sexid,
             BIRTH           = v_Birth,
             AGE             = v_Age,
             AGESTR          = v_AgeStr,
             IDNO            = v_IDNO,
             MARITAL         = v_Marital,
             JOBID           = v_JobID,
             PROVINCEID      = v_CSDProvinceID,
             COUNTYID        = v_CSDCityID,
             NATIONID        = v_NationID,
             NATIONALITYID   = v_NationalityID,
             NATIVEPLACE_P   = v_JGProvinceID,
             NATIVEPLACE_C   = v_JGCityID,
             ORGANIZATION    = v_Organization,
             OFFICEPLACE     = v_OfficePlace,
             OFFICETEL       = v_OfficeTEL,
             OFFICEPOST      = v_OfficePost,
             NATIVEADDRESS   = v_NATIVEADDRESS,
             NATIVETEL       = v_NATIVETEL,
             NATIVEPOST      = v_NATIVEPOST,
             ADDRESS         = v_ADDRESS,
             CONTACTPERSON   = v_ContactPerson,
             RELATIONSHIP    = v_RelationshipID,
             CONTACTADDRESS  = v_ContactAddress,
             CONTACTOFFICE   = v_CONTACTOFFICE,
             CONTACTTEL      = v_ContactTEL,
             CONTACTPOST     = v_CONTACTPOST,
             OFFERER         = v_OFFERER,
             SOCIALCARE      = v_SocialCare,
             INSURANCE       = v_INSURANCE,
             CARDNO          = v_CARDNO,
             ADMITINFO       = v_ADMITINFO,
             ADMITDEPT       = v_AdmitDeptID,
             ADMITWARD       = v_AdmitWardID,
             ADMITBED        = v_ADMITBED,
             --ADMITDATE       = v_AdmitDate,
            -- INWARDDATE      = v_INWARDDATE,
             ADMITDIAGNOSIS  = v_ADMITDIAGNOSIS,
             OUTHOSDEPT      = v_OutHosDeptID,
             OUTHOSWARD      = v_OutHosWardID,
             OUTBED          = v_OutBed,
             OUTWARDDATE     = v_OutWardDate,
             OUTHOSDATE      = v_OUTHOSDATE,
             OUTDIAGNOSIS    = v_OUTDIAGNOSIS,
             TOTALDAYS       = v_TOTALDAYS,
             CLINICDIAGNOSIS = v_CLINICDIAGNOSIS,
             SOLARTERMS      = v_SOLARTERMS,
             ADMITWAY        = v_ADMITWAY,
             OUTWAY          = v_OUTWAY,
             CLINICDOCTOR    = v_CLINICDOCTOR,
             RESIDENT        = v_RESIDENT,
             ATTEND          = v_ATTEND,
             CHIEF           = v_CHIEF,
             EDU             = v_EDU,
             EDUC            = v_EDUC,
             RELIGION        = v_RELIGION,
             STATUS          = v_STATUS,
             CRITICALLEVEL   = v_CRITICALLEVEL,
             ATTENDLEVEL     = v_ATTENDLEVEL,
             EMPHASIS        = v_EMPHASIS,
             ISBABY          = v_ISBABY,
             MOTHER          = v_MOTHER,
             MEDICAREID      = v_MEDICAREID,
             MEDICAREQUOTA   = v_MEDICAREQUOTA,
             VOUCHERSCODE    = v_VOUCHERSCODE,
             STYLE           = v_STYLE,
             OPERATOR        = v_OPERATOR,
             MEMO            = v_memo,
             CPSTATUS        = v_CPSTATUS,
             OUTWARDBED      = v_OUTWARDBED,
             DISTRICTID      = v_CSDDistrictID,
             XZZPROVICEID    = v_XZZProvinceID,
             XZZCITYID       = v_XZZCityID,
             XZZDISTRICTID   = v_XZZDistrictID,
             XZZTEL          = v_XZZTEL,
             HKDZPROVICEID   = v_HKDZProvinceID,
             HKZDCITYID      = v_HKDZCityID,
             HKZDDISTRICTID  = v_HKDZDistrictID,
             XZZPOST         = v_XZZPost
       where inpatient.noofinpat = v_noofinpat;
    end if;
  end;

  /*
  * 捞出所有的数据供报表设计器打印
  */
  PROCEDURE usp_get_iem_mainpage_all(
                                     --      v_noofinpat             VARCHAR,
                                     o_result  OUT empcurtyp,
                                     o_result1 OUT empcurtyp,
                                     o_result2 OUT empcurtyp) AS
  BEGIN
    open o_result for
      select *
        from iem_mainpage_basicinfo
       where iem_mainpage_basicinfo.valide = '1'
         and iem_mainpage_basicinfo.noofinpat = '151';
  
    open o_result1 for
      select *
        from iem_mainpage_diagnosis
       where iem_mainpage_diagnosis.valide = '1'
         and iem_mainpage_diagnosis.iem_mainpage_no in
             (select iem_mainpage_basicinfo.iem_mainpage_no
                from iem_mainpage_basicinfo
               where iem_mainpage_basicinfo.valide = '1'
                 and iem_mainpage_basicinfo.noofinpat = '151');
  
    open o_result2 for
      select *
        from iem_mainpage_operation
       where iem_mainpage_operation.valide = '1'
         and iem_mainpage_operation.iem_mainpage_no in
             (select iem_mainpage_basicinfo.iem_mainpage_no
                from iem_mainpage_basicinfo
               where iem_mainpage_basicinfo.valide = '1'
                 and iem_mainpage_basicinfo.noofinpat = '151');
  
  END;

  -- End of DDL Script for Package YIDANDBA.IEM_MAGE_PAGE

  /*********************************************************************************/
  PROCEDURE usp_getieminfo_new(v_noofinpat INT,
                               o_result    OUT empcurtyp,
                               o_result1   OUT empcurtyp,
                               o_result2   OUT empcurtyp,
                               o_result3   OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量评分
     功能说明
     输入参数
      v_NoOfInpat varchar(40)--首页序号
     输出参数
     结果集、排序
    质量控制统计数据集
    
     调用的sp
     调用实例
     exec usp_GetIemInfo  9
     修改记录
    **********/
    v_infono NUMERIC;
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result1 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result2 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result3 FOR
      SELECT '' FROM DUAL;
  
    SELECT MAX(imb.iem_mainpage_no)
      INTO v_infono
      FROM iem_mainpage_basicinfo imb
     WHERE imb.noofinpat = v_noofinpat
       AND imb.valide = 1;
  
    --数据顺序不可变，与程序里相关
    --基本信息
    OPEN o_result FOR
      SELECT iem.iem_mainpage_no,
             iem.noofinpat,
             iem.socialcare,
             iem.payid,
             pay.name payName,
             
             iem.incount,
             iem.patnoofhis,
             iem.name,
             iem.sexid,
             iem.birth,
             
             iem.marital,
             iem.jobid,
             job.name       jobName,
             iem.provinceid,
             pro.name       provinceName,
             
             iem.countyid,
             county.name       countyName,
             iem.nationid,
             nation.name       NationName,
             iem.nationalityid,
             
             nationality.name nationalityName,
             iem.idno,
             iem.organization,
             iem.officeplace,
             iem.officetel,
             
             iem.officepost,
             iem.nativeaddress,
             iem.nativetel,
             iem.nativepost,
             iem.contactperson,
             
             iem.relationship,
             relationship.name  relationshipName,
             iem.contactaddress,
             iem.contacttel,
             iem.admitdate,
             
             iem.admitdept,
             AdmitDept.name      AdmitDeptName,
             iem.admitward,
             admitward.name      admitwardName,
             iem.trans_admitdept,
             
             trans_admitdept.name trans_admitdeptName,
             iem.outwarddate,
             iem.outhosdept,
             outhosdept.name      outhosdeptName,
             iem.outhosward,
             
             outhosward.name           outhoswardName,
             iem.actual_days,
             iem.days_before,
             iem.trans_date,
             iem.trans_admitdept_again,
             
             iem.Trans_AdmitWard,
             iem.death_time,
             iem.death_reason,
             
             ---诊断实体
             iem.admitinfo,
             iem.in_check_date,
             iem.zymosis,
             zymosis.name      zymosisName,
             iem.zymosisstate,
             
             iem.pathology_diagnosis_name,
             iem.pathology_observation_sn,
             iem.hurt_toxicosis_ele,
             iem.allergic_drug,
             iem.hbsag,
             
             iem.hcv_ab,
             iem.hiv_ab,
             iem.opd_ipd_id,
             iem.in_out_inpatinet_id,
             iem.before_after_or_id,
             
             iem.clinical_pathology_id,
             iem.pacs_pathology_id,
             iem.save_times,
             iem.success_times,
             iem.section_director,
             
             section_director.name section_directorName,
             iem.director,
             director.name         directorName,
             iem.vs_employee_code  vs_employeeID,
             vs_employee.name      vs_employeeName,
             
             iem.resident_employee_code resident_employeeID,
             resident_employee.name     resident_employeeName,
             iem.refresh_employee_code  refresh_employeeID,
             refresh_employee.name      refresh_employeeName,
             iem.master_interne,
             
             master_interne.name master_interneName,
             iem.interne,
             interne.name        interneName,
             iem.coding_user,
             coding_user.name    coding_userName,
             
             iem.medical_quality_id,
             iem.quality_control_doctor,
             quality_control_doctor.name quality_control_doctorName,
             iem.quality_control_nurse,
             quality_control_nurse.name  quality_control_nurseName,
             
             iem.quality_control_date,
             
             --费用模块
             (case
               when iem.ashes_diagnosis_name = '' then
                '2'
               else
                '1'
             end) Ashes_Check,
             iem.is_first_case,
             iem.is_following,
             iem.is_teaching_case,
             iem.following_ending_date,
             
             iem.blood_type_id,
             iem.rh,
             iem.blood_reaction_id,
             iem.blood_rbc,
             iem.blood_plt,
             
             iem.blood_plasma,
             iem.blood_wb,
             iem.blood_others,
             
             --基础信息实体
             iem.Is_Completed,
             iem.completed_time,
             iem.Valide,
             iem.Create_User,
             iem.Create_Time,
             iem.Modified_User,
             iem.Modified_Time,
             iem.xay_sn,
             iem.ct_sn,
             iem.mri_sn,
             iem.dsa_sn,
             iem.ashes_anatomise_sn,
             iem.ashes_diagnosis_name
      
        FROM iem_mainpage_basicinfo iem
        left join dictionary_detail pay
          on pay.detailid = iem.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
          on job.detailid = iem.jobid
         and job.categoryid = '41'
        left join areas pro
          on pro.id = iem.provinceid
         and pro.category = '1000'
        left join areas county
          on county.id = iem.countyid
         and county.category = '1001'
        left join dictionary_detail nation
          on nation.detailid = iem.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = iem.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = iem.relationship
         and relationship.categoryid = '44'
        left join department AdmitDept
          on AdmitDept.id = iem.admitdept
        left join ward admitward
          on admitward.id = iem.admitward
        left join department trans_admitdept
          on trans_admitdept.id = iem.trans_admitdept
        left join department outhosdept
          on outhosdept.id = iem.outhosdept
        left join ward outhosward
          on outhosward.id = iem.outhosward
        left join diagnosis zymosis
          on zymosis.markid = iem.zymosis
        left join users section_director
          on section_director.id = iem.section_director
        left join users director
          on director.id = iem.director
        left join users vs_employee
          on vs_employee.id = iem.vs_employee_code
        left join users resident_employee
          on resident_employee.id = iem.resident_employee_code
        left join users refresh_employee
          on refresh_employee.id = iem.refresh_employee_code
        left join users master_interne
          on master_interne.id = iem.master_interne
        left join users interne
          on interne.id = iem.interne
        left join users coding_user
          on coding_user.id = iem.coding_user
        left join users quality_control_doctor
          on quality_control_doctor.id = iem.quality_control_doctor
        left join users quality_control_nurse
          on quality_control_nurse.id = iem.quality_control_nurse
       WHERE iem.iem_mainpage_no = v_infono
         AND iem.valide = 1;
  
    --诊断
    OPEN o_result1 FOR
      SELECT diag.diagnosis_name,
             diag.status_id,
             (case
               when diag.status_id = '1' then
                '治愈'
               when diag.status_id = '2' then
                '好转'
               when diag.status_id = '3' then
                '未愈'
               when diag.status_id = '4' then
                '死亡'
               else
                '其他'
             end) Status_Name,
             diag.diagnosis_code,
             diag.diagnosis_type_id,
             diag.order_value
        FROM iem_mainpage_diagnosis diag
       WHERE iem_mainpage_no = v_infono
         AND valide = 1
       ORDER BY order_value;
  
    --手术
    /*    OPEN o_result2 FOR
    SELECT *
      FROM iem_mainpage_operation
     WHERE iem_mainpage_no = v_infono
       AND valide = 1;*/
  
    OPEN o_result2 FOR
    
      SELECT iem.iem_mainpage_operation_no,
             iem.iem_mainpage_no,
             iem.operation_code,
             iem.operation_date,
             iem.operation_name,
             u1.name                       execute_user1_Name,
             iem.execute_user1,
             u2.name                       execute_user2_Name,
             iem.execute_user2,
             u3.name                       execute_user3_Name,
             iem.execute_user3,
             --dic.name anaesthesia_type_Name,
             ab.name anaesthesia_type_Name,
             iem.anaesthesia_type_id,
             (case
               when iem.close_level = '1' then
                'I/甲'
               when iem.close_level = '2' then
                'II/甲'
               when iem.close_level = '3' then
                'III/甲'
               when iem.close_level = '4' then
                'I/乙'
               when iem.close_level = '5' then
                'II/乙'
               when iem.close_level = '6' then
                'III/乙'
               when iem.close_level = '7' then
                'I/丙'
               when iem.close_level = '8' then
                'II/丙'
               when iem.close_level = '9' then
                'III/丙'
               else
                ''
             end) close_level_Name,
             iem.close_level,
             ua.name anaesthesia_user_Name,
             iem.anaesthesia_user,
             iem.valide,
             iem.create_user,
             iem.create_time,
             iem.cancel_user,
             iem.cancel_time
        FROM iem_mainpage_operation iem
        left join users u1
          on iem.execute_user1 = u1.id
         and u1.valid = 1
        left join users u2
          on iem.execute_user2 = u2.id
         and u2.valid = 1
        left join users u3
          on iem.execute_user3 = u3.id
         and u3.valid = 1
        left join users ua
          on iem.anaesthesia_user = ua.id
         and ua.valid = 1
      /*     left join dictionary_detail dic on iem.anaesthesia_type_id =
          dic.detailid
      and dic.categoryid = '30'*/
        left join anesthesia ab
          on iem.anaesthesia_type_id = ab.id
       WHERE valide = 1
         and iem.iem_mainpage_no = v_infono;
  
    --产妇婴儿信息
    OPEN o_result3 FOR
      SELECT *
        FROM IEM_MAINPAGE_OBSTETRICSBABY
       WHERE iem_mainpage_no = v_infono
         AND valide = 1;
  END;

  /**(*********编辑病案首页基本信息********************************************/
  PROCEDURE usp_Edit_Iem_BasicInfo_2012(v_edittype        varchar2 default '',
                                        v_IEM_MAINPAGE_NO varchar2 default '', ---- '病案首页标识';
                                        v_PATNOOFHIS      varchar2 default '', ---- '病案号';
                                        v_NOOFINPAT       varchar2 default '', ---- '病人首页序号';
                                        v_PAYID           varchar2 default '', ---- '医疗付款方式ID';
                                        v_SOCIALCARE      varchar2 default '', ---- '社保卡号';
                                        
                                        v_INCOUNT varchar2 default '', ---- '入院次数';
                                        v_NAME    varchar2 default '', ---- '患者姓名';
                                        v_SEXID   varchar2 default '', ---- '性别';
                                        v_BIRTH   varchar2 default '', ---- '出生';
                                        v_MARITAL varchar2 default '', ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
                                        
                                        v_JOBID         varchar2 default '', ---- '职业';
                                        v_NATIONALITYID varchar2 default '', ---- '国籍ID';
                                        v_NATIONID      varchar2 default '', --民族
                                        v_IDNO          varchar2 default '', ---- '身份证号码';
                                        v_ORGANIZATION  varchar2 default '', ---- '工作单位';
                                        v_OFFICEPLACE   varchar2 default '', ---- '工作单位地址';
                                        
                                        v_OFFICETEL      varchar2 default '', ---- '工作单位电话';
                                        v_OFFICEPOST     varchar2 default '', ---- '工作单位邮编';
                                        v_CONTACTPERSON  varchar2 default '', ---- '联系人姓名';
                                        v_RELATIONSHIP   varchar2 default '', ---- '与联系人关系';
                                        v_CONTACTADDRESS varchar2 default '', ---- '联系人地址';
                                        
                                        v_CONTACTTEL varchar2 default '', ---- '联系人电话';
                                        v_ADMITDATE  varchar2 default '', ---- '入院时间';
                                        v_ADMITDEPT  varchar2 default '', ---- '入院科室';
                                        v_ADMITWARD  varchar2 default '', ---- '入院病区';
                                        v_TRANS_DATE varchar2 default '', ---- '转院时间';
                                        
                                        v_TRANS_ADMITDEPT varchar2 default '', ---- '转院科别';
                                        v_TRANS_ADMITWARD varchar2 default '', ---- '转院病区';
                                        v_OUTWARDDATE     varchar2 default '', ---- '出院时间';
                                        v_OUTHOSDEPT      varchar2 default '', ---- '出院科室';
                                        v_OUTHOSWARD      varchar2 default '', ---- '出院病区';
                                        
                                        v_ACTUALDAYS               varchar2 default '', ---- '实际住院天数';
                                        v_PATHOLOGY_DIAGNOSIS_NAME varchar2 default '', ---- '病理诊断名称';
                                        v_PATHOLOGY_OBSERVATION_SN varchar2 default '', ---- '病理检查号 ';
                                        v_ALLERGIC_DRUG            varchar2 default '', ---- '过敏药物';
                                        v_SECTION_DIRECTOR         varchar2 default '', ---- '科主任';
                                        
                                        v_DIRECTOR               varchar2 default '', ---- '主（副主）任医师';
                                        v_VS_EMPLOYEE_CODE       varchar2 default '', ---- '主治医师';
                                        v_RESIDENT_EMPLOYEE_CODE varchar2 default '', ---- '住院医师';
                                        v_REFRESH_EMPLOYEE_CODE  varchar2 default '', ---- '进修医师';
                                        v_DUTY_NURSE             varchar2 default '', ---- '责任护士';
                                        
                                        v_INTERNE                varchar2 default '', ---- '实习医师';
                                        v_CODING_USER            varchar2 default '', ---- '编码员';
                                        v_MEDICAL_QUALITY_ID     varchar2 default '', ---- '病案质量';
                                        v_QUALITY_CONTROL_DOCTOR varchar2 default '', ---- '质控医师';
                                        v_QUALITY_CONTROL_NURSE  varchar2 default '', ---- '质控护士';
                                        
                                        v_QUALITY_CONTROL_DATE varchar2 default '', ---- '质控时间';
                                        v_XAY_SN               varchar2 default '', ---- 'x线检查号';
                                        v_CT_SN                varchar2 default '', ---- 'CT检查号';
                                        v_MRI_SN               varchar2 default '', ---- 'mri检查号';
                                        v_DSA_SN               varchar2 default '', ---- 'Dsa检查号';
                                        
                                        v_BLOODTYPE      varchar2 default '', ---- '血型';
                                        v_RH             varchar2 default '', ---- 'Rh';
                                        v_IS_COMPLETED   varchar2 default '', ---- '完成否 y/n ';
                                        v_COMPLETED_TIME varchar2 default '', ---- '完成时间';
                                        v_VALIDE         varchar2 default '1', ---- '作废否 1/0';
                                        
                                        v_CREATE_USER   varchar2 default '', ---- '创建此记录者';
                                        v_CREATE_TIME   varchar2 default '', ---- '创建时间';
                                        v_MODIFIED_USER varchar2 default '', ---- '修改此记录者';
                                        v_MODIFIED_TIME varchar2 default '', ---- '修改时间';
                                        v_ZYMOSIS       varchar2 default '', ---- '医院传染病';
                                        
                                        v_HURT_TOXICOSIS_ELE_ID   varchar2 default '', ---- '损伤、中毒的外部因素';
                                        v_HURT_TOXICOSIS_ELE_Name varchar2 default '', ---- '损伤、中毒的外部因素';
                                        v_ZYMOSISSTATE            varchar2 default '', ---- '医院传染病状态';
                                        v_PATHOLOGY_DIAGNOSIS_ID  varchar2 default '', ---- '病理诊断编号';
                                        v_MONTHAGE                varchar2 default '', ---- '（年龄不足1周岁的） 年龄(月)';
                                        v_WEIGHT                  varchar2 default '', ---- '新生儿出生体重(克)';
                                        
                                        v_INWEIGHT         varchar2 default '', ---- '新生儿入院体重(克)';
                                        v_INHOSTYPE        varchar2 default '', ---- '入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他';
                                        v_OUTHOSTYPE       varchar2 default '', ---- '离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他';
                                        v_RECEIVEHOSPITAL  varchar2 default '', ---- '2.医嘱转院，拟接收医疗机构名称：';
                                        v_RECEIVEHOSPITAL2 varchar2 default '', ---- '3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名;
                                        
                                        v_AGAININHOSPITAL       varchar2 default '', ---- '是否有出院31天内再住院计划 □ 1.无  2.有';
                                        v_AGAININHOSPITALREASON varchar2 default '', ---- '出院31天内再住院计划 目的:            ';
                                        v_BEFOREHOSCOMADAY      varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院前    天';
                                        v_BEFOREHOSCOMAHOUR     varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院前     小时';
                                        v_BEFOREHOSCOMAMINUTE   varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院前    分钟';
                                        
                                        v_LATERHOSCOMADAY    varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院后    天';
                                        v_LATERHOSCOMAHOUR   varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院后    小时';
                                        v_LATERHOSCOMAMINUTE varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院后    分钟';
                                        v_CARDNUMBER         varchar2 default '', ---- '健康卡号';
                                        v_ALLERGIC_FLAG      varchar2 default '', ---- '药物过敏1.无 2.有';
                                        
                                        v_AUTOPSY_FLAG     varchar2 default '', ---- '死亡患者尸检 □ 1.是  2.否';
                                        v_CSD_PROVINCEID   varchar2 default '', ---- '出生地 省';
                                        v_CSD_CITYID       varchar2 default '', ---- '出生地 市';
                                        v_CSD_DISTRICTID   varchar2 default '', ---- '出生地 县';
                                        v_CSD_PROVINCENAME varchar2 default '', ---- '出生地 省名称';
                                        
                                        v_CSD_CITYNAME     varchar2 default '', ---- '出生地 市名称';
                                        v_CSD_DISTRICTNAME varchar2 default '', ---- '出生地 县名称';
                                        v_XZZ_PROVINCEID   varchar2 default '', ---- '现住址 省';
                                        v_XZZ_CITYID       varchar2 default '', ---- '现住址 市';
                                        v_XZZ_DISTRICTID   varchar2 default '', ---- '现住址 县';
                                        
                                        v_XZZ_PROVINCENAME varchar2 default '', ---- '现住址 省名称';
                                        v_XZZ_CITYNAME     varchar2 default '', ---- '现住址 市名称';
                                        v_XZZ_DISTRICTNAME varchar2 default '', ---- '现住址 县名称';
                                        v_XZZ_TEL          varchar2 default '', ---- '现住址 电话';
                                        v_XZZ_POST         varchar2 default '', ---- '现住址 邮编';
                                        
                                        v_HKDZ_PROVINCEID   varchar2 default '', ---- '户口地址 省';
                                        v_HKDZ_CITYID       varchar2 default '', ---- '户口地址 市';
                                        v_HKDZ_DISTRICTID   varchar2 default '', ---- '户口地址 县';
                                        v_HKDZ_PROVINCENAME varchar2 default '', ---- '户口地址 省名称';
                                        v_HKDZ_CITYNAME     varchar2 default '', ---- '户口地址 市名称';
                                        
                                        v_HKDZ_DISTRICTNAME varchar2 default '', ---- '户口地址 县名称';
                                        v_HKDZ_POST         varchar2 default '', ---- '户口所在地邮编';
                                        v_JG_PROVINCEID     varchar2 default '', ---- '籍贯 省名称';
                                        v_JG_CITYID         varchar2 default '', ---- '籍贯 市名称';
                                        v_JG_PROVINCENAME   varchar2 default '', ---- '籍贯 省名称';
                                        v_JG_CITYNAME       varchar2 default '', ---- '籍贯 市名称'
                                        v_Age               varchar2 default '',
                                        v_zg_flag           varchar2 default '', -----转归：□ 1.治愈 2.好转 3.未愈 4.死亡 5.其他
                                        v_admitinfo         varchar2 default '', --  v入院病情□ 1.危 2.重 3.一般 4.急 add 二一二年六月二十六日 10:14:09
                                        v_CSDADDRESS        varchar2 default '', --出生地具体地址 add by ywk 2012年7月11日 10:13:49
                                        v_JGADDRESS         varchar2 default '', --籍贯地址具体地址 add by ywk 2012年7月11日 10:13:49
                                        v_XZZADDRESS        varchar2 default '', --现住址具体地址 add by ywk 2012年7月11日 10:13:49
                                        v_HKDZADDRESS       varchar2 default '', --户口地址具体地址 add by ywk 2012年7月11日 10:13:49
                                        
                                        v_MenAndInHop           varchar, --门诊和住院
                                        v_InHopAndOutHop        varchar, --入院和出院
                                        v_BeforeOpeAndAfterOper varchar, --术前和术后
                                        v_LinAndBingLi          varchar, --临床与病理
                                        v_InHopThree            varchar, --入院三日内
                                        v_FangAndBingLi         varchar, --放射和病理
                                        o_result                OUT empcurtyp) as
    mynoofclinic varchar2(50);
  
  begin
    if v_IDNO = '不详' then
      mynoofclinic := '';
    else
      mynoofclinic := v_IDNO;
    end if;
    IF v_edittype = '1' THEN
    
      --新增病案首页基本信息
      insert into iem_mainpage_basicinfo_2012
        (IEM_MAINPAGE_NO, ---- '病案首页标识';
         PATNOOFHIS, ---- '病案号';
         NOOFINPAT, ---- '病人首页序号';
         PAYID, ---- '医疗付款方式ID';
         SOCIALCARE, ---- '社保卡号';
         
         INCOUNT, ---- '入院次数';
         NAME, ---- '患者姓名';
         SEXID, ---- '性别';
         BIRTH, ---- '出生';
         MARITAL, ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
         
         JOBID, ---- '职业';
         NATIONALITYID, ---- '国籍ID';
         NATIONID, --民族
         IDNO, ---- '身份证号码';
         ORGANIZATION, ---- '工作单位';
         OFFICEPLACE, ---- '工作单位地址';
         
         OFFICETEL, ---- '工作单位电话';
         OFFICEPOST, ---- '工作单位邮编';
         CONTACTPERSON, ---- '联系人姓名';
         RELATIONSHIP, ---- '与联系人关系';
         CONTACTADDRESS, ---- '联系人地址';
         
         CONTACTTEL, ---- '联系人电话';
         ADMITDATE, ---- '入院时间';
         ADMITDEPT, ---- '入院科室';
         ADMITWARD, ---- '入院病区';
         TRANS_DATE, ---- '转院时间';
         
         TRANS_ADMITDEPT, ---- '转院科别';
         TRANS_ADMITWARD, ---- '转院病区';
         OUTWARDDATE, ---- '出院时间';
         OUTHOSDEPT, ---- '出院科室';
         OUTHOSWARD, ---- '出院病区';
         
         ACTUALDAYS, ---- '实际住院天数';
         PATHOLOGY_DIAGNOSIS_NAME, ---- '病理诊断名称';
         PATHOLOGY_OBSERVATION_SN, ---- '病理检查号 ';
         ALLERGIC_DRUG, ---- '过敏药物';
         SECTION_DIRECTOR, ---- '科主任';
         
         DIRECTOR, ---- '主（副主）任医师';
         VS_EMPLOYEE_CODE, ---- '主治医师';
         RESIDENT_EMPLOYEE_CODE, ---- '住院医师';
         REFRESH_EMPLOYEE_CODE, ---- '进修医师';
         DUTY_NURSE, ---- '责任护士';
         
         INTERNE, ---- '实习医师';
         CODING_USER, ---- '编码员';
         MEDICAL_QUALITY_ID, ---- '病案质量';
         QUALITY_CONTROL_DOCTOR, ---- '质控医师';
         QUALITY_CONTROL_NURSE, ---- '质控护士';
         
         QUALITY_CONTROL_DATE, ---- '质控时间';
         XAY_SN, ---- 'x线检查号';
         CT_SN, ---- 'CT检查号';
         MRI_SN, ---- 'mri检查号';
         DSA_SN, ---- 'Dsa检查号';
         
         BLOODTYPE, ---- '血型';
         RH, ---- 'Rh';
         IS_COMPLETED, ---- '完成否 y/n ';
         COMPLETED_TIME, ---- '完成时间';
         VALIDE, ---- '作废否 1/0';
         
         CREATE_USER, ---- '创建此记录者';
         CREATE_TIME, ---- '创建时间';
         MODIFIED_USER, ---- '修改此记录者';
         MODIFIED_TIME, ---- '修改时间';
         ZYMOSIS, ---- '医院传染病';
         
         HURT_TOXICOSIS_ELE_ID, ---- '损伤、中毒的外部因素';
         HURT_TOXICOSIS_ELE_Name,
         ZYMOSISSTATE, ---- '医院传染病状态';
         PATHOLOGY_DIAGNOSIS_ID, ---- '病理诊断编号';
         MONTHAGE, ---- '（年龄不足1周岁的） 年龄(月)';
         WEIGHT, ---- '新生儿出生体重(克)';
         
         INWEIGHT, ---- '新生儿入院体重(克)';
         INHOSTYPE, ---- '入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他';
         OUTHOSTYPE, ---- '离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他';
         RECEIVEHOSPITAL, ---- '2.医嘱转院，拟接收医疗机构名称：';
         RECEIVEHOSPITAL2, ---- '3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名;
         
         AGAININHOSPITAL, ---- '是否有出院31天内再住院计划 □ 1.无  2.有';
         AGAININHOSPITALREASON, ---- '出院31天内再住院计划 目的:            ';
         BEFOREHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院前    天';
         BEFOREHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院前     小时';
         BEFOREHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院前    分钟';
         
         LATERHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院后    天';
         LATERHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院后    小时';
         LATERHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院后    分钟';
         CARDNUMBER, ---- '健康卡号';
         ALLERGIC_FLAG, ---- '药物过敏1.无 2.有';
         
         AUTOPSY_FLAG, ---- '死亡患者尸检 □ 1.是  2.否';
         CSD_PROVINCEID, ---- '出生地 省';
         CSD_CITYID, ---- '出生地 市';
         CSD_DISTRICTID, ---- '出生地 县';
         CSD_PROVINCENAME, ---- '出生地 省名称';
         
         CSD_CITYNAME, ---- '出生地 市名称';
         CSD_DISTRICTNAME, ---- '出生地 县名称';
         XZZ_PROVINCEID, ---- '现住址 省';
         XZZ_CITYID, ---- '现住址 市';
         XZZ_DISTRICTID, ---- '现住址 县';
         
         XZZ_PROVINCENAME, ---- '现住址 省名称';
         XZZ_CITYNAME, ---- '现住址 市名称';
         XZZ_DISTRICTNAME, ---- '现住址 县名称';
         XZZ_TEL, ---- '现住址 电话';
         XZZ_POST, ---- '现住址 邮编';
         
         HKDZ_PROVINCEID, ---- '户口地址 省';
         HKDZ_CITYID, ---- '户口地址 市';
         HKDZ_DISTRICTID, ---- '户口地址 县';
         HKDZ_PROVINCENAME, ---- '户口地址 省名称';
         HKDZ_CITYNAME, ---- '户口地址 市名称';
         
         HKDZ_DISTRICTNAME, ---- '户口地址 县名称';
         HKDZ_POST, ---- '户口所在地邮编';
         JG_PROVINCEID, ---- '籍贯 省名称';
         JG_CITYID, ---- '籍贯 市名称';
         JG_PROVINCENAME, ---- '籍贯 省名称';
         JG_CITYNAME,
         age,
         zg_flag,
         admitinfo,
         CSDAddress,
         JGAddress,
         XZZAddress,
         HKAddress,
         MenAndInHop,
         InHopAndOutHop,
         BeforeOpeAndAfterOper,
         LinAndBingLi,
         InHopThree,
         FangAndBingLi) ---- '籍贯 市名称';
      values
        (seq_iem_mainpage_basicinfo_id.NEXTVAL, ---- '病案首页标识';
         v_PATNOOFHIS, ---- '病案号';
         v_NOOFINPAT, ---- '病人首页序号';
         v_PAYID, ---- '医疗付款方式ID';
         v_SOCIALCARE, ---- '社保卡号';
         v_INCOUNT, ---- '入院次数';
         v_NAME, ---- '患者姓名';
         v_SEXID, ---- '性别';
         v_BIRTH, ---- '出生';
         v_MARITAL, ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
         v_JOBID, ---- '职业';
         v_NATIONALITYID, ---- '国籍ID';
         v_NATIONID, --民族
         mynoofclinic, ---- '身份证号码';
         v_ORGANIZATION, ---- '工作单位';
         v_OFFICEPLACE, ---- '工作单位地址';
         v_OFFICETEL, ---- '工作单位电话';
         v_OFFICEPOST, ---- '工作单位邮编';
         v_CONTACTPERSON, ---- '联系人姓名';
         v_RELATIONSHIP, ---- '与联系人关系';
         v_CONTACTADDRESS, ---- '联系人地址';
         v_CONTACTTEL, ---- '联系人电话';
         v_ADMITDATE, ---- '入院时间';
         v_ADMITDEPT, ---- '入院科室';
         v_ADMITWARD, ---- '入院病区';
         v_TRANS_DATE, ---- '转院时间';
         v_TRANS_ADMITDEPT, ---- '转院科别';
         v_TRANS_ADMITWARD, ---- '转院病区';
         v_OUTWARDDATE, ---- '出院时间';
         v_OUTHOSDEPT, ---- '出院科室';
         v_OUTHOSWARD, ---- '出院病区';
         v_ACTUALDAYS, ---- '实际住院天数';
         v_PATHOLOGY_DIAGNOSIS_NAME, ---- '病理诊断名称';
         v_PATHOLOGY_OBSERVATION_SN, ---- '病理检查号 ';
         v_ALLERGIC_DRUG, ---- '过敏药物';
         v_SECTION_DIRECTOR, ---- '科主任';
         v_DIRECTOR, ---- '主（副主）任医师';
         v_VS_EMPLOYEE_CODE, ---- '主治医师';
         v_RESIDENT_EMPLOYEE_CODE, ---- '住院医师';
         v_REFRESH_EMPLOYEE_CODE, ---- '进修医师';
         v_DUTY_NURSE, ---- '责任护士';
         v_INTERNE, ---- '实习医师';
         v_CODING_USER, ---- '编码员';
         v_MEDICAL_QUALITY_ID, ---- '病案质量';
         v_QUALITY_CONTROL_DOCTOR, ---- '质控医师';
         v_QUALITY_CONTROL_NURSE, ---- '质控护士';
         v_QUALITY_CONTROL_DATE, ---- '质控时间';
         v_XAY_SN, ---- 'x线检查号';
         v_CT_SN, ---- 'CT检查号';
         v_MRI_SN, ---- 'mri检查号';
         v_DSA_SN, ---- 'Dsa检查号';
         v_BLOODTYPE, ---- '血型';
         v_RH, ---- 'Rh';
         v_IS_COMPLETED, ---- '完成否 y/n ';
         v_COMPLETED_TIME, ---- '完成时间';
         v_VALIDE, ---- '作废否 1/0';
         v_CREATE_USER, ---- '创建此记录者';
         TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss'), ---- '创建时间';
         v_MODIFIED_USER, ---- '修改此记录者';
         v_MODIFIED_TIME, ---- '修改时间';
         v_ZYMOSIS, ---- '医院传染病';
         v_HURT_TOXICOSIS_ELE_ID, ---- '损伤、中毒的外部因素';
         v_HURT_TOXICOSIS_ELE_Name, ---- '损伤、中毒的外部因素';
         v_ZYMOSISSTATE, ---- '医院传染病状态';
         v_PATHOLOGY_DIAGNOSIS_ID, ---- '病理诊断编号';
         v_MONTHAGE, ---- '（年龄不足1周岁的） 年龄(月)';
         v_WEIGHT, ---- '新生儿出生体重(克)';
         v_INWEIGHT, ---- '新生儿入院体重(克)';
         v_INHOSTYPE, ---- '入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他';
         v_OUTHOSTYPE, ---- '离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他';
         v_RECEIVEHOSPITAL, ---- '2.医嘱转院，拟接收医疗机构名称：';
         v_RECEIVEHOSPITAL2, ---- '3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名;
         v_AGAININHOSPITAL, ---- '是否有出院31天内再住院计划 □ 1.无  2.有';
         v_AGAININHOSPITALREASON, ---- '出院31天内再住院计划 目的:            ';
         v_BEFOREHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院前    天';
         v_BEFOREHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院前     小时';
         v_BEFOREHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院前    分钟';
         v_LATERHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院后    天';
         v_LATERHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院后    小时';
         v_LATERHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院后    分钟';
         v_CARDNUMBER, ---- '健康卡号';
         v_ALLERGIC_FLAG, ---- '药物过敏1.无 2.有';
         v_AUTOPSY_FLAG, ---- '死亡患者尸检 □ 1.是  2.否';
         v_CSD_PROVINCEID, ---- '出生地 省';
         v_CSD_CITYID, ---- '出生地 市';
         v_CSD_DISTRICTID, ---- '出生地 县';
         v_CSD_PROVINCENAME, ---- '出生地 省名称';
         v_CSD_CITYNAME, ---- '出生地 市名称';
         v_CSD_DISTRICTNAME, ---- '出生地 县名称';
         v_XZZ_PROVINCEID, ---- '现住址 省';
         v_XZZ_CITYID, ---- '现住址 市';
         v_XZZ_DISTRICTID, ---- '现住址 县';
         v_XZZ_PROVINCENAME, ---- '现住址 省名称';
         v_XZZ_CITYNAME, ---- '现住址 市名称';
         v_XZZ_DISTRICTNAME, ---- '现住址 县名称';
         v_XZZ_TEL, ---- '现住址 电话';
         v_XZZ_POST, ---- '现住址 邮编';
         v_HKDZ_PROVINCEID, ---- '户口地址 省';
         v_HKDZ_CITYID, ---- '户口地址 市';
         v_HKDZ_DISTRICTID, ---- '户口地址 县';
         v_HKDZ_PROVINCENAME, ---- '户口地址 省名称';
         v_HKDZ_CITYNAME, ---- '户口地址 市名称';
         v_HKDZ_DISTRICTNAME, ---- '户口地址 县名称';
         v_HKDZ_POST, ---- '户口所在地邮编';
         v_JG_PROVINCEID, ---- '籍贯 省名称';
         v_JG_CITYID, ---- '籍贯 市名称';
         v_JG_PROVINCENAME, ---- '籍贯 省名称';
         v_JG_CITYNAME,
         v_Age,
         v_zg_flag,
         v_admitinfo, --入院病情
         v_CSDADDRESS, --出生地
         v_JGADDRESS, --籍贯地址
         v_XZZADDRESS, --现住址
         v_HKDZADDRESS, --户口住址
         v_MenAndInHop, --门诊和住院
         v_InHopAndOutHop, --入院和出院
         v_BeforeOpeAndAfterOper, --术前和术后
         v_LinAndBingLi, --临床与病理
         v_InHopThree, --入院三日内
         v_FangAndBingLi);
    
      open o_result for
        select seq_iem_mainpage_basicinfo_id.currval from dual;
      ---修改病案首页基本信息
    ELSIF v_edittype = '2' THEN
    
      update iem_mainpage_basicinfo_2012
         set PATNOOFHIS               = v_PATNOOFHIS, --病案号
             NOOFINPAT                = v_NOOFINPAT, --病人首页序号
             PAYID                    = v_PAYID, --医疗付款方式ID
             SOCIALCARE               = v_SOCIALCARE, --社保卡号
             INCOUNT                  = v_INCOUNT, --入院次数
             NAME                     = v_NAME, --患者姓名
             SEXID                    = v_SEXID, --性别
             BIRTH                    = v_BIRTH, --出生
             MARITAL                  = v_MARITAL, --婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他
             JOBID                    = v_JOBID, --职业
             NATIONALITYID            = v_NATIONALITYID, --国籍ID
             NATIONID                 = v_NATIONID, --民族
             IDNO                     = mynoofclinic, --身份证号码
             ORGANIZATION             = v_ORGANIZATION, --工作单位
             OFFICEPLACE              = v_OFFICEPLACE, --工作单位地址
             OFFICETEL                = v_OFFICETEL, --工作单位电话
             OFFICEPOST               = v_OFFICEPOST, --工作单位邮编
             CONTACTPERSON            = v_CONTACTPERSON, --联系人姓名
             RELATIONSHIP             = v_RELATIONSHIP, --与联系人关系
             CONTACTADDRESS           = v_CONTACTADDRESS, --联系人地址
             CONTACTTEL               = v_CONTACTTEL, --联系人电话
             ADMITDATE                = v_ADMITDATE, --入院时间
             ADMITDEPT                = v_ADMITDEPT, --入院科室
             ADMITWARD                = v_ADMITWARD, --入院病区
             TRANS_DATE               = v_TRANS_DATE, --转院时间
             TRANS_ADMITDEPT          = v_TRANS_ADMITDEPT, --转院科别
             TRANS_ADMITWARD          = v_TRANS_ADMITWARD, --转院病区
             OUTWARDDATE              = v_OUTWARDDATE, --出院时间
             OUTHOSDEPT               = v_OUTHOSDEPT, --出院科室
             OUTHOSWARD               = v_OUTHOSWARD, --出院病区
             ACTUALDAYS               = v_ACTUALDAYS, --实际住院天数
             PATHOLOGY_DIAGNOSIS_NAME = v_PATHOLOGY_DIAGNOSIS_NAME, --病理诊断名称
             PATHOLOGY_OBSERVATION_SN = v_PATHOLOGY_OBSERVATION_SN, --病理检查号
             ALLERGIC_DRUG            = v_ALLERGIC_DRUG, --过敏药物
             SECTION_DIRECTOR         = v_SECTION_DIRECTOR, --科主任
             DIRECTOR                 = v_DIRECTOR, --主（副主）任医师
             VS_EMPLOYEE_CODE         = v_VS_EMPLOYEE_CODE, --主治医师
             RESIDENT_EMPLOYEE_CODE   = v_RESIDENT_EMPLOYEE_CODE, --住院医师
             REFRESH_EMPLOYEE_CODE    = v_REFRESH_EMPLOYEE_CODE, --进修医师
             DUTY_NURSE               = v_DUTY_NURSE, --责任护士
             INTERNE                  = v_INTERNE, --实习医师
             CODING_USER              = v_CODING_USER, --编码员
             MEDICAL_QUALITY_ID       = v_MEDICAL_QUALITY_ID, --病案质量
             QUALITY_CONTROL_DOCTOR   = v_QUALITY_CONTROL_DOCTOR, --质控医师
             QUALITY_CONTROL_NURSE    = v_QUALITY_CONTROL_NURSE, --质控护士
             QUALITY_CONTROL_DATE     = v_QUALITY_CONTROL_DATE, --质控时间
             XAY_SN                   = v_XAY_SN, --x线检查号
             CT_SN                    = v_CT_SN, --CT检查号
             MRI_SN                   = v_MRI_SN, --mri检查号
             DSA_SN                   = v_DSA_SN, --Dsa检查号
             BLOODTYPE                = v_BLOODTYPE, --血型
             RH                       = v_RH, --Rh
             IS_COMPLETED             = v_IS_COMPLETED, --完成否 y/n
             COMPLETED_TIME           = v_COMPLETED_TIME, --完成时间
             VALIDE                   = v_VALIDE, --作废否 1/0
             /* CREATE_USER              = v_CREATE_USER, --创建此记录者
             CREATE_TIME              = v_CREATE_TIME, --创建时间*/
             MODIFIED_USER           = v_MODIFIED_USER, --修改此记录者
             MODIFIED_TIME           = TO_CHAR(SYSDATE,
                                               'yyyy-mm-dd hh24:mi:ss'), --修改时间
             ZYMOSIS                 = v_ZYMOSIS, --医院传染病
             HURT_TOXICOSIS_ELE_ID   = v_HURT_TOXICOSIS_ELE_ID, --损伤、中毒的外部因素
             HURT_TOXICOSIS_ELE_Name = v_HURT_TOXICOSIS_ELE_Name, --损伤、中毒的外部因素
             ZYMOSISSTATE            = v_ZYMOSISSTATE, --医院传染病状态
             PATHOLOGY_DIAGNOSIS_ID  = v_PATHOLOGY_DIAGNOSIS_ID, --病理诊断编号
             MONTHAGE                = v_MONTHAGE, --（年龄不足1周岁的） 年龄(月)
             WEIGHT                  = v_WEIGHT, --新生儿出生体重(克)
             INWEIGHT                = v_INWEIGHT, --新生儿入院体重(克)
             INHOSTYPE               = v_INHOSTYPE, --入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他
             OUTHOSTYPE              = v_OUTHOSTYPE, --离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他
             RECEIVEHOSPITAL         = v_RECEIVEHOSPITAL, --2.医嘱转院，拟接收医疗机构名称：
             RECEIVEHOSPITAL2        = v_RECEIVEHOSPITAL2, --3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名称：
             AGAININHOSPITAL         = v_AGAININHOSPITAL, --是否有出院31天内再住院计划 □ 1.无  2.有
             AGAININHOSPITALREASON   = v_AGAININHOSPITALREASON, --出院31天内再住院计划 目的:
             BEFOREHOSCOMADAY        = v_BEFOREHOSCOMADAY, --颅脑损伤患者昏迷时间： 入院前    天
             BEFOREHOSCOMAHOUR       = v_BEFOREHOSCOMAHOUR, --颅脑损伤患者昏迷时间： 入院前     小时
             BEFOREHOSCOMAMINUTE     = v_BEFOREHOSCOMAMINUTE, --颅脑损伤患者昏迷时间： 入院前    分钟
             LATERHOSCOMADAY         = v_LATERHOSCOMADAY, --颅脑损伤患者昏迷时间： 入院后    天
             LATERHOSCOMAHOUR        = v_LATERHOSCOMAHOUR, --颅脑损伤患者昏迷时间： 入院后    小时
             LATERHOSCOMAMINUTE      = v_LATERHOSCOMAMINUTE, --颅脑损伤患者昏迷时间： 入院后    分钟
             CARDNUMBER              = v_CARDNUMBER, --健康卡号
             ALLERGIC_FLAG           = v_ALLERGIC_FLAG, --药物过敏1.无 2.有
             AUTOPSY_FLAG            = v_AUTOPSY_FLAG, --死亡患者尸检 □ 1.是  2.否
             CSD_PROVINCEID          = v_CSD_PROVINCEID, --出生地 省
             CSD_CITYID              = v_CSD_CITYID, --出生地 市
             CSD_DISTRICTID          = v_CSD_DISTRICTID, --出生地 县
             CSD_PROVINCENAME        = v_CSD_PROVINCENAME, --出生地 省名称
             CSD_CITYNAME            = v_CSD_CITYNAME, --出生地 市名称
             CSD_DISTRICTNAME        = v_CSD_DISTRICTNAME, --出生地 县名称
             XZZ_PROVINCEID          = v_XZZ_PROVINCEID, --现住址 省
             XZZ_CITYID              = v_XZZ_CITYID, --现住址 市
             XZZ_DISTRICTID          = v_XZZ_DISTRICTID, --现住址 县
             XZZ_PROVINCENAME        = v_XZZ_PROVINCENAME, --现住址 省名称
             XZZ_CITYNAME            = v_XZZ_CITYNAME, --现住址 市名称
             XZZ_DISTRICTNAME        = v_XZZ_DISTRICTNAME, --现住址 县名称
             XZZ_TEL                 = v_XZZ_TEL, --现住址 电话
             XZZ_POST                = v_XZZ_POST, --现住址 邮编
             HKDZ_PROVINCEID         = v_HKDZ_PROVINCEID, --户口地址 省
             HKDZ_CITYID             = v_HKDZ_CITYID, --户口地址 市
             HKDZ_DISTRICTID         = v_HKDZ_DISTRICTID, --户口地址 县
             HKDZ_PROVINCENAME       = v_HKDZ_PROVINCENAME, --户口地址 省名称
             HKDZ_CITYNAME           = v_HKDZ_CITYNAME, --户口地址 市名称
             HKDZ_DISTRICTNAME       = v_HKDZ_DISTRICTNAME, --户口地址 县名称
             HKDZ_POST               = v_HKDZ_POST, --户口所在地邮编
             JG_PROVINCEID           = v_JG_PROVINCEID, --籍贯 省名称
             JG_CITYID               = v_JG_CITYID, --籍贯 市名称
             JG_PROVINCENAME         = v_JG_PROVINCENAME, --籍贯 省名称
             JG_CITYNAME             = v_JG_CITYNAME, --籍贯 市名称\
             age                     = v_Age,
             zg_flag                 = v_zg_flag, --addby ywk 2012年5月14日 14:53:16
             admitinfo               = v_admitinfo, ---add by ywk 2012年6月26日 10:15:30
             CSDADDRESS              = v_CSDADDRESS, --出生地 add by ywk 2012年7月11日 10:18:22
             JGADDRESS               = v_JGADDRESS, --籍贯地址
             XZZADDRESS              = v_XZZADDRESS, --现住址
             HKAddress               = v_HKDZADDRESS, --户口住址
             MenAndInHop             = v_MenAndInHop,
             InHopAndOutHop          = v_InHopAndOutHop,
             BeforeOpeAndAfterOper   = v_BeforeOpeAndAfterOper,
             LinAndBingLi            = v_LinAndBingLi,
             InHopThree              = v_InHopThree,
             FangAndBingLi           = v_FangAndBingLi
       where IEM_MAINPAGE_NO = v_IEM_MAINPAGE_NO;
      open o_result for
        select v_IEM_MAINPAGE_NO from dual;
    end if;
  
  END;

  /*****查询病案首页信息****************************************************************************/
  PROCEDURE usp_getieminfo_2012(v_NoOfInpat INT,
                                o_result    OUT empcurtyp,
                                o_result1   OUT empcurtyp,
                                o_result2   OUT empcurtyp,
                                o_result3   OUT empcurtyp,
                                o_result4   OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取病人病案首页各模块信息
     功能说明
     输入参数
      v_NoOfInpat varchar(40)--首页序号
     输出参数
    **********/
    v_infono NUMERIC;
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result1 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result2 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result3 FOR
      SELECT '' FROM DUAL;

  
    SELECT MAX(imb.iem_mainpage_no)
      INTO v_infono
      FROM iem_mainpage_basicinfo_2012 imb
     WHERE imb.noofinpat = v_noofinpat
       AND imb.valide = 1;
  
    /* --数据顺序不可变，与程序里相关
        --基本信息
        OPEN o_result FOR
          SELECT iem.iem_mainpage_no,
                 iem.noofinpat,
                 iem.socialcare,
                 iem.payid,
                 pay.name payName,
    
                 iem.incount,
                 iem.patnoofhis,
                 iem.name,
                 iem.sexid,
                 iem.birth,
    
                 iem.marital,
                 iem.jobid,
                 job.name jobName,
                 iem.csd_provinceid,
                 iem.csd_cityid,
    
                 iem.csd_districtid,
                 iem.csd_provincename,
                 iem.csd_cityname,
                 iem.csd_districtname,
                 iem.xzz_provinceid,
    
                 iem.xzz_cityid,
                 iem.xzz_districtid,
                 iem.xzz_provincename,
                 iem.xzz_cityname,
                 iem.xzz_districtname,
    
                 iem.xzz_tel,
                 iem.xzz_post,
                 iem.hkdz_provinceid,
                 iem.hkdz_cityid,
                 iem.hkdz_districtid,
    
                 iem.hkdz_provincename,
                 iem.hkdz_cityname,
                 iem.hkdz_districtname,
                 iem.hkdz_post,
                 iem.jg_provinceid,
    
                 iem.jg_cityid,
                 iem.jg_provincename,
                 iem.jg_cityname,
                 iem.nationid,
                 nation.name NationName,
    
                 iem.nationalityid,
                 nationality.name nationalityName,
                 iem.idno,
                 iem.organization,
                 iem.officeplace,
    
                 iem.officetel,
                 iem.officepost,
                 iem.contactperson,
                 iem.relationship,
                 relationship.name relationshipName,
    
                 iem.contactaddress ContactAddress,
                 iem.contacttel ContactTEL,
                 iem.admitdate,
                 iem.admitdept,
                 AdmitDept.name AdmitDeptName,
    
                 iem.admitward,
                 admitward.name admitwardName,
                 iem.trans_admitdept,
                 trans_admitdept.name trans_admitdeptName,
                 iem.outwarddate,
    
                 iem.outhosdept,
                 outhosdept.name outhosdeptName,
                 iem.outhosward,
                 outhosward.name outhoswardName,
                 iem.actualdays,
    
                 iem.is_completed,
                 iem.completed_time,
                 iem.valide,
                 iem.create_user,
                 iem.create_time,
    
                 iem.modified_user,
                 iem.modified_time,
                 iem.autopsy_flag,
    
                 --2012国家卫生部表中病案首页新增内容
                 iem.monthage,
                 iem.weight,
                 iem.inweight,
                 iem.inhostype,
                 iem.outhostype,
    
                 iem.receivehospital,
                 iem.receivehospital2,
                 iem.againinhospital,
                 iem.againinhospitalreason,
                 iem.beforehoscomaday,
    
                 iem.beforehoscomahour,
                 iem.beforehoscomaminute,
                 iem.laterhoscomaday,
                 iem.laterhoscomahour,
                 iem.laterhoscomaminute,
                 iem.cardnumber,
    
                 ---诊断实体
                 iem.pathology_diagnosis_id,
                 iem.pathology_diagnosis_name,
                 iem.pathology_observation_sn,
                 iem.hurt_toxicosis_ele_id,
                 iem.hurt_toxicosis_ele_name,
    
                 iem.allergic_flag,
                 iem.allergic_drug,
                 iem.bloodtype,
                 iem.rh,
                 iem.section_director,
    
                 section_director.name section_directorName,
                 iem.director,
                 director.name directorName,
                 iem.vs_employee_code vs_employeeID,
                 vs_employee.name vs_employeeName,
    
                 iem.resident_employee_code resident_employeeID,
                 resident_employee.name     resident_employeeName,
                 iem.refresh_employee_code  refresh_employeeID,
                 refresh_employee.name      refresh_employeeName,
                 iem.duty_nurse             ,
    
                 duty_nurse.name Duty_NurseName,
                 iem.interne,
                 interne.name interneName,
                 iem.coding_user,
                 coding_user.name coding_userName,
    
                 iem.medical_quality_id,
                 iem.quality_control_doctor,
                 quality_control_doctor.name quality_control_doctorName,
                 iem.quality_control_nurse,
                 quality_control_nurse.name quality_control_nurseName,
    
                 iem.quality_control_date,
                 iem.age,
                 iem.zg_flag
    
            FROM iem_mainpage_basicinfo_2012 iem
            left join dictionary_detail pay on pay.detailid = iem.payid
                                           and pay.categoryid = '1'
            left join dictionary_detail job on job.detailid = iem.jobid
                                           and job.categoryid = '41'
            left join dictionary_detail nation on nation.detailid =
                                                  iem.nationid
                                              and nation.categoryid = '42'
            left join dictionary_detail nationality on nationality.detailid =
                                                       iem.nationalityid
                                                   and nationality.categoryid = '43'
            left join dictionary_detail relationship on relationship.detailid =
                                                        iem.relationship
                                                    and relationship.categoryid = '44'
            left join department AdmitDept on AdmitDept.id = iem.admitdept
            left join ward admitward on admitward.id = iem.admitward
            left join department trans_admitdept on trans_admitdept.id =
                                                    iem.trans_admitdept
            left join department outhosdept on outhosdept.id = iem.outhosdept
            left join ward outhosward on outhosward.id = iem.outhosward
            left join diagnosis zymosis on zymosis.markid = iem.zymosis
            left join users section_director on section_director.id =
                                                iem.section_director
            left join users director on director.id = iem.director
            left join users vs_employee on vs_employee.id =
                                           iem.vs_employee_code
            left join users resident_employee on resident_employee.id =
                                                 iem.resident_employee_code
            left join users refresh_employee on refresh_employee.id =
                                                iem.refresh_employee_code
    
            left join users interne on interne.id = iem.interne
            left join users duty_nurse on duty_nurse.id = iem.duty_nurse
            left join users coding_user on coding_user.id = iem.coding_user
            left join users quality_control_doctor on quality_control_doctor.id =
                                                      iem.quality_control_doctor
            left join users quality_control_nurse on quality_control_nurse.id =
                                                     iem.quality_control_nurse
           WHERE iem.iem_mainpage_no = v_infono
             AND iem.valide = 1;
    */
  
    --数据顺序不可变，与程序里相关
    --基本信息
    OPEN o_result FOR
      SELECT iem.iem_mainpage_no,
             iem.noofinpat,
             iem.socialcare,
             myinp.payid,
             pay.name payName,
             myinp.noofrecord,
             iem.incount,
             iem.patnoofhis,
             myinp.name,
             myinp.sexid,
             myinp.birth,
             myinp.nativetel, ---现住址电话edit 2012年6月25日 08:46:26
             myinp.marital,
             myinp.jobid,
             job.name    jobName,
             iem.zg_flag,
             myinp.provinceid csd_provinceid,
             myinp.countyid csd_cityid,
             myinp.districtid csd_districtid,    
             csdpro.provincename csd_provincename,
             csdcity.cityname    csd_cityname,
             csddis.districtname csd_districtname,
             myinp.xzzproviceid xzz_provinceid,
             myinp.xzzcityid     xzz_cityid,
             myinp.xzzdistrictid xzz_districtid,
             myinp.xzzdetailaddress xzz_detailaddress,--add by cyq 2012-12-27
             xzzpro.provincename xzz_provincename,
             xzzcity.cityname    xzz_cityname,
             xzzdis.districtname xzz_districtname,
             myinp.xzztel         xzz_tel,
             myinp.xzzpost        xzz_post,
             myinp.hkdzproviceid  hkdz_provinceid,
             myinp.hkzdcityid     hkdz_cityid,
             myinp.hkzddistrictid hkdz_districtid,
             hkzzpro.provincename hkdz_provincename,
             hkzzcity.cityname    hkdz_cityname,
             hkzzdis.districtname hkdz_districtname,
             myinp.hkdzdetailaddress hkdz_detailaddress,--add by cyq 2012-12-27
             myinp.nativepost hkdz_post,
             myinp.nativeplace_p jg_provinceid,
             myinp.nativeplace_c jg_cityid,
             jgpro.provincename  jg_provincename,
             jgcity.cityname     jg_cityname,
             myinp.nationid,
             nation.name    NationName,
             myinp.nationalityid,
             nationality.name    nationalityName,
             myinp.idno,
             iem.organization,
             myinp.officeplace,
             myinp.officetel,
             myinp.officepost,
             myinp.contactperson,
             myinp.relationship,
             relationship.name  relationshipName,
             myinp.contactaddress ContactAddress,
             myinp.contacttel ContactTEL,
             myinp.admitdate,
             myinp.inwarddate,--入区时间add by ywk 2013年1月17日13:54:50
             myinp.admitdept,
             AdmitDept.name  AdmitDeptName,
             iem.admitinfo, --新增的入院病情 2012年6月26日 09:42:30
             myinp.admitward,
             admitward.name       admitwardName,
             iem.trans_admitdept,
             trans_admitdept.name trans_admitdeptName,
             myinp.outhosdate,
             myinp.outhosdept,
             outhosdept.name  outhosdeptName,
             myinp.outhosward,
             outhosward.name  outhoswardName,
             myinp.totaldays actualdays,
             iem.is_completed,
             iem.completed_time,
             iem.valide,
             iem.create_user,
             iem.create_time,
             iem.modified_user,
             iem.modified_time,
             iem.autopsy_flag,
             --2012国家卫生部表中病案首页新增内容
             iem.monthage,
             iem.weight,
             iem.inweight,
             iem.inhostype,
             iem.outhostype,
             iem.receivehospital,
             iem.receivehospital2,
             iem.againinhospital,
             iem.againinhospitalreason,
             iem.beforehoscomaday,
             iem.beforehoscomahour,
             iem.beforehoscomaminute,
             iem.laterhoscomaday,
             iem.laterhoscomahour,
             iem.laterhoscomaminute,
             iem.cardnumber,
             ---诊断实体
             iem.pathology_diagnosis_id,
             iem.pathology_diagnosis_name,
             iem.pathology_observation_sn,
             iem.hurt_toxicosis_ele_id,
             iem.hurt_toxicosis_ele_name,
             iem.allergic_flag,
             iem.allergic_drug,
             iem.bloodtype,
             iem.rh,
             iem.section_director,
             section_director.name section_directorName,
             iem.director,
             director.name         directorName,
             iem.vs_employee_code  vs_employeeID,
             vs_employee.name      vs_employeeName,
             iem.resident_employee_code resident_employeeID,
             resident_employee.name     resident_employeeName,
             iem.refresh_employee_code  refresh_employeeID,
             refresh_employee.name      refresh_employeeName,
             iem.duty_nurse,
             duty_nurse.name  Duty_NurseName,
             iem.interne,
             interne.name     interneName,
             iem.coding_user,
             coding_user.name coding_userName,
             iem.medical_quality_id,
             iem.quality_control_doctor,
             quality_control_doctor.name quality_control_doctorName,
             iem.quality_control_nurse,
             quality_control_nurse.name  quality_control_nurseName,
             iem.quality_control_date,
             myinp.agestr  age,
             myinp.csdaddress, --出生地地址 ywk 
             myinp.jgaddress, --籍贯地址
             myinp.xzzaddress, --现住址
             myinp.hkaddress, --户口住址
             iem.menandinhop, --门诊
             iem.inhopandouthop,
             iem.beforeopeandafteroper,
             iem.linandbingli,
             iem.inhopthree,
             iem.fangandbingli,
             myinp.isbaby, --是否婴儿的标志 add by ywk 2012年7月30日 13:58:41
             myinp.mother --母亲的首页序号 Noofinpat    
        FROM iem_mainpage_basicinfo_2012 iem
      -- edit  by ywk （对于首页表里有的，病人表里也有的数据，在病案首页显示的时候取病人表里的数据）
        left join inpatient myinp
          on myinp.noofinpat = iem.noofinpat
        left join dictionary_detail pay
          on pay.detailid = myinp.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
          on job.detailid = myinp.jobid
         and job.categoryid = '41'
        left join dictionary_detail nation
          on nation.detailid = myinp.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = myinp.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = myinp.relationship
         and relationship.categoryid = '44'
        left join department AdmitDept
          on AdmitDept.id = myinp.admitdept
        left join ward admitward
          on admitward.id = myinp.admitward
        left join department trans_admitdept
          on trans_admitdept.id = iem.trans_admitdept
        left join department outhosdept
          on outhosdept.id = myinp.outhosdept
        left join ward outhosward
          on outhosward.id = myinp.outhosward
        left join diagnosis zymosis
          on zymosis.markid = iem.zymosis
        left join users section_director
          on section_director.id = iem.section_director
        left join users director
          on director.id = iem.director
        left join users vs_employee
          on vs_employee.id = iem.vs_employee_code
        left join users resident_employee
          on resident_employee.id = iem.resident_employee_code
        left join users refresh_employee
          on refresh_employee.id = iem.refresh_employee_code
      
        left join users interne
          on interne.id = iem.interne
        left join users duty_nurse
          on duty_nurse.id = iem.duty_nurse
        left join users coding_user
          on coding_user.id = iem.coding_user
        left join users quality_control_doctor
          on quality_control_doctor.id = iem.quality_control_doctor
        left join users quality_control_nurse
          on quality_control_nurse.id = iem.quality_control_nurse
      
      ---省，市，县的名称从Inpatient表里去除，取名称，进行链表查询 add by ywk 2012年5月17日10:58:03
        left join s_province csdpro
          on myinp.provinceid = csdpro.provinceid --出生地的省
        left join s_city csdcity
          on myinp.countyid = csdcity.cityid --出生地的市
        left join s_district csddis
          on myinp.districtid = csddis.districtid --出生地的县
      
        left join s_province jgpro
          on myinp.nativeplace_p = jgpro.provinceid --籍贯的省
        left join s_city jgcity
          on myinp.nativeplace_c = jgcity.cityid --籍贯的市
      
        left join s_province xzzpro
          on myinp.xzzproviceid = xzzpro.provinceid --现住址的省
        left join s_city xzzcity
          on myinp.xzzcityid = xzzcity.cityid --现住址的市
        left join s_district xzzdis
          on myinp.xzzdistrictid = xzzdis.districtid --现住址的县
      
        left join s_province hkzzpro
          on myinp.hkdzproviceid = hkzzpro.provinceid --户口住址的省
        left join s_city hkzzcity
          on myinp.hkzdcityid = hkzzcity.cityid --户口住址的市
        left join s_district hkzzdis
          on myinp.hkzddistrictid = hkzzdis.districtid --户口住址的县
      
       WHERE iem.iem_mainpage_no = v_infono
         AND iem.valide = 1;
  
    --诊断
    OPEN o_result1 FOR
      SELECT diag.diagnosis_name,
             diag.morphologyicd,--形态学诊断编码
             diag.morphologyname,--形态学诊断名称  add jxh
             diag.status_id,
             (case
               when diag.status_id = '1' then
                '有'
               when diag.status_id = '2' then
                '临床未确定'
               when diag.status_id = '3' then
                '情况不明'
               when diag.status_id = '4' then
                '无'
               else
                ''
             end) Status_Name, --入院病情
             diag.iem_mainpage_diagnosis_no,diag.iem_mainpage_no,--add by cyq 2012-12-25
             diag.diagnosis_code,
             diag.diagnosis_type_id,
             diag.order_value,
             diag.menandinhop,
             /*( case when diag.menandinhop='0' then '未作'
               when  diag.menandinhop='1' then '确诊'
                 when diag.menandinhop='2' then '误诊'
                when   diag.menandinhop='3' then '不肯定'
                   else '' end
             )*/
             md.name             as menandinhopname,
             diag.inhopandouthop,
             /* (
             case when diag.inhopandouthop='0' then '未作'
               when  diag.inhopandouthop='1' then '确诊'
             when     diag.inhopandouthop='2' then '误诊'
                when   diag.inhopandouthop='3' then '不肯定'
                   else '' end
             )*/
             ind.name                   as inhopandouthopname,
             diag.beforeopeandafteroper,
             /* (
             case when diag.beforeopeandafteroper='0' then '未作'
               when  diag.beforeopeandafteroper='1' then '确诊'
              when    diag.beforeopeandafteroper='2' then '误诊'
               when    diag.beforeopeandafteroper='3' then '不肯定'
                   else '' end
             )*/
             befd.name         as beforeopeandafteropername,
             diag.linandbingli,
             /*  (
             case when diag.linandbingli='0' then '未作'
               when  diag.linandbingli='1' then '确诊'
               when   diag.linandbingli='2' then '误诊'
               when    diag.linandbingli='3' then '不肯定'
                   else '' end
             )*/
             lid.name        as linandbingliname,
             diag.inhopthree,
             /*    (
             case when diag.inhopthree='0' then '未作'
               when  diag.inhopthree='1' then '确诊'
               when   diag.inhopthree='2' then '误诊'
                when   diag.inhopthree='3' then '不肯定'
                   else '' end
             )*/
             intd.name          as inhopthreename,
             diag.fangandbingli,
             /* (
             case when diag.fangandbingli='0' then '未作'
               when  diag.fangandbingli='1' then '确诊'
                when  diag.fangandbingli='2' then '误诊'
               when    diag.fangandbingli='3' then '不肯定'
                   else '' end
             )*/
             fad.name       as fangandbingliname,
             addinfo.name   as admitinfoname,
             diag.admitinfo --新增的入院病情 add by ywk  2012年7月26日 15:12:42
        FROM iem_mainpage_diagnosis_2012 diag
        left join dictionary_detail addinfo
          on addinfo.detailid = diag.admitinfo
         and addinfo.categoryid = '5'
        left join dictionary_detail md
          on diag.menandinhop = md.detailid
         and md.categoryid = 'dg'
        left join dictionary_detail ind
          on diag.inhopandouthop = ind.detailid
         and ind.categoryid = 'dg'
        left join dictionary_detail lid
          on diag.linandbingli = lid.detailid
         and lid.categoryid = 'dg'
        left join dictionary_detail befd
          on diag.beforeopeandafteroper = befd.detailid
         and befd.categoryid = 'dg'
        left join dictionary_detail intd
          on diag.inhopthree = intd.detailid
         and intd.categoryid = 'dg'
        left join dictionary_detail fad
          on diag.fangandbingli = fad.detailid
         and fad.categoryid = 'dg'
       WHERE iem_mainpage_no = v_infono
         AND valide = 1
       ORDER BY order_value;
  
    --手术
    /*    OPEN o_result2 FOR
    SELECT *
      FROM iem_mainpage_operation
     WHERE iem_mainpage_no = v_infono
       AND valide = 1;*/
  
    OPEN o_result2 FOR
    
      SELECT iem.iem_mainpage_operation_no,
             iem.iem_mainpage_no,
             iem.operation_code,
             iem.operation_date,
             iem.operation_name,
             u1.name                       execute_user1_Name,
             iem.execute_user1,
             u2.name                       execute_user2_Name,
             iem.execute_user2,
             u3.name                       execute_user3_Name,
             iem.execute_user3,
             --dic.name anaesthesia_type_Name,
             ab.name anaesthesia_type_Name,
             iem.anaesthesia_type_id,
             (case
               when iem.close_level = '1' then
                'I/甲'
               when iem.close_level = '2' then
                'II/甲'
               when iem.close_level = '3' then
                'III/甲'
               when iem.close_level = '4' then
                'I/乙'
               when iem.close_level = '5' then
                'II/乙'
               when iem.close_level = '6' then
                'III/乙'
               when iem.close_level = '7' then
                'I/丙'
               when iem.close_level = '8' then
                'II/丙'
               when iem.close_level = '9' then
                'III/丙'
               else
                ''
             end) close_level_Name,
             iem.operation_level,
             (case
               when iem.operation_level = '1' then --operation_level
                '一级手术'
               when iem.operation_level = '2' then
                '二级手术'
               when iem.operation_level = '3' then
                '三级手术'
               when iem.operation_level = '4' then
                '四级手术'
               else
                ''
             end) operation_level_Name,
             iem.close_level,
             ua.name anaesthesia_user_Name,
             iem.anaesthesia_user,
             iem.valide,
             iem.create_user,
             iem.create_time,
             iem.cancel_user,
             iem.cancel_time,
             iem.ischoosedate,
             iem.isclearope,
             iem.isganran,
             (case
               when iem.ischoosedate = '1' then
                '是'
               when iem.ischoosedate = '2' then
                '否'
               when iem.ischoosedate = '0' then
                '未知'
               else
                ''
             end) ischoosedatename,
             (case
               when iem.isclearope = '1' then
                '是'
               when iem.isclearope = '2' then
                '否'
               when iem.isclearope = '0' then
                '未知'
               else
                ''
             end) isclearopename,
             (case
               when iem.isganran = '1' then
                '是'
               when iem.isganran = '2' then
                '否'
               when iem.isganran = '0' then
                '未知'
               else
                ''
             end) isganranname
             ,iem.anesthesia_level,iem.opercomplication_code
        FROM iem_mainpage_operation_2012 iem
        left join users u1
          on iem.execute_user1 = u1.id
         and u1.valid = 1
        left join users u2
          on iem.execute_user2 = u2.id
         and u2.valid = 1
        left join users u3
          on iem.execute_user3 = u3.id
         and u3.valid = 1
        left join users ua
          on iem.anaesthesia_user = ua.id
         and ua.valid = 1
      /* left join dictionary_detail dic on iem.anaesthesia_type_id =
          dic.detailid
      and dic.categoryid = '30'*/
      --edit by ywk 2012年4月18日10:24:09
        left join anesthesia ab
          on iem.anaesthesia_type_id = ab.id
       WHERE valide = 1
         and iem.iem_mainpage_no = v_infono;
  
    --产妇婴儿信息
    OPEN o_result3 FOR
      SELECT *
        FROM IEM_MAINPAGE_OBSTETRICSBABY
       WHERE iem_mainpage_no = v_infono
         AND valide = 1;
         
        ---取得病案首页的费用信息 --add by ywk   2012年10月16日 20:23:51
    OPEN o_result4 FOR
    select  *from Iem_MainPage_FeeInfo where iem_mainpage_no = v_infono
         AND valid = 1;
  END;

  /*********************************************************************************/
  PROCEDURE usp_edit_iem_mainpage_oper2012(v_iem_mainpage_no     NUMERIC,
                                           v_operation_code      VARCHAR,
                                           v_operation_date      VARCHAR,
                                           v_operation_name      VARCHAR,
                                           v_execute_user1       VARCHAR,
                                           v_execute_user2       VARCHAR,
                                           v_execute_user3       VARCHAR,
                                           v_anaesthesia_type_id NUMERIC,
                                           v_close_level         NUMERIC,
                                           v_anaesthesia_user    VARCHAR,
                                           --v_Valide numeric ,
                                           v_create_user     VARCHAR,
                                           v_OPERATION_LEVEL varchar,
                                           v_IsChooseDate    varchar, --手术相关字段
                                           v_IsClearOpe      varchar,
                                           v_IsGanRan        varchar,
                                           v_anesthesia_level varchar,
                                           v_opercomplication_code varchar
                                           --v_Create_Time varchar(19)
                                           --v_Cancel_User varchar(10) ,
                                           --v_Cancel_Time varchar(19)
                                           ) AS /**********
                                                                                   版本号  1.0.0.0.0
                                                                                   创建时间
                                                                                   作者
                                                                                   版权
                                                                                   描述  插入功病案首页手术TABLE
                                                                                   功能说明
                                                                                   输入参数
                                                                                   输出参数
                                                                                   结果集、排序
            
                                                                                   调用的sp
                                                                                   调用实例
            
                                                                                   修改记录
                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_operation_2012
      (iem_mainpage_operation_no,
       iem_mainpage_no,
       operation_code,
       operation_date,
       operation_name,
       execute_user1,
       execute_user2,
       execute_user3,
       anaesthesia_type_id,
       close_level,
       anaesthesia_user,
       valide,
       create_user,
       create_time,
       OPERATION_LEVEL,
       IsChooseDate, --增加的手术相关字段
       IsClearOpe,
       IsGanRan
       ,anesthesia_level,opercomplication_code)
    VALUES
      (seq_iem_mainpage_operation_id.NEXTVAL,
       v_iem_mainpage_no, --numeric
       v_operation_code, -- varchar(60)
       v_operation_date,
       -- varchar(19)
       v_operation_name, -- varchar(300)
       v_execute_user1, -- varchar(20)
       v_execute_user2,
       -- varchar(20)
       v_execute_user3, -- varchar(20)
       v_anaesthesia_type_id, -- numeric
       v_close_level,
       -- numeric
       v_anaesthesia_user, -- varchar(20)
       1, -- numeric
       v_create_user, -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'),
       v_OPERATION_LEVEL,
       v_IsChooseDate, --手术相关字段
       v_IsClearOpe,
       v_IsGanRan
       ,v_anesthesia_level,v_opercomplication_code);
  END;

 

/*********************************************************************************/
  PROCEDURE usp_edif_iem_mainpage_diag2012(v_iem_mainpage_no   VARCHAR,
                                           v_diagnosis_type_id VARCHAR,
                                           v_diagnosis_code    VARCHAR,
                                           v_diagnosis_name    VARCHAR,
                                           v_status_id         VARCHAR,
                                           v_order_value       VARCHAR,
                                           --v_Valide numeric ,
                                           v_create_user           VARCHAR,
                                           v_MenAndInHop           varchar, --门诊和住院
                                           v_InHopAndOutHop        varchar, --入院和出院
                                           v_BeforeOpeAndAfterOper varchar, --术前和术后
                                           v_LinAndBingLi          varchar, --临床与病理
                                           v_InHopThree            varchar, --入院三日内
                                           v_FangAndBingLi         varchar, --放射和病理
                                           v_AdmitInfo             varchar --子入院病情
                                           --v_Create_Time varchar(19) ,
                                           --v_Cancel_User varchar(10) ,
                                           --v_Cancel_Time varchar(19)
                                           ) AS /**********
                                                                                   版本号  1.0.0.0.0
                                                                                   创建时间
                                                                                   作者
                                                                                   版权
                                                                                   描述  插入功病案首页诊断TABLE
                                                                                   功能说明
                                                                                   输入参数
                                                                                   输出参数
                                                                                   结果集、排序

                                                                                   调用的sp
                                                                                   调用实例

                                                                                   修改记录
                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_diagnosis_2012
      (iem_mainpage_diagnosis_no,
       iem_mainpage_no,
       diagnosis_type_id,
       diagnosis_code,
       diagnosis_name,
       status_id,
       order_value,
       valide,
       create_user,
       create_time,
       MenAndInHop,
       InHopAndOutHop,
       BeforeOpeAndAfterOper,
       LinAndBingLi,
       InHopThree,
       FangAndBingLi,
       admitinfo)
    VALUES
      (seq_iem_mainpage_diagnosis_id.NEXTVAL,
       v_iem_mainpage_no, -- Iem_Mainpage_NO - numeric
       v_diagnosis_type_id,
       -- Diagnosis_Type_Id - numeric
       v_diagnosis_code,
       -- Diagnosis_Code - varchar(60)
       v_diagnosis_name, -- Diagnosis_Name - varchar(300)
       v_status_id, -- Status_Id - numeric
       v_order_value,
       -- Order_Value - numeric
       1,
       -- Valide - numeric
       v_create_user, -- Create_User - varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'),
       v_MenAndInHop, --门诊和住院
       v_InHopAndOutHop, --入院和出院
       v_BeforeOpeAndAfterOper, --术前和术后
       v_LinAndBingLi, --临床与病理
       v_InHopThree, --入院三日内
       v_FangAndBingLi,
       v_AdmitInfo
       -- Create_Time - varchar(19)
       );
  END;
  
  
  -----------------------------------------------湖北专用首页存储过程  add jxh----------------------------------------------------------------------
  PROCEDURE usp_edif_iem_mainpage_diag_hb(v_iem_mainpage_no   VARCHAR,
                                           v_diagnosis_type_id VARCHAR,
                                           v_diagnosis_code    VARCHAR,
                                           v_diagnosis_name    VARCHAR,                                            
                                           v_status_id         VARCHAR,
                                           v_order_value       VARCHAR,
                                           v_morphologyicd     VARCHAR,--形态学诊断编码
                                           v_morphologyname    VARCHAR,--形态学诊断名称 
                                           --v_Valide numeric ,
                                           v_create_user           VARCHAR,
                                           v_MenAndInHop           varchar, --门诊和住院
                                           v_InHopAndOutHop        varchar, --入院和出院
                                           v_BeforeOpeAndAfterOper varchar, --术前和术后
                                           v_LinAndBingLi          varchar, --临床与病理
                                           v_InHopThree            varchar, --入院三日内
                                           v_FangAndBingLi         varchar, --放射和病理
                                           v_AdmitInfo             varchar --子入院病情 
                                           --v_Create_Time varchar(19) ,
                                           --v_Cancel_User varchar(10) ,
                                           --v_Cancel_Time varchar(19)
                                           ) AS /**********
                                                                                   版本号  1.0.0.0.0
                                                                                   创建时间
                                                                                   作者
                                                                                   版权
                                                                                   描述  插入功病案首页诊断TABLE
                                                                                   功能说明
                                                                                   输入参数
                                                                                   输出参数
                                                                                   结果集、排序
            
                                                                                   调用的sp
                                                                                   调用实例
            
                                                                                   修改记录
                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_diagnosis_2012
      (iem_mainpage_diagnosis_no,
       iem_mainpage_no,
       diagnosis_type_id,
       diagnosis_code,
       diagnosis_name, 
       morphologyicd,
       morphologyname,
       status_id,
       order_value,
       valide,
       create_user,
       create_time,
       MenAndInHop,
       InHopAndOutHop,
       BeforeOpeAndAfterOper,
       LinAndBingLi,
       InHopThree,
       FangAndBingLi,
       admitinfo)
    VALUES
      (seq_iem_mainpage_diagnosis_id.NEXTVAL,
       v_iem_mainpage_no, -- Iem_Mainpage_NO - numeric
       v_diagnosis_type_id,
       -- Diagnosis_Type_Id - numeric
       v_diagnosis_code,
       -- Diagnosis_Code - varchar(60)
       v_diagnosis_name, -- Diagnosis_Name - varchar(300)  
       v_morphologyicd,
       v_morphologyname,     
       v_status_id, -- Status_Id - numeric
       v_order_value,
       -- Order_Value - numeric
       1,
       -- Valide - numeric
       v_create_user, -- Create_User - varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'),
       v_MenAndInHop, --门诊和住院
       v_InHopAndOutHop, --入院和出院
       v_BeforeOpeAndAfterOper, --术前和术后
       v_LinAndBingLi, --临床与病理
       v_InHopThree, --入院三日内
       v_FangAndBingLi,
       v_AdmitInfo
       -- Create_Time - varchar(19)
       );
  END;



  --更新病案首页信息后，对病人信息表进行数据同步 add by ywk 二一二年五月四日 15:20:27
  PROCEDURE usp_Edit_Iem_PaientInfo(v_NOOFINPAT      varchar2 default '', ---- '病人首页序号';
                                    v_NAME           varchar2 default '', ---- '患者姓名';
                                    v_SEXID          varchar2 default '', ---- '性别';
                                    v_BIRTH          varchar2 default '', ---- '出生';
                                    v_Age            INTEGER default '', --年龄
                                    v_IDNO           varchar2 default '', ---- '身份证号码';
                                    v_MARITAL        varchar2 default '', ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
                                    v_JOBID          varchar2 default '', ---- '职业';
                                    v_CSD_PROVINCEID varchar2 default '', ---- '出生地 省';
                                    v_CSD_CITYID     varchar2 default '', ---- '出生地 市';
                                    v_NATIONID       varchar2 default '', --民族
                                    v_NATIONALITYID  varchar2 default '', ---- '国籍ID';
                                    v_JG_PROVINCEID  varchar2 default '', ---- '籍贯 省';
                                    v_JG_CITYID      varchar2 default '', ---- '籍贯 市';
                                    v_OFFICEPLACE    varchar2 default '', ---- '工作单位地址';
                                    v_OFFICETEL      varchar2 default '', ---- '工作单位电话';
                                    v_OFFICEPOST     varchar2 default '', ---- '工作单位邮编';
                                    v_HKDZ_POST      varchar2 default '', ---- '户口所在地邮编';
                                    v_CONTACTPERSON  varchar2 default '', ---- '联系人姓名';
                                    v_RELATIONSHIP   varchar2 default '', ---- '与联系人关系';
                                    v_CONTACTADDRESS varchar2 default '', ---- '联系人地址';
                                    v_CONTACTTEL     varchar2 default '', ---- '联系人电话';
                                    v_ADMITDEPT      varchar2 default '', ---- '入院科室';
                                    v_ADMITWARD      varchar2 default '', ---- '入院病区';\
                                    v_ADMITDATE      varchar2 default '', ---- '入院时间';
                                    v_OUTWARDDATE    varchar2 default '', ---- '出院时间';
                                    v_OUTHOSDEPT     varchar2 default '', ---- '出院科室';
                                    v_OUTHOSWARD     varchar2 default '', ---- '出院病区';
                                    v_ACTUALDAYS     varchar2 default '', ---- '实际住院天数';
                                    v_AgeStr         varchar2 default '', ---- '年龄 精确到月天;2012年5月9日9:31:03 （杨维康 泗县修改）
                                    v_PatId          varchar2 default '', --新增的付款方式 add by ywk 2012年5月14日 16:02:13
                                    v_CardNo         varchar2 default '', --健康卡号   
                                    
                                    -----add by ywk  2012年5月16日9:45:27 Inpatient表l里增加病案首页里相应的字段
                                    v_Districtid     varchar2 default '', --出生地‘县’
                                    v_xzzproviceid   varchar2 default '', --现在住址省
                                    v_xzzcityid      varchar2 default '', --现在住址市
                                    v_xzzdistrictid  varchar2 default '', --现在住址县
                                    v_xzztel         varchar2 default '', --现在住址电话
                                    v_hkdzproviceid  varchar2 default '', --户口住址省
                                    v_hkzdcityid     varchar2 default '', --户口住址市
                                    v_hkzddistrictid varchar2 default '', --户口住址县    
                                    v_xzzpost        varchar2 default '', --现住址邮编    
                                    v_isupdate       varchar2 default '', ---2012年5月24日 17:19:10 ywk 是否更新身份证号字段
                                    v_CSDADDRESS     varchar2 default '', --出生地具体地址 add by ywk 2012年7月11日 10:13:49
                                    v_JGADDRESS      varchar2 default '', --籍贯地址具体地址 add by ywk 2012年7月11日 10:13:49
                                    v_XZZADDRESS     varchar2 default '', --现住址具体地址 add by ywk 2012年7月11日 10:13:49
                                    v_HKDZADDRESS    varchar2 default '' --户口地址具体地址 add by ywk 2012年7月11日 10:13:49
                                    --add by cyq 2012-12-27 Inpatient表里增加病案首页里相应的字段
                                    ,v_XZZDetailAddr varchar2 default '', --现住址详细地址(县级以下) add by cyq 2012-12-27
                                    v_HKDZDetailAddr varchar2 default '' --户口地址详细地址(县级以下) add by cyq 2012-12-27
                                    ) as
    myidno          varchar2(50);
    mymaterital     varchar2(50);
    myjobid         varchar2(50);
    myadmitdept     varchar2(50);
    mydamitward     varchar2(50);
    myouthosdept    varchar2(50);
    myouthosward    varchar2(50);
    myofficepalce   varchar2(250);
    myofficetel     varchar2(50);
    myofficepost    varchar2(50);
    mycontactperson varchar2(50);
    myadmitdate     varchar2(50);
    myouthosdate    varchar2(50);
    mynoofclinic    varchar2(50);
  begin
    /*select nvl(idno,v_IDNO)
     into myidno
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --身份证号码*/
  
    myidno := v_IDNO;
  
    /*select nvl(v_MARITAL, Marital)
     into mymaterital
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --婚姻*/
    mymaterital := v_MARITAL;
    myjobid     := v_JOBID;
    /* select nvl(v_JOBID, jobid)
     into myjobid
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --职业*/
    --  myadmitdept:=v_ADMITDEPT;
    select nvl(v_ADMITDEPT, AdmitDept)
      into myadmitdept
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --入院科室(如果病案首页里编辑的填写内容是空，就取原来的Inpatient表里的数据)
    --mydamitward:=  v_ADMITWARD; 
    select nvl(v_ADMITWARD, AdmitWard)
      into mydamitward
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --入院病区
    --myouthosdept:=v_OUTHOSDEPT;
    select nvl(v_OUTHOSDEPT, OutHosDept)
      into myouthosdept
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --出院室科
    --  myouthosward:=v_OUTHOSWARD;
    select nvl(v_OUTHOSWARD, OutHosWard)
      into myouthosward
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --出院病区
    /*  select nvl(v_OFFICEPLACE, OfficePlace)
     into myofficepalce
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --工作地址*/
    myofficepalce := v_OFFICEPLACE;
    /*   select nvl(v_OFFICETEL, OfficeTEL)
     into myofficetel
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --工作单位电话*/
    myofficetel  := v_OFFICETEL;
    myofficepost := v_OFFICEPOST;
    /*select nvl(v_OFFICEPOST, OfficePost)
     into myofficepost
     from inpatient
    where NoOfInpat =v_NOOFINPAT; --工作单位邮编*/
    mycontactperson := v_CONTACTPERSON;
    /* s\*elect nvl(v_CONTACTPERSON, ContactPerson)
     into mycontactperson
     from inpatient
    where NoOfInpat =*\ v_NOOFINPAT; --联系人姓名*/
    myadmitdate := v_ADMITDATE;
    /*select nvl(v_ADMITDATE, AdmitDate)
     into myadmitdate
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --入院时间*/
    myouthosdate := v_OUTWARDDATE;
    select nvl(v_OUTWARDDATE, OutHosDate)
      into myouthosdate
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --出院时间
    if v_isupdate = '0' then
      update inpatient
         set Name           = v_NAME,
             sexid          = v_SEXID,
             birth          = v_BIRTH,
             age            = v_Age,
             idno           = myidno,
             Marital        = mymaterital,
             jobid          = myjobid,
             ProvinceID     = v_CSD_PROVINCEID,
             CountyID       = v_CSD_CITYID,
             NationID       = v_NATIONID,
             NationalityID  = v_NATIONALITYID,
             Nativeplace_P  = v_JG_PROVINCEID,
             Nativeplace_C  = v_JG_CITYID,
             OfficePlace    = myofficepalce,
             OfficeTEL      = myofficetel,
             OfficePost     = myofficepost,
             NativePost     = v_HKDZ_POST,
             ContactPerson  = mycontactperson,
             Relationship   = v_RELATIONSHIP,
             ContactAddress = v_CONTACTADDRESS,
             ContactTEL     = v_CONTACTTEL,
             AdmitDept      = myadmitdept,
             AdmitWard      = mydamitward,
             AdmitDate      = myadmitdate,
             OutHosDate     = myouthosdate,
             OutHosDept     = myouthosdept,
             OutHosWard     = myouthosward,
             TotalDays      = v_ACTUALDAYS,
             AgeStr         = v_AgeStr,
             payid          = v_PatId,
             cardno         = v_CardNo,
             districtid     = v_Districtid,
             xzzproviceid   = v_xzzproviceid,
             xzzcityid      = v_xzzcityid,
             xzzdistrictid  = v_xzzdistrictid,
             xzztel         = v_xzztel,
             hkdzproviceid  = v_hkdzproviceid,
             hkzdcityid     = v_hkzdcityid,
             hkzddistrictid = v_hkzddistrictid,
             xzzpost        = v_xzzpost,
             CSDADDRESS     = v_CSDADDRESS,
             JGADDRESS      = v_JGADDRESS,
             XZZADDRESS     = v_XZZADDRESS,
             HKADDRESS      = v_HKDZADDRESS
             ,xzzdetailaddress = v_XZZDetailAddr, --add by cyq 2012-12-27
             hkdzdetailaddress = v_HKDZDetailAddr --add by cyq 2012-12-27
       where NoOfInpat = v_NOOFINPAT;
      commit;
    end if;
    if v_isupdate = '1' then
      if myidno = '不详' then
        mynoofclinic := '';
      else
        mynoofclinic := myidno;
      end if;
      update inpatient
         set Name           = v_NAME,
             sexid          = v_SEXID,
             birth          = v_BIRTH,
             age            = v_Age,
             idno           = mynoofclinic,
             Marital        = mymaterital,
             jobid          = myjobid,
             ProvinceID     = v_CSD_PROVINCEID,
             CountyID       = v_CSD_CITYID,
             NationID       = v_NATIONID,
             NationalityID  = v_NATIONALITYID,
             Nativeplace_P  = v_JG_PROVINCEID,
             Nativeplace_C  = v_JG_CITYID,
             OfficePlace    = myofficepalce,
             OfficeTEL      = myofficetel,
             OfficePost     = myofficepost,
             NativePost     = v_HKDZ_POST,
             ContactPerson  = mycontactperson,
             Relationship   = v_RELATIONSHIP,
             ContactAddress = v_CONTACTADDRESS,
             ContactTEL     = v_CONTACTTEL,
             AdmitDept      = myadmitdept,
             AdmitWard      = mydamitward,
             AdmitDate      = myadmitdate,
             OutHosDate     = myouthosdate,
             OutHosDept     = myouthosdept,
             OutHosWard     = myouthosward,
             TotalDays      = v_ACTUALDAYS,
             AgeStr         = v_AgeStr,
             payid          = v_PatId,
             cardno         = v_CardNo,
             districtid     = v_Districtid,
             xzzproviceid   = v_xzzproviceid,
             xzzcityid      = v_xzzcityid,
             xzzdistrictid  = v_xzzdistrictid,
             xzztel         = v_xzztel,
             hkdzproviceid  = v_hkdzproviceid,
             hkzdcityid     = v_hkzdcityid,
             hkzddistrictid = v_hkzddistrictid,
             xzzpost        = v_xzzpost,
             noofclinic     = mynoofclinic,
             CSDADDRESS     = v_CSDADDRESS,
             JGADDRESS      = v_JGADDRESS,
             XZZADDRESS     = v_XZZADDRESS,
             HKADDRESS      = v_HKDZADDRESS
             ,xzzdetailaddress = v_XZZDetailAddr, --add by cyq 2012-12-27
             hkdzdetailaddress = v_HKDZDetailAddr --add by cyq 2012-12-27
       where NoOfInpat = v_NOOFINPAT;
      commit;
    end if;
    /* begin
    update inpatient set Name = v_NAME ,sexid=v_SEXID,birth=v_BIRTH,age=v_Age,idno=v_IDNO,Marital=v_MARITAL,jobid=v_JOBID,
    ProvinceID=v_CSD_PROVINCEID,CountyID=v_CSD_CITYID,NationID=v_NATIONID,NationalityID=v_NATIONALITYID,Nativeplace_P=v_JG_PROVINCEID,
    Nativeplace_C=v_JG_CITYID,OfficePlace=v_OFFICEPLACE,OfficeTEL=v_OFFICETEL,OfficePost=v_OFFICEPOST,NativePost=v_HKDZ_POST,
    ContactPerson=v_CONTACTPERSON,Relationship=v_RELATIONSHIP,ContactAddress=v_CONTACTADDRESS,ContactTEL=v_CONTACTTEL,AdmitDept=v_ADMITDEPT,
    AdmitWard=v_ADMITWARD,AdmitDate=v_ADMITDATE,OutHosDate=v_OUTWARDDATE,OutHosDept=v_OUTHOSDEPT,OutHosWard=v_OUTHOSWARD,TotalDays=v_ACTUALDAYS
    where NoOfInpat = v_NOOFINPAT;
    commit;*/
  
  End;

  --获得首页默认表里的数据
  --add by ywk 2012年5月17日 09:36:46
  PROCEDURE usp_GetDefaultInpatient(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      select inp.*,
             pay.name             payname,
             job.name             jobname,
             nation.name          nationame,
             nationality.name     nationaltyname,
             relationship.name    relationshipname,
             csdpro.provincename  csd_provincename,
             csdcity.cityname     csd_cityname,
             csddis.districtname  csd_districtname,
             xzzpro.provincename  xzz_provincename,
             xzzcity.cityname     xzz_cityname,
             xzzdis.districtname  xzz_districtname,
             hkzzpro.provincename hkdz_provincename,
             hkzzcity.cityname    hkdz_cityname,
             hkzzdis.districtname hkdz_districtname,
             jgpro.provincename   jg_provincename,
             jgcity.cityname      jg_cityname,
             dia.name             outdiagname -- 门诊诊断
        from inpatient_default inp
        left join dictionary_detail pay
          on pay.detailid = inp.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
          on job.detailid = inp.jobid
         and job.categoryid = '41'
        left join dictionary_detail nation
          on nation.detailid = inp.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = inp.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = inp.relationship
         and relationship.categoryid = '44'
        left join diagnosis dia
          on dia.icd = inp.clinicdiagnosis
      ---省，市，县的名称从Inpatient表里去除，取名称，进行链表查询 add by ywk 2012年5月17日10:58:03
        left join s_province csdpro
          on inp.provinceid = csdpro.provinceid --出生地的省
        left join s_city csdcity
          on inp.countyid = csdcity.cityid --出生地的市
        left join s_district csddis
          on inp.districtid = csddis.districtid --出生地的县
      
        left join s_province jgpro
          on inp.nativeplace_p = jgpro.provinceid --籍贯的省
        left join s_city jgcity
          on inp.nativeplace_c = jgcity.cityid --籍贯的市
      
        left join s_province xzzpro
          on inp.xzzproviceid = xzzpro.provinceid --现住址的省
        left join s_city xzzcity
          on inp.xzzcityid = xzzcity.cityid --现住址的市
        left join s_district xzzdis
          on inp.xzzdistrictid = xzzdis.districtid --现住址的县
      
        left join s_province hkzzpro
          on inp.hkdzproviceid = hkzzpro.provinceid --户口住址的省
        left join s_city hkzzcity
          on inp.hkzdcityid = hkzzcity.cityid --户口住址的市
        left join s_district hkzzdis
          on inp.hkzddistrictid = hkzzdis.districtid; --户口住址的县
  
  END;

  PROCEDURE usp_GetInpatientByNo(v_noofinpat varchar2 default '',
                                 o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      select inp.*,
             pay.name             payname,
             job.name             jobname,
             nation.name          nationame,
             nationality.name     nationaltyname,
             relationship.name    relationshipname,
             csdpro.provincename  csd_provincename,
             csdcity.cityname     csd_cityname,
             csddis.districtname  csd_districtname,
             xzzpro.provincename  xzz_provincename,
             xzzcity.cityname     xzz_cityname,
             xzzdis.districtname  xzz_districtname,
             hkzzpro.provincename hkdz_provincename,
             hkzzcity.cityname    hkdz_cityname,
             hkzzdis.districtname hkdz_districtname,
             jgpro.provincename   jg_provincename,
             jgcity.cityname      jg_cityname,
             dia.name             outdiagname, -- 门诊诊断
             u1.name              CHIEFNAME,
             u2.name              attendname,
             u3.name              RESIDENTNAME
        from inpatient inp
        left join dictionary_detail pay
          on pay.detailid = inp.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
          on job.detailid = inp.jobid
         and job.categoryid = '41'
        left join dictionary_detail nation
          on nation.detailid = inp.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = inp.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = inp.relationship
         and relationship.categoryid = '44'
        left join diagnosis dia
          on dia.icd = inp.clinicdiagnosis
        left join users u1
          on u1.id = inp.chief
        left join users u2
          on u2.id = inp.attend
        left join users u3
          on u3.id = inp.resident
      ---省，市，县的名称从Inpatient表里去除，取名称，进行链表查询 add by ywk 2012年5月17日10:58:03
        left join s_province csdpro
          on inp.provinceid = csdpro.provinceid --出生地的省
        left join s_city csdcity
          on inp.countyid = csdcity.cityid --出生地的市
        left join s_district csddis
          on inp.districtid = csddis.districtid --出生地的县
      
        left join s_province jgpro
          on inp.nativeplace_p = jgpro.provinceid --籍贯的省
        left join s_city jgcity
          on inp.nativeplace_c = jgcity.cityid --籍贯的市
      
        left join s_province xzzpro
          on inp.xzzproviceid = xzzpro.provinceid --现住址的省
        left join s_city xzzcity
          on inp.xzzcityid = xzzcity.cityid --现住址的市
        left join s_district xzzdis
          on inp.xzzdistrictid = xzzdis.districtid --现住址的县
      
        left join s_province hkzzpro
          on inp.hkdzproviceid = hkzzpro.provinceid --户口住址的省
        left join s_city hkzzcity
          on inp.hkzdcityid = hkzzcity.cityid --户口住址的市
        left join s_district hkzzdis
          on inp.hkzddistrictid = hkzzdis.districtid --户口住址的县
       where inp.noofinpat = v_noofinpat;
  end;

  /*
  * 维护病案首页的费用信息
  add by ywk 2012年10月16日 19:29:53
  */
  PROCEDURE usp_editiem_mainpage_feeinfo(v_edittype        varchar2 default '',
                                         v_IEM_MAINPAGE_NO varchar2 default '', ---- '病案首页标识';
                                         v_TotalFee        varchar2 default '', ---- 总费用;
                                         v_OwnerFee        varchar2 default '', ---- '自付金额
                                         v_YbMedServFee    varchar2 default '', ---- 一般医疗服务费
                                         v_YbMedOperFee    varchar2 default '', ---- 一般治疗操作费
                                         v_NurseFee        varchar2 default '', ----护理费
                                         v_OtherInfo       varchar2 default '', ---- 综合类 其他费用
                                         v_BLZDFee         varchar2 default '', ---- 诊断类 病理诊断费
                                         v_SYSZDFee        varchar2 default '', ---- 实验室诊断费
                                         v_YXXZDFee        varchar2 default '', ----  诊断类 影像学诊断费
                                         v_LCZDItemFee     varchar2 default '', ----  诊断类 临床诊断项目费
                                         v_FSSZLItemFee    varchar2 default '', ----  非手术治疗项目费
                                         v_LCWLZLFee       varchar2 default '', ---- 治疗类 临床物理治疗费
                                         v_OperMedFee      varchar2 default '', ----治疗类 手术治疗费
                                         v_KFFee           varchar2 default '', ----康复类 康复费
                                         v_ZYZLFee         varchar2 default '', ----中医类 中医治疗费
                                         v_XYMedFee        varchar2 default '', ---西药类 西药费
                                         v_KJYWFee         varchar2 default '', ---西药类 抗菌药物费用
                                         v_ZCYFFee         varchar2 default '', ---中药类 中成药费
                                         v_ZCaoYFFee       varchar2 default '', ---中药类 中草药费
                                         v_BloodFee        varchar2 default '', ---血液和血液制品类 血费
                                         v_BDBLZPFFee      varchar2 default '', ---血液和血液制品类 白蛋白类制品费
                                         v_QDBLZPFFee      varchar2 default '', ---球蛋白类制品费
                                         v_NXYZLZPFFee     varchar2 default '', ---血液和血液制品类 凝血因子类制品费
                                         v_XBYZLZPFFee     varchar2 default '', ---细胞因子类制品费
                                         v_JCYYCXYYCLFFee  varchar2 default '', -- 检查用一次性医用材料费
                                         v_ZLYYCXYYCLFFee  varchar2 default '', -- /耗材类 治疗用一次性医用材料费
                                         v_SSYYCXYYCLFFee  varchar2 default '', -- 材类 手术用一次性医用材料费
                                         v_QTFee           varchar2 default '', -- 其他类：（24）其他费        
                                         v_Memo1           varchar2 default '', -- 预留字段   1    
                                         v_Memo2           varchar2 default '', -- 预留字段    2  
                                         v_Memo3           varchar2 default '', -- 预留字段     3     
                                            v_MaZuiFee           varchar2 default '', -- 麻醉费
                                         v_ShouShuFee           varchar2 default ''-- 手术费 
                                         ) as
   p_count integer default 0;
 
  begin
     IF v_edittype = '1' THEN
  SELECT NVL(MAX(ID), 0) + 1 into p_count FROM Iem_MainPage_FeeInfo;


    
      --新增病案首页基本信息
      insert into Iem_MainPage_FeeInfo(ID,IEM_MAINPAGE_NO,TotalFee,OwnerFee,YbMedServFee,
      YbMedOperFee,NurseFee,OtherInfo,BLZDFee,SYSZDFee,YXXZDFee,LCZDItemFee,FSSZLItemFee,LCWLZLFee,OperMedFee,KFFee,
      ZYZLFee,XYMedFee,KJYWFee,ZCYFFee,ZCaoYFFee,BloodFee,BDBLZPFFee,QDBLZPFFee,NXYZLZPFFee,XBYZLZPFFee,JCYYCXYYCLFFee,Zlyycxyyclffee
      ,SSYYCXYYCLFFee,QTFee,MemoFee1,MemoFee2,MemoFee3,valid,Mazuifee,shoushufee)
      values
        (p_count, ---- '病案首页标识';
        V_IEM_MAINPAGE_NO,V_TotalFee,V_OwnerFee,V_YbMedServFee,
      V_YbMedOperFee,V_NurseFee,V_OtherInfo,V_BLZDFee,V_SYSZDFee,V_YXXZDFee,V_LCZDItemFee,V_FSSZLItemFee,V_LCWLZLFee,V_OperMedFee,V_KFFee,
      V_ZYZLFee,V_XYMedFee,V_KJYWFee,V_ZCYFFee,V_ZCaoYFFee,V_BloodFee,V_BDBLZPFFee,V_QDBLZPFFee,V_NXYZLZPFFee,V_XBYZLZPFFee,V_JCYYCXYYCLFFee,V_Zlyycxyyclffee
      ,V_SSYYCXYYCLFFee,V_QTFee,V_Memo1,V_Memo2,V_Memo3,1,V_MaZuifee,V_shoushufee
         );
    
      ---修改病案首页基本信息
    ELSIF v_edittype = '2' THEN
    
      update Iem_MainPage_FeeInfo
      set TotalFee=V_TotalFee,
      OwnerFee=v_OwnerFee,
      YbMedServFee=V_YbMedServFee,
      YbMedOperFee=V_YbMedOperFee,NurseFee=V_NurseFee,OtherInfo=V_OtherInfo,
      BLZDFee=V_BLZDFee,SYSZDFee=V_SYSZDFee,YXXZDFee=V_YXXZDFee,LCZDItemFee=V_LCZDItemFee,FSSZLItemFee=V_FSSZLItemFee,
      LCWLZLFee=V_LCWLZLFee,OperMedFee=V_OperMedFee,KFFee=V_KFFee,
      ZYZLFee=V_ZYZLFee,XYMedFee=V_XYMedFee,KJYWFee=V_KJYWFee,ZCYFFee=V_ZCYFFee,
      ZCaoYFFee=V_ZCaoYFFee,BloodFee=V_BloodFee,BDBLZPFFee=V_BDBLZPFFee,QDBLZPFFee=V_QDBLZPFFee,NXYZLZPFFee=V_NXYZLZPFFee,
      XBYZLZPFFee=V_XBYZLZPFFee,JCYYCXYYCLFFee=V_JCYYCXYYCLFFee,Zlyycxyyclffee=V_Zlyycxyyclffee
      ,SSYYCXYYCLFFee=V_SSYYCXYYCLFFee,QTFee=V_QTFee,MemoFee1=V_Memo1,MemoFee2=V_Memo2,MemoFee3=V_Memo3,MaZuiFee=V_MaZuifee,ShouShuFee=v_ShouShuFee
      where IEM_MAINPAGE_NO=V_IEM_MAINPAGE_NO;
        
   
    end if;
  end;
  
  procedure usp_operiem_mainpage_qc
  (
            v_OperType         varchar2 default '0',
            v_id               varchar2 default '0',
            v_tabletype        varchar2 default '0',
            v_fields           varchar2 default '',
            v_fieldsvalue      varchar2 default '',
            v_conditiontabletype         varchar2 default '',
            v_conditionfields            varchar2 default '',
            v_conditionfieldsvalue       varchar2 default '',
            v_REDUCTSCORE                varchar2 default '0',
            v_REDUCTREASON               varchar2 default '',
            v_VALIDE                     varchar2 default '0',
            o_result                     OUT empcurtyp
            
  )as
  p_id varchar2(16);
  begin
  open o_result for
  select V_ID from dual;
  ---查询
  IF v_OperType = '0' THEN
     open o_result for
     select qc.id,
         (case qc.tabletype when '0' then '基本信息表'
                            when '1' then '诊断表'
                            when '2' then '手术表'
                            when '3' then '婴儿表'
                            when '4' then '病人表'
                            end) tabletype,
         qc.fields,
         qc.fieldsvalue,
         (case qc.conditiontabletype 
                            when '0' then '基本信息表'
                            when '1' then '诊断表'
                            when '2' then '手术表'
                            when '3' then '婴儿表'
                            when '4' then '病人表'
                            end) conditiontabletype,
         qc.conditionfields,
         qc.conditionfieldsvalue,
         qc.reductscore,
         qc.reductreason,
         (case qc.valide when '0' then '否'
                         when '1' then '是'
                         end)valide
      from iem_mainpage_qc qc;
  ---新增
  ELSIF v_OperType = '1' THEN
  insert into iem_mainpage_qc (ID,TABLETYPE,FIELDS,FIELDSVALUE,CONDITIONTABLETYPE,CONDITIONFIELDS,CONDITIONFIELDSVALUE,REDUCTSCORE,REDUCTREASON,VALIDE)
  values
  (seq_emr_configpoint.NEXTVAL,v_tabletype,v_fields,v_fieldsvalue,v_conditiontabletype,v_conditionfields,v_conditionfieldsvalue,v_REDUCTSCORE,v_REDUCTREASON,v_VALIDE);
  ---修改
  ELSIF v_OperType = '2' THEN
  update iem_mainpage_qc set TABLETYPE = v_tabletype, FIELDS = v_fields, FIELDSVALUE = v_fieldsvalue, CONDITIONTABLETYPE = v_conditiontabletype,
  CONDITIONFIELDS = v_conditionfields,CONDITIONFIELDSVALUE = v_conditionfieldsvalue,REDUCTSCORE = v_REDUCTSCORE,REDUCTREASON = v_REDUCTREASON,
  VALIDE = v_VALIDE where id = v_id;
  ---删除
  ELSIF v_OperType = '3' THEN
  delete from iem_mainpage_qc where id = v_id;
  end if;
  end;
END;
/

prompt
prompt Creating package body IEM_MAIN_PAGE_SX
prompt ======================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.iem_main_page_sx IS

  /*
  * 插入病案首页中 产妇婴儿信息
  */
  PROCEDURE usp_insert_iem_main_ObsBaby(v_iem_mainpage_no NUMERIC,
                                        v_TC              VARCHAR, --胎次
                                        v_CC              VARCHAR, -- 产次
                                        v_TB              VARCHAR, -- 胎别
                                        v_CFHYPLD         VARCHAR, --产妇会阴破裂度
                                        v_MIDWIFERY       VARCHAR, --接产者
                                        v_SEX             VARCHAR, --性别
                                        v_APJ             VARCHAR, -- 阿帕加评加
                                        v_HEIGH           VARCHAR, --身长
                                        v_WEIGHT          VARCHAR, --体重
                                        v_CCQK            VARCHAR, --产出情况
                                        v_BITHDAY         VARCHAR, --出生时间
                                        v_FMFS            VARCHAR, --     分娩方式
                                        v_CYQK            VARCHAR,
                                        v_create_user     VARCHAR) as
  begin
    insert into IEM_MAINPAGE_OBSTETRICSBABY
      (IEM_MAINPAGE_OBSBABYID,
       IEM_MAINPAGE_NO,
       TC, --胎次
       CC, -- 产次
       TB, -- 胎别
       CFHYPLD, --产妇会阴破裂度
       MIDWIFERY, --接产者
       SEX, --性别
       APJ, -- 阿帕加评加
       HEIGH, --身长
       WEIGHT, --体重
       CCQK, --产出情况
       BITHDAY, --出生时间
       FMFS, --      分娩方式
       CYQK, --出院情况
       create_user,
       create_time)
    values
      (SEQ_IEM_MAINPAGE_OBSBABY_ID.Nextval,
       v_IEM_MAINPAGE_NO,
       v_TC, --胎次
       v_CC, -- 产次
       v_TB, -- 胎别
       v_CFHYPLD, --产妇会阴破裂度
       v_MIDWIFERY, --接产者
       v_SEX, --性别
       v_APJ, -- 阿帕加评加
       v_HEIGH, --身长
       v_WEIGHT, --体重
       v_CCQK, --产出情况
       v_BITHDAY, --出生时间
       v_FMFS, --      分娩方式
       v_CYQK,
       v_create_user, -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'));
  end;

  /**(*********编辑病案首页基本信息********************************************/
  PROCEDURE usp_Edit_Iem_BasicInfo_sx(v_edittype        varchar2 default '',
                                      v_IEM_MAINPAGE_NO varchar2 default '', ---- '病案首页标识';
                                      v_PATNOOFHIS      varchar2 default '', ---- '病案号';
                                      v_NOOFINPAT       varchar2 default '', ---- '病人首页序号';
                                      v_PAYID           varchar2 default '', ---- '医疗付款方式ID';
                                      v_SOCIALCARE      varchar2 default '', ---- '社保卡号';
                                      
                                      v_INCOUNT varchar2 default '', ---- '入院次数';
                                      v_NAME    varchar2 default '', ---- '患者姓名';
                                      v_SEXID   varchar2 default '', ---- '性别';
                                      v_BIRTH   varchar2 default '', ---- '出生';
                                      v_MARITAL varchar2 default '', ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
                                      
                                      v_JOBID         varchar2 default '', ---- '职业';
                                      v_NATIONALITYID varchar2 default '', ---- '国籍ID';
                                      v_NATIONID      varchar2 default '', --民族
                                      v_IDNO          varchar2 default '', ---- '身份证号码';
                                      v_ORGANIZATION  varchar2 default '', ---- '工作单位';
                                      v_OFFICEPLACE   varchar2 default '', ---- '工作单位地址';
                                      
                                      v_OFFICETEL      varchar2 default '', ---- '工作单位电话';
                                      v_OFFICEPOST     varchar2 default '', ---- '工作单位邮编';
                                      v_CONTACTPERSON  varchar2 default '', ---- '联系人姓名';
                                      v_RELATIONSHIP   varchar2 default '', ---- '与联系人关系';
                                      v_CONTACTADDRESS varchar2 default '', ---- '联系人地址';
                                      
                                      v_CONTACTTEL varchar2 default '', ---- '联系人电话';
                                      v_ADMITDATE  varchar2 default '', ---- '入院时间';
                                      v_ADMITDEPT  varchar2 default '', ---- '入院科室';
                                      v_ADMITWARD  varchar2 default '', ---- '入院病区';
                                      v_TRANS_DATE varchar2 default '', ---- '转院时间';
                                      
                                      v_TRANS_ADMITDEPT varchar2 default '', ---- '转院科别';
                                      v_TRANS_ADMITWARD varchar2 default '', ---- '转院病区';
                                      v_OUTWARDDATE     varchar2 default '', ---- '出院时间';
                                      v_OUTHOSDEPT      varchar2 default '', ---- '出院科室';
                                      v_OUTHOSWARD      varchar2 default '', ---- '出院病区';
                                      
                                      v_ACTUALDAYS               varchar2 default '', ---- '实际住院天数';
                                      v_PATHOLOGY_DIAGNOSIS_NAME varchar2 default '', ---- '病理诊断名称';
                                      v_PATHOLOGY_OBSERVATION_SN varchar2 default '', ---- '病理检查号 ';
                                      v_ALLERGIC_DRUG            varchar2 default '', ---- '过敏药物';
                                      v_SECTION_DIRECTOR         varchar2 default '', ---- '科主任';
                                      
                                      v_DIRECTOR               varchar2 default '', ---- '主（副主）任医师';
                                      v_VS_EMPLOYEE_CODE       varchar2 default '', ---- '主治医师';
                                      v_RESIDENT_EMPLOYEE_CODE varchar2 default '', ---- '住院医师';
                                      v_REFRESH_EMPLOYEE_CODE  varchar2 default '', ---- '进修医师';
                                      v_DUTY_NURSE             varchar2 default '', ---- '责任护士';
                                      
                                      v_INTERNE                varchar2 default '', ---- '实习医师';
                                      v_CODING_USER            varchar2 default '', ---- '编码员';
                                      v_MEDICAL_QUALITY_ID     varchar2 default '', ---- '病案质量';
                                      v_QUALITY_CONTROL_DOCTOR varchar2 default '', ---- '质控医师';
                                      v_QUALITY_CONTROL_NURSE  varchar2 default '', ---- '质控护士';
                                      
                                      v_QUALITY_CONTROL_DATE varchar2 default '', ---- '质控时间';
                                      v_XAY_SN               varchar2 default '', ---- 'x线检查号';
                                      v_CT_SN                varchar2 default '', ---- 'CT检查号';
                                      v_MRI_SN               varchar2 default '', ---- 'mri检查号';
                                      v_DSA_SN               varchar2 default '', ---- 'Dsa检查号';
                                      
                                      v_BLOODTYPE      varchar2 default '', ---- '血型';
                                      v_RH             varchar2 default '', ---- 'Rh';
                                      v_IS_COMPLETED   varchar2 default '', ---- '完成否 y/n ';
                                      v_COMPLETED_TIME varchar2 default '', ---- '完成时间';
                                      v_VALIDE         varchar2 default '1', ---- '作废否 1/0';
                                      
                                      v_CREATE_USER   varchar2 default '', ---- '创建此记录者';
                                      v_CREATE_TIME   varchar2 default '', ---- '创建时间';
                                      v_MODIFIED_USER varchar2 default '', ---- '修改此记录者';
                                      v_MODIFIED_TIME varchar2 default '', ---- '修改时间';
                                      v_ZYMOSIS       varchar2 default '', ---- '医院传染病';
                                      
                                      v_HURT_TOXICOSIS_ELE_ID   varchar2 default '', ---- '损伤、中毒的外部因素';
                                      v_HURT_TOXICOSIS_ELE_Name varchar2 default '', ---- '损伤、中毒的外部因素';
                                      v_ZYMOSISSTATE            varchar2 default '', ---- '医院传染病状态';
                                      v_PATHOLOGY_DIAGNOSIS_ID  varchar2 default '', ---- '病理诊断编号';
                                      v_MONTHAGE                varchar2 default '', ---- '（年龄不足1周岁的） 年龄(月)';
                                      v_WEIGHT                  varchar2 default '', ---- '新生儿出生体重(克)';
                                      
                                      v_INWEIGHT         varchar2 default '', ---- '新生儿入院体重(克)';
                                      v_INHOSTYPE        varchar2 default '', ---- '入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他';
                                      v_OUTHOSTYPE       varchar2 default '', ---- '离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他';
                                      v_RECEIVEHOSPITAL  varchar2 default '', ---- '2.医嘱转院，拟接收医疗机构名称：';
                                      v_RECEIVEHOSPITAL2 varchar2 default '', ---- '3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名;
                                      
                                      v_AGAININHOSPITAL       varchar2 default '', ---- '是否有出院31天内再住院计划 □ 1.无  2.有';
                                      v_AGAININHOSPITALREASON varchar2 default '', ---- '出院31天内再住院计划 目的:            ';
                                      v_BEFOREHOSCOMADAY      varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院前    天';
                                      v_BEFOREHOSCOMAHOUR     varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院前     小时';
                                      v_BEFOREHOSCOMAMINUTE   varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院前    分钟';
                                      
                                      v_LATERHOSCOMADAY    varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院后    天';
                                      v_LATERHOSCOMAHOUR   varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院后    小时';
                                      v_LATERHOSCOMAMINUTE varchar2 default '', ---- '颅脑损伤患者昏迷时间： 入院后    分钟';
                                      v_CARDNUMBER         varchar2 default '', ---- '健康卡号';
                                      v_ALLERGIC_FLAG      varchar2 default '', ---- '药物过敏1.无 2.有';
                                      
                                      v_AUTOPSY_FLAG     varchar2 default '', ---- '死亡患者尸检 □ 1.是  2.否';
                                      v_CSD_PROVINCEID   varchar2 default '', ---- '出生地 省';
                                      v_CSD_CITYID       varchar2 default '', ---- '出生地 市';
                                      v_CSD_DISTRICTID   varchar2 default '', ---- '出生地 县';
                                      v_CSD_PROVINCENAME varchar2 default '', ---- '出生地 省名称';
                                      
                                      v_CSD_CITYNAME     varchar2 default '', ---- '出生地 市名称';
                                      v_CSD_DISTRICTNAME varchar2 default '', ---- '出生地 县名称';
                                      v_XZZ_PROVINCEID   varchar2 default '', ---- '现住址 省';
                                      v_XZZ_CITYID       varchar2 default '', ---- '现住址 市';
                                      v_XZZ_DISTRICTID   varchar2 default '', ---- '现住址 县';
                                      
                                      v_XZZ_PROVINCENAME varchar2 default '', ---- '现住址 省名称';
                                      v_XZZ_CITYNAME     varchar2 default '', ---- '现住址 市名称';
                                      v_XZZ_DISTRICTNAME varchar2 default '', ---- '现住址 县名称';
                                      v_XZZ_TEL          varchar2 default '', ---- '现住址 电话';
                                      v_XZZ_POST         varchar2 default '', ---- '现住址 邮编';
                                      
                                      v_HKDZ_PROVINCEID   varchar2 default '', ---- '户口地址 省';
                                      v_HKDZ_CITYID       varchar2 default '', ---- '户口地址 市';
                                      v_HKDZ_DISTRICTID   varchar2 default '', ---- '户口地址 县';
                                      v_HKDZ_PROVINCENAME varchar2 default '', ---- '户口地址 省名称';
                                      v_HKDZ_CITYNAME     varchar2 default '', ---- '户口地址 市名称';
                                      
                                      v_HKDZ_DISTRICTNAME varchar2 default '', ---- '户口地址 县名称';
                                      v_HKDZ_POST         varchar2 default '', ---- '户口所在地邮编';
                                      v_JG_PROVINCEID     varchar2 default '', ---- '籍贯 省名称';
                                      v_JG_CITYID         varchar2 default '', ---- '籍贯 市名称';
                                      v_JG_PROVINCENAME   varchar2 default '', ---- '籍贯 省名称';
                                      v_JG_CITYNAME       varchar2 default '', ---- '籍贯 市名称'
                                      v_Age               varchar2 default '',
                                      
                                      v_CURE_TYPE   VARCHAR2 default '', ----  Y    治疗类别 □ 1.中医（ 1.1 中医   1.2民族医）    2.中西医     3.西医
                                      v_MZZYZD_NAME VARCHAR2 default '', ---- Y   门（急）诊诊断（中医诊断）
                                      v_MZZYZD_CODE VARCHAR2 default '', ---- Y   门（急）诊诊断（中医诊断） 编码
                                      v_MZXYZD_NAME VARCHAR2 default '', ---- Y   门（急）诊诊断（西医诊断）
                                      v_MZXYZD_CODE VARCHAR2 default '', ---- Y   门（急）诊诊断（西医诊断） 编码
                                      v_SSLCLJ      VARCHAR2 default '', ---- Y   实施临床路径：□ 1. 中医  2. 西医  3 否
                                      v_ZYZJ        VARCHAR2 default '', ---- Y   使用医疗机构中药制剂：□ 1.是  2. 否
                                      
                                      v_ZYZLSB       VARCHAR2 default '', ---- Y   使用中医诊疗设备：□  1.是 2. 否
                                      v_ZYZLJS       VARCHAR2 default '', ---- Y   使用中医诊疗技术：□ 1. 是  2. 否
                                      v_BZSH         VARCHAR2 default '', ---- Y   辨证施护：□ 1.是  2. 否
                                      v_outHosStatus VARCHAR2, ---出院状况
                                      v_JBYNZZ       VARCHAR2,
                                      v_MZYCY        VARCHAR2,
                                      v_InAndOutHos  VARCHAR2,
                                      v_LCYBL        VARCHAR2,
                                      v_FSYBL        VARCHAR2,
                                      v_qJCount      VARCHAR2,
                                      v_successCount VARCHAR2,
                                      v_InPatLY      VARCHAR2,
                                      v_asaScore     VARCHAR2,
                                      o_result       OUT empcurtyp) as
    mynoofclinic varchar2(50);
  
  begin
    if v_IDNO = '不详' then
      mynoofclinic := '';
    else
      mynoofclinic := v_IDNO;
    end if;
  
    IF v_edittype = '1' THEN
    
      --新增病案首页基本信息
      insert into iem_mainpage_basicinfo_sx
        (IEM_MAINPAGE_NO, ---- '病案首页标识';
         PATNOOFHIS, ---- '病案号';
         NOOFINPAT, ---- '病人首页序号';
         PAYID, ---- '医疗付款方式ID';
         SOCIALCARE, ---- '社保卡号';
         
         INCOUNT, ---- '入院次数';
         NAME, ---- '患者姓名';
         SEXID, ---- '性别';
         BIRTH, ---- '出生';
         MARITAL, ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
         
         JOBID, ---- '职业';
         NATIONALITYID, ---- '国籍ID';
         NATIONID, --民族
         IDNO, ---- '身份证号码';
         ORGANIZATION, ---- '工作单位';
         OFFICEPLACE, ---- '工作单位地址';
         
         OFFICETEL, ---- '工作单位电话';
         OFFICEPOST, ---- '工作单位邮编';
         CONTACTPERSON, ---- '联系人姓名';
         RELATIONSHIP, ---- '与联系人关系';
         CONTACTADDRESS, ---- '联系人地址';
         
         CONTACTTEL, ---- '联系人电话';
         ADMITDATE, ---- '入院时间';
         ADMITDEPT, ---- '入院科室';
         ADMITWARD, ---- '入院病区';
         TRANS_DATE, ---- '转院时间';
         
         TRANS_ADMITDEPT, ---- '转院科别';
         TRANS_ADMITWARD, ---- '转院病区';
         OUTWARDDATE, ---- '出院时间';
         OUTHOSDEPT, ---- '出院科室';
         OUTHOSWARD, ---- '出院病区';
         
         ACTUALDAYS, ---- '实际住院天数';
         PATHOLOGY_DIAGNOSIS_NAME, ---- '病理诊断名称';
         PATHOLOGY_OBSERVATION_SN, ---- '病理检查号 ';
         ALLERGIC_DRUG, ---- '过敏药物';
         SECTION_DIRECTOR, ---- '科主任';
         
         DIRECTOR, ---- '主（副主）任医师';
         VS_EMPLOYEE_CODE, ---- '主治医师';
         RESIDENT_EMPLOYEE_CODE, ---- '住院医师';
         REFRESH_EMPLOYEE_CODE, ---- '进修医师';
         DUTY_NURSE, ---- '责任护士';
         
         INTERNE, ---- '实习医师';
         CODING_USER, ---- '编码员';
         MEDICAL_QUALITY_ID, ---- '病案质量';
         QUALITY_CONTROL_DOCTOR, ---- '质控医师';
         QUALITY_CONTROL_NURSE, ---- '质控护士';
         
         QUALITY_CONTROL_DATE, ---- '质控时间';
         XAY_SN, ---- 'x线检查号';
         CT_SN, ---- 'CT检查号';
         MRI_SN, ---- 'mri检查号';
         DSA_SN, ---- 'Dsa检查号';
         
         BLOODTYPE, ---- '血型';
         RH, ---- 'Rh';
         IS_COMPLETED, ---- '完成否 y/n ';
         COMPLETED_TIME, ---- '完成时间';
         VALIDE, ---- '作废否 1/0';
         
         CREATE_USER, ---- '创建此记录者';
         CREATE_TIME, ---- '创建时间';
         MODIFIED_USER, ---- '修改此记录者';
         MODIFIED_TIME, ---- '修改时间';
         ZYMOSIS, ---- '医院传染病';
         
         HURT_TOXICOSIS_ELE_ID, ---- '损伤、中毒的外部因素';
         HURT_TOXICOSIS_ELE_Name,
         ZYMOSISSTATE, ---- '医院传染病状态';
         PATHOLOGY_DIAGNOSIS_ID, ---- '病理诊断编号';
         MONTHAGE, ---- '（年龄不足1周岁的） 年龄(月)';
         WEIGHT, ---- '新生儿出生体重(克)';
         
         INWEIGHT, ---- '新生儿入院体重(克)';
         INHOSTYPE, ---- '入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他';
         OUTHOSTYPE, ---- '离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他';
         RECEIVEHOSPITAL, ---- '2.医嘱转院，拟接收医疗机构名称：';
         RECEIVEHOSPITAL2, ---- '3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名;
         
         AGAININHOSPITAL, ---- '是否有出院31天内再住院计划 □ 1.无  2.有';
         AGAININHOSPITALREASON, ---- '出院31天内再住院计划 目的:            ';
         BEFOREHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院前    天';
         BEFOREHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院前     小时';
         BEFOREHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院前    分钟';
         
         LATERHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院后    天';
         LATERHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院后    小时';
         LATERHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院后    分钟';
         CARDNUMBER, ---- '健康卡号';
         ALLERGIC_FLAG, ---- '药物过敏1.无 2.有';
         
         AUTOPSY_FLAG, ---- '死亡患者尸检 □ 1.是  2.否';
         CSD_PROVINCEID, ---- '出生地 省';
         CSD_CITYID, ---- '出生地 市';
         CSD_DISTRICTID, ---- '出生地 县';
         CSD_PROVINCENAME, ---- '出生地 省名称';
         
         CSD_CITYNAME, ---- '出生地 市名称';
         CSD_DISTRICTNAME, ---- '出生地 县名称';
         XZZ_PROVINCEID, ---- '现住址 省';
         XZZ_CITYID, ---- '现住址 市';
         XZZ_DISTRICTID, ---- '现住址 县';
         
         XZZ_PROVINCENAME, ---- '现住址 省名称';
         XZZ_CITYNAME, ---- '现住址 市名称';
         XZZ_DISTRICTNAME, ---- '现住址 县名称';
         XZZ_TEL, ---- '现住址 电话';
         XZZ_POST, ---- '现住址 邮编';
         
         HKDZ_PROVINCEID, ---- '户口地址 省';
         HKDZ_CITYID, ---- '户口地址 市';
         HKDZ_DISTRICTID, ---- '户口地址 县';
         HKDZ_PROVINCENAME, ---- '户口地址 省名称';
         HKDZ_CITYNAME, ---- '户口地址 市名称';
         
         HKDZ_DISTRICTNAME, ---- '户口地址 县名称';
         HKDZ_POST, ---- '户口所在地邮编';
         JG_PROVINCEID, ---- '籍贯 省名称';
         JG_CITYID, ---- '籍贯 市名称';
         JG_PROVINCENAME, ---- '籍贯 省名称';
         JG_CITYNAME, ---- '籍贯 市名称';
         age,
         
         CURE_TYPE, ---- 治疗类别 □ 1.中医（ 1.1 中医   1.2民族医）    2.中西医     3.西医
         MZZYZD_NAME, ---- 门（急）诊诊断（中医诊断）
         MZZYZD_CODE, ---- 门（急）诊诊断（中医诊断） 编码
         MZXYZD_NAME, ---- 门（急）诊诊断（西医诊断）
         MZXYZD_CODE, ---- 门（急）诊诊断（西医诊断） 编码
         SSLCLJ, ---- 实施临床路径：□ 1. 中医  2. 西医  3 否
         ZYZJ, ---- 使用医疗机构中药制剂：□ 1.是  2. 否
         ZYZLSB, ---- 使用中医诊疗设备：□  1.是 2. 否
         ZYZLJS, ---- 使用中医诊疗技术：□ 1. 是  2. 否
         BZSH, ---- 辨证施护：□ 1.是  2. 否
         outHosStatus, ----病人出院状况 Add by xlb 2013-07-03
         JBYNZZ, ----疾病是否疑难杂症 Add by xlb 2013-07-03
         MZYCY, --- 门诊与出院 Add by xlb 2013-07-03
         InAndOutHos, --入院与出院
         LCYBL, ---临床与病理
         FSYBL, ---放射与病理
         qJCount, ---抢救次数
         successCount, ---成功次数
         InPatLY, ----病人来源
         asaScore --ASA分级评分
         )
      values
        (seq_iem_mainpage_basicinfo_id.NEXTVAL, ---- '病案首页标识';
         v_PATNOOFHIS, ---- '病案号';
         v_NOOFINPAT, ---- '病人首页序号';
         v_PAYID, ---- '医疗付款方式ID';
         v_SOCIALCARE, ---- '社保卡号';
         v_INCOUNT, ---- '入院次数';
         v_NAME, ---- '患者姓名';
         v_SEXID, ---- '性别';
         v_BIRTH, ---- '出生';
         v_MARITAL, ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
         v_JOBID, ---- '职业';
         v_NATIONALITYID, ---- '国籍ID';
         v_NATIONID, --民族
         mynoofclinic, ---- '身份证号码';
         v_ORGANIZATION, ---- '工作单位';
         v_OFFICEPLACE, ---- '工作单位地址';
         v_OFFICETEL, ---- '工作单位电话';
         v_OFFICEPOST, ---- '工作单位邮编';
         v_CONTACTPERSON, ---- '联系人姓名';
         v_RELATIONSHIP, ---- '与联系人关系';
         v_CONTACTADDRESS, ---- '联系人地址';
         v_CONTACTTEL, ---- '联系人电话';
         v_ADMITDATE, ---- '入院时间';
         v_ADMITDEPT, ---- '入院科室';
         v_ADMITWARD, ---- '入院病区';
         v_TRANS_DATE, ---- '转院时间';
         v_TRANS_ADMITDEPT, ---- '转院科别';
         v_TRANS_ADMITWARD, ---- '转院病区';
         v_OUTWARDDATE, ---- '出院时间';
         v_OUTHOSDEPT, ---- '出院科室';
         v_OUTHOSWARD, ---- '出院病区';
         v_ACTUALDAYS, ---- '实际住院天数';
         v_PATHOLOGY_DIAGNOSIS_NAME, ---- '病理诊断名称';
         v_PATHOLOGY_OBSERVATION_SN, ---- '病理检查号 ';
         v_ALLERGIC_DRUG, ---- '过敏药物';
         v_SECTION_DIRECTOR, ---- '科主任';
         v_DIRECTOR, ---- '主（副主）任医师';
         v_VS_EMPLOYEE_CODE, ---- '主治医师';
         v_RESIDENT_EMPLOYEE_CODE, ---- '住院医师';
         v_REFRESH_EMPLOYEE_CODE, ---- '进修医师';
         v_DUTY_NURSE, ---- '责任护士';
         v_INTERNE, ---- '实习医师';
         v_CODING_USER, ---- '编码员';
         v_MEDICAL_QUALITY_ID, ---- '病案质量';
         v_QUALITY_CONTROL_DOCTOR, ---- '质控医师';
         v_QUALITY_CONTROL_NURSE, ---- '质控护士';
         v_QUALITY_CONTROL_DATE, ---- '质控时间';
         v_XAY_SN, ---- 'x线检查号';
         v_CT_SN, ---- 'CT检查号';
         v_MRI_SN, ---- 'mri检查号';
         v_DSA_SN, ---- 'Dsa检查号';
         v_BLOODTYPE, ---- '血型';
         v_RH, ---- 'Rh';
         v_IS_COMPLETED, ---- '完成否 y/n ';
         v_COMPLETED_TIME, ---- '完成时间';
         v_VALIDE, ---- '作废否 1/0';
         v_CREATE_USER, ---- '创建此记录者';
         TO_CHAR(SYSDATE, 'yyyy-mm-dd hh24:mi:ss'), ---- '创建时间';
         v_MODIFIED_USER, ---- '修改此记录者';
         v_MODIFIED_TIME, ---- '修改时间';
         v_ZYMOSIS, ---- '医院传染病';
         v_HURT_TOXICOSIS_ELE_ID, ---- '损伤、中毒的外部因素';
         v_HURT_TOXICOSIS_ELE_Name, ---- '损伤、中毒的外部因素';
         v_ZYMOSISSTATE, ---- '医院传染病状态';
         v_PATHOLOGY_DIAGNOSIS_ID, ---- '病理诊断编号';
         v_MONTHAGE, ---- '（年龄不足1周岁的） 年龄(月)';
         v_WEIGHT, ---- '新生儿出生体重(克)';
         v_INWEIGHT, ---- '新生儿入院体重(克)';
         v_INHOSTYPE, ---- '入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他';
         v_OUTHOSTYPE, ---- '离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他';
         v_RECEIVEHOSPITAL, ---- '2.医嘱转院，拟接收医疗机构名称：';
         v_RECEIVEHOSPITAL2, ---- '3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名;
         v_AGAININHOSPITAL, ---- '是否有出院31天内再住院计划 □ 1.无  2.有';
         v_AGAININHOSPITALREASON, ---- '出院31天内再住院计划 目的:            ';
         v_BEFOREHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院前    天';
         v_BEFOREHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院前     小时';
         v_BEFOREHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院前    分钟';
         v_LATERHOSCOMADAY, ---- '颅脑损伤患者昏迷时间： 入院后    天';
         v_LATERHOSCOMAHOUR, ---- '颅脑损伤患者昏迷时间： 入院后    小时';
         v_LATERHOSCOMAMINUTE, ---- '颅脑损伤患者昏迷时间： 入院后    分钟';
         v_CARDNUMBER, ---- '健康卡号';
         v_ALLERGIC_FLAG, ---- '药物过敏1.无 2.有';
         v_AUTOPSY_FLAG, ---- '死亡患者尸检 □ 1.是  2.否';
         v_CSD_PROVINCEID, ---- '出生地 省';
         v_CSD_CITYID, ---- '出生地 市';
         v_CSD_DISTRICTID, ---- '出生地 县';
         v_CSD_PROVINCENAME, ---- '出生地 省名称';
         v_CSD_CITYNAME, ---- '出生地 市名称';
         v_CSD_DISTRICTNAME, ---- '出生地 县名称';
         v_XZZ_PROVINCEID, ---- '现住址 省';
         v_XZZ_CITYID, ---- '现住址 市';
         v_XZZ_DISTRICTID, ---- '现住址 县';
         v_XZZ_PROVINCENAME, ---- '现住址 省名称';
         v_XZZ_CITYNAME, ---- '现住址 市名称';
         v_XZZ_DISTRICTNAME, ---- '现住址 县名称';
         v_XZZ_TEL, ---- '现住址 电话';
         v_XZZ_POST, ---- '现住址 邮编';
         v_HKDZ_PROVINCEID, ---- '户口地址 省';
         v_HKDZ_CITYID, ---- '户口地址 市';
         v_HKDZ_DISTRICTID, ---- '户口地址 县';
         v_HKDZ_PROVINCENAME, ---- '户口地址 省名称';
         v_HKDZ_CITYNAME, ---- '户口地址 市名称';
         v_HKDZ_DISTRICTNAME, ---- '户口地址 县名称';
         v_HKDZ_POST, ---- '户口所在地邮编';
         v_JG_PROVINCEID, ---- '籍贯 省名称';
         v_JG_CITYID, ---- '籍贯 市名称';
         v_JG_PROVINCENAME, ---- '籍贯 省名称';
         v_JG_CITYNAME,
         v_Age,
         
         v_CURE_TYPE, ---- 治疗类别 □ 1.中医（ 1.1 中医   1.2民族医）    2.中西医     3.西医
         v_MZZYZD_NAME, ---- 门（急）诊诊断（中医诊断）
         v_MZZYZD_CODE, ---- 门（急）诊诊断（中医诊断） 编码
         v_MZXYZD_NAME, ---- 门（急）诊诊断（西医诊断）
         v_MZXYZD_CODE, ---- 门（急）诊诊断（西医诊断） 编码
         v_SSLCLJ, ---- 实施临床路径：□ 1. 中医  2. 西医  3 否
         v_ZYZJ, ---- 使用医疗机构中药制剂：□ 1.是  2. 否
         v_ZYZLSB, ---- 使用中医诊疗设备：□  1.是 2. 否
         v_ZYZLJS, ---- 使用中医诊疗技术：□ 1. 是  2. 否
         v_BZSH, ---- 辨证施护：□ 1.是  2. 否
         v_outHosStatus,
         v_JBYNZZ,
         v_MZYCY,
         v_InAndOutHos,
         v_LCYBL,
         v_FSYBL,
         v_qJCount,
         v_successCount,
         v_InPatLY,
         v_asaScore);
    
      open o_result for
        select seq_iem_mainpage_basicinfo_id.currval from dual;
      ---修改病案首页基本信息
    ELSIF v_edittype = '2' THEN
    
      update iem_mainpage_basicinfo_sx
         set PATNOOFHIS               = v_PATNOOFHIS, --病案号
             NOOFINPAT                = v_NOOFINPAT, --病人首页序号
             PAYID                    = v_PAYID, --医疗付款方式ID
             SOCIALCARE               = v_SOCIALCARE, --社保卡号
             INCOUNT                  = v_INCOUNT, --入院次数
             NAME                     = v_NAME, --患者姓名
             SEXID                    = v_SEXID, --性别
             BIRTH                    = v_BIRTH, --出生
             MARITAL                  = v_MARITAL, --婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他
             JOBID                    = v_JOBID, --职业
             NATIONALITYID            = v_NATIONALITYID, --国籍ID
             NATIONID                 = v_NATIONID, --民族
             IDNO                     = mynoofclinic, --身份证号码
             ORGANIZATION             = v_ORGANIZATION, --工作单位
             OFFICEPLACE              = v_OFFICEPLACE, --工作单位地址
             OFFICETEL                = v_OFFICETEL, --工作单位电话
             OFFICEPOST               = v_OFFICEPOST, --工作单位邮编
             CONTACTPERSON            = v_CONTACTPERSON, --联系人姓名
             RELATIONSHIP             = v_RELATIONSHIP, --与联系人关系
             CONTACTADDRESS           = v_CONTACTADDRESS, --联系人地址
             CONTACTTEL               = v_CONTACTTEL, --联系人电话
             ADMITDATE                = v_ADMITDATE, --入院时间
             ADMITDEPT                = v_ADMITDEPT, --入院科室
             ADMITWARD                = v_ADMITWARD, --入院病区
             TRANS_DATE               = v_TRANS_DATE, --转院时间
             TRANS_ADMITDEPT          = v_TRANS_ADMITDEPT, --转院科别
             TRANS_ADMITWARD          = v_TRANS_ADMITWARD, --转院病区
             OUTWARDDATE              = v_OUTWARDDATE, --出院时间
             OUTHOSDEPT               = v_OUTHOSDEPT, --出院科室
             OUTHOSWARD               = v_OUTHOSWARD, --出院病区
             ACTUALDAYS               = v_ACTUALDAYS, --实际住院天数
             PATHOLOGY_DIAGNOSIS_NAME = v_PATHOLOGY_DIAGNOSIS_NAME, --病理诊断名称
             PATHOLOGY_OBSERVATION_SN = v_PATHOLOGY_OBSERVATION_SN, --病理检查号
             ALLERGIC_DRUG            = v_ALLERGIC_DRUG, --过敏药物
             SECTION_DIRECTOR         = v_SECTION_DIRECTOR, --科主任
             DIRECTOR                 = v_DIRECTOR, --主（副主）任医师
             VS_EMPLOYEE_CODE         = v_VS_EMPLOYEE_CODE, --主治医师
             RESIDENT_EMPLOYEE_CODE   = v_RESIDENT_EMPLOYEE_CODE, --住院医师
             REFRESH_EMPLOYEE_CODE    = v_REFRESH_EMPLOYEE_CODE, --进修医师
             DUTY_NURSE               = v_DUTY_NURSE, --责任护士
             INTERNE                  = v_INTERNE, --实习医师
             CODING_USER              = v_CODING_USER, --编码员
             MEDICAL_QUALITY_ID       = v_MEDICAL_QUALITY_ID, --病案质量
             QUALITY_CONTROL_DOCTOR   = v_QUALITY_CONTROL_DOCTOR, --质控医师
             QUALITY_CONTROL_NURSE    = v_QUALITY_CONTROL_NURSE, --质控护士
             QUALITY_CONTROL_DATE     = v_QUALITY_CONTROL_DATE, --质控时间
             XAY_SN                   = v_XAY_SN, --x线检查号
             CT_SN                    = v_CT_SN, --CT检查号
             MRI_SN                   = v_MRI_SN, --mri检查号
             DSA_SN                   = v_DSA_SN, --Dsa检查号
             BLOODTYPE                = v_BLOODTYPE, --血型
             RH                       = v_RH, --Rh
             IS_COMPLETED             = v_IS_COMPLETED, --完成否 y/n
             COMPLETED_TIME           = v_COMPLETED_TIME, --完成时间
             VALIDE                   = v_VALIDE, --作废否 1/0
             /* CREATE_USER              = v_CREATE_USER, --创建此记录者
             CREATE_TIME              = v_CREATE_TIME, --创建时间*/
             MODIFIED_USER           = v_MODIFIED_USER, --修改此记录者
             MODIFIED_TIME           = TO_CHAR(SYSDATE,
                                               'yyyy-mm-dd hh24:mi:ss'), --修改时间
             ZYMOSIS                 = v_ZYMOSIS, --医院传染病
             HURT_TOXICOSIS_ELE_ID   = v_HURT_TOXICOSIS_ELE_ID, --损伤、中毒的外部因素
             HURT_TOXICOSIS_ELE_Name = v_HURT_TOXICOSIS_ELE_Name, --损伤、中毒的外部因素
             ZYMOSISSTATE            = v_ZYMOSISSTATE, --医院传染病状态
             PATHOLOGY_DIAGNOSIS_ID  = v_PATHOLOGY_DIAGNOSIS_ID, --病理诊断编号
             MONTHAGE                = v_MONTHAGE, --（年龄不足1周岁的） 年龄(月)
             WEIGHT                  = v_WEIGHT, --新生儿出生体重(克)
             INWEIGHT                = v_INWEIGHT, --新生儿入院体重(克)
             INHOSTYPE               = v_INHOSTYPE, --入院途径:1.急诊  2.门诊  3.其他医疗机构转入  9.其他
             OUTHOSTYPE              = v_OUTHOSTYPE, --离院方式 □ 1.医嘱离院  2.医嘱转院 3.医嘱转社区卫生服务机构/乡镇卫生院 4.非医嘱离院5.死亡9.其他
             RECEIVEHOSPITAL         = v_RECEIVEHOSPITAL, --2.医嘱转院，拟接收医疗机构名称：
             RECEIVEHOSPITAL2        = v_RECEIVEHOSPITAL2, --3.医嘱转社区卫生服务机构/乡镇卫生院，拟接收医疗机构名称：
             AGAININHOSPITAL         = v_AGAININHOSPITAL, --是否有出院31天内再住院计划 □ 1.无  2.有
             AGAININHOSPITALREASON   = v_AGAININHOSPITALREASON, --出院31天内再住院计划 目的:
             BEFOREHOSCOMADAY        = v_BEFOREHOSCOMADAY, --颅脑损伤患者昏迷时间： 入院前    天
             BEFOREHOSCOMAHOUR       = v_BEFOREHOSCOMAHOUR, --颅脑损伤患者昏迷时间： 入院前     小时
             BEFOREHOSCOMAMINUTE     = v_BEFOREHOSCOMAMINUTE, --颅脑损伤患者昏迷时间： 入院前    分钟
             LATERHOSCOMADAY         = v_LATERHOSCOMADAY, --颅脑损伤患者昏迷时间： 入院后    天
             LATERHOSCOMAHOUR        = v_LATERHOSCOMAHOUR, --颅脑损伤患者昏迷时间： 入院后    小时
             LATERHOSCOMAMINUTE      = v_LATERHOSCOMAMINUTE, --颅脑损伤患者昏迷时间： 入院后    分钟
             CARDNUMBER              = v_CARDNUMBER, --健康卡号
             ALLERGIC_FLAG           = v_ALLERGIC_FLAG, --药物过敏1.无 2.有
             AUTOPSY_FLAG            = v_AUTOPSY_FLAG, --死亡患者尸检 □ 1.是  2.否
             CSD_PROVINCEID          = v_CSD_PROVINCEID, --出生地 省
             CSD_CITYID              = v_CSD_CITYID, --出生地 市
             CSD_DISTRICTID          = v_CSD_DISTRICTID, --出生地 县
             CSD_PROVINCENAME        = v_CSD_PROVINCENAME, --出生地 省名称
             CSD_CITYNAME            = v_CSD_CITYNAME, --出生地 市名称
             CSD_DISTRICTNAME        = v_CSD_DISTRICTNAME, --出生地 县名称
             XZZ_PROVINCEID          = v_XZZ_PROVINCEID, --现住址 省
             XZZ_CITYID              = v_XZZ_CITYID, --现住址 市
             XZZ_DISTRICTID          = v_XZZ_DISTRICTID, --现住址 县
             XZZ_PROVINCENAME        = v_XZZ_PROVINCENAME, --现住址 省名称
             XZZ_CITYNAME            = v_XZZ_CITYNAME, --现住址 市名称
             XZZ_DISTRICTNAME        = v_XZZ_DISTRICTNAME, --现住址 县名称
             XZZ_TEL                 = v_XZZ_TEL, --现住址 电话
             XZZ_POST                = v_XZZ_POST, --现住址 邮编
             HKDZ_PROVINCEID         = v_HKDZ_PROVINCEID, --户口地址 省
             HKDZ_CITYID             = v_HKDZ_CITYID, --户口地址 市
             HKDZ_DISTRICTID         = v_HKDZ_DISTRICTID, --户口地址 县
             HKDZ_PROVINCENAME       = v_HKDZ_PROVINCENAME, --户口地址 省名称
             HKDZ_CITYNAME           = v_HKDZ_CITYNAME, --户口地址 市名称
             HKDZ_DISTRICTNAME       = v_HKDZ_DISTRICTNAME, --户口地址 县名称
             HKDZ_POST               = v_HKDZ_POST, --户口所在地邮编
             JG_PROVINCEID           = v_JG_PROVINCEID, --籍贯 省名称
             JG_CITYID               = v_JG_CITYID, --籍贯 市名称
             JG_PROVINCENAME         = v_JG_PROVINCENAME, --籍贯 省名称
             JG_CITYNAME             = v_JG_CITYNAME, --籍贯 市名称\
             age                     = v_Age,
             
             CURE_TYPE    = v_CURE_TYPE, ---- 治疗类别 □ 1.中医（ 1.1 中医   1.2民族医）    2.中西医     3.西医
             MZZYZD_NAME  = v_MZZYZD_NAME, ---- 门（急）诊诊断（中医诊断）
             MZZYZD_CODE  = v_MZZYZD_CODE, ---- 门（急）诊诊断（中医诊断） 编码
             MZXYZD_NAME  = v_MZXYZD_NAME, ---- 门（急）诊诊断（西医诊断）
             MZXYZD_CODE  = v_MZXYZD_CODE, ---- 门（急）诊诊断（西医诊断） 编码
             SSLCLJ       = v_SSLCLJ, ---- 实施临床路径：□ 1. 中医  2. 西医  3 否
             ZYZJ         = v_ZYZJ, ---- 使用医疗机构中药制剂：□ 1.是  2. 否
             ZYZLSB       = v_ZYZLSB, ---- 使用中医诊疗设备：□  1.是 2. 否
             ZYZLJS       = v_ZYZLJS, ---- 使用中医诊疗技术：□ 1. 是  2. 否
             BZSH         = v_BZSH, ---- 辨证施护：□ 1.是  2. 否
             outHosStatus = v_outHosStatus,
             JBYNZZ       = v_JBYNZZ,
             MZYCY        = v_MZYCY,
             InAndOutHos  = v_InAndOutHos,
             LCYBL        = v_LCYBL,
             FSYBL        = v_FSYBL,
             qJCount      = v_qJCount,
             successCount = v_successCount,
             InPatLY      = v_InPatLY,
             asaScore     = v_asaScore
       where IEM_MAINPAGE_NO = v_IEM_MAINPAGE_NO;
      open o_result for
        select v_IEM_MAINPAGE_NO from dual;
    end if;
  
  END;

  /*****查询病案首页信息****************************************************************************/
  -----Modify by xlb 江西九江新增字段 2013-07-03
  PROCEDURE usp_getieminfo_sx(v_NoOfInpat INT,
                              o_result    OUT empcurtyp,
                              o_result1   OUT empcurtyp,
                              o_result2   OUT empcurtyp,
                              o_result3   OUT empcurtyp,
                              o_result4   OUT empcurtyp) AS
    /**********
     版本号  1.0.0.0.0
     创建时间
     作者
     版权
     描述  获取质量评分
     功能说明
     输入参数
      v_NoOfInpat varchar(40)--首页序号
     输出参数
     结果集、排序
    质量控制统计数据集
    
     调用的sp
     调用实例
     exec usp_GetIemInfo  9
     修改记录
    **********/
    v_infono NUMERIC;
  BEGIN
    OPEN o_result FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result1 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result2 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result3 FOR
      SELECT '' FROM DUAL;
  
    OPEN o_result4 FOR
     SELECT '' FROM DUAL;
  
    SELECT MAX(imb.iem_mainpage_no)
      INTO v_infono
      FROM iem_mainpage_basicinfo_sx imb
     WHERE imb.noofinpat = v_noofinpat
       AND imb.valide = 1;
  
    --数据顺序不可变，与程序里相关
    --基本信息
    OPEN o_result FOR
      SELECT iem.iem_mainpage_no,
             iem.noofinpat,
             iem.socialcare,
             myinp.payid,
             pay.name            payName,
             myinp.noofrecord,
             iem.incount,
             iem.patnoofhis,
             myinp.name,
             myinp.sexid,
             myinp.birth,
             myinp.nativetel, ---现住址电话edit 2012年6月25日 08:46:26
             myinp.marital,
             myinp.jobid,
             job.name            jobName,
             myinp.provinceid    csd_provinceid,
             myinp.countyid      csd_cityid,
             
             myinp.districtid csd_districtid, --出生地县
             
             -- csdpro.provincename csd_provincename,
             iem.csd_provincename csd_provincename,
             csdcity.cityname     csd_cityname,
             csddis.districtname  csd_districtname,
             /*myinp.csdprovicename csd_provincename,
             myinp.csdcityname csd_cityname,
             myinp.csddistrictname csd_districtname,*/
             myinp.xzzproviceid xzz_provinceid,
             
             myinp.xzzcityid     xzz_cityid,
             myinp.xzzdistrictid xzz_districtid,
             
             iem.xzz_provincename xzz_provincename,
             xzzcity.cityname     xzz_cityname,
             xzzdis.districtname  xzz_districtname,
             /*  myinp.xzzprovicename xzz_provincename,
             myinp.xzzcityname xzz_cityname,
             myinp.xzzdistrictname xzz_districtname,*/
             
             myinp.xzztel  xzz_tel,
             myinp.xzzpost xzz_post,
             
             myinp.hkdzproviceid  hkdz_provinceid,
             myinp.hkzdcityid     hkdz_cityid,
             myinp.hkzddistrictid hkdz_districtid,
             
             iem.hkdz_provincename hkdz_provincename,
             hkzzcity.cityname     hkdz_cityname,
             hkzzdis.districtname  hkdz_districtname,
             /*     myinp.hkzzprovicename hkdz_provincename,
             myinp.hkzzcityname   hkdz_cityname,
               myinp.hkzzdistrictname hkdz_districtname,*/
             
             myinp.nativepost hkdz_post,
             
             myinp.nativeplace_p jg_provinceid,
             
             myinp.nativeplace_c jg_cityid,
             
             --jgpro.provincename jg_provincename,
             iem.jg_provincename jg_provincename,
             jgcity.cityname     jg_cityname,
             /*  myinp.jgprovicename jg_provincename,
             myinp.jgcityname jg_cityname,
             */
             myinp.nationid,
             nation.name    NationName,
             
             myinp.nationalityid,
             nationality.name    nationalityName,
             
             myinp.idno,
             iem.organization,
             
             myinp.officeplace,
             
             myinp.officetel,
             
             myinp.officepost,
             
             myinp.contactperson,
             
             myinp.relationship,
             relationship.name  relationshipName,
             
             myinp.contactaddress ContactAddress,
             
             myinp.contacttel ContactTEL,
             
             myinp.admitdate,
             
             myinp.admitdept,
             AdmitDept.name  AdmitDeptName,
             
             --myinp.admitward,
             iem.admitward,
             iem.admitward        admitwardName,
             iem.trans_admitdept,
             trans_admitdept.name trans_admitdeptName,
             iem.outwarddate,
             myinp.outhosdate,
             --iem.outhosdept,
             myinp.outhosdept,
             outhosdept.name  outhosdeptName,
             --iem.outhosward,
             iem.outhosward,
             iem.outhosward outhoswardName,
             --iem.actualdays,
             myinp.totaldays actualdays,
             
             iem.is_completed,
             iem.completed_time,
             iem.valide,
             iem.create_user,
             iem.create_time,
             
             iem.modified_user,
             iem.modified_time,
             iem.autopsy_flag,
             
             --2012国家卫生部表中病案首页新增内容
             iem.monthage,
             iem.weight,
             iem.inweight,
             iem.inhostype,
             iem.outhostype,
             
             iem.receivehospital,
             iem.receivehospital2,
             iem.againinhospital,
             iem.againinhospitalreason,
             iem.beforehoscomaday,
             
             iem.beforehoscomahour,
             iem.beforehoscomaminute,
             iem.laterhoscomaday,
             iem.laterhoscomahour,
             iem.laterhoscomaminute,
             iem.cardnumber,
             
             ---诊断实体
             iem.pathology_diagnosis_id,
             iem.pathology_diagnosis_name,
             iem.pathology_observation_sn,
             iem.hurt_toxicosis_ele_id,
             iem.hurt_toxicosis_ele_name,
             
             iem.allergic_flag,
             iem.allergic_drug,
             iem.bloodtype,
             iem.rh,
             iem.section_director,
             
             section_director.name section_directorName,
             iem.director,
             director.name         directorName,
             iem.vs_employee_code  vs_employeeID,
             vs_employee.name      vs_employeeName,
             
             iem.resident_employee_code resident_employeeID,
             resident_employee.name     resident_employeeName,
             iem.refresh_employee_code  refresh_employeeID,
             refresh_employee.name      refresh_employeeName,
             iem.duty_nurse,
             
             duty_nurse.name  Duty_NurseName,
             iem.interne,
             interne.name     interneName,
             iem.coding_user,
             coding_user.name coding_userName,
             
             iem.medical_quality_id,
             iem.quality_control_doctor,
             quality_control_doctor.name quality_control_doctorName,
             iem.quality_control_nurse,
             quality_control_nurse.name  quality_control_nurseName,
             
             iem.quality_control_date,
             -- iem.age,
             myinp.agestr age,
             
             iem.cure_type,
             iem.mzzyzd_name,
             iem.mzzyzd_code,
             iem.mzxyzd_name,
             iem.mzxyzd_code,
             iem.sslclj,
             iem.zyzj,
             
             iem.zyzlsb,
             iem.zyzljs,
             iem.bzsh,
             iem.outhosstatus,
             iem.jbynzz,
             iem.mzycy,
             iem.inandouthos,
             iem.lcybl,
             iem.fsybl,
             iem.qjcount,
             iem.successcount,
             iem.inpatly,
             iem.asascore,
             myinp.isbaby,
             myinp.mother
      
        FROM iem_mainpage_basicinfo_sx iem
      -- edit  by ywk （对于首页表里有的，病人表里也有的数据，在病案首页显示的时候取病人表里的数据）
        left join inpatient myinp
          on myinp.noofinpat = iem.noofinpat
        left join dictionary_detail pay
          on pay.detailid = myinp.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
      --on job.detailid = iem.jobid
          on job.detailid = myinp.jobid
         and job.categoryid = '41'
        left join dictionary_detail nation
          on nation.detailid = myinp.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = myinp.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = myinp.relationship
         and relationship.categoryid = '44'
        left join department AdmitDept
          on AdmitDept.id = myinp.admitdept
        left join ward admitward
          on admitward.id = iem.admitward
        left join department trans_admitdept
          on trans_admitdept.id = iem.trans_admitdept
        left join department outhosdept
          on outhosdept.id = myinp.outhosdept
        left join ward outhosward
          on outhosward.id = iem.outhosward
        left join diagnosis zymosis
          on zymosis.markid = iem.zymosis
        left join users section_director
          on section_director.id = iem.section_director
        left join users director
          on director.id = iem.director
        left join users vs_employee
          on vs_employee.id = iem.vs_employee_code
        left join users resident_employee
          on resident_employee.id = iem.resident_employee_code
        left join users refresh_employee
          on refresh_employee.id = iem.refresh_employee_code
      
        left join users interne
          on interne.id = iem.interne
        left join users duty_nurse
          on duty_nurse.id = iem.duty_nurse
        left join users coding_user
          on coding_user.id = iem.coding_user
        left join users quality_control_doctor
          on quality_control_doctor.id = iem.quality_control_doctor
        left join users quality_control_nurse
          on quality_control_nurse.id = iem.quality_control_nurse
      
      ---省，市，县的名称从Inpatient表里去除，取名称，进行链表查询 add by ywk 2012年5月17日10:58:03
      --left join s_province csdpro
      -- on myinp.provinceid = csdpro.provinceid --出生地的省
        left join s_city csdcity
          on myinp.countyid = csdcity.cityid --出生地的市
        left join s_district csddis
          on myinp.districtid = csddis.districtid --出生地的县
      
      -- left join s_province jgpro
      --on myinp.nativeplace_p = jgpro.provinceid --籍贯的省
        left join s_city jgcity
          on myinp.nativeplace_c = jgcity.cityid --籍贯的市
      
        left join s_province xzzpro
          on myinp.xzzproviceid = xzzpro.provinceid --现住址的省
        left join s_city xzzcity
          on myinp.xzzcityid = xzzcity.cityid --现住址的市
        left join s_district xzzdis
          on myinp.xzzdistrictid = xzzdis.districtid --现住址的县
      
        left join s_province hkzzpro
          on myinp.hkdzproviceid = hkzzpro.provinceid --户口住址的省
        left join s_city hkzzcity
          on myinp.hkzdcityid = hkzzcity.cityid --户口住址的市
        left join s_district hkzzdis
          on myinp.hkzddistrictid = hkzzdis.districtid --户口住址的县
      
       WHERE iem.iem_mainpage_no = v_infono
         AND iem.valide = 1;
  
    --诊断
    OPEN o_result1 FOR
      SELECT diag.diagnosis_name,
             diag.status_id,
             (case
               when diag.status_id = '1' then
                '有'
               when diag.status_id = '2' then
                '临床未确定'
               when diag.status_id = '3' then
                '情况不明'
               when diag.status_id = '4' then
                '无'
               else
                ''
             end) Status_Name, --入院病情
             diag.diagnosis_code,
             diag.diagnosis_type_id,
             diag.order_value,
             diag.type,
             diag.typename
        FROM iem_mainpage_diagnosis_sx diag
       WHERE iem_mainpage_no = v_infono
         AND valide = 1
       ORDER BY order_value;
  
    --手术
    /*    OPEN o_result2 FOR
    SELECT *
      FROM iem_mainpage_operation
     WHERE iem_mainpage_no = v_infono
       AND valide = 1;*/
  
    OPEN o_result2 FOR
    
      SELECT iem.iem_mainpage_operation_no,
             iem.iem_mainpage_no,
             iem.operation_code,
             iem.operation_date,
             iem.operation_name,
             u1.name                       execute_user1_Name,
             iem.execute_user1,
             u2.name                       execute_user2_Name,
             iem.execute_user2,
             u3.name                       execute_user3_Name,
             iem.execute_user3,
             --dic.name anaesthesia_type_Name,
             ab.name anaesthesia_type_Name,
             iem.anaesthesia_type_id,
             (case
               when iem.close_level = '1' then
                'I/甲'
               when iem.close_level = '2' then
                'II/甲'
               when iem.close_level = '3' then
                'III/甲'
               when iem.close_level = '4' then
                'I/乙'
               when iem.close_level = '5' then
                'II/乙'
               when iem.close_level = '6' then
                'III/乙'
               when iem.close_level = '7' then
                'I/丙'
               when iem.close_level = '8' then
                'II/丙'
               when iem.close_level = '9' then
                'III/丙'
               else
                ''
             end) close_level_Name,
             iem.operation_level,
             (case
               when iem.operation_level = '1' then --operation_level  edit by ywk 2012年4月18日14:03:50
                '一级手术'
               when iem.operation_level = '2' then
                '二级手术'
               when iem.operation_level = '3' then
                '三级手术'
               when iem.operation_level = '4' then
                '四级手术'
               else
                ''
             end) operation_level_Name,
             iem.close_level,
             ua.name anaesthesia_user_Name,
             iem.anaesthesia_user,
             iem.valide,
             iem.create_user,
             iem.create_time,
             iem.cancel_user,
             iem.cancel_time,
             iem.operintimes
        FROM iem_mainpage_operation_sx iem
        left join users u1
          on iem.execute_user1 = u1.id
         and u1.valid = 1
        left join users u2
          on iem.execute_user2 = u2.id
         and u2.valid = 1
        left join users u3
          on iem.execute_user3 = u3.id
         and u3.valid = 1
        left join users ua
          on iem.anaesthesia_user = ua.id
         and ua.valid = 1
      /*left join dictionary_detail dic on iem.anaesthesia_type_id =
          dic.detailid
      and dic.categoryid = '30'*/
      ---麻醉信息的修改 edit by ywk 2012年4月18日10:22:32
        left join anesthesia ab
          on iem.anaesthesia_type_id = ab.id
       WHERE valide = 1
         and iem.iem_mainpage_no = v_infono;
  
    --产妇婴儿信息
    OPEN o_result3 FOR
      SELECT *
        FROM IEM_MAINPAGE_OBSTETRICSBABY
       WHERE iem_mainpage_no = v_infono
         AND valide = 1;
  
    OPEN o_result4 FOR
      select *
        from Iem_MainPage_FeeInfo
       where iem_mainpage_no = v_infono
       AND valid = 1;
  END;

  /*********************************************************************************/
  PROCEDURE usp_edit_iem_mainpage_oper_sx(v_iem_mainpage_no     NUMERIC,
                                          v_operation_code      VARCHAR,
                                          v_operation_date      VARCHAR,
                                          v_operation_name      VARCHAR,
                                          v_execute_user1       VARCHAR,
                                          v_execute_user2       VARCHAR,
                                          v_execute_user3       VARCHAR,
                                          v_anaesthesia_type_id NUMERIC,
                                          v_close_level         NUMERIC,
                                          v_anaesthesia_user    VARCHAR,
                                          --v_Valide numeric ,
                                          v_create_user     VARCHAR,
                                          v_OPERATION_LEVEL varchar,
                                          v_OperInTimes     VARCHAR2
                                          --v_Create_Time varchar(19)
                                          --v_Cancel_User varchar(10) ,
                                          --v_Cancel_Time varchar(19)
                                          ) AS /**********
                                                                                                   版本号  1.0.0.0.0
                                                                                                   创建时间
                                                                                                   作者
                                                                                                   版权
                                                                                                   描述  插入功病案首页手术TABLE
                                                                                                   功能说明
                                                                                                   输入参数
                                                                                                   输出参数
                                                                                                   结果集、排序
    
                                                                                                   调用的sp
                                                                                                   调用实例
    
                                                                                                   修改记录
                                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_operation_sx
      (iem_mainpage_operation_no,
       iem_mainpage_no,
       operation_code,
       operation_date,
       operation_name,
       execute_user1,
       execute_user2,
       execute_user3,
       anaesthesia_type_id,
       close_level,
       anaesthesia_user,
       valide,
       create_user,
       create_time,
       OPERATION_LEVEL,
       operintimes)
    VALUES
      (seq_iem_mainpage_operation_id.NEXTVAL,
       v_iem_mainpage_no, --numeric
       v_operation_code, -- varchar(60)
       v_operation_date,
       -- varchar(19)
       v_operation_name, -- varchar(300)
       v_execute_user1, -- varchar(20)
       v_execute_user2,
       -- varchar(20)
       v_execute_user3, -- varchar(20)
       v_anaesthesia_type_id, -- numeric
       v_close_level,
       -- numeric
       v_anaesthesia_user, -- varchar(20)
       1, -- numeric
       v_create_user, -- varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'),
       v_OPERATION_LEVEL,
       v_OperInTimes);
  END;

  /*********************************************************************************/
  PROCEDURE usp_edif_iem_mainpage_diag_sx(v_iem_mainpage_no   VARCHAR,
                                          v_diagnosis_type_id VARCHAR,
                                          v_diagnosis_code    VARCHAR,
                                          v_diagnosis_name    VARCHAR,
                                          v_status_id         VARCHAR,
                                          v_order_value       VARCHAR,
                                          --v_Valide numeric ,
                                          v_create_user VARCHAR,
                                          v_type        varchar,
                                          v_typeName    varchar
                                          --v_Create_Time varchar(19) ,
                                          --v_Cancel_User varchar(10) ,
                                          --v_Cancel_Time varchar(19)
                                          ) AS /**********
                                                                                                   版本号  1.0.0.0.0
                                                                                                   创建时间
                                                                                                   作者
                                                                                                   版权
                                                                                                   描述  插入功病案首页诊断TABLE
                                                                                                   功能说明
                                                                                                   输入参数
                                                                                                   输出参数
                                                                                                   结果集、排序
    
                                                                                                   调用的sp
                                                                                                   调用实例
    
                                                                                                   修改记录
                                                                                                  **********/
  BEGIN
    INSERT INTO iem_mainpage_diagnosis_sx
      (iem_mainpage_diagnosis_no,
       iem_mainpage_no,
       diagnosis_type_id,
       diagnosis_code,
       diagnosis_name,
       status_id,
       order_value,
       valide,
       create_user,
       create_time,
       type,
       typeName)
    VALUES
      (seq_iem_mainpage_diagnosis_id.NEXTVAL,
       v_iem_mainpage_no, -- Iem_Mainpage_NO - numeric
       v_diagnosis_type_id,
       -- Diagnosis_Type_Id - numeric
       v_diagnosis_code,
       -- Diagnosis_Code - varchar(60)
       v_diagnosis_name, -- Diagnosis_Name - varchar(300)
       v_status_id, -- Status_Id - numeric
       v_order_value,
       -- Order_Value - numeric
       1,
       -- Valide - numeric
       v_create_user, -- Create_User - varchar(10)
       TO_CHAR(SYSDATE, 'yyyy-mm-dd HH24:mi:ss'),
       v_type,
       v_typeName
       -- Create_Time - varchar(19)
       );
  END;

  --更新病案首页信息后，对病人信息表进行数据同步 add by ywk 二一二年五月四日 15:20:27
  PROCEDURE usp_Edit_Iem_PaientInfo_sx(v_NOOFINPAT      varchar2 default '', ---- '病人首页序号';
                                       v_NAME           varchar2 default '', ---- '患者姓名';
                                       v_SEXID          varchar2 default '', ---- '性别';
                                       v_BIRTH          varchar2 default '', ---- '出生';
                                       v_Age            INTEGER default 1, --年龄
                                       v_IDNO           varchar2 default '', ---- '身份证号码';
                                       v_MARITAL        varchar2 default '', ---- '婚姻状况 1.未婚 2.已婚 3.丧偶4.离婚 9.其他';
                                       v_JOBID          varchar2 default '', ---- '职业';
                                       v_CSD_PROVINCEID varchar2 default '', ---- '出生地 省';
                                       v_CSD_CITYID     varchar2 default '', ---- '出生地 市';
                                       v_NATIONID       varchar2 default '', --民族
                                       v_NATIONALITYID  varchar2 default '', ---- '国籍ID';
                                       v_JG_PROVINCEID  varchar2 default '', ---- '籍贯 省';
                                       v_JG_CITYID      varchar2 default '', ---- '籍贯 市';
                                       v_OFFICEPLACE    varchar2 default '', ---- '工作单位地址';
                                       v_OFFICETEL      varchar2 default '', ---- '工作单位电话';
                                       v_OFFICEPOST     varchar2 default '', ---- '工作单位邮编';
                                       v_HKDZ_POST      varchar2 default '', ---- '户口所在地邮编';
                                       v_CONTACTPERSON  varchar2 default '', ---- '联系人姓名';
                                       v_RELATIONSHIP   varchar2 default '', ---- '与联系人关系';
                                       v_CONTACTADDRESS varchar2 default '', ---- '联系人地址';
                                       v_CONTACTTEL     varchar2 default '', ---- '联系人电话';
                                       v_ADMITDEPT      varchar2 default '', ---- '入院科室';
                                       v_ADMITWARD      varchar2 default '', ---- '入院病区';\
                                       v_ADMITDATE      varchar2 default '', ---- '入院时间';
                                       v_OUTWARDDATE    varchar2 default '', ---- '出院时间';
                                       v_OUTHOSDEPT     varchar2 default '', ---- '出院科室';
                                       v_OUTHOSWARD     varchar2 default '', ---- '出院病区';
                                       v_ACTUALDAYS     varchar2 default '', ---- '实际住院天数';
                                       v_AgeStr         varchar2 default '', ---- '年龄 精确到月天;2012年5月9日9:31:03 （杨维康 泗县修改）
                                       v_PatId          varchar2 default '', --新增的付款方式 add by ywk 2012年5月14日 16:02:13
                                       v_CardNo         varchar2 default '', --健康卡号
                                       -----add by ywk  2012年5月16日9:45:27 Inpatient表l里增加病案首页里相应的字段
                                       v_Districtid     varchar2 default '', --出生地‘县’
                                       v_xzzproviceid   varchar2 default '', --现在住址省
                                       v_xzzcityid      varchar2 default '', --现在住址市
                                       v_xzzdistrictid  varchar2 default '', --现在住址县
                                       v_xzztel         varchar2 default '', --现在住址电话
                                       v_hkdzproviceid  varchar2 default '', --户口住址省
                                       v_hkzdcityid     varchar2 default '', --户口住址市
                                       v_hkzddistrictid varchar2 default '', --户口住址县
                                       v_xzzpost        varchar2 default '', --现住址邮编
                                       v_isupdate       varchar2 default '' ---2012年5月24日 17:19:10 ywk 是否更新身份证号字段
                                       ) as
    myidno          varchar2(50);
    mymaterital     varchar2(50);
    myjobid         varchar2(50);
    myadmitdept     varchar2(50);
    mydamitward     varchar2(50);
    myouthosdept    varchar2(50);
    myouthosward    varchar2(50);
    myofficepalce   varchar2(250);
    myofficetel     varchar2(50);
    myofficepost    varchar2(50);
    mycontactperson varchar2(50);
    myadmitdate     varchar2(50);
    myouthosdate    varchar2(50);
    mynoofclinic    varchar2(50);
  begin
    /*select nvl(idno,v_IDNO)
     into myidno
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --身份证号码*/
  
    myidno := v_IDNO;
  
    /*select nvl(v_MARITAL, Marital)
     into mymaterital
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --婚姻*/
    mymaterital := v_MARITAL;
    myjobid     := v_JOBID;
    /* select nvl(v_JOBID, jobid)
     into myjobid
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --职业*/
    --  myadmitdept:=v_ADMITDEPT;
    select nvl(v_ADMITDEPT, AdmitDept)
      into myadmitdept
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --入院科室(如果病案首页里编辑的填写内容是空，就取原来的Inpatient表里的数据)
    --mydamitward:=  v_ADMITWARD;
    select nvl(v_ADMITWARD, AdmitWard)
      into mydamitward
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --入院病区
    --myouthosdept:=v_OUTHOSDEPT;
    select nvl(v_OUTHOSDEPT, OutHosDept)
      into myouthosdept
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --出院室科
    --  myouthosward:=v_OUTHOSWARD;
    select nvl(v_OUTHOSWARD, OutHosWard)
      into myouthosward
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --出院病区
    /*  select nvl(v_OFFICEPLACE, OfficePlace)
     into myofficepalce
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --工作地址*/
    myofficepalce := v_OFFICEPLACE;
    /*   select nvl(v_OFFICETEL, OfficeTEL)
     into myofficetel
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --工作单位电话*/
    myofficetel  := v_OFFICETEL;
    myofficepost := v_OFFICEPOST;
    /*select nvl(v_OFFICEPOST, OfficePost)
     into myofficepost
     from inpatient
    where NoOfInpat =v_NOOFINPAT; --工作单位邮编*/
    mycontactperson := v_CONTACTPERSON;
    /* s\*elect nvl(v_CONTACTPERSON, ContactPerson)
     into mycontactperson
     from inpatient
    where NoOfInpat =*\ v_NOOFINPAT; --联系人姓名*/
    myadmitdate := v_ADMITDATE;
    /*select nvl(v_ADMITDATE, AdmitDate)
     into myadmitdate
     from inpatient
    where NoOfInpat = v_NOOFINPAT; --入院时间*/
    myouthosdate := v_OUTWARDDATE;
    select nvl(v_OUTWARDDATE, OutHosDate)
      into myouthosdate
      from inpatient
     where NoOfInpat = v_NOOFINPAT; --出院时间
    if v_isupdate = '0' then
      update inpatient
         set Name           = v_NAME,
             sexid          = v_SEXID,
             birth          = v_BIRTH,
             age            = v_Age,
             idno           = myidno,
             Marital        = mymaterital,
             jobid          = myjobid,
             ProvinceID     = v_CSD_PROVINCEID,
             CountyID       = v_CSD_CITYID,
             NationID       = v_NATIONID,
             NationalityID  = v_NATIONALITYID,
             Nativeplace_P  = v_JG_PROVINCEID,
             Nativeplace_C  = v_JG_CITYID,
             OfficePlace    = myofficepalce,
             OfficeTEL      = myofficetel,
             OfficePost     = myofficepost,
             NativePost     = v_HKDZ_POST,
             ContactPerson  = mycontactperson,
             Relationship   = v_RELATIONSHIP,
             ContactAddress = v_CONTACTADDRESS,
             ContactTEL     = v_CONTACTTEL,
             AdmitDept      = myadmitdept,
             --AdmitWard      = mydamitward,
             AdmitDate  = myadmitdate,
             OutHosDate = myouthosdate,
             OutHosDept = myouthosdept,
             -- OutHosWard     = myouthosward,
             TotalDays      = v_ACTUALDAYS,
             AgeStr         = v_AgeStr,
             payid          = v_PatId,
             cardno         = v_CardNo,
             districtid     = v_Districtid,
             address        = v_xzzproviceid,
             xzzcityid      = v_xzzcityid,
             xzzdistrictid  = v_xzzdistrictid,
             xzztel         = v_xzztel,
             nativeaddress  = v_hkdzproviceid,
             hkzdcityid     = v_hkzdcityid,
             hkzddistrictid = v_hkzddistrictid,
             xzzpost        = v_xzzpost,
             organization   = myofficepalce
      
       where NoOfInpat = v_NOOFINPAT;
      commit;
    end if;
    if v_isupdate = '1' then
      if myidno = '不详' then
        mynoofclinic := '';
      else
        mynoofclinic := myidno;
      end if;
      update inpatient
         set Name           = v_NAME,
             sexid          = v_SEXID,
             birth          = v_BIRTH,
             age            = v_Age,
             idno           = mynoofclinic,
             Marital        = mymaterital,
             jobid          = myjobid,
             ProvinceID     = v_CSD_PROVINCEID,
             CountyID       = v_CSD_CITYID,
             NationID       = v_NATIONID,
             NationalityID  = v_NATIONALITYID,
             Nativeplace_P  = v_JG_PROVINCEID,
             Nativeplace_C  = v_JG_CITYID,
             OfficePlace    = myofficepalce,
             OfficeTEL      = myofficetel,
             OfficePost     = myofficepost,
             NativePost     = v_HKDZ_POST,
             ContactPerson  = mycontactperson,
             Relationship   = v_RELATIONSHIP,
             ContactAddress = v_CONTACTADDRESS,
             ContactTEL     = v_CONTACTTEL,
             AdmitDept      = myadmitdept,
             AdmitWard      = mydamitward,
             AdmitDate      = myadmitdate,
             OutHosDate     = myouthosdate,
             OutHosDept     = myouthosdept,
             OutHosWard     = myouthosward,
             TotalDays      = v_ACTUALDAYS,
             AgeStr         = v_AgeStr,
             payid          = v_PatId,
             cardno         = v_CardNo,
             districtid     = v_Districtid,
             address        = v_xzzproviceid,
             xzzcityid      = v_xzzcityid,
             xzzdistrictid  = v_xzzdistrictid,
             xzztel         = v_xzztel,
             nativeaddress  = v_hkdzproviceid,
             hkzdcityid     = v_hkzdcityid,
             hkzddistrictid = v_hkzddistrictid,
             xzzpost        = v_xzzpost,
             noofclinic     = mynoofclinic,
             organization   = myofficepalce
       where NoOfInpat = v_NOOFINPAT;
      commit;
    end if;
    /*   open o_result for
    select v_IEM_MAINPAGE_NO from dual;*/
  End;

  --获得首页默认表里的数据
  --add by ywk 2012年5月17日 09:36:46
  PROCEDURE usp_GetDefaultInpatient(o_result OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      select inp.*,
             pay.name             payname,
             job.name             jobname,
             nation.name          nationame,
             nationality.name     nationaltyname,
             relationship.name    relationshipname,
             csdpro.provincename  csd_provincename,
             csdcity.cityname     csd_cityname,
             csddis.districtname  csd_districtname,
             xzzpro.provincename  xzz_provincename,
             xzzcity.cityname     xzz_cityname,
             xzzdis.districtname  xzz_districtname,
             hkzzpro.provincename hkdz_provincename,
             hkzzcity.cityname    hkdz_cityname,
             hkzzdis.districtname hkdz_districtname,
             jgpro.provincename   jg_provincename,
             jgcity.cityname      jg_cityname,
             dia.name             outdiagname -- 门诊诊断
        from inpatient_default inp
        left join dictionary_detail pay
          on pay.detailid = inp.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
          on job.detailid = inp.jobid
         and job.categoryid = '41'
        left join dictionary_detail nation
          on nation.detailid = inp.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = inp.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = inp.relationship
         and relationship.categoryid = '44'
        left join diagnosis dia
          on dia.icd = inp.clinicdiagnosis --add ywk 2012年6月15日 11:44:07
      ---省，市，县的名称从Inpatient表里去除，取名称，进行链表查询 add by ywk 2012年5月17日10:58:03
        left join s_province csdpro
          on inp.provinceid = csdpro.provinceid --出生地的省
        left join s_city csdcity
          on inp.countyid = csdcity.cityid --出生地的市
        left join s_district csddis
          on inp.districtid = csddis.districtid --出生地的县
      
        left join s_province jgpro
          on inp.nativeplace_p = jgpro.provinceid --籍贯的省
        left join s_city jgcity
          on inp.nativeplace_c = jgcity.cityid --籍贯的市
      
        left join s_province xzzpro
          on inp.xzzproviceid = xzzpro.provinceid --现住址的省
        left join s_city xzzcity
          on inp.xzzcityid = xzzcity.cityid --现住址的市
        left join s_district xzzdis
          on inp.xzzdistrictid = xzzdis.districtid --现住址的县
      
        left join s_province hkzzpro
          on inp.hkdzproviceid = hkzzpro.provinceid --户口住址的省
        left join s_city hkzzcity
          on inp.hkzdcityid = hkzzcity.cityid --户口住址的市
        left join s_district hkzzdis
          on inp.hkzddistrictid = hkzzdis.districtid; --户口住址的县
  
  END;

  PROCEDURE usp_GetInpatientByNo(v_noofinpat varchar2 default '',
                                 o_result    OUT empcurtyp) AS
  BEGIN
    OPEN o_result FOR
      select inp.*,
             pay.name          payname,
             job.name          jobname,
             nation.name       nationame,
             nationality.name  nationaltyname,
             relationship.name relationshipname,
             /* csdpro.provincename  csd_provincename,*/
             inp.provinceid      csd_provincename,
             csdcity.cityname    csd_cityname,
             csddis.districtname csd_districtname,
             /*xzzpro.provincename  xzz_provincename,*/
             inp.address         xzz_provincename,
             xzzcity.cityname    xzz_cityname,
             xzzdis.districtname xzz_districtname,
             /* hkzzpro.provincename hkdz_provincename,*/
             inp.nativeaddress    hkdz_provincename,
             hkzzcity.cityname    hkdz_cityname,
             hkzzdis.districtname hkdz_districtname,
             /*jgpro.provincename   jg_provincename,*/
             inp.nativeplace_p jg_provincename,
             jgcity.cityname   jg_cityname,
             dia.name          outdiagname, -- 门诊诊断
             u1.name           CHIEFNAME,
             u2.name           attendname,
             u3.name           RESIDENTNAME
        from inpatient inp
        left join dictionary_detail pay
          on pay.detailid = inp.payid
         and pay.categoryid = '1'
        left join dictionary_detail job
          on job.detailid = inp.jobid
         and job.categoryid = '41'
        left join dictionary_detail nation
          on nation.detailid = inp.nationid
         and nation.categoryid = '42'
        left join dictionary_detail nationality
          on nationality.detailid = inp.nationalityid
         and nationality.categoryid = '43'
        left join dictionary_detail relationship
          on relationship.detailid = inp.relationship
         and relationship.categoryid = '44'
        left join diagnosis dia
          on dia.icd = inp.clinicdiagnosis --add ywk 2012年6月15日 11:44:07
        left join users u1
          on u1.id = inp.chief
        left join users u2
          on u2.id = inp.attend
        left join users u3
          on u3.id = inp.resident
      ---省，市，县的名称从Inpatient表里去除，取名称，进行链表查询 add by ywk 2012年5月17日10:58:03
      ---left join s_province csdpro
      --- on inp.provinceid = csdpro.provinceid --出生地的省
        left join s_city csdcity
          on inp.countyid = csdcity.cityid --出生地的市
        left join s_district csddis
          on inp.districtid = csddis.districtid --出生地的县
      
      --- left join s_province jgpro
      ---  on inp.nativeplace_p = jgpro.provinceid --籍贯的省
        left join s_city jgcity
          on inp.nativeplace_c = jgcity.cityid --籍贯的市
      
        left join s_province xzzpro
          on inp.xzzproviceid = xzzpro.provinceid --现住址的省
        left join s_city xzzcity
          on inp.xzzcityid = xzzcity.cityid --现住址的市
        left join s_district xzzdis
          on inp.xzzdistrictid = xzzdis.districtid --现住址的县
      
        left join s_province hkzzpro
          on inp.hkdzproviceid = hkzzpro.provinceid --户口住址的省
        left join s_city hkzzcity
          on inp.hkzdcityid = hkzzcity.cityid --户口住址的市
        left join s_district hkzzdis
          on inp.hkzddistrictid = hkzzdis.districtid --户口住址的县
       where inp.noofinpat = v_noofinpat;
  end;

  /*
  * 维护病案首页的费用信息
  add by ywk 2012年10月16日 19:29:53
  */
  PROCEDURE usp_editiem_mainpage_feeinfo(v_edittype        varchar2 default '',
                                         v_IEM_MAINPAGE_NO varchar2 default '', ---- '病案首页标识';
                                         v_TotalFee        varchar2 default '', ---- 总费用;
                                         v_OwnerFee        varchar2 default '', ---- '自付金额
                                         v_YbMedServFee    varchar2 default '', ---- 一般医疗服务费
                                         v_YbMedOperFee    varchar2 default '', ---- 一般治疗操作费
                                         v_NurseFee        varchar2 default '', ----护理费
                                         v_OtherInfo       varchar2 default '', ---- 综合类 其他费用
                                         v_BLZDFee         varchar2 default '', ---- 诊断类 病理诊断费
                                         v_SYSZDFee        varchar2 default '', ---- 实验室诊断费
                                         v_YXXZDFee        varchar2 default '', ----  诊断类 影像学诊断费
                                         v_LCZDItemFee     varchar2 default '', ----  诊断类 临床诊断项目费
                                         v_FSSZLItemFee    varchar2 default '', ----  非手术治疗项目费
                                         v_LCWLZLFee       varchar2 default '', ---- 治疗类 临床物理治疗费
                                         v_OperMedFee      varchar2 default '', ----治疗类 手术治疗费
                                         v_KFFee           varchar2 default '', ----康复类 康复费
                                         v_ZYZLFee         varchar2 default '', ----中医类 中医治疗费
                                         v_XYMedFee        varchar2 default '', ---西药类 西药费
                                         v_KJYWFee         varchar2 default '', ---西药类 抗菌药物费用
                                         v_ZCYFFee         varchar2 default '', ---中药类 中成药费
                                         v_ZCaoYFFee       varchar2 default '', ---中药类 中草药费
                                         v_BloodFee        varchar2 default '', ---血液和血液制品类 血费
                                         v_BDBLZPFFee      varchar2 default '', ---血液和血液制品类 白蛋白类制品费
                                         v_QDBLZPFFee      varchar2 default '', ---球蛋白类制品费
                                         v_NXYZLZPFFee     varchar2 default '', ---血液和血液制品类 凝血因子类制品费
                                         v_XBYZLZPFFee     varchar2 default '', ---细胞因子类制品费
                                         v_JCYYCXYYCLFFee  varchar2 default '', -- 检查用一次性医用材料费
                                         v_ZLYYCXYYCLFFee  varchar2 default '', -- /耗材类 治疗用一次性医用材料费
                                         v_SSYYCXYYCLFFee  varchar2 default '', -- 材类 手术用一次性医用材料费
                                         v_QTFee           varchar2 default '', -- 其他类：（24）其他费        
                                         v_Memo1           varchar2 default '', -- 预留字段   1    
                                         v_Memo2           varchar2 default '', -- 预留字段    2  
                                         v_Memo3           varchar2 default '', -- 预留字段     3     
                                         v_MaZuiFee        varchar2 default '', -- 麻醉费
                                         v_ShouShuFee      varchar2 default '' -- 手术费 
                                         ) as
    p_count integer default 0;
  
  begin
    IF v_edittype = '1' THEN
      SELECT NVL(MAX(ID), 0) + 1 into p_count FROM Iem_MainPage_FeeInfo;
    
      --新增病案首页基本信息
      insert into Iem_MainPage_FeeInfo
        (ID,
         IEM_MAINPAGE_NO,
         TotalFee,
         OwnerFee,
         YbMedServFee,
         YbMedOperFee,
         NurseFee,
         OtherInfo,
         BLZDFee,
         SYSZDFee,
         YXXZDFee,
         LCZDItemFee,
         FSSZLItemFee,
         LCWLZLFee,
         OperMedFee,
         KFFee,
         ZYZLFee,
         XYMedFee,
         KJYWFee,
         ZCYFFee,
         ZCaoYFFee,
         BloodFee,
         BDBLZPFFee,
         QDBLZPFFee,
         NXYZLZPFFee,
         XBYZLZPFFee,
         JCYYCXYYCLFFee,
         Zlyycxyyclffee,
         SSYYCXYYCLFFee,
         QTFee,
         MemoFee1,
         MemoFee2,
         MemoFee3,
         valid,
         Mazuifee,
         shoushufee)
      values
        (p_count, ---- '病案首页标识';
         V_IEM_MAINPAGE_NO,
         V_TotalFee,
         V_OwnerFee,
         V_YbMedServFee,
         V_YbMedOperFee,
         V_NurseFee,
         V_OtherInfo,
         V_BLZDFee,
         V_SYSZDFee,
         V_YXXZDFee,
         V_LCZDItemFee,
         V_FSSZLItemFee,
         V_LCWLZLFee,
         V_OperMedFee,
         V_KFFee,
         V_ZYZLFee,
         V_XYMedFee,
         V_KJYWFee,
         V_ZCYFFee,
         V_ZCaoYFFee,
         V_BloodFee,
         V_BDBLZPFFee,
         V_QDBLZPFFee,
         V_NXYZLZPFFee,
         V_XBYZLZPFFee,
         V_JCYYCXYYCLFFee,
         V_Zlyycxyyclffee,
         V_SSYYCXYYCLFFee,
         V_QTFee,
         V_Memo1,
         V_Memo2,
         V_Memo3,
         1,
         V_MaZuifee,
         V_shoushufee);
    
      ---修改病案首页基本信息
    ELSIF v_edittype = '2' THEN
    
      update Iem_MainPage_FeeInfo
         set TotalFee       = V_TotalFee,
             OwnerFee       = v_OwnerFee,
             YbMedServFee   = V_YbMedServFee,
             YbMedOperFee   = V_YbMedOperFee,
             NurseFee       = V_NurseFee,
             OtherInfo      = V_OtherInfo,
             BLZDFee        = V_BLZDFee,
             SYSZDFee       = V_SYSZDFee,
             YXXZDFee       = V_YXXZDFee,
             LCZDItemFee    = V_LCZDItemFee,
             FSSZLItemFee   = V_FSSZLItemFee,
             LCWLZLFee      = V_LCWLZLFee,
             OperMedFee     = V_OperMedFee,
             KFFee          = V_KFFee,
             ZYZLFee        = V_ZYZLFee,
             XYMedFee       = V_XYMedFee,
             KJYWFee        = V_KJYWFee,
             ZCYFFee        = V_ZCYFFee,
             ZCaoYFFee      = V_ZCaoYFFee,
             BloodFee       = V_BloodFee,
             BDBLZPFFee     = V_BDBLZPFFee,
             QDBLZPFFee     = V_QDBLZPFFee,
             NXYZLZPFFee    = V_NXYZLZPFFee,
             XBYZLZPFFee    = V_XBYZLZPFFee,
             JCYYCXYYCLFFee = V_JCYYCXYYCLFFee,
             Zlyycxyyclffee = V_Zlyycxyyclffee,
             SSYYCXYYCLFFee = V_SSYYCXYYCLFFee,
             QTFee          = V_QTFee,
             MemoFee1       = V_Memo1,
             MemoFee2       = V_Memo2,
             MemoFee3       = V_Memo3,
             MaZuiFee       = V_MaZuifee,
             ShouShuFee     = v_ShouShuFee
       where IEM_MAINPAGE_NO = V_IEM_MAINPAGE_NO;
    
    end if;
  end;

  PROCEDURE usp_AddOrModIemFeeZY(v_id        varchar,
                                 v_NOOFINPAT varchar,
                                 v_TOTAL     varchar,
                                 v_OWNFEE    varchar,
                                 v_YBYLFY    varchar,
                                 v_ZYBZLZF   varchar,
                                 v_ZYBZLZHZF varchar,
                                 v_YBZLFY    varchar,
                                 v_CARE      varchar,
                                 v_ZHQTFY    varchar,
                                 v_BLZDF     varchar,
                                 v_SYSZDF    varchar,
                                 v_YXXZDF    varchar,
                                 v_LCZDF     varchar,
                                 v_FSSZLF    varchar,
                                 v_LCWLZLF   varchar,
                                 v_SSZLF     varchar,
                                 v_MZF       varchar,
                                 v_SSF       varchar,
                                 v_KFF       varchar,
                                 v_ZYZDF     varchar,
                                 v_ZYZLF     varchar,
                                 v_ZYWZ      varchar,
                                 v_ZYGS      varchar,
                                 v_ZCYJF     varchar,
                                 v_ZYTNZL    varchar,
                                 v_ZYGCZL    varchar,
                                 v_ZYTSZL    varchar,
                                 v_ZYQT      varchar,
                                 v_ZYTSTPJG  varchar,
                                 v_BZSS      varchar,
                                 v_XYF       varchar,
                                 v_KJYWF     varchar,
                                 v_CPMEDICAL varchar,
                                 v_YLJGZYZJF varchar,
                                 v_CMEDICAL  varchar,
                                 v_BLOODFEE  varchar,
                                 v_XDBLZPF   varchar,
                                 v_QDBLZPF   varchar,
                                 v_NXYZLZPF  varchar,
                                 v_XBYZLZPF  varchar,
                                 v_JCYYCXCLF varchar,
                                 v_ZLYYCXCLF varchar,
                                 v_SSYYCXCLF varchar,
                                 v_OTHERFEE  varchar,
                                 v_VALID     varchar) as
    v_count integer;
  begin
    select count(*)
      into v_count
      from iem_mainpage_feeinfoZY
     where iem_mainpage_feeinfoZY.Id = v_id
       and iem_mainpage_feeinfoZY.Valid = '1';
    if v_count <= 0 then
      insert into iem_mainpage_feeinfoZY
        (Id,
         Noofinpat,
         Total,
         Ownfee,
         Ybylfy,
         Zybzlzf,
         Zybzlzhzf,
         Ybzlfy,
         Care,
         Zhqtfy,
         Blzdf,
         Syszdf,
         Yxxzdf,
         Lczdf,
         Fsszlf,
         Lcwlzlf,
         Sszlf,
         Mzf,
         Ssf,
         kff,
         Zyzdf,
         Zyzlf,
         Zywz,
         Zygs,
         Zcyjf,
         Zytnzl,
         Zygczl,
         Zytszl,
         Zyqt,
         Zytstpjg,
         Bzss,
         Xyf,
         Kjywf,
         Cpmedical,
         Yljgzyzjf,
         Cmedical,
         Bloodfee,
         Xdblzpf,
         Qdblzpf,
         Nxyzlzpf,
         Xbyzlzpf,
         Jcyycxclf,
         Zlyycxclf,
         Ssyycxclf,
         Otherfee,
         Valid)
      values
        (v_id,
         v_NOOFINPAT,
         v_TOTAL,
         v_OWNFEE,
         v_YBYLFY,
         v_ZYBZLZF,
         v_ZYBZLZHZF,
         v_YBZLFY,
         v_CARE,
         v_ZHQTFY,
         v_BLZDF,
         v_SYSZDF,
         v_YXXZDF,
         v_LCZDF,
         v_FSSZLF,
         v_LCWLZLF,
         v_SSZLF,
         v_MZF,
         v_SSF,
         v_KFF,
         v_ZYZDF,
         v_ZYZLF,
         v_ZYWZ,
         v_ZYGS,
         v_ZCYJF,
         v_ZYTNZL,
         v_ZYGCZL,
         v_ZYTSZL,
         v_ZYQT,
         v_ZYTSTPJG,
         v_BZSS,
         v_XYF,
         v_KJYWF,
         v_CPMEDICAL,
         v_YLJGZYZJF,
         v_CMEDICAL,
         v_BLOODFEE,
         v_XDBLZPF,
         v_QDBLZPF,
         v_NXYZLZPF,
         v_XBYZLZPF,
         v_JCYYCXCLF,
         v_ZLYYCXCLF,
         v_SSYYCXCLF,
         v_OTHERFEE,
         v_VALID);
    else
      update iem_mainpage_feeinfoZY
         set TOTAL     = v_TOTAL,
             OWNFEE    = v_OWNFEE,
             YBYLFY    = v_YBYLFY,
             ZYBZLZF   = v_ZYBZLZF,
             ZYBZLZHZF = v_ZYBZLZHZF,
             YBZLFY    = v_YBZLFY,
             CARE      = v_CARE,
             ZHQTFY    = v_ZHQTFY,
             BLZDF     = v_BLZDF,
             SYSZDF    = v_SYSZDF,
             YXXZDF    = v_YXXZDF,
             LCZDF     = v_LCZDF,
             FSSZLF    = v_FSSZLF,
             LCWLZLF   = v_LCWLZLF,
             SSZLF     = v_SSZLF,
             MZF       = v_MZF,
             SSF       = v_SSF,
             KFF       = v_KFF,
             ZYZDF     = v_ZYZDF,
             ZYZLF     = v_ZYZLF,
             ZYWZ      = v_ZYWZ,
             ZYGS      = v_ZYGS,
             ZCYJF     = v_ZCYJF,
             ZYTNZL    = v_ZYTNZL,
             ZYGCZL    = v_ZYGCZL,
             ZYTSZL    = v_ZYTSZL,
             ZYQT      = v_ZYQT,
             ZYTSTPJG  = v_ZYTSTPJG,
             BZSS      = v_BZSS,
             XYF       = v_XYF,
             KJYWF     = v_KJYWF,
             CPMEDICAL = v_CPMEDICAL,
             YLJGZYZJF = v_YLJGZYZJF,
             CMEDICAL  = v_CMEDICAL,
             BLOODFEE  = v_BLOODFEE,
             XDBLZPF   = v_XDBLZPF,
             QDBLZPF   = v_QDBLZPF,
             NXYZLZPF  = v_NXYZLZPF,
             XBYZLZPF  = v_XBYZLZPF,
             JCYYCXCLF = v_JCYYCXCLF,
             ZLYYCXCLF = v_ZLYYCXCLF,
             SSYYCXCLF = v_SSYYCXCLF,
             OTHERFEE  = v_OTHERFEE
       where id = v_id;
    end if;
  end;

  PROCEDURE usp_GetIemFeeZYbyInpat(v_noofinpat varchar,
                                   o_result    OUT empcurtyp) as
  begin
    OPEN o_result FOR
      select *
        from iem_mainpage_feeinfozy
       where iem_mainpage_feeinfozy.valid = '1'
         and iem_mainpage_feeinfozy.noofinpat = v_noofinpat;
  end;

END;
/

prompt
prompt Creating package body MAINPAGEEXTENSION
prompt =======================================
prompt
create or replace package body emr.mainpageextension is

---抓取病案首页扩展维护记录 Add by xlb 2013-04-10
PROCEDURE GETIEMEXCEPT(
                       o_result out empcurtype
                      ) as
Begin
open o_result for
select iemexid,iemexname,dateelementflow,
IEMCONTROL,iemothername,ordercode,isotherline,
valide,createdocid,createdatetime,MODIFYDOCID,
MODIFYDATETIME from iem_mainpage_except
 where valide='1' order by to_number(iem_mainpage_except.ordercode);
END;

PROCEDURE ADDORMODIFYIEMEXCEPT
                            (
                            v_iemexId         VARCHAR2,
                            v_iemexName       VARCHAR2,
                            v_dateElementFlow VARCHAR2,
                            v_iemControl      VARCHAR2,
                            v_iemOtherName    VARCHAR2,
                            v_orderCode       VARCHAR2,
                            v_isOtherLine     VARCHAR2,
                            v_valide          VARCHAR2,
                            v_createDocId     VARCHAR2,
                            v_createDateTime  CHAR,
                            v_modifyDocId     VARCHAR2,
                            v_modifyDateTime  VARCHAR2

                            ) AS


v_count integer;

BEGIN
  select count(*) into v_count from iem_mainpage_except e where e.iemexid=v_iemexId;
    if v_count <=0
    then
    insert into iem_mainpage_except (iemexid,
                                    iemexname,
                                    dateelementflow,
                                    iemcontrol,
                                    iemothername,
                                    ordercode,
                                    isotherline,
                                    valide,
                                    createdocid,
                                    createdatetime,
                                    modifydocid,
                                    modifydatetime
                                    )  values
                                     (
                                        v_iemexId,
                                        v_iemexName,
                                        v_dateElementFlow,
                                        v_iemControl,
                                        v_iemOtherName,
                                        v_orderCode,
                                        v_isOtherLine,
                                        v_valide,
                                        v_createDocId,
                                        v_createDateTime,
                                        v_modifyDocId,
                                        v_modifyDateTime
                                        );
else
  update iem_mainpage_except e set e.iemexname=v_iemexName,
  dateelementflow=v_dateElementFlow,iemcontrol=v_iemControl,
  ordercode=v_orderCode,isotherline=v_isOtherLine,valide=v_valide,
  iemothername=v_iemOtherName,
  createdocid=v_createDocId,createdatetime=v_createDateTime,
  modifydocid=v_modifyDocId,modifydatetime=v_modifyDateTime

   where e.iemexid=v_iemexId;

END IF;

END;
----------------------------------新增或修改病人使用记录  病案首页扩展功能  Add by xlb 2013-04-16
Procedure ADDORMODIFYIEMUS
                         (
                          v_iemExUserId   VARCHAR2,
                          v_iemExId       VARCHAR2,
                          v_nOofInpat     VARCHAR2,
                          v_value         VARCHAR2,
                          v_createDocId   VARCHAR2,
                          v_modifyDocId   VARCHAR2,
                          v_modifyDateTime CHAR
                          ) AS
  v_count integer;
 begin
 select count(*) into v_count from iem_mainpage_except_use where IEMEXUSEID=v_iemExUserId;
 if v_count <=0
 then
 insert into iem_mainpage_except_use
                                   (   IEMEXUSEID,
                                        iemexid,
                                      noofinpat,
                                          value,
                                    createdocid,
                                 createdatetime,
                                    modifydocid,
                                  modifydatetime)
                                          values
                                          (
                                          v_iemExUserId,
                                          v_iemExId,
                                          v_nOofInpat,
                                          v_value,
                                          v_createDocId,
                                          to_char(sysdate,'yyyy-mm-dd hh24;mi;ss'),
                                          null,
                                          null
                                          );
else update iem_mainpage_except_use set iemexid=v_iemExId,
value=v_value,modifydocid=v_modifyDocId,modifydatetime=v_modifyDateTime where IEMEXUSEID=v_iemExUserId;

end if;
end;

end;----package end;
/

prompt
prompt Creating package body QUEST_SOO_ALERTTRACE
prompt ==========================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.quest_soo_alerttrace wrapped
0
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
3
b
9200000
1
4
0
11c
2 :e:
1PACKAGE:
1BODY:
1QUEST_SOO_ALERTTRACE:
1MC_FILE_READ:
1CONSTANT:
1NUMBER:
18192:
1MC_PREVIOUS:
13:
10:
1MC_FORWARD:
11:
1MC_SEARCH:
12:
1MC_FIND_START:
1MC_FIND_BUFFFWD:
14:
1MC_FIND_END:
15:
1MC_FIND_BUFFBACK:
16:
1MC_RESET_FILE:
1-:
1MC_RESET_ALL:
1MC_FILE_START:
1100:
1MC_FILE_END:
1101:
1MC_FILE_START_POS:
1MC_CASE_INSENSITIVE:
1MC_CASE_SENSITIVE:
1GV_LINES:
1GV_CHUNKSIZE:
1GV_INSTANCE:
1VARCHAR2:
1GV_DUMP_DIR:
11000:
1GV_BFILE:
1BFILE:
1GV_FILE_IDX:
1PLS_INTEGER:
1GV_FILE_SIZE:
1TYPE:
1TYP_FILE:
1LONG:
1GARR_FILE_IDX:
1TYP_TEXT_REC:
1RECORD:
1STARTPOS:
1ENDPOS:
1LINEDATE:
1DATE:
1TEXT:
14000:
1TYP_TEXT_REC_ARR:
1BINARY_INTEGER:
1TYP_IDX:
1TYP_FILE_REC:
1DIRNAME:
1FILENAME:
1FILE_LENGTH:
1ARR_BUFF_START:
1ARR_BUFF_END:
1CURR_BUFF:
1TYP_FILE_REC_ARR:
1GARR_FILE_REC:
1INITFILE:
1P_FILE:
1P_DIRPATH:
1DELETE:
1||:
1LP_SEPERATE_FILE_NAME:
1P_FILENAME:
1O_DIRNAME:
1OUT:
1O_FILE:
1LV_DELIM:
1CHAR:
1/:
1LV_STR_POS:
1IS NULL:
1alert_:
1.log:
1EXISTS:
1NOT:
1ELSIF:
1INSTR:
1=:
1\:
1SUBSTR:
1+:
1COUNT:
1CLOSE_FILE:
1DBMS_LOB:
1FILEISOPEN:
1FILECLOSE:
1CREATE_DIRECTORY:
1P_DIRNAME:
1PRAGMA:
1AUTONOMOUS_TRANSACTION:
1V_SQL_TEXT:
1CREATE OR REPLACE DIRECTORY :
1 AS ':
1':
1EXECUTE:
1IMMEDIATE:
1LP_VALIDATE_DIRECTORY:
1IV_DIRECTORY_PATH:
1OV_DIRECTORY_NAME:
1LV_TEST:
1DIRECTORY_NAME:
1ALL_DIRECTORIES:
1DIRECTORY_PATH:
1ROWNUM:
1SELECT directory_name:n           INTO ov_directory_name:n           FROM all+
1_directories:n          WHERE directory_path = iv_directory_path AND ROWNUM <+
1 2:
1NO_DATA_FOUND:
1QUEST_SOO_BDUMP_DIR:
1IDX:
110000:
1LOOP:
1QUEST_SOO_DIR_:
1SELECT 1:n                       INTO lv_test:n                       FROM al+
1l_directories:n                      WHERE directory_name = ov_directory_name+
1 AND ROWNUM < 2:
1EXIT:
1LP_OPEN_FILE:
1LV_DIRECTORY:
1LV_FILE_NAME:
1LV_DIR_PATH:
1OTHERS:
1RAISE_APPLICATION_ERROR:
120001:
1Error seperating file name from directory:::
1SQLERRM:
120002:
1Error validating or creating directory:::
1BFILENAME:
120003:
1Error opening file:::
1FILEOPEN:
1LOB_READONLY:
1ISDATE:
1INPUTSTRING:
1DATEVALUE:
1TO_DATE:
1DY MON DD HH24::MI::SS YYYY:
1FIND_DATE:
1P_START_POS:
1O_DATE_POS:
1O_DATE:
1LV_START:
1LV_END:
1LV_TMP_READ:
1LV_TMP_END:
1LV_TEXT:
1LV_TMP_DATE:
1LV_ISDATE:
1LV_IDX:
1<=:
110:
1<:
10A:
1UTL_RAW:
1CAST_TO_VARCHAR2:
1>=:
1IS NOT NULL:
1RESET_CACHE:
1P_DIRECTION:
1P_START:
1P_END:
1LV_BUFFER:
1FUNCTION:
1LF_READ_LINES:
1O_START_POS:
1O_END_POS:
1PO_RESET:
1P_RERUN:
1P_SIZE_MULT:
1RETURN:
1LARR_READ_LINES:
1LARR_TMP_READ:
1LV_LINES:
1LV_START_POS:
1LV_DATE_START_POS:
1LV_TMP_START:
1LV_TMP_SRCH_END:
1LV_CURRENT_DATE:
1*:
1NVL:
1>:
1FIRST:
1LF_SEARCH:
1P_SEARCH:
1P_CASESENSITIVE:
1P_SEARCH_SECONDS:
1LARR_LINES:
1LV_FIND_IDX:
1LV_TMP_IDX:
1LV_COMP_IDX:
1LV_SECONDS:
1LV_START_DATE:
1LV_CURR_DATE:
1LV_TMP_TEXT:
18196:
1LV_FIND:
1400:
1UPPER:
1SYSDATE:
120:
160:
124:
1LEAST:
1STRING NOT FOUND:
1INITIALIZELINES:
1P_LINES:
1P_CHUNKSIZE:
1MOVE_CACHE:
1LAST:
1PRINT_CACHE:
1DBMS_OUTPUT:
1PUT_LINE:
1Forward :
1Previous :
1File Start :
1File End :
1Search :
1CASE_NOT_FOUND:
1WHILE:
1Buff Number:: :
1 - Start:::
1 - End:::
1NEXT:
1READFILE:
1P_NAV:
1P_READ_SECONDS:
1QUEST_SOO_ALERTTRACE_LOG_TYP:
1LV_END_POS:
1LV_CACHE_ID:
1LV_RESET:
1LV_READ_SECONDS:
1LNT_ALERT:
1GETLENGTH:
120004:
1Error reading to EOF:::
120005:
1Error searching from EOF for :::
1 - Error:::
120006:
1Error reading from SOF:::
120007:
1Error searching for :
1 from SOF:::
120008:
1Error moving forward from position :
120009:
1Error searching forward from position :
1 for text:::
1. Error is :::
120010:
1Error moving backwards through file from position :
1. Error:::
120011:
1Error searching for string:: :
1 backwards through file from start position:::
1TO_NUMBER:
120012:
1Error moving to position :
1NEW:
1EXTEND:
1QUEST_SOO_ALERTTRACE_LINE_TYP:
120013:
1Error creating nested table
/

prompt
prompt Creating package body QUEST_SOO_PKG
prompt ===================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.QUEST_SOO_PKG wrapped
0
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
3
b
8106000
1
4
0
491
2 :e:
1PACKAGE:
1BODY:
1QUEST_SOO_PKG:
1TYPE:
1VARCHAR_TAB_TYP:
1VARCHAR2:
1120:
1BINARY_INTEGER:
1NUMBER_TAB_TYP:
1NUMBER:
1EVENT_INDX_TAB:
1EVENT_NAME_TAB:
1EVENT_CATEGORY_TAB:
1G_EVENT_COUNT:
10:
1L_EVENT_INITIALIZED:
1BOOLEAN:
1FALSE:
1CURSOR:
1C_LOCK:
1ROWNUM:
1SID:
1LTYPE:
1REQUEST:
1LMODE:
1LOCK_TYPE_DECODE:
1ID2:
1LOCK_TYPE:
1LOCK_MODE_DECODE:
1MODE_HELD:
1MODE_REQUESTED:
1ID1:
1BLOCK:
1BLOCKING:
1DECODE:
11:
1BLOCKED:
1V$LOCK:
1!=:
12:
1C_LOCK_41:
1LOCK_TYPE_DECODE_41:
1LOCK_MODE_DECODE_41:
1VTABTYPE:
1200:
1NTABTYPE:
1PRINTED:
1BLOCKED_LIST:
1BLOCKED_LIST_CNT:
1BLOCKING_LIST:
1BLOCKING_LIST_CNT:
1LOCK_COUNT:
1TREE_DEPTH:
1TREE_SEQUENCE:
1LOCK_HASH_TABLE:
1SID_HASH_TABLE:
1SOO_LOCKTREE_ROW:
1QUEST_SOO_LOCK_TREE:
1ROWTYPE:
1FULL_VERSION:
120:
1FUNCTION:
1GET_SEG_NAME:
1P_FILENO:
1P_BLOCKNO:
1RETURN:
1GET_SEG_NAME_41:
1INITIALIZE_OBJECT_CACHE:
1DBVERSION:
1FORMAT_SQL:
1P_SQL_TEXT:
1P_MAX_LEN:
1256:
1I:
1L_TEXT_LEN:
1L_THIS_CHAR:
1CHAR:
1L_LAST_CHAR:
1L_FROM_POS:
1L_DUP_SP_POS:
1L_RETURN_TEXT:
12000:
1TRANSLATE:
1CHR:
110:
1||:
113:
1  :
1INSTR:
1WHILE:
1LOOP:
1SUBSTR:
1+:
1EXIT:
1>:
140:
1UPPER:
16:
1=:
1SELECT:
1FROM:
1 ... :
1DEBUG:
1IN_STRING:
1G_DEBUG:
1DBMS_OUTPUT:
1PUT_LINE:
1FILE_ID:
1EXTENT_ID:
1BLOCK_ID:
1BLOCKS:
1OWNER:
1.:
1SEGMENT_NAME:
1BULK:
1COLLECT:
1OBJECT_CACHE_FILENO:
1OBJECT_CACHE_EXTNO:
1OBJECT_CACHE_BLOCKNO:
1OBJECT_CACHE_LENGTH:
1OBJECT_CACHE_SEGNAME:
1SYS:
1DBA_EXTENTS:
1OBJECT_CACHE_COUNT:
1COUNT:
1G_OBJECT_CACHE_INITIALIZED:
1HI:
1LO:
1NEXT:
1PREV:
1Extent at file :
1, block :
1TRUNC:
1-:
1/:
1MAIN_LOOP:
1checking entry :
1:: :
1, :
1TO_CHAR:
1found match at :
1 :: :
1ELSIF:
1<:
1too low:
1CEIL:
1too high:
1chopped down to nothing (next entry:
1):
1Unknown, temporary or new segment:
1UNK:
1GET_EXT_NO:
1EVENT_CATEGORY:
1P_EVENT:
1TAG:
1pre 4.0:
1CAT:
1100:
1Unknown:
1SoO ERROR:: Event category table not initialized:
1 ^ :
13:
1P_INDX:
1Spotlight On Oracle internal error:
1NO_DATA_FOUND:
1ISSPOK:
1SP_OK1:
1REQUEST_FAILURES:
1LAST_FAILURE_SIZE:
1MAX_FREE_SIZE:
1FREE_SPACE:
1REQUEST_MISSES:
1V$SHARED_POOL_RESERVED:
1SP_OK2:
1TRANSLATE_PARAMETER:
1VALUE:
1V$PARAMETER:
1NAME:
1shared_pool_reserved_min_alloc:
1RES_SPOK:
1REQUEST_F:
1LAST_FS:
1MAX_FS:
1FS:
1REQUEST_M:
1SPS_VAL:
1OPEN:
1CLOSE:
1SGAOTHER:
1SGA_OTHER1:
1java_pool_size:
1SGA_OTHER2:
1SUM:
1V$SGA:
1Variable Size:
1SGA_OTHER3:
1SGA_OTHER4:
1DC:
1SHARABLE_MEM:
1V$DB_OBJECT_CACHE:
1SGA_OTHER5:
1SA:
1V$SQLAREA:
1SGA_OTHER6:
1250:
1*:
1USERS_OPENING:
1SGA_OTHER7:
1V$SESSTAT:
1S:
1V$STATNAME:
1N:
1STATISTIC#:
1session uga memory max:
1SGA_OTHER_SZ:
1JPSZ:
1SGA_NV_SZ:
1SGA_TOT:
1OBJECT_MEM:
1SHARED_SQL:
1CURSOR_MEM:
1MTS_MEM:
1NVL:
1ORACLEEVENTCLASS:
1P_EVENT_NAME:
1CS:
1SELECT wait_class FROM v$event_name WHERE name = ::event_name:
1CH:
1INTEGER:
1WAITCLASS:
1RV:
1VERSION:
1TO_NUMBER:
1DBMS_SQL:
1OPEN_CURSOR:
1PARSE:
1NATIVE:
1BIND_VARIABLE:
1event_name:
1DEFINE_COLUMN:
1EXECUTE:
1FETCH_ROWS:
1COLUMN_VALUE:
1CLOSE_CURSOR:
1POPULATE_EVENT_TABLE:
1STMT:
13200:
1STMT7:
1SELECT /*+ORDERED USE_HASH(E) */:n:n                    s.event event,:n:n   +
1                 e.topcategory || ' - ' || e.subcategory || ' ^ ' || e.catego+
1ry category,:n:n                    NVL(total_waits, -1)       total_waits,:n+
1:n                    NVL(S.INDX, -1)            indx:n:n               FROM +
1(SELECT /*+  ORDERED */:n:n                            0 inst_id,:n:n        +
1                    D.KSLEDNAM event,:n:n                            S.KSLESW+
1TS total_waits,:n:n                            S.KSLESTMO total_timeouts,:n:n+
1                            S.KSLESTIM time_waited,:n:n                      +
1      S.KSLESTIM / DECODE(S.KSLESWTS,0,1,S.KSLESWTS) average_wait,:n:n       +
1                     S.INDX indx:n:n                       FROM X$KSLED D, X$+
1KSLEI S:n:n                      WHERE S.INDX = D.INDX:n:n
/

prompt
prompt Creating package body QUEST_SOO_SCHEMA_MGR
prompt ==========================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.QUEST_SOO_SCHEMA_MGR wrapped
0
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
3
b
8106000
1
4
0
3a
2 :e:
1PACKAGE:
1BODY:
1QUEST_SOO_SCHEMA_MGR:
1TYPE:
1CVTYPE:
1REF:
1CURSOR:
1FUNCTION:
1TABLE_EXISTS:
1P_TABLE_NAME:
1VARCHAR2:
1RETURN:
1BOOLEAN:
1L_COUNT:
1INTEGER:
10:
1L_TABLE_EXISTS:
1FALSE:
1COUNT:
1USER_TABLES:
1TABLE_NAME:
1=:
1>:
1TRUE:
1CREATE_SCHEMA_VERSION_TABLE:
1SQLTEXT:
12000:
1CREATE TABLE quest_soo_schema_versions:n               (schema_id varchar2(25+
16) primary key,:n                version  number not null):
1EXECUTE:
1IMMEDIATE:
1GET_VERSION:
1P_SCHEMA_ID:
1NUMBER:
1L_VERSION:
1VERSION_CSR:
1OPEN:
1SELECT version FROM quest_soo_schema_versions :
1||:
1 WHERE schema_id=::b_schema_id :
1USING:
1NOTFOUND:
1-:
11:
1CLOSE:
1SET_VERSION:
1P_VERSION:
1L_CURRENT_VERSION:
1IS NULL:
1INSERT INTO quest_soo_schema_versions :
1(schema_id,version) VALUES(::b_schema_id,::b_version) :
1ELSIF:
1!=:
1UPDATE quest_soo_schema_versions :
1SET version=::b_version WHERE schema_id=::b_schema_id :
1COMMIT:
1INIT:
1QUEST_SOO_SCHEMA_VERSIONS:
1NOT:
0

0
0
119
2
0 a0 1d a0 97 a0 9d :2 a0
c8 77 a0 8d 8f a0 b0 3d
b4 :2 a0 a3 2c 6a a0 1c 51
81 b0 a3 a0 1c a0 81 b0
a0 d2 9f ac :2 a0 b2 ee :2 a0
7e b4 2e ac e5 d0 b2 e9
a0 7e 51 b4 2e :2 a0 d b7
19 3c :2 a0 5a 65 b7 a4 b1
11 68 4f 9a a3 b4 55 6a
a0 51 a5 1c 6e 81 b0 :3 a0
11e 11d b7 a4 b1 11 68 4f
a0 8d 8f a0 b0 3d b4 :2 a0
a3 2c 6a a0 1c 81 b0 a3
a0 1c 81 b0 :2 a0 6e 7e 6e
a0 b4 2e a0 112 11c 11a 11d
:2 a0 e9 d3 :2 a0 f a0 7e 51
b4 2e d b7 19 3c :2 a0 e9
c1 :2 a0 5a 65 b7 a4 b1 11
68 4f 9a 8f a0 b0 3d 8f
a0 b0 3d b4 a3 55 6a a0
1c 81 b0 :3 a0 a5 b d a0
:2 7e 51 b4 2e b4 2e a0 7e
b4 2e 52 10 :2 a0 6e 7e 6e
a0 b4 2e a0 112 a0 112 11e
11a 11d a0 b7 :2 a0 7e b4 2e
:2 a0 6e 7e 6e a0 b4 2e a0
112 a0 112 11e 11a 11d b7 :2 19
3c a0 57 a0 b4 e9 b7 a4
b1 11 68 4f 9a b4 55 6a
a0 6e a5 b 7e b4 2e a0
57 b3 b7 19 3c b7 a4 b1
11 68 4f b1 b7 a4 11 b1
56 4f 17 b5
119
2
0 3 7 8 14 10 2a 1e
22 26 c 31 35 4e 4a 49
56 46 5b 5f 82 67 6b 6f
73 7b 7e 66 a1 8d 91 99
9d 63 89 a8 ac af b0 b4
b8 b9 c0 c4 c8 cb cc d1
d2 d8 dc dd e2 e6 e9 ec
ed f2 f6 fa fe 100 104 107
10b 10f 112 116 118 11c 11e 12a
12e 130 167 145 146 14a 14e 152
155 156 15e 163 144 16e 172 176
17a 17e 141 182 186 188 194 198
19a 19e 1b7 1b3 1b2 1bf 1af 1c4
1c8 1e8 1d0 1d4 1d8 1dc 1e4 1cf
203 1f3 1f7 1ff 1cc 1ef 20a 20e
213 216 21b 21f 220 225 229 22a
22d 22e 232 236 23a 23f 244 248
24c 251 255 258 25b 25c 261 265
267 26b 26e 272 276 27b 27d 281
285 288 28c 28e 292 294 2a0 2a4
2a6 2bf 2bb 2ba 2c7 2d4 2d0 2b7
2dc 2cf 2fd 2e5 2e9 2ed 2f1 2f9
2cc 2e1 304 308 30c 30d 30f 313
317 31a 31d 320 321 326 327 32c
330 333 334 1 339 33e 342 346
34b 34e 353 357 358 35d 361 362
366 367 36b 36c 370 374 376 37a
37e 381 382 387 38b 38f 394 397
39c 3a0 3a1 3a6 3aa 3ab 3af 3b0
3b4 3b5 3b9 3bb 3bf 3c3 3c6 3ca
3cf 3d3 3d4 3d9 3db 3df 3e1 3ed
3f1 3f3 404 405 409 40d 411 416
417 419 41c 41d 422 426 42b 42c
42e 432 435 437 43b 43d 449 44d
44f 451 453 457 463 465 468 46a
473
119
2
0 :2 1 9 e 4 9 13 17
13 :2 4 d 1b 28 :2 1b 1a 7
e 7 :2 4 :2 18 23 18 :2 7 :2 18
23 18 7 :6 e 9 :2 e 1b :3 19
9 :4 7 a 12 14 :2 12 a 1c
a :4 7 f e 7 :6 4 e 7
0 :2 4 11 1b 1a 11 d 11
:2 7 f 19 :2 7 :7 4 d 1a 26
:2 1a 19 7 e 7 :2 4 :3 15 :2 7
:3 15 :2 7 c 1f 1c 1f 40 :2 1f
7 40 :3 7 :2 d :2 7 a 16 :2 a
17 18 :2 17 a :4 7 d :3 7 f
e 7 :6 4 e 1b 27 :2 1b 31
3b :2 31 1a 7 :2 4 :3 1b :2 7 1c
29 :2 1c 7 a 1c 1e 1f :2 1e
:2 1c :4 24 :3 a 12 1f 1c 1f 16
:2 1f 1c 16 29 27 :3 a :2 7 d
22 :3 1f a 12 1f 1c 1f 16
:2 1f 1c 16 27 25 :3 a :9 7 :6 4
e 0 :2 4 e 1c :2 e :6 a :3 7
:a 4 :5 1
119
2
0 :4 1 :6 3 :7 5 :2 6 8 :2 5 :5 8
:6 9 :4 b c :3 d :5 e d :4 b :5 10
:3 12 11 :2 10 :4 15 :2 a :3 5 16 18
1a 0 :2 18 :4 1a 1b :2 1a :5 1f :2 1e
:3 18 20 :7 22 :2 23 25 :2 22 :4 25 :5 26
:3 28 :3 29 :2 28 2a 29 :3 28 2c 2d
:2 2c :3 2f :6 31 30 :2 2f :4 34 :4 36 :2 27
:3 22 37 :a 39 3b :2 39 :4 3b :6 3d :e 3f
:3 41 :2 42 43 :2 41 :4 43 :3 41 44 40
:5 44 :3 46 :2 47 48 :2 46 :4 48 :3 46 45
4
/

prompt
prompt Creating package body QUEST_SOO_SQLTRACE
prompt ========================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.quest_soo_sqltrace wrapped
0
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
3
b
9200000
1
4
0
32f
2 :e:
1PACKAGE:
1BODY:
1QUEST_SOO_SQLTRACE:
1G_DEBUG:
1NUMBER:
10:
1G_FETCH_BUNCHING_TIME:
15000000:
1G_SQL_ID:
1-:
11:
1G_SQL_ZERO:
1G_TRACE_FILE_ID:
1G_SESSION_ID:
1G_SERIAL:
1G_CURRENTLY_BINDING_SQL:
1G_LOAD_ALL_LINES:
1BOOLEAN:
1TRUE:
1G_PROCESS_WAITS:
1G_PROCESS_BINDS:
1G_LOAD_RECURSIVE:
1G_PREVIOUS_LINE_TYPE:
1VARCHAR2:
120:
1G_MAJOR_ORACLE_VERSION:
1G_MINOR_ORACLE_VERSION:
1G_LAST_DEBUG_MESSAGE:
132767:
1G_SESSION_PGA_MEMORY_STAT#:
1G_PGA_LIMIT:
1BULK_ERRORS:
1PRAGMA:
1EXCEPTION_INIT:
124381:
1TYPE:
1VARCHAR_TAB_TYP:
1200:
1BINARY_INTEGER:
1NUMBER_TAB_TYP:
1SQL_EXEC_TYP:
1RECORD:
1SQL_ID:
1PARSE_ID:
1CURSOR_TO_STMT_MAP_TYP:
1CURSOR_TO_STMT_MAP:
1PARSE_TYP:
1QUEST_SOO_AT_PARSE_CURSOR:
1ROWTYPE:
1G_PARSE_LIST:
1EXEC_TYP:
1QUEST_SOO_AT_SQL_EXECUTIONS:
1G_EXEC_LIST:
1FETCH_TYP:
1QUEST_SOO_AT_SQL_FETCH:
1G_FETCH_LIST:
1SQL_STATEMENT_TYP:
1QUEST_SOO_AT_SQL_STATEMENT:
1G_SQL_STATEMENT_LIST:
1WAIT_NAM_TYP:
1QUEST_SOO_AT_WAIT_NAMES:
1WAIT_NAM_IDX:
1INTEGER:
1256:
1G_WAIT_NAMES:
1G_WAIT_NAM_IDX:
1SQL_WAIT_TYP:
1QUEST_SOO_AT_SQL_WAITS:
1G_WAIT_LIST:
1G_PENDING_WAITS:
1NESTED_NUM_TYP:
1G_PENDING_WAITS_SQL_IDX:
1SQL_TEXT_TYP:
1QUEST_SOO_AT_SQL_STMT_PIECES:
1G_SQL_STMT_PIECES:
1STAT_TYP:
1QUEST_SOO_AT_EXECUTION_PLAN:
1G_STAT_LIST:
1EXEC_ERROR_TYP:
1QUEST_SOO_AT_SQL_EXEC_ERROR:
1G_ERROR_LIST:
1EXEC_WAIT_TYP:
1VARCHAR:
130:
1EXEC_WAIT_LIST_TYP:
1BIND_SET_TYP:
14000:
1SQL_BINDS_TYP:
1G_SQL_BINDS:
1BIND_TYP:
1QUEST_SOO_AT_SQL_BINDS:
1G_BIND_LIST:
1SQL_STMT_TYP:
1SQL_STMT:
1PARSE_LIST:
1SQL_TEXT_LIST:
1EXEC_LIST:
1EXEC_WAIT_LIST:
1FETCH_LIST:
1STAT_LIST:
1SQL_KNOWN:
1FALSE:
1SQL_LIST_TYP:
1G_SQL_LIST:
1SQL_ADDRESS_LIST:
1G_SQL_LOOKUP:
1G_DIRECTORY_NAME:
160:
1G_TRACE_FILE:
1QUEST_SOO_AT_TRACE_FILE:
1G_PGA_SIZE:
1PGA_TYP:
1G_PGA_USAGE:
1OPERATIONS_TYP:
1QUEST_SOO_AT_OPERATIONS:
1OPERATIONS_IDX_TYP:
1OPERATION_STRING:
1G_OPERATIONS_LIST:
1G_OPERATIONS_IDX:
1PROCESS_PENDING_WAITS:
1P_SQL_ID:
1RESET_PACKAGE:
1DEBUG:
1P_LEVEL:
1P_TEXT:
1=:
1>=:
1DBMS_OUTPUT:
1PUT_LINE:
1LOAD_WAIT_LOOKUP:
1DELETE:
1EVENT_ID:
1NAM:
1BULK:
1COLLECT:
1SELECT event_id,:n             nam:n      BULK COLLECT INTO g_wait_names:n   +
1     FROM quest_soo_at_wait_names:
1POPULATE_WAIT_LOOKUP:
1AUTONOMOUS_TRANSACTION:
1EVENT#:
1NAME:
1V$EVENT_NAME:
1INSERT INTO quest_soo_at_wait_names:n                  (event_id, nam):n     +
1    SELECT event#, NAME:n           FROM v$event_name:
1COMMIT:
1INITIALIZE_WAIT_LOOKUP:
1V_WAIT_NAME:
1V_EVENT_ID:
1COUNT:
1||:
1 events loaded:
1I:
1LOOP:
1Creatining index for :
1 to id :
1FUNCTION:
1NEW_WAIT_ID:
1P_WAIT_NAME:
1RETURN:
1V_WAIT_ID:
1LOCK TABLE quest_soo_at_wait_names IN EXCLUSIVE MODE:
1NVL:
1MAX:
1SELECT NVL (MAX (event_id), 0) + 1:n        INTO v_wait_id:n        FROM ques+
1t_soo_at_wait_names:
1INSERT INTO quest_soo_at_wait_names:n                  (event_id, nam:n      +
1            ):n           VALUES (v_wait_id, p_wait_name:n                  ):
1GET_WAIT_ID:
1NO_DATA_FOUND:
1SESSION_PGA_MEMORY:
1L_PGA_SIZE:
1IS NULL:
1STATISTIC#:
1V$STATNAME:
1SELECT statistic#:n           INTO g_session_pga_memory_stat#:n           FRO+
1M v$statname:n          WHERE NAME = 'session pga memory':
1VALUE:
1V$MYSTAT:
1SELECT VALUE:n        INTO l_pga_size:n        FROM v$mystat:n       WHERE st+
1atistic# = g_session_pga_memory_stat#:
1TRACK_PGA:
1P_CATEGORY:
1L_START_PGA:
1L_END_PGA:
1L_PGA_DELTA:
1>:
1EXISTS:
1+:
1PRINT_PGA:
1L_CATEGORY:
1FIRST:
1EXIT:
12:
1:::
1NEXT:
1MYSTAT:
1P_STATNAME:
1L_VALUE:
1JOIN:
1USING:
1SELECT VALUE:n           INTO l_value:n           FROM v$mystat JOIN v$statna+
1me USING (statistic#):n          WHERE NAME = p_statname:
1 = :
1GET_STRING:
1P_LINE:
1START_STRING:
1RETURNVALUE:
11000:
1START_POS:
1TMP:
1INSTR:
1LENGTH:
1SUBSTR:
1END_STRING:
1END_POS:
1LOG_ERROR:
1P_FILE_NAME:
1P_ERROR_STACK:
1P_CALL_STACK:
1P_ERROR_LINE_NO:
1LOAD_STATUS:
1ERROR_TEXT:
1ERROR_LINE_NO:
1LAS
/

prompt
prompt Creating package body QUEST_SOO_USER_MANAGER
prompt ============================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.quest_soo_user_manager wrapped
0
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
3
b
8106000
1
4
0
df
2 :e:
1PACKAGE:
1BODY:
1QUEST_SOO_USER_MANAGER:
1EXE:
1P_SQL_TEXT:
1VARCHAR2:
1COMPILATION_ERROR:
1PRAGMA:
1EXCEPTION_INIT:
1-:
124344:
1L_CURSOR:
1INTEGER:
10:
1RC:
1STMT:
11000:
1DBMS_SQL:
1OPEN_CURSOR:
1PARSE:
12:
1EXECUTE:
1CLOSE_CURSOR:
1OTHERS:
1RAISE_APPLICATION_ERROR:
120101:
1SQLERRM:
1||:
1  when executing ':
1'   :
1GRANT_USER:
1USER_P:
1CURSOR:
1OBJECT_C:
1OBJECT_NAME:
1NAME:
1OBJECT_TYPE:
1TYPE:
1USER_OBJECTS:
1LIKE:
1QUEST_SOO_%:
1STATUS:
1=:
1VALID:
1VIEW:
1TABLE:
1PROCEDURE:
1FUNCTION:
1!=:
1sys.:
1REPLACE:
1V$:
1V_$:
1SYS:
1V_$FIXED_TABLE:
1V$%:
1EXISTING_OBJECTS:
1DBA_OBJECTS:
1OWNER:
1UPPER:
1100:
1ORA_VERSION:
164:
1TABLE_ALREADY_EXISTS:
1955:
1TABLE_NOT_EXISTS:
1942:
1SYNONYM_EXCEPTION:
1PACKAGE_NOT_EXISTS:
14030:
1R:
1LOOP:
1drop :
1 :
1.:
1grant select on :
1 to :
1ELSIF:
1grant select,insert,update,delete on :
1grant execute on :
1NOT_LIKE:
1sys.%:
1PUBLIC:
1drop public synonym :
1drop synonym :
1create public synonym :
1 for :
1create synonym :
1grant select on sys.v_$rollname to :
1grant select on sys.X_$BH       to :
1grant select on sys.X_$KSLES    to :
1grant select on sys.X_$KSLED    to :
1grant select on sys.X_$KSUSESTA to :
1grant select on sys.X_$KSPPI    to :
1grant select on sys.X_$KSPPCV   to :
1grant select on sys.X_$KSQRS    to :
1grant select on sys.X_$KSLEI    to :
1grant select on sys.X_$KSLLT    to :
1grant select on sys.X_$KSLLD    to :
1grant select on sys.X_$KSMLRU   to :
1grant select on sys.X_$KCBFWAIT to :
1grant select on sys.X_$KSMSP    to :
1grant select on sys.X_$KSQST    to :
1grant select on sys.X_$KSBDP    to :
1grant select on sys.X_$KSUSECST to :
1SUBSTR:
1BANNER:
1INSTR:
11:
15:
1VERSION:
1V$VERSION:
1ROWNUM:
18:
19:
110:
1grant select on sys.X_$KCBWDS                 to :
1grant select on sys.X_$KCBWBPD                to :
13:
18.1:
1grant select on sys.X_$KTFBUE              to :
1grant select on sys.X_$KTFBFE              to :
1grant select on sys.X_$KTFBHC              to :
1grant select on sys.dba_temp_files         to :
1grant select any dictionary             to :
1grant select  on sys.obj$            to :
1grant select  on sys.ts$             to :
1grant select  on sys.fet$            to :
1grant select  on sys.uet$            to :
1grant select  on sys.file$           to :
1grant select  on sys.user$           to :
1grant select  on sys.seg$            to :
1grant select  on sys.undo$           to :
1grant select  on sys.dba_extents     to :
1grant select  on sys.dba_free_space  to :
1grant select  on sys.dba_indexes     to :
1grant select  on sys.dba_ind_columns to :
1grant select  on sys.dba_tab_columns to :
1grant select  on sys.dba_tab_privs   to :
1grant select  on sys.dba_jobs        to :
1grant select  on sys.dba_data_files  to :
1grant select  on sys.dba_objects     to :
1grant execute on sys.dbms_system     to :
1REVOKE_USER:
1NOT_GRANT:
11927:
1revoke all privileges on :
1 from :
1VALIDATE_USER:
1RETURN:
1V_SYN_NUM:
1V_VIEW_PRIV:
1V_VIEW_NUM:
1X_SYN_NUM:
1X_VIEW_PRIV:
1X_VIEW_NUM:
1SYS_OBJ_PRIV:
1USER_OBJ_PRIV1:
1USER_OBJ_PRIV2:
1USER_OBJ_PRIV:
1RETURN_VALUE:
1COUNT:
1SYNONYM:
1DBA_TAB_PRIVS:
1TABLE_NAME:
1V_$%:
1PRIVILEGE:
1SELECT:
1GRANTEE:
1X$KSLES:
1X$KSLED:
1X$KSUSESTA:
1X$KSPPI:
1X$KSPPCV:
1X$KSQRS:
1X$KSLEI:
1X$KSLLT:
1X$KSLLD:
1X$KSMLRU:
1X$KCBFWAIT:
1X$KSMSP:
1X$KSQST:
1X$KSUSECST:
1X$BH:
1X$KSBDP:
1X$KCBWDS:
1X$KCBWBPD:
1X$KTFBUE:
1X$KTFBFE:
1X$KTFBHC:
1OBJ$:
1TS$:
1FET$:
1UET$:
1FILE$:
1USER$:
1SEG$:
1UNDO$:
1DBA_EXTENTS:
1DBA_FREE_SPACE:
1DBA_INDEXES:
1DBA_IND_COLUMNS:
1DBA_TAB_COLUMNS:
1DBA_JOBS:
1DBA_DATA_FILES:
1DBA_TEMP_FILES:
1DBMS_SYSTEM:
1>=:
135:
117:
17.3:
1>:
180:
116:
18.0:
1130:
118:
19.0:
1170:
121:
19.2:
110.:
1250:
0

0
0
851
2
0 a0 1d a0 97 9a 8f a0
b0 3d b4 8b 55 6a b0 2a
:3 a0 7e 51 b4 2e b4 5d a3
a0 1c 51 81 b0 a3 a0 1c
51 81 b0 a3 a0 51 a5 1c
81 b0 :3 a0 6b d :2 a0 6b :2 a0
51 a5
/

prompt
prompt Creating package body QUEST_SOO_UTIL
prompt ====================================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.quest_soo_util wrapped
0
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
3
b
8106000
1
4
0
260
2 :e:
1PACKAGE:
1BODY:
1QUEST_SOO_UTIL:
1TYPE:
1TYP_LOCK_TYPE_DESC:
1VARCHAR2:
1100:
1BINARY_INTEGER:
1TYP_LOCK_MODE_DESC:
120:
1TYP_LOCK_TYPE:
12:
1TYP_LOCK_IDX:
1PLS_INTEGER:
1ARR_LOCK_TYPE_DESC:
1ARR_LOCK_TYPE:
1ARR_LOCK_TYPE_IDX:
1ARR_LOCK_MODE_DESC:
1ARR_LOCK_MODE:
1ARR_LOCK_MODE_IDX:
1MV_SEARCHING:
1{searching...}:
1MV_CACHE:
110:
1cache#:
1MV_RBS:
1RBS#:
1MV_LATCH:
1latch#:
1MV_MODE:
1mode:::
1MV_OBJECT:
1Object:
1MV_DATAFILE:
1TEMP datafile:::
1MV_FILE:
1file:
1MV_SCAN:
130:
1Full table scan on %s:
1MV_COMPLETE:
1(%s%% complete):
1MV_UNKNOWN:
140:
1Unknown, temporary or new segment:
1FUNCTION:
1ENCODE_INDEX:
1P_VALUE:
1RETURN:
1NUMBER:
1LV_CHAR:
11:
1LV_POS:
15:
1LV_TMP:
1IDX:
1LENGTH:
1LOOP:
1SUBSTR:
1ASCII:
148:
157:
10:
1||:
1TO_CHAR:
1-:
164:
1+:
1TO_NUMBER:
1GET_LOCK_TYPE_DESC:
1P_LOCK_TYPE:
1P_ID2:
1LV_IDX:
1IS NULL:
1=:
1TS:
1T0:
1ELSIF:
1T1:
1EXISTS:
1GET_LOCK_MODE_DESC:
1P_IDX:
1IO_EVENT:
1P_EVENT:
1P_P1:
1P_P2:
1P_TYPE:
1512:
1NAME:
1V$DBFILE:
1FILE#:
1ROWNUM:
1NO_DATA_FOUND:
1EXECUTE:
1IMMEDIATE:
1BEGIN SELECT t.name INTO ::1 FROM v$tempfile t, v$parameter p :
1 WHERE p.name = 'db_files' AND t.file#=::2-p.value; :
1EXCEPTION WHEN NO_DATA_FOUND THEN ::1 ::= NULL; END;:
1USING:
1OUT:
1 (file#=:
1):
1!=:
1DFS db file lock:
1Extent at file :
1, block :
1, :
1ENQUEUE_EVENT:
1LV_LOCK_TYPE:
1LV_LOCK_MODE:
1CHR:
1BITAND:
116777216:
1/:
116777215:
116711680:
165535:
1LATCH_EVENT:
1V$LATCHNAME:
1LATCH#:
1DBA_EVENT:
1P_PX:
1 :
1DBMS_UTILITY:
1DATA_BLOCK_ADDRESS_FILE:
1DATA_BLOCK_ADDRESS_BLOCK:
1UNDO_EVENT:
1V$ROLLNAME:
1USN:
1ROW_EVENT:
1PARAMETER:
1V$ROWCACHE:
1CACHE#:
1EVENT_DETAIL:
1P_P1TEXT:
1P_P2TEXT:
1P_P3TEXT:
1P_P3:
1LV_RETURN:
12048:
1file#:
1block#:
1file number:
1first dba:
1enqueue:
1LIKE:
1enq::%:
1latch activity:
1latch free:
1dba:
1undo segment recovery:
1row cache lock:
1TRIM:
1>:
1LOAD_LOCKS:
1Buffer hash table instance lock:
1Control file schema global enqueue lock:
1Cross-instance function invocation instance lock:
13:
14:
1Cursor bind lock:
1Data file instance lock:
16:
1Direct loader parallel index create:
17:
1Mount/startup db primary/secondary instance lock:
18:
1Distributed recovery process lock:
19:
1Distributed transaction entry lock:
1SGA open-file information lock:
111:
1File set lock:
112:
1Space management operations on a specific segment lock:
113:
1Instance number lock:
114:
1Instance recovery serialization global enqueue lock:
115:
1Instance state lock:
116:
1Library cache invalidation instance lock:
117:
1Job queue lock:
118:
1Thread kick lock:
119:
1Master buffer hash table instance lock:
1Mount definition gloabal enqueue lock:
121:
1Media recovery lock:
122:
1Password file lock:
123:
1Parallel operation lock:
124:
1Process startup lock:
125:
126:
1USE_ROW_ENQUEUE enforcement lock:
127:
1Redo thread global enqueue lock:
128:
1Row wait enqueue lock:
129:
1System commit number instance lock:
1System commit number high water mark enqueue lock:
131:
1SMON lock:
132:
1Sequence number instance lock:
133:
1Sequence number enqueue lock:
134:
1Sort segment lock:
135:
1Space transaction enqueue lock:
136:
1Sequence number value lock:
137:
1Generic enqueue lock:
138:
1DDL enqueue lock:
139:
1Extend-segment enqueue lock:
1DML enqueue lock:
141:
1Temporary object operations lock:
142:
1Temporary table enqueue lock:
143:
1Transaction enqueue lock:
144:
1User supplied lock:
145:
1User name lock:
146:
1Undo segment DDL lock:
147:
1Being-written redo log instance lock:
1Write-atomic-log-switch global enqueue lock:
149:
1Temporary segment or new block allocation enqueue lock:
150:
1Log start/log switch enqueue lock:
151:
1Default Temporary Tablespace Enqueue:
152:
1Diana Version Enqueue:
153:
1Internet Application Server Enqueue:
154:
1Scheduler Modification and Loading Enqueue:
155:
1Scheduler Top Plan Enqueue:
156:
1Synchronized Replication Enqueue:
1Change Data Captu
/

prompt
prompt Creating package body WWJ
prompt =========================
prompt
CREATE OR REPLACE PACKAGE BODY EMR.WWJ
IS
--
-- To modify this template, edit file PKGBODY.TXT in TEMPLATE 
-- directory of SQL Navigator
--
-- Purpose: Briefly explain the functionality of the package body
--
-- MODIFICATION HISTORY
-- Person      Date    Comments
-- ---------   ------  ------------------------------------------      
   -- Enter procedure, function bodies as shown below


   -- Enter further code below as specified in the Package spec.
END;
/


spool off
